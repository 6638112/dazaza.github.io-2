<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>通过MQTT和家庭助理自动完成的尚飞百叶窗Somfy blinds automated via MQTT and Home Assistant</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Somfy blinds automated via MQTT and Home Assistant<br/>通过MQTT和家庭助理自动完成的尚飞百叶窗</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-24 05:24:50</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/11/20098c021b2aa6341b2cebac44706a67.jpg"><img src="http://img2.diglog.com/img/2020/11/20098c021b2aa6341b2cebac44706a67.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>In this post I’ll show you how to use a Raspberry Pi and some soldering skills to automate old Somfy blinds via the MQTT protocol exposed to Home Assistant and Google Home.</p><p>在本文中，我将向您展示如何使用Raspberry Pi和一些焊接技巧，以通过Home Assistant和Google Home公开的MQTT协议自动化旧的Somfy百叶窗。</p><p>  We’ve moved to a new apartment and one of its features are external blinds (a.k.a. covers) that are controlled through a dedicated remote of the Somfy brand. However, just like with a TV, finding the remote is often tricky, so I decided to try and automate the external blind movements through Home Assistant and further voice commands of Google Home.</p><p>  我们已经搬到了一个新公寓，它的功能之一是外部百叶窗（又称遮罩），该百叶窗是由尚飞品牌的专用遥控器控制的。但是，就像在电视机上一样，找到遥控器通常很棘手，因此我决定尝试通过Home Assistant和Google Home的其他语音命令来使外部盲目动作自动化。</p><p> The system in place is a Somfy’s Telis 4 RTS Pure remote, with two remotes, each being able to program 5 channels (4 individual ones and combined). The system uses a legacy, proprietary radio protocol called  RTS, which only Somfy and Telis use.</p><p> 该系统是尚飞的Telis 4 RTS Pure遥控器，带有两个遥控器，每个遥控器都可以对5个频道进行编程（4个独立频道并组合）。该系统使用称为RTS的传统专有无线电协议，只有Somfy和Telis使用。</p><p> Somfy offers a RTS bridge called  Somfy MyLink for a wooping ~300CHF, which is a little steep for something that is not necessary and just scratching an itch. Also, there’s not much fun in that.</p><p> Somfy提供了一个名为Somfy MyLink的RTS桥接器，价格约为300CHF，对于不需要的东西来说有点陡峭，只是痒痒。另外，这也没有太多的乐趣。</p><p>  Turns out,  Nickduino had a similar itch to scratch. Using 3-4 CHF-worth of hardware components, it is quite easy to build a software radio that will immitate a Somfy Telis remote and control the blinds.</p><p>  事实证明，尼克杜伊诺也有类似的痒挠。使用价值3-4瑞士法郎的硬件组件，可以很容易地构建一个软件无线电来模仿Somfy Telis遥控器并控制百叶窗。</p><p> There’s an bare-bones  Somfy Remote Arduino sketch that shows how the protocol works. I originally wanted make the blind controller as small as possible and base it on an  ESP32, taking that sketch and controlling it via  arduino-mqtt.</p><p> 有一个简单的Somfy Remote Arduino草图，显示了协议的工作原理。我最初想使盲目控制器尽可能小，并基于ESP32进行设计，并通过arduino-mqtt对其进行控制。</p><p> Turns out there is a full MQTT/web interface script  Nickduino/Pi-Somfy that also only goes into the details of how to solder things, and connect things onto a Raspberry Pi. Laziness won the day, especially as I wanted to use my spare Pi for something anyway.</p><p> 事实证明，这里有完整的MQTT / Web界面脚本Nickduino / Pi-Somfy，该脚本也仅详细介绍了如何焊接以及将其连接到Raspberry Pi的细节。懒惰赢得了这一天，尤其是因为我无论如何都想用我的备用Pi做某事。</p><p>  Usually for 433MHz signals you could easily use a ready-made module such us  this 2CHF sender-receiver pair. However, in order for Somfy to make their RTS even more proprietary than it already was, it is not using the typical  433.93MHz frequency but  433.42MHz 🤦‍♂️. This means one will need to do some soldering.</p><p>通常对于433MHz信号，您可以轻松地使用现成的模块，例如2CHF发送器/接收器对。但是，为了使Somfy拥有比现在更高的RTS专有性，它没有使用典型的433.93MHz频率，而是使用433.42MHz🤦♂️。这意味着将需要进行一些焊接。</p><p>   After 4 weeks, all the eBay items were in place, and I could start soldering. Turns out de-soldering things off is much harder than soldering things on. I managed to peel away the original oscillator with by applying leverage underneath it using a swiss army knife and heating its connectors one by one. Soldering the new one was quite easy in comparison.</p><p>   4周后，所有eBay物品都就位了，我可以开始焊接了。事实证明，取消焊接的难度比焊接的难度大得多。我设法通过使用瑞士军刀在杠杆下方施加杠杆并逐一加热其连接器来剥落原始振荡器。相比之下，焊接新产品非常容易。</p><p>  I then took a 17cm piece of solid copper cable, and wrapped it into a small coil. Turns out soldering a think 1mm cable to a tiny connector was the trickiest bit, but with the right amount of patience, things will stick eventually.</p><p>  然后，我拿起一根17厘米的实心铜电缆，并将其包裹成一个小线圈。原来，将一根1mm的电缆焊接到一个微小的连接器上是最棘手的事情，但是如果有足够的耐心，事情最终会持续下去。</p><p> Eventually, the fully connected sender fits nicely into a Raspberry Pi enclosure after connecting everything to the GPIO 4 pin:</p><p> 最终，将所有东西都连接到GPIO 4引脚后，完全连接的发送器很好地适合Raspberry Pi外壳：</p><p>   Installing Pi-Somfy is super easy, just follow  these steps. It assume you install it under the default  pi user in  /home/pi, and comes with a handy  systemctl service for auto-starting the system.</p><p>   安装Pi-Somfy非常容易，只需执行以下步骤。假定您将其安装在/ home / pi的默认pi用户下，并且附带了一个方便的systemctl服务，用于自动启动系统。</p><p> By default it will come up on port  :80 of your Pi. Programming the blinds takes a little bit of time. The procedure is as follows:</p><p> 默认情况下，它将在您的Pi的端口：80上显示。对百叶窗进行编程需要一点时间。步骤如下：</p><p> Set the right channel (individual blind, or all) on the remote you’re programming from.</p><p> 在您要进行编程的遥控器上设置正确的频道（单个百叶窗或全部）。</p><p>  Click  Add new to put in the name (this will be your MQTT name by the way) and add in the time.</p><p>单击“添加新名称”以输入名称（顺便说一下，这将是您的MQTT名称）并添加时间。</p><p> Using a pen, press the “hole” on the other side of the remote. This sends the signal to the blind to accept programming a new remote.</p><p> 用笔按遥控器另一侧的“孔”。这会将信号发送到百叶窗以接受对新遥控器的编程。</p><p> Note: The system relies on time to figure out where the blind is percentage-wise. It can often get things wrong (e.g. if you stopped it mid-through), or on the all-channel if blinds have different lengths (e.g. balcony). But in practice it works remarkably well.</p><p> 注意：系统依靠时间来确定盲注百分比。它通常会弄错事情（例如，如果您在中途停止），或者如果百叶窗的长度不同（例如，阳台），则可能会在全通道出现问题。但实际上，它的效果非常好。</p><p>   MQTT is a standard protocol for message brokers, and finds a lot of use in home IoT. For most use cases, it has a simple publish-subscribe mechanic based on topics.</p><p>   MQTT是消息代理的标准协议，在家庭物联网中有很多用途。对于大多数用例，它都有一个基于主题的简单的发布-订阅机制。</p><p>  Home Assistant has an embedded MQTT broker, but it is  highly advised to use an external one, such as Mosquitto. You should install it on the same machine that runs Home Assistant, as it will act as a hub for other MQTT-connected services. To do that on Ubuntu:</p><p>  家庭助理具有嵌入式MQTT代理，但是强烈建议使用外部代理，例如Mosquitto。您应该将其安装在运行Home Assistant的同一台计算机上，因为它将充当其他MQTT连接的服务的集线器。要在Ubuntu上做到这一点：</p><p>  Now let’s set up a password file in  /etc/mosquitto/passwd with a user for  homeassistant and  pisomfy.</p><p>  现在，与用户一起在/ etc / mosquitto / passwd中设置一个密码文件，以实现homeassantant和pisomfy。</p><p>    For debugging purposes, open a separate tab on the same machine and subscribe to all messages under the  home-assistant/# topic via:</p><p>    为了进行调试，请在同一台计算机上打开一个单独的选项卡，并通过以下方法订阅“ home-assistant /＃”主题下的所有消息：</p><p>         On your Pi machine, open  /home/pi/operateShutters.conf and edit the `[MQTT] section to look as follows</p><p>在您的Pi机器上，打开/home/pi/operateShutters.conf并编辑`[MQTT]部分，如下所示</p><p> [MQTT] # Location (IP Address of DNS Name) of the MQTT Server MQTT_Server  =  myHAmachine # or hostname of your home assistant machine # Port of the MQTT Server MQTT_Port  =  1883 # Username for the MQTT Server MQTT_User  =  pisomfy # Password of the MQTT Server MQTT_Password  =  YourPiSomfyPassword # Enable auto discovery EnableDiscovery  =  true</p><p> [MQTT]＃MQTT服务器的位置（DNS名称的IP地址）MQTT_Server = myHAmachine＃或家庭助手计算机的主机名＃MQTT服务器的端口MQTT_Port = 1883＃MQTT服务器的用户名MQTT_User = pisomfy＃MQTT的密码服务器MQTT_Password = YourPiSomfyPassword＃启用自动发现EnableDiscovery = true</p><p>    At this point the tab with the subscriptions should be full of messages. These are auto-discovery messages over MQTT for each of the programmed covers. This will cause Home Assistant to automatically add the entities.</p><p>    此时，带有订阅的选项卡应充满消息。这些是针对每个已编程封面通过MQTT进行的自动发现消息。这将使Home Assistant自动添加实体。</p><p>     In order to simplify things, I wanted to only expose the  _all blinds (a.k.a. covers) to Google Home/Assistant. For that I added an explicit section in the  /etc/homeassistant/configuration.yaml section of  google_assistant:</p><p>     为了简化操作，我只想将_all百叶窗（又称封面）暴露给Google Home / Assistant。为此，我在google_assistant的/etc/homeassistant/configuration.yaml部分中添加了显式部分：</p><p> google_assistant :    # ...    exposed_domains :   -  fan    entity_config :    cover.br_all :    expose :   true    aliases :   -  &#34;Bedroom Covers&#34;    cover.lr_all :    expose :   true    aliases :   -  &#34;Living Room Covers&#34;</p><p> google_assistant：＃...暴露域：-风扇实体配置：cover.br_all：暴露：真实别名：-“卧室盖” cover.lr_all：暴露：真实别名：-“客厅盖”</p><p> After restarting Home Assistant, and uttering the magical  Ok Google, Sync All Devices, the covers will show up in your Home App:</p><p> 重新启动Home Assistant，并说出神奇的Ok Google，同步所有设备后，封面将显示在您的Home App中：</p><p>    The killer feature is setting this up as a routine to open/close the blind as you wake up, go to sleep.</p><p>    杀手级功能将其设置为例行程序，以在您醒来，进入睡眠状态时打开/关闭百叶窗。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://mwitkow.me/posts/2020-11-08_somfy/">https://mwitkow.me/posts/2020-11-08_somfy/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/家庭/">#家庭</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/blinds/">#blinds</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/mqtt/">#mqtt</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>