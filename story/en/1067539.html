<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>在服务器上切换操作系统的错误方法 The wrong way to switch operating systems on your server</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">The wrong way to switch operating systems on your server<br/>在服务器上切换操作系统的错误方法 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-06-23 03:36:48</div><div class="page_narrow text-break page_content"><p>After  moving my server to Hetzner, I built up a large collectionof self-hosted services I use on a daily basis: from fun things likean  RSS reader and an  IRC bouncer, to critical services like my email. I ran them all with  docker-compose from a  Debian VPS.</p><p>将我的服务器移动到Hetzner后，我建立了一系列自托管服务的大型集合，我每天使用：从有趣的东西就会喜欢RSS读卡器和IRC保镖，到我的电子邮件等关键服务。我用docker撰写了从debian vps跑上的全部。</p><p> For the last couple months, however, I’ve been meaning to move awayfrom Debian and towards something more minimal and clean. Over thislast weekend, I decided to move to  Alpine Linux.</p><p> 然而，在过去的几个月里，我一直意味着移开Debian，并朝着更低最小化的东西。在此周末，我决定搬到阿尔卑斯山Linux。</p><p>     In a previous move between two servers, I simply  rsynced therelevant files over to the new VPS. Here, where I’m just switchingoperating systems on a single server, I figured I could make a backupwith Tarsnap, and be done within the day.</p><p>     在前面的两个服务器之间移动中，我简单地将其rshynctant文件rsyhcant文件朗读到新vps。在这里，我只是在单个服务器上切换系统，我认为我可以备份tarsnap，并在一天内完成。</p><p> However, backups are much more complex than simply transferring filesfrom one server to another. My haphazard strategy resulted in threedays of stress and frustration as I clambered to restore aself-hosting empire that I myself had reduced to ash.</p><p> 但是，备份比简单地将文件传输到另一台服务器到另一台服务器更复杂。我的潜意战略导致了压力和挫折的程度，因为我克服了恢复了我自己已经减少到灰烬的托管帝国。</p><p>  I began my work on the transition full of optimism, if a bit stressed.I had read through the Tarsnap online documentation a number of times,and was ready to make my first attempt. I loaded my Tarsnap account upwith USD$10 and ran:</p><p>  如果有点强调，我开始过渡到过渡的过渡。我已经通过了多次通过Tarsnap在线文档阅读了，并准备好了我的第一次尝试。我加载了我的Tarsnap账户Upwith US $ 10和RAN：</p><p>  My terminal sat empty for hours. There were no changes – the processwas running, but there was no feedback. I was nervous.</p><p>  我的终端坐了几个小时。没有更改 - 流程运行，但没有反馈。我很紧张。</p><p>   To my horror, stats printed to the screen: the backup had been 90%complete, and I had stopped it. Convinced I had ruined the backupcompletely, I deleted the partial backup from Tarsnap and startedagain from scratch.</p><p>   为了我的恐怖，印刷到屏幕的统计数据：备份已完成90％，我已经停止了它。确信我已经破坏了备份操作，我从Tarsnap删除了部分备份，并从头开始了。 </p><p> This was my first, but not last, moment close to tears. I went tosleep and let the backup run overnight.</p><p>这是我的第一个，但不是持续的，靠近泪水的时刻。我走了tosleep，让备份运行过夜。</p><p>  Day Two began well: I woke and the backup was finished! I wiped theVPS, installed Alpine, and brought it up to spec. I created a regularuser, configured SSH, and decided to use  doas instead of  sudo fora change. Alpine, so far, feels great to use. None of the cruft thatbothered me when using Debian.</p><p>  第二天开始良好：我醒了，备份结束了！我擦拭了vps，安装了高山，并将其带到了规格。我创建了一个正则风险，配置了ssh，并决定使用doas而不是sudo fora更改。阿尔卑斯山，到目前为止，感觉很好。使用Debian时，没有骗子呢。</p><p>     I opened up a new  tmux window and poked around the filesystem. Allmy files seemed like they were already there…</p><p>     我打开了一个新的tmux窗口并在文件系统周围戳戳。艾默的文件似乎已经存在......</p><p>    It errored out. All my environment variables were undefined. Then ithit me: I forgot to back up the  .env file. My eyes welled up.</p><p>    它耗尽了。我的环境变量都是未定义的。然后我：我忘了备份.env文件。我的眼睛很好。</p><p> Still, I was determined. I worked to reconstruct the  .env file fromsecrets I had stored in  Bitwarden (my offline copy, because my vaultis self-hosted and was thus down).</p><p> 仍然，我决定了。我努力重建，重建.env文件，我已经存储在Bitwarden（我的离线副本，因为我的Vaultis自托管，因此下降）。</p><p>   One of my services was missing a Dockerfile to build. I shouldn’t havepressed  &lt;Ctrl-C&gt;! I was a total moron.</p><p>   我的一个服务缺少船坞才能建立。我不应该抑制＆lt; ctrl-c＆gt;！我是一个总体的白痴。</p><p>  I gathered what was left of my resolve and trudged onwards. I searched tarsnap’s manpages looking for something to speed up my download.</p><p>  我收集了我的决心和拒绝了什么。我搜索了Tarsnap的编辑寻找速度下载的东西。 </p><p> I found a number of flags that could have helped me  make a backupbetter the next time around, but nothing that would help me restorethe backup any faster. With nothing in the manpages, I went to look atthe  helper scripts.</p><p>我发现了许多可以帮助我在下次留下备份的标志，但没有任何东西可以帮助我恢复备份任何更快。在人页中没有什么，我去看了帮助脚本。</p><p>  That’s when I found it:  redsnapper. A Ruby script that runs multipletarsnap clients at once to extract archives  fast. Fuckingprecisely. I wiped out the incomplete files I had restored, downloadedRuby and started restoring from the backup once again:</p><p>  那是我发现它的时候：RedSnapper。一个Ruby脚本，一次运行MultipletarSnap客户端以快速提取存档。他妈的需要。我擦掉了我恢复的不完整文件，下载了粗暴，并再次从备份中重新恢复：</p><p>  I changed  the song, and watched the files fly by on my screen. Iwent to sleep, confident I would wake to good news.</p><p>  我改变了这首歌，并在屏幕上观看了文件飞行。我要睡觉，有信心我会唤醒好消息。</p><p>    I restarted  redsnapper, explicitly excluding the  .mkv it hadfailed to download, and let it run until it came on another movie andcrashed again (an hour or so later). I excluded the second movie fileand sent it to run again.</p><p>    我重新启动了RedSnapper，明确排除.mkv它已触动下载，并让它运行，直到它进入另一部电影并再次（一个小时左右）。我排除了第二部电影fileand发送它再次运行。</p><p>   Then I realized something.  redsnapper kept crashing when it hitmovies I had stored in  Jellyfin.</p><p>   然后我意识到了一些东西。当我储存在果冻垃圾中时，Redsnapper在困境时崩溃了。</p><p> I don’t need Jellyfin at all. I’ve never watched a movie more thanonce.</p><p> 我根本不需要果冻垃圾。我从未看过电影更远。</p><p> The movies take up massive storage on disk, and keep causing tarsnapto crash. They don’t compress well either, so they take up a fucktonof space in the archives.</p><p> 电影在磁盘上占据大量存储，并继续导致Tarsnapto崩溃。它们也不妥善压缩，所以他们在档案中占用了一个笨拙的空间。 </p><p> I stopped the download in the middle - the day’s third, after twoearlier attempts that ended after encountering movie files – andchanged the command slightly before rerunning. After a number oferrors I couldn’t explain, I realized my account was negative andtopped it up with another USD$25 before running:</p><p>我在遇到电影文件后结束后的两次尝试后停止下载 - 在遇到电影文件后的两次尝试 - 在重新运行之前稍微加强命令。经过一批人无法解释，我意识到我的账户是消极的，在运行之前，在另外25美元的价格下降：</p><p>  I returned to my computer a couple hours later.  redsnapper hadstopped, with a whole lot of files extracted and a couple errors atthe bottom about symlinks.</p><p>  几个小时后我回到了我的电脑。 RedSnapper Hadstopped，大量文件提取了大量的文件，底部有关符号链接的若干错误。</p><p> I figured, this time, it had probably done everything properly butcouldn’t create the symlinks (probably a flag missing somewhere). Imanually went through my files creating the symlinks, and then broughteverything up with docker-compose.</p><p> 我想，这一次，它可能已经正确地完成了一切，也可能无法创建符号链接（可能是困境某处的旗帜）。成本通过我的文件创建符号链接，然后用Docker-Compose撰写。</p><p>      After shutting down my containers, I backed up my entire setup.This included a number of  “live” databases,  .git folders,and other data that I either did not need or could reconstructonce the move had been completed.</p><p>      在关闭我的容器后，我备份了我的整个setup.这包括一些“直播”数据库，.git文件夹和我要么不需要的其他数据，也可以重建移动。</p><p> I didn’t back up the  .env file I use to store secrets for use in docker-compose.yml. I was luckily able to reconstruct it fromindividual secrets I stored in my password manager.</p><p> 我没有备份.env文件，我用来存储用于docker-compose.yml的秘密。我很幸运能够重建我在密码管理器中存储的单独秘密。</p><p> A thorough read of the manpages before I started (rather than justthe online guides) would have revealed several helpful flags: -v to see what files  tarsnap is operating on, --aggressive-networking to take advantage of the datacenterinternet speeds, and  --recover to resume interrupted backups, toname a few.</p><p> 在我开始（而不是在线指南）之前彻底阅读了联系人：-V查看Tarsnap正在运行的文件， - 达到数据中心互联网速度，以及 - 恢复以恢复中断备份，调音款。</p><p> We already talked about Jellyfin. Even with very little content inJellyfin, the collection took up huge amounts of space on disk andin the backup (especially because video files don’t compresswell), and sat entirely unused. It is now gone. Good riddance.</p><p> 我们已经谈过果冻垃圾。即使内容少量不少垃圾杂志，该系列也占据了磁盘上的大量空间，备份（特别是因为视频文件不compresswell），并且完全未使用。现在已经消失了。甩掉包袱。 </p><p>  What did I learn? Well, I’m still devising a plan to prevent thingslike this from happening in the future. Here’s the plan currently:</p><p>我学到了什么？好吧，我还在制定计划，以防止事情在未来发生这种情况。以下是目前的计划：</p><p>  Back up everything every day. I’ll build a buffer of three “rolling”backups, where backups collect up to a max of three and then, as newbackups are created, the older backups are removed.</p><p>  每天备份一切。我将构建三个“滚动”备份的缓冲区，其中备份收集到最多三个，然后在创建新返回时，删除较旧的备份。</p><p> The backup script will shut down the services, dump the databases(i.e. convert as much content to plain-text, easily-compressibleformats as possible) and make a time-stamped backup (currently onlywith Tarsnap, but perhaps in the future with a number of otherservices).</p><p> 备份脚本将关闭服务，转储数据库（即，将内容转换为纯文本，易于压缩的Formbats，并制作时间戳备份（目前仅用于Tarsnap，但在未来可能在未来其他服务）。</p><p>  Simply having high-quality backups to restore will already be a hugeleap forward. I’m also  definitely going to continue using redsnapper: the speed gains it gives on large backups are crucial.</p><p>  简单地拥有恢复的高质量备份将是一个前向前的hugeleap。我肯定会继续使用RedSnapper：在大备份上给出的速度收益至关重要。</p><p>    I’ll write further about my self-hosting setup as it evolves, andpublish the backup script once its finished. I’ll also maintain adedicated page on my site describing my self-hosting setup as itchanges.</p><p>    我会在进一步的情况下进一步写入我的自托管设置，并在完成后备份脚本。我还将在我的网站上保持暗示的页面，将我的自托管设置为Itchanges。</p><p> Also, I’m sure there are people more knowledgeable about Tarsnap thanI. That’s basically the point of this article. If you are one of thesepeople, please don’t hesitate to  email me if you’ve got corrections,advice, or just want to flex that you know how to do backups betterthan I do.</p><p> 此外，我相信有人对Tarsnap Thani有更多了解。这基本上是这篇文章的重点。如果您是TheSepeople之一，请不要犹豫，如果您有更正，建议或只是想弯曲，请致以巧妙，您知道如何进行备份。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://figbert.com/posts/wrong-way-to-switch-server-os/">https://figbert.com/posts/wrong-way-to-switch-server-os/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/操作系统/">#操作系统</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/switch/">#switch</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/备份/">#备份</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>