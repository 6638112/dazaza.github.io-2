<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>SSH紧急访问</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">SSH紧急访问</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-04 19:45:00</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/7/8afd141fbc81c9593e41ccc0b61c3d13.png"><img src="http://img.diglog.com/img/2020/7/8afd141fbc81c9593e41ccc0b61c3d13.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>在这篇文章中，我们将设计一个破玻璃程序，以便在紧急情况下使用可以离线存储的安全密钥联系SSH主机。这只是一种方法，但您可以根据您的情况进行调整。我们将在硬件安全密钥上存储脱机SSH证书颁发机构，并让我们的主机信任该CA。这几乎可以在任何OpenSSH设置上工作，包括我们的单点登录SSH。</p><p>你为什么想要这个？只是作为最后的选择。一个后门进入您的服务器，无论出于什么原因，其他东西都不起作用。</p><p>被动撤销。证书过期；公钥不过期。您可以创建有效期为1分钟甚至5秒的SSH证书。一旦过期，证书将无法用于新连接。这非常适合偶尔进行紧急访问。</p><p>您将能够为主机上的任何帐户创建证书，并根据需要将短期证书发送给同事。</p><p>支持驻留密钥的硬件安全密钥。驻留密钥是完全存储在安全密钥上的加密密钥-有时受字母数字PIN保护。驻留密钥的公共部分可以在需要时与私钥句柄一起从安全密钥导出。Yubikey 5系列密钥支持常驻密钥。最好将这些密钥专用于紧急主机访问。在这篇文章中，我将只使用一个密钥，但是您应该有一个备用密钥。</p><p>在本地计算机和要紧急访问的服务器上安装OpenSSH 8.2或更高版本。Ubuntu20.04附带OpenSSH8.2。</p><p>(可选)检查证书的步骤CLI-在MacOS上使用BREW安装步骤进行安装(此处有Linux安装说明)。</p><p>对于注释(-C)，我提供了Yubikey-9-512-742@mall step.com来提醒我该CA引用的是哪个安全密钥(在Yubikey上，序列号打印在密钥本身上)。</p><p>除了将密钥添加到Yubikey之外，这还将在本地生成两个文件：</p><p>但别担心，Yubikey上存储着另一个无法提取的真正的私钥。</p><p>作为主机上的root用户，如果您还没有sshd配置(/etc/ssh/sshd_config)，请将其添加到sshd配置中：</p><p>然后，将CA公钥(sk-user-ca.pub)的内容附加到主机上的/etc/ssh/ca.pub。</p><p>现在我们可以尝试访问主机了。但是我们首先需要一张证书！</p><p>人们很容易将SSH证书视为公钥/私钥对的替代品，但仅有证书并不足以对用户进行身份验证。每个SSH证书还具有与其关联的专用密钥。这就是我们在给自己颁发证书之前需要生成这个紧急密钥对的原因。重要的是向服务器提供了一个签名证书，该证书指向您拥有私钥的密钥对。我们实际上不需要Emergency.pub来运行这些命令中的任何一个，但是无论如何，我们都可以从ssh-keygen获得一个。</p><p>因此，即使有证书，公钥交换仍然有效。证书只是消除了服务器存储公钥的需要。</p><p>现在创建证书本身；它将允许用户ubuntu在5分钟前开始的10分钟窗口内登录(以解决时钟偏差问题)。您可以根据需要更改这些值。</p><p>紧急证书pub类型：ecdsa-sha2-nistp256-cert-v01@openssh.com用户证书公钥：ecsa-cert SHA256:EJSfzfQv1UK44/LOKhBbuh5oRMqxXGBSr+UAzA7cork签名CA：sk-ecdsa SHA256:kLJ7xfTTPQN0G/IF2cq5TB3EitaV4k3XczcBZcLPQ0E密钥ID：&#34；测试密钥&#34；序列号：0有效期：2020-06-24T16：53：03至2020-06-24T16：03：03主体：ubuntu关键选项：(无)扩展：允许-x11-转发许可-代理-转发。</p><p>这里，公钥是您创建的紧急密钥，签名CA是sk-user-ca。</p><p>就是这样！🥳您现在可以为信任您的紧急证书颁发机构的主机上的任何用户创建ssh证书。</p><p>您现在可以删除紧急情况*。您可以保留sk-user-ca*，但不需要这样做，因为它也驻留在安全密钥上。您可能还希望从主机中删除原始的PEM公钥(例如，在ubuntu用户的~/.ssh/AuthorizedKEYS中)，如果您一直在使用它进行紧急访问的话。</p><p>为任何用户创建有效期为一小时或更短时间的证书(如果需要)：</p><p>$ssh-keygen-t ecdsa-f紧急$ssh-keygen-us sk-user-ca.pub-i test-key-n[用户名]-V-5M：+60M紧急$chmod 600紧急-cert.pub。</p><p>如果现有的.ssh/config文件在连接时导致任何问题，您可以运行ssh并使用-F NONE来绕过它。</p><p>如果您需要向同事发送证书，Magic Wormhole是一个简单而安全的选择。他们唯一需要的文件就是紧急情况和紧急情况-cert.pub。</p><p>我喜欢这种方法的原因是它的硬件是有后盾的。你可以把安全钥匙放在保险箱里，除非你需要它们，否则它们哪儿也不会去。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://smallstep.com/blog/ssh-emergency-access/">https://smallstep.com/blog/ssh-emergency-access/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/ssh/">#ssh</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/emergency/">#emergency</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/密钥/">#密钥</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1008651.html"><img src="http://img.diglog.com/img/2020/6/thumb_69aef10d4962ebcacfbf8b7b112b4f93.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008651.html">秘而不宣-MacOS原生应用程序在安全飞地中存储SSH密钥</a></div><span class="my_story_list_date">2020-6-28 4:23</span></div><div class="col-sm"><div><a target="_blank" href="/story/1002907.html"><img src="http://img.diglog.com/img/2020/5/thumb_bcc6300cd79dbdb19c60f6443e367e14.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1002907.html">SSH代理已解释</a></div><span class="my_story_list_date">2020-5-20 9:19</span></div><div class="col-sm"><div><a target="_blank" href="/story/1001142.html"><img src="http://img.diglog.com/img/2020/5/thumb_5553ec8757f36ceba1352e115c8fc3c7.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1001142.html">基础设施安全不会拖累开发人员</a></div><span class="my_story_list_date">2020-5-8 2:28</span></div><div class="col-sm"><div><a target="_blank" href="/story/1000281.html"><img src="http://img.diglog.com/img/2020/5/thumb_efcfd4d38b9caa03b20a374e4c3f9f77.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1000281.html">SSH黑客攻击-远程员工的一点理智</a></div><span class="my_story_list_date">2020-5-2 18:4</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>