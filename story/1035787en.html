<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Safari中的Cname隐藏和反弹追踪防御Cname Cloaking and Bounce Tracking Defense in Safari</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Cname Cloaking and Bounce Tracking Defense in Safari<br/>Safari中的Cname隐藏和反弹追踪防御</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-22 03:28:20</div><div class="page_narrow text-break page_content"><p>This blog post covers several enhancements to Intelligent Tracking Prevention (ITP) in Safari 14 on macOS Big Sur, Catalina, and Mojave, iOS 14, and iPadOS 14 to address our latest discoveries in the industry around tracking.</p><p>这篇博客文章涵盖了macOS Big Sur，Catalina和Mojave，iOS 14和iPadOS 14上Safari 14中的智能跟踪预防（ITP）的多项增强功能，以解决我们在跟踪领域的最新发现。</p><p>  ITP now caps the expiry of cookies set in so-called third-party CNAME-cloaked HTTP responses to 7 days. On macOS, this enhancement is specific to Big Sur.</p><p>  现在，ITP将在所谓的第三方CNAME隐藏的HTTP响应中设置的Cookie的有效期限设置为7天。在macOS上，此增强功能特定于Big Sur。</p><p>  In the eyes of web browsers, the first party of a website is typically defined by its registrable domain. This means that  www.blog.example and  comments.blog.example are considered same-site and the same party. If the user loads a webpage from  www.blog.example, and that page makes a subresource request to  comments.blog.example, that request will carry all cookies that are set to cover the  blog.example site, including login cookies and user identity cookies. In addition, the response to that  comments.blog.example subresource request can  set cookies for  blog.example, and those cookies will be first-party cookies.</p><p>  在网络浏览器看来，网站的第一方通常由其可注册域定义。这意味着www.blog.example和comments.blog.example被视为同一站点和同一方。如果用户从www.blog.example加载网页，并且该页面向comments.blog.example发出子资源请求，则该请求将携带所有设置为覆盖blog.example网站的cookie，包括登录cookie和用户身份饼干。另外，对该comment.blog.example子资源请求的响应可以为blog.example设置cookie，并且这些cookie将是第一方cookie。</p><p> Enter CNAMEs. CNAME stands for canonical name record and maps one domain name to another as part of the Domain Name System, or DNS. This means a site owner can configure one of their subdomains, such as  sub.blog.example, to resolve to  thirdParty.example, before resolving to an IP address. This happens underneath the web layer and is called  CNAME cloaking — the  thirdParty.example domain is cloaked as  sub.blog.example and thus has the same powers as the true first party.</p><p> 输入CNAME。 CNAME代表规范名称记录，并将一个域名映射到另一个域名，作为域名系统或DNS的一部分。这意味着网站所有者可以在解析为IP地址之前，配置其子域之一（例如sub.blog.example）以解析为thirdParty.example。这种情况发生在Web层下面，称为CNAME伪装-thirdParty.example域被伪装为sub.blog.example，因此具有与真正的第一方相同的权力。</p><p>  Cross-site trackers have convinced site owners to set up CNAME cloaking in order to circumvent tracking prevention, such as ITP’s 7-day expiry cap on cookies set in JavaScript. In our blog case, this would be making  track.blog.example resolve to  tracker.example.</p><p>  跨站点跟踪程序已说服站点所有者设置CNAME伪装，以规避跟踪预防，例如ITP对JavaScript中设置的Cookie的7天有效期上限。在我们的博客案例中，这将把track.blog.example解析为tracker.example。</p><p> A  recent paper from researchers at the Graduate University for Advanced Studies (Sokendai) and the French National Cybersecurity Agency (ANSSI) found 1,762 websites CNAME cloaking 56 trackers in total.</p><p>高级研究大学（Sokendai）和法国国家网络安全局（ANSSI）研究人员的最新论文发现，共有1,762个CNAME网站掩盖了56个跟踪器。</p><p>  Site owners who set up CNAME cloaking risk full website takeovers or customer cookie hijacking if the CNAME records aren’t properly managed, for instance if CNAME cloaking isn’t decommissioned when no longer in use. It was  recently reported that 250 websites of banks, healthcare companies, restaurant chains, and civil rights groups had been compromised through mismanaged CNAME cloaking. In June this year, Microsoft  documented these attacks and how their cloud customers should prevent them.</p><p>  如果对CNAME记录的管理不当，例如，如果CNAME伪装不再使用时就不再使用，那么设置CNAME伪装的网站所有者可能会面临整个网站被收购或客户Cookie劫持的风险。最近有报道称，由于CNAME伪装管理不当，银行，医疗保健公司，饭店连锁和民权组织的250个网站遭到破坏。微软在今年6月记录了这些攻击以及他们的云客户应如何防止它们。</p><p>  ITP now detects third-party CNAME cloaking requests and caps the expiry of any cookies set in the HTTP response to 7 days. This cap is aligned with ITP’s expiry cap on all cookies created through JavaScript.</p><p>  现在，ITP会检测到第三方CNAME的伪装请求，并将HTTP响应中设置的任何cookie的有效期限设置为7天。此上限与ITP通过JavaScript创建的所有Cookie的有效期限一致。</p><p> Third-party CNAME cloaking is defined as a first-party subresource that resolves through a CNAME that differs from the first-party domain and differs from the top frame host’s CNAME, if one exists. Yes, the whole site can be CNAME cloaked, when it uses so called edge servers.</p><p> 第三方CNAME伪装被定义为第一方子资源，该子资源通过与第一方域不同且与顶级主机的CNAME（如果存在）不同的CNAME进行解析。是的，当使用所谓的边缘服务器时，整个站点都可以被CNAME隐藏。</p><p> The best way to explain this is through a table (1p means first-party, 3p means third-party):</p><p> 最好的解释方法是通过表（1p表示第一方，3p表示第三方）：</p><p>   In June 2018, we announced an update to ITP to detect and defend against  first party bounce trackers. In March 2020, we announced an enhancement to also detect  delayed bounce tracking. Since then, we have received a report of one specific website engaged in bounce tracking while also being likely to get frequent user interaction. To combat such issues, we proposed to the W3C Privacy Community Group what we call a  SameSite=Strict jail as well as other escalations.</p><p>2018年6月，我们宣布对ITP进行更新，以检测和防御第一方跳动跟踪器。 2020年3月，我们宣布了一项增强功能，可以检测延迟的反弹跟踪。从那时起，我们收到了一份有关跳出跟踪的特定网站的报告，同时也有可能频繁地与用户互动。为了解决此类问题，我们向W3C隐私社区小组提出了所谓的SameSite = Strict监禁以及其他升级建议。</p><p> What the SameSite=strict jail does is detect bounce tracking and, at a certain threshold, rewrite all the tracking domain’s cookies to  SameSite=strict. This means that they will not be sent in cross-site, first-party navigations, and they can no longer be used for simple redirect-based bounce tracking.</p><p> SameSite = strict监狱的工作是检测跳出跟踪，并在一定阈值下将所有跟踪域的Cookie重写为SameSite = strict。这意味着它们将不会在跨站点的第一方导航中发送，并且不再可以用于基于重定向的简单反弹跟踪。</p><p> Our implementation is rather relaxed, with the threshold set to 10 unique navigational, first-party redirects (unique in the sense of going to unique domains), and an automatic reset of that counter once the cookies are rewritten to SameSite=strict. This automatically gives the domain a new chance so that they can disengage in bounce tracking and “get out of jail.”</p><p> 我们的实现相当轻松，将阈值设置为10个唯一的导航，第一方重定向（就唯一域而言是唯一的），并且一旦将cookie重写为SameSite = strict后，该计数器就会自动重置。这会自动为域提供新的机会，使他们可以脱离跳出跟踪并“摆脱监禁”。</p><p> Our current list of domains we subject to this protection is empty because the domain reported to us has stopped their bounce tracking. But this protection remains in our toolbox.</p><p> 我们当前受此保护的域列表为空，因为报告给我们的域已停止其退信跟踪。但是这种保护仍然保留在我们的工具箱中。</p><p>  Up until now, WebKit has blocked cross-origin IndexedDB. WebKit now allows partitioned and ephemeral third-party IndexedDB in an effort to align with other browsers now that they are interested in storage partitioning too. You can partake in the ongoing standardization effort for storage partitioning on  GitHub.</p><p>  到目前为止，WebKit已阻止跨域IndexedDB。现在，WebKit允许分区的和临时的第三方IndexedDB努力与其他浏览器保持一致，因为它们也对存储分区也很感兴趣。您可以参与GitHub上正在进行的存储分区标准化工作。</p><p> Partitioned means unique IndexedDB instance per first-party site and ephemeral means in-memory-only, i.e. goes away on browser quit.</p><p>分区意味着每个第一方站点都有唯一的IndexedDB实例，短暂意味着仅在内存中，即在浏览器退出时消失。</p><p>  Private Browsing in Safari is based on WebKit’s ephemeral sessions where nothing is persisted to disk. This means ITP would not be able to learn things between launches of Safari. Further, Private Browsing also uses a separate ephemeral session for each new tab the user opens. To uphold this separation between tabs, ITP wouldn’t be able to classify cross-site trackers from the user’s full browsing  even in-memory.</p><p>  Safari中的私人浏览基于WebKit的短暂会话，其中任何内容都不会持久保存到磁盘。这意味着ITP将无法在Safari启动之间学习东西。此外，私人浏览还为用户打开的每个新选项卡使用单独的临时会话。为了维持标签之间的这种分隔，ITP甚至无法从用户的完整浏览中对跨站点跟踪器进行分类。</p><p> However, full third-party cookie blocking doesn’t need classification and is now enabled by default in Private Browsing. This might seem simple to support but the challenge was to make the Storage Access API work with the aforementioned tab separation. This is how it works: Say  identityProvider.example wants to request storage access as third-party on the login page for  social.example in Tab A. Interacting with  identityProvider.example as a first party website in Tab B will not suffice to allow it to request storage access in Tab A since that would leak state between the separate ephemeral sessions. Thus, the user must interact with  identityProvider.example  in the same tab as where  identityProvider.example later requests storage access as third-party. This makes sure that login flows where two different parties are involved and third-party cookie access is required, is possible in Private Browsing mode.</p><p> 但是，完整的第三方Cookie阻止功能不需要分类，并且默认情况下已在“私人浏览”中启用。这看起来似乎很容易支持，但是面临的挑战是使Storage Access API与上述选项卡分隔一起使用。它是这样工作的：假设identityProvider.example希望在登录页面上以第三方身份请求选项卡A中的social.example的存储访问。与identityProvider.example作为选项卡B中的第一方网站进行交互将无法允许它请求在选项卡A中进行存储访问，因为那样会在单独的临时会话之间泄漏状态。因此，用户必须在与identityProvider.example稍后请求第三方进行存储访问相同的选项卡中与identityProvider.example进行交互。这样可以确保在“私人浏览”模式下可以进行涉及两个不同方且需要第三方Cookie访问的登录流。</p><p>  Back in March 2020, when we  announced ITP’s 7-day cap on all script-writeable storage, developers asked about home screen web applications and whether they were exempt from this 7-day cap. We explained how ITP’s counter of “days of use” and capture of user interaction effectively made sure that the first party of home screen web applications would not be subjected to the new 7-day cap. To make this more clear, we have implemented an explicit exception for the first-party domain of home screen web applications to make sure ITP always skips that domain in its website data removal algorithm.</p><p>  早在2020年3月，当我们宣布ITP对所有可写脚本的存储设置7天上限时，开发人员就询问了主屏幕Web应用程序以及是否不受此7天上限的限制。我们解释了ITP的“使用天数”计数器和如何捕获用户互动，如何有效地确保第一屏主屏幕应用程序不会受到新的7天上限的限制。为了更清楚地说明这一点，我们为主屏幕Web应用程序的第一方域实现了一个明确的例外，以确保ITP始终在其网站数据删除算法中跳过该域。</p><p> In addition, the website data of home screen web applications is kept isolated from Safari and thus will not be affected by ITP’s classification of tracking behavior in Safari.</p><p> 此外，主屏幕Web应用程序的网站数据与Safari保持隔离，因此不会受到ITP在Safari中跟踪行为分类的影响。</p><p>  The above updates to WebKit and ITP would not have been possible without the help from Kate, Jiten, Scott, Tommy, Sihui, and David. Thank you!</p><p>没有Kate，Jiten，Scott，Tommy，Sihui和David的帮助，不可能对WebKit和ITP进行以上更新。谢谢！</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://webkit.org/blog/11338/cname-cloaking-and-bounce-tracking-defense/">https://webkit.org/blog/11338/cname-cloaking-and-bounce-tracking-defense/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/隐藏/">#隐藏</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/cloaking/">#cloaking</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/itp/">#itp</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>