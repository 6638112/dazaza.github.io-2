<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>在RBS中采用Ruby 3类型 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">在RBS中采用Ruby 3类型 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-26 11:21:18</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/12/feb0307586085b572c07461c5885df6e.png"><img src="http://img2.diglog.com/img/2020/12/feb0307586085b572c07461c5885df6e.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>随着Ruby 3.0的发展，我们来看看即将发布的版本的亮点之一：Ruby Type Signatures。是的，类型正在成为我们最喜​​欢的动态语言！让我们看看如何通过将类型添加到现实世界的开源项目中并查看流程的更详细点来利用它们。</p><p> 这不是我第一次涉及Ruby类型：大约一年前，我第一次体验了Sorbet，并在同一个Martian博客中分享了我的经验。在我的Sorbet帖子结束时，我答应尝试另一个Ruby类型检查器：Steep。所以，我在这里，偿还债务！</p><p>  我强烈建议您先阅读“排序宝石”一词，因为我会多次提及该文章。</p><p> RBS是与Sorbet完全不同的野兽：首先，它是Ruby核心团队的一项正式工作。其次，它使用一种完全不同的方法来注释程序：理想情况下，您可以将.rb文件完全保留不变。官方自述文件指出：</p><p>  “结构”包括类和方法签名，类型定义等。由于它是一种独立的语言，而不是Ruby，因此使用单独的.rbs文件来存储类型。</p><p>  ＃martian.rb class Martian＆lt;外星人def初始化（name，evil：false）super（name）@evil = evil结束def邪恶吗？ @evil end end＃martian.rbs类Alien attr_reader名称：字符串def初始化：（名称：字符串）-＆gt;无效的末级火星人＆lt; Alien @evil：bool def初始化：（name：String，？evil：bool）-＆gt;无效def邪恶？ ：（）-＆gt;布尔端</p><p> 除了我们为参数，方法和实例变量指定了类型之外，签名看起来与类定义本身非常相似。到目前为止，看起来很像Ruby。但是，RBS具有某些实体，例如Ruby中缺少的实体。稍后我们将看到一些示例。 </p><p>实际上，那不是100％正确；有一种运行时类型检查模式。继续阅读以了解更多信息。</p><p> RBS本身不提供执行类型检查的任何功能;只是一种语言，还记得吗？那就是陡峭进入的阶段。</p><p> 在本文的其余部分中，我将描述将RBS和Steep添加到Rubanok的过程-Rubanok是一种受俄罗斯Pinnochio启发的神奇Ruby DSL，用于在HTTP控制器中转换参数。在我的Sorbet帖子中，我以相同的库为例为您提供了连续感。如果想了解有关Rubanok本身的更多信息，请查看我的“雕刻像Papa Carlo这样的控制器”博客文章。</p><p>  可能很难弄清楚如何开始向现有项目添加类型。幸运的是，RBS提供了一种脚手架的方式。它带有一个CLI工具（rbs），该工具具有一定数量的命令，但我们只对原型感兴趣：</p><p> $ rbs prototype -h用法：rbs prototype [generator ...] [args ...]生成RBS文件的原型。支持的生成器是rb，rbi，runtime。示例：$ rbs prototype rb foo.rb $ rbs prototype rbi foo。 rbi $ rbs原型运行时字符串</p><p>  $ rbs prototype rb lib / ** / * .rb＃Rubanok提供了一个DSL ...（源文件中的所有注释）字段：无类型attr_reader activate_on：无类型attr_reader activate_always：无类型attr_reader ignore_empty_values：无类型attr_reader filter_with：无类型def初始化：（无类型字段，？activate_on：无类型Activate_on，？activate_always：bool ）-＆gt;无类型的def项目：（无类型的params）-> untyped def适用吗？：（ untyped params）-＆gt; （:: TrueClass | untyped）def to_method_name：（）-＆gt;未输入类型的私人def build_method_name：（）-＆gt; :: String def fetch_value ：（无类型的参数，无类型的字段）-＆gt; untyped def empty？：（ untyped val）-＆gt; （:: FalseClass | untyped）end＃＃＆lt; truncated＆gt;</p><p> 第一个选项（原型rb）为您使用静态分析（更确切地说，通过解析源代码和分析AST）传递的文件中指定的所有实体生成签名。 </p><p>此命令将所有发现的类型流式传输到标准输出。为了保存输出，我们可以使用重定向：</p><p>  我希望使用镜像签名文件来获取文件（即具有多个文件）。我们可以通过Unix的一些知识来实现​​：</p><p> 查找lib -name \ *。rb -print |切-sd / -f 2- | xargs -I {} bash -c＆＃39; export file = {};导出target = sig / $ file; mkdir -p $ {target％/ *}; rbs原型rb lib / $ file＆gt; sig / $ {file / rb / rbs}＆＃39;</p><p> 我认为，如果默认情况下具有上述功能会更好得多（或者这是一个功能-将所有签名保留在相同的文件🤔中）。</p><p> 另外，将注释从源文件复制到签名会使可读性降低（尤其是在有很多注释的情况下，例如我的情况）。当然，我们可以添加更多的Unix魔术来解决此问题...</p><p>  $ RUBYOPT =＆＃34; -Ilib＆＃34; rbs原型运行时-r rubanok Rubanok :: Ruleclass Rubanok :: Rule public def activate_always：（）->未键入的def activate_on：（）-> untyped def适用吗？：（ untyped params）-＆gt;未键入的def字段：（）-＆gt;无类型def filter_with：（）->无类型的def ignore_empty_values：（）-＆gt;无类型的def项目：（无类型的params）->无类型def to_method_name：（）-＆gt;未输入类型的私人def build_method_name：（）-＆gt; untyped def empty？：（ untyped val）-＆gt;无类型的def fetch_value ：（无类型的参数，无类型的字段）无类型def初始化：（无类型字段，？activate_on：无类型，？activate_always：无类型，？ignore_empty_values：无类型，？filter_with：无类型）-＆gt;无类型的</p><p> 在运行时模式下，RBS使用Ruby的自省API（Class.methods等）来生成指定的类或模块签名。 </p><p>让我们比较一下用rb和运行时模式生成的Rubanok :: Rule类的签名：</p><p>  那么，为什么可能会发现运行时生成器有用呢？我猜只有一个原因：动态生成的方法。例如，在Active Record中。</p><p> 因此，这两种模式都有其优点和缺点，同时使用它们将提供更好的签名覆盖率。不幸的是，目前还没有很好的方法来差异化/合并RBS文件;您必须手动执行。另一个手动工作是用实际打字信息替换未打字的信息。</p><p> 但是，暂时不要弄脏我们的手。该游戏中还有一个玩家-Type Profiler，这是Ruby核心团队的另一个实验工具。</p><p> Type Profiler在执行期间动态推断程序类型签名。它监视所有加载的类和方法，并收集有关哪些类型用作输入和输出的信息，分析此数据并生成RBS定义。在幕后，它使用了自定义的Ruby解释器（因此，代码实际上并未执行）。您可以在官方文档中找到更多信息。</p><p> TypeProf和RBS之间的主要区别是我们需要创建一个示例脚本以用作概要分析入口点。</p><p>  ＃sig / rubanok_type_profile.rb要求＆＃34; rubanok＆＃34;处理器=类。新的（Rubanok :: Processor）做地图：q do | q：|原始结尾匹配：sort_by，：sort，activate_on：：sort_by确实具有＆＃34; status＆＃34; ，＆＃34; asc＆＃34;做原始终端默认做| sort_by：，排序：＆＃34; asc＆＃34; |原始末端末端处理器。项目（{q：＆＃34; search＆＃34;，sort_by：＆＃34; name＆＃34;}）处理程序。呼叫（[]，{q：＆＃34; search＆＃34;，sort_by：＆＃34; name＆＃34;}） </p><p>$ typeprof -Ilib sig / rubanok_type_profile.rb --exclude-dir lib / rubanok / rails --exclude-dir lib / rubanok / rspec.rb＃Classesmodule Rubanok版本：字符串类规则未定义：对象@method_name：字符串attr_reader字段：未键入attr_reader activate_on：Array [untyped] attr_reader activate_always：false attr_readerignore_empty_values：未键入attr_reader filter_with：nil def初始化：（未键入，？activate_on：未键入，？activate_always：false，？ignore_empty_values：与未输入n，？filter nil def project：（未键入）-> untyped def适用吗？ ：（未键入）-＆gt; bool def to_method_name：-＆gt;字符串private def build_method_name：-＆gt;字符串def fetch_value ：（无类型，无类型）-＆gt;目的？ def空吗？ ：（无）-＆gt;错误结束＃...结束</p><p> 很好，现在我们定义了一些类型（尽管其中大多数仍然没有类型），TypeProf尊重了我们的方法和实例变量的可见性（我们之前从未见过）。方法的顺序与原始文件中的相同-很好！</p><p> 不幸的是，尽管TypeType是一个运行时分析器，但它在元编程支持方面却不是很好。例如，使用迭代定义的方法将不会被识别：</p><p> ＃a.rb A级％w [a b]。每个。 with_index {|我define_method（str）{i}}结束pA。新的。 a + A。新的。 b</p><p>   因此，即使您生成的可执行文件提供了100％的API覆盖率但使用元编程，TypeProf仍然不足以为您的程序构建完整的类型支架。</p><p> 综上所述，生成初始签名的所有三种方法都有其优点和缺点，但是将它们的结果相结合可以为在现有代码中添加类型提供非常好的起点。希望我们能够在未来实现此自动化。</p><p>  跑typeprof并使用其输出来添加缺少的实例变量并更新一些签名。 </p><p>我在撰写本文时，已合并了具有attr_reader self.foo支持的PR。</p><p> 我还发现了一个错误，当RBS未能正确地在单个类（例如，在类＆lt;＆lt;＆lt; self块内）中定义的attr_accessor属性中。幸运的是，它是固定的并且可以快速合并，所以我的主要模块签名现在是正确的：</p><p> 模块Rubanok-attr_accessor ignore_empty_values：无类型-attr_accessor fail_when_no_matches：无类型+ def self.fail_when_no_matches：（）-＆gt; untyped + def self.fail_when_no_matches =：（未键入）-＆gt; untyped + def self.ignore_empty_values：（）-＆gt; untyped + def self.ignore_empty_values =：（未键入）-＆gt;无类型的结尾</p><p>  到目前为止，我们仅讨论了如何编写和生成类型签名。如果我们不向开发堆栈中添加类型检查器，那将毫无用处。</p><p> 到目前为止，唯一支持RBS的类型检查器是Steep-毫不奇怪地由负责RBS的Ruby核心提交人Soutaro Matsumoto开发。</p><p>  让我们将陡峭的宝石添加到我们的依赖项中并生成一个配置文件：</p><p>  这将生成具有某些配置的默认Steepfile。对于Rubanok，我将其更新为： </p><p>＃Steepfile target：lib do＃从sig /文件夹签名＆＃34; sig＆＃34;加载签名＃仅检查来自lib /文件夹的文件，检查＆＃34; lib＆＃34; ＃我们不想键入检查Rails / RSpec的相关代码＃（因为我们没有RBS文件），请忽略＆＃34; lib / rubanok / rails / *。rb＆＃34;忽略＆＃34; lib / rubanok / railtie.rb＆＃34;忽略＆＃34; lib / rubanok / rspec.rb＆＃34; ＃我们使用Set标准库；它的签名＃随RBS一起提供，但是我们需要显式加载它们＆＃34; set＆＃34;结束</p><p>  在淹没各种类型的东西之前，让我们考虑一下如何衡量签名的效率。我们可以使用陡峭的统计数据来查看类型覆盖范围的好坏：</p><p>  令人惊讶的是，此命令输出CSV😯。让我们添加一些Unix魔术，并使输出更具可读性：</p><p> $ bundle exec陡峭的统计信息--log-level =致命| awk -F＆＃39;，＆＃39; ＆＃39; {printf＆＃34;％-28s％-9s％-12s％-14s％-10s \ n＆＃34;，$ 2，$ 3，$ 4，$ 5，$ 7}＆＃39;文件状态已键入的呼叫未键入调用键入％lib / rubanok / dsl / mapping.rb成功7 2 63.64lib / rubanok / dsl / matching.rb成功26 18 52.00lib / rubanok / processor.rb成功34 8 69.39lib / rubanok / rule.rb成功24 12 66.67lib / rubanok / version.rb成功0 0 0lib / rubanok.rb成功8 4 66.67</p><p> 理想情况下，我们希望输入所有内容。因此，我打开了.rbs文件，开始用实际类型一一替换未类型化的文件。</p><p> 我花了大约十分钟的时间才摆脱了无类型的定义（大部分都是这样）。我不会详细描述此过程；除了我要注意的一件事外，这非常简单。</p><p> 让我们回想一下Rubanok是什么。它提供了一个DSL来定义形式（输入，参数）的数据（通常是用户输入）转换器->输入。典型的用例是根据请求参数自定义Active Record关系： </p><p>Warning: Can only detect less than 5000 characters</p><p>为什么陡峭检测到三个#empty？规则类中的方法？事实证明，它认为匿名提炼主体是该类别主体的一部分：</p><p> 使用（Module。new是否精炼NilClass def空吗？真正的末端精炼对象def空吗？false末端吗）def空吗？ （val）返回false，除非ignore_empty_values val。空吗结束</p><p> 我提交了一个问题，并将改进内容移至文件顶部以修复这些错误。</p><p>   lib / rubanok / processor.rb：56：13：NoMethodError：type =（:: Class | nil），方法=＆lt; =（超类＆lt; =处理器）lib / rubanok / processor.rb：57：12：NoMethodError：type =（:: Class | nil），方法=规则（superclass.rules）lib / rubanok / processor.rb：67： 13：NoMethodError：类型=（:: Class | nil），方法=＆lt; =（超类＆lt; =处理器）</p><p>   这是继承类属性的一种非常常见的模式。为什么不起作用？首先，超类签名表示结果为Class或nil（尽管据我所知仅对BaseObject类可能为nil）。因此，我们不能立即使用＆lt; =（因为它没有在NilClass上定义）。</p><p> 即使我们取消超类的包装，仍然存在.rules的问题-Steep的流量敏感性分析目前无法识别＆lt; =运算符。因此，我决定对系统进行黑客攻击，并为Processor类明确定义.superclass签名：</p><p>    到目前为止，我们已经看到了与Sorbet差不多的问题。让我们来看看一些新东西。 </p><p>def工程（参数）参数=参数。 transform_keys（＆amp;：to_sym）＃params是一个Hash，fields_set是Set的params。 切片（* fields_set）结束  Hash＃slice方法需要一个数组，但是我们传递了一个Set。 但是，我们还使用了splat（*）运算符，该运算符隐式尝试将对象转换为数组-似乎合法吗？ 不幸的是，Steep还不是很聪明：我们必须添加一个明确的#to_a调用。  这种DSL方法接受一些选项作为关键字参数，然后将它们传递给Rule类初始化程序。 可能的选项是在Rule＃initialize中严格定义和强制执行的，但是我们希望避免明确声明它们只是为了向前。 不幸的是，只有在我们将** options声明为无类型的情况下才有可能，这会使签名变得毫无用处。  -def map（* fields，** options，＆amp; block）-filter = options [：filter_with]-rule =  ...... </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://evilmartians.com/chronicles/climbing-steep-hills-or-adopting-ruby-types">https://evilmartians.com/chronicles/climbing-steep-hills-or-adopting-ruby-types</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/ruby/">#ruby</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/类型/">#类型</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1036013.html"><img src="http://img2.diglog.com/img/2020/11/thumb_a1fe6584030c6a7cb2547a0764fd0777.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1036013.html">StimulusReflex：使用Ruby on Rails构建现代的反应式Web界面</a></div><span class="my_story_list_date">2020-11-23 8:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1035840.html"><img src="http://img2.diglog.com/img/2020/11/thumb_11c826cfa4b68a0727ed56dfc94a9e82.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1035840.html">我对Ruby类一无所知</a></div><span class="my_story_list_date">2020-11-22 8:57</span></div><div class="col-sm"><div><a target="_blank" href="/story/1035641.html"><img src="http://img2.diglog.com/img/2020/11/thumb_e3cca80340e666a775173cbbdc0b7a39.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1035641.html">Ruby的静态类型：大规模采用冰糕</a></div><span class="my_story_list_date">2020-11-21 21:33</span></div><div class="col-sm"><div><a target="_blank" href="/story/1035270.html"><img src="http://img2.diglog.com/img/2020/11/thumb_6f5c84856fa29d5f5170a177cc0f6115.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1035270.html">将我的无服务器项目转移到Ruby on Rails</a></div><span class="my_story_list_date">2020-11-15 20:58</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>