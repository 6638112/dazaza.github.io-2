<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Unix 域套接字的乐趣</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Unix 域套接字的乐趣</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-07-24 23:34:31</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/7/34afa80e2a658d3608af0a50877a34f9.jpeg"><img src="http://img2.diglog.com/img/2021/7/34afa80e2a658d3608af0a50877a34f9.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>本周对 Datasette 的一个小改进：我添加了对通过 Unix 域套接字进行代理的支持。这最初是来自 Aslak Raanes 的功能请求：#1388：使用 UNIX 域套接字提供服务。我以前没有接触过这些，所以这是学习新东西的好机会。 Unix 域套接字提供了一种机制，机器上的不同进程可以通过类似于 TCP 的机制与每个进程进行通信，但通过文件路径代替。我之前在 Docker 守护进程中遇到过这些，它侦听路径 /var/run/docker.sock 并且可以像这样使用 curl 进行通信：如果单击“HTTP”选项卡，Docker 文档中有更多示例。事实证明，nginx 和 Apache 都能够将流量代理到 Unix 域套接字而不是 HTTP 端口，这使得它成为运行后端服务器而不将它们附加到 TCP 端口的有用机制。 Datasette 使用出色的 Uvicorn Python Web 服务器来提供开箱即用的流量，并且 Uvicorn 已经包含对 UDS 的支持——因此添加对 Datasette 的支持非常容易——这是完整的实现。我添加了一个新的 --uds 选项，所以现在你可以像这样运行 Datasette：</p><p>Datasette 将在 /tmp/datasette.sock 上“监听”——这意味着您可以像这样通过 curl 运行请求：更重要的是，这意味着您可以像这样配置 nginx 或 Apache 来代理到 Datasette 服务器（nginx）： daemon off;事件 { worker_connections 1024;} http { 服务器 { 监听 80;位置 / { proxy_pass http://datasette; proxy_set_header 主机 $host; } } 上游数据集 { 服务器 unix:/tmp/datasette.sock; }} 实现只有几行代码（将 uds 选项传递给 Uvicorn）但添加测试证明更具挑战性。我使用这个 pytest 固定装置来启动服务器进程：@ pytest。夹具（范围 =“会话”）def ds_unix_domain_socket_server（tmp_path_factory）：socket_folder = tmp_path_factory。 mktemp(&quot;uds&quot;) uds = str(socket_folder / &quot;datasette.sock&quot;) ds_proc = subprocess. Popen( [ &quot;datasette&quot;, &quot;--memory&quot;, &quot;--uds&quot;, uds], stdout = subprocess.PIPE, stderr = subprocess.STDOUT, cwd = tempfile.gettempdir(), ) #给服务器时间启动时间。 sleep( 1.5) # 检查是否成功启动 assert not ds_proc.民意调查（），ds_proc。标准输出。读（）。 decode(&quot;utf-8&quot;) yield ds_proc, uds # 在 pytest 会话结束时关闭它 ds_proc. terminate() 我对其他一些测试使用了类似的模式，以练习 #1221 中添加的 --ssl-keyfile 和 --ssl-certfile 选项。测试本身看起来像这样，利用 HTTPX 对 Unix 域套接字进行调用的能力：</p><p>@pytest。标记。串行@pytest。标记。 skipif( not hasattr( socket, &quot;AF_UNIX&quot;), reason = &quot;Requires socket.AF_UNIX support&quot;) def test_serve_unix_domain_socket(ds_unix_domain_socket_server): _, uds = ds_unix_domain_socket_server transport = httpx. HTTPTransport(uds = uds) 客户端 = httpx.客户端（传输 = 传输）响应 = 客户端。 get( &quot;http://localhost/_memory.json&quot;) assert { &quot;database&quot;: &quot;_memory&quot;, &quot;path&quot;: &quot;/_memory&quot;, &quot;tables&quot;: [], }. items() &lt;= 响应。 json()。 items() skipif 装饰器避免在不支持 Unix 域套接字的平台上运行此测试（我认为包括 Windows，请参阅此评论）。 @pytest.mark.serial 装饰器应用了一个“标记”，可用于有选择地运行测试。我这样做是因为 Datasette 的测试使用 pytest-xdist 在 CI 中运行，但这与这种启动临时服务器的方式不兼容。 Datasette 实际上在 GitHub Actions 中运行测试，如下所示： - name: Run tests run: | pytest -n auto -m &quot;not serial&quot; pytest -m &quot;serial&quot; pytest -n auto -m &quot;not serial&quot; 行使用 pytest-xdist 在自动选择的进程数上运行几乎所有测试，但跳过那些用@pytest.mark.serial 标记。然后第二行在没有任何额外并发的情况下运行剩余的串行测试。可以在代理文档后面的运行数据集中找到此功能的文档和示例配置。感谢 Aslak 提供有关 Apache 配置的注释。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://simonwillison.net/2021/Jul/13/unix-domain-sockets/">https://simonwillison.net/2021/Jul/13/unix-domain-sockets/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/unix/">#unix</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/quot/">#quot</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>