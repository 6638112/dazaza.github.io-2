<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Datasette内部 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Datasette内部 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-28 08:07:05</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/12/fe901e6d7745594dc77bd3a7455f9cb2.png"><img src="http://img2.diglog.com/img/2020/12/fe901e6d7745594dc77bd3a7455f9cb2.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>我一直在对Datasette的内部工作进行一些根本性的更改，虽然还没有准备好发布，但是它们正在朝着一个有趣的方向发展。</p><p> 我对Datasette的目标之一是能够在一个地方处理各种各样的数据。 Datasette Library票证跟踪了这一工作-我希望新闻编辑室（或任何其他基于信息的组织）能够将数百个数据库和可能包含数千个表的数据保存在一个地方。</p><p> SQLite数据库只是磁盘上的文件，因此，如果您有成千上万个各种形状和大小的各种数据库，我希望能够在一个Datasette实例中显示它们。</p><p> 如果您有一百个数据库文件，每个数据库文件包含一百个表，则总共为10,000个表。这意味着需要对主页进行分页，并且需要在Datasette实例可用的表中进行搜索和过滤。</p><p>  因此，在第1150期中，我已经实现了解决方案的第一部分。在启动时，Datasette现在将创建一个内存中的SQLite数据库，该数据库表示所有已连接的数据库和表，以及这些表的列，索引和外键。</p><p> 对于演示，请首先以root用户身份登录Latest.datasette.io演示实例，然后访问私有_internal数据库。</p><p>  这个新的内部数据库目前是私有的，因为我不想公开任何可能由Datasette的权限机制涵盖的有关表的元数据。 </p><p>新的内存数据库表示基础数据库文件的架构，但是如果添加或修改新表时发生更改，该怎么办？</p><p> SQLite有一个巧妙的技巧可以帮助您解决此问题：PRAGMA schema_version返回一个表示模式当前版本的整数，该整数在创建或修改表时会更改。</p><p> 这意味着我可以缓存表模式，并且仅在发生更改时才重新计算它们。针对与数据库的连接运行PRAGMA schema_version是非常快速的查询。</p><p> 我首先在datasette-graphql中使用了这个技巧来缓存GraphQL模式自省的结果，因此我相信它也可以在这里工作。</p><p>   Datasette的权限系统于6月份在Datasette 0.44中添加，适用于插件挂钩。权限插件可以按照以下方式回答问题：是否允许当前经过身份验证的actor对表X执行动作视图表？＆＃34;。每次询问该问题时，都会通过插件挂钩来查询插件。</p><p> 在设计权限系统时，我忘记了之前曾学习过的有关权限系统的重要课程：在某个时候，您将需要回答以下问题：“向我显示此角色有权执行操作的所有X的列表” ”。</p><p> 那个时候到了。如果我要为Datasette渲染一个分页的主页，列出10,000多个表，则需要一种有效的方法来计算允许当前用户查看的10,000个表的子集。 </p><p>循环调用该插件钩子10,000次并不会减少它。</p><p> 因此，我开始重新考虑权限了-很高兴我还没有使用Datasette 1.0！</p><p> 对我有利的是SQLite。以通用的，可定制的方式有效地批量回答权限问题是一个非常困难的问题。有了关系数据库，它变得更加容易。</p><p> 问题＃1152跟踪了我对此的一些思考。我有一种预感，该解决方案将涉及一个新的插件挂钩，可能类似于“返回一个SQL片段，该片段标识该用户可以访问的数据库或表”。然后，我可以针对新的_internal数据库运行该SQL（可能与其他插件使用AND或UNION返回的SQL结合使用同一个钩子来返回该SQL）来构造一组用户可以访问的表。</p><p> 如果可以这样做，然后对内存中的SQLite数据库运行查询，则应该能够为主页上的10,000多个表提供一个分页的，经过筛选的界面，可以轻松实现我的性能目标。</p><p> 我想很快在新版本中发布新的_internal数据库，因此我可能最终会为此实现一个较慢的版本。绝对是一个有趣的问题。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://simonwillison.net/2020/Dec/27/weeknotes-datasette-internals/">https://simonwillison.net/2020/Dec/27/weeknotes-datasette-internals/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/datasette/">#datasette</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/数据库/">#数据库</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>