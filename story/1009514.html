<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Python模式匹配：防护和或-模式可能不能很好地组合</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Python模式匹配：防护和或-模式可能不能很好地组合</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-03 00:53:55</div><div class="page_narrow text-break page_content"><p>PEP622建议向Python添加模式匹配构造。模式匹配允许程序员使用反映构造语法的语法来分解数据。该提案使Python与许多其他现代编程语言保持一致，如Haskell、OCaml和Rust。然而，提案中包含的两个特性(或-模式和卫士)以一种可能令人惊讶的方式交互-请参阅本文以了解这种交互的解释，因为它与OCaml相关，OCaml是另一种同时具有或-模式和卫士的语言。</p><p>您可以在cpython的这个分支上尝试这个PEP的正在进行的实现：https://github.com/brandtbucher/cpython/tree/patma.。</p><p>在本文的其余部分，我将简要总结模式匹配，定义或模式和保护，并在Python上下文中展示令人惊讶的行为。</p><p>在提议之前，您可以编写一个函数，根据一对动物的种类对它们进行分类。</p><p>类狗：def__init__(Self，Name)：Self。name=name类猫：def__init__(self，age)：self。年龄=年龄定义分类(宠物)：如果是实例(宠物，猫)：打印(&#34；一只年龄为{}岁的猫。格式(宠物。年龄))Elif is instance(宠物，狗)：打印(&#34；一只名叫{}&#34；的狗。格式(宠物。名字))分类(狗(#34；Fido&34；))#打印：一只名叫菲多的狗分类(猫(3))#打印：一只3岁的猫。</p><p>定义分类(宠物)：匹配宠物：案例猫(年龄=年龄)：打印(&#34；一只已经{}岁的猫。格式(年龄))案例狗(名称=名称)：打印(&#34；一只名为{}&#34；的狗。格式(名称))。</p><p>换句话说，模式匹配允许您检查一段数据，同时匹配其形状并将其字段的值绑定到变量。在上面的代码中，Cat(age=age)是一个与Cat值匹配的模式，并绑定到名为age的变量。</p><p>该提案给出了该构造的语义的非正式描述，但是非正式描述没有解释引入的两个特性之间的交互：OR-模式和模式保护。事实证明，正如目前实现的那样，这些特性之间的交互有些令人惊讶，如果这个PEP最终被接受，可能会产生至少一个高分的堆栈溢出问题。</p><p>下面是一个或模式的示例：猫(年龄=3岁)|狗(名称=&#34；FIDO&#34；)。这个图案与三岁大的猫或狗Fido相匹配。在实践中：</p><p>#我有一只三岁的猫和一只叫Fido的狗。#如果宠物可以是我的，这个函数返回true。def couldBeMyPet(宠物)：匹配宠物：Case Cat(年龄=3)|Dog(Name=&#34；FIDO&#34；)：Return True Case_：Return False Print(couldBeMyPet(Cat(3)#Prints True Print(couldBeMyPet(Dog(&#34；Rover&#34；)#Prints False。</p><p>模式保护是可以包含在case分支中的布尔表达式；仅当模式保护的计算结果为true时才采用case分支。</p><p>定义分类(宠物)：匹配宠物：案例猫(age=age)，如果年龄%2==0：打印(&#34；这只猫的年龄是偶数！&#34；)案例狗(name=name)如果排序(Name)==list(Name)：print(&#34；这只狗的名字按字母顺序！&#34；)case_：print(&#34；我对这只宠物没什么好说的。&#34；)分类(猫(4))#打印&#34；这只猫的年龄是偶数！&#34；分类(狗(&#34；阿贝&34；))#打印&#34；这只狗的名字是按字母顺序排列的！&#34；分类(狗(&#34；菲多&34；))#打印&#34；关于这只宠物我没什么好说的。</p><p>在上面的示例中，如果age%2==0和if sorted(Name)==list(Name)是模式保护，则仅当布尔表达式的计算结果为True时才允许采用该案例。</p><p>def do EitherCatHaveAnEvenAge(pet1，pet2)：Match(pet1，pet2)：case(Cat(age=age)，_)|(_，Cat(age=age))if age%2==0：返回True case_：返回假打印(Do EitherCatHaveAnEvenAge(Cat(2)，Cat(4)#打印True Print(Do EitherCataveAnEvenAge(Cat(2)，Cat(4))。cat(4)#打印错误(？)。</p><p>最后一个(是否EitherCatHaveAnEvenAge(Cat(5)，Cat(4)似乎应该计算为True。毕竟，or-模式中的一个模式似乎与第二只猫相匹配，这是一只年龄为偶数的猫。</p><p>如果年龄%2==0，(Cat(5)，Cat(4))是否与(Cat(age=age)，_)|(_，Cat(age=age))匹配？要回答这个问题，您头脑中的语义可能如下所示：</p><p>那么，(Cat(5)，Cat(4))确实与OR模式的第一个模式(Cat(age=age)，_)匹配。此匹配将值5绑定到变量age。</p><p>现在，如果年龄%2==0，我们检查防护。由于5%2==0的计算结果为FALSE，因此此检查失败。</p><p>返回到or模式，看看是否有其他方法可以匹配它。在这种情况下，(Cat(5)，Cat(4))也与OR模式的第二个模式(_，Cat(age=age))匹配。这会将值4绑定到变量age。</p><p>现在，如果年龄%2==0，则保护成功，因为4%2==0的计算结果为True。</p><p>这是完全合理的，但实现并不是这样做的。该实现的语义更类似于以下内容：</p><p>因为警卫失败了，所以案子没人接！取而代之的是，下一个案件将开庭审理。此案例(case_：)总是成功，因此我们返回false。</p><p>换句话说，模式匹配没有回溯语义，即使一个值可以以多种不同的方式匹配或模式。</p><p>我喜欢模式匹配，我很高兴看到它可能会被像Python这样的流行语言采用。但这种特殊的功能交互可能会让新手感到困惑。让我们比较一下其他语言的方法。</p><p>在这里，OCaml具有与Python相同的语义，但是OCaml编译器可以发出警告(因为编译器有足够的类型信息来判断或模式的组成模式是否可能以不同的方式匹配相同的值)。</p><p>当x=2-&gt；print_endline&#34；：)&#34；|_-&gt；print_endline&#34；：(&#34；</p><p>警告57：受保护的模棱两可的变量或模式变量；变量x可能匹配不同的参数。(请参阅手册第9.5节)。</p><p>Rust具有模式匹配和保护，并具有实验性的或_模式特性。与Python不同，它实现了回溯语义。这本身就很奇怪，特别是在存在副作用的情况下。请看一下这个节目：</p><p>#！[Feature(Or_Patterns)]//提示用户是否接受匹配Pub FN检查(x：I32)-&gt；bool{use std：：IO：：{stdin}；println！(&#34；检查此匹配：{}。我们应该接受吗？y/n&#34；，x)；让mut s=string：：new()；stdin().read_line(&amp；mut s)。期望(&#34；没有输入正确的字符串&#34；)；返回s.trim()==&#34；y&#34；}pub fn main(){Match(1，2){(x，_)|(_，x)if check(X)=&gt；{println！(&#34；：)&#34；)}_=&gt；{println！(&#34；：：(&#34；)}。</p><p>$Cargo+夜间运行检查此匹配：1.我们应该接受它吗？Y/nn检查这场比赛：2。我们应该接受吗？Y/NY：)。</p><p>我不确定Python的正确决策是什么。或者-图案和护卫可能就是构图不好。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://ncik-roberts.github.io/posts/pep622.html">https://ncik-roberts.github.io/posts/pep622.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/python/">#python</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/模式匹配/">#模式匹配</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/pattern/">#pattern</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/模式/">#模式</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1009451.html"><img src="http://img.diglog.com/img/2020/7/thumb_5c35becbbc4d71eacee2f845232d0e17.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1009451.html">DARTS：用于时间序列处理和预测的Python库</a></div><span class="my_story_list_date">2020-7-2 18:34</span></div><div class="col-sm"><div><a target="_blank" href="/story/1009251.html"><img src="http://img.diglog.com/img/2020/7/thumb_810d8cfa346ea0e2525b5cc0d5d2aff2.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1009251.html">摩根大通Python培训指南：蛇形语言扎实入门</a></div><span class="my_story_list_date">2020-7-1 20:25</span></div><div class="col-sm"><div><a target="_blank" href="/story/1009207.html"><img src="http://img.diglog.com/img/2020/7/thumb_39d006e6b9065b18a6737eef37410022.gif" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1009207.html">Pylance：VSCode中对Python的快速、功能丰富的语言支持</a></div><span class="my_story_list_date">2020-7-1 8:57</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008809.html"><img src="http://img.diglog.com/img/2020/6/thumb_4cb0fa642cebb17de1e466e3ffb9fe8d.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008809.html">PyperClip：用于复制和粘贴剪贴板功能的跨平台Python模块</a></div><span class="my_story_list_date">2020-6-29 9:37</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>