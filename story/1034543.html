<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>R能在苹果硅片上发挥作用吗？</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">R能在苹果硅片上发挥作用吗？</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-11 23:05:21</div><div class="page_narrow text-break page_content"><p>在今年早些时候的2020年WWDC大会上，苹果公司宣布他们的笔记本电脑将从英特尔过渡到基于ARM的处理器。这篇博客是关于R什么时候能在这个平台上工作的前景，基于在一台运行A12Z的开发机器上的实验，A12Z是“苹果硅”处理器之一。</p><p>新的平台将包括Rosetta 2，这是一个动态翻译框架，它运行为64位英特尔Mac构建的二进制代码，使用的是即时、动态的二进制代码翻译。好消息是，R似乎可以很好地处理动态翻译，所以R用户即使使用当前版本也不需要担心。然而，有趣的问题是，R是否也会发挥作用。本机执行预计会更快，而且无论如何，转换可能最终都要完成。</p><p>执行摘要是：虽然目前还没有针对该平台发布Fortran编译器，但GNU Fortran的一个开发版本似乎已经运行良好。在使用数值Nas进行计算时，NaN有效载荷传播会产生一些令人惊讶的结果，但这些结果可以通过更改浮点单元的模式来克服，R-devel中已经这样做了。更多细节请看这篇文章。</p><p>R至少需要Fortran 90编译器才能生成。Fortran R中的大部分代码以及基本和推荐的软件包仍然是Fortran 77版本，因此它可以通过f2c转换为C，并由C编译器编译。然而，一些代码已经使用了Fortran 90的特性和后端移植，这需要付出很大的努力。</p><p>此外，R附带了略微修改的Reference LAPACK和BLAS版本，它们需要Fortran 90编译器才能构建。尽管苹果在MacOS的加速框架中提供了BLAS和LAPACK的优化版本，但在新平台上也能提供参考LAPACK/BLAS，这是非常可取的。</p><p>GCC的GFortran支持64位ARM：五月早先的一篇博文是关于在QEMU仿真器中的64位ARM(Aarch64)上运行的Linux上构建和测试R的。然而，苹果硅平台使用的是GFortran还不支持的不同的应用程序二进制接口(ABI)。</p><p>目前，似乎没有其他Fortran 90编译器，也没有免费的非商业性的。具体地说，LLVM的Fortran编译器(现在又称为Flang)还没有完成。</p><p>虽然GFortran目前还不支持Apple Silicon(GCC主干也没有发布)，但GCC有一个私人开发分支，包括Ian Sandoe的GFortran，我们进行了试验。</p><p>像往常一样，从源头上打造GCC需要先打造平台的GMP、MPFR和MPC。GMP(版本6.2.0)需要从主干向后移植补丁(为Apple硅片、汇编宏配置脚本)。重新生成配置脚本和本地生成文件也需要构建libtool。GMP的配置脚本必须显式运行--build=aarch64-apple-darwin20.0.0，即使是在本地构建时也是如此。GCC的配置脚本使用--with-sysroot运行，指定一个目录到通过Xcode-SELECT-P安装的MacOSX.sdk。</p><p>R需要许多依赖项，这些依赖项可以在R安装和管理之后使用Apple提供的Apple/LLVM工具链进行本机构建(不需要Fortran编译器)。我们还编译了Subversion的本机构建，尽管原则上可以从tarball构建R。</p><p>R和推荐的包是使用APPLE/LLVMclang编译C语言(使用CFLAGS=-Wno-error=implicit-function-declaration)和Objective C，并使用GFortran的开发版本编译Fortran代码)构建的。</p><p>许多针对R和推荐的包的测试都失败了，原因与平台有关，但结果都是因为相同的原因：NaN负载的惊人传播，例如，nna*1就是NaN。</p><p>浮点数的R‘s NA使用带有特殊有效负荷值的NaN表示。源自不涉及NA的计算的NAN具有不同的(例如，零)有效负载，因此可以与NA区分开来。NAN经常在没有显式检查的情况下传递给R内部的计算，同样的情况也发生在程序包代码和外部数值代码中，它们对R的NA概念和表示方式一无所知。</p><p>IEEE 754浮点算术标准没有规定如何通过计算传播NaN有效载荷。涉及NAS和/或其他NAN的计算结果取决于CPU/浮点单元、编译器优化(编译器可以对计算重新排序)和算法(例如，在假定输入值是有限的情况下，很容易忽略不需要计算结果的输入值，但是没有实际检查它们是有限的)。</p><p>在R的在线帮助(？na，？nan)中可以找到更多信息，包括不应依赖na和NaN之间的差异的免责声明(引用最近R-devel的措辞)：</p><p>涉及‘nan’的计算将返回‘nan’或‘na’：这两个中的哪一个是不确定的，可能依赖于R平台(因为编译器可能会对计算进行重新排序)。</p><p>使用‘na’的数值计算通常会产生‘na’：一个可能的例外是也涉及‘nan’的地方，在这种情况下，任何一种情况都可能产生结果(这可能取决于R平台)。然而，这并不能保证，未来的CPU和/或编译器可能会有不同的行为。</p><p>相对于R Nas，英特尔FPU工作得相对较好：与NAs的二进制操作会产生Nas，即使涉及NAs也是如此(基于实验)。但目前，英特尔计算机上的R通常被构建为使用SSE指令进行计算，这对R Nas不起作用：与Nas的二进制操作仅在另一个参数不是NaN时，或者当NA是第一个参数时，才会产生NA，因此NaN+NA是NaN，但NA+NaN是NA。由于带有SSE的64位英特尔最近很可能是R的主流设置，测试已经更新以接受这一行为。</p><p>然而，事实证明，在A12Z上，R的NA在任何二进制操作(有效负载丢失)之后变成了正常的NAN，所以即使是NA*1也是NAN。这在上面引用的R文档中警告过的范围内，但是仍然有一些R测试和推荐的包捕获了(记录为不可靠的)行为，期望像这样的操作将返回NA。我们还没有调查过有多少其他CRAN/BIOS包可以这样做。</p><p>ARM架构浮点单元(VFP、NEON)支持快速运行模式，包括清零和默认NAN。后者意味着NaN操作数的有效负载不会传播，所有结果NAN都具有默认有效负载，因此在R中，即使NA*1也是NAN。幸运的是，Runfast模式可以被禁用，当它被禁用时，NAN有效负载传播比使用Intel SSE更友好(NaN+NA是NA)。因此，我们在ARM启动时将R更新为DisableRunFast模式，从而解决了观察到的所有问题。</p><p>我们之前没有遇到这个问题，因为Runfast已经在其他平台上被默认禁用，包括Raspberry Pi(在带有32位ARM的旧型号2上测试，BCM2835)，以及在模拟Aarch64(64位ARM，Cortex-A72)的QEMU上测试。</p><p>由伊恩·桑多(Ian Sandoe)为苹果硅提供支持的实验GCC在GCC的苹果硅开发分支机构工作。</p><p>浮点异常跟踪和NaN传播也是由Agner Fog编写的关于NaN有效负载传播的文本。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://developer.r-project.org/Blog/public/2020/11/02/will-r-work-on-apple-silicon/">https://developer.r-project.org/Blog/public/2020/11/02/will-r-work-on-apple-silicon/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/nan/">#nan</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1034527.html"><img src="http://img2.diglog.com/img/2020/11/thumb_08f880f953605a3606c7f8b863ae2b1d.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1034527.html">Apple Silicon M1 Mac不支持eGPU</a></div><span class="my_story_list_date">2020-11-11 21:50</span></div><div class="col-sm"><div><a target="_blank" href="/story/1034524.html"><img src="http://img2.diglog.com/img/2020/11/thumb_977d07ddbd67d97b9eda8c121c94996d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1034524.html">苹果的差异化转变</a></div><span class="my_story_list_date">2020-11-11 21:48</span></div><div class="col-sm"><div><a target="_blank" href="/story/1034443.html"><img src="http://img2.diglog.com/img/2020/11/thumb_d621652fb51a936378653fd374e97155.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1034443.html">苹果新款M1 Mac不能与外部GPU配合使用</a></div><span class="my_story_list_date">2020-11-11 9:1</span></div><div class="col-sm"><div><a target="_blank" href="/story/1034429.html"><img src="http://img2.diglog.com/img/2020/11/thumb_335c1aec8be378838308a917a5cfd3d6.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1034429.html">
《每日新闻》：苹果发布新款Mac</a></div><span class="my_story_list_date">2020-11-11 7:30</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>