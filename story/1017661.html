<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>平行缝雕刻</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">平行缝雕刻</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-12 07:57:21</div><div class="page_narrow text-break page_content"><p>接缝雕刻是一种内容感知的大小调整技术，它可以改变图像的大小，同时试图保留图像中有趣的内容。这项技术背后的基本思想是去除低能量接缝：与周围环境相似的像素路径。删除的接缝可以是垂直的，也可以是水平的，以减小图像的宽度或高度。</p><p>例如，这是我几年前在西弗吉尼亚州斯普鲁斯·诺布附近拍摄的全景照片。</p><p>这个图像非常宽，但是我们可以把它刻下来。这是一个过程的动画，由我最近实现的接缝雕刻机生成，作为MPL的并行基准。</p><p>在这个实现中获得真正的并行加速被证明是一个有趣的挑战。对于相当小的典型图像，我发现最明显的并行化方法是提取足够的并行度，因为它需要的粒度太小，所以我设计了一种新的并行化方法，对小图像的并行化效果要好得多。这篇文章介绍了一些细节。</p><p>缝刻背后的想法是考虑一张图像中所有可能的接缝，选择最不重要的一条，然后将其移除。接缝是横跨图像的像素路径，沿途每行(或列)接触一个像素。当我们移除接缝时，我们会将图像的宽度或高度减少1。我们可以根据需要重复此过程多次以缩小图像。</p><p>我们将根据像素能量的概念来衡量接缝的“重要性”，像素能量可以有很多不同的定义。对于缝刻来说，色差梯度似乎工作得很好，它衡量了像素的颜色与周围环境的不同程度。接缝的能量就是接缝接触的所有像素的累计能量。使用此设置，能量最小的接缝应该不重要，并且可以安全地从图像中移除。</p><p>为了计算最小接缝能量，我们可以使用一种简单的动态规划算法。为了简单起见，让我们把重点放在垂直接缝上。设\(M(i，j)\)是在行\(i\)和列\(j\)结束的任何部分接缝的最小能量，\(E(i，j)\)是该位置的像素的能量。这些最小接缝能量由以下方程式关联：</p><p>[M(i，j)=E(i，j)+\min(M(i-1，j-1)，M(i-1，j)，M(i-1，j+1))\]一张图片可能会有所帮助。对于每个位置，我们查看结束于其上方的最小局部接缝，选取最小的，然后添加下一个像素。</p><p>一旦(M\)被完全计算出来，我们就可以通过从最下面一行中最小的开始，沿着最小接缝能量的路径向上走，从下到上向后工作，找到最小的总接缝。</p><p>\(M\)等式中的依赖关系似乎提供了很大的并行性。也许最直接明显的方法是以行为主的顺序计算\(M\)，其中我们首先计算所有行0，然后计算所有行1，依此类推。使用这种顺序，可以完全并行地计算一行内的值，因为每个\(M(i，j)\)仅依赖于前一行的三个值\(M(i-1，\ldots)\)。</p><p>然而，行为主顺序在实践中有一个主要问题：典型的图像最多只有几千个像素宽，并且每个像素只需要少量的工作。这(每行)的工作量不足以有效地并行化！比方说，我们需要至少一千个像素的粒度来摊销并行本身的成本。</p><p>这在很大程度上排除了对典型的小图像使用行长排序的可能性。有没有更好的方法来计算\(M\)而不减小颗粒尺寸？</p><p>为了在不减小粒度的情况下提取更多的并行性，我们需要更好的划分工作的方法。这可能是可以“自动”完成的事情(例如，看看Rezaul Chowdhury的作品)，但在这里，我们将尝试自己设计一些东西。</p><p>单个值\(M(i，j)\)的所有依赖项是什么？从视觉上看，依存关系形成一个尖端向下的三角形：</p><p>我们可以用这样的三角形很好地分割工作。首先，设想将相邻行分组为条带。在一条带子内，用一串向下的三角形覆盖带子的顶部。剩余的空间将看起来像一堆向上的三角形，每个三角形都已经满足了它的所有依赖关系(这不是很明显，但是画一幅画会有帮助)。所以，我们可以在两个平行的轮次中处理一条，首先我们平行地做一串向下的三角形，然后我们做一串朝前的三角形来填满剩余的空间。</p><p>这是一张使用三角形的图片，底部有6个像素宽。请注意，如果我们使用底宽为偶数的三角形，那么这些瓷砖自然不会重叠。</p><p>实际上每个三角形应该有多宽？回想一下，我们拍摄的目标粒度可能是一千或两千像素。这对应于基本宽度介于64(三角形中的1056像素)到90(三角形中的2070像素)之间的三角形。</p><p>因此，在较小的图像中，例如1000像素宽，我们可以水平放置至少11个三角形，建议最大可能加速11倍或更多。这是对行主策略的一大改进，后者(使用1000像素的粒度)将不能从这样的图像中提取任何并行性。</p><p>对于MPL，我同时实现了行优先策略和三角形策略，以比较它们的性能。可以在MPL资源库的/src/seam-carve/subdirectory子目录中找到三角形化策略的代码。我将把行主代码作为练习留给读者。(还不算太差！)。</p><p>以下是从大约2600x600大小的图像中移除10个接缝的一些性能数据。我做了一点调整，最终选择了1000像素的行长粒度和88(1980像素)的三角形基宽粒度。</p><p>在1个处理器(P=1)上，行主策略的速度提高了大约15%，但是更多的处理器很快达到了大约2倍的最大加速比，在10个处理器上没有任何额外的改进。相比之下，三角形策略随着处理器数量的增加继续变得更快，在10个处理器上的自我加速大约是5倍，在20个处理器上是6.5倍，在30个处理器上是9倍。</p><p>尽管在1个处理器上有少量的开销，但是我们可以看到三角形策略提供了显著的收益。在更高的核心计数上，它的速度比行主策略快4倍之多。</p><p>有人可能会问：为什么我们获得的加速距离理论限制如此之远？在基宽为88的情况下，我们不是应该能够在宽度为2600的图像上获得高达30倍的加速吗？不幸的是，在实践中实现如此好的加速比存在大量障碍：无效的缓存利用率、内存带宽瓶颈、非最佳调度…。还有更多。</p><p>缝雕在很大程度上是受内存限制的，也就是说，对于每次内存访问，它在下一次访问之前只做少量的工作。为了绕过这个瓶颈，我们可能需要更好的缓存利用率，因此我们必须更仔细地在内存中布局\(M(i，j)\)的值。(对于这个实现，我使用了一个简单的平面数组布局，其中\(M(i，j)\)位于索引\(iw+j\)。相反，我们可以尝试将这些值存储在分层结构中，首先按条带索引，然后按三角形索引，以更好地改善局部性。)</p><p>缝刻跨度很高，在每次同步之间执行少量的工作。例如，在行主策略中，我们在每行之间使用屏障，而在三角形策略中，我们在每个条带中使用两个屏障。这可能会导致调度程序执行过多的线程迁移。为了缓解这一问题，我们可以尝试的一件事是让三角形稍微重叠，增加每个条带的大小。这用少量的重复工作换取了总体上较少的障碍同步，这可能会被证明是非常有益的。</p><p>好棒的帖子！很高兴看到对过于细粒度并行的成本的实际分析，因为在讨论“令人尴尬的并行”问题时，这通常会被抛诸脑后。正如您所展示的，要使某些事情变得快速，您需要一种不太细粒度的方法(开销太大)，也不能太粗糙(否则您不能使用所有现有的并行性)。找到一种在可用并行范围内很好地扩展的最小开销方法通常有点棘手。</p><p>通过这种排序，可以完全并行地处理每一行，因为每个值M(i，j)仅依赖于来自前一行的三个值M(i-1，_)。</p><p>“每行”实际上不应该有“每列(在一行内)”或“每个像素”吗？</p><p>也就是说，如果我理解您对此方法的建议，它是按顺序执行每一行，并在一行中获得每像素(或更粗)的并行度。</p><p>我很高兴你喜欢它！是的，我完全同意：实践并行性的错综复杂经常被视为“实现细节”，尽管它们本身确实很有趣。我希望这些帖子能帮助澄清这件事。</p><p>在重新读取之后，我可能只是错误地解析了“每一行都可以完全并行处理”。我将其理解为“在所有行的集合中，每行都可以并行处理(但行内的工作是串行的)”(例如，每个工作器一个行)，但当然它可以有效地表示“每行内的工作可以并行处理(例如，每个工作器一个像素)，但是整行是串行的(行1必须在行0之后处理，依此类推)。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://shwestrick.github.io/2020/07/29/seam-carve.html">https://shwestrick.github.io/2020/07/29/seam-carve.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/平行/">#平行</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/seam/">#seam</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/三角形/">#三角形</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>