<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Linux FU：移动/用户</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Linux FU：移动/用户</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-04 22:35:49</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/9/c863f503308fd8d88708cb218ce52cb7.jpg"><img src="http://img2.diglog.com/img/2020/9/c863f503308fd8d88708cb218ce52cb7.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Linux已经改变了。最初受到Unix的启发，有一些很好理解但没有很好执行的规则，每个人都理解。程序做一些小事，并使用管道进行通信。X Windows服务器并不总是在您的本地计算机上运行。/usr中的任何内容都无法引导系统。</p><p>这些天，我们有系统地控制一切。如果你在一台显示器上运行Chrome，它就会被锁定在那台显示器上，它真的希望那是本地显卡。除非您采取预防措施，否则将/usr移到另一个分区很容易阻止您启动。我搬家了，我活着讲述了这件事。如果你需要这样做，你会想听听我的故事。</p><p>很多人都在批评systemd--包括我在内--但实际上这不是systemd的错。当我们有更多的程序员时，这些原则就会丧失，而且他们中的许多人都受到其他系统的影响，在这些系统中，事情的工作方式不同。不过，我不是在大喊大叫。我最近的一次经历让我想起了这一切，在此过程中，我学到了一些关于引导过程的现代状态的东西。故事开始于一位朋友给了我一个英特尔计算棒。但我遇到的问题并不是特定于该硬件，而是现代Linux发行版如何管理它们的启动过程。</p><p>就像我说的，我的一个朋友给了我一个英特尔计算棒。这是早期相当贫血的疾病之一。特别是，它只有1 GB的内存和8 GB的闪存。它启动了一个旧版本的Ubuntu，正如你所预期的那样，速度相当慢。但我喜欢它的外形，而且我有一个可以使用永久性PC的新工作室，所以我决定升级它。</p><p>出现了一些常见的问题。BIOS升级中断了网络。升级到KDE Neon修复了网络，但较新的内核有可怕的C-State bug，导致挂起。幸运的是，这很容易解决。所以经过一些努力，我有了一个合理的工作系统。说大也大吧。</p><p>问题出在8 GB的闪存。我放了一张64 GB的SD卡，但我不想从它启动。安装了霓虹灯和一些其他必需品后，闪光灯几乎100%满了。我的计划是/opt/home，/usr转到SD卡。我以为这会很容易。</p><p>传统上，这是一个简单的过程。首先，使用无需更改即可获得隐藏文件和链接的内容复制文件。许多人使用rsync，但通常使用tar。然后删除旧目录(为了安全起见，我先将其重命名，并在一切正常后将其删除)。最后，创建一个新的空目录，并更改/etc/fstab以在引导时挂载磁盘。</p><p>对于/home和/opt，这很好。系统会毫不费力地启动，我很快就把它做好了。我知道/usr会有点难，但我想我可以在没有GUI的根shell中，或者只需从USB驱动器引导并执行所有相同的工作。</p><p>实际上我预计会有四匹坐骑。我将整个SD卡挂载到/sdcard。然后，我确实将挂载从/sdcard/opt绑定到/opt，将/sdcard/home绑定到/home。/usr挂载也是绑定挂载，但不会那么容易。</p><p>我尝试移动/usr导致系统停止引导。为什么？原来systemd负责挂载/etc/fstab中的内容，而systemd需要/usr中的内容。我认为如果systemd不必读取/etc/fstab，那么它可能足够智能来引导系统，所以我决定使用systemd的本机设施挂载SD卡。</p><p>Systemd可以像处理服务一样处理挂载。这意味着它将管理安装，并将其编织到依赖项中。因此，在挂载某些磁盘之前，可能要求服务或其他挂载准备就绪，当然，其他服务和挂载也可能依赖于该磁盘。理论上，这是完美的，因为例如，在挂载/sdcard之前尝试挂载/sdcard/home是没有意义的。</p><p>显然，UUID会根据磁盘的不同而改变。不是很明显，这个文件必须命名为sdcard.mount。如果挂载点是/usr/lib，那么文件必须是usr-lib.mount。</p><p>请注意，挂载需要/sdcard。一旦您将这些文件放到正确的位置并重新加载系统，您就可以启动这些单元，文件将会挂载。您可以使它们在引导时启动。除了文件名之外，/opt单元看起来完全相同。</p><p>这仍然给/usr留下了问题。当然，编写单元很容易，但问题是systemd需要/usr之外的一些库，所以系统将拒绝引导。我考虑将库复制到/lib或初始RAM磁盘中的某个位置，但在发现有相当多的库之后，我决定不这么做。</p><p>我最终决定，在引导过程的早期挂载所有内容将是正确的答案。这样，systemd就可以想象它有一个完整的磁盘。我实际上曾考虑过使用LVM将磁盘连接在一起，但由于很多原因，我认为这是不好的，而且可能会遇到同样的问题。我想要控制SD卡和内部存储上的内容，所以是时候看看initramfs脚本了。</p><p>大多数现代Linux发行版不会直接引导您的根文件系统。取而代之的是，它们有一个压缩的文件系统，加载到RAM中，然后引导。该系统负责使系统为真正的引导做好准备。除了其他功能外，它还挂载根文件系统，然后旋转以使其成为真正的根。</p><p>对于Debian风格的发行版，这是initramfs，您可以在/etc/initramfs-tools中找到一些用户可定义的脚本。大部分预定义文件位于/usr/share/initramfs-tools中。在脚本目录中，您将看到许多后缀为-top、-Bottom和-premount的子目录。</p><p>正如您可能想象的那样，init-*发生在系统初始化时，而local-*发生在挂载本地磁盘时。不要将这些与钩子脚本混淆。钩子脚本在构建初始文件系统时执行。如果您需要静态修改引导环境，这会很有帮助。我们需要的脚本是在引导时执行的脚本。</p><p>首先运行顶部脚本，然后运行预装载，然后运行底部脚本。所以init-top首先运行，而init-Bottom是最后运行的。在此期间，其他脚本运行，并在本地底层运行，根文件系统应该可以运行了。</p><p>如果您阅读文档，您将看到脚本具有特定的格式。然而，也有一些例子具有误导性。例如，模板脚本显示获取/usr/share/initramfs-tools/钩子函数以加载通用函数。如果/usr已经存在，那就太好了，但是对于我们来说，它不存在。其他一些脚本使用位于/usr/share/initramfs-tools/script/function的引导环境中的副本。这就是我在剧本中使用的：</p><p>唯一棘手的部分是我们最终的根文件系统不在/，而是在/root，所以挂载反映了这一点。</p><p>当然，我必须禁用/opt和/home的systemd挂载，尽管我本可以离开它们而不将它们放在此脚本中。现在，在systemd获得控制之前，它可以在/usr中找到它想要的所有内容，并且系统会引导。移动这三个目录给我留下了大约70%的内部存储空间，只占用了SD卡的一小部分。</p><p>可能还有许多其他方法可以做到这一点。我提到了LVM，或者您可以恢复到旧的初始化脚本。但是，一旦你把一切都弄清楚了，这确实可以可靠地工作，而且非常灵活。</p><p>英特尔棒很小，但我们见过更小的。如果您确实在家里尝试这样做，不要忘记登录到eMMC设备并不总是一个好主意。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://hackaday.com/2020/09/03/linux-fu-moving-usr/">https://hackaday.com/2020/09/03/linux-fu-moving-usr/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/fu/">#fu</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/挂载/">#挂载</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1022077.html"><img src="http://img2.diglog.com/img/2020/9/thumb_befcf346bb8dda0419f1c52a6ba7166f.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1022077.html">联想发布首款Fedora Linux ThinkPad笔记本电脑</a></div><span class="my_story_list_date">2020-9-4 16:16</span></div><div class="col-sm"><div><a target="_blank" href="/story/1021645.html"><img src="http://img2.diglog.com/img/2020/9/thumb_cec2909557a8611e525cf6e4cbf59eee.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1021645.html">Bottlerocket，一个为运行容器而构建的开源Linux发行版</a></div><span class="my_story_list_date">2020-9-2 5:25</span></div><div class="col-sm"><div><a target="_blank" href="/story/1021293.html"><img src="http://img.diglog.com/img/2020/8/thumb_0e9879e3990ad48ccf6f9078b27cb5c9.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1021293.html">在ext4中使用Linux内核的不区分大小写特性</a></div><span class="my_story_list_date">2020-8-30 21:8</span></div><div class="col-sm"><div><a target="_blank" href="/story/1021073.html"><img src="http://img.diglog.com/img/2020/8/thumb_3784dc110fc890967203836fc494bb9a.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1021073.html">Linux容器-技术介绍(2015)</a></div><span class="my_story_list_date">2020-8-29 9:10</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>