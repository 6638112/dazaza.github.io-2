<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>在Catalina上违反单调的时间期望</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">在Catalina上违反单调的时间期望</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-21 07:22:55</div><div class="page_narrow text-break page_content"><p>Monotonic time is one of those things that you probably don&#39;t learn about until you&#39;ve been bitten by not using it. The whole point of having a clock which only ever ticks upward is that the system makes an agreement with you that it will never ever go backwards. You can then use this to measure durations no matter what the human-readable (&#34;wall time&#34;) might be doing.</p><p>单调的时间是这样一种东西，除非你被不使用它咬了，否则你可能不会了解它。拥有一个只会向上走的时钟的全部意义在于，这个系统与你达成了一个协议，那就是它永远不会倒退。然后，您可以使用它来测量持续时间，而不管人类可读的(墙时间)可能在做什么。</p><p> That is, even if admin of a box sets the system time back 55 seconds in the middle of your calculations, you can still reliably count out 60 actual seconds and still wait the right amount of time. If you did that with the system clock (wall time), then it would be affected by that adjustment.</p><p>也就是说，即使计算机管理员在计算过程中将系统时间倒退了55秒，您仍然可以可靠地计数出实际的60秒，并且仍然可以等待合适的时间。如果您使用系统时钟(挂钟时间)这样做，那么它将受到该调整的影响。</p><p> Let&#39;s say you&#39;re a developer, and this is you. You were counting out durations with time() or gettimeofday() or something like that, and then a leap second made a hash of your system, or someone seriously screwed up your timekeepingand your machine jumped forward and then back 17 seconds. You learned your lesson and started using monotonic timers.</p><p>让我们假设您是一名开发人员，这就是您。你用time()或gettimeofday()或类似的东西计算持续时间，然后闰秒把你的系统搞得一团糟，或者有人严重破坏了你的计时，你的机器向前跳了17秒，然后又向后跳了17秒。您吸取了教训并开始使用单调计时器。</p><p> Now let&#39;s say you&#39;ve moved on to doing stuff on laptops and other systems which go to sleep sometimes. You&#39;d like to track durations when the machine is actually alive and just not absolute time. You go to the man page for clock_gettime on such a machine, and you find this:</p><p>现在，让我们假设你已经转向在笔记本电脑和其他有时会进入睡眠状态的系统上做事情。您希望跟踪机器实际处于活动状态而不是绝对时间的持续时间。在这样一台机器上，您转到lock_gettime的手册页，您会发现：</p><p> CLOCK_UPTIME_RAW: clock that increments monotonically, in the same manner as CLOCK_MONOTONIC_RAW, but that does not increment while the system is asleep. The returned value is identical to the result of mach_absolute_time() after the appropriate mach_timebase conversion is applied.</p><p>CLOCK_UPTIME_RAW：以与CLOCK_MONTOTION_RAW相同的方式单调递增的时钟，但在系统休眠时不会递增。返回值与应用适当的mach_timebase转换后的mach_Absolute_time()的结果相同。</p><p> Well well well! That sounds pretty awesome, right? It ticks upward, never goes backwards, and only ticks when the machine is awake. That sounds perfect!</p><p>好啊，好啊，好啊！听起来很棒，对吧？它向上滴答作响，从不倒退，而且只在机器唤醒时滴答作响。听起来太棒了！</p><p> You build your stuff around this, and things are okay for a while. But then one day, you notice that your code is very unhappy in certain situations. Indeed, it looks like your stuff is running in very tight circles for unreasonable amounts of time. It was supposed to spin in that tight loop for at most a few milliseconds, but here it is going for minutes, and hours, even!</p><p>你围绕着这一点建立你的东西，事情在一段时间内是好的。但是有一天，您注意到您的代码在某些情况下非常不愉快。事实上，看起来你的东西在非常紧的圈子里运行了不合理的时间。它应该在这个紧密的循环中旋转至多几毫秒，但在这里它要转几分钟，甚至几个小时！</p><p> Then one day you notice that it happens after a deep system sleep of an hour or more, and only when the battery is below 50%. That&#39;s when you see it: on newer versions of the OS, that timer  resets when the machine wakes back up!</p><p>然后有一天，你会注意到，只有在电池电量低于50%的情况下，才会在系统深度睡眠一小时或更长时间后出现这种情况。这就是你看到它的时候：在更新版本的操作系统上，当机器重新唤醒时，计时器会重置！</p><p> You now know why your code would eat 100% of the CPU in that spinloop and would keep going until the machine&#39;s actual uptime had roughly doubled. That is, if you put it to sleep after 45 minutes of uptime with a low-ish battery, then woke it up some time later, it would spin like that for another 45 minutes.</p><p>现在您知道了为什么代码会100%地占用该自旋循环中的CPU，并且会一直运行，直到机器的实际正常运行时间大约翻了一番。也就是说，如果你让它在45分钟的正常运行时间后用低电量的电池休眠，然后过一段时间唤醒它，它会像这样再旋转45分钟。</p><p> Based on a report I got from a reader, this seems to be very real on Macs running Catalina, whereas it was not a thing on Mojave. You can see where this has been reported to libuvand  llvm too.</p><p>根据我从一位读者那里得到的一份报告，这在运行Catalina的Mac上似乎非常真实，而在Mojave上却不是这样。您也可以看到在哪里向libuv和llvm报告了这一点。</p><p> I haven&#39;t tried to duplicate this yet on my own Macs given that it takes a lot of battery drain and then a substantial time asleep and I have other things to do with these boxes. I&#39;m willing to believe this is real based on those bug reports.</p><p>我还没有尝试在我自己的Mac电脑上复制这一点，因为这需要大量的电池消耗，然后需要很长时间的睡眠，而且我还有其他事情要处理这些盒子。根据那些错误报告，我愿意相信这是真的。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="http://rachelbythebay.com/w/2020/10/20/ticktock/">http://rachelbythebay.com/w/2020/10/20/ticktock/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/时间/">#时间</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/monotonic/">#monotonic</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/系统/">#系统</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>