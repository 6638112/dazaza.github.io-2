<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>基于MIR（中等内部表示）的轻量级JIT编译器 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">基于MIR（中等内部表示）的轻量级JIT编译器 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-06 20:01:51</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/12/38ab2f586e1efef00a85f89bcea553e2.png"><img src="http://img2.diglog.com/img/2020/12/38ab2f586e1efef00a85f89bcea553e2.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>MIR项目的目标是为实现快速，轻量级的口译员和JIT提供基础</p><p>  该代码处于开发的初始阶段。仅用于熟悉项目。绝对没有保证将来不会更改MIR，并且该代码适用于任何测试，除了此处给出的测试以及在x86_64 Linux / OSX和aarch64 / ppc64be / ppc64le / s390x Linux以外的平台上进行的测试</p><p>  MIR由模块组成每个函数都有签名（参数和返回类型），局部变量（包括函数参数）和指令每个局部变量的类型只能是64位整数，float，double或long double</p><p>  内存操作数具有类型，位移，基数和索引整数局部变量，以及整数常数作为索引的小数位。内存类型可以是8位，16位，32位和64位有符号或无符号整数类型，浮点类型，双精度型或long double类型使用整数存储值时，将其以符号或零扩展为64位整数值</p><p>  引用操作数用于引用当前模块，其他MIR模块或C外部函数或声明中的函数和声明。</p><p>  有用于在不同的32位和64位有符号和无符号值，浮点，双精度和长双精度值之间进行转换的转换指令</p><p> 在32位和64位有符号和无符号值，浮点，双精度和长双精度值上有算术指令（加，减，乘，除，模） </p><p>存在对32位和64位有符号和无符号值起作用的逻辑指令（或异或运算）  有些比较指令适用于32位和64位有符号和无符号值，浮点，双精度和长双精度值  有分支insns（无条件跳转，并且跳转到零或非零值），它们将一个标签作为其操作数  有组合的比较和分支指令，以一个标签为一个操作数，两个32位和64位有符号和无符号值，浮点，双精度和长双精度值  有切换指令，可根据作为第一个操作数给出的索引从作为操作数给出的标签跳转到标签  有些返回指令适用于32位和64位整数值，float，double和long double值  您可以通过API来创建MIR，该API包含用于创建模块，函数，指令，操作数等的函数 </p><p>了解MIR的最好方法是使用文本MIR表示</p><p> ＃define Size 819000 int sieve（int N）{int64_t i，k，prime，count，n;字符标志[大小];对于（n = 0; n＆lt; N; n ++）{计数= 0; for（i = 0; i＆lt; Size; i ++）标志[i] = 1;对于（i = 0; i＆lt; Size; i ++）如果（flags [i]）{素数= i + i + 3;对于（k = i +素数； k＆lt;大小； k + =素数）标志[k] = 0；数++; }}返回计数；} void ex100（void）{printf（＆＃34;筛（100）=％d \＆＃34 ;，筛（100））; }</p><p>  m_sieve：模块导出筛子筛子：func i32，i32：N local i64：iter，i64：count，i64：i，i64：k，i64：prime，i64：temp，i64：flags alloca标志，819000 mov iter，0循环：bge fin，iter，N mov count，0; mov i，0 loop2：bge fin2，i，819000 mov u8：（flags，i），1;加i，i，1 jmp loop2 fin2：mov i，0 loop3：bge fin3，i，819000 beq cont3，u8：（flags，i），0 add temp，i，i;添加质数，温度3;加k，i，主循环4：bge fin4，k，819000 mov u8：（flags，k），0;添加k，k，素数jmp loop4 fin4：添加计数，计数，1 cont3：添加i，i，1个jmp loop3 fin3：添加iter，iter，1个jmp循环fin：ret count endfunc endmodule m_ex100：模块格式：字符串＆＃ 34;筛（10）=％d \ n＆＃34; p_printf：proto p：fmt，i32：result p_sieve：proto i32，i32：iter export ex100 import sieve，printf ex100：func v，0 local i64：r调用p_sieve，sieve，r，100调用p_printf，printf，format，r endfunc结束模块</p><p> func描述函数的签名（采用32位signedinteger参数并返回32位带符号整数值）和函数参数N，它们将是64位带符号整数类型的局部变量。函数结果首先按类型进行描述，并且没有名称。参数始终具有名称，并在结果描述之后</p><p> 函数可能具有多个结果，但是当前机器定义了可能的数量和结果类型的组合</p><p>    我们可以在计算中使用32位指令，如果使用32位CPU，这将是有意义的。当使用32位指令时，我们仅使用64位操作数的32位有效部分，而结果的高32位部分是机器已定义（因此，如果您编写可移植的MIR代码，请考虑未定义高32位部件值）</p><p> 字符串以C字符串的形式描述数据C字符串可以直接用作insn操作数。在这种情况下，数据将添加到模块中，并且数据地址将用作操作数 </p><p>导入描述了应在其他MIR模块中定义的模块功能或数据</p><p>  创建MIR模块（通过MIR API或读取MIR二进制或文本文件）后，您应该加载模块</p><p>  链接后，您可以从模块解释功能，也可以为MIR JIT编译器（生成器）生成的功能调用机器代码。函数的执行方式通常由设置接口定义。生成的代码的生成方式（延迟在第一次调用时或提前生成）也可以取决于接口</p><p> 上面示例中的运行代码如下所示（此处m1和m2是模块m_sieve和m_e100，func是函数ex100，sieve是函数sieve）：</p><p> / * ctx是由MIR_init创建的上下文* / MIR_load_module（ctx，m1）; MIR_load_module（ctx，m2）; MIR_load_external（ctx，＆＃34; printf＆＃34 ;, printf）; MIR_link（ctx，MIR_set_interp_interface，import_resolver）; / *或使用MIR_set_gen_interface来生成和使用机器代码* / / *或使用MIR_set_lazy_gen_interface来在其第一次调用时生成功能代码* / / *使用MIR_gen（ctx，func）来显式生成功能机器代码* / MIR_interp（ctx ，func，＆amp; result，0）; / *零是参数编号* / / *或（（void（*）（void））func-＆gt; addr）（）;打电话给interpr。或gen。通过接口代码* /</p><p>   二进制MIR代码通常比类似的MIR文本代码小10倍，读取速度快10倍</p><p>   从WASM到MIR的转换应该非常简单明了仅需要为MIR提供用于WASM浮点数insns的小型WASM运行时 </p><p>到/从MIR和从/到MIR编译器的LLVM IR的Java字节代码的实现将是一个挑战：  也可以将GCC移植到MIR。 经验丰富的GCC开发人员可以实施6到12个月  据我估计，将MIR JIT编译器移植到mips64或sparc64将需要每个目标1-2个月的工作  注重性能的将MIR JIT编译器移植到32位目标将需要实现附加的小分析传递，以获取仅在32位指令中使用的64位变量的信息。  我们使用一种Braun算法的形式来构建SSA（M。Braun等人，“静态单项分配表单的简单而有效的构造”）  构建SSA：通过将phi节点和SSA边添加到操作数来构建单个静态分配表单  走出SSA：移除phi节点和SSA边缘（我们一直保持传统的SSA） </p><p>文件mir.h和mir.c包含主要的API代码，包括MIR二进制和MIR文本表示的输入/输出</p><p> 文件mir-dlist.h，mir-mp.h，mir-varr.h，mir-bitmap.h，mir-htab.h包含对应于双链表，内存池，可变长度数组，位图，哈希表的通用代码。文件mir-hash.h是哈希表使用的通用，简单，高质量的哈希函数</p><p> 文件mir-interp.c包含用于解释MIR代码的代码。它包含在mir.cand中，从未单独编译</p><p>    文件c2mir / c2mir.h，c2mir / c2mir.c，c2mir / c2mir-driver.c和c2mir / mirc.h包含用于C到MIR编译器的代码。目录c2mir / x86_64和c2mir / aarch64，c2mir / ppc64和c2mir / s390x中的文件分别包含用于C到MIR编译器的x86_64，aarch64，ppc64和s390x机器相关代码</p><p>  当前代码只能用于使将来的用户熟悉该项目及其使用的方法</p><p>   [1]是基于筛网代码（无任何包含文件和GCC使用内存文件系统）的编译时间的100倍。使用的优化级别为1</p><p>  [3]基于使用MIR发电机优化级别1的10次运行的最佳壁挂时间 </p><p>[4]基于针对GCC和MIR内核的cc1的剥离大小以及针对MIR的解释器或生成器  [5]基于生成空C文件的目标代码或通过API生成emptyMIR模块的时间  [6]仅基于x86-64 C编译器所需的文件以及用于创建和运行MIR代码的最少程序的文件  我只看到三个可以视为或改编为真正的通用轻量级JIT竞争对手的项目  QBE：它生成的汇编代码使QBE 30的机器代码生成速度比MIR生成器慢  LIBJIT开始作为DotGNU项目的一部分：LIBJIT更大：80K C行（用于不带动态Pascal编译器的LIBJIT）与MIR的10K C行（不包括C到MIR编译器） </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://github.com/vnmakarov/mir">https://github.com/vnmakarov/mir</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/编译/">#编译</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/jit/">#jit</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/weight/">#weight</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/mir/">#mir</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1038019.html"><img src="http://img2.diglog.com/img/2020/12/thumb_022ae1f163e3837faf7572f4d1b4761b.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1038019.html">Template Haskell和交叉编译的故事 </a></div><span class="my_story_list_date">2020-12-6 14:57</span></div><div class="col-sm"><div><a target="_blank" href="/story/1037150.html"><img src="http://img2.diglog.com/img/2020/11/thumb_b5310b7ab14bd3f2dcb5e98a7f9dc32a.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1037150.html">Richard Miller的RISC-V计划9 C编译器[视频]</a></div><span class="my_story_list_date">2020-11-30 0:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1037116.html"><img src="http://img2.diglog.com/img/2020/11/thumb_025b67dc2053e70abacf6317da9484ff.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1037116.html">Nim编译器— Pascal源代码</a></div><span class="my_story_list_date">2020-11-29 16:5</span></div><div class="col-sm"><div><a target="_blank" href="/story/1036945.html"><img src="http://img2.diglog.com/img/2020/11/thumb_c22dc4656fda92a95b3ba1c933beee0f.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1036945.html">AWS聘请Rust编译器团队联合负责人Felix Klock</a></div><span class="my_story_list_date">2020-11-28 7:35</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>