<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>生产中的ES模块：我到目前为止的经验</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">生产中的ES模块：我到目前为止的经验</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-26 21:49:33</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/c9ec90dcde14834f0586db1457745446.png"><img src="http://img2.diglog.com/img/2020/10/c9ec90dcde14834f0586db1457745446.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>For the last year, I’ve been running a single-page web app powered by ES modules in production.</p><p>在过去的一年里，我一直在生产中运行一个由ES模块提供支持的单页Web应用程序。</p><p> It’s a JavaScript app but it doesn’t use Babel, Webpack, Rollup, or any other tooling for transpiling or bundling. The files I write in development are the same files that get served to end-users in production.</p><p>这是一款javascript应用程序，但它不使用巴别塔、webpack、Rollup或任何其他工具来进行转换或捆绑。我在开发中编写的文件与在生产中提供给最终用户的文件相同。</p><p> The app is for a side-project… an  online music-box song making tool. It’s not a massive app, but it’s not tiny either—there’s currently about 60 JavaScript modules, which are a mix of components, utilities, and third-party libraries.  The codebase looks a lot like a ReactJS project, but it doesn’t use React. It uses a plain JavaScript alternative that substitutes abstractions (like JSX) with native JavaScript features (like template strings). The framework isn’t relevant for the purpose of this post but you can read more about it in  my earlier post, if you are curious.</p><p>这个应用程序是针对副项目…的。一个在线音乐盒歌曲制作工具。它不是一个庞大的应用程序，但也不算小--目前大约有60个JavaScript模块，这些模块混合了组件、实用程序和第三方库。代码库看起来很像一个ReactJS项目，但是它没有使用Reaction。它使用普通的JavaScript替代方案，将抽象(如JSX)替换为原生JavaScript特性(如模板字符串)。这个框架与这篇文章的目的无关，但如果你感兴趣，可以在我之前的文章中阅读更多关于它的内容。</p><p> When I launched the app in August 2019, the industry consensus was that using unbundled ES6 modules in production was a bad idea. Khan Academy tried unbundling their homepage JS and concluded that  it slowed down their initial page load. That was five years ago and I still don’t know of anybody who seriously considers skipping the bundler and using ES6 modules in production.*</p><p>当我在2019年8月发布这款应用时，业界的共识是，在生产中使用非捆绑的ES6模块是一个坏主意。Khan Academy尝试拆分他们的主页JS，并得出结论，这降低了他们最初的页面加载速度。那是五年前的事了，我至今还不知道有谁认真考虑跳过捆绑包，在生产中使用ES6模块。*。</p><p> And that’s too bad because now that  browser support for ES modules is great, it seems like we could avoid a lot of  nonsense by just  writing JavaScript that the browser understands (at least for projects where it makes sense).</p><p>这太糟糕了，因为现在浏览器对ES模块的支持非常好，似乎只需编写浏览器能够理解的JavaScript就可以避免很多无稽之谈(至少对于有意义的项目是这样)。</p><p> I kept looking for examples of people doing this but I struggled to find them, so I decided I’d give it a try and see how bad it really was. Here’s what I found:</p><p>我一直在寻找人们这样做的例子，但我很难找到他们，所以我决定试一试，看看到底有多糟糕。这是我的发现：</p><p>  Development experience. I expected the development experience to be great, and it was. There’s no setup instructions, no startup delays. No need to watch files, generate source maps, or wait for things to recompile. Just save the file and refresh. ✨</p><p>开发经验。我原以为开发体验会很棒，事实也的确如此。没有安装说明，没有启动延迟。无需查看文件、生成源映射或等待重新编译。只需保存文件并刷新即可。✨。</p><p> Deployment. Deployment was straightforward. All I needed to do was copy my code to the server as-is. My web host Netlify makes it easy to do this on git push (though, to be fair, Netlify can make even the most complex setups easy to deploy).</p><p>部署。部署非常简单。我所需要做的就是按原样将代码复制到服务器。我的网络主机netlify使得在git推送上实现这一点变得很容易(不过，公平地说，netlify甚至可以让最复杂的设置也很容易部署)。</p><p> Dev/Prod parity. Every time I found a production bug I was able to reproduce it locally. Not a major goal, but very convenient.</p><p>开发/生产奇偶校验。每次我发现生产缺陷时，我都能在本地复制它。这不是一个主要目标，但非常方便。</p><p>  Dependencies not supporting ES modules.I often found libraries I wanted to use, only to learn that they didn’t support ES modules. They usually supported CommonJS instead, which meant I couldn’t use them. At first, I was working around this by loading versions of the library that use browser globals (either via script tag, or  side-effects import). This worked, but it didn’t feel ideal.</p><p>依赖项不支持ES模块。我经常发现我想使用的库，结果却发现它们不支持ES模块。它们通常支持CommonJS，这意味着我不能使用它们。起初，我通过加载使用浏览器全局变量的库版本(通过脚本标记或副作用导入)来解决这个问题。这很管用，但感觉并不理想。</p><p> Eventually, I started using  Snowpack, which can import dependencies that don’t support ES modules and produce a one-time build that does. This worked so well that  I’ve started using it on other projects.</p><p>最后，我开始使用SnowPack，它可以导入不支持ES模块的依赖项，并生成支持ES模块的一次性构建。它工作得非常好，我已经开始在其他项目中使用它。</p><p> Environment variables. Typically, I’d assign these at build-time but you can’t when there’s no build. Fortunately, Cory House has  a great post describing all the options. I ended up using  environment sniffing which feels a little weird, but ultimately isn’t a big deal for my app.</p><p>环境变量。通常，我会在构建时分配这些参数，但在没有构建时就不能了。幸运的是，科里·豪斯有一个很棒的帖子描述了所有的选择。我最终使用了环境嗅探，这感觉有点奇怪，但最终对我的应用程序来说并不是什么大不了的事。</p><p> CSS organization. I went with traditional CSS using BEM conventions, which was fine. I still wanted to break up my files though, so I used a  main.css file with a bunch of  @imports. That felt better, but then I had a blocking request that delayed page rendering so  I moved the  @imports into an inline style tag. I’m not sure if I like it, so I may keep iterating on this.</p><p>CSS组织。我使用传统的CSS，使用BEM约定，这很好。不过，我仍然想拆分我的文件，所以我使用了一个带有一堆@Imports的main.css文件。这感觉好多了，但是后来我有一个阻塞请求，延迟了页面呈现，所以我将@Imports移到了内联样式标记中。我不确定我是否喜欢，所以我可能会继续重复这一点。</p><p>  Cache invalidation. I was worried that I was going to have trouble invalidating cached CSS or JavaScript (since I couldn’t rely on a bundler to give my assets cache-busting filenames). It turns out that  ETags are a great solution for this (especially since  my web host has a solid implementation that’s quick and simple). I’ve heard that cache-busting filenames can be a bit faster than Etags, but Netlify’s implementation feels pretty snappy to me.</p><p>缓存无效。我担心我在使缓存的CSS或JavaScript无效时会遇到麻烦(因为我不能依赖捆绑程序为我的资产指定缓存破坏的文件名)。事实证明，eTags是解决这个问题的一个很好的解决方案(特别是因为我的web主机有一个快速而简单的可靠实现)。我听说破坏缓存的文件名可能比eTag快一点，但我觉得Netlify的实现相当快。</p><p> Performance.Everything I heard said that ES module performance was going to be terrible, even with HTTP/2. So I braced myself and… it’s been great. I haven’t even done any optimizations beyond making sure that my initial HTML file had some good default markup. I suspect the performance is good because my app isn’t big enough to start hitting any bottlenecks yet ( this research says you’ll be fine if you’re below a couple hundred modules, which  seems to be confirmed anecdotally). This made me realize that that my intuition was off on what was “too big” of an app. You can go a long way before you’re in a place where you need to load 300-500 files, all at once. It feels unlikely that I’ll reach those limits on my app, at least.</p><p>性能。我听到的每一件事都说ES模块的性能会很糟糕，即使是使用HTTP2。所以我和…都做好了准备。这真是太棒了。除了确保我的初始HTML文件具有一些良好的默认标记之外，我甚至没有做任何优化。我怀疑性能很好，因为我的应用还没有大到可以开始遇到任何瓶颈(这项研究说，如果你低于几百个模块就可以了，这一点似乎得到了坊间的证实)。这让我意识到，我的直觉偏离了一款应用程序的“太大”。在您需要一次加载300-500个文件之前，您可以走很长一段路。至少，我觉得我的应用程序不太可能达到这些限制。</p><p> I was a little worried about not minifying my JavaScript. Isn’t that a huge number of bytes saved? It turns out that the difference is a lot smaller when your files are served gzipped (or  brotli-compressed, as in my case). Minifying would still make my files smaller by renaming variables and stripping out comments, but the difference was less than I expected.</p><p>我有点担心没有缩小我的JavaScript。这不是节省了大量字节吗？事实证明，当您的文件以gzip(或brotli压缩，就像我的例子)提供服务时，差别要小得多。通过重命名变量和去掉注释，缩小仍然会使我的文件更小，但是差别比我预期的要小。</p><p> Browser support. Since I wasn’t using Babel, I expected lots of cross-browser issues but they were rare.** It turns out that once you drop IE11 support, browser support of modern JS features is really good. Things like arrow functions, const/let, template strings, ES6 classes, and  fetch all have over 95% global support (and that’s including IE11). The only time I didn’t get to use a JS feature I really wanted was  the optional chaining operator, and that feature will probably have 95% support in the next year or two. Evergreen browsers are a powerful thing.</p><p>浏览器支持。因为我没有使用Babel，所以我预计会有很多跨浏览器的问题，但它们很少见。**事实证明，一旦你放弃了对IE11的支持，浏览器对现代JS特性的支持就真的很好了。箭头函数、const/let、模板字符串、ES6类和FETCH等都有超过95%的全局支持(包括IE11)。我唯一一次没有使用我真正想要的JS特性是可选的链运算符，该特性在未来一两年内可能会有95%的支持。长青浏览器是一个功能强大的东西。</p><p>  I’ve been pleasantly surprised. If this were a typical, bundled, single-page-application, I would have needed to deal with one or two major tooling upgrades by now. Instead, I’ve been able to focus on features.  Native web technologies FTW!</p><p>我很惊喜。如果这是一个典型的、捆绑的、单页面的应用程序，我现在就需要处理一两个主要的工具升级。取而代之的是，我能够专注于功能。原生网络技术FTW！</p><p> If my module count gets so big that performance starts to noticeably degrade, I’m pretty confident that I’ll be able to use Snowpack to work through it. From  their docs:</p><p>如果我的模块数量太大，性能开始明显下降，我很有信心能够使用SnowPack来解决这个问题。从他们的文档中：</p><p> Snowpack treats bundling as an optional production optimization, which means you’re free to skip over the extra complexity of bundling until you need it.  You should be able to use a bundler because you want to, and not because you need to.</p><p>SnowPack将捆绑视为可选的生产优化，这意味着您可以自由地跳过捆绑的额外复杂性，直到需要为止。您应该能够使用捆绑器，因为您想这样做，而不是因为您需要这样做。</p><p>  Maybe ES modules aren’t for every project but they’ve worked pretty well for mine. If there are fundamental flaws, I haven’t found them yet.</p><p>也许ES模块并不适用于每个项目，但它们在我的项目中工作得很好。如果说有什么根本性的缺陷，我还没有找到。</p><p> Honestly, it’s hard for me to imagine building a side-project any other way right now.</p><p>老实说，现在我很难想象以其他方式构建一个副业。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.bryanbraun.com/2020/10/23/es-modules-in-production-my-experience-so-far/">https://www.bryanbraun.com/2020/10/23/es-modules-in-production-my-experience-so-far/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/模块/">#模块</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/modules/">#modules</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>