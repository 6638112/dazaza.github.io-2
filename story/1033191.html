<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>JIT初见端倪</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">JIT初见端倪</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-05 02:06:51</div><div class="page_narrow text-break page_content"><p>这个问题在很大程度上是自己造成的，是由于编译器太慢(我们经常使用LLVM)造成的，而我们给它提供了大段代码来进行更多的优化，这让情况变得更糟。</p><p>通过限制自己一次只编译一条指令，我们在表上留下了一些性能，但极大地提高了编译速度。</p><p>这使得编译速度非常快，因为我们基本上只是在每次使用指令时复制-粘贴模板，仅根据其参数执行一些细微的调整。</p><p>乍一看，这可能令人望而生畏，但一旦你习惯了，实际上并不是那么糟糕。虽然即使是最小的事情也需要大量的代码才能实现，但只要代码保持简短，就本质上是简单和容易遵循的。</p><p>缺点是每种体系结构都需要实现每条指令，但幸运的是没有很多流行的指令，我们希望在发布OTP24时支持两个最常见的指令：x86_64和AArch64。其他人将继续使用口译员。</p><p>编译模块时，JIT逐个检查指令，并在编译过程中调用机器代码模板。这对解释器有两个非常大的好处：不需要在它们之间跳转，因为它们是背靠背发出的，每个参数的结尾是下一个参数的开始，并且参数不需要在运行时解决，因为它们已经“燃烧”了。</p><p>现在我们已经了解了一些背景知识，让我们来看一下上一篇文章中示例的机器代码模板IS_NONEMPTY_LIST：</p><p>/*参数作为包含*类型和值的`ArgVal`对象传递，例如说&#34；X寄存器4&#34；，*&#34；原子&#39；hello&#39；&#34；，&#34；Label 57&#34；等等。*/void BeamModuleAssembler：：emit_is_non Empty_List(const ArgVal&amp；Fail，const ArgVal&amp；Src){/*找出`Src`位于哪个内存地址。*/x86：Mem list_ptr=getArgRef(Src)；/*发出`test`指令，对*list_ptr指向的内存进行非*破坏性操作，如果列表为*空，则清零标志。*/a。Test(list_ptr，imm(_tag_primary_ask-tag_primary_list))；/*如果零标志清零(列表为空)，则会发出`jnz`指令，跳转到失败标签*。*/a。JNZ(标签[失败。GetValue()])；/*与那里的解释器不同，不需要跳到*下一条成功指令，因为它紧跟在这条指令之后。*/}</p><p>该模板将生成与模板本身几乎相同的代码。假设我们的源是“X寄存器1”，失败标签是57：</p><p>这比解释器快得多，甚至比线程化代码更紧凑，但这是一条微不足道的指令。更复杂的呢？让我们来看看解释器中的超时指令：</p><p>超时(){if(is_traced_FL(c_p，F_trace_Receive)){TRACE_RECEIVE(c_p，am_lock_service，am_timeout，am_timeout，null)；}if(ERTS_proc_get_saved_call_buf(C_P)){save_call(c_p，&amp；exp_timeout)；}c_p-&gt；标志&amp；=~F_Timo；Join_Message(C_P)；}。</p><p>这必然会有大量的代码，而手动转换这些宏真的很烦人。我们究竟如何才能做到这一点而不发疯呢？</p><p>静态无效超时(进程*c_p){if(is_traced_FL(c_p，F_trace_Receive)){trace_Receive(c_p，am_lock_service，am_timeout，am_timeout)；}if(ERTS_proc_get_saved_call_buf(C_P)){save_call(c_p，&amp；exp_timeout)；}c_p-&gt；标志&amp；=~F_Timo；Join_Message(C_P)；}void BeamModuleAssembler：：emit_timeout(){/*将第一个C参数设置为当前正在执行的*进程c_p，然后调用上面的C函数。*/a。Mov(arg1，c_p)；a.。Call(imm(超时))；}。</p><p>这个小的逃生口让我们从一开始就不必用汇编语言写所有的东西，而且很多指令仍然是这样的，因为没有必要改变它们。</p><p>今天就到这里吧。在下一篇文章中，我们将介绍我们的约定和一些我们用来减少代码大小的技术。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.erlang.org/a-first-look-at-the-jit/">https://blog.erlang.org/a-first-look-at-the-jit/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/jit/">#jit</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/指令/">#指令</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>