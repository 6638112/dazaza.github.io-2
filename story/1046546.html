<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Rust基准自动火焰记录仪 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Rust基准自动火焰记录仪 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-29 05:56:14</div><div class="page_narrow text-break page_content"><p>这只是关于我最近在Rust生态系统中发现的东西的简短文章：</p><p>  如果您订阅了Medium，并希望支持我，则可以阅读Medium上的这篇文章。</p><p>  Criterion是Rust生态系统中一个众所周知且经常使用的基准测试框架。如果您还没有听说过，一定要查看一下！</p><p> 从v0.3开始，Criterion支持进程内分析挂钩，它们允许我们在运行基准测试时使用自定义探查器。注册自定义探查器后，我们可以通过使用--profile-time标志运行基准测试套件来启用它们。</p><p> 为基准测试有一个用于自定义探查器的钩子，您可以做一些很棒的事情，例如，使用pprof为每个基准测试生成火焰图。</p><p>   这些数字很棒。但是我们怎样才能更快地做到这一点呢？我们在哪里花费最多的时间？”</p><p>  以前，我只靠使用可靠的实用工具-cargo-flamegraph弄脏了手，但是问题是，当使用带有基准的cargo-flamegraph时，通常会出现一些不必要的混乱情况，例如基准测试的设置例程以及Criterion附带的框架代码。 </p><p>pprof是一个CPU事件探查器，可用于在Linux上探查程序的特定部分。最重要的是：它甚至支持使用功能标志flamegraph生成探查图。</p><p>   现在，我们将使用pprof为标准创建自定义探查器，该探查器将为每个基准打印火焰图。</p><p>  [dev-依赖项] pprof = {版本=＆＃34; 0.3＆＃34; ，功能= [＆＃34; flamegraph＆＃34; ]}准则=＆＃34; 0.3＆＃34; ＃条件宏=＆＃34; 0.3＆＃34; ＃可选，如果您使用自定义测试框架</p><p> 现在在您的长椅/文件夹中创建一个新文件。我们称之为perf.rs。在这里，我们将实现新的FlamegraphProfiler。</p><p> 实现自定义事件探查器的接口实际上很简单，我们只需要实现Criterion的Criteria :: profiler :: Profiler特质就可以了。</p><p> 使用std :: {fs :: File，os :: raw :: c_int，path :: Path};使用标准：：探查器：：探查器；使用pprof :: ProfilerGuard; ///可以与Criterion一起使用的小型自定义探查器，可以为基准创建火焰图。 ///另请参见[关于此的条件文档] [custom-profiler]。 /// /// ##有关如何启用定制分析器的示例：/// ///```/// mod perf; ///使用perf :: FlamegraphProfiler; /// /// fn fibonacci_profiled（criterion：＆amp; mut Criterion）{/// //在此处正常使用准则struct。 ///} /// /// fn custom（）-＆gt; Criterion {/// Criterion :: default（）。with_profiler（FlamegraphProfiler :: new（））///} /// /// criteria_group！ {///名称=长凳； /// config = custom（）; ///目标= fibonacci_profiled ///} ///```/// ///这样做的好处是它将仅对基准进行采样，而不对诸如///设置过程之类的东西进行采样。 /// ///此外，只有将`--profile-time＆lt; time＆gt;`传递给基准二进制文件时，它才会启动。 ///将在其报告目录中的每个单独基准中创建一个火焰图，///`profile / flamegraph.svg`下。 /// /// [custom-profiler]：https://bheisler.github.io/criterion.rs/book/user_guide/profiling.html#implementing-in-process-profiling-hooks发布结构FlamegraphProfiler＆lt; ＆＃39; a＆gt; {频率：c_int，active_profiler：选项＆lt; ProfilerGuard＆lt; ＆＃39; a＆gt; ，} impl＆lt; ＆＃39; a＆gt; FlamegraphProfiler＆lt; ＆＃39; a＆gt; {＃[allow（dead_code）] pub fn new（频率：c_int）-＆gt;自我{FlamegraphProfiler {频率，active_profiler：无，}}} impl＆lt; ＆＃39; a＆gt; FlamegraphProfiler＆lt; ＆＃39; a＆gt; {fn start_profiling（＆amp; mut self，_benchmark_id：＆amp; str，_benchmark_dir：＆amp; Path）{self。 active_profiler = Some（ProfilerGuard :: new（self。frequency）。unwrap（））; } fn stop_profiling（＆amp; mut self，_benchmark_id：＆amp; str，Benchmark_dir：＆amp; Path）{std :: fs :: create_dir_all（beta_dir）。解开（）;让flamegraph_path = Benchmark_dir。加入（＆＃34; flamegraph.svg＆＃34;）; let flamegraph_file = File :: create（＆amp; flamegraph_path）。期望（＆＃34;创建flamegraph.svg＆＃34;时发生文件系统错误）；如果让Some（分析者）=自我。 active_profiler。接受（）{分析器。报告（）。 build（）。展开（）。 Flamegraph（flamegraph_file）。期望（＆＃34;编写flamegraph错误＆＃34;）; }}}</p><p> 要使用新的探查器，我们需要在Criterion中注册它。另请参阅Criterion的高级配置。 </p><p>如果您将自定义测试框架功能与criteria-macro结合使用，则可以使用以下命令对其进行配置：</p><p> ＃！[feature（custom_test_frameworks）]＃！[test_runner（criterion :: runner）]使用准则：： {Criterion，black_box};使用standard_macro ::条件;国防部性能; fn斐波那契（n：u64）-> u64 {匹配n {0 | 1 => 1，n ＝＞ 1。斐波那契（n-1）+斐波那契（n-2），}} fn custom_criterion（）-＆gt;条件{Criterion :: default（）。 with_profiler（perf :: FlamegraphProfiler :: new（100））}＃[criterion（custom_criterion（））] fn bench_custom（c：＆amp; mut Criterion）{c。 bench_function（＆＃34; Fibonacci-Custom＆＃34;，| b | b。iter（|| fibonacci（black_box（20））））; }</p><p>  国防部性能;条件组！ {名称=长凳; //这可以是任何返回`Criterion`对象的表达式。 config = Criterion :: default（）。 with_profiler（perf :: FlamegraphProfiler :: new（100）;目标=工作台}</p><p> 既然我们已经设置了自定义探查器，那么就可以将其实际用于基准测试，如下一节所述。</p><p>   要在不以root用户身份运行基准的情况下启用性能分析，您可能需要将Linux内核中的perf_event_paranoid的值调整为适合您的环境的值。最允许的值为-1。</p><p>     使用我们的自定义FlamegraphProfiler，此命令将在benchs / my_bench.rs中运行基准5秒钟。</p><p> 注意：您需要指定基准的名称，否则可能会收到错误Unrecognized选项：＆＃39; profile-time＆＃39;。有关有效的命令行选项，另请参见长条凳给出“ Uncognized Option”的错误。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.jibbow.com/posts/criterion-flamegraphs/">https://www.jibbow.com/posts/criterion-flamegraphs/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/基准/">#基准</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/criterion/">#criterion</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1046474.html"><img src="http://img2.diglog.com/img/2021/1/thumb_956e4ecdbda2f7c9eefb95b7fe08f1a4.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1046474.html">据报道，Facebook考虑通过反托拉斯诉讼打击苹果 </a></div><span class="my_story_list_date">2021-1-29 3:25</span></div><div class="col-sm"><div><a target="_blank" href="/story/1046393.html"><img src="http://img2.diglog.com/img/2021/1/thumb_617ce6aec8f6f79201be77aa512fe397.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1046393.html">Facebook针对iOS 14隐私功能对苹果提起反托拉斯诉讼 </a></div><span class="my_story_list_date">2021-1-28 23:36</span></div><div class="col-sm"><div><a target="_blank" href="/story/1046257.html"><img src="http://img2.diglog.com/img/2021/1/thumb_3542c06f46d07695073d006761995d94.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1046257.html">资料来源：Facebook正在准备针对苹果的反托拉斯诉讼，以迫使开发人员遵守App Store的规则，因为Apple自己的应用不必遵循 </a></div><span class="my_story_list_date">2021-1-28 22:35</span></div><div class="col-sm"><div><a target="_blank" href="/story/1046227.html"><img src="http://img2.diglog.com/img/2021/1/thumb_8d0a26d22bd8cf2589a7e1d489571387.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1046227.html">设置Anaconda，Jupyter和Rust </a></div><span class="my_story_list_date">2021-1-28 22:27</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>