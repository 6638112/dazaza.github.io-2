<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>如何创建自动AWS计费报告</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">如何创建自动AWS计费报告</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-18 15:07:05</div><div class="page_narrow text-break page_content"><p>Amazon提供创建计费警报的功能，可在您的AWS账单超过特定阈值时发出警报。但是，此方法有几个缺点：</p><p>您需要设置一个预定义的阈值。当您第一次开始使用AWS时，很难知道您的AWS账单会是什么样子。为了安全起见，很多人把这个门槛设得很低。</p><p>像这样的警报往往是被动的，而不是主动的。一旦超过阈值，就会触发警报。例如，我忘了关闭我不再使用的EC2实例，但大约一周后，当我的计费阈值超过限制时，我才发现这一点。</p><p>Cost Explorer确实提供了一个易于使用的界面，可以帮助您随时掌握账单数据。然而，这需要人们定期使用该工具，以确保我们不会遗漏任何东西。</p><p>在本文中，我们将研究如何构建一个简单的管道来通过电子邮件向我们发送账单报告。生成的报告将如下所示：</p><p>我们将创建一个名为app的新文件夹，该文件夹将存储Cost Explorer API和使用SES的应用程序逻辑。</p><p>我们还将在根目录中创建一个名为handler.py的文件。该文件将包含用于生成计费报告的逻辑。</p><p>我们将使用Cost Explorer中的Cost and Usage端点来获取所需的计费数据。</p><p>从datetime导入boto3从dateutil.relativedelta导入relativedelta类CostExplorer：TODAY_DATE=DATETIME。Utcnow()。Date()cur_Month_Date=TODAY_DATE。替换(DAY=1)PRIV_MONTER_DATE：DATE=CUR_MONTER_DATE-Relativedelta(MONTS=+1)def__init__(Self)：self。客户端=boto3。客户(&#34；ce&#34；)本人。指标=[&#34；UNBLANDED_COST&#34；]自身。币种：str=&#34；美元；本身。Daily_report_kwargs={&#34；时间段&#34；：自我。_Get_Time Period(START=SELF。TODAY_DATE-TIMEDAR(DAYS=2)，#START_DT包含END=SELF。TODAY_DATE，#END_DT是独占的)，&#34；指标&#34；：SELF。指标，&#34；粒度&#34；：&#34；每日&#34；}自身。Monthly_Report_kwargs={&#34；时间段&#34；：自我。_Get_Time Period(START=SELF。PRIV_MONTH_DATE，#START_DT包含END=SELF。TODAY_DATE，#END_DT是独占的)，&#34；指标&#34；：SELF。指标，&#34；粒度&#34；：&#34；每月&#34；}def_get_timePeriod(self，start：date，end：date)：return{&#34；start&#34；：start。Isoformat()，&#34；End&#34；：End。Isoformat()，}def_get_data(self，result)：&#34；&#34；&#34；&#34；从成本资源管理器数据中检索单个帐单行。结果：行={&#34；日期&#34；：v[&#34；时间段&#34；][&#34；开始&#34；]}v[&#34；Groups&#34；]：Key=i[&#34；Keys&#34；][0]行中i的&#34；&#34；&#34；&#34；&#34；&#34；行=[]。更新({key：Float(I[&#34；Metrics&34；][&#34；UnblendedCost&#34；][&#34；Amount&#34；])})行。更新({&#34；Total&#34；：Float(v[&#34；Total&#34；][&#34；UnblendedCost&#34；][&#34；Amount&#34；])})行。Append(Row)return[f&#34；{row[&#39；date&#39；]}：{round(row[&#39；Total&#39；]，2)}&#34；针对行中的行]def GENERATE_REPORT(SELF，REPORT_KWARGS)：&#34；&#34；&#34；根据粒度、开始日期和结束日期获取成本数据。&#34；&#34；&#34；响应=自我。客户。GET_COST_AND_USAGE(**REPORT_KWARGS)返回&#34；\n&#34；。加入(自我)。_GET_DATA(Response[&#34；ResultsByTime&#34；])。</p><p>我们希望生成两个报告，一个是最近2天的报告(每日粒度)，另一个是比较上个月与当前月的支出(每月粒度)。</p><p>我们使用未混合成本来表示我们的账单数据。有关这方面的更多信息可以在此处找到。</p><p>SES需要经过验证的电子邮件地址才能使用。可以通过AWS控制台进行验证。</p><p>导入boto3 class EmailClient：Sender=&#34；Sendder=&#34；AWS Cost Alert&lt；[电子邮件受保护]&gt；&#34；Subject=&#34；每日AWS账单报告&#34；#具有非HTML电子邮件客户端的收件人的电子邮件正文。Body_Text=&#34；&#34；&#34；&#34；AWS计费警报\r\n每日计费报告\r\n{DAILY_BILLING_REPORT}\r\n{MONTRATE_BILLING_REPORT}\r\n&#34；&#34；&#34；#电子邮件的HTML正文。Body_html=&#34；&34；&lt；html&gt；&lt；head&gt；&lt；/head&gt；&lt；body&gt；&lt；h1&gt；AWS计费预警&lt；/h1&gt；&lt；hr/&gt；h3&gt；每日账单&lt；/h3&gt；&lt；p&gt；{Daily_billing_report}&lt；/p&gt；&lt；hr/&gt；&lt；H3&gt；每月账单&lt；/h3&gt；&lt；p&gt；{Monthly_Billing_Report}&lt；/p&gt；&lt；/body&gt；&lt；/html&gt；&#34；&#34；&#34；#电子邮件的字符编码。Charset=&#34；UTF-8&#34；#收件人电子邮件地址Recipient=&#34；[电子邮件受保护]&#34；def__init__(Self)：自我。客户端=boto3。客户端(&#34；SES&#34；)def send(SELF，DAILY_BILLING_REPORT，MONTAY_BILLING_REPORT)：&#34；&#34；&#34；&#34；发送包含AWS计费数据的电子邮件&#34；&#34；&#34；电子邮件_TEXT=SELF。正文(_Text)。格式(Daily_Billing_Report=Daily_Billing_Report，Monthly_Billing_Report=Monthly_Billing_Report)email_html=self。Body_HTML。格式(DAILY_BILLING_REPORT=DAILY_BILLING_REPORT，MOUNTAL_BILLING_REPORT=MONTRATE_BILLING_。客户。发送电子邮件(Destination={&#34；ToAddresses&#34；：[Self.。收件人，]，}，邮件={&#34；正文&#34；：{&#34；HTML&#34；：{&#34；字符集&#34；：自我。字符集，&#34；data&#34；：email_html}，&#34；text&#34；：{&#34；Charset&#34；：Self。字符集，&#34；数据&#34；：电子邮件_文本，}，}，&#34；主题&#34；：{&#34；字符集&#34；：自我。字符集，&#34；数据&#34；：自我。主题，}，}，来源=自我。发件人，)。</p><p>现在，我们将使用成本资源管理器和SES生成报告。用下面的代码片段替换handler.py的内容：</p><p>从app.ost_explorer导入CostExplorer从app.email导入EmailClient def main()：ce=CostExplorer()Daily_report=ce。生成报告(CE.。Daily_report_kwargs)Monthly_Report=ce。生成报告(CE.。Monthly_Report_kwargs)Email_Client=EmailClient()Email_Client。发送(DAILY_BILLING_REPORT=DAILY_REPORT，MOUNTAL_</p><p>既然我们已经在本地生成了账单报告，我们将利用无服务器框架使用AWS Lambda创建无服务器管道。</p><p>Serverless-python-requirements插件自动捆绑Requirements.txt中的依赖项，并使它们可用于Lambda函数。</p><p>服务：无服务器成本警报插件：-serverless-python-Requirements Package：excludeDevDependency：true exclude：-node_module/**custom：pythonRequirements：slm：true strie：false slimPatternsAppendDefaults：true slimPatterns：-&#34；**/*.Egg-info*&#34；-&#34；**/*.dist-info*&#34；DockerizePip：true Provider：Name：AWS运行时：python3.7阶段：dev Region：us-west-2 iamRoleStatements：-Effect：Allow Action：-ses：SendEmail Resource：-&#34；*&#34；-Effect：Allow Action：-ce：GetCostAndUsage Resource：-&#34；*&#34；Functions：Send_Daily_Cost_Report：Handler.Generate_Report Events：-http：Get hello。</p><p>Lambda函数将有权查询成本资源管理器中的CostAndUsage函数和SES中的SendEmail。</p><p>在将Lambda函数部署到AWS之前，我们需要更新Lambda函数，以便它可以响应HTTP请求。使用以下代码片段更新handler.py的内容：</p><p>从app.ost_explorer导入CostExplorer从app.email导入EmailClient def GENERATE_REPORT(event，context)：ce=CostExplorer()Daily_report=ce。生成报告(CE.。Daily_report_kwargs)Monthly_Report=ce。生成报告(CE.。Monthly_Report_kwargs)Email_Client=EmailClient()Email_Client。发送(Daily_Billing_Report=Daily_Report，Monthly_Billing_Report=Monthly_Report)return{&#34；statusCode&#34；：200，&#34；Header&#34；：{&#34；Content-Type&#34；：&#34；Application/json&#34；，}，&#34；Body&#34；：&#34；Success&#34；，}。</p><p>现在，我们将Lambda功能部署到AWS。在您的终端中运行以下命令：</p><p>如果部署成功，您应该能够看到Lambda的HTTP端点，如下所示：</p><p>最后，我们将更新Lambda函数，使其作为预定的cron而不是HTTP端点运行。我们将把Lambda函数设置为每天运行一次。</p><p>功能：SEND_DAILY_COST_REPORT：#HANDLER：handler.Generate_Report#events：#-http：GET hello HANDLER：HANDLER。GENERATE_REPORT事件：-Schedule：Cron(0 9**？*)。</p><p>在过去的几周里，我一直在使用这个设置，它对保持我的AWS账单非常有用，而不必担心频繁检查控制台。Cost Explorer API有很多不同的报告选项，您可以生成适合您的报告。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.learnaws.org/2020/10/17/how-to-create-billing-alerts/">https://www.learnaws.org/2020/10/17/how-to-create-billing-alerts/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/自动/">#自动</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/automated/">#automated</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/report/">#report</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1027169.html"><img src="http://img2.diglog.com/img/2020/9/thumb_e213fa00f3bb0f8a7061ed1d9b1300c7.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1027169.html">优步是如何在自动驾驶汽车上浪费25亿美元的</a></div><span class="my_story_list_date">2020-9-30 7:18</span></div><div class="col-sm"><div><a target="_blank" href="/story/1023719.html"><img src="http://img2.diglog.com/img/2020/9/thumb_71aeb37fe83459181458a11dae6d15bd.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1023719.html">具有自动内容提取功能的Web Clipper浏览器扩展，现已开源</a></div><span class="my_story_list_date">2020-9-14 0:10</span></div><div class="col-sm"><div><a target="_blank" href="/story/1023063.html"><img src="http://img2.diglog.com/img/2020/9/thumb_5b65ab46bc36b7837cdbdcf169baa3bf.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1023063.html">F.lux自动调整您的计算机照明以匹配您的环境</a></div><span class="my_story_list_date">2020-9-10 4:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1021547.html"><img src="http://img2.diglog.com/img/2020/9/thumb_2e803e49a5033cfaabc79b52e9623939.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1021547.html">特斯拉缓慢的自动驾驶进展继续绿灯警告</a></div><span class="my_story_list_date">2020-9-1 8:39</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>