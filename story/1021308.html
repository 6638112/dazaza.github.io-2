<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我在围棋的上下文包中犯了一个有趣的错误</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">我在围棋的上下文包中犯了一个有趣的错误</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-31 00:03:11</div><div class="page_narrow text-break page_content"><p>今天，戴夫·切尼在推特上又做了一个围棋突击测试，他问下面的代码是否打印了-6，0，&lt；nil&gt；；&#39；或者：</p><p>Import(&#34；context&#34；&#34；fmt&#34；)func f(CTX context.Context){context.WithValue(ctx，&#34；foo&#34；，-6)}func main(){ctx：=context.TODO()f(Ctx)fmt.Println(ctx.Value(&#34；foo&#34；))}。</p><p>我关注的是将字符串用作上下文键，部分原因是我使用Python等语言的经验。首先，contextpackage的文档中写道：</p><p>提供的键必须是可比较的，并且不应该是字符串类型或任何其他内置类型，以避免使用上下文的包之间的冲突。WithValue的用户应该为键定义他们自己的类型。[...]。</p><p>像Python这样的语言中的一个传统问题是，两个字符串可能会比较相同，但实际上并不是相同的东西，而且一些代码确实希望您用完全相同的东西来表示它。但是，上下文包并不要求您使用完全相同的键来表示它，只需要使用键的接口值比较相同的键即可。</p><p>(因为上下文比较接口值，所以值和类型都必须匹配；仅让两个值具有相同的底层具体类型(例如字符串)并进行相同的比较是不够的。这就是为什么定义自己的字符串类型是避免包之间冲突的可靠方法。)。</p><p>所以在我看完所有这些之后，我自信地回答说，这个代码打印了-6。设置该值时使用的字符串不一定与检索该值时使用的字符串相同，但这无关紧要。(#34；foo&34；string=#34；foo&34；string)，但这并不重要。然而，这不是代码的问题所在。实际问题是context.WithValue()返回一个设置了值的新上下文，它不会更改它调用的上下文。Dave Cheney的代码就好像.WithValue()改变了当前上下文一样，因为f()忽略了.WithValue()提供的新上下文，并且不向main()返回任何内容。因为原来的context_in main()是调用.value()的，所以它没有&#34；foo&34；键，结果实际上是&#39；&lt；nil&gt；&#39；。</p><p>代码的这个问题实际上是一个相当有趣的错误，因为就我目前所知，通常的Go样式检查器都没有检测到它。这段代码通过了审核，它不会产生来自errcheck的抱怨，因为我们没有忽略错误返回值，而golangci-lint这样的工具只会抱怨使用内置类型字符串作为.WithValue()中的键。似乎没有注意到我们忽略了来自.WithValue()的关键返回值，这使得它或多或少变成了一个不可操作的东西。</p><p>(现在戴夫·切尼已经把这个问题公诸于众了，我怀疑会有人给Staticcheck提供一张支票，因为Staticcheck已经使用内置类型作为关键问题检测到了这个问题。)</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://utcc.utoronto.ca/~cks/space/blog/programming/GoContextValueMistake">https://utcc.utoronto.ca/~cks/space/blog/programming/GoContextValueMistake</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/上下文/">#上下文</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/mistake/">#mistake</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>