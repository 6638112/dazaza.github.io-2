<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>65C02板卡计算机上的PS/2键盘</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">65C02板卡计算机上的PS/2键盘</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-12 10:28:04</div><div class="page_narrow text-break page_content"><p>我一直在关注本·埃特(Ben Eater)关于在面包板上建造一台6502计算机的系列文章。当我通过使用更大的4线x 20字符LCD显示器获得65C22后，我想知道是否可以直接将计算机与外部键盘接口。IBM Personal System/2(PS/2)于1987年发布，它有一个非常常用的键盘和鼠标连接器，它使用一些方便的电信号来与更古老的技术接口，比如这台板式计算机所基于的WDC 65C02和65C22。</p><p>电学上，PS/2非常简单：电源、地、时钟和数据。时钟由键盘内部的微控制器驱动，速率约为10-16.7 kHz。数据线在时钟较低时有效，数据和时钟都是开路收集器，可以通过上拉电阻直接与计算机相连。</p><p>我买了一个PS/2连接器，并将四根电线焊接到正确的引脚上。电源+5V，接地0V，键盘的三个状态灯闪烁，所以我知道我没有短路或向后安装引脚。那很好。</p><p>我把PS/2时钟线连接到NmiB(DIP-40 W65C02S上的第6针)，并用1kΩ上拉电阻把它绑在5V导轨上，因为我无论如何都是在做硬件更改，所以我也给IRQB(W65C02S的第4针)增加了一个按钮，以便更容易地触发第二类中断。(它在调试时很有帮助-在interruptservice处理程序中，我可以打印任何我想要的信息。)。</p><p>同样，数据线也通过1kΩ上拉电阻连接到PA0(40针W65C22的引脚2)。</p><p>6502上的两个中断引脚的使用略有不同，不可屏蔽中断(NMIB)是边缘触发的，这通常意味着只有一个中断源可以使用它。但这对PS/2来说很好，因为我们只想在每个时钟信号上中断一次。</p><p>中断请求(IRQB)是电平触发的：只要中断被启用并且输入较低，处理器就会生成中断。这意味着服务多个设备要容易得多，但是必须有某种方法来清除另一端的中断-而且我们在PS/2总线上实际上没有这种能力，所以这不是一个好的选择，除非我们想要添加一些粘合逻辑。听起来很贵，而且我的面包板上也没有多少空位了。</p><p>WDC65C02S支持一些额外的操作码，所以我将使用-wdc02标志让vasm理解这些操作码。我还添加了-chklabels、-wail和-x。它们分别在标签与助记符/指令匹配时发出警告，在警告时返回错误代码，在引用未定义符号时显示错误。</p><p>为它们中的每一个设置矢量-这将替换Ben Eater视频中的.org$fffc：</p><p>现在，是时候声明和初始化一些内存了。首先，在零页中命名四个字节：</p><p>实际值并不重要-它们是指向RAM的前256B中字节的指针。</p><p>前两个KEY_BUF_X和KEY_READ_X是256字节循环数组的偏移量。让我们将该数组命名为：</p><p>后两个变量用于解码PS/2字节。现在，让我们在重置处理程序中将它们全部初始化为零。</p><p>所有这些都不起作用，但是我们已经在RAM中保留了解码原始PS/2字节流所需的所有空间。</p><p>如前所述，PS/2时钟速率在10-16.7 kHz之间，数据线仅在时钟周期的下半部分有效。</p><p>我的计算机有1 MHz时钟，这意味着我们有1M/16.7k=59.88个周期来完全处理NMI。而且数据只在上半年有效。</p><p>WDC65C02需要6(或7？)。周期来处理中断，并且只有在前一条指令完成后才能处理中断，所以当我们开始中断处理程序的第一条指令时，我们可能已经进入了12或13个周期！</p><p>我们将从65C22 VIA读取端口，并且需要使用一些位掩码来获取第一位。如果设置高位而不是低位会非常方便，但是我已经在使用PA7作为LCD上的E引脚了，我不想仅仅为了方便而破坏与Ben代码的兼容性。</p><p>因此，在中断例程期间，我会将PA0旋转到PA7位置，然后将其屏蔽。</p><p>NMI：PHA；保留A寄存器LDA端口；数据位在A错误的低位；数据位在进位标志错误；数据位在A的高位和#KEY_DATA；所有其他位已被清除；将A存储在KEY_BUF[KEY_BUF_X]phx LDX KEY_BUF_X STA KEY_BUF，x INC KEY_BUF_X；按正确的顺序PLX PLA恢复X，A；完成中断RTBUF[KEY_BUF_X]phx LDX KEY_BUF_X sta KEY_BUF_X。</p><p>解码PS/2比特流所需的周期比我们在不可屏蔽中断处理程序中所能承受的多几个周期。因此，处理程序是浪费的，并且将位样本作为字节写入256字节的循环缓冲区中。</p><p>第一位(状态0)是起始位，其后是8个数据位(状态1-8)，最低有效优先，然后是奇偶校验位(状态9)，然后是停止位(状态10)。</p><p>LOOP：PS2_CHECK_BIT：LDA KEY_READ_X CMP KEY_BUF_X beq LOOP PROCESS_ONE_PS2_BIT：LDA PS2_BIT_NUMBER CMP#0 beq PS2_START_BIT CMP#9 beq PS2_Parity_Bit CMP#10 beq PS2_STOP_BIT；否则，转到PS2_DATA_BIT PS2_DATA_BIT：；将$80/$00移入PS2_NEXT_BYTE LDX KEY_READ_X LDA PS2_NEXT_BUF和#$7F ora KEY_BUF，x sta PS2_NEXT_BYTE NEXT_PS2_BIT：；推进状态机INC PS2_BIT_NUMBER；推进读取位指针INC KEY_READ_X；检查是否有更多位要解码JMP PS2_CHECK_BIT PS2_START_BIT：；TODO：我们可以。TODO：我们可以验证奇偶校验位是否正确JMP NEXT_PS2_BIT PS2_STOP_BIT：LDA PS2_NEXT_BYTE；TODO：我们可以验证停止位是否正确；TODO：我们已成功将PS/2字节解码到A寄存器。STZ PS2_BIT_NUMBER INC KEY_READ_X；给主循环(当前为空)一个运行JMP循环的机会。</p><p>PS/2不发送ASCII，它发送扫描码。大多数PS/2键盘使用“SET 2”代码。我们关注的字符在按下键时发送一个单字节的“make”代码(按住键时每秒发送几次)，在释放键时发送一个两字节的“Break”代码。</p><p>一个很好的抽象方法是将这些扫描码解码到一个缓冲区中，这样我们就可以进行行编辑等操作，但我只会将我识别的所有字符直接打印到LCD上。</p><p>首先，我们需要创建PS/2扫描码的映射。你可以看看键盘上的按键矩阵是如何连线的。</p><p>。对齐8 PS2_SCAN_CODE：；0123456789ABCDEF。ASC&#34；？`？&#34；；0。ASC&#34；？Q1？ZSAW2？&#34；；1.。ASC&#34；？CXDE43？？VFTR5？&#34；；2.。ASC&#34；？NBHGY6？MJU78？&#34；；3.。ASC&#34；？，KIO09？？./L；P-？&#34；；4.。ASC&#34；？？&#39；？？[=？]？\？？&#34；；5。</p><p>PRINT_PS2_KEY：；如果我们之前收到#$F0，则忽略此字节位PS2_IGNORE_NEXT_CODE BMI CODE_IGNORED；A为扫描码。；查看是否有中断代码CMP#$F0 beq IGNORE_NEXT；边界检查PS2_SCAN_CODES CMP#$5F BPL TOO_HIGH；索引到PS2_SCAN_CODES Tax LDA PS2_SCAN_CODES，x JSR PRINT_CHAR RTS TOH_HIGH：RTS IGNORE_NEXT：LDA#$FF ps2_IGNORE_NEXT_CODE RTS CODE_IGNORED：STZ PS2_IGNORE_NEXT_CODE RTS。</p><p>还有更多的工作要做，比如Shift、Backspace、箭头键，甚至将行输出到屏幕上的正确位置。就像我上面提到的，将这些ASCII码存储在行缓冲区或任何适合您的应用程序用途的地方可能更有意义，您甚至可以使用另一个循环缓冲区来跟踪指针。</p><p>但是，嘿，至少我们可以说你好，世界，这才是最重要的。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://jacob.jkrall.net/ps2-on-65c02">https://jacob.jkrall.net/ps2-on-65c02</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/键盘/">#键盘</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/板卡/">#板卡</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ps2/">#ps2</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1010679.html"><img src="http://img.diglog.com/img/2020/7/thumb_0ac1d2add4518fa23fa929b28ea3888f.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1010679.html">JKLP：一种36键人体工学键盘</a></div><span class="my_story_list_date">2020-7-9 8:28</span></div><div class="col-sm"><div><a target="_blank" href="/story/1010115.html"><img src="http://img.diglog.com/img/2020/7/thumb_1e394671127f41c1824f89be5a0d297e.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1010115.html">M60-开源USB和BLE，Python驱动的热插拔机械键盘</a></div><span class="my_story_list_date">2020-7-6 22:4</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008812.html"><img src="http://img.diglog.com/img/2020/6/thumb_edcdfb6713b923f5fcbeeb3b6e588503.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008812.html">准将SX-64键盘修复</a></div><span class="my_story_list_date">2020-6-29 10:5</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008002.html"><img src="http://img.diglog.com/img/2020/6/thumb_47b51fe9d75501f2aa54ffb53cec1433.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008002.html">35美元的儿童键盘让我变成了小说家</a></div><span class="my_story_list_date">2020-6-25 2:19</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>