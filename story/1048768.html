<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>如何在运行时模拟I / O故障 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">如何在运行时模拟I / O故障 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-02-21 10:07:44</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/2/6479fafe357d1d15eec89c6d6ccf70eb.jpg"><img src="http://img2.diglog.com/img/2021/2/6479fafe357d1d15eec89c6d6ccf70eb.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>在生产环境中，由于各种事件（例如磁盘故障和管理员错误），可能会发生文件系统故障。作为Chaos Engineering平台，Chaos Mesh自其早期版本以来就一直支持在文件系统中模拟I / O故障。通过简单地添加IOChaos CustomResourceDefinition（CRD），我们可以观察文件系统如何失败并返回错误。</p><p> 但是，在Chaos Mesh 1.0之前，该实验并不容易，并且可能消耗了大量资源。我们需要通过变异的接纳网络钩子将边车容器注入Pod，并重写ENTRYPOINT命令。即使未注入故障，注入的侧车集装箱也会造成大量开销。</p><p> Chaos Mesh 1.0改变了这一切。现在，我们可以使用IOChaos在运行时将错误注入文件系统。这简化了过程并大大减少了系统开销。这篇博客文章介绍了如何在不使用辅助工具的情况下实施IOChaos实验。</p><p>  为了在运行时模拟I / O错误，我们需要在程序开始系统调用（例如读取和写入）之后但在调用请求到达目标文件系统之前，将错误注入文件系统中。我们可以通过以下两种方式之一来做到这一点：</p><p> 在目标文件系统之前添加一个称为ChaosFS的文件系统层。 ChaosFS使用目标文件系统作为后端，并从操作系统接收请求。整个调用链接是目标程序syscall-> Linux内核-＆gt; ChaosFS-＆gt;目标文件系统。因为ChaosFS是可定制的，所以我们可以根据需要注入延迟和错误。因此，ChaosFS是我们的选择。</p><p>  如果ChaosFS在目标文件系统中读写文件，则需要将ChaosFS挂载到与Pod配置中指定的目标路径不同的路径。 ChaosFS无法安装到目标目录的路径。</p><p> 我们需要在目标程序开始运行之前挂载ChaosFS。这是因为新安装的ChaosFS仅对目标文件系统中的程序新打开的文件有效。 </p><p>我们需要将ChaosFS挂载到目标容器的mnt名称空间。有关详细信息，请参见mount_namespaces（7）-Linux手册页。</p><p> 在Chaos Mesh 1.0之前，我们使用了变异接纳Webhook来实现IOChaos。该技术解决了上面列出的三个问题，并允许我们：</p><p> 在目标容器中运行脚本。该操作更改了ChaosFS后端文件系统的目标目录（例如，从/ mnt / a更改为/ mnt / a_bak），以便我们可以将ChaosFS挂载到目标路径（/ mnt / a）。启动Pod。例如，我们可以将原始命令/ app修改为/waitfs.sh / app。</p><p> waitfs.sh脚本一直在检查文件系统是否已成功安装。如果已安装，则/ app已启动。</p><p> 在Pod中添加一个新容器以运行ChaosFS。该容器需要与目标容器（例如，/ mnt）共享一个卷，然后我们将该卷安装到目标目录（例如，/ mnt / a）。我们还为该卷的装载正确启用了装载传播，以将共享渗透到主机，然后将奴隶渗透到目标。</p><p> 这三种方法使我们可以在程序运行时注入I / O错误。但是，注入远非方便：</p><p> 我们只能将故障注入到卷子目录中，而不能注入到整个卷中。解决方法是将mv（重命名）替换为mount move以移动目标卷的安装点。 </p><p>我们必须在Pod中显式编写命令，而不是隐式使用image命令。否则，挂载文件系统后/waitfs.sh脚本将无法正确启动程序。</p><p> 相应的容器需要具有正确的配置以进行安装传播。由于潜在的隐私和安全问题，我们无法通过变异许可Webhook修改配置。</p><p> 注射配置很麻烦。更糟糕的是，在配置能够注入故障之后，我们不得不创建一个新的Pod。</p><p> 程序运行时，我们无法撤出ChaosFS。即使没有注入故障或错误，性能也会受到很大影响。</p><p>  在没有变异的入网钩的情况下如何破解这些顽强的坚果呢？让我们回过头来思考一下我们为什么使用变异接纳Webhook添加运行ChaosFS的容器的原因。我们这样做是为了将文件系统挂载到目标容器。</p><p> 实际上，还有另一种解决方案。除了将容器添加到Pod中之外，我们可以首先使用setns Linux系统调用来修改当前进程的名称空间，然后使用mount调用将ChaosFS挂载到目标容器。假设要注入的文件系统是/ mnt。新的注入过程如下：</p><p> 在当前进程中使用setns输入目标容器的mnt名称空间。 </p><p>该过程完成后，目标容器将通过ChaosFS打开，读取和写入/ mnt中的文件。这样，可以更轻松地注入延迟或故障。但是，仍然有两个问题要回答：</p><p> 假设在打开文件时我们无法卸载文件系统，您如何恢复该过程？</p><p>  ptrace解决了以上两个问题。我们可以使用ptrace在运行时替换打开的文件描述符（FD），并替换当前的工作目录（CWD）和mmap。</p><p>  ptrace是一个功能强大的工具，可使目标进程（跟踪）运行任何系统调用或二进制程序。为了使Tracee运行程序，ptrace修改了RIP指向目标进程的地址，并添加了int3指令来触发断点。当二进制程序停止时，我们需要恢复寄存器和内存。</p><p> 在x86_64体系结构中，RIP寄存器（也称为指令指针）始终指向运行下一条指令的内存地址。要将程序加载到目标进程的内存空间中：</p><p> 将二进制程序写入新分配的内存，并使RIP寄存器指向它。</p><p> 最佳实践是，我们经常用process_vm_writev替换ptrace POKE_TEXT写入，因为如果要写入的数据量很大，process_vm_writev的执行效率会更高。 </p><p>使用ptrace，我们可以创建一个进程来替换其自己的FD。现在，我们只需要一种方法即可进行替换。此方法是dup2系统调用。</p><p>  dup2函数的签名是int dup2（int oldfd，int newfd）;。它用于创建旧FD（oldfd）的副本。该副本的FD号为newfd。如果newfd已经对应于已打开文件的FD，则已打开文件上的FD将自动关闭。</p><p> 例如，当前进程打开FD为1的/ var / run / __ chaosfs__test __ / a。要用/ var / run / test / a替换此打开的文件，此过程将执行以下操作：</p><p> 使用fcntl系统调用获取/ var / run / __ chaosfs__test __ / a的OFlags（开放系统调用使用的参数，例如O_WRONLY）。</p><p>  使用open系统调用使用相同的OFlags打开/ var / run / test / a。假设FD为2。</p><p>  使用dup2（2，1）用新打开的FD 2替换/ var / run / __ chaosfs__test __ / a的FD 1。</p><p> 该过程完成后，当前过程的FD 1指向/ var / run / test / a。为了注入故障，对目标文件的所有后续操作都将通过用户空间中的文件系统（FUSE）。 FUSE是Unix和类似Unix的计算机操作系统的软件接口，它使非特权用户无需编辑内核代码即可创建自己的文件系统。 </p><p>ptrace和dup2的组合功能使跟踪程序可以使跟踪程序自己替换打开的FD。现在，我们需要编写一个二进制程序并使目标进程运行它：</p><p> 当目标进程使用克隆函数创建线程时，将传递CLONE_FILES参数。</p><p> 因此，Chaos Mesh仅替换线程组中第一个线程的FD。</p><p> 根据以上两节和syscall指令的用法编写一段汇编代码。这是汇编代码的示例。</p><p> 使用汇编程序将代码转换为二进制程序。我们使用dynasm-rs作为汇编器。</p><p> 使用ptrace使目标进程运行该程序。在程序运行时，将在运行时替换FD。</p><p>     在此图中，每条水平线对应于一条沿箭头方向延伸的螺纹。挂载/挂载文件系统和替换FD任务是按顺序精心安排的。考虑到上述过程，这种安排很有意义。 </p><p>我已经讨论了如何实现故障注入以在运行时模拟I / O故障（请参阅chaos-mesh / toda）。 但是，当前的实现还远远不够完美：  Chaos Mesh不会立即确定文件系统是否已成功安装。 仅在一秒钟后才这样做。  如果您对Chaos Mesh感兴趣并希望帮助我们改进它，欢迎您加入我们的Slack频道，或将拉取请求或问题提交到我们的GitHub存储库。  这是有关混沌网格实现系列的第一篇文章。 如果您想了解如何实现其他类型的故障注入，请继续关注。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://chaos-mesh.org/blog/how-to-simulate-io-faults-at-runtime/">https://chaos-mesh.org/blog/how-to-simulate-io-faults-at-runtime/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/模拟/">#模拟</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/faults/">#faults</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1048652.html"><img src="http://img2.diglog.com/img/2021/2/thumb_798ad98ec3877c1479c0e979c1f84284.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1048652.html">BTC残局 </a></div><span class="my_story_list_date">2021-2-21 7:46</span></div><div class="col-sm"><div><a target="_blank" href="/story/1038209.html"><img src="http://img2.diglog.com/img/2020/12/thumb_391784ea5c4f5e33c928538802b3e08e.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1038209.html">ESP8266上的模拟电视台 </a></div><span class="my_story_list_date">2020-12-7 19:3</span></div><div class="col-sm"><div><a target="_blank" href="/story/1038003.html"><img src="http://img2.diglog.com/img/2020/12/thumb_54170c7b87208396b2410f838de3120e.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1038003.html">我们生活在模拟中吗？ 机会约为50–50 </a></div><span class="my_story_list_date">2020-12-6 12:33</span></div><div class="col-sm"><div><a target="_blank" href="/story/1036504.html"><img src="http://img2.diglog.com/img/2020/11/thumb_cc96e9d8d26ca8bc3ad87b61614c997d.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1036504.html">计算机芯片可以模拟未来“比物理定律更快”</a></div><span class="my_story_list_date">2020-11-25 17:26</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>