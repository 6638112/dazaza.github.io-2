<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>TCP比看起来更难TCP is harder than it looks</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">TCP is harder than it looks<br/>TCP比看起来更难</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2022-02-21 08:54:23</div><div class="page_narrow text-break page_content"><p>In theory it&#39;s quite easy to write software that deals with TCP at thepacket level, whether it&#39;s a full TCP stack or just a packethandling application that needs to be TCP-aware. The main RFCs aren&#39;thorribly long or complicated, and specify things in great detail. Andwhile new extensions appear regularly, the option negotiation duringthe initial handshake ensures that you can pick and choose whichextensions to support. (Of course some of the extensions are in effectmandatory -- a TCP stack without support for selectiveacknowledgements or window scaling will be pretty miserable.) If all you want to do is to e.g. load the frontpage of Google, writinga TCP stack can be a one afternoon hack. And even with a larger scope,if all you need to do is to connect to arbitrary machines runningvanilla Linux, BSD, or Windows on the same internal network, you canfairly quickly validate both interoperability and performance.  But since TCP looks so easy to implement, there are a lot ofimplementations around. Some full TCP stacks, some TCP manglingmiddleboxes, and some that are simply trying to track the state of TCPconnections such as firewalls. At  work our TCP stack doesn&#39;tjust need to interoperate with just a limited number of top operatingsystems. We handle hundreds of terabytes of traffic every day,with a traffic mix that&#39;s not really under our control. In practiceit&#39;s completely arbitrary traffic, dealing with any device that couldpossibly get connected to a cellular network or any device that mighthave a public IP. Under those circumstances you basically have to bebug-compatible with everything. There&#39;s some well established folklore about which areas tend to bebuggy in other systems, and that you thus need to be particularlycareful with. For example TCP option ordering and alignment is acommon source of such problems, to the extent that at some point youmight as well just use the same exact option placement as  Linuxor Windows, on the assumption that even the sloppiest firewall vendorwill have tested at least against those systems! Zero windows are another frequent source of grief, to such lengthsthat at multiple mobile operators the technical staff have quizzed usextensively on our use of zero windows. I don&#39;t quite know why zerowindows have that reputation, but we have definitely seen that classof problems in the wild occasionally (for example the  FreeBSD problemfrom a few years back was very annoying). But here&#39;s a new one we saw recently, which was good for an afternoonof puzzling and is a case that I hadn&#39;t heard any scary stories about.A customer reported failures for a certain website when using our TCPimplementation, but a success when using a standard one. Notconsistently though, there were multiple different failure / succcesscases. Sometimes we were seeing connections hanging right after thehandshake; the SYNACK would have no options at all set (a big redflag), advertised a zero window, and the server would never reply toany zero window probes or otherwise open any window space: 19:53:40.384444 IP 10.0.1.110.34098 &gt; x.x.x.x.443: Flags [S], seq 2054608140, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 019:53:40.779236 IP x.x.x.x.443 &gt; 10.0.1.110.34098: Flags [S.], seq 3403190647, ack 2054608141, win 0, length 019:53:40.885177 IP 10.0.1.110.34098 &gt; x.x.x.x.443: Flags [S], seq 2054608140, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 019:53:41.189576 IP 10.0.1.110.34098 &gt; x.x.x.x.443: Flags [.], ack 1, win 29200, length 019:53:41.189576 IP 10.0.1.110.34098 &gt; x.x.x.x.443: Flags [.], ack 1, win 29200, length 019:53:42.189892 IP 10.0.1.110.34098 &gt; x.x.x.x.443: Flags [.], ack 1, win 64000, length 019:53:43.391186 IP 10.0.1.110.34098 &gt; x.x.x.x.443: Flags [.], ack 1, win 64000, length 019:53:44.832112 IP 10.0.1.110.34098 &gt; x.x.x.x.443: Flags [.], ack 1, win 64000, length 0</p><p>理论上是&#39；它很容易编写在包级别处理TCP的软件，无论是&#39；它是一个完整的TCP堆栈，或者只是一个需要TCP感知的包处理应用程序。主要的RFC有&#39；非常长或者非常复杂，并且非常详细地描述事物。虽然新的扩展经常出现，但在初始握手期间的选项协商确保您可以选择支持哪些扩展。（当然，一些扩展实际上是强制性的——不支持选择性确认或窗口缩放的TCP堆栈将非常糟糕。）如果你想做的只是加载谷歌的frontpage，那么编写一个TCP堆栈可能是一个下午的黑客攻击。即使范围更大，如果只需要连接到同一内部网络上运行Linux、BSD或Windows的任意机器，也可以相当快地验证互操作性和性能。但由于TCP看起来很容易实现，所以有很多实现。一些完整的TCP堆栈，一些TCP管理中间盒，还有一些只是试图跟踪TCP连接（如防火墙）的状态。在工作中，我们的TCP堆栈没有&#39；t只需要与数量有限的顶级操作系统进行互操作。我们每天处理数百TB的流量，流量组合为&#39；它不在我们的控制之下。在实践中&#39；它是完全任意的流量，处理任何可能连接到蜂窝网络的设备或任何可能具有公共IP的设备。在这种情况下，你基本上必须与一切兼容。那里&#39；这是一些公认的民间传说，关于哪些区域在其他系统中容易出现故障，因此你需要特别注意。例如，TCP选项排序和对齐是此类问题的常见来源，在某种程度上，你也可以使用与Linuxor Windows相同的选项位置，前提是即使是最邋遢的防火墙供应商也至少已经针对这些系统进行了测试！Zero windows是另一个经常令人悲伤的来源，它的长度如此之长，以至于在多家移动运营商中，技术人员对我们使用Zero windows进行了大量有用的测试。我不&#39；我不太清楚为什么zerowindows会有这样的名声，但我们肯定偶尔会在野外看到这类问题（例如，几年前的FreeBSD问题非常恼人）。但在这里&#39；这是我们最近看到的一个新的例子，对于一个令人困惑的下午来说很好，这是一个我没有看到的例子&#39；我没听说过任何关于他的恐怖故事。一位客户报告说，在使用我们的TCP实施时，某个网站出现故障，但在使用标准实施时，该网站成功。尽管如此，还是有多个不同的失败/成功案例。有时，我们看到握手之后，联系就挂了；SYNACK将完全没有选项设置（一个大红旗），通告零窗口，服务器将永远不会回复任何零窗口探测或以其他方式打开任何窗口空间：19:53:40.384444 IP 10.0.1.110.34098&gt；x、 x.x.x.443:Flags[S]，seq 2054608140，win 29200，选项[mss 1460，nop，nop，sackOK，nop，wscale 7]，长度019:53:40.779236 IP x.x.x.443&gt；10.0.1.110.34098:Flags[S.]，seq 3403190647，ack 2054608141，win 0，length 019:53:40.885177 IP 10.0.1.110.34098&gt；x、 x.x.x.443:Flags[S]，seq 2054608140，win 29200，选项[mss 1460，nop，nop，sackOK，nop，wscale 7]，长度019:53:41.189576 IP 10.0.1.110.34098&gt；x、 x.x.x.443：旗帜[.]，ack 1，win 29200，长度019:53:41.189576 IP 10.0.1.110.34098&gt；x、 x.x.x.443：旗帜[.]，ack 1，win 29200，长度019:53:42.189892 IP 10.0.1.110.34098&gt；x、 x.x.x.443：旗帜[.]，ack 1，win 64000，长度019:53:43.391186 IP 10.0.1.110.34098&gt；x、 x.x.x.443：旗帜[.]，ack 1，win 64000，长度019:53:44.832112 IP 10.0.1.110.34098&gt；x、 x.x.x.443：旗帜[.]，确认1，赢64000，长度0</p><p>Other times the SYNACK would be a lot more reasonable looking, and theconnection would work fine: 19:29:16.457114 IP 10.0.1.110.33842 &gt; x.x.x.x.443: Flags [S], seq 1336309505, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 019:29:17.264497 IP x.x.x.x.443 &gt; 10.0.1.110.33842: Flags [S.], seq 2619514903, ack 1336309506, win 14600, options [mss 1460,nop,nop,sackOK,nop,wscale 6], length 019:29:17.264556 IP 10.0.1.110.33842 &gt; x.x.x.x.443: Flags [.], ack 1, win 229, length 019:29:17.265665 IP 10.0.1.110.33842 &gt; x.x.x.x.443: Flags [P.], seq 1:305, ack 1, win 229, length 30419:29:18.059278 IP x.x.x.x.443 &gt; 10.0.1.110.33842: Flags [.], ack 305, win 995, length 019:29:18.087425 IP x.x.x.x.443 &gt; 10.0.1.110.33842: Flags [.], seq 1:1461, ack 305, win 1000, length 1460</p><p>其他时候，SYNACK的外观会更加合理，连接也会正常工作：19:29:16.457114 IP 10.0.1.110.33842&gt；x、 x.x.x.443:Flags[S]，seq 1336309505，win 29200，选项[mss 1460，nop，nop，sackOK，nop，wscale 7]，长度019:29:17.26447 IP x.x.x.443&gt；10.0.1.110.33842:Flags[S.]，seq 2619514903，ack 1336309506，win 14600，选项[mss 1460，nop，nop，sackOK，nop，wscale 6]，长度019:29:17.264556 IP 10.0.1.110.33842&gt；x、 x.x.x.443：旗帜[.]，ack 1，win 229，长度019:29:17.265665 IP 10.0.1.110.33842&gt；x、 x.x.x.443:Flags[P]，seq 1:305，ack 1，win 229，长度30419:29:18.059278 IP x.x.x.x.443&gt；10.0.1.110.33842：旗帜[.]，ack 305，win 995，长度019:29:18.087425 IP x.x.x.443&gt；10.0.1.110.33842：旗帜[.]，序列1:1461，确认305，赢1000，长度1460</p><p>And there were also occasions where we&#39;d get back two SYNACKs withdifferent sequence numbers, which of course didn&#39;t always work toowell: 19:37:41.677890 IP 10.0.1.110.33933 &gt; x.x.x.x.443: Flags [S], seq 2689636737, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 019:37:41.877046 IP 10.0.1.110.33933 &gt; x.x.x.x.443: Flags [S], seq 2689636737, win 29200, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 019:37:42.076611 IP x.x.x.x.443 &gt; 10.0.1.110.33933: Flags [S.], seq 3107565270, ack 2689636738, win 0, length 019:37:42.275471 IP x.x.x.x.443 &gt; 10.0.1.110.33933: Flags [S.], seq 3109157454, ack 2689636738, win 0, length 0</p><p>还有一些时候我们&#39；d返回两个序列号不同的synack，当然没有&#39；t总是工作得很好：19:37:41.677890 IP 10.0.1.110.33933&gt；x、 x.x.x.443:Flags[S]，seq 2689636737，win 29200，选项[mss 1460，nop，nop，sackOK，nop，wscale 7]，长度019:37:41.877046 IP 10.0.1.110.33933&gt；x、 x.x.x.443:Flags[S]，seq 2689636737，win 29200，选项[mss 1460，nop，nop，sackOK，nop，wscale 7]，长度019:37:42.076611 IP x.x.x.443&gt；10.0.1.110.33933:Flags[S]，seq 3107565270，ack 2689636738，win 0，长度019:37:42.275471 IP x.x.x.443&gt；10.0.1.110.33933：旗帜[S]，序列3109157454，确认2689636738，胜利0，长度0</p><p> You might be able to guess the problem just from the above traces, butactually verifying it required quite a few attempts with slightlytweaked parameters to find the boundary conditions. Who knew thatthere are systems around that can&#39;t handle receiving a duplicate SYN?The three different behaviors seem to correspond with no SYN beingretransmitted, the retransmission arriving to the middlebox before itemits a SYNACK, and the retransmission arriving after the middlebox hasemitted a SYNACK. The middlebox was located in Australia, but most likely that IP was justa loadbalancer, transparent reverse proxy, or some similar form oftraffic redirection with a real final destination somewhere in theUS. When being accessed from Europe, this resulted in an aggregate RTTof something like 450-550ms. Our TCP implementation has a variablebase SYN retransmit timout, and in this case it was roughly 500ms. Somost of the time the page load would fail with our TCP stack, butsucceed with an off the shelf one that had a SYN retransmit timeout of1 second. (I said above that I had not heard any scary stories on this, whichof course does not mean those scary stories don&#39;t exist. After figuringout the root cause, it was easy enough to find more reports of connectionbreakage due to SYN retransmits, for example  this one involvingsatellites). It&#39;s easy to see how the developers of that unidentified piece oftraffic redirecting kit missed a bug in this bit offunctionality. Outside of 2G cellular connections, satellitescommunications, or networks suffering from extreme buffer bloat, it&#39;srare to see RTTs that are long enough to trigger a SYN retransmit.Heck, in this case we were most likely talking of the packets goinground the world the long way around. But from my point of view this is a particularly annoying bug. Itis by definition triggered before we have any information at all onthe other end of the connection, so there&#39;s no possible heuristic wecould use to conditionally disable the offending feature just forhosts that are at risk. The options are either to tell a customer thatsome traffic won&#39;t work (which is normally unacceptable, even if theroot cause is undeniably on the other end), or to water down a usefulfeature a little bit to at least fail no more often than the&#34;competition&#34; does. And it&#39;s the slowly aggregating pile of cases like this that makesdealing with TCP hard in practice, no matter how simple it looks tostart with.</p><p>你可能仅仅从上面的轨迹就能猜到问题，但实际上验证它需要多次尝试，并稍微调整参数，才能找到边界条件。谁知道周围有系统可以&#39；无法处理接收重复的SYN？这三种不同的行为似乎与未重新传输SYN、在项目发出SYNACK之前到达中间盒的重新传输以及在中间盒发出SYNACK之后到达的重新传输相对应。中间包位于澳大利亚，但最有可能的是，IP只是一个负载平衡器、透明的反向代理，或某种类似形式的流量重定向，其真正的最终目的地位于美国某地。从欧洲访问时，这导致RTTof总量约为450-550ms。我们的TCP实现有一个可变的BASE SYN重新传输timout，在本例中大约是500毫秒。大多数情况下，我们的TCP堆栈会导致页面加载失败，但如果是一个现成的堆栈，其SYN重新传输超时为1秒，页面加载就会成功。（我在上面说过，我没有听过任何关于这方面的可怕故事，当然这并不意味着那些可怕的故事不存在。在找出根本原因后，很容易找到更多关于SYN重新传输导致连接中断的报告，例如这篇涉及卫星的报道）。它&#39；It’很容易看出，这一未知的流量重定向工具包的开发人员在这一点的功能中漏掉了一个bug。除了2G蜂窝连接、卫星通信或遭受极端缓冲区膨胀的网络之外，它&#39；SRT可以看到足够长的RTT来触发SYN重传。见鬼，在这种情况下，我们最有可能谈论的是环绕世界的包裹。但在我看来，这是一个特别恼人的错误。从定义上讲，它是在我们在连接的另一端获得任何信息之前触发的，因此&#39；我们不可能仅针对处于风险中的主机有条件地禁用有问题的功能。选项是要么告诉客户一些流量赢了&#39；t工作（这通常是不可接受的，即使根本原因不可否认是在另一端），或者稍微淡化一个有用的功能，至少不比&#34；竞争&#34；做它&#39；这是一堆慢慢累积起来的案例，这使得在实践中很难处理TCP，无论它看起来有多简单。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/tcp/">#tcp</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>