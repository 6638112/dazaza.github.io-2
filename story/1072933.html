<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>将Go分析与跟踪连接起来</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">将Go分析与跟踪连接起来</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2022-02-13 18:48:42</div><div class="page_narrow text-break page_content"><p>发布：今天，我想就我们最近在Datadog上发布的一些新的评测功能分享一些想法。我将解释他们做什么，如何工作，以及哪些Go 1.18捐款是为了让事情顺利进行。</p><p>让我们从最终结果开始。假设您有一个100毫秒的跟踪，其中10毫秒用于数据库查询，但90毫秒仍然无法解释。</p><p>发生这种情况时，通常需要研究代码以寻找线索。你忘了一些追踪仪器了吗？是时候添加、重新部署并等待了。或者你需要优化你的围棋代码？如果是，怎么做？</p><p>这个工作流程是可管理的，但事实证明有更好的方法——我们可以使用分析数据来填补空白。这正是我们新的代码热点功能所做的。如下所示，我们的请求占用了90毫秒的CPU时间。这是一个很强的信号，可以让我们排除非CPU活动，如未指令的服务调用、互斥冲突、通道等待、睡眠等。</p><p>更棒的是，当点击“查看配置文件”按钮时，我们可以在CPU时间上查看每个请求的火焰图。这里我们可以看到，我们的时间都花在了JSON编码上。</p><p>由于我们的HTTP处理函数没有出现在堆栈跟踪中，我们还可以间接推断，这项工作是在处理请求的goroutine生成的后台goroutine中完成的。</p><p>除了使用概要文件分解跟踪信息外，我们还可以做相反的事情，按端点分解概要文件的CPU时间，如下所示。复选框可用于按端点过滤配置文件。</p><p>为了更容易理解随时间的变化，例如部署后，我们可以将这些数据绘制成图表。</p><p>这些功能建立在一个名为pprof标签的现有Go功能之上，该功能允许我们将任意键/值对附加到当前运行的goroutine。当生成新的goroutine时，这些标签会自动继承，因此它们会覆盖到代码的所有角落。关键的是，这些标签也集成到了CPU档案器中，因此它们会自动出现在它生成的CPU档案中。</p><p>因此，为了实现这个功能，我们修改了dd trace go库中的跟踪代码，以便在创建新的span时自动应用诸如span id和端点之类的标签。此外，当跨度完成时，我们会注意移除标签。这种实现的简化示例如下所示：</p><p>func StartSpan（ctx context.context，端点字符串）*span{span:=&span{id:rand.Uint64（），restoreCX:ctx}标签：=pprof。标签（&#34；span#u id&#34；，fmt.Sprintf（&#34；%d&#34；，span.id），&#34；终点&#34；，终点，）pprof。SetGoroutineLabels（pprof.WithLabels（ctx，labels））返回span}type span结构{id uint64 restoreCtx context.context}func（s*span）Finish（）{pprof.SetGoroutineLabels（s.restoreCtx）}</p><p>我们的实际实现稍微复杂一些，还降低了泄露PII（个人身份信息）的风险。它会自动覆盖contrib包中的HTTP和gRPC包装，以及应用程序可能实现的任何自定义跟踪。</p><p>一旦我们的后端接收到跟踪和分析信息，我们就能够执行为本文前面展示的功能提供动力所需的查找。</p><p>作为实现这些新特性的一部分，我们做了很多测试，包括单元测试、微观基准测试、宏观基准测试等等。正如所料，这在我们的代码中暴露了问题，并允许我们快速修复它们。</p><p>稍微出乎意料的是，我们还在Go运行时中发现了几个问题，这些问题影响了pprof标签的准确性，以及总体上的CPU配置。好消息是，在社区的帮助下，Go维护人员和我们这边的贡献——所有这些问题都在即将发布的Go 1.18版本中得到了解决。</p><p>如果您对这方面的全部细节感兴趣，请查看附带的帖子：Go 1.18中的评测改进。</p><p>也就是说，除非你使用大量cgo，否则Go 1.17中的新功能应该已经非常适合你了。</p><p>我目前正在寻找对这些新功能感兴趣的人，以便获得反馈。</p><p>无论你是现有客户还是潜在客户，只要给我发一封电子邮件，我们就可以设置30分钟的缩放。为了让交易更甜蜜，我也很乐意回答一些常见的问题：）。</p><p>如果想快速入门，只需将下面的代码复制到应用程序中即可。</p><p>此外，您还可以查看这个完整工作的dd trace go演示应用程序，它显示了一个包括HTTP和PostgreSQL的集成。</p><p>包主要导入（&#34；time&#34；&#34；gopkg.in/DataDog/dd trace go.v1/ddtrace/tracer&#34；&#34；gopkg.in/DataDog/dd trace go.v1/profiler&#34；）func main（）{const（env=&#34；dev&#34；service=&#34；example&#34；version=&#34；0.1&#34；）tracer.Start（tracer.WithEnv（env）、tracer.WithService（service）、tracer.WithService（version）、tracer.withprofilercodehospots（true）、tracer.WithProfilerEndpoints（true）、defer（））tracer.Stop err:=profiler.Start（profiler.with服务（service），profiler。WithEnv（env），探查器。WithVersion（version），//在所有范围内，100%的时间内启用CPU分析以捕获热点信息//的功能。目前默认值为25%，但在//下一个dd trace go发行版中可能会发生变化。探查器。CPUDuration（60*time.s），分析器。WithPeriod（60*时间秒），如果出错无{panic（err）}延迟分析器。停止（）/&lt；您的应用程序代码&gt；}</p><p>--Felix Geisendörfer通过RSS或电子邮件订阅此博客，或通过Twitter从我那里获取小的更新。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/跟踪/">#跟踪</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/profiling/">#profiling</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/功能/">#功能</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>