<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>对亚马逊Manyrepo构建系统的思考</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">对亚马逊Manyrepo构建系统的思考</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-31 02:40:40</div><div class="page_narrow text-break page_content"><p>A while ago, I pondered monorepo version control systems.This article is at the opposite end of the spectrum: Manyrepos.</p><p>不久前，我考虑过Monorepo版本控制系统，本文则与此截然相反：Manyrepos。</p><p>  Monorepos are alluring since Google, Facebook, and Microsoft use that approach.Is that a part of their secret sauce or accidental?There is another big tech company which does the opposite.At Amazon, teams work more independently.Some use different version control systems which are not gitlike Subversion and Perforce.I guess that most companies do  not have a monorepobecause it is really easy to split of a separate projectbut hard to merge them just from an organizational point of view.So maybe we can learn more from Amazon than Google?</p><p>Monorepos很有吸引力，因为谷歌、Facebook和微软都使用了这种方法。这是他们秘密计划的一部分，还是偶然的？还有另一家大型科技公司做了相反的事情。在亚马逊，团队更独立地工作。一些公司使用不同的版本控制系统，这些系统并不像Git那样颠覆和执行。我猜大多数公司没有单一的方法，因为从组织的角度来看，拆分一个单独的项目真的很容易，但很难合并它们。所以也许我们可以从亚马逊学到比谷歌更多的东西。所以，也许我们可以从亚马逊学到比谷歌更多的东西。我猜大多数公司没有单一的方法，因为从组织的角度来看，拆分一个单独的项目真的很容易，但很难合并它们。所以也许我们可以从亚马逊学到比谷歌更多的东西？</p><p> A common pattern is that Amazon like the others built its own infrastructureand engineers love it and miss it after they leave.</p><p>一个共同的模式是，亚马逊和其他公司一样建造了自己的基础设施，工程师们喜欢它，离开后也怀念它。</p><p> I&#39;ve heard descriptions and seen blog entries about many other large companies build systems, but to be honest, nothing even comes close to the amazing technology Amazon has produced.I would probably argue that what Google, Facebook, and most other companies of comparable size and larger do is at best objectively less good and at worst wasting millions of dollars of lost productivity.– terabyte</p><p>我听过关于许多其他大公司建立系统的描述，也看过博客文章，但老实说，甚至没有什么能与亚马逊创造的令人惊叹的技术相提并论。我可能会争辩说，谷歌、Facebook和大多数其他规模或更大的公司所做的事情，充其量客观上是不太好的，最糟糕的是浪费了数百万美元的生产力损失。-TB。</p><p> Once you understand the build and deployment tools you first wonder how you ever did anything before and then start to fear how you&#39;ll do anything once you leave.– hohle</p><p>一旦你了解了构建和部署工具，你首先会想知道你以前是怎么做的，然后开始担心一旦你离开了，你会怎么做。-霍尔。</p><p> Just like Ex-Googlers reinvented their build system on the outsidewith  Pantsand  Buck.Likewise  QBT reinvents the Amazon build system.Unfortunately, QBT is less known and less mature.</p><p>就像前谷歌员工用Pantand Buck在外面重新创造了他们的构建系统一样，QBT也重新发明了亚马逊的构建系统。不幸的是，QBT鲜为人知，也不那么成熟。</p><p>  There is less information about Amazon unfortunately.Mine is from  this gistand discussions on  HN and lobste.rs.If I got something wrong, please tell me.The short version is that Amazon&#39;s &#34;Brazil&#34; tool ismore of a package system than a build system.It is closer to Nix than to Bazel.</p><p>不幸的是，关于亚马逊的信息较少。我的信息来自HN和lobste.rs上的这个看台讨论。如果我说错了什么，请告诉我。简而言之，亚马逊巴西工具更像是一个打包系统，而不是构建系统。它更接近NIX，而不是Bazel。</p><p> Brazil delegates the actual build process to language-specific tools.Tools, like tmux, are also packaged with Brazil.The interesting part is how packages are managedand the core concept to understand is  version set.</p><p>巴西将实际的构建过程委托给特定于语言的工具。像tmux这样的工具也与巴西一起打包。有趣的是包是如何管理的，需要理解的核心概念是版本集。</p><p> If you create a package at Amazon,you specify an  interface version like &#34;1.1&#34;.As long as changes are backwards-compatible,the interface version is not changed.When Brazil builds a package,it appends an additional number to turn it into a  build versionlike &#34;1.1.3847523&#34;.You can only specify dependencies on interface versions.</p><p>如果您在Amazon创建包，则指定类似&#34；1.1&#34；的界面版本。只要更改是向后兼容的，界面版本就不会更改。当巴西构建包时，它会附加一个额外的数字，使其成为类似&#34；1.1.3847523&#34；的构建版本。您只能指定对界面版本的依赖关系。</p><p> Another thing Brazil does when building a packageis to record the transitive closure of dependencieswith their build versions.Modern packaging tools differ between&#34;dependencies you want&#34;and &#34;dependencies you actually used&#34;.For example,  Cargo.toml and Cargo.lock in Rust.</p><p>巴西在构建包时做的另一件事是记录依赖项与其构建版本的可传递关闭。现代打包工具在您想要的依赖项和您实际使用的依赖项之间有所不同。例如，Rust中的Cargo.toml和Cargo.lock。</p><p> A  version set is a collection of packages.The &#34;live&#34; package is the special global onewhich corresponds to a trunk branch in version control.When you build a package &#34;against&#34; a version set,the tests of all packages in the version set are executed,and the version set is incremented.Thus the individual package is updated(or published if it was not part of the version set before).</p><p>版本集是包的集合。包是特殊的全局包，与版本控制中的主干分支相对应。当您针对版本集构建包时，将执行对版本集中所有包的测试，并且版本集将递增。因此，单个包将更新(如果之前不是版本集的一部分，则会发布)。</p><p> Brazil dependencies are classified as runtime, build, and test dependencies.So for deployment, it can strip everything but the runtime dependenciesfrom a version set.</p><p>巴西依赖项分为运行时依赖项、构建依赖项和测试依赖项，因此对于部署，它可以从版本集中剥离除运行时依赖项之外的所有依赖项。</p><p>  One of the biggest ways that brazil was misused was around handling of major versions [aka interface version].For context, only a single major version of a package is allowed to exist in a versionset at a time. If you tried to merge in a different major version of a package into your versionset, your pipeline would fail to build due to &#34;Major version conflicts&#34;. One of the biggest sins was around bumping the major versions of the dependencies in a library without bumping the major version of that library at the same time. This would lead to many broken pipelines. Let&#39;s say you have a library Foo-1.0 with a bunch of users on other teams. You decide to bump up the Guava version from 25 to 29 and publish the new version of Foo-1.0. Anyone consuming Foo-1.0 would automatically pick up the new version of that lib because it&#39;s just a minor version change, however the merge would fail with a &#34;major version conflict&#34; because the major version of Guava they&#39;re using in their versionset is still 25. This means you would either have to pin that library back at a previous version, or bump your dependency on Guava in all of you packages to 29.– pentlander</p><p>巴西被滥用的最大方式之一是围绕主要版本[又名界面版本]的处理，就上下文而言，一个版本集中一次只允许存在一个包的一个主要版本。如果您尝试将包的不同主要版本合并到您的版本集中，您的管道将由于主要版本冲突而无法构建。最大的错误之一是在没有同时冲突库的主要版本的情况下冲撞库中的依赖项的主要版本。这将导致许多管道破裂。假设您有一个库foo-1.0，其中有一群其他团队的用户。您决定将Guava版本从25升级到29，并发布新版本的foo-1.0。任何使用foo-1.0的用户都会自动选择该库的新版本，因为这只是一个次要的版本更改，但是合并将失败，并出现主要版本冲突，因为他们在其版本集中使用的主要版本仍然是25。这意味着您要么必须将该库固定回以前的版本，要么将您对所有软件包中的芭乐的依赖提升到29个。--Pentlander。</p><p> This is an insight that generalizes:Updating a dependency major version is a breaking changeeven if your API is stable.</p><p>这是一个概括的见解：即使你的API是稳定的，更新依赖项的主要版本也是一个突破性的变化。</p><p>  Overall, it sounds a lot like a distribution package manager like apt or Nix.The difference of version sets isthat they provide a branching mechanismand this is how teams can work independently.How is that unique though?You can fork with apt and Nix as well.In a monorepo, it would be a branch.It must be about something different.</p><p>总体而言，它听起来很像APT或Nix这样的发行包管理器。版本集的不同之处在于它们提供了分支机制，这就是团队可以独立工作的方式。这有什么特别的呢？你也可以用APT和Nix分叉。在Monorepo中，它将是一个分支。它肯定是关于不同的东西。</p><p> One advantage of monorepos is that one can track all users.Version sets in Brazil provide a similar mechanismsince it is a  central database.This is important in case of security updates, for example.Unfortunately, in manyrepo environments this information is usually not availableand when an issue arise it must be arduously researched.So maybe companies should build such infrastructureinstead of dreaming about monorepos?</p><p>Monorepos的一个优点是可以跟踪所有用户。巴西的版本集提供了类似的机制，因为它是一个中央数据库。例如，这在安全更新的情况下很重要。不幸的是，在许多repo环境中，这些信息通常是不可用的，当出现问题时，必须对其进行艰苦的研究。那么，也许公司应该建立这样的基础设施，而不是梦想着Monorepos？</p><p> Coming back to the advantage of manyrepos,refering to Amazon we can describe it concretely:Version sets allow you to use multiple interface versions of the same packageat once (not multiple build versions though).This mixture is not technically possible with a git monorepo(but with Subversion or Perforce).This is at least one example of the general tradeoff.</p><p>回到多个repo的优势，参考Amazon，我们可以具体描述它：版本集允许您一次使用同一包的多个界面版本(虽然不是多个构建版本)。这种混合在技术上使用git monorepo是不可能的(但使用Subversion或Perforce)。这至少是一般权衡的一个示例。</p><p> I don’t really think there’s a better or worse between the Amazon and Google/FB style build/deploy/source control systems, it’s primarily a reflection of the org/team structure and what they prioritize - there’s tension between team independence/velocity and crosscutting changes that optimize the whole codebase.– revert</p><p>我真的不认为Amazon和Google/FB风格的构建/部署/源代码控制系统之间有什么更好或更差的地方，它主要反映了组织/团队的结构和他们优先考虑的事情-团队独立性/速度和优化整个代码库的横切更改之间存在紧张关系。</p><p> I would like to see more discussion online about this.Many companies should value the team independence over the crosscutting changes.So the question is:How to get the advantages we currently uniquely attribute to monoreposin a manyrepo setting?Amazon&#39;s Brazil has valuable ideas to contributeand should be more widely known.</p><p>我希望在网上看到更多关于这方面的讨论。许多公司应该更看重团队的独立性，而不是横切的变化。所以问题是：如何在众多回购环境中获得我们目前唯一归功于单一数据库的优势？亚马逊的巴西有宝贵的想法可以做出贡献，应该更广为人知。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="http://beza1e1.tuxen.de/amazon_manyrepo_builds.html">http://beza1e1.tuxen.de/amazon_manyrepo_builds.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/amazon/">#amazon</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/亚马逊/">#亚马逊</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/构建/">#构建</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/版本/">#版本</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1032341.html"><img src="http://img2.diglog.com/img/2020/10/thumb_627b4c4ae4f3aa068b3ef536210ba2fb.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032341.html">亚马逊正在打开全新的Razr盒子以折叠手机，以确保运输安全</a></div><span class="my_story_list_date">2020-10-31 2:40</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032216.html"><img src="http://img2.diglog.com/img/2020/10/thumb_214ddb9e62c2e1dcecbd6047d7e900df.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032216.html">
亚马逊预计新冠肺炎下个季度的成本约为40亿美元</a></div><span class="my_story_list_date">2020-10-30 10:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032141.html"><img src="http://img2.diglog.com/img/2020/10/thumb_c8edf3dcb231359da70d319e7de759d6.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032141.html">亚马逊报告称，第三季度“其他”类别收入为54亿美元，同比增长51%，订阅服务收入为65.8亿美元，同比增长33%，其中主要包括广告业务。</a></div><span class="my_story_list_date">2020-10-30 4:56</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032133.html"><img src="http://img2.diglog.com/img/2020/10/thumb_c1dfc94501cbe88803516dad93e2d016.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032133.html">
亚马逊打破了第三季度的预期，但AWS增长放缓至29%</a></div><span class="my_story_list_date">2020-10-30 4:34</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>