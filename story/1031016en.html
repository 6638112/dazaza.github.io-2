<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>三个开源Sonos项目：Rust中高效的嵌入式开发</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">三个开源Sonos项目：Rust中高效的嵌入式开发</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-25 06:15:59</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/4c7caf2581b4d14b9be121f26f94dc9c.jpg"><img src="http://img2.diglog.com/img/2020/10/4c7caf2581b4d14b9be121f26f94dc9c.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>The three projects introduced in this post were created by Snips, a French startup specialised in embedded speech understanding, which, following a 2019 acquisition, now makes up Sonos’ voice experience team.  The Sonos team continues to develop and maintain these open source projects.</p><p>本文介绍的三个项目是由Snips创建的，Snips是一家专注于嵌入式语音理解的法国初创公司，在2019年被收购后，Snips现在组成了Sonos的语音体验团队，Sonos团队继续开发和维护这些开源项目。</p><p> Inside a young software ecosystem, often some libraries or tools are lacking if you venture outside of the main focus of the initial ecosystem foundation. We encountered that phenomenon a few times, and on a few occasions, we tried to rise to the challenge and make a contribution to the ecosystem.</p><p>在一个年轻的软件生态系统中，如果您在初始生态系统基础的主要关注点之外冒险，通常会缺少一些库或工具。我们遇到过几次这种现象，有几次，我们试图迎接挑战，为生态系统做出贡献。</p><p> As early adopters of the Rust language, we got frustrated with the practical difficulties of running tests and benches on mobile phones and other connected devices. This led to the development of  dinghy. Running neural network models on devices in a world where the big players prefer the cloud pushed us to develop  tract. Finally, targeting embedded computers like the Sonos devices requires a lot of interfacing with other native software. We developed  ffi-convert because we wanted it to be easier, both for us and for other teams.</p><p>作为Rust语言的早期采用者，我们对在手机和其他连接设备上运行测试和工作台的实际困难感到沮丧。这导致了小艇的发展。在一个大玩家更喜欢云的世界里，在设备上运行神经网络模型推动了我们开发Track。最后，瞄准像Sonos设备这样的嵌入式计算机需要与其他本地软件进行大量接口。我们开发FFI-CONVERT是因为我们想让它对我们和其他团队来说都更容易。</p><p>    Sonos is a software company; besides the hardware, what makes the Sonos system special is software. The software stack spans the cloud, mobile devices, and of course the speakers and components themselves. On-device software has to be cross-compiled. The small computers at the core of our players can run the software, but they could not build it — or they could, but not in a very practical way.</p><p>Sonos是一家软件公司，除了硬件之外，Sonos系统的特别之处在于软件。软件堆栈跨越云、移动设备，当然还有扬声器和组件本身。设备上的软件必须交叉编译。我们玩家核心的小型计算机可以运行软件，但他们不能构建它-或者他们可以，但不是以一种非常实用的方式。</p><p> The Sonos Voice Experience software is written in Rust. This language solves most of the cross-compiling issues. Actual cross-compilation is natively handled by rustc, cargo, and rustup. Rustc, the compiler, is built on top of LLVM, so it can generate code for a wide collection of architectures. Cargo, the build and dependency manager, is aware of cross-compiling and can drive the compiler accordingly. Rustup makes it easy to set up and keep up-to-date an environment able to cross-compile to many architectures. But we wanted to push it a bit further — we wanted to run tests and benches on actual devices as easily as on a PC.</p><p>Sonos语音体验软件是用Rust编写的。该语言解决了大部分交叉编译问题。实际的交叉编译由Rustc、Cargo和Rustup进行本机处理。编译器Rustc构建在LLVM之上，因此它可以为各种架构生成代码。构建和依赖项管理器Cargo知道交叉编译，并可以相应地驱动编译器。Rustup使设置和保持最新环境变得很容易，该环境能够对许多架构进行交叉编译。但我们想要更进一步-我们想在实际设备上像在PC上一样轻松地运行测试和工作台。</p><p> Dinghy is a cargo extension that rewires the familiar “run”, “test”, and “bench” commands. It handles cross compilation, deploys the compiled code to the device, then remotely runs tests or benches on the target device. It reports the results as if the test were running locally. As the Rust ecosystem matured, we patched third-party libraries so they were cross-compiled and worked on ARM processors. One ambition of  dinghy was to make it trivial for any Rust library developer to run tests on their own phone, even for libraries that did not explicitly target phones. We wanted any Rust developer to be able to cross-compile and test on a phone without having to be an expert on Android or iOS.</p><p>Dinghy是一个Cargo扩展，它重新连接了熟悉的“run”、“test”和“bench”命令。它处理交叉编译，将编译后的代码部署到设备上，然后在目标设备上远程运行测试或工作台。它会报告结果，就好像测试在本地运行一样。随着Rust生态系统的成熟，我们为第三方库打了补丁，以便它们可以在ARM处理器上交叉编译和工作。Dinghy的一个雄心是让任何Rust库开发人员在自己的手机上运行测试变得微不足道，即使对于没有明确针对手机的库也是如此。我们希望任何Rust开发人员都能够在手机上交叉编译和测试，而不必是Android或iOS专家。</p><p> Running code on Android phones from arbitrary tools is relatively easy. iOS phones are more of a challenge, as iOS devices will only accept signed code, even for tests. XCode handles most of the complexity of signing code and certificate management for an iOS application developer, but replicating the process outside of XCode for an external tool like Cargo is not a trivial task.</p><p>在Android手机上从任意工具运行代码相对容易。IOS手机更是一个挑战，因为iOS设备将只接受签名的代码，即使是测试也是如此。Xcode为iOS应用程序开发人员处理签名代码和证书管理的大部分复杂性，但在XCode之外将该过程复制到Cargo等外部工具并不是一件容易的任务。</p><p> Additionally,  dinghy can target remote devices using ssh. This makes it very easy to use a raspberry pi or any single board computer as a test and bench device, while keeping the heavy compilation of rust code to a powerful intel workstation, server or laptop.</p><p>此外，dinghy可以使用ssh瞄准远程设备。这使得使用树莓pi或任何单板计算机作为测试和试验台设备变得非常容易，同时将大量的锈代码编译到功能强大的英特尔工作站、服务器或笔记本电脑上。</p><p> Today,  dinghy is at the core of the SVE build system, since SVE code is mostly Rust. In-house developers also use it in interactive tests and benches, targeting unlocked Sonos devices or standard single board computers as proxies. We also maintain mobile platform support in good working order, even though it is not a primary target for SVE.</p><p>今天，dinghy是SVE构建系统的核心，因为SVE代码大多是铁锈的。内部开发人员还在互动测试和长凳上使用它，目标是解锁的Sonos设备或标准单板计算机作为代理。我们还将移动平台支持保持在良好的工作状态，尽管它不是SVE的主要目标。</p><p>      Tract is a neural network inference library. The most visible neural network libraries, like TensorFlow or PyTorch, are training frameworks; they are used by machine learning teams to train neural networks. Training is usually done in the cloud, with access to vast amounts of computing resources and training data. Once the network is trained, it has to be deployed in order to run and perform the task it was designed and trained for.</p><p>TRACE是一个神经网络推理库。最明显的神经网络库，如TensorFlow或PyTorch，都是训练框架；机器学习团队使用它们来训练神经网络。培训通常在云中进行，可以访问大量的计算资源和培训数据。网络经过培训后，必须进行部署，才能运行和执行其设计和培训的任务。</p><p> Training frameworks are also perfectly capable of doing this task, called “inference”. However, they tend to favour the training aspects above all other imperatives, to the detriment of the inference use case. They are also huge pieces of software, making them a quite expensive solution for embedded systems where resources are scarce. It is not uncommon for embedding teams to develop ad-hoc neural network runners that hardcode a specific neural network design.</p><p>培训框架也完全有能力完成这项任务，称为“推理”。然而，他们倾向于支持培训方面，而不是所有其他的要求，这对推理用例是不利的。它们也是巨大的软件，对于资源稀缺的嵌入式系统来说，它们是一个相当昂贵的解决方案。对于嵌入式团队来说，开发硬编码特定神经网络设计的ad-hoc神经网络运行器并不少见。</p><p> We chose another way, developing tract as a generic neural network inference library. We make sure it is competitive with other libraries in the standard use cases like image categorization challenges. Since inference is a considerably easier problem than training, quite a few libraries exist in this space independently of the big training frameworks.</p><p>我们选择了另一种方式，将TRACE开发成一个通用的神经网络推理库。我们确保它在标准用例(如图像分类挑战)中与其他库竞争。由于推理是一个比训练容易得多的问题，因此相当多的库独立于大型训练框架而存在于该领域。</p><p> But voice, music, sound, and other time-oriented signals are not necessarily first class citizens when it comes to neural networks. Running real time in a streaming fashion also adds constraints on both model design and runtime engineering that may elude off-the-shelf solutions. Owning our own library gives us the opportunity to put energy into solving our specific constraints, hardware or applicative. We are firm believers in the virtues of owning business-critical pieces of engineering.</p><p>但是，当涉及到神经网络时，语音、音乐、声音和其他面向时间的信号不一定是一等公民。以流方式实时运行还增加了对模型设计和运行时工程的约束，这些约束可能会避开现成的解决方案。拥有自己的图书馆让我们有机会将精力投入到解决特定的硬件或应用限制上。我们坚信拥有对业务至关重要的工程部件的优点。</p><p> While tract was initiated as a developer’s personal pet project, a lot of development time was invested to make it great at running real-time voice applications on embedded systems. Sonos is happy to keep tract’s story going, investing developer time on tract. While we exchanged some constraints for others, and pushed the library in new directions, we do our best to make sure that tract remains a good general purpose neural network inference library. We were very happy to help with the development of tractjs, a third-party Javascript tract binding that allows running neural network inference in node.js, or even in a browser.</p><p>虽然TRAIL最初是作为开发人员的个人宠儿项目启动的，但它投入了大量的开发时间，以使其能够在嵌入式系统上运行实时语音应用程序。索诺斯很高兴让Track的故事继续下去，将开发者的时间投入到Track上。在我们交换了一些限制条件，并将库推向新方向的同时，我们尽最大努力确保TRACTRA仍然是一个良好的通用神经网络推理库。我们非常高兴为tractjs的开发提供帮助，这是一种第三方Javascript绑定，允许在node.js中甚至在浏览器中运行神经网络推理。</p><p>      As previously mentioned, we mostly use Rust for the SVE codebase. However, most of the rest of the Sonos ecosystem is coded in C++, and we need a way to have both codebases communicate. The standard way for having two different languages communicate is to use the C ABI. This is a set of conventions that are defined by the C language and explain how functions should be called, and it has the advantage of being properly defined and stable. This means that most languages are able to use these conventions to call into C code, or whatever code follows these conventions. This process is usually called FFI, for Foreign Function Interface.</p><p>如前所述，我们主要使用Rust作为SVE代码库。然而，Sonos生态系统的其余大部分都是用C++编写的，我们需要一种让两个代码库进行通信的方法。让两种不同语言进行通信的标准方式是使用C ABI。这是一组由C语言定义并解释应该如何调用函数的约定，它的优点是定义正确且稳定。这意味着大多数语言都能够使用这些约定调入C代码，或者任何遵循这些约定的代码。此过程通常称为FFI，即外部函数接口。</p><p> In the case of Rust, a few adjustments on the layout of the structs and the way functions are declared are necessary in order to have a C-compatible interface. We need to rewrite some high level Rust constructs to resemble something closer to lower-level C semantics. For instance, use raw pointers instead of Rust references, or force the rustc compiler to lay out the memory of a struct as the C compiler would. We end up having two structs representing the data going through our C interface: the C-like one that is cumbersome to use in Rust (you need to use “unsafe” rust blocks to access anything behind a raw pointer) and the pure Rust one that can be used easily in the Rust code. With two structs effectively representing the same thing, we need a way to easily convert data from one representation to the other.</p><p>对于Rust，为了拥有与C兼容的接口，需要对结构的布局和声明函数的方式进行一些调整。我们需要重写一些高级Rust结构，使其更接近于较低级别的C语义。例如，使用原始指针而不是Rust引用，或者强制rustc编译器像C编译器那样布局结构的内存。我们最终拥有两个表示通过C接口的数据的结构：一个类似C的结构，在Rust中使用起来很麻烦(您需要使用“不安全的”Rust块来访问原始指针后面的任何内容)和一个纯Rust结构，它可以很容易地在Rust代码中使用。有了两个有效地表示同一事物的结构，我们需要一种轻松地将数据从一种表示转换为另一种表示的方法。</p><p> This conversion code is somewhat easy to write, but it is quite repetitive, and there are quite a few gotchas (using unsafe Rust code is, well, unsafe). This is why we decided to create  ffi-convert: a set of Rust traits standardising the conversion process, complemented with Rust proc macros to automatically derive the implementation of these traits. This means we don’t have to write the unsafe and error prone conversion code anymore, since it is automatically generated. This also ensures all the conversion code follows good practices, improving code quality, while making it easy to systematically change all the implementations quickly if we find a problem in the way we handle a conversion.</p><p>这个转换代码有点容易编写，但是它相当重复，而且有相当多的陷阱(使用不安全的Rust代码是不安全的)。这就是为什么我们决定创建ffi-Convert：一组使转换过程标准化的Rust特征，并辅之以Rust proc宏，以自动派生这些特征的实现。这意味着我们不必再编写不安全且容易出错的转换代码，因为它是自动生成的。这还确保了所有转换代码都遵循良好的实践，提高了代码质量，同时如果我们在处理转换的方式中发现问题，可以轻松地快速系统地更改所有实现。</p><p> While it has been written to support our use cases, ffi-convert does not contain anything specific to our projects. It can be helpful for any project having to deal with a non trivial FFI interface. It is available on  GitHub as well as on  crates.io, so you can easily use it to create a C ABI for your own rust projects.</p><p>虽然编写FFI-Convert是为了支持我们的用例，但它不包含任何特定于我们项目的内容。它对任何必须处理非平凡的FFI接口的项目都很有帮助。它在GitHub和crates.io上都可用，因此您可以很容易地使用它为您自己的Ruust项目创建一个C ABI。</p><p>     These three projects are at different stages of their lifetime, ranging from very active development to maturity and stability. All of them play an important role in our day to day activities, so we naturally invest some time to develop them more, or maintain them in good shape. It’s always with great pleasure that we get some feedback from the community, be it in the form of bug reports or feature requests, so feel free to give them a shot and reach out!</p><p>这三个项目正处于生命中的不同阶段，从非常活跃的发展到成熟稳定。它们在我们的日常活动中都扮演着重要的角色，所以我们自然会花一些时间来更多地培养它们，或者保持它们的良好状态。我们总是非常高兴地从社区获得一些反馈，无论是以错误报告还是功能请求的形式，所以请随时给他们一个机会，并联系他们！</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://tech-blog.sonos.com/posts/three-open-source-sonos-projects-in-rust/">https://tech-blog.sonos.com/posts/three-open-source-sonos-projects-in-rust/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/开源/">#开源</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/开发/">#开发</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/sonos/">#sonos</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/source/">#source</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1030326.html"><img src="http://img2.diglog.com/img/2020/10/thumb_f51b305f6413c5039ab87cf02b4a57e4.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030326.html">在为开源项目做贡献时应该避免什么</a></div><span class="my_story_list_date">2020-10-22 3:38</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030321.html"><img src="http://img2.diglog.com/img/2020/10/thumb_62a45ddc49e773fd22182544d250b522.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030321.html">欧盟委员会批准新的开源软件战略2020-2023年</a></div><span class="my_story_list_date">2020-10-22 3:26</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030288.html"><img src="http://img2.diglog.com/img/2020/10/thumb_424f585cdb872b09b408f6afed080335.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030288.html">
研究发现，大多数大型开源初创公司都在旧金山湾区以外，其中许多是欧洲公司，并且避免了风险投资</a></div><span class="my_story_list_date">2020-10-21 19:49</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030264.html"><img src="http://img2.diglog.com/img/2020/10/thumb_e59aec519ef06d73fd94eacf26958a58.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030264.html">Authelia：开源的全功能认证服务器</a></div><span class="my_story_list_date">2020-10-21 15:12</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>