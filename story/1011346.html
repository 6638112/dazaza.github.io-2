<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Cockroachdb/Copist：在围棋测试中模拟SQL数据库从未如此简单</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Cockroachdb/Copist：在围棋测试中模拟SQL数据库从未如此简单</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-12 23:09:51</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/7/042820036143b1de3a783b79c9419758.png"><img src="http://img.diglog.com/img/2020/7/042820036143b1de3a783b79c9419758.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>在围棋测试中模拟您的SQL数据库从未如此简单。复制器库自动记录测试期间进行的低级SQL调用。然后，它生成无需连接到Real SQL数据库即可回放这些调用的测试代码。再做一次测试。这一次，它们将运行得更快，因为现在它们不需要数据库连接。</p><p>最棒的是，您的测试将在每个测试用例之间运行，就好像您的测试数据库被重置为干净的、众所周知的状态一样。令人沮丧的问题已经不复存在，即测试单独运行时运行良好，但与修改数据库的其他测试协同运行时会失败。</p><p>只要代码直接或间接使用GO的SQL包(例如，GO ORM和广泛使用的sqlxpackage)，Copist就不会对生产代码施加任何开销，而且几乎不需要对您的应用程序或测试代码进行任何更改。这是因为Copist在Go的sqlpackage的驱动程序级别运行。</p><p>假设您有一些应用程序代码，它打开到Postgresdatabase的连接并查询一些客户数据：</p><p>func QueryName(db*sql.DB)string{row，_：=db.Query(&#34；select name from Customers where id=$1&#34；，100)推迟rows.Close()for rows.Next(){var name string rows.Scan(&amp；name)return name}return&#34；&#34；}。</p><p>测试此代码的通常方法是创建一个测试数据库，并使用测试客户数据填充该数据库。但是，如果应用程序代码修改了数据库中的行，比如删除客户怎么办？如果上面的代码在修改后的数据库上运行，它可能不会返回预期的客户。因此，重要的是要在测试用例之间重置数据库的状态，以便测试的行为是可预测的。但是连接到数据库的速度很慢。运行查询的速度很慢。而且在每次测试之间重置整个数据库的状态非常慢。</p><p>各种模仿库是使用测试数据库的另一种选择，这些库在应用程序或数据访问堆栈的某一层拦截调用，并在不需要接触数据库的情况下返回录制的响应。其中许多库的问题在于，它们要求开发人员手动构建录制的响应，这在应用程序发生更改时既耗时又脆弱。</p><p>Copyist包含一个Go SQL包驱动程序，用于记录应用程序和测试代码进行的低级SQL调用。当使用COPYSTER调用GO测试时，如果使用&#34；-RECORD&34；命令行标志，则COPYSTER驱动程序将记录所有SQL调用。测试完成后，Copist将在随附的测试文件中生成回放GO代码。然后，可以在没有&#34；-record&#34；标志的情况下再次运行GO测试。这一次，复印机驱动程序将回放录制的通话，而不需要访问数据库。GO测试并没有变得更明智，它的运行方式就像它正在使用数据库一样。</p><p>下面是使用Copist的推荐测试模式。该示例显示了如何对上面所示的QueryName函数进行单元测试。</p><p>func TestMain(m*testing.M){flag.parse()copy ist.Register(&#34；postgres&#34；，setDB)os.Exit(m.Run())}func TestQueryName(t*testing.T){defer copy ist.Open().Close()db，_：=sql.Open(&#34；Copist_Postgres&#34；，&#34；postgreSQL：//root。{t.Error(&#34；测试失败&#34；)}}。</p><p>在TestMain函数(或在任何测试之前调用的任何其他位置)中，调用copy ist.Register函数。此函数用于将新驱动程序注册到名为Copist_&lt；driverName&gt；的GO&#39；的SQL包中。在您要录制的任何测试中，添加一个延迟复制器。Open().Close()语句。此语句开始一个新的录制会话，然后在测试结束时调用Close时生成回放代码。</p><p>Copist确实需要知道是在录制模式下运行还是在回放模式下运行。要使Copist在录制模式下运行，请使用记录标志调用测试：</p><p>这将在与TestQueryNamefile相同的目录中生成一个新的测试文件。例如，如果该文件名为app_test.go，则Copyist将生成一个包含TestQueryName测试记录的app_copy ist_test.go文件。现在再尝试运行测试几次(第一次需要重新编译测试，因此需要更长的时间)：</p><p>上面的部分忽略了一个重要的细节。注册驱动程序以与Copist一起使用时，Register的第二个参数是回调函数：</p><p>如果不为空，则只要Copyist在录制模式下运行，每次调用Copist.Open(通常在每次测试开始时)时，Copist都会调用此函数。此重置函数可以做它喜欢做的任何事情，但通常它会对数据库运行SQL脚本，以便通过删除/创建表、删除表中的数据和/或将数据插入到表中来使测试更方便，从而将其重置为干净状态。</p><p>这只是意味着您需要使用&#34；-record&34；命令行标志重新运行测试，以便生成新的录制。最有可能的是，您更改了应用程序或测试代码，以便它们使用不同的调用顺序或内容以不同的方式调用数据库。</p><p>但是，在更罕见的情况下，您已经重新生成了录制，没有进行任何测试或应用程序更改，但在以不同的顺序运行测试时仍然看到此错误。这是由你的应用程序或你正在使用的ORM中的非决定论造成的。</p><p>作为不确定性的一个例子，一些ORM在第一个连接打开时向数据库发送设置查询，以确定数据库版本。因此，无论哪个测试碰巧先运行，都会记录一个额外的查询调用。如果您首先运行不同的测试，您将看到意外调用错误，因为其他测试并不期待额外的调用。</p><p>解决这些问题的办法是消除非决定论。例如，在ORM发送设置查询的情况下，从TestMainmethod初始化它：</p><p>测试文件的大小与您的测试对数据库的访问次数以及它们请求的数据量直接相关。虽然复制者费力地生成高效的代码，以尽可能多地消除冗余，但它所能做的也就这么多了。尝试编写对较小数量的有趣数据进行操作的测试。对于需要大量数据库调用或大量数据的测试，请使用不同形式的验证。关于模仿者的一个好处是，你可以选择哪些测试将使用它。为正确的工作选择正确的工具，诸如此类。</p><p>由于Copist的工作方式，它只能用于非并行、单线程测试和应用程序代码。这是因为驱动程序代码无法知道哪个测试和/或哪个线程使用了哪些连接、语句和事务。</p><p>Copist目前仅支持Postgres PQ驱动程序。如果您想要扩展Copist以支持其他驱动程序，如MySQL或SQLite，请您提交拉取请求。</p><p>Copist不会实现每个SQL包驱动程序接口和方法。这可能意味着复制者可能不能完全使用一些具有更高级功能的驱动程序。欢迎在这一领域的贡献。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://github.com/cockroachdb/copyist">https://github.com/cockroachdb/copyist</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/database/">#database</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/数据库/">#数据库</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/sql/">#sql</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/copyist/">#copyist</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/测试/">#测试</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1010873.html"><img src="http://img.diglog.com/img/2020/7/thumb_dfcf51d510ec471de68ecd4cd45dbfc2.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1010873.html">使用图形数据库构建您的下一个应用程序</a></div><span class="my_story_list_date">2020-7-10 3:58</span></div><div class="col-sm"><div><a target="_blank" href="/story/1010769.html"><img src="http://img.diglog.com/img/2020/7/thumb_edc0ddd81a38a186e95d123a676c5d96.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1010769.html">
MariaDB再融资2500万美元扩大SkySQL云数据库平台</a></div><span class="my_story_list_date">2020-7-9 21:17</span></div><div class="col-sm"><div><a target="_blank" href="/story/1009530.html"><img src="http://img.diglog.com/img/2020/7/thumb_ccf2810977b5100cce7d1a23ebced565.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1009530.html">JSON-Base-数据库软件完全构建为JSON文件</a></div><span class="my_story_list_date">2020-7-3 1:59</span></div><div class="col-sm"><div><a target="_blank" href="/story/1009490.html"><img src="http://img.diglog.com/img/2020/7/thumb_736ee9987456232d6fbe8cd23a89568f.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1009490.html">
QuestDB nabs$230万种子用于构建开源时间序列数据库</a></div><span class="my_story_list_date">2020-7-2 22:29</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>