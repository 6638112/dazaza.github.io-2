<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>如何在 Rust 中实现工作池</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">如何在 Rust 中实现工作池</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-07-23 00:51:41</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/7/b7a1af7e0606912201c55975f6549aec.jpg"><img src="http://img2.diglog.com/img/2021/7/b7a1af7e0606912201c55975f6549aec.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>别。由于其所有权模型，工作池不太适合 Rust。相反，拥抱函数式编程和不可变数据。 Rust 提供了更简单易用和更优雅的工具：并行迭代器和流。需要注意的是，就像在任何编程语言中使用工作池一样，应该始终设置并发上限。否则，您可能会很快耗尽系统资源。对于计算密集型作业（CPU 密集型），有提供并行迭代器的 rayon crate：其组合器被分派到线程池的迭代器。好消息是线程池对我们这些开发人员是隐藏的。我们只需要像使用标准迭代器一样进行编码。 [ package] name = &quot;rust_worker_pool&quot; version = &quot;0.1.0&quot; authors = [ &quot;Sylvain Kerkour &lt;sylvain@kerkour.com&gt;&quot;] edition = &quot;2018&quot; # 在 https://doc.rust 查看更多键和它们的定义-lang.org/cargo/reference/manifest.html[dependencies] rand = &quot;0.8&quot; rayon = &quot;1&quot; 使用 rand::{thread_rng, Rng};使用人造丝::前奏:: *;使用 std::time::Duration; fn compute_job(job: i64) -&gt; i64 { let mut rng = thread_rng();让 sleep_ms: u64 = rng.gen_range( 0.. 10); std::thread::sleep(Duration::from_millis(sleep_ms)); job * job} fn process_result(result: i64) { println !( &quot;{}&quot;, result);} fn main() { let jobs = 0.. 100; jobs.into_par_iter() .map(compute_job) .for_each(process_result);} 默认情况下，线程池的大小等于机器的逻辑 CPU 数量。对于 I/O（输入/输出）绑定作业，我们需要转移到异步区域。更准确地说，我们将使用 Streams，它是可以并发处理项目的异步迭代器。</p><p>但是 Stream trait 本身不提供组合子。我们需要从未来的 crate 中导入 StreamExt trait。 [ package] name = &quot;rust_worker_pool&quot; version = &quot;0.1.0&quot; authors = [ &quot;Sylvain Kerkour &lt;sylvain@kerkour.com&gt;&quot;] edition = &quot;2018&quot; # 在 https://doc.rust 查看更多键和它们的定义-lang.org/cargo/reference/manifest.html[dependencies] rand = &quot;0.8&quot; tokio = { version = &quot;1&quot;, features = [ &quot;full&quot;] } futures = &quot;0.3&quot; for_each_concurrent 是最容易使用的消耗流。这意味着它不会返回 Stream 本身，而是返回一个可以 .await 的 Future。使用期货::{stream, StreamExt};使用 rand::{thread_rng, Rng};使用 std::time::Duration; async fn compute_job(job: i64) -&gt; i64 { let mut rng = thread_rng();让 sleep_ms: u64 = rng.gen_range( 0.. 10); tokio::time::sleep(Duration::from_millis(sleep_ms))。等待; job * job} async fn process_result(result: i64) { println !( &quot;{}&quot;, result);} #[tokio::main] async fn main() { let jobs = 0.. 100;让并发= 42; stream::iter(jobs) .for_each_concurrent(concurrency, |job | async move { let result = compute_job(job). await; process_result(result). await; }) 。 await;} 另一方面，buffer_unordered 不消耗流。这就是为什么我们需要使用 for_each 作为接收器来消费 Stream。使用期货::{stream, StreamExt};使用 rand::{thread_rng, Rng};使用 std::time::Duration; async fn compute_job(job: i64) -&gt; i64 { let mut rng = thread_rng();让 sleep_ms: u64 = rng.gen_range( 0.. 10); tokio::time::sleep(Duration::from_millis(sleep_ms))。等待; job * job} async fn process_result(result: i64) { println !( &quot;{}&quot;, result);} #[tokio::main] async fn main() { let jobs = 0.. 100;让并发= 42; stream::iter(jobs) .map(compute_job) .buffer_unordered(concurrency) .for_each(process_result) 。 await;} 有时，我们可能需要收集它们而不是直接处理结果，例如稍后批量发送它们。好消息，collect 方法在 Streams 上可用：</p><p>使用期货::{stream, StreamExt};使用 rand::{thread_rng, Rng};使用 std::time::Duration; async fn compute_job(job: i64) -&gt; i64 { let mut rng = thread_rng();让 sleep_ms: u64 = rng.gen_range( 0.. 10); tokio::time::sleep(Duration::from_millis(sleep_ms))。等待; job * job} async fn process_result(result: i64) { println !( &quot;{}&quot;, result);} #[tokio::main] async fn main() { let jobs = 0.. 100;让并发= 42;让结果： Vec &lt; i64 &gt; = stream::iter(jobs) .map(compute_job) .buffer_unordered(concurrency) .collect() 。 await;} PS：想学习真实世界的 Rust 和攻击性安全吗？看看我的书 Black Hat Rust（可在早期访问中获得），我们将在其中详细介绍，以及我在那里分享我在编写 Rust 超过 2 年的时间里学到的所有东西：https://academy .kerkour.com/black-hat-rust?coupon=BLOG PS 2：为了避免与电子邮件通讯传递相关的问题，我正在启动一个矩阵频道，您可以加入以关注此博客的所有更新:) #blog： kerkour.com</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://kerkour.com/blog/rust-worker-pool/">https://kerkour.com/blog/rust-worker-pool/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/worker/">#worker</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1069009.html"><img src="http://img2.diglog.com/img/2021/7/thumb_6f8a69fa54283e1959d7c30d4f212f9b.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1069009.html">使用来自 C、C++ 和 Rust 的 WebAssembly 线程</a></div><span class="my_story_list_date">2021-7-22 23:29</span></div><div class="col-sm"><div><a target="_blank" href="/story/1068986.html"><img src="http://img2.diglog.com/img/2021/7/thumb_4cb1df330196dc79ba39e39cd132d13f.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1068986.html">拜登选择谷歌的敌人来领导司法部的反垄断，因为它正在考虑拆分大型科技公司的计划</a></div><span class="my_story_list_date">2021-7-22 22:50</span></div><div class="col-sm"><div><a target="_blank" href="/story/1068923.html"><img src="http://img2.diglog.com/img/2021/7/thumb_023495daf1f8317da3089bebdce8c6d6.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1068923.html">拜登任命谷歌敌人乔纳森·坎特为美国司法部反垄断主管</a></div><span class="my_story_list_date">2021-7-22 22:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1068881.html"><img src="http://img2.diglog.com/img/2021/7/thumb_6f89ee3c4dd8ea095b0e1a5b954c56e1.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1068881.html">根据 6 月份的一封信，印度的反垄断监管机构指责亚马逊在寻求 2019 年投资 Future Group 部门的批准时隐瞒事实</a></div><span class="my_story_list_date">2021-7-22 22:19</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>