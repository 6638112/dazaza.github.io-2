<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>NSA教学 The NSA Instruction</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">The NSA Instruction<br/>NSA教学 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-06-11 17:23:04</div><div class="page_narrow text-break page_content"><p>Most CPU architectures in use today have an instruction called  popcount, short for “population count”. Here’s what it does: it counts the number of set bits in a machine word. For example (assuming 8-bit words for simplicity),  popcount(00100110) is  3 and  popcount(01100000) is  2.</p><p>今天使用的大多数CPU架构都有一个名为Popcount的指令，即“人口计数”。这是它的所作所为：它计算了机器字中的设置位的数量。例如（假设用于简单的8位字），Popcount（00100110）为3并且PopCount（01100000）是2。</p><p> You might be wondering, like I was, if there’s more to this instruction, but that’s all it does! This doesn’t seem very useful, right?</p><p> 你可能想知道，就像我一样，如果这条指令有更多的话，那就是它所做的一切！这似乎并不是很有用，对吗？</p><p> I thought this might be a recent addition for some hyperspecialised use case, but it has in fact been present in CPU architectures since at least 1961:</p><p> 我认为这可能是一些高超专业的用例的添加，但它实际上已经存在于自1961年以来的CPU架构中：</p><p>    popcount is also known as “The NSA Instruction”, and a  very entertaining thread on  comp.arch discusses its uses inside and outside cryptography. It is rumoured that it was originally added to CPU instructions at the behest of the NSA. As  this archived email thread puts it:</p><p>    PopCount也称为“NSA指令”，并且Comp.arch上的非常有趣的线程讨论其在内部和外部密码内容中。据传，它最初被添加到NSA的CPU指令中。由于此归档的电子邮件线程将其放置：</p><p> It was almost a tradition that one of the first of any new faster CDC machine was delivered to a “good customer” - picked up at the factory by an anonymous truck, and never heard from again.</p><p> 这几乎是一个传统，其中一个新的CDC机器中的第一个被交付给“好客户” - 由匿名卡车在工厂拾取，从未再次听过。</p><p>  One measure of information content is the  Hamming weight, which is the number of symbols in a string that are different from the zero-symbol of the alphabet. For a binary string, this is exactly  popcount!</p><p>  信息内容的一个度量是汉明权重，这是与字母零符号不同的字符串中的符号数。对于二进制字符串，这正是opcount！</p><p> As explained here, the NSA wanted to do cryptanalysis on intercepted messages, and since the CDC 6000 had 60-bit words, one word was enough to store most alphabets they were interested in. They were able to:</p><p> 如在这里解释的，NSA想在截获的消息上进行密码分析，并且由于CDC 6000有60位的单词，一个字就足以存储他们感兴趣的大多数字母。他们能够： </p><p>  Curiously,  popcount seems to have disappeared from instruction sets between the mid-1970s and the mid-2000s, so there has to be more to it than cryptographic applications to explain its return. What else can it be used for?</p><p>好奇地，PopCount似乎已经从20世纪70年代中期和2000年代中期之间的指令集中消失了，因此必须比加密应用更多地解释其返回。还有什么可以用来？</p><p>  Related to the concept of Hamming weight is  Hamming distance, which is the number of differing positions between two strings of identical length. For two binary strings  x and  y, this is just the  popcount of them XORed together. For example:</p><p>  与汉明重量的概念有关是汉明距离，这是两个相同长度之间的不同位置的数量。对于两个二进制字符串x和y，这只是他们一起xored的opcount。例如：</p><p>  For telecommunications applications, this helps us calculate the signal distance, where a known word is sent over the wire and the number of flipped bits are counted to provide an estimate of the error introduced by transmission.</p><p>  对于电信应用，这有助于我们计算信号距离，其中已知的单词被电线发送，并计数翻转比特的数量以提供通过传输引入的误差的估计。</p><p> We can then design an  error-correcting code accordingly, e.g. if we want to be robust against up to 2 flipped bits, our code words need to differ in Hamming distance by at least 5.</p><p> 然后，我们可以相应地设计错误校正代码，例如，如果我们希望对最多2个翻转位的强大，我们的代码词需要在汉明距离至少5时不同。</p><p>  And now for something completely different: binary convolutional neural networks! But first, what are they?</p><p>  而现在是完全不同的东西：二元卷积神经网络！但首先，他们是什么？</p><p> Binary means that we’re using matrices consisting of only the values +1 (coded as  1) and -1 (coded as  0), as opposed to 32-bit floating-point values.</p><p> 二进制意味着我们使用仅由值+1（编码为1）和-1（编码为0）的矩阵，而不是32位浮点值。</p><p>  Neural networks are systems inspired by animal brains (I’m a bit hazy on this part).</p><p>  神经网络是由动物大脑启发的系统（我在这部分朦胧）。 </p><p> In summary, we have to do binary matrix multiplication. But what’s special about binary matrices?</p><p>总之，我们必须进行二进制矩阵乘法。但是关于二进制矩阵有什么特别之处？</p><p> Ordinary matrix multiplication on 32-bit values is a good fit on desktop computers with powerful CPUs and GPUs, but increasingly we also want to do useful work on smaller and simpler devices, such as smartphones, routers, smartwatches, etc. We can decompose these more complex matrices into layers of binary matrices, and these resulting matrices are so much easier to store and operate on that we are better off even though there are more layers.</p><p> 32位值上的普通矩阵乘法是具有强大CPU和GPU的桌面计算机上的良好适合，但我们也想在更小型和更简单的设备上进行有用的工作，例如智能手机，路由器，智能手表等。我们可以分解这些更复杂的矩阵分成二进制矩阵层，并且这些产生的矩阵更容易存储和操作，即使有更多的层，我们也会更好。</p><p> Where does  popcount come into play? It’s used to calculate the dot product of two binary matrices:</p><p> Popcount在哪里发挥作用？它用于计算两个二进制矩阵的点乘积：</p><p> a = xnor(x, y)  b = popcount(a)  c = len(a)  dot(x, y) = 2 × b − c</p><p> a = xnor（x，y）b = popcount（a）c = len（a）点（x，y）= 2×b  -  c</p><p>   Many chess programs store data using a  bitboard representation, which conveniently fits into a 64-bit word.  Population Count has been used to perform meaningful operations with this representation, such as calculating the  mobility of a piece.</p><p>   许多国际象棋程序使用位板表示存储数据，这方便地适合64位字。人口计数已被用来使用这种表示来执行有意义的操作，例如计算一块的移动性。</p><p>  This is related to the notion of Hamming distance above: molecules are hashed in some way and compared (with  popcount) to determine how similar they are. More details on that  here.</p><p>  这与上面的汉明距离的概念有关：分子以某种方式散列并比较（用Popcount）来确定它们是多么相似的。有关这里的更多细节。</p><p>  This is where I first learned about  popcount! The HAMT is a data structure ( pioneered by Phil Bagwell) that can store a very large number of values (usually 32 or 64) in an array at each node of the trie. However, allocating memory for a 32 or 64-element array every time can be incredibly wasteful, especially if the array only actually contains a handful of elements. The solution is to add a bitmask in which the number of bits that are set corresponds to the number of elements in the array, which allows the array to grow and shrink as required. Calculating the index for a given element efficiently can then be done using  popcount. You can learn more about how they work from  this blog post, where I implement them myself.</p><p>  这是我第一次学习obcount的地方！ HAMT是数据结构（Phal Bagwell开创），可以在Trie的每个节点处存储非常大的值（通常为32或64）。但是，每次可以令人难以置信的浪费，特别是，如果阵列实际上只包含少数元素，则为32或64元素阵列分配内存。该解决方案是添加一个位掩码，其中设置的位数对应于阵列中的元素的数量，其允许阵列根据需要增长和缩小。然后可以使用popcount进行有效地计算给定元素的索引。您可以了解更多有关他们如何从本博客文章工作的更多信息，我自己实施它们。 </p><p>  This is an exciting new area of research that focuses on how to store data in as little space as possible, without having to decompress it in order to do useful work. One technique is to think in terms of arrays of bits (bitvectors), which can be queried using two operations:</p><p>这是一个激动人心的研究领域，专注于如何将数据存储在尽可能少的空间中，而无需解压缩它以便进行有用的工作。一种技术是在比特阵列（BitVectors）方面进行思考，可以使用两个操作查询：</p><p>  Making these operations efficient on large bitvectors requires constructing an index and using it effectively, both involving  popcount. There’s  a good overview of the RRR index here, and as far as I can tell the current state-of-the-art approach is described in  Space-Efficient, High-Performance Rank &amp; Select Structures on Uncompressed Bit Sequences.</p><p>  使这些操作在大型比特媒体上有效需要构建索引并有效地使用它，涉及Popcount。这里的RRR指数有很好的概述，据我所知，目前的最先进的方法在节省空间，高性能等级＆amp中描述了;在未压缩位序列上选择结构。</p><p>  popcount has become so pervasive that both  GCC and  Clang will detect an implementation of  popcount and replace it with the built-in instruction. Imagine Clippy going “I see you are trying to implement  popcount, let me go ahead and fix that for you”! The relevant LLVM code is  here. Daniel Lemire points to this as an example of  the surprising cleverness of modern compilers.</p><p>  PopCount已变得如此普遍，即GCC和Clang将检测到PopCount的实现并将其替换为内置指令。想象一下clippy去“我看到你正在努力实施popcount，让我继续为你解决这个问题”！相关的LLVM代码在这里。 Daniel Lemire指出这一点是现代编纂者令人惊讶的聪明才智。</p><p>  From beginnings shrouded in mystery,  popcount has emerged as a generally useful, if slightly unusual, CPU instruction. I love how it ties together such different fields of computing, and I wonder how many other similarly weird instructions are out there. If you have a favourite, I’d love to hear about it!</p><p>  从开头笼罩在谜团中，Popcount已经出现为一般有用的，如果略有异常，CPU指令。我喜欢它如何将这种不同的计算领域联系在一起，我想知道那里有多少奇怪的指令。如果你有一个喜欢的话，我很乐意听到它！ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://vaibhavsagar.com/blog/2019/09/08/popcount/">https://vaibhavsagar.com/blog/2019/09/08/popcount/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/nsa/">#nsa</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/popcount/">#popcount</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>