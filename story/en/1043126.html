<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我们压缩发布/订阅消息等内容，节省大量资金 We compress Pub/Sub messages and more, saving a load of money</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">We compress Pub/Sub messages and more, saving a load of money<br/>我们压缩发布/订阅消息等内容，节省大量资金 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-04 20:28:24</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/1/54515973ecc8f55f1ecf28442f3b055b.png"><img src="http://img2.diglog.com/img/2021/1/54515973ecc8f55f1ecf28442f3b055b.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Compression is a trick that can be used to solve a load of problems. Often, yourtools will compress content transparently: most modern browsers ask for gzippedHTTP payload, and some filesystems can be configured to compress blocks withoutthe user ever asking.</p><p>压缩是可以解决大量问题的技巧。通常，您的工具会透明地压缩内容：大多数现代浏览器要求使用gzippedHTTP有效负载，并且某些文件系统可以配置为压缩块而无需用户询问。</p><p> Outside of well known use cases, there are a variety of opportunities to improveefficiency or save a load of money by leveraging compression. It’s useful to beaware of common use cases, so you can take these opportunities when they arise.</p><p> 在众所周知的用例之外，还有多种机会可以通过利用压缩来提高效率或节省大量资金。留意常见用例很有用，因此您可以在机会出现时抓住这些机会。</p><p>  As a recent example, my team were migrating logs from one Elasticsearch clusterto another. While not quite Big Data™, this cluster had 10 billion log entries,or some 60TB of raw JSON.</p><p>  作为最近的示例，我的团队正在将日志从一个Elasticsearch集群迁移到另一个集群。尽管不是Big Data™，但该集群有100亿个日志条目，或大约60TB的原始JSON。</p><p> Having experience tackling long-running, large-scale migrations like this, youwant to build a process that allows you to ‘save game’ as frequently aspossible. This means you can build and run an export process, handling whateverissues will occur (they will, I promise!), then move cleanly on-to the importprocess. As with exports, your import process will also screw up: so it, too,should be easily re-runnable.</p><p> 拥有解决此类长期运行的大型迁移的经验，您想建立一个流程，使您可以尽可能频繁地“保存游戏”。这意味着您可以构建并运行导出过程，处理将发生的所有问题（我保证，它们都会发生），然后干净地移至importprocess。与出口一样，您的导入过程也会很麻烦：因此，它也应该易于重新运行。</p><p> As it is used across a load of GoCardless systems,  GooglePub/Sub is a natural fit for this problem.Google’s marketing tagline even sounds like it was written to describe ourideal, decoupled process:</p><p> 由于GooglePub / Sub可以在众多GoCardless系统中使用，因此很自然地可以解决此问题。甚至听起来Google的营销标语就是用来描述我们理想的，分离的过程的：</p><p> Pub/Sub is an asynchronous messaging service that decouples services thatproduce events from services that process events.</p><p> 发布/订阅是异步消息传递服务，该服务将产生事件的服务与处理事件的服务解耦。</p><p> In Pub/Sub, you  publish messages to topics. Each topic canhave many subscriptions, which  consumers can pull messagesfrom. In the most simple terms, the migration would:</p><p> 在发布/订阅中，您将消息发布到主题。每个主题可以拥有许多订阅，消费者可以从中订阅消息。用最简单的术语来说，迁移将： </p><p> Configure the Pub/Sub subscriptions to retain events (set retain_acked_messages, see:  Replaying and purging messages)so that we may replay them, if our import goes wrong</p><p>配置发布/订阅订阅以保留事件（设置retain_acked_messages，请参阅：重播和清除消息），以便在导入错误的情况下重播它们</p><p> So, what’s this got to do with compression? Like most Cloud services, Pub/Subcharges on usage, which means we’ll incur fees proportional to the data we’llpush through the service.</p><p> 那么，压缩与这有什么关系呢？与大多数Cloud服务一样，使用/发布会收取一定的费用，这意味着我们将收取与通过该服务推送的数据成比例的费用。</p><p>   In the best case where we import/export successfully on the first attempt (thiswon’t, and did not happen), we’ll be charged  2 x $40 x 60TB = $4,800 formessage delivery, as it will apply to both publish and subscribe. If we retainour messages for 2 weeks while the migration is on-going, we’ll be charged  0.5x $0.27 x 60,000GB = $8,100 for message storage.</p><p>   在最好的情况下，如果我们第一次尝试成功导入/导出（不会，也没有发生），我们将收取2 x $ 40 x 60TB = $ 4,800的Formessage交付费用，因为这将同时适用于发布和订阅。如果我们在迁移进行期间将邮件保留2周，则需要为邮件存储收取0.5x $ 0.27 x 60,000GB = $ 8,100的费用。</p><p>  Now, GoCardless isn’t poor. And as a rule of thumb, you normally want tooptimise for engineering hours over infrastructure cost.</p><p>  现在，GoCardless并不贫穷。根据经验，您通常需要优化工程时间而不是基础架构成本。</p><p>   To this end, we made a small change to our migration tool ( elastic-toolbox) tosupport compression of the messages we published to Pub/Sub.</p><p>   为此，我们对迁移工具（elastic-toolbox）进行了小改动，以支持压缩发布到Pub / Sub的消息。</p><p>  // Publish takes a message and publishes it to the Pub/Sub topic. If // compression is enabled, the message payload is compressed, and the // message is marked with a compress=true attribute. func  ( f  * pubsubExportTarget )  Publish ( ctx  context . Context ,  msg  Message )  error  {  data ,  _  :=  json . Marshal ( msg )  if  f . opt . Compress  {  data ,  _  =  f . compress ( data )  }  // enqueue marks a message as available to be sent, passing it  // to the Pub/Sub client  f . enqueue ( ctx ,  &amp; pubsub . Message {  Data :  data ,  Attributes :  map [ string ] string {  &#34;compress&#34; :  fmt . Sprintf ( &#34;%v&#34; ,  f . opt . Compress ),  },  })  return  nil }</p><p>  //发布会收到一条消息，并将其发布到Pub / Sub主题。如果启用//压缩，则将压缩消息有效负载，并使用compress = true属性标记//消息。 func（f * pubsubExportTarget）发布（ctx上下文。上下文，msg消息）错误{数据，_：= json。如果f则为元帅（味精）。选择。压缩{数据，_ = f。 compress（data）} //将消息标记为可发送，并将其//传递给Pub / Sub客户端f。入队（ctx，＆amp; pubsub。消息{数据：数据，属性：映射[字符串]字符串{＆＃34; compress＆＃34;：fmt。Sprintf（＆＃34;％v＆＃34;，f。 ），}，}）返回nil}</p><p>  var  (  exportPubsubWriteCompressionRatio  =  promauto . NewHistogram (  prometheus . HistogramOpts {  Name :  &#34;elastic_toolbox_export_pubsub_write_compression_ratio&#34; ,  Help :  &#34;Distribution of compression ratio&#34; ,  Buckets :  prometheus . LinearBuckets ( 0.1 ,  0.1 ,  10 ),  // 0.0 -&gt; 1.0  },  )  exportPubsubWriteCompressDurationSeconds  =  promauto . NewHistogram (  prometheus . HistogramOpts {  Name :  &#34;elastic_toolbox_export_pubsub_write_compress_duration_seconds&#34; ,  Help :  &#34;Distribution of time taken to compress hits&#34; ,  Buckets :  prometheus . ExponentialBuckets ( 0.0625 ,  2 ,  8 ),  // 0.0625 -&gt; 16s  },  ) ) // compress applies gzip compression to the incoming data, and instruments // compression efficiency. func  ( f  * pubsubExportTarget )  compress ( data  [] byte )  ([] byte ,  error )  {  defer  prometheus . NewTimer ( prometheus . ObserverFunc ( func ( v  float64 )  {  exportPubsubWriteCompressDurationSeconds . Observe ( v )  })) . ObserveDuration ()  var  buffer  bytes . Buffer  zw  :=  gzip . NewWriter ( &amp; buffer )  if  _ ,  err  :=  zw . Write ( data );  err  !=  nil  {  return  nil ,  err  }  if  err  :=  zw . Close ();  err  !=  nil  {  return  nil ,  err  }  compressed  :=  buffer . Bytes ()  exportPubsubWriteCompressionRatio . Observe (  float64 ( len ( compressed ))  /  float64 ( len ( data )))  return  compressed ,  nil }</p><p>  var（exportPubsubWriteCompressionRatio = promauto。NewHistogram（prometheus。HistogramOpts {名称：＆＃34; elastic_toolbox_export_pubsub_write_compression_ratio＆＃34;，帮助：＆＃34;压缩比的分布＆＃34;，桶：prometheus。LinearBuckets（0.1， // 0.0-＆gt; 1.0}，）exportPubsubWriteCompressDurationSeconds = promauto。NewHistogram（prometheus。HistogramOpts {名称：＆＃34; elastic_toolbox_export_pubsub_write_compress_duration_seconds＆＃34;，帮助：＆＃34;分配时间来压缩打击次数＆＃34; prometheus。ExponentialBuckets（0.0625，2，8），// 0.0625-＆gt; 16s}，））// compress将gzip压缩应用于传入的数据，并提高//压缩效率。 func（f * pubsubExportTarget）压缩（数据[]字节）（[]字节，错误）{延迟普罗米修斯。 NewTimer（prometheus.ObserverFunc（func（vfloat64）{exportPubsubWriteCompressDurationSeconds.Observe（v）}））。 ObserveDuration（）var缓冲区字节。缓冲区zw：= gzip。 New_Writer（＆amp; buffer）如果_，err：= zw。写（数据）; err！= nil {返回nil，err}如果err：= zw。关 （）; err！= nil {return nil，err}压缩：=缓冲区。字节（）exportPubsubWriteCompressionRatio。观察（float64（len（压缩（len））/ float64（len（数据）））返回压缩，nil} </p><p>  As our savings will be proportional to our compression ratio (compressed /original bytes), we care a lot about how compressible our data is.</p><p>由于我们的节省将与压缩率（压缩/原始字节）成正比，因此我们非常关心数据的可压缩性。</p><p>   Using the modified  elastic-toolbox to run an concurrent export of threedifferent indices, we can use the elastic_toolbox_export_pubsub_write_compression_ratio Prometheus metric (seethe  compress method above) to build a heatmap of compression ratios:</p><p>   使用修改后的elastic-toolbox运行三个不同索引的并发导出，我们可以使用elastic_toolbox_export_pubsub_write_compression_ratio Prometheus度量标准（请参见上面的compress方法）来构建压缩比的热图：</p><p>  This heatmap shows that all messages compressed to  at most 30% the originalsize. When measured over our entire corpus of logs, we average at a  ~12%compression ratio, meaning 1GiB of logs becomes just 120MiB.</p><p>  此热图显示所有消息最多压缩为原始大小的30％。在整个原木语料库中进行测量时，我们的平均压缩率约为12％，这意味着1GiB的原木仅为120MiB。</p><p>     The most obvious next step was to apply this to our logging pipeline all thetime. Given we ship container logs straight into Pub/Sub, pulling them out of asubscription into Elasticsearch, we can easily write a fluentd filter that applies the same compressionstrategy.</p><p>     最明显的下一步是始终将其应用于我们的日志记录管道。假设我们将容器日志直接发送到Pub / Sub中，然后将它们从订阅中拉出到Elasticsearch中，我们可以轻松编写应用相同压缩策略的流利过滤器。</p><p> My colleague Ben put together an awesome dashboard to track how much we save,which works out to be  several thousand a month:</p><p> 我的同事本（Ben）整理了一个很棒的仪表板来跟踪我们节省了多少钱，每月可以节省几千：</p><p>   If you work in a Cloud environment, there are so many opportunities to savemoney by compressing your data.</p><p>   如果您在云环境中工作，那么有很多机会可以通过压缩数据来节省金钱。</p><p> Beyond logs, another GoCardless example is a tool called draupnir. This service hosts copies ofour production databases for load testing and forensic analysis (query planprediction, etc). Google SSD storage costs $187 per TiB/month, which means everycopy of our  5TB Postgres costs $1,000/month.</p><p> 除日志外，另一个GoCardless示例是一个名为draupnir的工具。该服务托管生产数据库的副本，以进行负载测试和取证分析（查询计划预测等）。 Google SSD存储的价格为每个TiB /月187美元，这意味着我们5TB Postgres的每个副本的价格为1,000美元/月。 </p><p> Draupnir might host several copies at a time, depending on the use cases. We cansave a load of money by enabling  btrfscompression totransparently compress the filesystem blocks, allowing us to use  ~70% less SSDcapacity than we may otherwise.</p><p>Draupnir可能一次使用多个副本，具体取决于用例。通过启用btrfscompression透明地压缩文件系统块，我们可以节省大量资金，这使我们可以比其他方式少使用约70％的SSD容量。</p><p> And if you thought compression was limited to cost savings, you’d be wrong!Having suffered from occasional micro-outages when people ran large backfills orbuilt new database indexes, we solved the problem by enabling Postgres WALcompression (see  Postgres Underused Features: WAL Compression,or the  Postgres Write Ahead Log docs).</p><p> 如果您认为压缩只限于节省成本，那将是错的！当人们运行大型回填或建立新的数据库索引时，偶尔会遭受微故障的困扰，我们通过启用Postgres WALcompression解决了该问题（请参阅Postgres WusCompression）： ，或Postgres预先写日志文档）。</p><p> The outages were caused by database operations creating a large amount of WALchurn, where the replica would stall while writing the WAL to disk. Bycompressing the WAL stream, we  significantly reduced the IO spikes, allowingthe replica to handle the stream without issue.</p><p> 中断是由数据库操作导致的大量WALchurn造成的，在将WAL写入磁盘时，副本将停滞。通过压缩WAL流，我们大大减少了IO尖峰，使副本可以毫无问题地处理该流。</p><p>   Compression is a trade-off, a decision we make to trade CPU for another resourcethat might be more expensive or less available. The value assigned to CPU,memory, or network bandwidth continually changes, and you’ll need to make thiscalculation on a case-by-case basis.</p><p>   压缩是一种折衷，这是我们决定将CPU换成另一种可能更昂贵或更不可用的资源的决定。分配给CPU，内存或网络带宽的值会不断变化，因此您需要根据具体情况进行计算。</p><p> This post aimed to cover a scenario where the cost of compression, in bothcompute resource and time-to-build, was significantly outweighed by the savingsit would make. Not all situations will have the same economics, but it takes afew minutes of napkin maths to decide either way.</p><p> 这篇文章旨在介绍一种方案，在这种方案中，无论是在计算资源还是在构建时间上，压缩成本都将大大节省其成本。并非所有情况都具有相同的经济学原理，但是要用哪种方式来决定哪种方式，需要花费几分钟的时间。</p><p> I hope this case study prompts consideration of compression outside of standard,boring use-cases, and helps to find opportunities where you can apply it to yourown systems.</p><p> 我希望这个案例研究能促使人们考虑在标准，无聊的用例之外进行压缩，并有助于找到机会将其应用于自己的系统。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.lawrencejones.dev/compress-everything/">https://blog.lawrencejones.dev/compress-everything/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/发布/">#发布</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/pub/">#pub</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/压缩/">#压缩</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>