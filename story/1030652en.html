<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>为什么MyWorld从Cassandra切换到CockroachDB</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">为什么MyWorld从Cassandra切换到CockroachDB</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-23 03:46:39</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/ef74bbac00091ecd26976f0352b629df.jpg"><img src="http://img2.diglog.com/img/2020/10/ef74bbac00091ecd26976f0352b629df.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>community      Today&#39;s guest author, Daniel Perano, is a Full-Stack Developer &amp; Founder of  MyWorld. He is one of many developers building interesting projects with CockroachDB. If you&#39;d like to guest author a blog about your project please reach out on our  community slack channel.</p><p>“今日社区”的客座作者丹尼尔·佩拉诺(Daniel Perano)是“我的世界”(MyWorld)的全栈开发者和创始人。他是使用CockroachDB构建有趣项目的众多开发人员之一。如果你想客串写一篇关于你的项目的博客，请联系我们的社区闲置频道。</p><p>  MyWorld  is a next-generation virtual world startup. Current social virtual worlds (like   Second Life  and   OpenSimulator ) are built on decades-old technology and are fundamentally limited in their design. MMOG (Massive Multiplayer Online Game) developers lack a common, extensible platform, meaning that multiple years of work and millions of dollars are required to build a custom engine for almost every MMOG - forcing indie studios and many other small developers out of the market entirely. At MyWorld, we’re building a brand new virtual world platform from the ground up, using modern tools and technologies to create a fast, scalable, and extensible platform to power the next generation of social virtual worlds and massive multi-player online games.</p><p>MyWorld是下一代虚拟世界初创公司。当前的社交虚拟世界(如Second Life和OpenSimulator)是建立在几十年前的技术之上的，它们的设计从根本上是有限的。MMOG(大规模多人在线游戏)开发人员缺乏一个通用的、可扩展的平台，这意味着需要多年的工作和数百万美元才能为几乎每一个MMOG构建一个自定义引擎-迫使独立工作室和许多其他小型开发人员完全退出市场。在MyWorld，我们正在从头开始构建一个全新的虚拟世界平台，使用现代工具和技术创建一个快速、可伸缩和可扩展的平台，为下一代社交虚拟世界和大型多人在线游戏提供动力。</p><p>   In addition, we want a database that follows our own philosophy of making software that self-maintains as much as possible and requires minimal human interaction to operate. Lastly, we need any database we use to be open-source or open-core - this openness is central to MyWorld’s heritage and design philosophy, and since MyWorld will be open-sourced at some point after the alpha and beta releases we could not consider closed-source or vendor-locked databases.</p><p>此外，我们想要一个数据库，它遵循我们自己的哲学，即制作尽可能自我维护的软件，并且只需要最少的人工交互来操作。最后，我们需要我们使用的任何数据库都是开源或开放核心的-这种开放性是MyWorld传统和设计理念的核心，而且由于MyWorld将在alpha和beta发布之后的某个时候开放源代码，我们不能考虑关闭源代码或供应商锁定的数据库。</p><p> Under the hood, our tech stack builds heavily on a combination of in-house code and some of the best open-source software in the industry. The database layer is based on a lightweight ORM pattern - the   Postgres JDBC driver , a   HikariCP Connection pool , and the   jNimble ORM  with a thin layer on top of it to map our domain objects to/from SQL (all queries are handwritten for design flexibility and performance - we don’t use the automatic mapping features of jNimble right now). At a higher level, our physics engine is   Bullet  and we use the   jMonkeyEngine  game engine both server side and client side. The world simulation is handled through an in-house entity system, and scripting is done in a powerful high-level in-house scripting language (object oriented with classes, first-class functions, dynamic typing, and polymorphism). We use the   Jetty HTTP  server for our embedded HTTP needs, and the client-side UI is done with   JavaFX .</p><p>在幕后，我们的技术堆栈在很大程度上建立在内部代码和一些业内最好的开源软件的组合上。数据库层基于轻量级ORM模式-Postgres JDBC驱动程序、HikariCP连接池和jNimble ORM，上面有一个薄层，用于将我们的域对象映射到SQL或从SQL映射(为了设计灵活性和性能，所有查询都是手写的-我们现在不使用jNimble的自动映射特性)。在更高的层次上，我们的物理引擎是Bullet，我们在服务器端和客户端都使用jMonkeyEngine游戏引擎。世界模拟是通过内部实体系统处理的，脚本编写是使用强大的高级内部脚本语言(使用类、一流函数、动态类型和多态性面向对象)完成的。我们使用Jetty HTTP服务器满足嵌入式HTTP需求，客户端UI使用JavaFX完成。</p><p>  Prior to porting our database backend to use   CockroachDB , we were using Cassandra. Initially, this went well, as our data model has always been designed to be as simple and straightforward as possible in terms of database representation. However, as we grew and discovered more and more query needs, Cassandra’s denormalization patterns and lack of flexible indexing began to be a real and very noticeable constraint, especially since its severely limited range queries meant that implementing our own higher-level indices on top of its out-of-the-box functionality would be a very difficult endeavor.</p><p>在移植数据库后端以使用CockroachDB之前，我们使用的是Cassandra。最初，这很顺利，因为我们的数据模型总是被设计成在数据库表示方面尽可能简单和直接。然而，随着我们的增长和发现越来越多的查询需求，Cassandra的非规范化模式和缺乏灵活的索引开始成为一个真实且非常明显的限制，特别是因为它的范围严重受限的查询意味着在其开箱即用功能之上实现我们自己的更高级别的索引将是一项非常困难的工作。</p><p> We held out on Cassandra for as long as we could - it’s a very fast and scalable database, and it’s been tried and proven at a scale unlike any other (  Apple’s cluster surpassed 75k active nodes ). True horizontal scalability and the ability to keep operating with nodes down is critical for us. However, the more we ran into Cassandra’s limitations on our data model, the more aware we became of Cassandra&#39;s impact on our design:</p><p>我们在Cassandra上坚持了尽可能长的时间-它是一个非常快速和可伸缩的数据库，并且它已经在与任何其他数据库都不同的规模上进行了试验和验证(苹果的集群超过了75k活动节点)。真正的水平可伸缩性和在节点关闭的情况下保持操作的能力对我们至关重要。然而，我们越是遇到卡桑德拉对我们数据模型的限制，我们就越意识到卡桑德拉对我们设计的影响：</p><p> Using Cassandra was unduly influencing the model, restricting our higher-level design choices, and forcing us to maintain certain areas of data consistency at the application level instead of in the database. Some design trade-offs always have to be made in a distributed environment, but Cassandra was influencing higher-level design choices in ways a database shouldn’t.</p><p>使用Cassandra过度影响了模型，限制了我们更高级别的设计选择，并迫使我们在应用程序级别而不是在数据库中维护某些区域的数据一致性。一些设计权衡总是必须在分布式环境中进行，但是Cassandra正在以数据库不应该影响的方式影响更高级别的设计选择。</p><p> Cassandra is outstanding, but our needs were simply outgrowing what Cassandra was designed to handle.  Additionally, while Cassandra’s “ccm” tool worked well for managing local-only database clusters in development, we had growing concerns about the level of operational overhead Cassandra might require in production.</p><p>卡桑德拉很出色，但我们的需求只是超出了卡桑德拉的设计能力。此外，虽然Cassandra的“CCM”工具可以很好地管理开发中的仅限本地的数据库集群，但我们越来越担心Cassandra在生产中可能需要的运营开销水平。</p><p>  Because of our investment in Cassandra and our concerns about performance trade-offs, we were slow to initially evaluate CockroachDB. Once we tried porting some of our database code and experimenting with the areas that had been difficult with Cassandra, however, the decision almost made itself. We could model our data whichever way suited each area best, and if we needed, say, a range query over several unrelated numeric columns (which is very difficult to do efficiently in Cassandra), we could always add an index and more or less forget about it.</p><p>由于我们对Cassandra的投资以及对性能权衡的担忧，我们最初评估CockroachDB的速度很慢。然而，一旦我们尝试移植一些数据库代码，并尝试使用Cassandra时遇到困难的领域，几乎就会做出决定。我们可以以任何最适合每个区域的方式对数据建模，如果我们需要对几个不相关的数字列进行范围查询(这在Cassandra中很难高效完成)，我们总是可以添加一个索引，然后或多或少地忘记它。</p><p> Switching to SQL meant that we could model our data the way it ought to be modeled and rely on full multi-table transactions and SQL constraints to maintain data integrity. The migration from Cassandra to SQL was surprisingly painless - our data model was already in a strongly-typed tabular form, and since we had opted to write our queries as handwritten CQL (Cassandra Query Language, which is essentially a subset of SQL) instead of using an ORM, we only had to make minimal syntactic and type changes to existing queries in order to have a functional starting point running with CockroachDB.</p><p>切换到SQL意味着我们可以按照应该建模的方式对数据建模，并依赖完全的多表事务和SQL约束来维护数据完整性。从Cassandra迁移到SQL的过程出奇地轻松-我们的数据模型已经是强类型的表格形式，而且由于我们选择将查询编写为手写CQL(Cassandra查询语言，本质上是SQL的子集)，而不是使用ORM，所以我们只需对现有查询进行最小程度的语法和类型更改，就可以有一个运行CockroachDB的功能起点。</p><p> Choosing SQL meant gaining flexible indices, integrity constraints, full-featured transactions, and the ability to efficiently model our data with far more flexibility than Cassandra allowed. Choosing CockroachDB in particular meant that we could have the power of SQL, make only minimal performance trade-offs (and more importantly, have the ability to make trade-offs in ways that Cassandra just couldn’t support), make effectively no compromises on the scale of traffic and data we could handle, and operate with little human intervention.</p><p>选择SQL意味着获得灵活的索引、完整性约束、功能齐全的事务，以及以远远超过Cassandra所允许的灵活性高效地对数据建模的能力。选择CockroachDB尤其意味着我们可以拥有SQL的强大功能，只进行最低限度的性能权衡(更重要的是，能够以Cassandra无法支持的方式进行权衡)，在我们可以处理的流量和数据规模上有效地不妥协，并且操作几乎不需要人工干预。</p><p> CockroachDB’s compatibility with Postgres was another big plus for us - that meant developing our code with tried-and-proven Postgres drivers &amp; libraries, and in the worst case, the ability to switch to Postgres with little to no code modifications (albeit with a punishing hit to scalability) should something go catastrophically wrong with CockroachDB.</p><p>对我们来说，CockroachDB与Postgres的兼容性是另一个很大的优势--这意味着用久经考验的Postgres驱动程序&amp；库来开发我们的代码，在最糟糕的情况下，如果CockroachDB出现灾难性的问题，只需很少甚至不需要修改代码就可以切换到Postgres(尽管这会对可伸缩性造成严重影响)。</p><p> Last but not least, CockroachDB just works in development. When I first tried it out I tossed together a bare-bones 3 line shell script to start a 3 node cluster.</p><p>最后但并非最不重要的一点是，CockroachDB只能在开发中工作。当我第一次尝试它时，我拼凑了一个基本的3行shell脚本来启动一个3节点集群。</p><p> The initial installation and setup only took about 30 minutes, including fiddling with the clustering parameters and the built-in web dashboard. This shocked me - this just doesn’t happen with databases, especially in a clustered configuration.</p><p>初始安装和设置只花了大约30分钟，包括摆弄集群参数和内置的Web仪表板。这让我很震惊-数据库不会出现这种情况，尤其是在集群配置中。</p><p> You don’t download the software and then have a 3 node cluster up and running just like that. After I got an initial configuration that I liked, I’ve never had to spend any time fixing anything - it just doesn’t break. Cassandra’s “ccm” tool was also very effective, but every few months during a version upgrade (or just plain bad luck) something would go wrong and I would spend hours just getting the database cluster back up on my development machine. That hasn’t happened once with CockroachDB. CockroachDB’s trivial ability to adapt to both server and local development environments is a tremendous benefit for us.</p><p>您不需要下载软件，然后就像这样启动并运行一个3节点群集。在我得到了我喜欢的初始配置之后，我从来没有花费任何时间来修复任何东西-它就是不会坏。Cassandra的“CCM”工具也非常有效，但是在版本升级期间每隔几个月(或者仅仅是运气不好)就会出问题，我会花费数小时将数据库集群恢复到我的开发机器上。这种情况在CockroachDB中从未发生过一次。CockroachDB微不足道的适应服务器和本地开发环境的能力对我们来说是一个巨大的好处。</p><p>  We have not yet launched the MyWorld platform to the public. Our first public beta releases are scheduled to happen in Q2 of 2020. Right now, we’re running a lightweight 3 node cluster on a dev machine. We anticipate adoption around the globe, which means we’ll need to geo-distribute our clusters to keep latencies down for users and to comply with the GDPR and other data localization regulations worldwide. While we’re committed to gathering only as much personal user data as is critical for operation (such as email addresses for accounts and IP address logs for intrusion detection), the data we do collect may be subject to data locality laws - so we’ll likely need CockroachDB’s geo-partitioning feature to keep our users’ data in the countries where it belongs.</p><p>我们还没有向公众推出MyWorld平台。我们的第一个公开测试版计划在2020年第二季度发布。现在，我们在一台开发机器上运行一个轻量级的3节点集群。我们预计将在全球范围内采用，这意味着我们将需要在地理上分布我们的集群，以降低用户的延迟，并遵守GDPR和其他全球数据本地化法规。虽然我们承诺只收集对操作至关重要的个人用户数据(例如帐户的电子邮件地址和入侵检测的IP地址日志)，但我们收集的数据可能会受到数据地方性法律的约束-因此我们可能需要CockroachDB的地理分区功能来将用户数据保存在它所属的国家/地区。</p><p> If you’re evaluating CockroachDB for your own product, I’d highly recommend just   downloading  it and running a few queries from the command line - you’ll quickly get a good feel for how it handles in development. [  Editor&#39;s note:  CockroachCloud is another option for getting up and running quickly--it&#39;s our fully managed and hosted database-as-a-service.   Get started here.] If you have an existing codebase that you’re considering porting, take your time to go through the   migration guides  and the   feature support page  - I’ve found the documentation to be comprehensive and clear about what’s supported, what’s not, and any caveats you should be aware of.</p><p>如果您正在为您自己的产品评估CockroachDB，我强烈建议您只下载它并从命令行运行几个查询-您很快就会对它在开发中的处理方式有一个很好的感觉。[编者按：CockroachCloud是另一个快速启动和运行的选择--它是我们完全托管和托管的数据库即服务。我们从这里开始。]。如果您有正在考虑移植的现有代码库，请慢慢来阅读迁移指南和功能支持页面-我发现文档全面而清晰地说明了哪些是受支持的，哪些是不受支持的，以及您应该知道的任何注意事项。</p><p> I’ll follow up on this blog post with a ‘part 2’ to discuss database performance in production after we’ve launched the MyWorld platform and grown our user-base. In the meantime, if you’d like to know more about MyWorld or follow our progress, check out our   website , follow us on   Twitter  or   Facebook , or come chat with us on   Discord or in the  CockroachDB community slack !</p><p>在这篇博客文章之后，我将用一个“第2部分”来讨论在我们推出MyWorld平台并扩大用户群之后生产中的数据库性能。同时，如果您想了解更多关于“我的世界”或关注我们的进展，请访问我们的网站，在Twitter或Facebook上关注我们，或者来与我们就不和谐或在CockroachDB社区闲聊！</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.cockroachlabs.com/blog/cassandra-to-cockroachdb/">https://www.cockroachlabs.com/blog/cassandra-to-cockroachdb/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/cassandra/">#cassandra</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/switched/">#switched</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>