<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>保护交换机</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">保护交换机</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-03 03:33:27</div><div class="page_narrow text-break page_content"><p>这个基于OOP的解决方案在添加新操作符时确实具有很强的可扩展性，上面的示例缺少减法运算。我们可以通过定义一个新类来添加一个：</p><p>案例类Sub(Left：Expression，Right：Expression)扩展表达式{def eval：Double=Left。伊瓦尔-对。Eval}。</p><p>这真是太棒了--我们根本不用碰任何旧代码！哎呀，这里绝对是石头。</p><p>想象一下，在接下来的几年里，您继续使用更多的运算类来扩展我们的计算引擎，添加了乘法、除法、模数、变量、对数、三角函数等。</p><p>然后突然出现了一个新的要求--用户不仅要计算表达式的值，还要进行符号操作--例如简化表达式。例如，给定表达式a+a，他们希望得到表达式2*a作为结果。</p><p>此要求不能由表达式接口上的eval方法捕获。我们需要一种新的方法：</p><p>下一步，他们可能希望能够将表达式显示为字符串：</p><p>您现在需要更改多少个代码单元才能实现这些功能？表达式的所有实现。在触及所有类之前，代码甚至不会编译。看起来，在这种功能的上下文中，我们的多态解决方案是非常不可扩展的。</p><p>让我们退后一步，让我们看看如何以不同的方式实现这一点。Scala和许多其他现代语言都有一个称为模式匹配的功能，可以认为这是一个非常灵活、功能强大的开关。</p><p>我们不在Case类上定义eval或simplify这样的操作，而是把它们拉出来：</p><p>特征表达式{case类const(Value：Double)扩展表达式case类Add(Left：Expression，Right：Expression)扩展表达式def eval(e：Expression)：Double={e Match{case const(X)=&gt；x case add(a，b)=&gt；a+b}}。</p><p>现在，添加像Sub这样的新操作需要对代码进行两次更改-在Match(Switch)语句中添加一个新类和添加一个新案例。</p><p>有些人可能会说这更糟糕，这不仅是因为有更多的地方需要更新，还因为有可能忘记更新开关，这可能会由于未处理的情况而导致运行时错误。幸运的是，Scala设计人员通过提供Seal关键字来考虑这一点，该关键字指示编译器所有的Case类只能定义在同一个模块中。这将解锁模式穷举分析，编译器将警告丢失的案例：</p><p>密封特征表达式案例类const(value：Double)扩展表达式案例类Add(Left：Expression，Right：Expression)扩展表达式def eval(e：Expression)：Double={e Match{case const(X)=&gt；x case add(a，b)=&gt；a+b}}。</p><p>添加像Simplify或ToString这样的新函数怎么样？它只需要在一个地方长乐-通过添加所需的方法。无需更改现有代码！</p><p>定义简化(e：表达式)：表达式={e匹配{case add(const(0)，x)=&gt；x case add(x，const(0))=&gt；x case Other=&gt；Other}}def toString(e：表达式)：字符串={e Match{case const(X)=&gt；x。ToString大小写add(a，b)=&gt；&#34；(&#34；+toString(A)+&#34；+&#34；+toString(B)+&#34；)}}</p><p>我在简介中提到的博客文章指出，使用多态性而不是分支可以产生更具可读性的代码。我觉得这个说法太笼统了，实际上非常值得商榷。</p><p>首先，即使在该博客作者给出的他们自己的示例中，使用分支的解决方案也比使用OOP的解决方案更短、更简单。虽然简短的代码并不总是比较长版本的代码更具可读性，但在这种情况下，我发现分支非常明确且易于遵循。理解这样的程序中的控制流要容易得多，因为所有目标都显式地给出在一个地方。在OOP解决方案中，实际的实现隐藏在接口后面，如果没有具有“跳转到实现”特性的优秀IDE的额外帮助，要找到它们要困难得多(幸运的是，这通常适用于静态类型的语言，但我见过IDE有时很难处理Python这样的动态语言)。</p><p>其次，在一般情况下，分支有一个优点，即函数逻辑可能依赖于多个对象类型，甚至依赖于实际数据。例如，在本文的示例中，转换a*(b+c)=&gt；a*b+a*c将同时取决于加法和乘法。在经典的OOP解决方案中，您会将其放在Add类中还是MUL类中？这两种说法似乎都不对。此外，将其放入其中一个会创建对另一个的依赖。一个代码分散、跨越多个类、严重依赖于彼此的表达式简化程序将很难理解。</p><p>这是一个关于高性能编程的博客，所以如果没有关于性能的部分，这篇文章将是不完整的。从理论上讲，一个足够好的编译器应该生成相同的代码，而不管是选择分支还是动态多态性，但实际情况是这样的吗？编译器有其局限性，通常不会生成可能的最佳结果代码。</p><p>这一次让我们考虑一个更现实的例子。不久前，我在数据库系统中序列化/反序列化代码时，偶然发现了一组描述数据类型的类。它们都实现了一个公共接口，定义了用于序列化和反序列化给定数据类型的值以及计算序列化数据长度的方法。下面的铁锈代码片段是对该代码的极大简化，但它说明了概念：</p><p>Pub特征数据类型{fn len(&amp；self)-&gt；usize；}pub struct BoolType；pub struct IntType；pub struct LongType；实施BoolType的数据类型{fN len(&amp；self)-&gt；usize{1}}IntType的实施数据类型{fn(&amp；self)-&gt；usize{4}}实施长度类型的数据类型{fn。Usize{8}}pub fn data_len(data_type：&amp；dyn dataType)-&gt；usize{data_type.len()}。</p><p>在给定对DataType对象的引用的情况下，在不知道确切的静态类型的情况下计算与其关联的数据大小是很容易的：</p><p>让T1=IntType；让T2=LongType；让v：vec&lt；&amp；dyn dataType&gt；=vec！[&amp；t1，&amp；t2]；println！(&#34；{}&#34；，data_len(v[0]))；//打印4 println！(&#34；{}&#34；，data_len(v[1]))；//打印8</p><p>设mut data=vec：：&lt；dataType&gt；：：new()；设mut rng=rand：：thread_rng()；for i in 1..。1000000{匹配rng.GEN_RANGE(0，3){0=&gt；data.ush(dataType：：booltype)，1=&gt；data.ush(dataType：：inttype)，2=&gt；data.ush(dataType：：LongType)，_=&gt；{}让mut=0；用于0中的i。1000{for data.iter(){len+=data_len(Dt)；}}println！(&#34；总len：{}&#34；，len)；</p><p>这段代码中没有分支！编译器注意到一个简单的查找表就可以完成这项工作。所以不仅矢量现在是完全平坦的，没有指针追逐，而且也没有跳跃。这对性能的影响非常显著：</p><p>1 762，37毫秒任务时钟#1,000 CPU使用了8个上下文开关#0,005 K/秒0 CPU迁移#0,000 K/秒387页错误#0,220 K/秒6 361 343 641周期#3,610 GHz 10 053 423 994指令#1，58 INSN/周期3 009 768 006分支#1707,796M/秒1 127 367分支-未命中#0，04%的所有分支33 221 LLC-加载-未命中1,127367。</p><p>那几乎快了4倍！分支未命中和LLC未命中的数量至少低两个数量级。</p><p>当然，您可能会发现，在更复杂的情况下，分支会产生与虚拟表分派完全相同的性能，因为开关/匹配通常也是由跳转表实现的。但是，通常情况下，分支为编译器提供了更大的优化灵活性，因为所有的跳转目标都是事先知道的。在虚拟分派的情况下，静态编译器在编译时可能不知道所有的跳转目标，因此通常这类代码更难优化。</p><p>当我们想要通过添加类型来扩展程序时，多态性的伸缩性很好，但是当我们想要在这些类型上添加函数时，它的伸缩性就不好。</p><p>当我们想要通过添加函数来扩展程序时，分支的伸缩性很好，但是当我们想要添加类型时，它的伸缩性就不好。</p><p>当分派目标依赖于多个类型时，分支是一种更干净的解决方案。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://pkolaczk.github.io/in-defense-of-switch/">https://pkolaczk.github.io/in-defense-of-switch/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/保护/">#保护</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/defense/">#defense</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/表达式/">#表达式</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1020333.html"><img src="http://img.diglog.com/img/2020/8/thumb_1cd4841f37379f87665f9c36969d7755.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1020333.html">把半个世界变成自然保护区的计划</a></div><span class="my_story_list_date">2020-8-26 13:18</span></div><div class="col-sm"><div><a target="_blank" href="/story/1019752.html"><img src="http://img.diglog.com/img/2020/8/thumb_b0197cfaf07f8570688269f4df4f7d4d.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019752.html">保护庞贝的最新项目揭开了新的宝藏</a></div><span class="my_story_list_date">2020-8-22 15:29</span></div><div class="col-sm"><div><a target="_blank" href="/story/1017097.html"><img src="http://img.diglog.com/img/2020/8/thumb_fc7f0fc1e81a2cf72e6d7a80142f17d2.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1017097.html">倾听沉默：为什么我们必须保护世界上的宁静之地</a></div><span class="my_story_list_date">2020-8-9 12:3</span></div><div class="col-sm"><div><a target="_blank" href="/story/1016464.html"><img src="http://img.diglog.com/img/2020/8/thumb_79c60a7812b173eb415ad4c6984c2ba0.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1016464.html">以貌取人：时不时地保护文字</a></div><span class="my_story_list_date">2020-8-6 1:11</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>