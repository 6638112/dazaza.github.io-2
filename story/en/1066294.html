<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>保持稳定的protobuf api Maintaining a Stable Protobuf API</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Maintaining a Stable Protobuf API<br/>保持稳定的protobuf api </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-06-17 04:24:03</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/6/78d37a228c46be5bb70f63a30d2ddff2.jpg"><img src="http://img2.diglog.com/img/2021/6/78d37a228c46be5bb70f63a30d2ddff2.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Congrats!You’ve hit a stable release or maybe you haven’t and instead customers have already decided to depend on your API.Rather than pulling the rug out from beneath your users, you’ve taken it upon yourself to keep everyone happy.Now that you’ve been tasked with maintaining API compatibility, you’ll need a guiding light  to copy for inspiration.For many developers,  Stripe is that holy grail of API compatibility:Applications with payments systems written using the Stripe API over a decade ago still function today without changes.While we should all aspire to have a comparable compatibility story, not everyone is using the same technology stack.What does maintaining an API at Stripe’s level look like if you’re using gRPC/Protobuf rather than JSON/HTTP?</p><p>恭喜！你已经达到了稳定的发布，或者也许你没有，而且客户已经决定依靠你的api.rather而不是从你的用户下面拉出地毯，你把它拿到了自己以让每个人都快乐。既然，您已经任务维护API兼容性，您需要一个指导灯来复制灵感。对于许多开发人员来说，条纹是API兼容性的圣杯：具有在十一十年前使用STRIFE API编写的付款系统的应用程序仍然在今天没有更改的功能。虽然我们应该渴望拥有可比的兼容性故事，而不是每个人都使用相同的技术堆栈。如果您使用GRPC / PROTOBUF而不是JSON / HTTP，那么在条纹级别的情况下维护API是什么样的？</p><p>  At  Authzed, we’ve begun our journey towards diligent Protobuf API versioning.Our initial goals are to:</p><p>  在Authzed中，我们已经开始推动努力Protobuf API版本化。我们的最初目标是：</p><p> Catch breaking changes before they ship and release a new version of the API if need be</p><p> 如果需要，在发货并释放新版本之前捕获打破更改</p><p> The starting place for us was obvious: migrate our existing ad-hoc Protobuf setup to the  Buf toolchain.Buf is a new, faster Protobuf compiler, but compilation speed isn’t why we’re switching: we’re sold on its robust feature-set.</p><p> 我们的起点是显而易见的：将我们现有的Ad-hoc protobuf设置迁移到Buf Toolchain.buf是一个新的，更快的protobuf编译器，但编译速度不是为什么我们正在切换：我们在其强大的功能上销售-放。</p><p>  Our previous workflow had been to read the Protobuf documentation to determine whether or not a change is backwards compatible.Occasionally, we’d spend time testing out code locally just to ensure that a change is wire-compatible.This is time consuming and adds a requirement for more tribal knowledge from our team of developers.</p><p>  我们以前的工作流程是阅读protobuf文档以确定更改是否向后兼容.Castally，我们将在本地度过时间，只是为了确保改变是线兼容的。这是耗时和增加的要求我们开发人员团队的更多部落知识。</p><p> Buf eliminates this concern with  breaking change detection that can be built into CI/CD workflows.Going forward, we’ll be able to publish an official versioning and deprecation policy, which can be easily and confidently enforced with Buf.</p><p> Buf消除了这种关注的疑虑，可以将可以内置为CI / CD工作流程的破坏性变化检测。前进，我们将能够发布官方版本控制和弃用策略，这可以通过BUF轻松而自信地强制执行。</p><p>  Even though we’ve worked with Protobuf APIs in the past and even have a Xoogler on the team that has worked on the internal Protobuf tooling team at Google, we still struggle to write and maintain idiomatic objects and service definitions.Buf has a massive index of linting rules and presets like those used at Google and Uber.These linting rules are the culmination of experience from years of engineering and are a great source to learn from.The  linting documentation includes descriptions of the common rules and justifications for why they should be applied.These idioms include package naming, which in turn describes how to best version your packages, too!</p><p>  即使我们在过去的Protobuf API工作，甚至在Google的内部Protobuf工具团队上工作的团队中甚至有一个Xoogler，我们仍然努力编写和维护惯用物体和服务定义.Buf具有大量索引Linting规则和预设，如谷歌和优步使用的规则。这些提示规则是从多年工程经验的高潮，并且是一个伟大的学习来源，从而借鉴文献包括常见规则和理由的描述适用。这些成语包括包命名，又描述了如何最好的版本您的包裹！ </p><p> We’re currently sticking with the defaults which we’ve found quite sane.However, there’s a fine balance between following idioms and making trade-offs for user experience; not every idiom yields nice to work with code generated in each language.When we eventually run into particular rules that choose to ignore, Buf makes  exceptions a single-line change.</p><p>我们目前坚持我们发现的默认值。但是，在以下习语之间有一个很好的平衡，并为用户体验提供权衡;并非每个成语都很好地处理了每种语言中生成的代码。当我们最终遇到了选择忽略的特定规则时，Buf会使单行更改进行异常。</p><p>  Before Buf, we had shell scripts for generating code from our Protobuf service definitions.Each shell script varied from project to project and had to include additional logic like determining where the script was executed relative to where our  .proto files live.Only afterwards could we focus on passing the right flags to  protoc to generate code.All of this, however, is already built into Buf, allowing us to abandon our shell scripts entirely.</p><p>  在BUF之前，我们有shell脚本，用于从Protobuf服务定义中生成代码.ECHEL脚本从项目变为项目，并且必须包含其他逻辑，如确定脚本相对于我们的.proto文件的位置。之后，我们可以重点关注将右标志传递给Protoc以生成代码。然而，这已经内置于Buf中，允许我们完全放弃我们的shell脚本。</p><p> Now we have a  buf.gen.yaml that specifies our plugins&#39; arguments.By adding a  shebang to the beginning of the YAML file, we even make it so you can easily  execute the YAML file to generate the code for a project:</p><p> 现在我们有一个buf.gen.yaml，指定我们的插件和＃39; Arguments.by添加一个shebang到yaml文件的开头，我们甚至可以使您可以轻松地执行yaml文件以生成项目的代码：</p><p> #!/usr/bin/env -S buf generate ../protos --template version:  &#34;v1beta1&#34; plugins: -  name:  &#34;go&#34;  out:  &#34;pkg/proto&#34;  opt:  &#34;paths=source_relative&#34; -  name:  &#34;go-grpc&#34;  out:  &#34;pkg/proto&#34;  opt:  &#34;paths=source_relative&#34; -  name:  &#34;validate&#34;  out:  &#34;pkg/proto&#34;  opt:  &#34;paths=source_relative,lang=go&#34;</p><p> ＃！/ usr / bin / env -s buf generate ../protos --template版本：＆＃34; v1beta1＆＃34;插件： - 名称：＆＃34; Go＆＃34;出：＆＃34; pkg / proto＆＃34;选择：＆＃34;路径= source_relative＆＃34; - 名称：＆＃34; go-grpc＆＃34;出：＆＃34; pkg / proto＆＃34;选择：＆＃34;路径= source_relative＆＃34; - 名称：＆＃34;验证＆＃34;出：＆＃34; pkg / proto＆＃34;选择：＆＃34;路径= source_relative，lang = go＆＃34;</p><p>  Now our devs don’t even have to learn how to use Buf: our config files know how to run themselves and CI/CD pipelines can handle the rest.</p><p>  现在我们的DEV甚至不必学习如何使用BUF：我们的配置文件知道如何运行自己，并且CI / CD管道可以处理其余的。</p><p>  This is just the beginning for our service’s API.We know you can never truly escape  Hyrum’s Law, but these are our first steps towards minimizing the impact of the changes we make.Buf enabled us to fly past the first step of validating our APIs and now we can focus on building out API metrics that will be used for data-driven decision-making for our deprecation policies and API design efforts.We’re extremely excited for the future Buf and its impact on the ecosystem of Protobuf tooling.</p><p>  这只是我们服务的API的开始。我们知道你永远无法真正逃避Hyrum的法律，但这些是我们最大限度地减少我们Make.Buf使我们能够通过验证我们API的第一步的第一步现在，我们可以专注于构建一个API指标，这些指标将用于数据驱动的决策，以便我们的弃用政策和API设计努力。我们对未来的BUF非常兴奋及其对Protobuf工具生态系统的影响。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://authzed.com/blog/buf">https://authzed.com/blog/buf</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/protobuf/">#protobuf</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/stable/">#stable</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/buf/">#buf</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>