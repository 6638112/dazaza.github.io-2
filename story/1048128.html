<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>QWaitCondition：解决不可避免的比赛（2014） </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">QWaitCondition：解决不可避免的比赛（2014） </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-02-18 05:31:27</div><div class="page_narrow text-break page_content"><p>这是我如何（没有）解决影响QWaitCondition的竞争条件的故事，并且在所有其他条件变量实现（pthread，boost，std :: condition_variable）上也存在。</p><p> 如果满足条件变量，则bool QWaitCondition :: wait（int timeout）应该返回true，如果超时则返回false。比赛是即使它实际上被唤醒了，它也可能返回false（超时）。</p><p> 该问题已经在2012年报告过。但是，我只是在David Faure试图修复由该比赛引起的QThreadPool中的另一个错误时才开始研究它。</p><p>   QMutexLocker储物柜（＆amp;互斥锁）; taskQueue。 append（任务）; //（（waitingThreads＆gt; 0）{//已经有正在运行的空闲线程。他们正在等待＆＃39; runnableReady＆＃39; // QWaitCondition。叫醒他们一个。等待线程-; runnableReady。 awawOne（）;}否则if（runningThreadCount＆maxThreadCount）{startNewThread（task）;}</p><p>  无效的QThreadPoolThread :: run（）{QMutexLocker更衣室（＆amp; manager-＆gt;互斥锁）; while（true）{/ * ... * / if（manager-＆gt; taskQueue。isEmpty（））{//没有待处理的任务，请等待一个。布尔已过期=！经理-＆gt; runnableReady。等待（更衣室。互斥（），管理器-> expiryTimeout）;如果（已过期）{manager-＆gt; runningThreadCount--;返回; }其他{继续； } QRunnable * r = manager-＆gt; taskQueue。 takeFirst（）; //运行任务柜。开锁（）; -跑（）;储物柜。 relock（）; }}</p><p> 这个想法是线程将等待一个任务给定的秒数，但是如果在给定的时间内没有添加任何任务，则该线程将到期并终止。这里的问题是我们依赖于的返回值runnableReady。如果有一个任务计划在线程到期的同时进行，则该线程将看到false并将到期。但是主线程不会重新启动任何其他线程。这将使应用程序挂起，因为该任务将永远不会运行。</p><p>  条件变量的许多实现都有相同的问题。它甚至记录在POSIX文档中： </p><p>[W]当pthread_cond_timedwait（）返回超时错误时，由于超时到期和谓词状态更改之间不可避免的竞争，关联的谓词可能为true。</p><p> pthread文档将其描述为不可避免的竞争。等待条件与互斥量相关联，该互斥量在调用wake（）时由用户锁定，并且也传递给了wait（）锁定状态。该实现应该解锁并自动进行等待。</p><p> C ++ 11标准库的condition_variable甚至具有用于返回代码的枚举（cv_status）。 C ++标准没有记录比赛，但是我尝试过的所有实现都遭受了比赛的困扰。 （因此，没有实现符合要求。）</p><p> 让我尝试更好地解释比赛：此代码显示了QWaitCondition的典型用法</p><p>  竞争是线程2中的等待条件超时并返回false，但与此同时，线程1唤醒了该条件。可以预料，由于所有内容均受互斥锁保护，因此不应发生这种情况。在内部，等待条件会解锁内部互斥锁，但不会在用户互斥锁再次锁定后检查是否尚未唤醒它。</p><p> QWaitCondition具有内部状态，该状态对等待的QWaitCondition数量和等待被唤醒的QWaitCondition数量进行计数。让我们回顾一下QWaitCondition的实际代码（为便于阅读而进行了编辑）</p><p> bool QWaitCondition :: wait（QMutex * Mutex，unsigned long）{// [...] pthread_mutex_lock（＆amp; d-＆gt;互斥锁）; ++ d-＆gt;服务员;互斥锁->开锁（）; //（为简明起见）int code = 0;做{code = d-＆gt; wait_relative（时间）; //调用pthread_cond_timedwait}，同时（code == 0＆amp; d-＆gt;唤醒== 0）; -d-＆gt;服务员; if（code == 0）-d->唤醒； // [!!] pthread_mutex_unlock（＆amp; d-＆gt;互斥锁）;互斥锁->锁（）;返回代码== 0;} void QWaitCondition :: awakOne（）{pthread_mutex_lock（＆amp; d-＆gt;互斥体）; d-唤醒次数= qMin（d->唤醒次数+ 1，d->服务员）; pthread_cond_signal（＆amp; d-＆gt; cond）; pthread_mutex_unlock（＆amp; d-＆gt;互斥锁）;} </p><p>请注意，d-> mutex是本机pthread互斥量，而局部变量互斥量是用户互斥量。在标有[!!]的行中，我们有效地拥有唤醒权限，但是我们在锁定用户之前执行了此操作39; s互斥。如果我们再次检查用户锁下的服务员该怎么办？</p><p>  bool QWaitCondition :: wait（QMutex * Mutex，unsigned long）{//与以前相同：pthread_mutex_lock（＆amp; d-＆gt; Mutex）; ++ d-＆gt;服务员;互斥锁->开锁（）;整数代码= 0;做{code = d-＆gt; wait_relative（时间）; //调用pthread_cond_timedwait}，同时（code == 0＆amp; d-＆gt;唤醒== 0）; // --d-＆gt;侍者; //如果（code == 0）-d-＆gt;唤醒； pthread_mutex_unlock（＆amp; d-＆gt;互斥锁）;互斥锁->锁（）; //现在再次检查唤醒：pthread_mutex_lock（＆amp; d-＆gt;互斥锁）; -d-＆gt;服务员; if（code！= 0＆amp; d-＆gt;唤醒）{//检测并纠正了种族-d-＆gt;唤醒；代码= 0; } pthread_mutex_unlock（＆amp; d-＆gt;互斥锁）;返回代码== 0;}</p><p> 至此，我们已经解决了比赛！我们只需要再次锁定内部互斥锁，因为d-> waiters和d-> wakeups需要受到它的保护。我们需要解锁它，因为在锁定内部互斥锁的情况下锁定用户的互斥锁可能会导致死锁，因为不遵守锁定顺序。</p><p> 但是，我们现在引入了另一个问题：如果有三个线程，则可能在一个线程被唤醒之前</p><p> //线程1 //线程2 //线程3mutex-＆gt; lock（）cond-＆gt; wait（mutex）;互斥锁-> lock（）cond-> wake（）;互斥锁-> unlock（）互斥锁-> lock（）cond-> wait（mutex，0）;</p><p> 我们不希望线程3窃取线程1的信号。但是，如果线程1的睡眠时间太长并且在线程3到期之前没有设法及时锁定内部互斥锁，则可能会发生这种情况。</p><p> 解决此问题的唯一方法是，如果我们可以在线程开始等待之前对其进行排序。受比特币区块链的启发，我在线程堆栈上创建了代表顺序的节点的链表。当线程开始等待时，它将自己添加到双链表的末尾。当一个线程唤醒其他线程时，它标记了链表的最后一个节点。 （通过增加节点内的唤醒计数器）。当线程超时时，它将检查该线程是否已被标记，或在链接列表中是否在该线程之后被标记。我们只在那种情况下解决比赛，否则我们认为这是超时。 </p><p>该补丁添加了很多代码，以添加和删除链表中的节点，并遍历该列表以检查我们是否确实被唤醒。链表由等待线程数限制。我期望与QWaitCondition的其他费用相比，此链表处理可以忽略不计</p><p> 但是，QWaitCondition基准测试的结果表明，在10个线程和高竞争的情况下，我们要付出约10％的代价，在5个线程中要付出约5％的代价。</p><p> 付出这笔罚款来解决比赛是否值得？到目前为止，我们决定不合并补丁并继续比赛。</p><p>  可以解决比赛，但是对性能的影响很小。这些实现均未尝试解决竞赛。我想知道如果您不能依靠它，为什么甚至根本没有返回状态。</p><p>  Woboq是一家软件公司，专门从事Qt和C ++的开发和咨询。雇用我们！</p><p>  如果您喜欢此博客并希望阅读类似的文章，请考虑通过我们的RSS feed（通过Google Feedburner，隐私权政策）订阅，通过电子邮件订阅（通过Google Feedburner，隐私权政策），或者在twitter上关注我们，或者在G +上添加我们。</p><p>      加载评论...加载评论会嵌入来自disqus.com的外部小部件。查看Disqus隐私权政策以获取更多信息。 </p><p>当我们发布新的有趣文章时，您将获得通知！ 单击以通过RSS或电子邮件在Google Feedburner上进行订阅。 （外部服务）。 单击以查看Google Feedburner的隐私权政策。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://woboq.com/blog/qwaitcondition-solving-unavoidable-race.html">https://woboq.com/blog/qwaitcondition-solving-unavoidable-race.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/解决/">#解决</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/solving/">#solving</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/线程/">#线程</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1046035.html"><img src="http://img2.diglog.com/img/2021/1/thumb_2652ea4ae722d58655d63636ce8614f3.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1046035.html">执法如何解决智能手机的加密问题 </a></div><span class="my_story_list_date">2021-1-24 3:41</span></div><div class="col-sm"><div><a target="_blank" href="/story/1044832.html"><img src="http://img2.diglog.com/img/2021/1/thumb_2af8a85c6fc67bad76645c605ea7123a.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1044832.html">Parler网站似乎恢复在线，并承诺“解决摆在我们面前的任何挑战” </a></div><span class="my_story_list_date">2021-1-18 11:45</span></div><div class="col-sm"><div><a target="_blank" href="/story/1044460.html"><img src="http://img2.diglog.com/img/2021/1/thumb_f73267d2d9c3d8a365b8b2877cf04126.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1044460.html">一切都被打破 </a></div><span class="my_story_list_date">2021-1-16 6:59</span></div><div class="col-sm"><div><a target="_blank" href="/story/1041196.html"><img src="http://img2.diglog.com/img/2020/12/thumb_4732d5dcba5e730aa32862b1d646bb8d.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1041196.html">人工智能解决了薛定ding方程 </a></div><span class="my_story_list_date">2020-12-22 10:15</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>