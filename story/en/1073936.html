<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>在OpenBSD上调试Ioctl问题Debugging an Ioctl Problem on OpenBSD</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Debugging an Ioctl Problem on OpenBSD<br/>在OpenBSD上调试Ioctl问题</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2022-02-18 22:15:35</div><div class="page_narrow text-break page_content"><p>I was trying to use a  V4L2 Ruby moduleon my OpenBSD laptop but ran into a problem where sending the V4L2  ioctls fromthis module would fail, while other V4L2 programs on OpenBSD worked fine.</p><p>我试图在我的OpenBSD笔记本电脑上使用V4L2 Ruby模块，但遇到了一个问题，从该模块发送V4L2 IOCTL将失败，而OpenBSD上的其他V4L2程序工作正常。</p><p> Since I got a few questionsrecently about kernel development and debugging, I thought I’d write up how Ifinally tracked it down and fixed it.(Spoiler: it was not an OpenBSD problem.)</p><p>由于我最近收到了一些关于内核开发和调试的问题，我想我应该写下我最终是如何找到并修复它的。（剧透：这不是OpenBSD的问题。）</p><p>    After first getting the module to compile on OpenBSD,I ran some simple Ruby code to set the parameters and start fetching data frommy camera:</p><p>首先在OpenBSD上编译模块后，我运行了一些简单的Ruby代码来设置参数，并开始从我的相机获取数据：</p><p>     ... struct v4l2_format fmt;... BZERO(fmt); fmt.type = V4L2_BUF_TYPE_VIDEO_CAPTURE; fmt.fmt.pix.width = wd; fmt.fmt.pix.height = ht; fmt.fmt.pix.pixelformat = fcc; fmt.fmt.pix.field = V4L2_FIELD_INTERLACED; err = xioctl(fd, VIDIOC_S_FMT, &amp;fmt); if (err &lt; 0) {	perror(&#34;ioctl(VIDIOC_S_FMT)&#34;);	...</p><p>... 结构v4l2_格式fmt；。。。BZERO（fmt）；fmt。type=V4L2_BUF_type_VIDEO_CAPTURE；fmt。fmt。皮克斯。宽度=wd；fmt。fmt。皮克斯。高度=ht；fmt。fmt。皮克斯。pixelformat=fcc；fmt。fmt。皮克斯。场=V4L2_场_交错；err=xioctl（fd、VIDIOC___FMT和FMT）；如果（err&lt；0）{perror（&#34；ioctl（VIDIOC___FMT）&#34；）。。。</p><p> The module is using a macro for  BZERO that just calls  bzero, and an  xioctlwrapper that retries  ioctl when it fails with  errno == EINTR.</p><p>该模块正在使用一个只调用BZERO的BZERO宏，以及一个xioctlwrapper，当ioctl失败且errno==EINTR时，它将重试ioctl。</p><p>  bzero(&amp;fmt, sizeof(struct v4l2_format));	fmt.type = d-&gt;buf_type;	fmt.fmt.pix.width = vid-&gt;width;	fmt.fmt.pix.height = vid-&gt;height;	fmt.fmt.pix.pixelformat = encs[vid-&gt;enc].id;	fmt.fmt.pix.field = V4L2_FIELD_ANY;	if (ioctl(d-&gt;fd, VIDIOC_S_FMT, &amp;fmt) &lt; 0) {		warn(&#34;VIDIOC_S_FMT&#34;);		return 0;	}</p><p>bzero（&amp；fmt，sizeof（struct v4l2_格式））；fmt。类型=d-&gt；buf_型；fmt。fmt。皮克斯。宽度=视频-&gt；宽度fmt。fmt。皮克斯。高度=视频-&gt；身高fmt。fmt。皮克斯。pixelformat=encs[vid-&gt；enc]。身份证件fmt。fmt。皮克斯。field=V4L2_field_ANY；如果（ioctl（d-&gt；fd，VIDIOC___FMT，&amp；FMT）&lt；0）{warn（&#34；VIDIOC#u S#u FMT&#34；）；返回0；	}</p><p> I tried changing the field to  V4L2_FIELD_ANY to match the OpenBSD utility, butit still failed with  ENOTTY.</p><p>我尝试将字段更改为V4L2_field_ANY以匹配OpenBSD实用程序，但在ENOTTY中仍然失败。</p><p> I usually turn to  ktraceto diagnose syscall issues, but in this case it just showed that it was calling ioctl on a filehandle 14, sending it  VIDIOC_S_FMT, and passing some data (a v4l2_format struct).</p><p>我通常会求助于KTrace来诊断系统调用问题，但在本例中，它只是显示它正在对文件句柄14调用ioctl，向其发送VIDIOC_S_FMT，并传递一些数据（v4l2_格式的结构）。</p><p>   The  ioctl is sent through  /dev/video1, which arrives at the  video(4)driver’s  videoioctl function.It then does some error checking and passes it alongto the USB-specific  uvideo(4)driver’s  uvideo_s_fmt function.</p><p>ioctl通过/dev/video1发送，到达视频（4）驱动程序的videoioctl函数。然后，它会执行一些错误检查，并将其与USB特定的uvideo（4）驱动程序的uvideo_s_fmt功能一起传递。</p><p> There are already some debugging  printfs in  uvideo_s_fmt, which are donethrough a  DPRINTF macro which actually prints only when  UVIDEO_DEBUG isenabled:</p><p>uvideo_s_fmt中已经有一些调试打印文件，它们是通过一个DPRINTF宏完成的，该宏实际上只在启用uvideo_调试时打印：</p><p> #ifdef UVIDEO_DEBUGint uvideo_debug = 1;#define DPRINTF(l, x...) do { if ((l) &lt;= uvideo_debug) printf(x); } while (0)#else#define DPRINTF(l, x...)#endif</p><p>#ifdef UVIDEO_DEBUGint UVIDEO_debug=1#定义DPRINTF（l，x…）do{if（（l）&lt；=uvideo_调试）printf（x）；}而（0）#else#定义DPRINTF（l，x…）#恩迪夫</p><p> I added a  #define UVIDEO_DEBUG above that block, recompiled the kernel andbooted to it.Running the  video utility makes the kernel print out a line, but it printsnothing from my Ruby code.</p><p>我在该块上添加了一个#define UVIDEO_调试，重新编译内核并引导到它。运行video实用程序会使内核打印出一行，但它不会从我的Ruby代码中打印任何内容。</p><p>  Since the  DPRINTF that prints that is pretty high in the function, I’mguessing it’s not even reaching  uvideo, so let’s go back to the  videodriver.</p><p>由于DPRINTF打印的功能非常强大，我想它甚至还没有到达uvideo，所以让我们回到视频驱动程序。</p><p> DPRINTF(3, &#34;video_ioctl(%zu, &#39;%c&#39;, %zu)\n&#34;,	 IOCPARM_LEN(cmd), (int) IOCGROUP(cmd), cmd &amp; 0xff);	error = EOPNOTSUPP;	switch (cmd) {	...	case VIDIOC_S_FMT:		if (!(flags &amp; FWRITE))			return (EACCES);		if (sc-&gt;hw_if-&gt;s_fmt)			error = (sc-&gt;hw_if-&gt;s_fmt)(sc-&gt;hw_hdl,			 (struct v4l2_format *)data);		break;</p><p>DPRINTF（3，&#34；视频操作（%zu，&#39；%c&#39；，%zu）\n&#34；，IOCPARM_LEN（cmd），（int）IOCGROUP（cmd），cmd&amp；0xff）；错误=EOPNOTSUPP；开关（cmd）{…case VIDIOC__FMT:if（！（flags&amp；FWRITE））返回（EACCES）；if（sc-&gt；hw_if-&gt；S_FMT）错误=（sc-&gt；hw_if-&gt；S_FMT）（sc-&gt；hw_hdl，（struct v4l2_格式*）数据）；中断；</p><p> Similarly, we can enable debugging  printfs in the  video driver by defining VIDEO_DEBUG at the top, compiling, and rebooting.Now when I run my Ruby code, I get:</p><p>类似地，我们可以通过在顶部定义video_DEBUG、编译和重新启动来在视频驱动程序中调试printfs。现在，当我运行Ruby代码时，我得到：</p><p>  Looking at  /usr/src/sys/sys/videoio.h, I can see that it does appear to be thecorrect  ioctl in the group  V, number 5, and a proper size of that v4l2_format struct:</p><p>查看/usr/src/sys/sys/videoio。h、 我可以看到，它看起来确实是组V中正确的ioctl，编号5，以及v4l2_格式结构的适当大小：</p><p>  The  _IOWR macro is a series of macrosthat build up an  unsigned long that corresponds to every possible  ioctl inthe kernel.</p><p>_IOWR宏是一系列宏，这些宏构建了一个无符号long，对应于内核中所有可能的ioctl。</p><p> So the  ioctl is reaching the  video driver, appears to be recognized as VIDIOC_S_FMT, but is not actually reaching the  uvideo driver’s  s_fmtfunction by way of the big  switch.Is it even getting into the  case VIDIOC_S_FMT?Let’s add our own debugging  printf to show that we reached that, and the pathit’s taking inside of the function.</p><p>因此，ioctl正在到达视频驱动程序，似乎被认为是VIDIOC__FMT，但实际上并没有通过大开关到达uvideo驱动程序的_FMT功能。维迪奥苏菲姆特的案子里有没有这个问题？让我们添加我们自己的调试printf，以显示我们达到了这一点，以及它在函数内部的路径。</p><p>  video_ioctl(208, &#39;V&#39;, 5)uvideo1: uvideo_s_fmt: requested width=640, height=480uvideo1: uvideo_s_fmt: offered width=640, height=480S_FMT: returned 0videoioctl: final ret 0</p><p>视频ioctl（208，&#39；V&#39；5）uvideo1:uvideo#U s#fmt:请求的宽度=640，高度=480uvideo1:uvideo#U fmt:提供的宽度=640，高度=480S#fmt:返回0视频ioctl:最终检索0</p><p> But when running my Ruby code, it only prints the first line, indicating thatit’s not even reaching the  case VIDIOC_S_FMT.Since the  switch is on the entire  cmd, not just the number (5) or on thegroup ( V), it must match all of the  ioctl parameters.Let’s print out the whole thing:</p><p>但是当运行我的Ruby代码时，它只打印第一行，这表明它甚至没有到达案例VIDIOC_s_FMT。由于开关位于整个cmd上，而不仅仅是数字（5）或组（V），因此它必须匹配所有ioctl参数。让我们把整件事打印出来：</p><p> video_ioctl(208, &#39;V&#39;, 5) (3234878981 vs s_fmt 3234878981)uvideo1: uvideo_s_fmt: requested width=640, height=480uvideo1: uvideo_s_fmt: offered width=640, height=480S_FMT: returned 0videoioctl: final ret 0</p><p>视频ioctl（208和39；V和39；5）（3234878981对s#fmt 3234878981）uvideo1:uvideo#U s#fmt：请求的宽度=640，高度=480uvideo1:uvideo#U fmt:提供的宽度=640，高度=480S#fmt:返回的0videoioctl:final ret 0</p><p>    At this point I went back to the Ruby C code.How is it passing the  ioctl request parameter?</p><p>在这一点上，我回到了Ruby C代码。它是如何传递ioctl请求参数的？</p><p> static int xioctl(int fh, int request, void *arg){ int r; do {	r = ioctl(fh, request, arg); } while (r == -1 &amp;&amp; EINTR == errno); return r;}</p><p>静态int-xioctl（int-fh，int-request，void*arg）{int-r；do{r=ioctl（fh，request，arg）；}而（r=-1&amp；EINTR==errno）；返回r；}</p><p>    Of course,  request must be an  unsigned long, but this Ruby module’s  xioctlwrapper is truncating it to a  signed int before passing it to the kernel.</p><p>当然，请求必须是无符号long，但这个Ruby模块的xioctlwrapper在将其传递给内核之前将其截断为有符号int。</p><p>  The  ioctl function on Linux also requiresan  unsigned long, so this fix is not specific to OpenBSD but presumablythe V4L2  ioctl values on Linux don’t exceed the size of a 32-bit integer andso this never caused issues for anyone on Linux.</p><p>Linux上的ioctl函数也需要一个无符号长，因此此修复程序不是OpenBSD特有的，但Linux上的V4L2 ioctl值可能不会超过32位整数的大小，因此这不会给Linux上的任何人带来问题。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/ioctl/">#ioctl</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/fmt/">#fmt</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>