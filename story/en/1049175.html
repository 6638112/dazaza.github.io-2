<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>在VMware vCenter中未经授权的RCE Unauthorized RCE in VMware VCenter</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Unauthorized RCE in VMware VCenter<br/>在VMware vCenter中未经授权的RCE </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-02-25 03:12:57</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/2/1f045f75d932bd9c445e66db49bd2223.png"><img src="http://img2.diglog.com/img/2021/2/1f045f75d932bd9c445e66db49bd2223.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Since the PoC for the VMware vCenter RCE (CVE-2021-21972) is now readily available, we’re publishing our article covering all of the technical details.</p><p>由于VMware vCenter RCE（CVE-2021-21972）的PoC现在可以随时可用，因此我们正在发布涵盖所有技术细节的文章。</p><p> In fall of 2020, I discovered couple vulnerabilities in the vSphere Client component of VMware vCenter. These vulnerabilities allowed non-authorized clients to execute arbitrary commands and send requests on behalf of the targeted server via various protocols:</p><p> 在2020年秋天，我发现了VMware vCenter的vSphere客户端组件中的情侣漏洞。这些漏洞允许未授权的客户端通过各种协议代表目标服务器执行任意命令并发送请求：</p><p>  In this article, I will cover how I discovered the VMware vSphere client RCE vulnerability, divulge the technical details, and explain how it can be exploited on various platforms.</p><p>  在本文中，我将介绍如何发现VMware vSphere Client RCE漏洞，泄露技术细节，并解释如何在各种平台上利用它。</p><p>   vSphere and vCenter enable the virtualization of corporate infrastructure and provide means of control over it. While this software can be encountered on the perimeter, in most cases it is located on internal networks.</p><p>   vSphere和vCenter启用公司基础架构的虚拟化，并提供对其的控制手段。虽然可以在周边遇到此软件，但在大多数情况下它位于内部网络上。</p><p>  During the analysis of the vSphere Client, I employed both a black-box and a white-box approach to testing, as usual, focusing on vulnerabilities that could be exploited without authorization. From the web panel I tried to send as many different requests as possible, all without cookie headers.</p><p>  在分析vSphere客户端期间，我雇用了一个黑匣子和一个白盒方法，以便像往常一样，专注于无需授权就可以利用的漏洞。来自Web Panel，我试图发送尽可能多的不同请求，所有都没有cookie标题。</p><p> After sending an unauthorized request to  /ui/vropspluginui/rest/services/*, I discovered that it did not in fact require any authentication.</p><p> 在向/ ui / vropspluginui /休息/服务/ *发送未经授权的请求之后，我发现它实际上并未需要任何身份验证。</p><p>  The web application relies on plugins, usually located in separate .jar files, for some of its features. The vropspluginui plugin, for example, is implemented in the file vropsplugin-service.jar.</p><p>  Web应用程序依赖于其中一些功能的插件，通常位于单独的.jar文件中。例如，VROPSPLUGINUI插件在文件vROPSPLUGIN-service.jar中实现。 </p><p> From what I understand, each plugin must specify which of its endpoints require authorization in the web panel to run and which do not. This plugin was configured to allow unauthorized users to access any URL it handled.</p><p>从我理解的那样，每个插件都必须指定哪些端点需要在Web面板中授权运行，并且哪些端口不存在。此插件配置为允许未经授权的用户访问其处理的任何URL。</p><p>    While iterating over all of the entries, a copy of each current entry was created on disk using the file naming convention:  /tmp/unicorn_ova_dir + entry_name.</p><p>    在迭代所有条目时，使用文件命名约定在磁盘上创建每个当前条目的副本：/ tmp / unicorn_ova_dir + entry_name。</p><p> This was where I noticed that the names of the .tar entries are not filtered. They are simply concatenated with the string “/tmp/unicorn_ova_dir”; a file is created at the resulting location. This meant we could create an archive entry containing the string “../”, which would allow us to upload an arbitrary file to an arbitrary directory on the server.</p><p> 这是我注意到.tar条目的名称不会过滤。它们只是与字符串“/ tmp / unicorn_ova_dir”连接;在生成的位置创建文件。这意味着我们可以创建一个包含字符串“../”的存档条目，这将允许我们将任意文件上传到服务器上的任意目录。</p><p> To make a .tar archive taking advantage of this quirk, I used the  evilarc utility. This was the second time it came in handy, the former being the search for a similar vulnerability described  previously in this blog.</p><p> 为了利用这个Quirk，我使用了evilarc实用程序来制作.tar存档。这是它第二次派上派上，前者是在这个博客中搜索先前描述的类似漏洞。</p><p>  The resulting archive contained a file with the name  ..\..\testFolder\testUpload.txt. I uploaded it to the URL  /ui/vropspluginui/rest/services/uploadova and checked the server’s filesystem for the presence of the  testFolder folder and its nested file in the  C:\ root directory.</p><p>  生成的存档包含一个带名称的文件.. \ .. \ testfolder \ testupload.txt。我将其上传到URL / UI / VROPSPLUGINUI / REST / SERVICES / UPLOOVA，并检查了COSTFOLDER文件夹的存在，并在C：\ Root目录中存在嵌套文件。</p><p>     In order to be able to execute arbitrary commands on a target system, we need to upload a .jsp shell that will be accessible without authorization. To discover such a location:</p><p>     为了能够在目标系统上执行任意命令，我们需要上传将无法授权访问的.jsp shell。要发现这样的位置：</p><p> Find writeable paths on disk where file creation using the previously described vulnerability is possible</p><p> 在磁盘上找到可写的路径，其中可能是使用先前描述的漏洞创建的文件创建 </p><p> Map found file paths into the folder structure of accessible web-roots, able to run .jsp scripts and not requiring authorization.</p><p>将找到的文件路径映射到可访问的Web根目录的文件夹结构中，该目录能够运行.jsp脚本，并且不需要授权。</p><p> First off, let’s check which privileges our uploaded files acquire by uploading the file  testUpload.txt and looking at its properties menu. We can see that its owner is the user “vsphere-ui”.</p><p> 首先，让我们通过上传文件testUpload.txt并查看其属性菜单来检查上传的文件获得了哪些特权。我们可以看到它的所有者是用户“ vsphere-ui”。</p><p>  In our search for a candidate location the directory  C:\ProgramData\VMware\vCenterServer\data\perfcharts\tc-instance\webapps\statsreport\ (in which .jsp files are present) looks promising.</p><p>  在搜索候选位置时，目录C：\ ProgramData \ VMware \ vCenterServer \ data \ perfcharts \ tc-instance \ webapps \ statsreport \（其中存在.jsp文件）看起来很有希望。</p><p>  The check for unauthorized access to jsp scripts yields success. Let’s check whether vsphere-ui has write privileges to this directory.</p><p>  检查未经授权的对jsp脚本的访问会产生成功。让我们检查一下vsphere-ui是否对该目录具有写权限。</p><p>  And sure enough, it does. Great! Now we can upload a specially crafted .jsp file to execute commands on the system.</p><p>  当然可以。伟大的！现在，我们可以上传特制的.jsp文件，以在系统上执行命令。</p><p> Let’s create an archive containing our crafted .jsp shell payload and send it to the URL that we’re studying.</p><p> 让我们创建一个包含精心制作的.jsp shell有效负载的存档，并将其发送到我们正在研究的URL。</p><p>   Our .jsp script has been uploaded to the server, giving us the opportunity to execute arbitrary commands on the system with NT AUTHORITY\SYSTEM privileges.</p><p>   我们的.jsp脚本已上传到服务器，这使我们有机会在具有NT AUTHORITY \ SYSTEM特权的系统上执行任意命令。 </p><p>  Things are a bit different for Linux instances. But they, too, are vulnerable and allow external users to upload arbitrary files.</p><p>对于Linux实例有点不同。但是，它们也易受攻击，允许外部用户上传任意文件。</p><p> On Linux I could not find a directory which allowed the simultaneous upload and execution of .jsp shells. Instead, there exists another method of achieving command execution on the server.</p><p> 在Linux上，我找不到允许同时上传和执行.jsp shell的目录。相反，存在另一种在服务器上实现命令执行的方法。</p><p> We know we can upload arbitrary files with the rights of the vsphere-ui user. What if we upload a public key to this user’s home directory and try connecting to the server via SSH using the private key?</p><p> 我们知道我们可以使用vSphere-UI用户的权限上传任意文件。如果我们将公钥上传到此用户的主目录，请尝试通过使用私钥通过SSH连接到服务器？</p><p>          Next, we upload the file using the vulnerability and attempt to connect to the target host via SSH:</p><p>          接下来，我们使用漏洞上传文件并尝试通过SSH连接到目标主机：</p><p>     In this article, I have demonstrated a method of achieving RCE in VMware vSphere Client as an unauthenticated user. In addition to getting access to the command line, an attacker can perform other malicious actions due to the lack of authentication in the vropspluginui plugin.</p><p>     在本文中，我已经展示了一种在VMware vSphere Client中实现RCE作为未经身份验证的用户的方法。除了获取命令行外，攻击者还可以在VROPSPLUGINUI插件中缺乏身份验证，执行其他恶意操作。</p><p> Updating to the latest version of VMware vSphere Client is highly recommended. Please see  iVMSA-2021-0002 for more information.</p><p> 强烈建议使用更新到最新版本的VMware vSphere Client。有关更多信息，请参阅IVMSA-2021-0002。</p><p>   October 9, 2020 — Vulnerability successfully reproduced and vendor started working on the fix plan</p><p>   10月9日，2020年 - 漏洞成功复制，供应商开始在修复计划上工作 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://swarm.ptsecurity.com/unauth-rce-vmware/">https://swarm.ptsecurity.com/unauth-rce-vmware/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/vmware/">#vmware</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/vcenter/">#vcenter</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/rce/">#rce</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/文件/">#文件</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>