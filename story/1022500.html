<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>PostgreSQL 13Beta3：B树索引重复数据消除</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">PostgreSQL 13Beta3：B树索引重复数据消除</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-07 10:57:20</div><div class="page_narrow text-break page_content"><p>PostgreSQL 13开发进展顺利，Postgres 13 Beta3于2020年8月13日发布。Postgres Beta 1和2版本分别于2020年5月和6月发布。我对Postgres 13感兴趣的功能之一是B-Tree重复数据删除功能。B-Tree索引是Postgres中的默认索引方法，也可能是生产环境中最常用的索引。对这部分数据库的任何改进都可能带来广泛的好处。从索引中删除重复项可使其物理大小更小，减少I/O开销，并有助于保持SELECT查询的速度！</p><p>在Laurenz Albe的帖子中，有一个很好的总结，从2020年6月初开始，大概使用了Pg13 Beta1，对这种改进的内容和方式进行了很好的总结。哈米德·阿赫塔尔(Hamid Akhtar)在7月份的帖子中报道了使用PG13Beta2的这一功能，以及一种不同的方法，包括使用EXPLAIN查看性能。这篇帖子再次介绍了使用PG13Beta3的这一改进。我打算看看这一改进在我在生产中使用的数据集上效果如何。对于这项任务，我的首选是使用osm2pgsql将OpenStreetMap数据加载到Postgres/PostGIS。</p><p>第一步是在一台Ubuntu18主机上安装两个版本的Postgres(12和13beta3)。在过去，当我测试生产前版本时，我会从源代码构建postgres，而不是使用aps，这次我决定使用apt install，所以我将包含这方面的基本过程。</p><p>建议安装PostgreSQL的方式是从pgdg(PostgreSQL Global Development Group)存储库中安装，有关更多信息，请参阅Postgres维基。要启用测试版，/etc/apt/Soures.list.d/pgdg.list中需要的行为：</p><p>Sudo apt更新#postgres 12sudo apt安装PostgreSQL-12 PostgreSQL-12-postgis-3#postgres 13(当前为Beta版)sudo apt安装PostgreSQL-13 postgreSQL-13-postgis-3。</p><p>在Ubuntu上，安装多个版本将创建在不同端口上运行的多个实例。我用来写这篇文章的测试服务器目前安装了三个版本的Postgres，目前只有两个在运行。Postgres 12是第一个安装的，因此获得了默认端口5432。Postgres 11第二个安装，分配给5433，PG13 beta 3最后安装，分配端口5434。在Debian/Ubuntu主机上，pg_lscluster作为pg_ctl包装器的一部分可用。</p><p>Sudo-u postgres pg_lsclustersVer群集端口状态所有者数据目录日志文件11 main 5433 down postgres/var/lib/postgresql/11/main/var/log/postgreSQL/postgresql-11-main.log12 main 5432 online postgres/var/lib/postgreSQL/12/main/var/log/postgresql/postgress12-main.log13 main 5434 online postgres/var/lib/postgreSQL/12/main/var/log/postgresql/postgresql/postgresql-12-main.log13 main 5434 online postgres/var/lib/postgreSQL/12/main/。</p><p>当使用已安装的多个版本时，验证版本是否与您期望的匹配是很有帮助的。首先，Postgres 12版本的端口5432。</p><p>Psql-d pgom-p5432-c&#34；选择版本()；&#34；┌────┐│版本│╞══。X86_64-PC-linux-gnu上的══╡│PostgreSQL12.4(Ubuntu12.4-1.pgdg18.04+1)，编译的…。││…。GCC(Ubuntu7.5.0-3ubuntu1~18.04)7.5.0，64位│└────┘。</p><p>Psql-d pgom-p5434-c&#34；选择版本()；&#34；┌────┐│版本│╞══。X86_64-PC-linux-gnu上的══╡│PostgreSQL13beta3(Ubuntu13~beta3-1.pgdg18.04+1)，C…。││…。编译：GCC(Ubuntu7.5.0-3ubuntu1~18.04)7.5.0，64位│└────┘。</p><p>两个版本的Postgres都加载了使用osm2pgsql加载的相同的Colorado OpenStreetMapdata。osm2pgsql本身不创建任何B-Tree索引，只创建几何上的GIST索引。对于本帖子，我们检查在四个列(osm_id、Highway、water way和Natural)上创建的B-Tree索引大小。查看公共数据。Planet_OSM_LINE表我可以猜测我们愿意和不愿意在哪里创建B-Tree索引。自然和水道)具有少量不同的值和不同数量的空值。这三列都是部分索引的候选列，以避免索引NULL值，从而减小创建的索引的大小。我希望在Postgres 13中看到这些列的好处，可能会降低部分索引的使用频率。</p><p>从pg_Catalog.pg_stats中选择attname，n_DISTINCT，NULL_FRAC，其中tablename=&#39；Planet_OSM_LINE&#39；和attname in(&#39；osm_id&#39；，&#39；高速公路&#39；，&#39；水道&#39；，&#39；Natural&#39；)；┌─┬─┬─┐│Attname│n_DISTINCT│NULL_FRAC│╞═╪═╪═╡│osm_id│-0.833553│0││高速公路│26│0.41616666││Natural│4│0.994││水道。│9│0.6663│└─┴─┴─┘。</p><p>首先是osm_id列，这是一组几乎唯一的正值和负值。要在两个版本中创建的索引：</p><p>以下查询始终用于报告索引大小。查询本身不会重复，因为只有筛选器会更改。</p><p>选择ai.schemaname作为s_name，ai.relname作为t_name，ai.indexrelname作为索引名称，pg_size_pretty(pg_relation_size(quote_ident(ai.schemaname)：：text||&#39；.&#39；||QUOTE_IDENT(ai.indexrelname)：：Text))作为索引大小，pg_relation_size(quote_ident(ai.schemaname)：：text||&#39；.&#39；|QUOTE_IDENT(ai.indexrelname)：：text)As index_size_bytes from pg_Catalog.pg_stat_all_indedes ai where ai.indexrelname LIKE&#39；ix_OSM_LINE%&#39；ORDER BY INDEX_NAME；</p><p>由于复制件的数量很少，难怪尺寸只有很小的缩小。仅从INDEX_SIZE列(MB)无法检测到减少，INDEX_SIZE_BYTES显示大小略有减少(29,515,776字节与29,384,704字节)。</p><p>┌─[记录1]─┬─┐│s_name│PUBLIC││t_name│PLANET_osm_line││索引名称│ix_osm_line_osm_id││索引大小│28 MB││索引大小字节│29515776│└─┴─┘。</p><p>┌─[记录1]─┬─┐│s_name│PUBLIC││t_name│PLANET_osm_line││索引名称│ix_osm_line_osm_id││索引大小│28 MB││索引大小字节│29384704│└─┴─┘。</p><p>PLANET_OSM_LINE数据中的高速公路数据就是一个很好的例子，说明部分索引通常是最小化索引大小的好主意。我的预感(也是希望)是，重复数据删除将通过减少索引大量空值所需的大小，使这里的部分索引变得毫无意义。</p><p>创建两个索引，一个是覆盖非空值的部分索引，另一个是整个表上的fullindex。</p><p>在public_OSM_LINE(HIGHAY)上创建索引ix_OSM_LINE_PRODUTY_PARTIAL，当PRECHAY不为空时创建索引IX_OSM_LINE_WALLE_FULL；</p><p>Postgres 12中的两个索引注意，部分索引从完整索引中减少了大约1/3的大小。</p><p>┌─┬─┬──┬─┐│s名称│t名称│索引名称│索引大小│╞═╪═╪════。═╪═╡│PUBLIC│PLANET_OSM_LINE│IX_OSM_LINE_HEADY_FULL│30 MB││PUBLIC│PLANET_OSM_LINE│IX_OSM_LINE_HEADY_PARTIAL│19 MB│└─┴─┴─。─┴─┘。</p><p>现在看一下Postgres 13中相同的两个索引，哇！Postgres 13中的Fullindex大约是Postgres 12中部分索引大小的一半！有了这种类型的节省，我预计我不会经常费心使用分部索引。</p><p>┌─┬─┬──┬─┐│s名称│t名称│索引名称│索引大小│╞═╪═╪════。═╪═╡│PUBLIC│PLANET_OSM_LINE│IX_OSM_LINE_HEADY_FULL│8944kB││PUBLIC│PLANET_OSM_LINE│IX_OSM_LINE_HEADY_PARTIAL│5272 kB│└─┴─┴─。─┴─┘。</p><p>我并不认为仅凭这一改进就可以消除对部分索引的需求。相反，它将把对部分索引的需求减少到边缘案例的较小子集。部分索引仍将是一个有用的工具。</p><p>最后两个要测试的列与高速路列具有不同的唯一和空比率。创建索引。</p><p>创建索引ix_OSM_LINE_WATHWAY_PARTIAL，在public上创建索引ix_OSM_LINE_WATWAY_PARTIAL，其中WATWAY不为NULL；在public上创建索引IX_OSM_LINE_WATWAY_FULL；在public上创建索引IX_OSM_LINE_NATUAL_PARTIAL。Planet_OSM_LINE(&#34；Natural&#34；)其中&#34；Natural&#34；不为空；在public上创建索引IX_OSM_LINE_Natural_FULL。</p><p>注意：osm2pgsql创建自然列，这是SQL中的保留关键字。您必须使用双引号引用此列，例如SELECT&#34；Natural&34；...。</p><p>下面是Postgres 12中这四(4)个新索引的索引大小。由于99.4%的行为NULL，自然列上的部分索引在这里大大优于完整索引。水路也节省了更多的部分索引，67%的行是NULL。作为参考，HIGHAYS列是42%的NULL。</p><p>┌─┬─┬──┬─┐│s名称│t名称│索引名称│索引大小│╞═╪═╪═══。══╪═╡│PUBLIC│PLANET_OSM_LINE│IX_OSM_LINE_自然_FULL│28 MB││PUBLIC│PLANET_OSM_LINE│IX_OSM_LINE_自然_PARTIAL│264KB││PUBLIC│PLANET_OSM_LINE│IX_OSM_LINE_WATWAY_FULL│28 MB││PUBLIC│PLANET_osm_line│IX_osm_。LINE_WATWAY_PARTIAL│└─┴─┴──┴─┘9680kB│。</p><p>同样，Postgres 13中的每个指数都比Postgres 12中的对应指数小很多。这里的胜利随着空值的不同模式发生了一些变化。</p><p>┌─┬─┬──┬─┐│s名称│t名称│索引名称│索引大小│╞═╪═╪═══。══╪═╡│PUBLIC│PLANET_OSM_LINE│IX_osm_LINE_Natural_Full│8912kB││PUBLIC│PLANET_osm_LINE│ix_osm_LINE_Natural_Partial│80 kB││PUBLIC│PLANET_OSM_LINE│IX_osm_LINE_WATWAY_FULL│8912kB││PUBLIC│PLANET_osm_LINE│IX_osm_。LINE_WATWAY_PARTIAL│└─┴─┴──┴─┘2968kB│。</p><p>Postgres 13的B-Tree重复数据删除对于值严重重复的列的索引来说是一大胜利。我使用复制和空值测试的列的大小减少了69-72%。下表将上述所有测试的结果汇总在一起。</p><p>下面是两个图表中相同的数据。首先，图表显示了尺寸缩小的百分比。</p><p>到目前为止，PostgreSQL13的B-Tree重复数据删除功能可能是我最喜欢的即将发布的版本。这一改进在磁盘上节省的数量给我留下了相当深刻的印象。它对唯一的B-Tree索引大小无济于事，尽管有大量类似于此处所示的非唯一索引。能够在具有空值的列上创建更紧凑的索引，而不需要部分索引，这是另一个好处。这似乎会使获取正确的索引变得更容易，同时保持较小的索引大小。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.rustprooflabs.com/2020/09/postgres-beta3-btree-dedup">https://blog.rustprooflabs.com/2020/09/postgres-beta3-btree-dedup</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/数据/">#数据</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/tree/">#tree</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/索引/">#索引</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1022367.html"><img src="http://img2.diglog.com/img/2020/9/thumb_892e1bee9ecfe25c3fff6156d6cfc8e3.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1022367.html">大驴数据经纪人退出名单</a></div><span class="my_story_list_date">2020-9-6 22:19</span></div><div class="col-sm"><div><a target="_blank" href="/story/1022148.html"><img src="http://img2.diglog.com/img/2020/9/thumb_d0d9f2313fa98a5e7a691b2eda32b15f.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1022148.html">抬高数据，缺失意义(2017)</a></div><span class="my_story_list_date">2020-9-5 4:36</span></div><div class="col-sm"><div><a target="_blank" href="/story/1022050.html"><img src="http://img2.diglog.com/img/2020/9/thumb_6aef038dc600865baaaa722e809624e1.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1022050.html">使用人工智能来增加收债</a></div><span class="my_story_list_date">2020-9-4 13:34</span></div><div class="col-sm"><div><a target="_blank" href="/story/1022010.html"><img src="http://img2.diglog.com/img/2020/9/thumb_d78064abf4407938fa9ee436e38fdbd4.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1022010.html">Pachyderm Hub：没有管理基础设施的麻烦的数据科学</a></div><span class="my_story_list_date">2020-9-4 7:29</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>