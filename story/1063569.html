<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Linux DNS查找的解剖 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Linux DNS查找的解剖 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-06-05 02:56:06</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/6/3c9ae059571ab73fa1b2b5bbecf99b95.png"><img src="http://img2.diglog.com/img/2021/6/3c9ae059571ab73fa1b2b5bbecf99b95.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>由于我与集群虚拟机工作了很多，我最终花了很多时间试图弄清楚DNS查找如何工作。我从Stackoverflow应用了“修复”问题，而无需了解他们为什么工作（或不起作用）一段时间。</p><p> 最终我已经厌倦了这一点，决定弄清楚它是如何一起挂起的。我找不到在线的任何地方找到完整的指南，并与同事交谈，他们不知道任何（或真的细节会发生什么）</p><p>  事实证明，短语'Linux是否有DNS查找'......</p><p>           这些帖子旨在分解程序如何决定它在Linux主机上获取IP地址以及可以参与的组件。不了解这些作品如何合适，调试和修复（例如）DNSMASQ，VAGRANT LANDRUSH或RESCVCONF可以完全令人困惑。</p><p> 它也是一种有价值的例证，如何随着时间的推移如此简单地变得如此复杂。到目前为止，我迄今为止，我看过十几个不同的技术和他们的考古学。</p><p> 我甚至写了一些自动化代码，以允许我在VM中进行实验。欢迎贡献/修正。</p><p> 请注意，这不是“DNS工作原理”的帖子。这是关于呼叫到Linux主机上配置的实际DNS服务器的所有内容（假设它甚至调用DNS服务器 - 就像你看到的那样，它不需要），以及如何找到哪一个去哪一个或者它如何获得其他一些方式。 </p><p>掌握的第一件事是没有单一的方法可以在Linux上完成DNS查找。它不是一个有干净界面的核心系统调用。</p><p> 但是，有一个标准的c库调用称之为许多程序使用：getaddrinfo。但并非所有应用程序都使用这个！</p><p>    他们都得到了相同的结果，所以他们必须做同样的事情，对吧？</p><p>  以下是ping在与DNS相关的主机上查看的文件：</p><p> root @ linuxdns1：〜＃strace -e trace = open -f ping -c1 google.com打开（＆＃34; /etc/ld.so.cache&#34;，o_rdonly | o_cloexec）= 3打开（＆＃34; /llib/x86_64-linux-gnu/libcap.so.2&#34;，o_rdonly | o_cloexec）= 3打开（＆＃34; /lib/x86_64-linux-gnu/libc.so.6&#34;，o_rdonly | o_cloexec）= 3打开（＆＃34; /etc/resolv.conf&#34;，o_rdonly | o_cloexec）= 4打开（＆＃34; /etc/resolv.conf&#34;，o_rdonly | o_cloexec）= 4打开（ ＆＃34; /etc/nsswitch.conf&#34;，o_rdonly | o_cloexec）= 4打开（＆＃34; /etc/ld.so.cache&#34;，o_rdonly | o_cloexec）= 4打开（＆＃34; /lib/x86_64-linux-gnu/libnss_files.so.2&#34;，o_rdonly | o_cloexec）= 4打开（＆＃34; /etc/host.conf&#34;，o_rdonly | o_cloexec）= 4打开（＆＃ 34; / etc / hosts＆＃34;，o_rdonly | o_cloexec）= 4打开（＆＃34; /etc/ld.so.cache&#34;，o_rdonly | o_cloexec）= 4打开（＆＃34; / lib / x86_64 -linux-gnu / libnsss_dns.so.2＆＃34;，o_rdonly | o_cloexec）= 4打开（＆＃34; /lib/x86_64-linux-gnu/libresolv.so.2&#34;，o_rdonly | o_cloexec）= 4 ping google.com（216.58.204.46）56（84）个字节的数据。打开（＆＃34; / etc / hosts＆＃34;，o_rdonly | o_cloexec）= 4 64字节从lhr25s12-in-f14.1e100.net（216.58.204.46）：ICMP_SEQ = 1 TTL = 63次= 13.0 ms [。 ..]</p><p>  $ strace -e trace = open -f host google.com [pid 9869]打开（＆＃34; /usr/share/locale/en_us.utf-8/lc_messages/libdst.cat&#34 ;, o_rdonly）= -1 enoent（没有这样的文件或目录）[pid 9869]打开（＆＃34; /usr/share/locale/en/libdst.cat&#34;，o_rdonly）= -1 Enoent（没有这样的文件或目录）[PID 9869]打开（＆＃34; / susr/share/locale/en/lc_messages/libdst.cat& n34;，o_rdonly）= -1 enoent（没有这样的文件或目录）[PID 9869]打开（＆ ＃34; /usr/lib/sl/openssl.cnf&#34;，o_rdonly）= 6 [PID 9869]打开（＆＃34; /usr/lib/x86_64-linux-gnu/openssl-1.0.0/2nuins/ libgost.so＆＃34;，o_rdonly | o_cloexec）= 6 [pid 9869]打开（＆＃34; /etc/resolv.conf&#34;，o_rdonly）= 6 google.com有地址216.58.204.46 [...]</p><p> 您可以看到，虽然我的ping看起来nsswitch.conf，但主机没有。他们都看看/etc/resolv.conf。 </p><p>我们已经建立了应用程序可以在他们决定哪个DNS服务器转到时更喜欢它们。上面的许多应用程序（如ping）可以通过其配置文件/etc/nsswitch.conf来引用（根据实现（*））到NSSwitch。</p><p> （*）Ping实现的令人惊讶的变化程度。这是一个我不想迷失的兔子洞。</p><p> NSSwitch不仅仅是为了DNS查找。它也用于密码和用户查找信息（例如）。</p><p> NSSwitch最初是作为Solaris操作系统的一部分创建的，以允许应用程序不必留给他们查看这些东西的内容或服务，但延迟到他们不必担心的其他可配置的集中式位置。</p><p>  passwd：compat组：compat shadow：compat gshadow：文件主机：文件dns myhostname网络：文件协议：db文件服务：db文件ethers：db文件rpc：db文件netgroup：nis</p><p> “寄宿的行是我们对我们感兴趣的那个。我们已经表明，Ping关心nsswitch.conf所以让我们摆弄它，看看我们如何用ping弄乱。</p><p>       $ ping -c1 localhost ping localhost（127.0.0.1）56（84）数据的字节。来自localhost的64个字节（127.0.0.1）：ICMP_SEQ = 1 TTL = 64次= 0.039毫秒 </p><p>$ ping -c1 google.com ping google.com（216.58.198.174）56（84）字节的数据。 来自LHR25S10-in-f174.1e100.NET（216.58.198.174）的64个字节（216.58.198.174）：ICMP_SEQ = 1 TTL = 63次= 8.01毫秒  以下是默认WRT主机查找的NSSwitch正在发生的图：  我们现在看到了主机和ping都查看此/etc/resolv.conf文件。  ＃动态resolv.conf（5）文件用于resolvconf（8）生成的glibc resolver（3）的文件，不要手动编辑此文件 - 您的更改将被覆盖名称服务器10.0.2.3  忽略前两条线 - 我们会回到那些（它们很重要，但你还没准备好羊毛球）。  *另一个兔子洞：主机似乎返回到127.0.0.1:53如果没有指定的名称程序。  此文件也取其他选项。 例如，如果将此行添加到“roscv.conf文件”中： </p><p>这是第一部分的结束。下一部分将首先查看如何创建和更新resolv.conf。  不同的程序以不同的方式弄清出地址的IP，例如，ping使用nsswitch，这反过来使用（或可以使用）/ etc / hosts，/etc/resolv.conf和它自己的主机名来获得结果  如果你喜欢这一点，请考虑购买我是一杯咖啡，鼓励我做更多。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://zwischenzugs.com/2018/06/08/anatomy-of-a-linux-dns-lookup-part-i/">https://zwischenzugs.com/2018/06/08/anatomy-of-a-linux-dns-lookup-part-i/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/dns/">#dns</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/文件/">#文件</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1062818.html"><img src="http://img2.diglog.com/img/2021/5/thumb_26e853ac3ea7c7b1f49812740a90f79d.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1062818.html">Pipewire：Fedora Linux 34的新音频和视频守护程序 </a></div><span class="my_story_list_date">2021-5-15 10:13</span></div><div class="col-sm"><div><a target="_blank" href="/story/1062693.html"><img src="http://img2.diglog.com/img/2021/5/thumb_3c077c8daf10708e4e6bedcd4aeff2d9.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1062693.html">Lima：Linux-on-Mac（“Linux的MacOS子系统”，“Mac ContaintD”） </a></div><span class="my_story_list_date">2021-5-15 0:41</span></div><div class="col-sm"><div><a target="_blank" href="/story/1062536.html"><img src="http://img2.diglog.com/img/2021/5/thumb_388249d589ef3bde2356a096450a4289.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1062536.html">System76为Linux，Windows和MacOS推出开源“启动可配置键盘” </a></div><span class="my_story_list_date">2021-5-14 3:14</span></div><div class="col-sm"><div><a target="_blank" href="/story/1061607.html"><img src="http://img2.diglog.com/img/2021/5/thumb_d225056ff4985cad1efdef773d50b3f0.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1061607.html">Linux基金会推出开源农业基础设施项目 </a></div><span class="my_story_list_date">2021-5-10 8:11</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>