<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我们如何使用Cloudflare和Stripe在2小时内处理500万欧元的捐赠 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">我们如何使用Cloudflare和Stripe在2小时内处理500万欧元的捐赠 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-07 23:31:50</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/12/46e28987c5d896b600eca64d657c32e8.png"><img src="http://img2.diglog.com/img/2020/12/46e28987c5d896b600eca64d657c32e8.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>深入探讨Late Late Toy Show捐赠平台背后的无服务器架构，以及我们在短短几周内将其整合在一起时所面临的挑战。</p><p>  有关RTÉ的Late Late Toy Show的无服务器平台的简介，请参阅本文。</p><p> 在本文中，我们将为您提供当晚的实况转播，并深入探究支撑一切的技术。并非所有事情都按计划进行（是吗？），但是RTÉToy Show Appeal取得了巨大的成功。</p><p>  我们机构有史以来第一个商业项目“我们无服务器”的简介如下：</p><p> 为爱尔兰最受欢迎的电视节目RTE的Late Late Toy Show建立捐赠平台，并准备在四个星期内进行。</p><p> 由于这是第一次在玩具展上提出捐赠要求，所以我们不知道会筹集多少资金，也不知道会有多少观众转化为捐赠者。我们只知道以下内容：</p><p> 估计爱尔兰有150万观众，还有来自全球130多个国家的爱尔兰侨民 </p><p>我们应该毫不费力地扩展，从几乎零活动到每秒数千个请求</p><p>  使其精简；应用程序本身具有的代码和复杂性越多，构建所需的时间就越长，而大规模操作的难度就越大。</p><p>  对于我们的第一个挑战，我们必须决定平台的基础架构，我们决定使用CloudFlare Workers。</p><p> 就无服务器平台而言，CloudFlare Workers可能不如AWS Lambda知名。但是，它们将允许我们的代码在CloudFlare的全球边缘网络上运行，而不是在区域实例上运行。与其他任何云计算服务不同，CloudFlare不使用容器或虚拟机，而是使用V8隔离技术，该技术是Google Chrome小组创建的在浏览器中运行JavaScript的技术。实际上，对于我们来说，这意味着代码将更接近最终用户发出的请求，并且调用不会引起任何冷启动，这种启动可能会持续100毫秒。</p><p> 我们使用无服务器大炮，Grafana和InfluxDB进行的负载测试的结果令人鼓舞。我们模拟了用几分钟的时间最多进行300次捐赠活动来猛击该站点的情况，发现10个请求中有9个请求的延迟时间不超过416毫秒，平均只有77毫秒。</p><p>  尽管出于明显的原因，我们无法在事件本身期间衡量延迟，但CloudFlare衡量的晚上结果更为令人印象深刻：99％的请求使用的时间少于6.6 ms，而整个晚上和第二天。仅在第99.9个百分位，我们看到了一个小小的颠簸，与捐款高峰在晚上11.34左右重合。借助AWS Lambda，我们习惯于在预热阶段看到功能运行100毫秒（毫秒），几秒钟，因此使功能持续运行不到10毫秒而又不会不可避免地受到损失是显而易见的！</p><p>  第二个挑战是使用可以每秒处理数百笔交易而又不费吹灰之力的支付平台：为此，我们很快就选择了Stripe。考虑到RTÉ之前的慈善呼吁节目“RTÉDids Comic Relief”的表演，我们对Stripe的现有限制感到满意，并且RTÉ的慈善合作伙伴爱尔兰社区基金会已将Stripe告知该活动。那时我们几乎不知道“玩具晚会秀”会打破所有记录，而我们很快就突破了这个极限。 </p><p>由于我们希望使堆栈尽可能地精简，因此我们严重依赖Stripe元数据和相关的Stripe Sigma（基本上是Presto）来存储和查询卡交易不需要的少量额外数据，例如用户选择大笔捐款的退税。这使我们能够提供总计的实时报告，并对Stripe持有的数据执行SQL查询，从而消除了许多必须考虑数据存储和相关可伸缩性的压力。</p><p>  节目在晚上9.35开始。 Twitter上颇有一些期待，并且第一条官方推文发布了要求捐款的消息。我们的捐款额约为1万欧元，以为我们度过了一个宁静的夜晚。</p><p> 我们开始看到访问量激增，尤其是在节目主持人Ryan于晚上10.30左右首次提出捐赠要求时，就在Saoirse分享了她勇敢而鼓舞人心的故事后不久。</p><p>  突然之间，事情正在发生，交通流量激增，我们看到捐款总额每秒猛增数万欧元。</p><p>   然后活动开始了，图表开始了，我们看到了先兆警告，来自Sentry和Stripe仪表板的Stripe API返回速率限制错误，随后用户在Twitter上报告了同样的错误。尽管平台本身正在快速响应，但由于Stripe的速率限制，一定比例的用户无法通过。我们与RTÉ的团队和Stripe的客户经理通电话。所有参与的团队反应迅速，不到半小时，Stripe的限制提高了5倍。同时，我们收到了Stripe CTO的电话，后者向我们保证我们不会再遇到任何问题。 Twitter现在着火了（#latelatetoyshow在世界范围内正在流行），很多人（理所当然地！）感谢Stripe。他们的反应绝对出色。</p><p>  捐款不断涌入。我们在23:13:54记录了每秒151笔捐款的峰值。我们还在23:35看到了更长的高峰分钟，即每分钟6988次捐赠-在整个分钟中每秒超过110次捐赠。到午夜，该平台已筹集了超过500万欧元，其中大部分捐款（超过400万欧元）在从晚上11点到午夜的一小时内完成。</p><p>  几个小时后我们结束了。这是一个漫长而激动人心的夜晚，我们需要为周六下午的节目重播做好准备。总共筹集了超过650万欧元（在撰写本文时，该站点一直开放到2020年12月14日），我们的CloudFlare员工收到了超过400万个请求。 </p><p>我们有意地将平台逻辑保持在最低限度。核心是，我们有一个工作站点，该站点负责两件事：它为静态ReactJS前端提供服务并响应后端路由。后端路线是处理付款的核心，它使用用户提交的数据为Stripe的API创建付款意向并返回任何反馈。</p><p> 我们通过Cypress.io对平台进行了自动化测试，该平台使用Stripe的测试模式在过渡环境中模拟了完整的付款过程，并使用Gi​​thub Actions对我们主分支的每次提交都运行了该过程。然后，我们再次使用Github Actions和Wrangler将其部署到RTÉ的CloudFlare帐户。测试和部署管道的简单性意味着我们可以在整个团队中快速迭代，同时确保我们的核心功能保持稳定。</p><p> 所有警告都记录在Sentry中，并发送到我们的Slack。晚上，我们记录了许多Sentry事件，其中许多事件与特定的浏览器行为和依赖项带来的控制台警告有关（例如我们与RTÉ的官方页眉和页脚的集成）。对我们来说幸运的是，并且证明了我们提前使用Browserstack进行了广泛的跨浏览器测试，没有报告的错误和警告被认为对用户使用至关重要。我们现在正在筛选这些事件，并使用知识来改进其下一个化身的平台。</p><p>  我们的平台可轻松扩展。使用传统的基础架构方法，充其量我们最多会大规模超支，从而导致超额支付，最糟糕的是该平台将超负荷且不可用。</p><p> 在边缘运行时（通过CloudFlare Workers或AWS Lambda @ Edge），无服务器速度更快。此外，CloudFlare Workers不会遭受典型的“冷启动”，随着流量的增加，整个活动期间的请求时间保持不变。</p><p> 当他们的服务有可能成为您的应用程序的限制因素时，请始终与您的依赖项制定直接的沟通计划。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://medium.com/we-are-serverless/a-technical-deep-dive-into-processing-5-million-in-donations-in-2-hours-using-cloudflare-workers-fd857ea5cd37">https://medium.com/we-are-serverless/a-technical-deep-dive-into-processing-5-million-in-donations-in-2-hours-using-cloudflare-workers-fd857ea5cd37</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/hours/">#hours</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/stripe/">#stripe</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1027839.html"><img src="http://img2.diglog.com/img/2020/10/thumb_6de886963510ba86fd44056382c9f0eb.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1027839.html">Twitch用户在第三季度观看了47.4亿小时的内容，而YouTube游戏的观看时长为16.8亿小时，Facebook游戏的观看时长为10亿小时；Twitch的流媒体小时市场份额约为91%</a></div><span class="my_story_list_date">2020-10-8 9:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1025753.html"><img src="http://img2.diglog.com/img/2020/9/thumb_76191eb25bdb6e0d2e0d2cb1166a40be.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1025753.html">
特斯拉在生产10太瓦时的道路上推出其无台式电池设计</a></div><span class="my_story_list_date">2020-9-23 7:27</span></div><div class="col-sm"><div><a target="_blank" href="/story/1018376.html"><img src="http://img.diglog.com/img/2020/8/thumb_de118d745d9535de9b423665b664b991.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018376.html">并不是每个人都需要8小时的睡眠</a></div><span class="my_story_list_date">2020-8-16 3:10</span></div><div class="col-sm"><div><a target="_blank" href="/story/1009306.html"><img src="http://img.diglog.com/img/2020/7/thumb_ca3ba32d9a0353b961e648a9069b0588.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1009306.html">
Twitch在第二季度再次打破纪录，总观看时长超过50亿小时</a></div><span class="my_story_list_date">2020-7-2 0:15</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>