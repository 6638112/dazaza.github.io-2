<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>门多萨：使用堆栈机器计算高效的JSON差异</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">门多萨：使用堆栈机器计算高效的JSON差异</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-31 01:11:11</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/fad3e43698604402c349bcb20d28eb64.png"><img src="http://img2.diglog.com/img/2020/10/fad3e43698604402c349bcb20d28eb64.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>When we started work on the recently released feature  , we needed a way to keep a significant part of the edit history of a document in the browser memory to be able to respond quickly to different user interface states. As the user picked various document versions to compare we wanted to be able to quickly reconstruct a specific section of the history of a document.</p><p>当我们开始开发最近发布的功能时，我们需要一种在浏览器内存中保留文档编辑历史的重要部分的方法，以便能够快速响应不同的用户界面状态。当用户选择各种文档版本进行比较时，我们希望能够快速重建文档历史的特定部分。</p><p>  For text diffs, we use the  , and we just assumed someone would have implemented a similarly efficient and compact diff format for JSON documents, but no such luck. If we wanted a general JSON diff format that was super compact and fast to apply, we would have to invent it ourselves. And thus, Mendoza, the totally non-human readable diff format for structured JSON documents, was born.</p><p>对于文本差异，我们使用，我们只是假设有人会为JSON文档实现类似高效和紧凑的diff格式，但没有这样的运气。如果我们想要一个超级紧凑和快速应用的通用JSON diff格式，我们必须自己发明它。于是，用于结构化JSON文档的完全非人类可读的diff格式门多萨应运而生。</p><p>  A flexible format that can accommodate more advanced encodings in the future</p><p>一种灵活的格式，可以在未来适应更高级的编码。</p><p>  Made for humans to read and understand and based on simple operations (like keep, insert, and delete text)</p><p>基于简单的操作(如保留、插入和删除文本)，供人类阅读和理解。</p><p> Possible to apply even if the source has changed a bit by including some of the contexts around every part that has changed</p><p>即使源已稍有更改，也可以通过在已更改的每个部分周围包含一些上下文来应用。</p><p> Now, this is great when you are collaborating with humans on code development and use something like git to track your changes. What it isn’t great for, however, is expressing differences between structured documents (such as JSON) in a compact manner that can be efficiently transferred over the network and parsed in JavaScript inside of browsers.</p><p>现在，当您在代码开发上与人类协作并使用诸如git之类的东西来跟踪您的更改时，这是非常棒的。然而，它的不足之处在于以一种紧凑的方式表达结构化文档(如JSON)之间的差异，这种方式可以在网络上高效传输，并在浏览器内用JavaScript进行解析。</p><p>  Most diff formats are made to be human-readable. Take these two documents, where a key and the array have some changes between them:</p><p>大多数diff格式都是人类可读的。以这两个文档为例，在这两个文档中，密钥和数组之间有一些更改：</p><p>   If these where two commits, the Git diff between them would be expressed like this:</p><p>如果其中两个提交，则它们之间的Git差异将表示为：</p><p> --- left.json	2020-10-06 21:49:06.000000000 +0200+++ right.json	2020-10-06 21:49:35.000000000 +0200@@ -1,9 +1,9 @@ { &#34;name&#34;: &#34;Bob&#34;,- &#34;EXPERIMENTAL_foobar&#34;: {&#34;key&#34;: &#34;123&#34;},+ &#34;foobar&#34;: {&#34;key&#34;: &#34;123&#34;}, &#34;values&#34;: [+ {&#34;_key&#34;: &#34;ghi&#34;}, {&#34;_key&#34;: &#34;abc&#34;},- {&#34;_key&#34;: &#34;def&#34;},- {&#34;_key&#34;: &#34;ghi&#34;}+ {&#34;_key&#34;: &#34;def&#34;} ]-}+}</p><p>-left.json2020-10-06 21：49：06.000000000+0200+right.json2020-10-06 21：49：35.000000000+0200@@-1，9+1，9@@{&#34；名称&#34；：&#34；鲍勃&#34；，-&#34；实验性_foobar&#34；：{&#34；key&#34；：&#34；123&#34；}，+&#34；foobar&#34；：{&#34；key&#34；：&#34；123&#34；}，&#34；值&#34；：[+{&#34；_key&#34；：&#34；ghi&#34；}，{&#34；_key&#34；：&#34；abc&#34；}，-{&#34；_key&#34；：&#34；def&#34；}，-{&#34；_key&#34；：&#34；ghi&#34；}+{&#34；_Key&#34；：&#34；def&#34；}]-}+}。</p><p> This makes it somewhat practical for humans to understand what is going on when the latter change is applied. But as you can see, in terms of pure data, there is a lot of repetition going on. and expressing all changes with only plusses and minuses isn&#39;t very efficient.</p><p>这使得人类在应用后一种变化时理解所发生的事情变得有些实际。但正如你所见，就纯数据而言，有很多重复在进行。而且，只用正负来表达所有的变化并不是很有效。</p><p>   Mendoza constructs a minimal recipe for transforming a document into another. All it really does is to compare two JSON documents and figure out the most minimal way to express their difference as strings and integers in an array. You can use this difference to reconstruct the first document to the other.</p><p>门多萨构建了将一个文档转换为另一个文档的最小配方。它真正要做的就是比较两个JSON文档，并找出将它们的差异表示为数组中的字符串和整数的最小方法。您可以使用此差异将第一个文档重建为另一个文档。</p><p>  A Mendoza patch consists of an array of integers and strings. The integers are  opcodes (short for “operation codes”), 8-bit numbers that correspond to an operation. Opcodes take parameters as strings, positive numbers, or JSON values (that is: the actual data that is changing). The list of available opcodes is as follows, notice that 10-18 are composites of the preceding ones:</p><p>门多萨补丁由整数和字符串数组组成。整数是操作码(“操作码”的缩写)，是对应于操作的8位数字。操作码将参数作为字符串、正数或JSON值(即：正在更改的实际数据)。可用操作码列表如下，请注意，10-18是前面几个操作码的组合：</p><p> </p><p></p><p> Mendoza reads these opcodes from the patch and produces the resulting document from them. Depending on the patch, Mendoza might choose not to strictly follow the opcodes but take a simpler path. If every field and value has changed, for example, it’s more efficient just to replace the whole document with the new data without going through all the operations. Or if you have a list of objects where one has moved to another position and changed a key-value, Mendoza will manage to go back to the original and represent the change in a cheap way.</p><p>门多萨从补丁中读取这些操作码，并从它们生成结果文档。根据补丁的不同，门多萨可能会选择不严格遵循操作码，而选择一条更简单的路径。例如，如果每个字段和值都已更改，则只需用新数据替换整个文档，而无需执行所有操作，效率会更高。或者，如果您有一个对象列表，其中一个对象已移动到另一个位置并更改了键值，门多萨将设法返回到原始位置，并以一种廉价的方式表示更改。</p><p>  Mendoza is implemented in Go and can be found in this  . We have also made  , that you can use in your own application.</p><p>门多萨是在围棋中实现的，可以在这里找到。我们还制作了，您可以在您自己的应用程序中使用。</p><p> Of course, you can dive into   and explore how Mendoza is used there. If you want a slightly simpler use-case, you can also   in the browser to power the  .</p><p>当然，您可以深入了解门多萨是如何在那里使用的。如果您想要稍微简单一点的用例，您还可以在浏览器中为提供支持。</p><p>  Naming a project is always difficult. Since this project is focused on representing changes between  JSON documents I naturally started thinking about names like &#34;JSON differ, JSON changes, JSON patch, …&#34;. However, most of these names have already been used by existing projects. While I was muttering &#34;JSON, JSON, JSON&#34; it suddenly turned into &#34;JSON, JSON, Jason, Jason Mendoza&#34;.</p><p>给项目命名总是很困难的。因为这个项目的重点是表示JSON文档之间的更改，所以我自然开始考虑诸如JSON Different、JSON Changes、JSON patch、…之类的名称。&#34；。然而，这些名称中的大多数已经被现有项目使用。当我喃喃地说着JSON，JSON，JSON&34；它突然变成了JSON，JSON，杰森，杰森·门多萨。</p><p> Jason Mendoza is a character from the show The Good Place, and while this project has little in common with the stupidest DJ from Florida, at least it&#39;s short and catchy.</p><p>杰森·门多萨是电视剧“好地方”中的一个角色，虽然这个项目与佛罗里达州最愚蠢的DJ没有什么共同之处，但至少它简短而朗朗上口。</p><p>  Since a Mendoza patch is just describing the effect of a change it is also limited to work for the documents it was based on. It doesn’t come with guarantees for consistency if the document you apply it on has changed from the original in meanwhile. This is one of the tradeoffs that we needed to do to make it really compressed.</p><p>由于门多萨补丁只是描述更改的效果，因此它也仅限于用于它所基于的文档。如果在此期间应用它的文档已从原始文档更改，则它不会提供一致性保证。这是我们需要做的权衡之一，以使其真正压缩。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.sanity.io/blog/mendoza">https://www.sanity.io/blog/mendoza</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/stack/">#stack</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/文档/">#文档</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>