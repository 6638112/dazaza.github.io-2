<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>使用Yubikey作为Linux的非接触式神奇解锁密钥</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">使用Yubikey作为Linux的非接触式神奇解锁密钥</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-18 02:32:40</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/8/5e30f26d2d42847003e9559636dd5be4.png"><img src="http://img.diglog.com/img/2020/8/5e30f26d2d42847003e9559636dd5be4.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>YubiKey对安全性很有帮助，但当您将它们放在无人看管的计算机中时就不安全了。在这一点上，任何人都可以使用密钥进行双因素身份验证/SSH/GPG签名，所以这并不比仅仅使用普通密码好多少。不幸的是，当我离开电脑时，我有一个忘带钥匙的习惯。我还有登录密码，太长了，很容易打错。</p><p>谢天谢地，有一种方法可以解决这两个问题：放入计算机时使用Yubikey解锁，取出时锁定计算机！</p><p>我记得几年前看到的第一个这个概念的例子是Predator，Windows软件(有一个令人愉快的复古网站)，当你移除一个特殊的USB驱动器时，它会锁定你的电脑。Linux的类似示例包括pamusb，它允许您通过插入特殊格式的U盘使用Linux的PAM登录。</p><p>当然，现在大多数人使用Yubikey来完成这一任务，Yubio有方便的指南来指导如何完成这一任务。然而，我想让它成为非接触的-也就是说，我想能够插入我的Yubikey并立即解锁我的笔记本电脑，而不需要点击登录或触摸Yubikey按钮。删除后，我想立即锁定我的计算机。</p><p>网上有一些关于如何做到这一点的指南(插入时解锁，拔出时锁定)，但不幸的是，它们中的大多数都是本文描述的问题的牺牲品。他们中的许多人使用udev来检测Yubikey何时插入，但除了检查其供应商ID、型号ID，有时还会检查序列号(所有这些都很容易被伪造)之外，它们实际上并不验证密钥。</p><p>为了提供实际的安全性，大多数官方指南使用pam_u2f(通过U2F协议验证Yubikey)或pam_yubito(使用通过YubiCloud的在线验证或通过挑战-响应协议的离线验证)。U2F方法需要轻触Yubi键，而挑战-响应过程可以在没有用户交互的情况下完成，所以我选择了后者。我使用这个来自System76的优秀指南设置了传统的Yubikey身份验证。</p><p>然而，当我插入钥匙时，我仍然需要一些方法来测试挑战-响应是否成功。通常，当您登录或解锁计算机时(即按锁屏上的Enter键)，会运行pam_yubito。但我不想要任何点击，所以我需要一种在没有交互的情况下运行它的方法。</p><p>这些规则在插入和删除键时有效地调用脚本，因此我可以从脚本触发任何操作。请注意，该脚本不应立即解锁计算机，以避免前面提到的安全问题。</p><p>为了实际测试插入时Yubikey的挑战响应，我决定使用pamtester，这是一个简单的实用程序，假装从命令行触发PAM身份验证。由于安装了pam_yubito，因此如果插入yybikey，这将自然地测试质询响应。</p><p>#！/bin/bash exec 1&gt；&gt；(logger-s-t&#34；$(basename&#34；$0&#34；)&#34；)2&gt；&amp；1echo&#34；运行&#34；如果[&#34；$1&#34；=&#34；=&#34；锁定&#34；]；则pkill-USR1 swaydle否则#unlock if echo&34；&#34；|pam34；则#PAM登录成功#kill locker kill$(Pgrep Swaylock)PS AUX|grep swaylock#On On显示SWAYSOCK=$(ls/run/user/1000/sway-ip.*.sock)swaymsg&#34；output*DPMS on&#34；fi退出0。</p><p>锁定时，它会立即锁定我的桌面(通过向swayIdle发送SIGUSR1，该程序管理对Sway窗口管理器的锁定)。</p><p>在解锁时，它首先查看是否可以在没有交互的情况下使用pamtester进行身份验证(当没有插入Yubikey或密钥无效时，pamtester会要求输入密码)。如果可以，它会关闭锁屏，并使用Sway WM协议打开所有显示器。</p><p>最后的结果是令人惊讶的方便，并成功地让我记得拔出我的Yubikey时，我的电脑不只一次无人看管2！任务成功。</p><p>是的，是的，我知道不会有太大的危险，因为我们现在都困在家里。但谁知道呢--也许当我们最终回到校园时，这会有所帮助。↩︎。</p><p>由Disqus提供支持的评论</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://kliu.io/post/yubico-magic-unlock/">https://kliu.io/post/yubico-magic-unlock/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/yubikey/">#yubikey</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/touchless/">#touchless</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1018608.html"><img src="http://img.diglog.com/img/2020/8/thumb_3737e981591a0266a159b239ff6464d5.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018608.html">系统管理员常用的Linux命令-第2部分</a></div><span class="my_story_list_date">2020-8-17 14:13</span></div><div class="col-sm"><div><a target="_blank" href="/story/1018603.html"><img src="http://img.diglog.com/img/2020/8/thumb_cddb82e3f81246946e16d32c9dbcd1e3.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018603.html">Linux PinePhone有用于相机、麦克风、数据、BT、Wi-Fi的物理终止开关</a></div><span class="my_story_list_date">2020-8-17 13:16</span></div><div class="col-sm"><div><a target="_blank" href="/story/1018594.html"><img src="http://img.diglog.com/img/2020/8/thumb_31e289ab07e9ec96774097f836b3c275.gif" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018594.html">自从谷歌宣布Google Drive Linux客户端即将推出以来，有多久了？</a></div><span class="my_story_list_date">2020-8-17 11:15</span></div><div class="col-sm"><div><a target="_blank" href="/story/1018587.html"><img src="http://img.diglog.com/img/2020/8/thumb_db616e8a601269eef2ea1b09645af6e1.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018587.html">评论家称基于Linux的PinePhone是“我多年来尝试过的最有趣的智能手机”。</a></div><span class="my_story_list_date">2020-8-17 9:52</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>