<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>16位MS-DOS内存模型回顾</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">16位MS-DOS内存模型回顾</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-11 03:47:26</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/8/d5ac22b6724f715986d70f6c316f3742.jpg"><img src="http://img.diglog.com/img/2020/8/d5ac22b6724f715986d70f6c316f3742.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>在MS-DOS和16位Windows编程中，您必须处理内存模型。这个术语不是指处理器体系结构内存模型(处理器如何与内存交互)，而是指程序如何在内部组织自身。操作系统本身对应用程序内存模型一无所知；它只是讨论程序如何处理不同类型的代码和数据的一种便捷方式。</p><p>内存模型的术语来自C编译器，因为这会通知编译器要生成哪种类型的代码。四种基本型号可以放进一张漂亮的桌子里：</p><p>8086使用分段存储器，这意味着指针由两部分组成：段和偏移量。远指针由段和偏移量组成。近指针仅由偏移量组成，并隐含了段。</p><p>一旦您拥有超过64KB的代码或超过64KB的数据，您就必须(分别)切换到远代码指针或远数据指针，以便引用所需的所有内容。</p><p>我的大多数程序都是紧凑的，这意味着代码不是很多，但是有很多数据。这是因为我编写的程序倾向于进行大量的数据处理。</p><p>介质模型对于具有大量代码但数据不多的程序非常有用。用户界面代码通常属于这一类，因为您必须编写大量代码来管理对话框，但所有这些工作的结果只是一个文本字符串(来自编辑框)和一些标志(来自某些复选框)。很多电脑游戏也属于这一类，因为你有很多的游戏逻辑，但是没有太多的游戏状态。</p><p>MS-DOS有一个额外的内存模型，称为微型机，其中代码和数据都被合并到一个64KB的段中。这是以.com扩展名结尾的程序所需的内存模型，它的存在是为了向后兼容CP/M。CP/M在支持最大64KB内存的8080处理器上运行。</p><p>远指针可以访问8086的1MB地址空间中的任何内存，但每个对象仍然被限制在64KB，因为指针运算只在指针的偏移部分执行。每当偏移量溢出时，通过调整段，大指针可以引用大于64KB的内存块。²使用大指针的指针算术计算开销很大，因此您不会经常使用它们。²</p><p>您并不局限于上述内存模型。您可以自己编写，称为混合模型编程。例如，您可以说您的程序的大部分是小内存模型，但是有一个地方您需要访问默认数据段之外的内存，因此您为此声明了一个显式的远指针。类似地，您可以定义一个显式的Far函数来将其移出默认代码段。</p><p>内存模型指定了默认行为，因此如果调用(比方说)memcpy，就会得到一个指针大小与内存模型匹配的版本。如果您有一个小型或中型的程序，并且想要复制默认数据段之外的内存，您可以调用_fmemcpy函数，该函数与memcpy相同，只是它需要较远的指针。(如果您使用的是紧凑型或大内存模型，则memcpy和_fmemcpy是相同的。)。</p><p>我的一位前同事回到了学校，正在和他(年轻的)导师交谈。不知何故，话题转向了8086处理器。我的同事和他的朋友解释了分段寻址、近指针和远指针、指针相等和比较的行为方式、神秘的A20门，以及实模式引导扇区是如何工作的。“他对分部寄存器过去的工作方式感到恐惧的表情是无价的。”</p><p>我很快纠正了我的同事。“‘以前工作过’？他们还在这样做呢！“。</p><p>额外的优势：您可以在windows.h定义的近宏和远宏中看到16位内存模型的残留物。它们不再有任何意义，但它们仍然是为了源代码向后兼容。</p><p>？在MS-DOS中，通过将20位地址的高16位放入段中并将剩余的4位放入偏移量来操作巨大的指针。MS-DOS中巨型指针的偏移量始终小于16。</p><p>²在16位Windows中，有一个名为hmemcpy的系统函数，它复制可能大于64KB的内存块。现在你知道h前缀代表什么了。</p><p>³分段内存是反例的一个很好的来源。例如，在分段内存模型中，可以有一个指向大小为N的缓冲区的指针p，而另一个指针q可以满足不等式</p><p>这就是为什么C和C++编程语言不指定不指向同一数组元素的指针之间的比较结果的原因之一。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://devblogs.microsoft.com/oldnewthing/20200728-00/?p=104012">https://devblogs.microsoft.com/oldnewthing/20200728-00/?p=104012</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/内存/">#内存</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ms/">#ms</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/指针/">#指针</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1017327.html"><img src="http://img.diglog.com/img/2020/8/thumb_586e0defe0ce03e4f6eb1ed969fd929d.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1017327.html">围棋中的分布式内存数据结构。可嵌入或独立的服务</a></div><span class="my_story_list_date">2020-8-10 21:16</span></div><div class="col-sm"><div><a target="_blank" href="/story/1015934.html"><img src="http://img.diglog.com/img/2020/8/thumb_4027801a27d9001d8b49466bb1e412e6.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1015934.html">在数据中心“隐藏”网络延迟以实现快速内存</a></div><span class="my_story_list_date">2020-8-4 0:37</span></div><div class="col-sm"><div><a target="_blank" href="/story/1015092.html"><img src="http://img.diglog.com/img/2020/7/thumb_8032faff566c06033707ae6a643402a8.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1015092.html">三星公布第二季度销售额约445亿美元，同比下降5.6%，但营业利润约68亿美元，同比增长23.5%，原因是对内存芯片的需求增加</a></div><span class="my_story_list_date">2020-7-30 10:16</span></div><div class="col-sm"><div><a target="_blank" href="/story/1013973.html"><img src="http://img.diglog.com/img/2020/7/thumb_55279394690e0ef1abb5e6ba4ee351a2.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1013973.html">Windows 286</a></div><span class="my_story_list_date">2020-7-24 23:11</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>