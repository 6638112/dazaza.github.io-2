<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Bash陷阱</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Bash陷阱</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-08 07:17:28</div><div class="page_narrow text-break page_content"><p>或者，你知道，停止使用expr。通过使用参数展开，您可以执行expr所做的所有操作。上面的那个东西想做什么？是否删除单词的第一个字母？这可以在POSIX shell中使用PE或子字符串扩展来完成：说真的，除非您在Solaris上使用不符合POSIX的/bin/sh，否则没有理由使用expr。它是一个外部进程，所以它比进程内字符串操作慢得多。由于没有人使用它，也没有人理解它在做什么，所以您的代码很混乱，很难维护。通常：Unix UTF-8文本不使用BOM。纯文本的编码由区域设置、MIME类型或其他元数据确定。虽然BOM的存在通常不会损坏仅供人类阅读的UTF-8文档，但在任何旨在由自动化过程(如脚本、源代码、配置文件等)解释的文本文件中，BOM是有问题的(通常在语法上是非法的)。应将以BOM开头的文件视为与带有MS-DOS换行符的文件相同的外来文件。在外壳脚本中：在8位环境中透明使用UTF-8的情况下，使用物料清单会干扰任何需要在开头使用特定ASCII字符的协议或文件格式，例如在UNIX外壳脚本的开头使用的。&#39；http://unicode.org/faq/utf_bom.html#bom5没有。这个表达式没有任何错误，但是您应该注意命令替换(所有形式：`...`、$(...)、$(&lt；file)、`&lt；file`和${0...；9}(Ksh))会删除所有尾随换行符。这通常是无关紧要的，甚至是可取的，但是如果您必须保留文字输出，包括任何可能的尾随换行符，这就变得很棘手，因为您无法知道输出中是否有它们，或者有多少。一种难看但有用的解决方法是在命令替换内添加后缀，并在外部删除它：另一种可移植性较差但可以说更漂亮的解决方案是使用带有空分隔符的read。#ksh(或启用lasttube的bash 4.2+)readlink-fn--&#34；$dir_path&#34；|IFS=读取-rd&#39；&#39；绝对目录路径。</p><p>此方法的缺点是，除非命令输出NUL字节，导致仅读取部分流，否则读取将始终返回FALSE。获取命令退出状态的唯一方法是通过PIPESTATUS。您还可以有意输出NUL字节以强制read返回true，并使用pipeail。Set-o pipeail{readlink-fn--&#34；$dir_path&#34；&amp；&amp；printf&#39；\0&#39；}|IFS=读取-rd&#39；&#39；绝对目录路径设置+o pipeail。</p><p>这在某种程度上造成了可移植性的混乱，因为Bash同时支持pipeail和PIPESTATUS，ksh93仅支持pipeail，并且只有最新版本的mksh支持pipeail，而早期版本仅支持PIPESTATUS。此外，需要最先进的ksh93版本才能在NUL字节停止读取。防止程序将传递给它们的文件名解释为选项的一种方法是使用路径名(请参阅上面的陷阱#3)。对于当前目录下的文件，名称可以使用相对路径名./作为前缀。但是，对于*.*这样的模式，可能会出现问题，因为它与./filename形式的字符串匹配。在一个简单的例子中，您可以直接使用GLOB来生成所需的匹配。但是，如果需要单独的模式匹配步骤(例如，结果已经过预处理并存储在数组中，需要过滤)，则可以通过在模式中考虑前缀[[$file！=./*.*]]或从匹配中剥离模式来解决此问题。#bash shop-s nullglob for path in./*；do[[${path##*/}！=*.*]]&amp；&amp；rm&#34；$path&#34；为*中的文件执行#或更好的操作；为*；中的文件执行[[$file！=*.*]]&amp；&amp；rm&#34；./$file&#34；do#或更好的操作*.*；do rm&#34；./$file&#34；</p><p>另一种可能性是用--参数表示选项的结束。(同样，见#pf3)。在*；do[[$file！=*.*]]&amp；&amp；rm--&#34；$file&#34；中文件的shop-s nullglob已完成。</p><p>这是迄今为止最常见的涉及重定向的错误，通常是由希望将stdout和stderr同时定向到一个文件或管道的人执行的，他们会尝试这样做，但不理解为什么stderr仍然出现在他们的终端上。如果您对此感到困惑，那么您可能一开始就不了解重定向或可能的文件描述符是如何工作的。在执行命令之前，从左到右评估重定向。这个语义上不正确的代码实质上意味着：&#34；首先将标准错误重定向到标准输出当前指向的位置(Tty)，然后将标准输出重定向到日志文件&#34；。这是倒退的。标准错误已经送到TTY了。改为使用以下内容：查看更深入的说明、复制描述符说明和BashGuide-重定向。$？只是请求</p><p>请勿导出CDPATH。在.bashrc中设置CDPATH不是问题，但是导出它会导致您运行的任何bash或sh脚本(碰巧使用cd)可能会更改行为。有两个问题。执行以下操作的脚本可能会将目录更改为~/myProject/ome/dir，而不是./ome/dir，具体取决于当时存在的目录。因此，CD可能会成功，并将脚本带到错误的目录，这可能会对以下命令产生有害影响，这些命令现在运行在与预期目录不同的目录中。第二个问题是，当cd在捕获输出的上下文中运行时：设置CDPATH时的副作用是，cd会将类似/home/user/ome/dir的内容输出到stdout，以指示它通过CDPATH找到了一个目录，这反过来将在输出变量中与某个命令的预期输出一起结束。脚本可以通过始终将./前缀到相对路径，或在脚本开始时运行unset的CDPATH，使其自身不受从环境继承的CDPATH的影响，但不要假设每个脚本编写者都已考虑到此缺陷，因此不要导出CDPATH。仅将变量的值直接赋给临时变量是不足以恢复其状态的。即使未设置初始变量，赋值也始终会产生已设置但为空的临时变量。对于IFS来说，这是一个特别的问题，因为空IFS与未设置的IFS具有完全不同的含义，将IFS设置为一个或两个命令的临时值是常见的要求。一种简单的解决方法是指定一个前缀来区分set和unset变量，然后在完成时将其删除。在可能的情况下，局部变量通常更可取。子壳是另一种可能性。用原始$(...)填充数组是不安全的。司令部代办。该命令的输出经历了单词拆分(在所有空格上，甚至在引号内的空格上)，然后进行整形。如果有像*或嗯这样的词？或[abc]，它将根据当前工作目录中的文件名展开。要选择替换项，您需要知道该命令是将其输出写入单行还是多行。如果它是单行：如果它是多行(并且您的目标是bash 4.0或更高版本)：如果它是多行(并且您希望与bash 3.x兼容，或者希望您的命令的退出状态反映在读取操作的成功或失败中，而不依赖于仅在bash 4.4和更高版本中提供的行为)：这将防止全局绑定。如果您需要避免在带引号的空格上拆分，它仍然帮不了您，但不幸的是，bash无法处理这种情况。对于通用的CSV(逗号分隔值)文件处理，您确实需要切换到具有专用CSV输入库的语言。GNU xargs支持并行运行多个作业。-P-n，其中n是要并行运行的作业数。序列100|xargs-N1-P10 ECHO&#34；$a&#34；|grep 5序列100|xargs-N1-P10 ECHO&#34；$a&#34；&gt；myoutput.txt。</p><p>这在许多情况下都可以很好地工作，但是有一个欺骗性的缺陷：如果$a包含超过8192个字符(限制取决于平台和版本)，那么回显可能不是原子的(它可能被分成多个write()调用)，并且存在两行混合的风险。$perl-e&39；print&#34；a&#34；x10000，&#34；\n&#34；&gt；foo$strace-e write bash-c&#39；read-r foo&lt；foo；foo；ECHO&#34；$foo&#34；&#39；&gt；/dev/NULL WRITE(1，&#34；aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#34；...，8192)=8192Write(1，&#34；aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#34；...，1809)=1809+exe。</p><p>显然，如果多次调用echo或printf：slowprint(){printf&#39；start-%s&#39；&#34；$1&#34；sleep&#34；$1&#34；printf&#39；%s-end\n&#39；&#34；$1&#34；}export-f slowprint seq 10|xargs-N1-i{}-P4 bash-c&#34；slowprint{}&。#对比没有并行化的seq 10|xargs-n1-i{}bash-c&#34；slowprint{}&#34；#请务必看到下一个Pitfall中的警告！</p><p>并行作业的输出混合在一起，因为每个作业由两个(或更多)单独的write()调用组成。如果您需要未混合的输出，因此建议使用保证输出将被序列化的工具(例如GNU并行)。有关更多详细信息，请参阅混合问题演示。此命令包含CodeInjection漏洞。Find找到的文件名被注入shell命令并由sh解析。如果文件名包含外壳元字符，如；或$(#...)，则可以通过`sh&#39；将文件名作为代码执行。如果输入不能保证是整数，上一个Pitfall中的Slowprint&34；示例将是一个CodeInjection错误。更准确地说，POSIX find没有指定包含以下内容的参数</p><p>如果您的系统的strftime()不支持%s，您可以使用以下命令获取纪元时间：强制基数10解释仅适用于无符号数字。只要$i包含一个没有前导-或+的数字字符串，就可以了。但是，如果$i可能为负值，则此转换可能会失败，可能会有噪音(带有错误消息)，或者更糟糕的是，会静默地失败(只是产生错误的结果)。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://mywiki.wooledge.org/BashPitfalls">https://mywiki.wooledge.org/BashPitfalls</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/bash/">#bash</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>