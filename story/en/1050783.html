<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>M1 MacBook Air在浏览器中击中900GFLOPS，使用Safari的实验WebGPU M1 MacBook Air Hits 900GFlops in the Browser with Safari's Experimental WebGPU</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">M1 MacBook Air Hits 900GFlops in the Browser with Safari's Experimental WebGPU<br/>M1 MacBook Air在浏览器中击中900GFLOPS，使用Safari的实验WebGPU </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-04 04:51:14</div><div class="page_narrow text-break page_content"><p>### Yet another impressive M1 statistic (that you can try in the browser)Safari supports WebGPU experimentally with WSL kernels.I wrote a simple tuner that tries to optimize matrix multiplication.If you have Safari, you can try it [here](https://jott.live/html/webgpu_demo.html).(You&#39;ll need to enable WebGPU in Develop &gt; Experimental Features.)My **M1 MacBook Air achieves 900GFlops** aftera couple seconds of tuning.My Intel MacBook Pro only hits 100GFlops with the same exhaustive search.For reference, MobileNet v3 Large (x1.0) is ~219MFlops.Running at this performance, it could do 4,500 inferences **per second**.The base BERT model (12 layers) is 11.2 GFlops. At this perf,one could theoretically run it 90 times a second.The basic idea is to tile memory accesses,vectorize, use `mad` instructions and tune for threading and dispatchparameters.The result is a kernel that looks like this:```[numthreads(2, 8, 1)]compute void main(constant float4[] A : register(u0), constant float4[] B : register(u1), device float4[] C : register(u2), float3 threadID : SV_DispatchThreadID) { uint m = uint(threadID.x); uint n = uint(threadID.y); float4 result_0_0 = float4(0.0, 0.0, 0.0, 0.0); float4 result_1_0 = float4(0.0, 0.0, 0.0, 0.0); float4 result_2_0 = float4(0.0, 0.0, 0.0, 0.0); float4 result_3_0 = float4(0.0, 0.0, 0.0, 0.0); for (uint k = 0; k &lt; 256; k++) { float4 a_0_0 = A[(m * 4 + 0) * 256 + (k * 1 + 0)]; float4 a_1_0 = A[(m * 4 + 1) * 256 + (k * 1 + 0)]; float4 a_2_0 = A[(m * 4 + 2) * 256 + (k * 1 + 0)]; float4 a_3_0 = A[(m * 4 + 3) * 256 + (k * 1 + 0)]; float4 b_0_0 = B[(k * 4 + 0) * 256 + (n * 1 + 0)]; float4 b_0_1 = B[(k * 4 + 1) * 256 + (n * 1 + 0)]; float4 b_0_2 = B[(k * 4 + 2) * 256 + (n * 1 + 0)]; float4 b_0_3 = B[(k * 4 + 3) * 256 + (n * 1 + 0)]; result_0_0 += mul(a_0_0.x, b_0_0); result_1_0 += mul(a_1_0.x, b_0_0); result_2_0 += mul(a_2_0.x, b_0_0); result_3_0 += mul(a_3_0.x, b_0_0); result_0_0 += mul(a_0_0.y, b_0_1); result_1_0 += mul(a_1_0.y, b_0_1); result_2_0 += mul(a_2_0.y, b_0_1); result_3_0 += mul(a_3_0.y, b_0_1); result_0_0 += mul(a_0_0.z, b_0_2); result_1_0 += mul(a_1_0.z, b_0_2); result_2_0 += mul(a_2_0.z, b_0_2); result_3_0 += mul(a_3_0.z, b_0_2); result_0_0 += mul(a_0_0.w, b_0_3); result_1_0 += mul(a_1_0.w, b_0_3); result_2_0 += mul(a_2_0.w, b_0_3); result_3_0 += mul(a_3_0.w, b_0_3); } C[(m * 4 + 0) * 256 + (n * 1 + 0)] = result_0_0; C[(m * 4 + 1) * 256 + (n * 1 + 0)] = result_1_0; C[(m * 4 + 2) * 256 + (n * 1 + 0)] = result_2_0; C[(m * 4 + 3) * 256 + (n * 1 + 0)] = result_3_0;}dispatch params: 128,32,1```Clearly more can be done to tune it(such as factoring out the `K` dimension a bit more or doing more levels of tiling),but I&#39;m quite happy with the results.Hitting nearly 1TFlops in the browser (50% of peak) is extremely empowering andit&#39;s exciting to see such technology available.</p><p>###还有另一个令人印象深刻的M1统计信息（你可以在浏览器中尝试）Safari通过WSL Kernels通过WSL Kernels实验支持WebGPU.I写了一个简单的调谐器，它试图优化矩阵乘法。如果您有Safari，则可以尝试[这里]（ https://jott.live/html/webgpu_demo.html），p).（您有效地启用WebGPU，在Develop和GT中启用WebGPU;实验功能。）我的** M1 MacBook Air实现900GFLOPS **后换秒秒。MY英特尔MacBook Pro只达到100GFlops，具有相同的详尽搜索。如图所示，MobileNet V3大（x1.0）是〜219mflock.running在这种性能下，它可以执行4,500个推论**每秒**。基础BERT模型（12层）是11.2 GFLOPS。在这个完善的情况下，理论上可以理解90次。基本思想是瓷砖内存访问，矢量化，使用`mad`指令和曲调来进行线程和调度参数。结果是一个看起来像这样的内核：``` [NumThreads（2,8,1）]计算void main（常量float4 [] a：寄存器（u0），常量float4 [] b：寄存器（u1），设备float4 [] c：寄存器（u2），float3 threadid： sv_dispatchthreadid）{uint m = uint（threadid.x）; uint n = uint（threadid.y）; FLOAT4结果_0_0 = FLOOT4（0.0，0.0,0.0，0.0）; FLOAT4结果_1_0 = FLOAT4（0.0,0.0,0.0，0.0）; FLOAT4结果_2_0 = FLOAT4（0.0，0.0,0.0，0.0）; FLOAT4结果_3_0 = FLOAT4（0.0，0.0,0.0，0.0）; for（uint k = 0; k＆lt; 256; k ++）{float4 a_0_0 = a [（m * 4 + 0）* 256 +（k * 1 + 0）]; float4 a_1_0 = a [（m * 4 + 1）* 256 +（k * 1 + 0）]; float4 a_2_0 = a [（m * 4 + 2）* 256 +（k * 1 + 0）]; float4 a_3_0 = a [（m * 4 + 3）* 256 +（k * 1 + 0）]; float4 b_0_0 = b [（k * 4 + 0）* 256 +（n * 1 + 0）]; float4 b_0_1 = b [（k * 4 + 1）* 256 +（n * 1 + 0）]; float4 b_0_2 = b [（k * 4 + 2）* 256 +（n * 1 + 0）]; float4 b_0_3 = b [（k * 4 + 3）* 256 +（n * 1 + 0）];结果_0_0 + = mul（a_0_0.x，b_0_0）;结果__0 + = mul（a_1_0.x，b_0_0）;结果_2_0 + = mul（a_2_0.x，b_0_0）;结果_3_0 + = mul（a_3_0.x，b_0_0）;结果_0_0 + = mul（a_0_0.y，b_0_1）;结果__0 + = mul（a_1_0.y，b_0_1）;结果_2_0 + = mul（a_2_0.y，b_0_1）;结果_3_0 + = mul（a_3_0.y，b_0_1）;结果_0_0 + = mul（a_0_0.z，b_0_2）;结果__0 + = mul（a_1_0.z，b_0_2）;结果_2_0 + = mul（a_2_0.z，b_0_2）;结果_3_0 + = mul（a_3_0.z，b_0_2）;结果_0_0 + = mul（a_0_0.w，b_0_3）;结果__0 + = mul（a_1_0.w，b_0_3）;结果_2_0 + = mul（a_2_0.w，b_0_3）;结果_3_0 + = mul（a_3_0.w，b_0_3）; } C [（m * 4 + 0）* 256 +（n * 1 + 0）] =结果_0_0; c [（m * 4 + 1）* 256 +（n * 1 + 0）] =结果_1_0; c [（m * 4 + 2）* 256 +（n * 1 + 0）] =结果_2_0; C [（m * 4 + 3）* 256 +（n * 1 + 0）] =结果_3_0;}派遣参数：更频繁地调整128,32,1.1 /}（例如要对`提供k`维度更多或做更多级别的平铺），但是我对结果很满意。浏览器中的近1TFlops（峰值的50％）非常赋予＆＃39;令人兴奋的＆＃39;令人兴奋的可用技术。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://jott.live/markdown/m1_webgpu_perf">https://jott.live/markdown/m1_webgpu_perf</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/macbook/">#macbook</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/air/">#air</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/webgpu/">#webgpu</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>