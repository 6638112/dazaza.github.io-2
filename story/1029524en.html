<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>廉价的电能测量：重新调整WiFi电源插头的用途</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">廉价的电能测量：重新调整WiFi电源插头的用途</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-18 07:14:57</div><div class="page_narrow text-break page_content"><p>Following the BoF on power consumption of software Cornelius chaired at Akademy 2020 I didlook a bit into tooling for that, in particular for cheap ways to measure electrical powerconsumption. Here are the results so far.</p><p>继在Akademy 2020上主持的关于软件功耗的BoF会议之后，我对工具进行了一些研究，特别是寻找测量电能消耗的廉价方法。以下是到目前为止的结果。</p><p>  Our existing profiling tools for improving software performance implicitly also identify partsthat presumably increase the power consumption, and we do have specialized tools like  powertop thatare good at identifying specific types of power drains. But not everything is visible in there,e.g. CPU/GPU trade-offs, or the actual effects of power management options or display settings.</p><p>我们现有的用于提高软件性能的评测工具也隐含地识别了可能会增加功耗的部件，并且我们确实有像Powertop这样的专门工具，能够很好地识别特定类型的功耗。但并不是所有的东西都是可见的，例如CPU/GPU的权衡，或者电源管理选项或显示设置的实际效果。</p><p> So being able to measure the actual power consumption between the wall plug and the full device seemsuseful, to the very least to verify that assumptions we make from other profiling tools actually hold.</p><p>因此，能够测量墙上插头和整个设备之间的实际功耗似乎是有意义的，至少可以验证我们从其他分析工具做出的假设实际上是成立的。</p><p>  Measuring electrical power isn’t exactly an unsolved problem, even if it’s not entirely trivial whenlooking at the combination of  alternating currentand  switching power supplies.However, it’s not straightforward to find a solution when adding all our desired constraints:</p><p>测量电功率并不完全是一个没有解决的问题，即使在考虑交流电和开关电源的组合时，它也不是完全微不足道的。但是，当添加所有我们想要的约束时，找到一个解决方案并不是简单的：</p><p> Work with a wide range of devices to measure without requiring modifications, and covering the totalpower consumption, ideally something you just connect to the power plug and the wall socket.</p><p>使用多种设备进行测量，无需修改，覆盖总功耗，理想情况下只需连接电源插头和墙上插座即可。</p><p>  High time resolution: Power consumption of computing hardware can change very very rapidly, averagingover a long time period might thus hide information relevant for us.</p><p>高时间分辨率：计算硬件的功耗可以非常非常迅速地变化，如果计算硬件的平均耗电量在很长一段时间内保持不变，则可能会隐藏与我们相关的信息。</p><p>  Cheap: To actually make an impact, I think we need to spread the equipment widely in the community,and that’s much more likely with tools that cost 10€ rather than a few k€.</p><p>便宜：为了真正产生影响，我认为我们需要在社区中广泛传播这些设备，而这更有可能是使用价格为10欧元的工具，而不是几千欧元的工具。</p><p>  Easy and safe to operate for people without an electrical engineering background: Same as the above, that shouldhelp spreading the tools widely.</p><p>对于没有电气工程背景的人来说，操作简单安全：如上所述，这将有助于工具的广泛推广。</p><p>  Bonus: Machine readable measurement data. That could allow us to build further software tools on top of this,such as test automation or CI integration for checking for power regressions.</p><p>奖励：机器可读的测量数据。这可以让我们在此基础上构建更多的软件工具，例如用于检查幂回归的测试自动化或CI集成。</p><p>  If you compromise on time resolution, there’s reasonably accurate devices soldfor about 10€ in every hardware store as e.g. “energy monitor”, typically with a smallLCD screen showing the accumulated electricity use over a period of time.</p><p>如果你在时间分辨率上做出妥协，每个硬件商店都有相当精确的设备出售，大约10欧元，比如“能源监控器”，通常带有一个小LCD屏幕，显示一段时间内的累计用电量。</p><p>  If you compromise on safety (or at least accept considerable effort to achieve safety),the necessary sensors to build a DIY measurement device only cost a few Euros.</p><p>如果你在安全性上妥协(或者至少接受相当大的努力来实现安全性)，制造DIY测量设备所需的传感器只需几欧元。</p><p>  While preparing the office at work for full remote operations earlier this year I came across a type of devices that seemedto check all those boxes though: A Wifi-controlled power plug capable of running a Free Software firmware and an integratedpower sensor.</p><p>今年早些时候，当我在办公室为全面远程操作做准备时，我遇到了一种似乎可以勾选所有这些选项的设备：一个能够运行自由软件固件的无线控制电源插头和一个集成的电源传感器。</p><p> To try this I got myself a few  Gosund SP111 for about 8€ a piece,and replaced their firmware with  Tasmota.The  manual flashing instructions might looka bit scary, but thanks to “opportunities” in their stock firmware this can also be done conveniently over the air using tuya-convert. Following the Docker-based approach in theirinstructions made this work on first try without any issues for me. Out of the box this was already showing power measurements in itsweb UI, with an update interval of a few seconds.</p><p>为了试一试，我花了大约8欧元一个给自己买了几个Gosund SP111，并用Tasmota替换了他们的固件。手动闪烁指令可能看起来有点可怕，但多亏了他们库存固件中的“机会”，这也可以通过空中TUYA-CONVERT方便地完成。在他们的说明中遵循基于Docker的方法，使得这项工作在第一次尝试时就完成了，对我来说没有任何问题。开箱即用，它已经在其Sweb UI中显示了功率测量，更新间隔为几秒钟。</p><p>  The initial values were not at all plausible though, going through the power calibration procedure helped with that.Reading out measurements automatically is possible via MQTT, so that’s covered as well.</p><p>虽然初始值完全不可信，但通过功率校准程序对此很有帮助。通过MQTT自动读出测量值是可能的，所以这也包括在内。</p><p> At this point I was reading through the firmware code, assuming it would need adjustments to allow higher sample rates,but it turns out we can get this down to 200ms by just sending the right MQTT commands. The two following crude scripts runningin parallel produce a CSV stream with the various measurement values.</p><p>在这一点上，我正在阅读固件代码，假设它需要调整以允许更高的采样率，但事实证明，我们只需发送正确的MQTT命令就可以将其降低到200ms。以下两个并行运行的原始脚本生成具有各种测量值的CSV流。</p><p> mosquitto_pub  -t  &#34;cmnd/tasmota/VoltRes&#34;  -m  &#34;3&#34;mosquitto_pub  -t  &#34;cmnd/tasmota/AmpRes&#34;  -m  &#34;3&#34;mosquitto_pub  -t  &#34;cmnd/tasmota/PowerRes&#34;  -m  &#34;5&#34; while  true ;  do usleep 200000 mosquitto_pub  -t  &#34;cmnd/tasmota/STATUS&#34;  -m  &#34;10&#34; done</p><p>蚊子_酒吧-t&#34；-m&#34；-m&#34；3&#34；蚊子_酒吧-t&#34；-m&#34；3&#34；蚊子酒吧-t&#34；cmnd/tasmota/powerres&#34；-m&#34；5&#34；当为真时；是否睡眠200000蚊子_酒吧-t&#34；cmnd/tasmota/status&#34；-m&#34；10&#34；完成</p><p> This sets the device to report measurements in the highest available resolution, and then polls in a 200ms interval. Theresults are received and unpacked by the next script. Its output is CSV that can be redirected as needed.</p><p>这会将设备设置为以最高可用分辨率报告测量结果，然后以200ms间隔轮询。结果由下一个脚本接收并解压缩。它的输出是可以根据需要重定向的CSV。</p><p> echo  &#34;Time;Voltage;Current;Power;Apparent Power;Reactive Power;Factor&#34; time =0mosquitto_sub  -t  &#39;stat/tasmota/STATUS10&#39; |  while  IFS =  read  -r line do  time = $(( time + 200 ))  voltage = ` echo  $line | jq  &#34;.StatusSNS.ENERGY.Voltage&#34; `  current = ` echo  $line | jq  &#34;.StatusSNS.ENERGY.Current&#34; `  power = ` echo  $line | jq  &#34;.StatusSNS.ENERGY.Power&#34; `  apparent_power = ` echo  $line | jq  &#34;.StatusSNS.ENERGY.ApparentPower&#34; `  reactive_power = ` echo  $line | jq  &#34;.StatusSNS.ENERGY.ReactivePower&#34; `  power_factor = ` echo  $line | jq  &#34;.StatusSNS.ENERGY.Factor&#34; `  echo  &#34; $time ; $voltage ; $current ; $power ; $apparent_power ; $reactive_power ; $power_factor &#34; done</p><p>ECHO&#34；时间；电压；电流；功率；视在功率；无功功率；因数&#34；time=0蚊子_sub-t&#39；stat/tasmota/STATUS10&#39；|While IFS=read-r line do time=$((time+200))VOLTION=`ECHO$LINE|JQ&#34；.StatusSNS.ENERGY.Voltv&#34；`Current=`ECHO$LINE|JQ&#34；.StatusSNS.ENERGY.Current&#34；`power=`ECHO$LINE|JQ&#34；`power=`ECHO$LINE|JQ&#34；.StatusSNS.ENERGY.Current&#34；`power=`ECHO$LINE|JQ&#34；.StatusSNS.ENERGY.Power&#34；`ApparentPower=`ECHO$LINE|JQ&#34；.StatusSNS.ENERGY.ApparentPower&#34；`RESPECTIVE_POWER=`ECHO$LINE|JQ&#34；.StatusSNS.ENERGY.ReactivePower&#34；`power_factor=`ECHO$LINE|JQ&#34；.StatusSNS.ENERGY.factor&#34；`ECHO&#34；$time；$VOLVAL；$CURRENT；$POWER；$APHERWORY；$POWER_F因子&#34；完成。</p><p>  There’s plenty of ways to process the CSV data, a real-time view turned out to be quite useful though. As the datacan be rather noisy a basic smoothing filter also helps to make things easier to read.</p><p>有很多方法可以处理CSV数据，但是实时视图被证明是非常有用的。由于数据可能相当嘈杂，所以基本的平滑过滤器也有助于使内容更易于阅读。</p><p> KDE’s  LabPlot can consume CSV “streams” and has the right filters for this. Unfortunatelyits filters cannot be applied in realtime yet, so the LapPlot team pointed me to a much older KDE application that can do this: Kst. It’s filters are frequency-based, so we need a low-pass filter to smooth themeasurements. Not as nice as what LabPlot produces IMHO, but it gets the job done.</p><p>KDE的LabPlot可以使用CSV“流”，并为此提供了正确的过滤器。不幸的是，它的过滤器还不能实时应用，所以LapPlot团队向我推荐了一个可以做到这一点的更古老的KDE应用程序：KST。它的滤波器是基于频率的，所以我们需要一个低通滤波器来平滑测量。没有LabPlot生产的IMHO好，但是它可以完成工作。</p><p>  Good news first: This is sensitive enough to see the impact of simple user interactions, power saving options(ie. the Good/Bad toggles in  powertop), display brightness changes, etc.</p><p>首先是好消息：这是足够敏感的，可以看到简单的用户交互、省电选项(即，POWERTOP中的好/坏切换)、显示器亮度变化等。</p><p>  How good this is, ie. how close the reported values get to reality, and to what extend the noise is inherent to the sensorI have no idea though, lacking a calibrated reference to compare this to. Based on suggestions found online on how to reduce thenoise by hardware modifications I have to assume most of that is coming from the sensor.</p><p>这真是太好了，也就是。然而，报告的值与现实有多接近，以及噪声在多大程度上是感官固有的，也不知道，因为缺乏一个校准的参考来比较这一点。根据网上找到的关于如何通过修改硬件来降低噪音的建议，我不得不假设其中大部分来自传感器。</p><p>  There’s plenty of things to further investigate here still, both regarding assessing and improving the quality and resolutionof the measurements (e.g. by looking into increasing the sampling frequency by modifying the Tasmota firmware, assuming that is evenuseful), and regarding establishing the power impact of software settings or options.</p><p>这里还有很多事情需要进一步研究，无论是关于评估和改进测量的质量和分辨率(例如，通过修改Tasmota固件来提高采样频率，假设这是非常有用的)，以及关于确定软件设置或选项的功率影响。</p><p> While not doing work that we don’t need to do is of course better either way, there are many less obvious questions to investigatewith this:</p><p>虽然不做我们不需要做的工作当然是更好的方法，但有许多不太明显的问题需要用这个来研究：</p><p> Can we enable more of the power management options exposed by  powertop by default? There’s probably good reasons why they are off,but maybe that selection can be done more targeted? Or if it’s about user-decided trade-offs, maybe that can be made easier accessiblefor more users?</p><p>默认情况下，我们是否可以启用Powertop提供的更多电源管理选项？他们被淘汰可能有很好的理由，但也许这种选择可以更有针对性地进行？或者，如果是关于用户决定的权衡，也许可以让更多的用户更容易访问？</p><p>  How do operations on the CPU and GPU compare, or different ways of accessing the GPU? Thinking about the various compositor settings here for example.</p><p>CPU和GPU上的操作如何比较，或者访问GPU的不同方式？例如，考虑一下这里的各种合成器设置。</p><p>  How do we best perform long-running background tasks? As fast as possible with all available resources, or stretched out over time?</p><p>我们如何最好地执行长期运行的后台任务？以最快的速度使用所有可用的资源，还是随着时间的推移而变得捉襟见肘？</p><p>  Can we somehow make automatic screen brightness control more clever, e.g. by improving idle or presence detection?</p><p>我们能不能以某种方式使自动屏幕亮度控制变得更智能，例如，通过改进空闲或存在检测？</p><p>  Can we save power by making a dark color scheme the default on OLED screens?</p><p>我们可以通过将深色方案设为OLED屏幕的默认配色方案来节省电能吗？</p><p>  As I didn’t break any of the Wifi power-plugs during these experiments, I still have two spares I can pass to anyone in the communityinterested in digging into this as well!</p><p>由于我在这些实验中没有弄坏任何Wifi电源插头，我还有两个备用电源插头可以传递给社区中任何有兴趣研究这一点的人！</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.volkerkrause.eu/2020/10/17/kde-cheap-power-measurement-tools.html">https://www.volkerkrause.eu/2020/10/17/kde-cheap-power-measurement-tools.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/wifi/">#wifi</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/电能/">#电能</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/power/">#power</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/测量/">#测量</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>