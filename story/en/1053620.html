<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Linus Torvalds  -  X86  - 为什么你可以片段时联合起来？ Linus Torvalds – x86 – why unite when you can fragment?</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Linus Torvalds – x86 – why unite when you can fragment?<br/>Linus Torvalds  -  X86  - 为什么你可以片段时联合起来？ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-20 22:16:22</div><div class="page_narrow text-break page_content"><p>Linus Torvalds (torvalds.delete@this.linux-foundation.org) on March 13, 2021 1:18 pm wrote:&gt; So honestly, it doesn&#39;t look too bad.&gt; &gt; The AMD version is essentially &#34;Fix known bugs in the exception handling definition&#34;.&gt; &gt; The Intel version is basically &#34;Yeah, the protected mode 80286 exception handling was bad, then 386 made &gt; it odder with the 32-bit extensions, and then syscall/sysenter made everything worse, and then the x86-64 &gt; extensions introduced even more problems. So let&#39;s add a mode bit where  all the crap goes away&#34;.&gt; &gt; In contrast, the AMD one is basically a minimal effort to fix actual fundamental problems with &gt; all that legacy-induced crap that are nasty to work around and that have caused issues.&gt; &gt; For a short list of &#34;IDT exception handling problems&#34;, I&#39;ll just enumerate some of them:&gt; &gt; (a) IDT itself is a horrible nasty format and you shouldn&#39;t have to parse memory in odd &gt; ways to handle exceptions. It was fundamentally bad from the 80286 beginnings, it got &gt; a tiny bit harder to parse for 32-bit, and it arguably got  much worse in x86-64.&gt; &gt; (b) %rsp not being restored properly by return-to-user mode.&gt; &gt; (c) delayed debug traps into supervisor mode&gt; &gt; (d) several bad exception nesting problems (NMI, machine checks and STI-shadow handling at the very least)&gt; &gt; (e) various atomicity problems with gsbase (swapgs) and stack pointer switching&gt; &gt; (f) several different exception stack layouts, and literally hundreds of different &gt; entrypoints for exceptions, interrupts and system calls (and that&#39;s not even &gt; counting the call gates that nobody should use in the first place).&gt; &gt; But I suspect I forgot some.&gt; &gt; AMD aims to fix the outright historical bugs (b)-(e), but keeps things otherwise &gt; the same (ie it adds a bit more code to the microcode that basically replaces some &gt; of the horrible hacks you currently have to do - badly - in system software).&gt; &gt; The Intel one is the recognition that there was more wrong than just the outright bugs that had to be worked around &gt; by system software, and introduces a &#34;fixed exceptions&#34; model, which basically fixes all of the above.&gt; &gt; Both are valid on their own, and they are actually fairly independent. Honestly, the &gt; AMD paper looks like a quick &#34;we haven&#39;t even finished thinking all the details through, &gt; but we know  these parts were broken, so we might as well release this&#34;.&gt; &gt; I don&#39;t know how long it has been brewing, but judging by the &#34;TBD&#34; &gt; things in that paper, I think it&#39;s a &#34;early rough draft&#34;.&gt; &gt; The Intel FRED stuff has several years of background, and honestly, I think is the right thing to do. It really &gt; relegates the whole IDT to a &#34;we don&#39;t even use this at all, unless you have legacy segment selectors&#34;. Good &gt; riddance to a truly horrid thing that goes back to a truly disgusting CPU architecture: the 80286.&gt; &gt; I hope both vendors end up doing  both of those things. The AMD version is better if you &gt; are an OS vendor that wants to change as little as humanly possible at the OS level, and &gt; get rid of known problems. Think &#34;legacy OS that we can&#39;t really make big changes to&#34;.&gt; &gt; But I think the Intel version is better if you think that x86-64 should actually survive longer-term, &gt; and you actually want to improve exception handling and speed things up (the &#34;F&#34; historically &gt; stood for &#34;Fast&#34;, I&#39;m not sure why they&#39;ve apparently renamed it &#34;Flexible&#34;).&gt; &gt; Honestly, I like the AMD model of &#34;release early for discussion&#34;. It&#39;s what they did with the original x86-64 &gt; (aka &#34;amd64&#34;) spec. I think their paper is very much in line with that original spec, both in that &#34;early &gt; release about a non-final this is what we want to do&#34; and a &#34;minimal changes to existing hardware&#34;.&gt; &gt; But I do think that the Intel approach is actually the better &gt; fix to some of the nastiest parts of the whole architecture.&gt; &gt; If you ever expect to eventually live in a world where the old 32-bit legacy isn&#39;t really &gt; relevant any more (we can already pretty much already discount the x86 16-bit modes), &gt; the Fred approach actually takes you a good step in that direction, I think.&gt; &gt; Anyway, I hope this won&#39;t be a fragmentation issue, but realistically, because of how little &gt; changes the AMD model does to the legacy mode, and how independent the whole Fred exception &gt; model is from the legacy mode, even if you don&#39;t end up in that &#34;everybody does both&#34;, &gt; I suspect it&#39;s not exceptionally (pun intended) hard to just support both.&gt; &gt; After all, Fred is very clearly defined to have an entirely new model, and any OS vendor that &gt; goes that way will still have to support the legacy exception model for older CPU&#39;s.&gt; &gt; The point being that the Fred exception handling is  much simpler, but it&#39;s &gt; entirely separate code and logic, explicitly bolted to the side in the hope &gt; that the original code and logic can be removed entirely some day.&gt; &gt; In contrast, the AMD model is meant to very explicitly interface with existing code, and just allow &gt; people to avoid the fragile (and sometimes expensive) hacks and workarounds they already have. &gt; &gt; So they actually have very little overlap - both conceptually &gt; and from a &#34;implementation and use&#34; standpoint. &gt; &gt; Linus</p><p>Warning: Can only detect less than 5000 characters</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.realworldtech.com/forum/?threadid=200812&curpostid=200822">https://www.realworldtech.com/forum/?threadid=200812&curpostid=200822</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/torvalds/">#torvalds</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/warning/">#warning</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>