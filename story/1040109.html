<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>为什么CockroachDB和PostgreSQL兼容 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">为什么CockroachDB和PostgreSQL兼容 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-17 01:05:46</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/12/d66d4285acf7abc5beef733a246902f1.jpg"><img src="http://img2.diglog.com/img/2020/12/d66d4285acf7abc5beef733a246902f1.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>CockroachDB构建为与PostgreSQL很大程度上兼容，这意味着为使用PostgreSQL编写的软件通常可以与CockroachDB一起使用而无需更改。</p><p>  可能令人惊讶的是，在撰写本文时（2018年5月上旬），该问题的答案尚未在CockroachDB网站，CockroachDB文档或第三方来源的CockroachDB相关文章中公开记录。</p><p> 我很幸运地坐在Cockroach Labs的首席架构师和联合创始人Ben Darnell旁边，当时现为CockroachCloud的总经理Lakshmi Kannan向我们提出了同样的问题：为什么CockroachDB设计成与PostgreSQL兼容？接下来是对结果讨论的扩展措词。</p><p> 免责声明：这是一个个人笔记，没有任何注释，并且已经过去了一周。在这里收集的任何想法，论点，时间表，陈述，事实或观点的不准确之处，完全是我的。</p><p>  CockroachDB完全可以使用其自己的SQL方言和/或网络协议来创建。这是RethinkDB做到的方式。尽管Google的Spanner的SQL方言受MySQL启发，但它也不完全兼容。与任何事物的兼容性都是一种选择，在构建SQL RDBMS时并不一定需要兼容。通过启用供应商锁定功能，避免兼容性甚至可以成为取得商业成功的一种方法。</p><p> 我们选择PostgreSQL兼容性的主要原因是确保我们的用户不必为了使用CockroachDB而学习太多的新知识。</p><p> 在设计自定义网络协议时，数据库提供程序还必须提供客户端驱动程序。考虑到当今使用的多种平台和编程语言，自定义协议产生了一个艰难的选择：要么专注于几种平台/语言组合，仅提供驱动程序，要么转移大量客户端驱动程序的工程资源。前一种选择产生的潜在用户群较小。后一种选择使资源无法用于实现更好的RDBMS。 </p><p>通过采用一种已建立的网络协议，尤其是在许多平台和许多编程语言中都存在驱动程序的网络协议，新的RDBMS使其可以立即用于现有客户端代码的较大生态系统。</p><p>  关于多层兼容性，还有另一件事要说。一会儿我会回到这个问题。</p><p>  那里有许多知名且使用广泛的RDBMS。在确定一个新项目应该与任何东西兼容之后，如何选择要与之兼容的东西？</p><p>  首先是CockroachDB从一开始就是开源的。因此，必须选择与具有开源驱动程序和应用程序的其他RDBMS兼容。更具体地说，在法律上有必要选择与其他RDBMS的兼容性，这些RDBMS在法律上允许其开源驱动程序连接到另一产品，而不是为其设计的产品。例如，用于MSSQL的开源驱动程序是不好的，因为MSSQL网络协议可能受专利保护并且与＆＃34; MSSQL不兼容＆＃34;。数据库的构建无需与Microsoft达成繁重的协议（如果有的话）。替代＆＃34; MSSQL＆＃34;与＆＃34; DB2＆＃34;或＆＃34; Oracle＆＃34;而且争论仍然存在。</p><p> 第二个约束是CockroachDB旨在吸引开源开发人员。开源开发人员喜欢什么？开源客户端驱动程序是一回事，但是围绕该技术的生态系统更为重要。必须存在欢迎社区，公共讨论论坛，第三方软件的自由市场，免费和开放的学习资源等。相比之下，许多专有RDBMS会将围绕其技术的讨论限制为半私有论坛。他们通常具有复杂的第三方发布限制。通常，学习和使用该技术的培训受到限制且费用昂贵。</p><p>   客户端生态系统已经成熟的长期项目，再次是为了减少花费在客户端代码上的工作量。</p><p>  开放源代码，以便可以自由检查其实现，以简化兼容性的实现。 </p><p>在寻找历史悠久且使用广泛的开源RDBMS（通常被称为分布式SQL（或NewSQL）数据库的兼容性锚点）时，搜索范围缩小到只有两个：MySQL和PostgreSQL。</p><p>   Google的Spanner，其开发思想与CockroachDB类似，并且具有相似的受众，其目标是实现一定程度的MySQL兼容性。其他最近的分布式SQL RDBMS（例如MemSQL）也选择了MySQL兼容性。像Cockroach Labs早期团队的其他成员一样，Ben Darnell在MySQL方面的个人经验甚至超过了PostgreSQL。</p><p>  最初，CockroachDB提出了与MySQL兼容的想法。 PostgreSQL取得平衡的原因是多种因素的组合。</p><p> 最初有一个明显的印象，那就是PostgreSQL的网络协议文档比MySQL的协议文档更清晰，更详细，并且总体上更支持第三方实现。</p><p> 同时，PostgreSQL许可证与CockroachDB自己的Apache许可证兼容，从而可以在CockroachDB中不变地重用PostgreSQL自己的（某些）源代码。相反，MySQL（及其后继MariaDB）是在GNU GPL下发布的，这阻止了在CockroachDB中直接重用MySQL代码。</p><p> 而且，很明显，随着时间的流逝，MySQL的有机增长方式与PostgreSQL相比没有那么原则性的增长。在整个文档和源代码中，MySQL似乎有更多例外和特殊情况需要关注。适当的SQL事务在MySQL中的出现要比在PostgreSQL中晚得多，并且MySQL文档和MySQL生态系统中仍然存在大量的问题，这是弱于事务隔离的结果。据我所知，CockroachDB团队不喜欢共享相同的文化和生态系统的观点，因为通常只将事务隔离视为复杂的，选择加入，“先进”。特征。</p><p> 仅这些因素导致CockroachDB缓慢但肯定地专注于PostgreSQL兼容性。但是随着时间的流逝，出现了其他一些方面，并确认这是一个不错的选择。在下面的更多内容。 </p><p>如今，CockroachDB支持PostgreSQL的网络协议，称为＆＃34;。 pgwire＆＃34;在CockroachDB源代码中，很好。由于能够按原样重用PostgreSQL语法解析器（带有扩展名），它还支持PostgreSQL的大多数SQL语法。但是，在方言语义层次上，兼容性的故事目前更加模糊，这仅仅是因为在该层次上要实现足够的兼容性还有很多工作要做。</p><p>  例如，在Internet上，IP层处于较低级别，TCP高于IP（IP可以独立于TCP起作用，并且TCP建立在其上），而HTTP高于TCP（TCP可以独立于HTTP起作用，并以HTTP为基础）。</p><p>  SQL网络协议的抽象级别与Internet上的TCP或HTTP类似。</p><p> SQL RDBMS通常不会在文档中像这样解释其通信协议，但应用程序开发人员在其代码中会清楚地看到此结构：当驱动程序可以成功连接到数据库（网络协议）时，仍有工作要做，因为他们可以如果应用发送无效的SQL标点符号（SQL语法），仍然会收到错误消息。即使标点符号正确，但当应用程序使用服务器上当前不支持的SQL函数（SQL语义）时，仍然可能会出现错误。在应用程序开发过程中的这些实际失误是分层通信协议的可见工件。</p><p>  最初（早在2015年和2016年），我们的想法是CockroachDB将与PostgreSQL的网络协议兼容，以便能够重新使用客户端驱动程序，但它会提供自己的，可能与PostgreSQL不兼容的SQL语法和/或方言语义。特别是，可以预见的是，CockroachDB将提供足够多的特定SQL扩展，以至于需要（或至少保证）自定义SQL方言。</p><p> 因此，CockroachDB的早期（未发布）版本具有混合的MySQL / Spanner / PostgreSQL方言，可通过PostgreSQL网络协议供客户端使用。</p><p> 该策略所基于的假设是，用户希望重用PostgreSQL驱动程序（使用网络协议），但愿意接受将CockroachDB特定的SQL查询与其驱动程序一起使用，以换取CockroachDB特定的好处。 </p><p>随着团队了解到CockroachDB 1.0升级的艰难方法，与10或20年前相比，CockroachDB想要进入的生态系统中的许多开发人员不再编写自己的SQL查询。</p><p> 到2016年初，很明显CockroachDB团队要做的不只是使客户端驱动程序兼容以刺激采用，还需要做更多的工作。它还必须使更高级别的框架兼容。反过来，这意味着将兼容性限制为网络协议的最初想法是不够的，因此PostgreSQL兼容性要求已扩展到整个CockroachDB的整个SQL层。那，或者投​​入工程工作来扩展现有的PostgreSQL框架，以使其与CockroachDB一起使用。</p><p>  现在的首要任务是提高与PostgreSQL语义的兼容性，例如，通过提供越来越多的PostgreSQL内置函数和运算符，以及通过information_schema和pg_catalog自省表。这项工作正在进行中，CockroachDB的未来版本旨在通过这种方式变得越来越兼容。</p><p> 同时，由于数据库体系结构的根本差异，CockroachDB存在一些功能可能永远无法与PostgreSQL完全兼容。例如，PostgreSQL的FOR Locking子句根本无法在CockroachDB中有效地实现，因为CockroachDB中的并发控制原语是如此不同。当现有的PostgreSQL客户端框架需要此类功能时，Cockroach Labs将投资于提供内部特定的CockroachDB特定版本的框架，方法是内部构建它们或支持第三方来进行工作。随着CockroachDB变得越来越流行，框架的开发人员甚至可能选择自己实现CockroachDB特定的替代方案。</p><p> 有关CockroachDB与PostgreSQL兼容性的最新信息，请转到此文档页面。</p><p>  事实证明，使CockroachDB与PostgreSQL兼容实际上是很多工作。如果CockroachDB选择了另一条路线，会有什么不同吗？</p><p> 第一种选择是提供自定义网络协议和SQL方言，从而迫使从头开始创建新的应用程序生态系统不是正确的选择。 CockroachDB旨在创建一个庞大的用户社区。如果不与已建立的软件生态系统兼容，则存在一个巨大的自举问题，该团队没有解决经验。 </p><p>此外，采用兼容性在开发过程中具有巨大优势：它消除了设计讨论中的开放性问题。联网软件的客户端/服务器界面中存在的开放性问题是一个巨大的时间消耗，通常会成为子团队之间代价高昂的分歧或冗长的设计迭代的根源。通过采用与任何事物的兼容性，CockroachDB团队能够将确定的答案源用于大量设计决策。通过将精力集中在更重要的事情上，例如弹性和操作简便性，这加速了发展。</p><p> 另一种替代方法是优先考虑与MySQL的早期兼容性。尽管如上所述，MySQL协议和方言的文献资料较少，原则性较差，但可以说实现起来更简单-特别是对于网络协议以外的语义方面。 MySQL具有更少的SQL数据类型，更少的内置函数，更少的自省功能，更少的配置选项。所有这些本可以减少CockroachDB的工作量。</p><p> 目前，CockroachDB团队对于优先考虑PostgreSQL兼容性的选择仍然很满意。上面讨论的论点仍然成立，尤其是代码许可证和程序员文化。此外，随着时间的流逝，支持PostgreSQL的其他几个方面也变得清晰起来。</p><p> 首先，Sun Microsystems（现为Oracle）在2008年收购了MySQL背后的公司MySQL AB，这使MySQL生态系统变得支离破碎。 MariaDB最初完全兼容，但现在提供了自己的功能集。 MySQL的未来没有任何统一的指导治理机构。在这方面，可以认为PostgreSQL更适合未来。而且，甲骨文现在拥有MySQL的大部分知识产权，并且一家公司开发的产品与MySQL紧密相关，并且吸引类似的企业受众，这可能会有点接近甲骨文的反竞争雷达为了舒适。</p><p> 但是，MySQL社区庞大，许多人对将应用程序移植到CockroachDB表现出兴趣。因此，CockroachDB团队正在积极开发MySQL迁移工具，这些工具在最新的alpha版本中可用。</p><p> 另外，PostgreSQL的参考文档比MySQL更干净，写得很好，呈现得很好并且对开发人员友好。它是对CockroachDB自己的文档的有效补充，并且用户报告说，他们很高兴将两者一起使用。</p><p> 最后，随着时间的流逝，特定的兼容性选择变得越来越重要。到一个项目变得众所周知并且有足够的用户在其技术堆栈中采用该项目时，（社交）网络效应和提供的支持资源的质量大大掩盖了（技术）网络或方言兼容性的最初提升收益。希望CockroachDB会尽快找到自己的位置。 </p><p>如果您对我们的PostgreSQL兼容性还有其他疑问，请加入CockroachDB Community Slack频道与CockroachDB用户和工程师聊天。  版权所有©2018 Raphael‘kena’Poss。 根据知识共享署名-相同方式共享4.0国际许可的条款，授予分发，重新使用和修改本文档的权限。  这项工作是Raphael'kena'Poss撰写的“为什么在CockroachDB中使用PostgreSQL”，是“在CockroachDB中使用PostgreSQL-为什么？”的衍生作品。 在CC BY SA下使用。 要查看此许可证的副本，请访问http://creativecommons.org/licenses/by-sa/4.0/。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.cockroachlabs.com/blog/why-postgres/">https://www.cockroachlabs.com/blog/why-postgres/</a></div><div class="story_tags page_narrow"></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>