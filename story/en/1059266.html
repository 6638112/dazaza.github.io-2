<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CHDIR到CWD：许可否认 Chdir to cwd: permission denied</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Chdir to cwd: permission denied<br/>CHDIR到CWD：许可否认 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-20 05:45:20</div><div class="page_narrow text-break page_content"><p>This post describes a  breakingchangein  runcv1.0.0-rc93,that has subsequently had a  workaroundimplemented that willpresumably be included in v1.0.0-rc94. Thanks to @haircommander for talking through theissue with me and implementing the subsequent workaround, and to @mattomata for his consultation on the  distroless/static:nonrootbehavior. If you are notinterested in the background of the issue, you can skip reading this post andtake a look at my detailed testing scenarios on the  Crossplanerepo, or my breakdown ofthe conflict with the  nonroot image on the  distrolessrepo.</p><p>这篇文章描述了一个BreakingChangein RunCV1.0.0-RC93，随后具有WorkAroundImplemented，该工作方法将是v1.0.0-rc94中的值得包含的。感谢@Haircommander通过与我的恐惧谈话并实施随后的解决方法，并在@Mattomata上咨询分发/静态：NOROOTBEAMAVIOR。如果您在问题的后台进行了无谓者，您可以跳过阅读这篇文章并查看我的Crosslanerepo上的详细测试场景，或者我与DistrolessRepo上的Nonroot Image冲突的细目。</p><p> Recently, a  Crossplane user reported that they hadupgraded to the latest version of  Openshift andtheir  Pods started immediately  going into CrashLoopBackoff.They went back and verified that the same version of Crossplane was runningsuccessfully on the older Openshift version, but now the containers were exitingwith:</p><p> 最近，交叉平面用户报告说，他们将其寄出到最新版本的OpenShift和Their Pods开始立即进入CrashloopBackoff.they返回并验证了相同版本的Cradlepane在旧的OpenShift版本上运行，但现在容器是出现的：</p><p> level=error msg=&#34;container_linux.go:366: starting container process caused: chdir to cwd (\&#34;/home/nonroot\&#34;) set in config.json failed: permission denied&#34;</p><p> level =错误msg =＆＃34; container_linux.go：366：启动容器过程导致：Chdir到CWD（\＆＃34; / home / nonroot \＆＃34;）在config.json中设置了：权限被拒绝＆＃34 ;</p><p> Fortunately, though this error is quite verbose for someone who is not familiarwith container runtime internals, it is extremely helpful for a developer as itprovides the file name, line number, and explicit expression of the action thatcaused the error. Most  Kubernetes platforms these daysuse   containerd as their “high-level” containerruntime, and   runc as their“low-level” container runtime. I won’t go into too much detail on theresponsibilities of each (I recommend you check out this  blogseriesby  Ian Lewis), but an extremely simple explanationis that  containerd orchestrates containers whose lifecycle is managed by runc. This error has to do with actually starting the container, which is adead giveaway that we are dealing with  runc, but if you weren’t sure it couldbe confirmed by looking at the source of container_linux.go.</p><p> 幸运的是，虽然这个错误对于那些不是容器运行时内部的人来说是非常详细的，但是对于ITPROVIDE文件名，行号和显式表达式的ActionStapsaused aftably，它非常有用。大多数kubernetes平台这些天气使用container作为他们的“高级”containerRuntime，并runc作为他们的“低级”容器运行时。我不会对每个人的文字进行太多细节（我建议您查看此博客IAN LEWIS），而是一个极其简单的解释，ContaintROD通过RUNC管理的生命周期管理的容器。此错误与实际上启动容器有关，这是我们正在处理Runc的Adead赠品，但如果您不确定它可以通过查看Container_Linux.Go来源来确认。</p><p> A container is essentially just a  Linuxprocess that is sandboxed using namespaces and cgroups. This means thatthey have the same properties that any other process has, including state,various identifiers, scheduling criteria, and more (if you want to learn moreabout all of the attributes of a process, taking a look at the task_structin the Linux Kernel source is a great adventure). The  OCI ImageSpecification allows you todefine some of these properties, which are then enforced by the containerruntime, in this case  runc.</p><p> 一个容器基本上只是一个Linuxpect使用命名空间和cgroups的沙盒。这意味着它们具有与任何其他进程具有相同的属性，包括状态，各种标识符，调度条件和更多（如果要了解一个进程的所有属性，请查看Task_Structin Linux内核源是一个伟大的冒险）。 OCI映像允许您批准其中一些属性，然后通过ContainErruntime强制强制执行这些属性，在这种情况下是Runc。</p><p> Unfortunately (or fortunately, depending on how you look at it), theseattributes can be defined at various levels of the container orchestrationstack, notably build time and run time. For example, in a Dockerfile you can define a  USER,  WORKDIR, and  ENTRYPOINT,but you can also  overridethemwhen running a container using the image you built. Similarly, Kubernetesexposes some of these attributes in the  Pod specification through  fields suchas runAsUser,  runAsGroup, and  workingDir. This allows for maximumflexibility, but also can lead to a rocky user experience when building widelydistributed images or running 3rd party images in your cluster.</p><p> 不幸的是（或幸运的是，根据您的观察方式），可以在容器编排器的各个级别中定义TheStributes，特别是建立时间和运行时间。例如，在Dockerfile中，您可以定义用户，WorkDir和Restspoint，但您也可以使用所构建的图像运行容器时覆盖。同样，KubernetEsexpose通过Fields Mutims RunasUser，RunasGroup和WorkingDir中的POD规范中的一些这些属性。这允许最高次数，但也可以导致在构建广播的图像或在群集中运行第三方图像时的岩石用户体验。</p><p> So back to the original issue: the parameters used to run the Crossplanecontainerized processes had not been changed, but  runc was now failing tostart them. Once again looking at the error message, we can see that  runc isunable to  chdir to the  cwd (or  WORKDIR in  Dockerfile parlance). When acontainer is started,  runc must identify the  cwd that is specified in theimage manifest, or overridden by the container orchestrator, and switch to thatdirectory before actually starting the process. Since this step was now failing,there must have been a change in how  runc executes it.</p><p> 所以回到原始问题：用于运行交叉平面内化进程的参数尚未更改，但运行频率已失败它们。再次查看错误消息，我们可以将RUNC ISSUSINABLE到CHDIR到CHDIR（或Dockerfile Parlance中的Workdir）。当Acontainer启动时，Runc必须标识以图形方式指定的CWD，或者在容器Orchestrator中覆盖，然后在实际启动过程之前切换到该目。由于此步骤目前失败，因此runc如何执行它。 </p><p> Taking a look at  this issue in the Red Hat bugtracker, we can see that a recentchangein  runc switched from executing the  chdir step with the  UID of  runc tothe  UID specified by the container image (or overridden by the containerorchestrator). But why was this change primarily causing problems for imagesbuilt on the  distroless/static:nonroot  baseimage? To understand, wemust first take a look at how the base image is built.</p><p>在Red Hat BugTracker中查看此问题，我们可以看到近来的incangein runc切换了与容器图像指定的runc toute UID的UID执行CHDIR步骤（或者被ContainerOrchestrator覆盖）。但是，为什么这一变化主要导致在分布/静态上的图像的问题：nonroot basimimage？要了解，Wemust首先要查看基础图像的构建方式。</p><p> The purpose of the distroless project is to provide base images that have theminimum components required for an application to run. Many common base images,such as  alpine, are stripped of much of thecruft of a full Linux distribution, but there are still many tools and utilitiesthat are unneeded and expose unnecessary attack vectors if a container wascompromised. So distroless just packages the  bareessentials,which for a Go application are packages such as  ca-certificates and  tzdata.The distroless project also offers a  nonroot variant of this bare bones image,which is essentially the same as  static, but  sets theuserto  nonroot (UID =  65532), and the working directory to  /home/nonroot.</p><p> Distroless项目的目的是提供具有应用程序运行所需的最终组件的基础图像。许多常见的基本图像（例如Alpine）被剥离了大部分的全部Linux分布，但仍有许多工具和Unifitiesthat不需要，如果容器仍然存在，则不必要的攻击向量。因此，不再包装了一个关于去应用程序的安全性，是CA-Certificates和Tzdata等包装。Distroless项目还提供了这种裸骨图像的非热变量，这与静态相同，但设置了SUTOSORO NOROOT（UID） = 65532），以及与/ home / nonroot的工作目录。</p><p> Note: these images are built with  Bazel, but you canget a good idea of how the  .bzl files map to a  Dockerfile withoutrequiring a deep understanding of the build system just by looking at the docker rules.</p><p> 注意：这些图像使用Bazel构建，但是您可以了解.bzl文件如何通过查看Docker规则来映射到DockerFile的DockerFile如何映射到DockerFile。</p><p> The  /home/nonroot directory gets created with  0700 permissions, which means that the owninguser ( nonroot) has  Read,  Write, and  Execute permissions on thedirectory, but other users, even those in the same group, have  no permissions.In order to  chdir, the calling process must have  Execute permissions on thetarget directory. In this case only UID  65532 has those permissions, but the nonroot image sets the user for us so that shouldn’t be an issue right?</p><p> 使用0700权限创建/ home / nonroot目录，这意味着权限（nonroot）已读取，写入和执行对图中的权限，但其他用户甚至是同一组中的用户，也没有权限。订单到CHDIR ，调用进程必须在Thetarget目录上执行权限。在这种情况下，只有UID 65532具有那些权限，但是NOROOT图像为我们设置用户，以便不应该是一个问题？</p><p> As mentioned before, the build time properties are sometimes overridden at runtime, and on Openshift, this   alwayshappens unlessexplicitly overridden. When a  Namespace is created on an Openshift cluster, itis given a range of UIDs and GIDs, and each  Pod that gets deployed in the Namespace is assigned the first UID and GID in the range. However, this is notnew functionality in Openshift, so if the  65532 UID was already beingoverridden in older versions, why were the containers able to be startedsuccessfully?</p><p> 如前所述，有时在运行时覆盖构建时属性，并且在OpenShift上覆盖，此类总是覆盖的。当在OpenShift群集中创建命名空间时，ITIS给定一系列UID和GID，以及在命名空间中部署的每个POD都被分配了该范围内的第一个UID和GID。但是，这是OpenShift中的效果，因此如果65532 UID在旧版本中已经WisoverRiddensid，为什么能够开始才能才能才能才能才能</p><p> The reason lies in the fact that the newer version of Openshift had upgraded to runc  v1.0.0-rc93 which included the aforementioned change to  chdir withthe container user rather than the user for the  runc process itself. Unlessrunning in  rootlessmode,  runc runsas the  root user, which typically has special privileged capabilities, suchas  CAP_FOWNER, which allow it bypass permissions. So though the olderOpenshift version was still using a “random” UID, since the underlying  runcversion was executing  chdir as root, it was not resulting in a permissiondenied error.</p><p> 原因在于，较新版本的OpenShift升级到Runc V1.0.0-RC93，其中包含与容器用户的上述更改为CHDIR，而不是用于RUNC进程本身的用户。除非RooLseMedMode，Runc运行root用户，它通常具有特殊的特权功能，如允许它绕过权限。因此，虽然旧oppenshift版本仍然使用“随机”uid，但是由于底层的raccersion正在作为root执行的chdir，因此它不会导致许可证的错误。</p><p> Whether this change is a feature or a bug is mostly a matter of how oneinterprets the responsibilities of a container runtime. However, regardless ofit being “correct” or not, it was a breaking change to a rather importantcomponent of the container ecosystem, which has led to a  subsequentworkaround being introducedthat will presumably be included in v1.0.0-rc94. As forcurrent users of the  nonroot base image, though I have detailed the situationin an  issue on the distrolessrepo, I wouldnot expect (nor recommend) that a change be made to the image configuration. Thepurpose of the image is to enforce the use of the single  nonroot user, somaking it possible not to breaks the original intention. Instead, if you agreewith Red Hat’s assertion (seethe “Traditional Applications and UIDs” section) that an application should not“expect a specific UID under which they will be running”, a viable alternativeis to use the plain  distroless/static image and manually set UID =  65532 inyour image build, effectively saying that “you will run as  nonroot by default,but you are free to override if you know what you’re doing”. This is the direction we have gone inthe  most recent Crossplanerelease.</p><p> 此更改是否是一个功能，或者错误主要是如何interintprets集装箱运行时的职责。但是，无论是“正确”，它是一个突破变化，对集装箱生态系统的相当重要的信息，这导致了随后推出的，推出将被推出在V1.0.0-RC94中。作为非目的基础图像的福电流用户，尽管我在DistrolessRepo上有一个问题，但我不期望（也不推荐）对图像配置进行的更改。图像的特点是强制使用单个非透明用户的使用，索明可以不打破原始意图。相反，如果您同意Red Hat的断言（Seethe“传统应用程序和UID），则应用程序不应该”期待他们将运行的特定UID“，是使用普通打败/静态图像和手动设置的可行替代品UID = 65532 inyour的图像构建，有效地说“默认情况下，您将作为NONROOT运行，但如果您知道您正在做什么，您可以自由地覆盖”。这是我们最近的交叉平面释放的方向。 </p><p>  Hopefully this post serves as a helpful guide for other folks that encounterthis issue. I want to give a huge shout out to all the folks who work onprojects like  runc and  containerd, which are the foundation for much of theinfrastructure of the cloud native landscape. When there are changes that breakexisting behavior I encourage folks to respond with grace and constructivefeedback. Often times, as is true with this change, the new behavior is in theinterest of protecting users, even if it can cause short term headaches.</p><p>希望这篇文章成为遇到问题的其他人的有用指南。 我想向所有工作的人喊出巨大的喊叫，这些人像符合runc和containerd那样，这是云本机景观的大部分地区的基础。 当吹气性行为发生变化时，我鼓励人们用恩典和构造反应回应。 通常，根据这种变化，如符合这一变化，即使它可能导致短期术语，新行为也在保护用户的兴趣中。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://danielmangum.com/posts/runc-chdir-to-cwd/">https://danielmangum.com/posts/runc-chdir-to-cwd/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/cwd/">#cwd</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/runc/">#runc</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>