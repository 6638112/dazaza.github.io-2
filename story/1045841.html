<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>剖析Apple M1 GPU，第二部分 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">剖析Apple M1 GPU，第二部分 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-23 02:15:32</div><div class="page_narrow text-break page_content"><p>不到一个月前，我开始研究Apple M1 GPU，希望开发出免费的开源驱动程序。本周，我达到了第二个里程碑：用我自己的开源代码绘制一个三角形。顶点着色器和片段着色器是用机器代码手写的，我通过IOKit内核驱动程序以与系统的Metal用户空间驱动程序相同的方式与硬件连接。</p><p>  新代码的大部分负责构建共享内存中的各种命令缓冲区和描述符，这些命令缓冲区和描述符用于控制GPU的行为。 Metal可以访问的任何状态都对应于这些缓冲区中的位，因此理解它们将是下一个主要任务。到目前为止，我较少关注内容，而是更关注它们之间的联系。特别是，这些结构包含指向彼此的指针，有时相互嵌套多层。该项目三角形的启动过程可以让您鸟瞰存储器中所有这些不同的部分如何组合在一起。</p><p> 例如，应用程序提供的顶点数据位于它们自己的缓冲区中。另一个缓冲区中的内部表指向这些顶点缓冲区中的每一个。该内部表将作为输入直接传递给在另一个缓冲区中指定的顶点着色器。顶点着色器的描述（包括可执行内存中代码的地址）由另一个缓冲区指向，该缓冲区本身是从主命令缓冲区引用的，而该缓冲区由IOKit调用中的句柄引用以提交命令缓冲区。 ew！</p><p> 换句话说，该演示代码并非旨在演示对命令缓冲区细粒度细节的理解，而是演示“不存在任何遗漏”。由于GPU的虚拟地址在运行之间会发生变化，因此该演示验证了所需的所有指针是否均已识别，并可以使用我们自己的（简单的）分配器在内存中自由地重新分配。由于在macOS上的内存和命令缓冲区分配方面存在一些“魔术”，因此使此代码在早期阶段工作可让您放心。</p><p> 我采用了零星的抚养程序。由于我的IOKit包装器与Metal应用程序存在于相同的地址空间中，因此包装器可能会在提交给GPU之前修改命令缓冲区。作为早期的“ hello world”，我确定了内存中渲染目标的透明颜色的编码，并演示了可以根据需要修改颜色。同样，在学习了用于启动反汇编程序的指令集时，我用手写的等效项替换了着色器，并确认只要可以写出机器代码，就可以在GPU上执行代码。但是不必在系统的这些“叶子节点”处停止；修改着色器代码后，我尝试将着色器代码上传到可执行缓冲区的其他部分，同时修改命令缓冲区的代码指针以进行补偿。之后，我可以尝试自己上传着色器的命令。以这种方式进行迭代，我可以构建所需的每个结构，同时分别测试每个结构。</p><p> 尽管有曲线球，但此过程比直接跳到构造缓冲区（可能通过“重播”）的替代方案要好得多。几年前，我曾使用过这种替代技术来启动Mali，但是它带来了非常困难的调试工作的实质性缺点。如果五百行幻数中有一个错字，除了GPU的错误之外，将没有反馈。但是，一次只工作一点，就可以立即查明并修复错误，从而提供更快的周转时间和更愉快的提拔体验。</p><p> 但是那里有弯球！当我尝试为颜色分配缓冲区时，我在修改透明颜色上的一时兴高采烈消失了。尽管编码与以前相同，但GPU仍无法正确清除。我想知道修改指针的方式是否有问题，我尝试将颜色放置在Metal驱动程序已经创建的未使用的内存部分中，并且有效。内容是一样的，我修改指针的方式是一样的，但是GPU不喜欢我的内存分配。我想知道我分配内存的方式是否有问题，但是包装所证实的，我用来调用内存分配IOKit调用的参数与Metal使用的参数位相同。我最后的努力是检查是否必须通过某些辅助通道（例如mmap系统调用）显式映射GPU内存。 IOKit确实具有与设备无关的内存映射调用，但是没有发现任何增强的跟踪来发现任何旁通道系统调用映射的迹象。 </p><p>麻烦正在酝酿中。在花费大量时间追寻“不可能的”错误之后，我感到很疯狂，我想知道系统调用中是否没有某些“魔术”……而是GPU内存本身。这是一个愚蠢的理论，因为如果成立，它将产生严重的“鸡与蛋”问题：如果必须由另一个GPU分配来祝福一个GPU分配，谁来祝福第一个分配？</p><p> 但是我感到很愚蠢，甚至感到绝望，因此我继续尝试通过在应用程序流的中间插入一个内存分配调用来测试该理论，以便每个后续分配都将位于不同的地址。在此更改之前和之后倾销GPU内存并检查差异，这揭示了我的第一个恐怖：GPU内存中的辅助缓冲区跟踪了所有必需的分配。特别是，我注意到此缓冲区中的值以可预测的偏移量（每个0x40字节）增加了1，这表明该缓冲区包含一个分配句柄的数组。实际上，这些值恰好对应于GPU内存分配调用中从内核返回的句柄。</p><p> 撇开该理论的明显问题，我还是进行了测试，修改了此表以在新分配的句柄末尾包含一个额外的条目，并修改了标题数据结构以使条目数增加一个。仍然没有骰子。尽管令人沮丧，但这并没有完全淹没该理论。实际上，我注意到了条目的一些特殊之处：与我的想法相反，并非所有条目都对应有效的句柄。不，除最后一个条目外，所有其他条目均有效。内核的句柄是1索引的，但是在每个内存转储中，最终句柄始终为0，不存在。也许这就像一个哨兵值，类似于C中以NULL终止的字符串。这种解释引出了为什么的问题？如果标题已经包含条目数，则标记值是多余的。</p><p> 我按了。我没有在句柄上添加额外的条目，而是将最后一个条目n复制到了额外的条目n + 1，然后用新的句柄覆盖了（现在倒数第二个）条目n。</p><p>  谜团解决了吗？我使代码正常工作，因此在某种意义上，答案一定是肯定的。但这很难令人满意。在每一步，不太可能的解决方案只会引发更多问题。鸡和蛋的问题最容易解决：此映射表与根命令缓冲区一起通过特殊的IOKit选择器进行分配，该选择器独立于常规缓冲区分配，并且映射表的句柄与提交命令缓冲区选择器。此外，通过命令缓冲区提交传递必需的句柄的想法并非闻所未闻。在主线Linux驱动程序上使用了类似的机制。但是，与简单的CPU端数组相比，在共享内存中使用64字节表条目的基本原理仍然难以捉摸。</p><p> 让内存分配陷入困境，前进的道路并非没有颠簸（和坑坑洼洼），而是耐心地进行了迭代，直到我自己与Metal并行构造了整个GPU内存，仅依靠专有用户空间来初始化设备。最后，剩下的就是我自己开始IOKit握手的信念飞跃，而我有了我的第一个三角形。</p><p> 自从上一篇博客文章（可在GitHub上获得）以来，这些更改总计约1700行代码。我整理了一个简单的演示，在屏幕上显示了GPU，为一个三角形制作了动画。此时的窗口系统集成实际上是不存在的：需要XQuartz，并且在具有纯净标量代码的软件中会发生（64x64 Morton级交错）帧缓冲区的虚化。不过，M1的CPU足够快以应付。 </p><p>现在，用户空间驱动程序的每个部分都已引导，接下来，我们可以独立地遍历指令集和命令缓冲区。 我们可以逗弄一些小细节，然后将代码从数百个莫名其妙的魔术常数逐位转换为真正的驱动程序。 向前！ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://rosenzweig.io/blog/asahi-gpu-part-2.html">https://rosenzweig.io/blog/asahi-gpu-part-2.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/缓冲区/">#缓冲区</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1045839.html"><img src="http://img2.diglog.com/img/2021/1/thumb_8f4724308dfffc86f06103a8e1df2a3d.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1045839.html">今日最佳科技交易：Apple Magic Keyboard，刺客信条Valhalla等 </a></div><span class="my_story_list_date">2021-1-23 1:18</span></div><div class="col-sm"><div><a target="_blank" href="/story/1045781.html"><img src="http://img2.diglog.com/img/2021/1/thumb_d637874cdc1f22aba07a9a5d0c3b0180.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1045781.html">传苹果计划通过MagSafe充电设计更轻薄的MacBook Air </a></div><span class="my_story_list_date">2021-1-22 20:38</span></div><div class="col-sm"><div><a target="_blank" href="/story/1045691.html"><img src="http://img2.diglog.com/img/2021/1/thumb_94c6fef7330750055515144af4e53a28.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1045691.html">每日紧缩：苹果可能正在开发虚拟现实耳机 </a></div><span class="my_story_list_date">2021-1-22 7:17</span></div><div class="col-sm"><div><a target="_blank" href="/story/1045588.html"><img src="http://img2.diglog.com/img/2021/1/thumb_c062528a1d9234c87e6b9b6fce4c3cd2.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1045588.html">开发人员说Ubuntu现在可以在Apple Silicon上运行，它“完全可用” </a></div><span class="my_story_list_date">2021-1-22 0:20</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>