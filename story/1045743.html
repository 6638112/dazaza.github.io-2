<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>螺纹输入冒险 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">螺纹输入冒险 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-22 14:25:01</div><div class="page_narrow text-break page_content"><p>过来吧，在本文中，我们将讨论Mutter如何在本机后端中获得输入线程。</p><p>   Mutter并非总是一个独立的合成器工具包，过去它曾经依赖于Clutter和Cogl库来获得工具包通常带来的所有好处：能够在屏幕上画图并能够接收输入。</p><p> 在Wayland的崛起中，对外部工具箱的依赖促使许多设计决策围绕输入管理进行，通常涉及在工具箱中添加支持以及必要的挂钩，以便Mutter可以使用或修改行为。双方不可避免地参与其中。</p><p> 后来，Mutter合并了自己的Clutter和Cogl副本，但最初的API障碍基本上保持不变。随着时间的流逝，并且仍在持续进行中，我们一直在对Mutter进行重构，以便所有与您操作系统的底层对话的代码都一起存储在src /后端中，从而使这些代码脱离了Clutter和Cogl。</p><p>  但是，就输入而言，Clutter API障碍在大多数情况下仍然存在，它仍然受到X11设计的严重影响，并且在最初设计时就被大量使用。一些例子，没有特殊的恶名或秩序：</p><p> 我们仍然以紧凑的方式转发输入轴，这要求查询输入设备以将event-> motion.axes [3]位置解码为CLUTTER_INPUT_AXIS_PRESSURE。节省空间的特性直接来自XIEvent和XIQueryDevice。</p><p> 指针约束是通过挂钩可以施加最终指针位置的函数来完成的。 </p><p>由于CLUTTER_TOUCH_CANCEL的语义略有不同，因此wl_touch.cancel的发出对libinput事件处理产生了奇怪的影响。</p><p> 完善这些交互，使后端代码保持更独立，这是所涉及工作的重要组成部分。</p><p>  主线程上下文已经是一个繁忙的地方，在最坏的情况下（并且已大大简化），我们：</p><p>  全部在一帧的过程中。输入线程将退出该过程的第一步。为了使它无缝运行，线程需要一定程度的独立性，它需要产生ClutterEvents并知道在没有任何外部代理的情况下指针将最终到达何处。例如：</p><p>  输入线程接管所有这些。主线程当然会有一些参与（例如指定有效的障碍或约束或虚拟输入），但是这些同步点要么稀缺，要么已经隐式异步。</p><p> 输入线程的主要目标是为主线程提供ClutterEvent，而实际上它们是在无关的线程中产生的。为此，从它们派生的所有信息必须独立于输入线程状态。因此，将ClutterInputDevice和ClutterInputDeviceTool（代表输入设备和绘图板工具）变形为不可变的对象，其下的所有更改（例如，配置）都在输入线程内部进行处理，并在发出的事件中抽象化。</p><p>   使线程始终准备好分派libinput听起来可能只是为您提供新框架所涉及的复杂性的一小部分，但这确实带来了一些好处： </p><p>Libinput事件始终总是尽快分派，因此这将减少日志中的“客户端错误：事件处理滞后XXms”消息。</p><p> 输入处理不会因主线程中的其他操作而停顿，这意味着更少的尴尬情况使我们无法及时处理事件（例如，至少在合成器端重复执行了一个键释放停止键）。</p><p> 使用输入线程单独绘制光标逻辑位置，更新光标平面位置以反映下一帧的最新位置，只需要向输入线程询问即可。</p><p> 通常，输入代码的组织比较整齐，其中较少的细节泄漏到后端域之外。</p><p>  代码总是走到更好的地方，合并的工作并没有实现所有可能实现的目标。以下是您不希望看到的固定问题：</p><p> 主线程仍然负责KMS，并更新光标平面缓冲区和位置。这意味着即使主线程停止运行，指针光标仍将冻结，尽管下面有输入线程处理事件。将来，还会有另一个单独的线程来处理原子KMS操作，因此输入和KMS线程可以在它们之间进行交谈并绕过任何主线程停顿。</p><p> 如果您需要在硬锁定时切换到另一个TTY，则主线程仍会涉及Ctrl + Alt + Fn的处理。对于开发人员来说，使其完全在输入线程中进行处理将是一件小事，也许是将来的工作。 </p><p>拥有几乎不受任何其他事物阻碍的输入处理能力是处理1000Hz鼠标和其他高频输入设备的先决条件。 但是，针对这些行为的节流行为没有改变，短期内应该会有更好的行为。  到目前为止，我们一直在努力使Mutter尽快运行并尽可能地解除锁定。 这是迈向更高级别设计的第一步，该设计在内部可以防止失速情况。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blogs.gnome.org/shell-dev/2021/01/21/threaded-input-adventures/">https://blogs.gnome.org/shell-dev/2021/01/21/threaded-input-adventures/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/输入/">#输入</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/input/">#input</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1044841.html"><img src="http://img2.diglog.com/img/2021/1/thumb_c75ef9d9cc163902e555326103eb4424.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1044841.html">为单行地址输入禁用Safari自动填充（2019） </a></div><span class="my_story_list_date">2021-1-18 13:11</span></div><div class="col-sm"><div><a target="_blank" href="/story/1039308.html"><img src="http://img2.diglog.com/img/2020/12/thumb_791452ca31139d0845c5b11ef9b3b46a.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1039308.html">Reddit用户通过反编译修复了Cyberpunk 2077 Steam控制器输入错误 </a></div><span class="my_story_list_date">2020-12-13 3:11</span></div><div class="col-sm"><div><a target="_blank" href="/story/1033363.html"><img src="http://img2.diglog.com/img/2020/11/thumb_00d3291eebdcee1117833f94f5e8bf1f.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033363.html">寻找哲学家的键盘</a></div><span class="my_story_list_date">2020-11-6 4:23</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032965.html"><img src="http://img2.diglog.com/img/2020/11/thumb_dab4eda0c0593d71ee40d9f2ba0248d3.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032965.html">反应基础：我学到了什么</a></div><span class="my_story_list_date">2020-11-3 22:15</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>