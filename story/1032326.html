<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>正在恢复丢失的漫游笔记</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">正在恢复丢失的漫游笔记</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-31 02:02:09</div><div class="page_narrow text-break page_content"><p>这篇文章深入探讨了一个可怕的数据丢失场景--我们将涵盖识别数据丢失、调查根本原因以及最终恢复数据的内容。</p><p>此错误影响ReadWise用户，他们在10/27导出其亮点(手动和自动)以漫游。如果您是这些用户中的一员，您应该尽快联系漫游支持&amp；Use My Recovery Code！</p><p>漫游是网络思维的笔记工具。它支持各种很酷的东西--这里与之相关的是，它每天都会自动创建一个新页面，那就是你的“每日笔记”(Daily Notes)。最近，我开始使用ReadWise，它吸收Kindle的亮点，并使用间隔重复来帮助你记住所读的内容。ReadWise具有漫游集成功能，可以自动将Kindle亮点添加到漫游中。不幸的是，由于Roam还没有一个公共API，Readwise的集成似乎有效地使用了Selenium-点击元素和粘贴亮点，这在本质上是不可靠的。</p><p>昨天，我醒来时没有带前一天的日记。灾难！幸运的是，在漫游松弛小组和来自Readwise的特里斯坦的帮助下，我能够隔离笔记删除的原因，甚至可以恢复我丢失的数据。事情是这样发生的：</p><p>Roam将Datascript用于其客户端数据库。与DATOMIC类似，Datascript将数据存储为定义为[e a v tx]的DATOM，或实体、属性、值和事务ID(递增整数)。如果您有兴趣了解更多，Datascript的作者有一个很好的概述。</p><p>对我们来说重要的是，Roam与其他web应用的不同之处在于它不会在后端存储所有的状态和历史。取而代之的是，roam的后端只存储一个快照的Datascript数据库(据我所知每天更新)和自上次快照以来的事务列表。如果我们可以在漫游下一个快照之前下载这两项内容，我们就有两个恢复的面包屑了：1.我们可以找到删除“我的每日笔记”页的事务2.我们还可以重建我们的Datascript数据库，在删除之前重新播放事务，并从中恢复我们的“每日笔记”！</p><p>我们的第一步是存储漫游的数据库快照和事务列表。Roam使用WebSocket连接将这些调用发送到其Web客户端，而不是REST API调用。这让我们的事情变得复杂起来：我们需要下载一个HAR文件，而不是仅仅用cURL保存API响应，幸运的是，它包含了更新的Chrome版本的WebSocket流量。HAR文件只是按时间顺序存储的JSON档案-只选择WebSocket流量很容易：</p><p>(parse-har[harfile]([json((Harfile)true)ws-message(json：log：entry(#((：_webSocketMessages%)Second：_webSocketMessages)ws-data(：data ws-message)]ws-data)</p><p>仔细检查这些数据，似乎漫游的WebSocket消息通常是JSON字符串(偶尔也是数字)。当一封邮件超过16KB时，它会拆分成多封邮件而不进行包装-因此我们需要将这些较大的邮件缝合在一起。检测非拆分消息的一种方法是尝试将其解析为JSON-如果它是有效的，我们可以说它是非拆分的。(这里有一个我们不太可能遇到的边缘情况：如果16KB的数据块碰巧也是有效的JSON，我们就不走运了。)。我们很幸运，我没有碰到这个！)。现在，我们可以按如下方式扩展parse-har：</p><p>(parse-har[harfile]([json((Harfile)true)ws-message(json：log：entry(#((：_webSocketMessages%)Second：_webSocketMessages)ws-data(：data ws-message)try-parse#((%true)(Throwable_Nil))；；Roam通过WS消息发送一系列JSON对象。；；如果一个对象大于16KB，它会被拆分；；多条消息-因此我们需要将它们缝合在一起。WS-json(([{：keys[Done Partial]}Next]([Potential-json-str(Partial Next)]([json(Potential-json-str)]{：Done(Done Json)：Partial&#34；&#34；}{：Done Done：Partial Potential-json-str})){：Done[]：Partial&#34；&#34；}ws-Data)](：Partial WS-json)&#34；&#34；))(：Done ws-json))。</p><p>有了我们解析的WebSocket消息，我们可以看到其中许多消息看起来像是事务。其中一个看起来特别可疑的字段有一个名为tx-meta的嵌套字段，值为delete-page！交易如下所示：</p><p>{：应用程序版本&#34；0.7.4&#34；，：电子邮件&#34；hello@jeff.yt&#34；，：Session-id&#34；uuid95d98efd-c8fa-4412-87a4-e7b7201bee24&#34；，：t 1603947791561，：Time 1603947791542，：tx&#34；[[\&#34；^\&#34；，\&#34；~：Block/uid\&#34；，\&#34；ogCRjInhE\&#34；，\&#34；~：Block/String\&#34；，\&#34；一些文本-此处\&#34；，\&#34；~：编辑/时间\&#34；，1603947791363，\&#34；~：编辑/电子邮件\&#34；，\&#34；hello@jeff.yt\&#34；]，[\&#34；^\&#34；，\&#34；^0\&#34；，\&#34；4CpSytRnt\&#34；，\&#34；^1\&#34；，\&#34；突出显示首次同步日期为#Readwise 10.28,2020\&#34；，\&#34；^2\&#34；，1603947791364，\&#34；^3\&#34；，\&#34；Hello@jeff.yt\&#34；]，[\&#34；^\&#34；，\&#34；^0\&#34；，\&#34；C-IOsE50G\&#34；，\&#34；^1\&#34；，\&#34；2020年10月28日晚上11：03添加新亮点\&#34；，\&#34；^2\&#34；，1603947791364，\&#34；^3\&#34；，\&#34；，[\&#34；~：db.fn/retractEntity\&#34；，[\&#34；^0\&#34；，\&#34；]]，[\&#34；^4\&#34；，[\&#34；^0\&#34；，\&#34；VwD08rqdT\&#34；]]，[\&#34；^4\&#34；，[\&#34；^0\&#34；，\&#34；6VWOGgeAd\&#34；]，[\&#34；^4\&#34；，[\&#34；^0\&#34；，\&#34；P56-fWN2O\&#34；]]，[\&#34；^4\&#34；，[\&#34；^0\&#34；，\&#34；SffV3NfN2\&34；]]，[\&#34；^4\&#34；，\&#34；^0\&#34；，\&#34；SffV3NfN2\&34；]]，[\&#34；^4\&#34；，[\&#34；^0\&#34；，\&#34；qnZBZCGCv\&#34；]]，[\&#34；^4\&#34；，[\&#34；^0\&#34；，\&#34；10-28-2020\&#34；]]&#34；，：tx-META{：Event-id&#34；uuid719b009f-b969-47b6-b2db-41542d10b328&#34；，：Event-Name&34；删除-第&#34页；，：tx-id&#34；uuid289e80fc-4c27-4d54-9df4-d83ac0ceeaed&#34；，：tx-name&#34；删除页面&#34；}}。</p><p>为了节省空间，我省略了大约90%的事务处理--但它们大同小异。这看起来绝对像删除了我的Daily Notes页面的事务：我在事务中看到db.fn/retractEntity和10-28-2020。有趣的是，该事务还捕获了两个ReadWise交互。这不是确凿的证据，但我的页面被神秘删除的同时，Readwise正在操作我的数据库，这一点绝对令人怀疑！</p><p>让我们在这里暂停一下，并与漫游松弛小组签到。已经有人开了一个关于数据丢失的帖子了！他们和其他人很快确认，他们也都启用了ReadWise的自动导出功能。再说一次，这并不是说Readwise是罪魁祸首，但这足以让我停止我正在做的事情，并禁用我的Readwise集成！我们还将在松弛线程中分享我们的知识，并要求受影响的用户像我们一样保存他们的roam Har文件。</p><p>后来，Readwise的创始人特里斯坦突然进入Slake，并迅速证实，最近的漫游行为变化与Readwise的整合相结合，可能会导致页面被删除。特里斯坦做出完美回应的巨大道具：他对问题进行分类，禁用功能以防止更多用户点击它，并在几个小时内修复并重新启用自动导出！特里斯坦也很善于沟通，承担全部责任，甚至提供退款，尽管我认为，当Roam还没有开放他们的公共API时，这些问题肯定会发生。</p><p>再次查看解析后的Har文件，我们会发现似乎是我们的序列化数据库-它是这样存储的：</p><p>这看起来像是过境！Transfer是一种类似JSON的格式，用于在应用程序之间发送数据(这篇文章是一个很好的介绍)。Datascript有它自己的传输处理程序集-让我们导入它，看看我们是否得到了一个工作的数据库！当然，我们还需要通过将传输编码的字符串粉碎在一起来组合Split-db。</p><p>(&#39；[datcript.Transition：AS DT])(parse-db[parsed-har]([db-str(parsed-har；；数据库嵌套很深！(#(%：D：B：D：Split-db))first：D：B：D：Split-db(&#34；&#34；))](db-str))。</p><p>瞧--一个真正的Datascript数据库！我们可以通过查询确认它是我的漫游数据库：</p><p>(&#39；[datcript.core：as d])([db(harfile()())conn(Db)](&#39；[：find？e：where[？e：node/title&#34；Daily Template&#34；]@conn))；；#{[1855]}。</p><p>对于正在运行的漫游数据库，我们的下一步是应用我们拥有的所有事务，直到删除事件。事务是传输编码的，我们必须进行相当多的数据操作才能获得它们的列表。一旦我们有了该列表，我们就可以对交易进行排序并按顺序应用它们：</p><p>(Apply-Transaction-Until[db parsed-har Until-time]([要应用的事务(parsed-har(#(%：D：B：D)(seqable？)。(CONCAT)(#((%First Name)&#34；-MK&#34；))(Second)(#((：time%)to-time))(：time)(：tx)(dt/read-transportstr)conn(Db)]([要应用的Tx事务](Conn Tx))(Conn))。</p><p>这里，Until-time是删除事务的时间。我们现在就快到了！在我的笔记被删除之前，我们已经成功地实现了我的漫游数据库！我们现在需要做的就是删除那个页面，然后我们就可以完成了！</p><p>恢复我删除的页面应该不会太难：我们可以使用Datascript的拉动功能递归地抓取整个页面的内容！</p><p>(recover[db]([conn(Db)note-eid((`[：find？e：where[？e：block/uid~Missing-Date]@conn))page(db&#39；[：block/string{：block/Children[：block/order：block/string{：block/Children...}]}]note-eid)]page))(Db)；#：block{：Children[#：block{：order 0，；：String&#34；[[体育馆💪🏽]]&#34；，；：儿童[#：Block{：Order 0，；；：String&#34；#[[Weight Room]]&#34；，；：Children[#：Block{：Order 0，：String&#34；Back 5x5x225&#34；}；#：Block{：Order 1，：String&#34；Seated row 4x12x100&#34；}]}。</p><p>接下来，让我们将此数据结构转换为可以粘贴回Roam中的内容。我们可以通过递归地物化块的子块来物化字符串，在递归时增加缩进：</p><p>(物化[{：KEYS[块/字符串]：作为页面}级别]([缩进(级别4)子页面((：块/子页面)(：块/顺序)(#(%(级别)(#(&#34；%s-%s&#34；(str(缩进&#34；&#34；))%)(&#34；\n&#34；)])]((String(Children))(String&#34；\n&#34；Children)(Children)Children String：Else&#34；&#34；)(Recover[db]([conn(Db)note-eid((`[：find？e：where[？e：block/uid~Missing-Date]]@conn))页面(db&#39；[：BLOCK/String{：BLOCK/CHILD[：BLOCK/ORDER：BLOCK/STRING{：BLOCK/CHILD...}]}]备注-eid)](第0页))(Db)；-[[体育馆💪🏽]]；-#[[重量间]]；-工作台5x5x225；-座位行4x12x100。</p><p>就是这样！现在我们可以将该字符串复制到漫游中，我们已经完全恢复了丢失的漫游页面结构和所有内容！您可以在这里找到完整的代码。</p><p>这是多么好的一种方式来度过一个上午啊！我非常感谢我能找回丢失的笔记。我很幸运，Roam在删除后没有对我的数据库进行快照-这将使这种方法变得不可能。我也感谢来自Readwise的特里斯坦和其他所有在漫游中的人，他们帮助隔离和调试了这个问题。我希望我能够帮助他们中的至少几个人恢复他们的数据。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://jeffchen.dev/posts/Recovering-Lost-Roam-Notes/">https://jeffchen.dev/posts/Recovering-Lost-Roam-Notes/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/恢复/">#恢复</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/lost/">#lost</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/readwise/">#readwise</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1028415.html"><img src="http://img2.diglog.com/img/2020/10/thumb_b8e6f973b550a673e39c683f4e2797a6.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1028415.html">在COVID19关闭期间，鸟类对半个世纪以来的声景恢复做出反应</a></div><span class="my_story_list_date">2020-10-13 20:0</span></div><div class="col-sm"><div><a target="_blank" href="/story/1020043.html"><img src="http://img.diglog.com/img/2020/8/thumb_fc4e44023eab9f0cac4dc01cf91ff080.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1020043.html">
YAC得到Slake的支持，在远程同事互动时恢复了语音的亲切感</a></div><span class="my_story_list_date">2020-8-25 0:0</span></div><div class="col-sm"><div><a target="_blank" href="/story/1018685.html"><img src="http://img.diglog.com/img/2020/8/thumb_559f1b5484608b0bf303561e438ce6f5.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018685.html">在2.11BSD恢复项目期间发现的修补程序中存在35年的错误</a></div><span class="my_story_list_date">2020-8-18 0:26</span></div><div class="col-sm"><div><a target="_blank" href="/story/1018064.html"><img src="http://img.diglog.com/img/2020/8/thumb_407310a3526f30069c1176e7bc4e70fc.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018064.html">谷歌恢复对地址栏的攻击，隐藏Chrome86的完整地址</a></div><span class="my_story_list_date">2020-8-14 23:44</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>