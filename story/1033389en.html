<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>利用K3在2020年内管理我的个人服务器</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">利用K3在2020年内管理我的个人服务器</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-06 07:14:10</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/11/7b15f85cf51e716c60511d53696eacf2.jpeg"><img src="http://img2.diglog.com/img/2020/11/7b15f85cf51e716c60511d53696eacf2.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Permalink     GitHub is home to over 50 million developers working together to host and review code, manage projects, and build software together.</p><p>PermalLink GitHub是5000万多名开发人员的家园，他们一起工作，共同托管和审查代码、管理项目和构建软件。</p><p>  Sign up</p><p>报名。</p><p>       This document is going to describe how I manage my personal server in 2020. It will talk about</p><p>本文档将介绍我在2020年如何管理我的个人服务器。它将谈论关于。</p><p>      &lt;iframe width=&#34;560&#34; height=&#34;315&#34; src=&#34; https://www.youtube.com/embed/P5ZJui3aPoQ&#34; frameborder=&#34;0&#34; allow=&#34;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture&#34; allowfullscreen&gt;&lt;/iframe&gt;  It has been more than 15 years now that I manage my own dedicated server, I am in my thirties, and it all started thanks to a talk from Benjamin Bayart  Internet libre, ou minitel 2.0 or for the non-French &#34;Free internet or minitel 2.0&#34;. For those who don&#39;t know what is a minitel, let me quote for you Wikipedia.</p><p>&lt；iframe宽度=&#34；560&#34；高度=&#34；315&#34；src=&#34；https://www.youtube.com/embed/P5ZJui3aPoQ&#34；帧边界=&#34；0&#34；允许=#34；加速度计；自动播放；剪贴板写入；加密媒体；陀螺仪；画中画&34；允许屏幕&&gt;；/iframe&&gt;；我管理自己的专用服务器已经15年多了，我已经30多岁了，这一切都要归功于本杰明·巴亚特(Benjamin Bayart)互联网图书馆的一次演讲，或者是为了非法语的免费互联网或Minitel 2.0。对于那些不知道什么是Minitel的人，让我为你引述一下维基百科(Wikipedia)。</p><p> The Minitel was a videotex online service accessible through telephone lines, and was the world&#39;s most successful online service prior to the World Wide Web. It was invented in Cesson-Sévigné, near Rennes in Brittany, France.</p><p>Minitel是一种可通过电话线访问的可视图文在线服务，在万维网出现之前是世界上最成功的在线服务。它是在法国布列塔尼雷恩附近的塞松-塞维涅发明的。</p><p> In the essence, the talk is about creating awareness in 2007 that the internet is starting to lose its decentralized nature and look like more to a minitel 2.0 due to our reliance on centralized big corp for about everything on the Web. This warning ring even louder nowadays with the advent of the Cloud where our computers are now just a fancy screen for accessing data/compute remotely.</p><p>本质上，这场讨论是关于在2007年让人们意识到，由于我们依赖集中化的大公司来处理网络上的一切，互联网正开始失去其分散性，看起来更像是Minitel 2.0。如今，随着云的出现，这种警告的声音变得更加响亮，我们的计算机现在只是一个用于远程访问数据/计算的奇特屏幕。</p><p> I went from hardcore extremist, by hosting a server made from scrap materials behind my parent house telephone line, using Gentoo to recompile everything, control every USE flags and have the satisfying pleasure of adding  -mtune=native to the compilation command line. Some years later, after being fed up with having to spend nights to recompile everything on an old Intel Pentium 3 because I missed a USE flag that was mandatory to try this new software, I switched to Debian.</p><p>我从一个铁杆极端分子，在我父母家的电话线后面托管了一个由废弃材料制成的服务器，使用Gentoo重新编译所有东西，控制每一个使用标志，并享受着在编译命令行中添加-mtune=ative的令人满意的乐趣。几年后，因为错过了试用这款新软件所必需的使用标志，我受够了不得不在旧的英特尔奔腾3上花上几个晚上重新编译所有的东西，于是我转而使用Debian。</p><p> At that point I thought I had the perfect setup, just do an  apt-get install and you have your software installed in a few minutes, is there anything more than that really ?</p><p>在这一点上，我认为我有一个完美的设置，只需做一个apt-get安装，你就可以在几分钟内安装好你的软件，还有什么比这更多的吗？</p><p> It was at that time also that I switched from hosting my server at my parent house to a hosting company. I was out for college and calling my parents to ask them to reboot the machine because it froze due to aging components was taking too much time. I was living in the constant fear of losing some emails and friends on IRC were complaining that the archive/history of the channel that my server was providing was not accessible anymore. So as hard as the decision had been, especially since everything was installed by hand without configuration management, I went to see my parents to tell them that I am removing the server from their care to host it on  online.net and that they should expect even fewer calls from me from now on.</p><p>也是在那个时候，我从母家托管我的服务器转到了托管公司。我去上大学了，打电话给我的父母，让他们重新启动机器，因为它因为组件老化而死机，花费了太多的时间。我一直生活在丢失电子邮件的恐惧中，IRC上的朋友抱怨说，我的服务器提供的频道的档案/历史再也无法访问了。因此，尽管这个决定很艰难，特别是因为所有的东西都是手工安装的，没有配置管理，但我去见了我的父母，告诉他们我将把服务器从他们手中移除，转而托管在Online e.net上，而且从现在开始，他们应该会更少地接到我的电话。</p><p> Rich of this new available bandwidth and after porting my manual deployments to Ansible, I really thought this time I had the perfect setup. Easy to install and configured management ! Is there anything more than that really ?</p><p>这个新的可用带宽非常丰富，在将我的手动部署移植到Ansible之后，我真的认为这一次我有了完美的设置。易于安装和配置管理！还有什么比这更重要的吗？</p><p> I had found my cruise boat and sailed peacefully with it until the dependencies monsters knocked me off board. When you try to  CRAM everything (mail, webserver, gitlab, pop3, imap, torrent, owncloud, munin, ...) into a single machine on Debian, you ultimately end-up activating unstable repository to get the latest version of packages and end-up with conflicting versions between softwares to the point that doing an  apt-get update &amp;&amp; apt-get upgrade is now your nemesis.</p><p>我找到了我的游艇，平静地乘着它航行，直到那些依附的怪物把我赶下了船。当你试图填满所有东西(邮件、网络服务器、GitLab、POP3、IMAP、Torrent、ownCloud、Munin等等)。在Debian上的一台机器上，你最终会激活不稳定的存储库来获取最新版本的包，最终导致软件之间的版本冲突，以至于进行apt-get更新&amp；&amp；apt-get升级现在成了你的死对头。</p><p> While avoiding system upgrade, I spent some time playing with Kvm/Xen, FreeBSD jails, Illumos, micro-kernel (I thought it will be the future :x) and the new player in town Docker ! I ended-up using Docker due to being too busy/lazy to reinstall everything on something new and Docker allowed me to progressively isolate/patch the software that were annoying me. Hello Python projects !</p><p>在避免系统升级的同时，我花了一些时间玩KVM/Xen、FreeBSD jages、Illumos、微内核(我认为它将是未来的X)和Docker镇的新玩家！由于太忙/太懒，我最终使用了Docker，没有时间在新的东西上重新安装所有东西，而Docker让我逐渐隔离/修补令我恼火的软件。你好，Python项目！</p><p> This hybrid setup worked for a while, but it felt clunky to manage, especially with Ansible in the mix. I ended-up moving everything into containers, not without hassle, and now Ansible was felling at odd and the integration between systemd and Docker weird, I was just spending time gluing trivial things.</p><p>这种混合设置曾经奏效过一段时间，但它让人感觉管理起来很笨拙，特别是在Ansible的参与下。我最后把所有东西都搬到了容器里，并不是没有麻烦，现在Ansible对ODD感到奇怪，System d和Docker之间的集成也很奇怪，我只是把时间花在粘合琐碎的东西上。</p><p> So I spent a bit of time this month to create and share with you my perfect new setup for managing a personal server in 2020 !</p><p>因此，这个月我花了一些时间来创建并与大家分享我在2020年管理个人服务器的完美新设置！</p><p>  So let&#39;s start. The first step is to create a GPG key. This key will serve to encrypt every secret we have in order to be able to commit them inside the git repository. With secrets inside git, our repository will be able be standalone and portable across machines. We will be able to do a  git clone and get working !</p><p>所以，让我们开始吧。第一步是创建一个GPG密钥。这个密钥将用于加密我们拥有的每一个秘密，以便能够在git存储库中提交它们。有了git内部的秘密，我们的存储库将能够独立运行，并且可以跨机器移植。我们将能够进行git克隆并开始工作！</p><p>  This GPG key will be the guardian of your infrastructure, if it leaks, anybody will be able to access your infra. So store it somewhere safe</p><p>这个GPG密钥将是你的基础设施的守护者，如果它泄露了，任何人都可以访问你的基础设施。所以把它放在安全的地方</p><p>   Now that we have a PGP key, we will use the wonderful tool  SOPS to encrypt our secrets with it.</p><p>现在我们有了PGP密钥，我们将使用这个非常棒的工具SOPS来加密我们的秘密。</p><p> Sops is not very well known, but very practical and easy to use, which is a great plus for once in a security tool.</p><p>SOPS不是很出名，但非常实用和易于使用，这对于一个安全工具来说是一个很好的加分。</p><p>   After that just invoke sops to create a new secret with your GPG key. Sops force the use of YAML, so your file need to be a valid YAML.</p><p>在那之后，只需调用SOPS来用您的GPG密钥创建一个新的秘密即可。SOPS强制使用YAML，因此您的文件需要是有效的YAML。</p><p> ❯ mkdir secrets secrets_decrypted❯ sops secrets/foobar.yml * editor with default values  *❯ cat secrets/foorbar.yml   # content of file is encrypted nowhello: ENC[AES256_GCM,data:zpzQz+siZxcshJjmi4PBvX2GMm3sWibxRPCgil2mi+c6AQ0uXEBLM2lL0o+BBg ==,...</p><p>ECCmkdir Secret_Deccrypted❯SOPS Secret/foobar.yml*编辑器使用默认值*❯猫机密/foorbar.yml#文件内容不加密：enc[AES256_GCM，ECC[AES256_GCM，ENTC[AES256_GCM，ENTC[AES256_GCM，FORBAR.YML==，...。</p><p>   There are other commands that allow you to avoid dumping your decrypted secrets onto the file system. If you are interested in this feature look at</p><p>还有其他命令允许您避免将解密的机密转储到文件系统。如果您对此功能感兴趣，请查看。</p><p>   Now that we are able to store secrets securely within our repository, it is time to generate a new ssh key in order to be able to log to our future next server.</p><p>现在我们可以在存储库中安全地存储秘密，是时候生成一个新的ssh密钥，以便能够登录到我们未来的下一台服务器。</p><p> We are going to set a passphrase to our ssh keys and use a ssh-agent/ keychain in order to avoid typing it every time</p><p>我们将为ssh密钥设置密码短语，并使用ssh代理/密钥链，以避免每次都输入密码。</p><p> # Don&#39;t forget to set a strong passphrase and change the default name for your key from id_rsa to something else, it will be usefull later onssh-keygen  # To add your ssh ke into the keyring eval   $(keychain --eval --agents ssh  ~/.ssh/your_private_key )</p><p>#不要忘记设置一个强密码，并将密钥的默认名称从id_rsa更改为其他名称，稍后在ssh-keygen#将ssh ke添加到密钥环eval$(keychain--val--Agents ssh~/.ssh/you_Private_key)会很有用。(=</p><p>  sops secrets/ssh.yml  # edit the yaml file to get 2 section for your private and public ssh key  # paste the content of your keys in this sectiongit add secrets/ssh.ymlgit commit -m   &#39;Adding ssh key &#39;</p><p>SOPS secrets/ssh.yml#编辑YAML文件以获得私钥和公钥的2个部分#将密钥的内容粘贴到此部分中它添加秘密/ssh.ymlgit Commit-m&#39；添加ssh密钥&#39；</p><p>  Now we want for this repository to be self-contained and easily portable across machines. A valid approach would have been to use Ansible in order to automate our deployment. But we will not tap a lot into the full power of a configuration management in this setup, so I chose to use a simple makefile to automate the deployment.</p><p>现在，我们希望这个存储库是自包含的，并且可以方便地跨机器移植。一种有效的方法是使用Ansible来自动化我们的部署。但是在这个设置中，我们不会充分利用配置管理的全部功能，所以我选择使用一个简单的Makefile来自动化部署。</p><p> ❯ mkdir config❯ cat Makefile.PHONY: installinstall: sops -d --extract   &#39;[&#34;public_key&#34;] &#39; --output  ~/.ssh/erebe_rsa.pub secrets/ssh.yml sops -d --extract   &#39;[&#34;private_key&#34;] &#39; --output  ~/.ssh/erebe_rsa.key secrets/ssh.yml chmod 600  ~/.ssh/erebe_rsa. * grep -q erebe.eu  ~/.ssh/config  &gt; /dev/null  2&gt;&amp;1  || cat config/ssh_client_config  &gt;&gt;  ~/.ssh/config mkdir  ~/.kube  ||  exit 0</p><p>❯mkdir配置❯猫生成文件。PHONY：安装：SOPS-d--提取#39；[&#34；公钥#34；]&#39；--输出~/.ssh/erebe_rsa.pub secrets/ssh.yml sops-d--提取&#39；[&#34；私有密钥&#34；]&#39；--输出~/.ssh/erebe_rsa.key secre.s。*grep-q erebe.eu~/.ssh/config&gt；/dev/null 2&gt；&amp；1||cat config/ssh_client_config&gt；&gt；~/.ssh/config mkdir~/.kube||退出0。</p><p> The installation section is decrypting the ssh keys, install them and looking into my ~/.ssh/config to see if I already have a section for my server in order to add it if missing. With that I will be able to do a  ssh my-server and get everything setup correctly</p><p>安装部分正在解密ssh密钥，安装它们，然后查看我的~/.ssh/config，看看我的服务器是否已经有一个部分，以便在丢失时添加它。这样，我就能够执行ssh my-server，并正确设置所有内容。</p><p>  We have a git repository with our ssh keys, so now is the time to use those keys and get a real server behind it.</p><p>我们有一个git存储库和我们的ssh密钥，所以现在是时候使用这些密钥并得到一个真正的服务器来支持它了。</p><p> Personally I use a 1st tier  dedibox from  online.net now renamed into  scaleway for 8€ per month. Their machine is rock solid, cheap and never had an issue with them since more than 15 years. You are free to chose whatever provider you want but here my recommendations for the thing to look at</p><p>就我个人而言，我使用的是Online.net的一级包厢，现在更名为scaleway，每月8欧元。他们的机器坚如磐石，价格便宜，15年多来从未出过问题。你可以自由选择你想要的任何供应商，但我在这里推荐给你看的东西。</p><p> Disk space: Using containers consume a lot of disk space. So take a machine with at least 60G of space.</p><p>磁盘空间：使用容器会消耗大量磁盘空间。因此，就拿一台至少有60G空间的机器来说吧。</p><p> Public bandwidth limitation: All hosting company throttle public bandwidth to avoid issue with torrent seedbox. So the higher you get for the same price, the better it is (i.e: scaleway provide 250Mbits/s while OVH only 200Mbits)</p><p>公共带宽限制：所有托管公司都会限制公共带宽，以避免Torrent种子盒出现问题。同样的价格越高越好(比如：Sceway提供250Mbit/s，而OVH只提供200Mbit/s)</p><p> Free backup storage: At some point we will have data to backup, so look if they provide some external storage for backups</p><p>免费备份存储：在某一时刻，我们将有数据要备份，因此请查看他们是否为备份提供了一些外部存储。</p><p>  Domain name/Free mail account: If you plan to use them as a registrar for your domain name, look if they can provide you email account storage in order to configure them as fallback to not lose mail</p><p>域名/免费邮件帐户：如果您计划使用它们作为您的域名的注册商，请查看它们是否可以为您提供电子邮件帐户存储，以便将它们配置为后备，以不丢失邮件。</p><p> Once you have your server provider, do the installation and choose Debian for the OS. At some point we will ask you for your ssh key, so provide the one you created earlier. If you have the possibility to select your filesystem use XFS instead of ext4 as it provides good support</p><p>一旦您有了服务器提供商，请进行安装并选择Debian作为操作系统。在某个时刻，我们会要求您提供ssh密钥，因此请提供您之前创建的密钥。如果可以选择文件系统，请使用XFS而不是ext4，因为它提供了很好的支持。</p><p>    The machine is in place and reachable to the outside world.First thing to do is secure it ! We want to :</p><p>机器已经就位，外界可以接触到。首先要做的是保护好它！我们希望：</p><p>    HOST= ${my-server}.PHONY: install package  # ...package: ssh  ${HOST}   &#39;apt-get update &amp;&amp; apt-get install -y curl htop mtr tcpdump ncdu vim dnsutils strace linux-perf iftop &#39;   # Enable automatic security Updates ssh  ${HOST}   &#39;echo &#34;unattended-upgrades unattended-upgrades/enable_auto_updates boolean true&#34; | de bconf-set-selections &amp;&amp; apt-get install unattended-upgrades -y &#39;</p><p>Host=${my-server}.PHONY：安装程序包#...程序包：SSH${host}&#39；apt-get update&amp；&amp；apt-get install-y curl HTOP MTR Tcpump ncdu vim dnsutils strace linux-perf iftop；#启用自动安全更新ssh${host。</p><p> With that the machine will install security update by its own, without requesting us to type manually  apt-get update &amp;&amp; apt-get upgrade</p><p>这样，计算机将自行安装安全更新，而不需要我们手动键入apt-get update&amp；&amp；apt-get upgrade。</p><p>  Next is improving the security of our ssh server. We are going to disable password authentication and allowing only public key authentication.As our ssh keys are encrypted in our repository, they will be always available to us if needed, as long as we have the GPG key.</p><p>下一步是提高ssh服务器的安全性。我们将禁用密码身份验证，只允许公钥身份验证。因为我们的ssh密钥在我们的存储库中是加密的，所以只要我们拥有GPG密钥，如果需要，它们将始终可用。</p><p>   As I don&#39;t use any configuration management (i.e: Ansible), It is kind of tedious to use a normal user and leverage privilege escalation (sudo) to do stuff in  root. So I allow root login on the SSH server to make things easier to manage. If you plan to use a configuration management system, disable the root login authentication.</p><p>因为我不使用任何配置管理(即：Ansible)，所以使用普通用户并利用权限提升(Sudo)在根目录下执行操作有点单调乏味。因此，我允许以超级用户身份登录SSH服务器，以便于管理。如果您计划使用配置管理系统，请禁用超级用户登录身份验证。</p><p>  Warning Be sure that you are correctly able to log with your ssh key before doing that or you will need to reinstall your machine/use the rescue console of your hosting provider to fix things</p><p>警告：在执行此操作之前，请确保您能够正确地使用ssh密钥登录，否则您将需要重新安装您的机器/使用主机提供商的救援控制台来修复问题。</p><p> ❯ Makefile.PHONY: install package ssh  #...  # Check if the file is different from our git repository and if it is the case re-upload and restart the ssh serverssh: ssh  ${HOST}   &#34;cat /etc/ssh/sshd_config &#34;  | diff - config/sshd_config \  || (scp config/sshd_config  ${HOST}:/etc/ssh/sshd_config  &amp;&amp; ssh  ${HOST} systemctl restart</p><p>❯生成文件。PHONY：安装程序包ssh#...#检查该文件是否与我们的GIT存储库不同，如果是，请重新上传并重新启动ssh服务器：ssh${HOST}&#34；cat/etc/ssh/sshd_config&#34；|diff-config/sshd_config\||(scp config/sshd_config${host}：/etc/ssh/sshd_config&amp；&amp。</p><p>    Last part of the plan is to secure the network by putting in place firewall rules.</p><p>该计划的最后一部分是通过制定防火墙规则来保护网络安全。</p><p> I want to stay close to the real things, so I use directly iptables to create my firewall rules. This is at the cost of having to duplicate the rules for IPv4 and IPv6.</p><p>我想要接近真实情况，所以我直接使用iptable来创建我的防火墙规则。这是以不得不复制IPv4和IPv6的规则为代价的。</p><p>  We want for our deployment of iptables rules to be idempotent, so we are going to create a custom chain to avoid messing with the default one.Also, I am going to use  iptables command directly instead of  iptable-restore, because  iptables-restore files need to be holistic and does not compose well when programs manage only a subpart of the firewall rules. As we are going to install Kubernetes later on, it will allow us to avoid messing with proxy rules.</p><p>我们希望iptable规则的部署是幂等的，因此我们将创建自定义链以避免干扰默认规则。此外，我将直接使用iptable命令而不是iptable-Restore，因为iptable-Restore文件需要是整体的，并且当程序只管理防火墙规则的一个子部分时不能很好地组合。由于我们稍后将安装Kubernetes，它将允许我们避免扰乱代理规则。</p><p> #!/bin/sh  # Execute only when it is for our main NIC[   &#34; $IFACE &#34;  !=   &#34;enp1s0 &#34; ]  ||  exit 0  # In order to get an IPv6 lease from online.netsysctl -w net.ipv6.conf.enp1s0.accept_ra=2  ###########################  # IPv4  ###########################  # Reset our custom chainiptables -P INPUT ACCEPTiptables -D INPUT -j USER_CUSTOMiptables -F USER_CUSTOMiptables -X USER_CUSTOMiptables -N USER_CUSTOM  # Allow loopback interfaceiptables -A USER_CUSTOM -i lo -j ACCEPT  # Allow wireguard interfaceiptables -A USER_CUSTOM -i wg0 -j ACCEPT  # Allow Kubernetes interfacesiptables -A USER_CUSTOM -i cni0 -j ACCEPTiptables -A USER_CUSTOM -i flannel.1 -j ACCEPT  # Allow already accepted connectionsiptables -A USER_CUSTOM -p tcp -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPTiptables -A USER_CUSTOM -p udp -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPTiptables -A USER_CUSTOM -p icmp -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT  # Accept incoming ICMP - Server provider use ping to monitor the machineiptables -A USER_CUSTOM -p icmp -j ACCEPT  # Allow sshiptables -A USER_CUSTOM -p tcp --dport 22 -j ACCEPT  # Allow http/httpsiptables -A USER_CUSTOM -p tcp --dport 80 -j ACCEPTiptables -A USER_CUSTOM -p tcp --dport 443 -j ACCEPT  # Allow SMTP and IMAPiptables -A USER_CUSTOM -p tcp --dport 25 -j ACCEPTiptables -A USER_CUSTOM -p tcp --dport 993 -j ACCEPT  # Allow wireguardiptables -A USER_CUSTOM -p udp --dport 995 -j ACCEPT  # Allow kubernetes k3S api serveriptables -A USER_CUSTOM -p tcp --dport 6443 -j ACCEPT  # Add our custom chainiptables -I INPUT 1 -j USER_CUSTOM  # DROP INCOMING TRAFFIC by default if nothing matchiptables -P INPUT DROP  #######  #IPv6  #######  #do the same thing with ip6tables instead of iptables  # Accept incoming ICMPip6tables -A USER_CUSTOM -p icmpv6 -j ACCEPT  # Allow ipv6 route auto configuration if your provider support itip6tables -A USER_CUSTOM -p udp --dport 546 -j ACCEPTip6tables -A USER_CUSTOM -p icmpv6 --icmpv6-type router-advertisement -j ACCEPTip6tables -A USER_CUSTOM -p icmpv6 --icmpv6-type router-solicitation -j ACCEPTip6tables -A USER_CUSTOM -p icmpv6 --icmpv6-type neighbour-advertisement -j ACCEPTip6tables -A USER_CUSTOM -p icmpv6 --icmpv6-type neighbour-solicitation -j ACCEPT ip6tables -A USER_CUSTOM -p icmpv6 --icmpv6-type echo-request -j ACCEPTip6tables -A USER_CUSTOM -p icmpv6 --icmpv6-type echo-reply -j ACCEPT</p><p>#！/bin/sh#仅当它用于我们的主NIC[&#34；$iFace&#34；！=&#34；enp1s0&#34；]|退出0#以便从Online获取IPv6租约。netsysctl-w net.ipv6.conf.enp1s0.ept_ra=2#重置我们的自定义链表-P输入ACCEPTipables-D INPUT-j user_。N user_Custom#Allow Loopback Interfaceipables-A user_Custom-i lo-j Accept#Allow Wireguard Interfaceipables-A user_Custom-i wg0-j Accept#Allow Kubernetes InterfaceSipables-A user_Custom-I cni0-j ACCEPTipables-A user_Custom-I flannel.1-j Accept#Allow Allow Alternated ConnectionSapeipables-A user_Custom-p tcp-m Connail-ctc-ctcstate established，Related-j ACCEPTipables-A user_Custom-p UDP-m ConnTrack--ctstate established，Related-j ACCEPTipables-A user_Custom-p ICMP-m ConnTrack--ctstate established，Related-j Accept#Accept传入ICMP-服务器提供程序使用ping来监视机器识别表-A user_Custom-p ICMP-j Accept#Allow sShipables-A user_Custom-p tcp--dport 22-j Accept#Allow http/Http-p TCP--dport 80-j ACCEPTipables-A user_Custom-p TCP--dport 443-j Accept#Allow SMTP and IMAPiptable-A user_Custom-p TCP--dport 443-j Accept#Allow SMTP and IMAPiptable-A user_Custom-p TCP--dport 443-j Accept#Allow SMTP and IMAPiptable。#Allow wireguardiptable-A user_CUSTOM-p UDP--dport 995-j Accept#Allow Kubernetes k3S API serverables-A user_Custom-p tcp--dport 6443-j Accept#添加自定义链接表-i输入1-j user_Custom#如果没有匹配表-P输入丢弃，默认情况下丢弃传入流量#IPv6#对ip6table而不是iptabtable执行相同的操作。如果您的提供商支持itip6table--A user_Custom-p UDP--dport 546-j ACCEPTip6ables--icmpv6-type路由器-advertisement-j ACCEPTip6table--icmpv6--A user_Custom-p icmpv6--icmpv6-type Router-Solication-j ACCEPTip6ables--A user_Custom-p icmpv6--icmpv6--icmpv6-type路由器-请求-j ACCEPTip6ables--dport 546--j ACCEPTip6ables--icmpv6--icmpv6。A user_Custom-p icmpv6--icmpv6-type ECHO-REPLY-j Accept。</p><p> I don&#39;t rate limit ssh connections, as most of the time it is me that is hit by that limit. Nowadays most bot scanning ssh servers are smart enough to time their attempts to avoid being rate limited.Even if we are only allowing public key authentication, some bots are going to try endlessly to connect to our SSH server, in hope that someday a breach appears. Like waves crashing tirelessly on the shore.</p><p>我不会限制ssh连接的速率，因为大多数时候是我受到了这个限制。如今，大多数僵尸扫描ssh服务器都足够聪明，能够计时以避免速率受限。即使我们只允许公钥身份验证，一些僵尸也会没完没了地尝试连接到我们的SSH服务器，希望有一天会出现漏洞。就像海浪不知疲倦地拍打着海岸。</p><p>  -A USER_CUSTOM -p tcp -m conntrack --ctstate NEW --dport 22 -m recent --set --name SSH-A USER_CUSTOM -p tcp -m conntrack --ctstate NEW --dport 22 -m recent --update --seconds 60 --hitcount 4 --rttl --name SSH -j DROP-A USER_CUSTOM -p tcp -m conntrack --ctstate NEW --dport 22 -j ACCEPT</p><p>--A user_Custom-p tcp-m ConnTrack--ctstate new--dport 22-m recent--set--name SSH-A user_Custom-p tcp-m ConnTrack--ctstate new--dport 22-m recent--update--秒60--HitCount 4--rtl--name SSH-j drop--A user_Custom-p tcp-m ConnTrack--ctstate new--dport 22-j Accept</p><p> We are going to deploy those rules in the  if-pre-up to restore them automatically when the machine reboots. As those rules are idempotent we force their execution when invoked to be sure they are in place.</p><p>我们将在if-pre-up中部署这些规则，以便在机器重新启动时自动恢复它们。因为这些规则是幂等的，所以我们在调用它们时强制执行它们，以确保它们到位。</p><p>   Now that we have a server provisioned and a bit more secure, we want to assign it a cute DNS name instead of just its IP address.If you don&#39;t know what is a DNS please refer to :</p><p>现在我们已经配置了服务器，并且安全性更高了，我们想为它分配一个可爱的DNS名称，而不仅仅是它的IP地址。如果您不知道什么是DNS，请参阅：</p><p>   I personally use  GANDI.net, as they provide free mailbox with a domain name. While I run a postfix/mail server on my server to receive and store emails, to avoid having to set up and manage a tedious DKIM I use GANDI SMTP mail server to send my emails and be trusted/not end up as spams. More on that later in setup your mail server.</p><p>我个人使用Gandi.net，因为他们提供带有域名的免费邮箱。当我在服务器上运行Postfix/邮件服务器来接收和存储电子邮件时，为了避免设置和管理繁琐的DKIM，我使用Gandi SMTP邮件服务器来发送电子邮件，并且被信任/不会成为垃圾邮件。在后面的设置邮件服务器中将详细介绍这一点。</p><p>  Propagation should be fast enough (if you plan to use let&#39;s encrypt DNS challenge for wildcard)</p><p>传播速度应该足够快(如果您计划对通配符使用LET的加密DNS质询)。</p><p>    This one is simple, just need to get the information of how to use the API of your registrar.For gandi, we will use their cli  gandi and manage our zone in a plain text file.</p><p>这个很简单，只需要获取如何使用注册商的API的信息。对于甘迪，我们将使用他们的cli gandi，并以纯文本文件的形式管理我们的区域。</p><p>    @ 10800 IN SOA ns1.gandi.net. hostmaster.gandi.net. 1579092697 10800 3600 604800 10800@ 10800 IN A 195.154.119.61@ 10800 IN AAAA 2001:bc8:3d8f::cafe@ 10800 IN MX 1 mail.erebe.eu.@ 10800 IN MX 10 spool.mail.gandi.net.@ 10800 IN MX 50 fb.mail.gandi.net.api 10800 IN A 195.154.119.61api 10800 IN AAAA 2001:bc8:3d8f::cafe...</p><p>@10800在SOA ns1.gandi.net中。Hostmaster.gandi.net。1579092697 10800 3600 604800 10800@10800 in A 195.154.119.61@10800 in AAA2001：bc8：3d8f：：cae@10800 in MX 1 mail.erebe.eu.@10800 in MX 10 spool.mail.gandi.net@10800 in MX 50 fb.mail.gandi.net.api 10800 in A 195.154.119.61api 10800 in A 195.154.119.61api 10800 in AAA2001：bc8：3d8f：：cae。</p><p> Depending from your registrar, FAI and the TTL you set on your records, it can take quite some times for the new record to be propagated/updated everywhere, so be patient !</p><p>根据您的注册商、FAI和您在您的记录上设置的TTL，新记录可能需要相当长的时间才能传播/更新到任何地方，所以请耐心等待！</p><p>  We now have a server secured, with a domain name attached, and that we can re-deploy at ease.</p><p>我们现在有一个安全的服务器，附加了域名，我们可以轻松地重新部署。</p><p> The next step is to install Kubernetes on it. The choice of Kubernetes can be a bit controversial for only using it on a single machine. Kubernetes is a container orchestrator, so you can only leverage its full power when managing a fleet of servers.In addition, running vanilla Kubernetes require installing ETCD and other heavyweight components, plus some difficulties configuring every module for them to work correctly together.</p><p>下一步是在上面安装Kubernetes。选择Kubernetes可能会引起一些争议，因为它只在一台机器上使用。Kubernetes是一个容器协调器，所以您只能在管理一组服务器时充分利用它的能力。此外，运行vanilla Kubernetes需要安装etcd和其他重量级组件，以及配置每个模块的一些困难，以便它们能够正常工作。</p><p>  Meet  K3S, a trimmed and packaged Kubernetes cluster in a single binary. This prodigy is bought to us by rancher labs, one of the big player in the container operator world. They took the decision for you (replacing ETCD by SQLite, network overlay, load balancer, ...) in order for k3s to be the smaller possible and easy to setup, while being a 100% compliant Kubernetes cluster.</p><p>来看看K3S，它是一个经过修剪和打包的库伯内斯集群(Kubernetes Cluster)，包含在一个二进制文件中。这个奇迹是集装箱运营商世界上最大的参与者之一牧场主实验室买给我们的。他们为您做出了决定(将etcd替换为SQLite、网络覆盖、负载均衡器等)。为了使k3尽可能更小、更易于设置，同时又是100%兼容的Kubernetes集群。</p><p> The main benefit of having Kubernetes installed on my server, is that it allow me to have a standard interface for all my deployments, have everything store in git and allows me to leverage other tools like  skaffold when I am developing my projects.</p><p>在我的服务器上安装Kubernetes的主要好处是，它允许我为所有部署提供一个标准界面，将所有内容存储在Git中，并允许我在开发项目时利用其他工具，如skaffold。</p><p> Warning With everything installed, just having the Kubernetes server components running add a 10% CPU on my  Intel(R) Atom(TM) CPU C2338 @ 1.74GHz. So if you are already CPU bound, don&#39;t use it or scale up your server.</p><p>警告：安装完毕后，仅运行Kubernetes服务器组件就会在我的英特尔(R)Atom(TM)CPU C2338@1.74 GHz上增加10%的CPU。因此，如果您已经受CPU限制，请不要使用它或扩展您的服务器。</p><p>  kubernetes_install: ssh  ${HOST}   &#39;export INSTALL_K3S_EXEC=&#34; --no-deploy servicelb --no-deploy traefik --no-deploy local-storage&#34;; \  curl -sfL https://get.k3s.io | sh - &#39;</p><p>KUBNETES_INSTALL：ssh${HOST}&#39；EXPORT INSTALL_K3S_EXEC=&#34；--不部署服务b--不部署traefik--不-部署本地存储&#34；；\curl-sfl https://get.k3s.io|sh-&#39；</p><p>  servicelb Everything will live on the same machine, so there is no need to load balance, most of the time we are going to avoid the network overlay also, by using the host network directly as much as possible</p><p>Servicelb所有东西都将位于同一台计算机上，因此不需要进行负载平衡，大多数情况下，我们还将通过尽可能直接使用主机网络来避免网络覆盖。</p><p> traefik I have more experience with Nginx/HAProxy for reverse-proxy, so I am going to use nginx ingress controller in place of Traefik</p><p>Traefik我有更多使用nginx/HAProxy进行反向代理的经验，所以我打算使用nginx入口控制器来代替Traefik。</p><p> local-storage this application is for creating automatically local volume (PV) for your hosts, as we have only one machine, we will bypass this complexity and just use  HostPath volume</p><p>本地存储此应用程序用于自动为您的主机创建本地卷(PV)，因为我们只有一台计算机，我们将绕过这一复杂性，只使用HostPath卷</p><p>   and check that your server is in Ready state (it can take some time). If it is the case, congrats ! You have a Kubernetes control plane working !</p><p>并检查您的服务器是否处于就绪状态(可能需要一些时间)。如果是这样的话，恭喜你！你有一架库伯内斯控制机在工作！</p><p> Now that this is done, we need to automate the setup of the kubeconfig installation.</p><p>现在已经完成了这项工作，我们需要自动设置kubeconfig安装。</p><p> On your server copy the content of the kube config file  /etc/rancher/k3s/k3s.yaml and encrypt it with sops under  secrets/kubernetes-config.yml.  Be sure to Replace 127.0.0.1 in the config by the ip/domain name of your server.</p><p>在您的服务器上，复制Kube配置文件/etc/rancher/k3s/k3s.yaml的内容，并使用secrets/Kubernetes-config.yml下的sop对其进行加密。请确保将配置中的127.0.0.1替换为服务器的IP/域名。</p><p>   If you made things correctly and that you have kubectl installed on your local machine, you should be able to do a</p><p>如果您正确地进行了操作，并且在本地计算机上安装了kubectl，则应该能够执行以下操作。</p><p>    I have many small pet projects exposing an HTTP endpoint that I want to expose to the rest of the internet, as I have blocked every ingoing traffic other than for port 80 and 443, I need to multiplex every application under those two. For that I need to install a reverse proxy that will also do TLS termination.</p><p>我有许多喜欢的小项目，它们公开了一个我想要向Internet其余部分公开的HTTP端点，因为我已经阻止了端口80和443以外的所有传入流量，因此我需要多路传输这两个端口下的每个应用程序。为此，我需要安装一个反向代理，也将做TLS终止。</p><p> As I have disabled Traefik, the default reverse-proxy, during the k3s installation, I need to install my own. My choice went to Nginx. I know it well with HaProxy, knows it is reliable and it is the most mature between the two on Kubernetes.</p><p>由于我在k3s安装期间禁用了默认的反向代理Traefik，所以我需要安装我自己的。我选择了恩吉克斯。我非常了解HaProxy，知道它是可靠的，也是Kubernetes上两者中最成熟的。</p><p> To install it on your K3s cluster either use the Helm chart or directly with a kube apply. Refer for the installation guide for  baremetal</p><p>要将其安装到您的K3S集群上，可以使用Helm图表，也可以直接使用Kube应用。请参阅裸机安装指南。</p><p> WARNING: Don&#39;t copy-paste directly from the documentation nginx-ingress annotations, the &#39;-&#39; is not a real &#39;-&#39; and your annotation will not be recognized  🤦</p><p>警告：请勿直接从文档ngix-inress批注复制粘贴，该批注不是真正的批注，您的批注将无法识别🤦。</p><p>    I am going also to edit the deployment in order for the Nginx reverse proxy to use  HostNetwork and avoid going thought the network overlay.In the above YAML file, replace DNS policy value by  ClusterFirstWithHostNet and add a new entry  hostNetwork: true for the container to use directly your network card instead of a virtual interface.</p><p>我还将编辑部署，以便Nginx反向代理使用HostNetwork并避免通过网络覆盖。在上面的YAML文件中，将DNS策略值替换为ClusterFirstWithHostNet，并添加一个新条目hostNetwork：true，以便容器直接使用您的网卡而不是虚拟接口。</p><p>  If you are using the helm chart, there is a variable/flag to toggle the usage of host network.Save your YAML file in your repo</p><p>如果您使用的是舵图，则会有一个变量/标志来切换主机网络的使用情况。将YAML文件保存在您的资源库中。</p><p>......</p><p>.</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://github.com/erebe/personal-server/blob/master/README.md">https://github.com/erebe/personal-server/blob/master/README.md</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/2020/">#2020</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/管理/">#管理</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/personnal/">#personnal</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1033261.html"><img src="http://img2.diglog.com/img/2020/11/thumb_3757f085c3829baa1f2757fbabdda308.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033261.html">2020年民调惨败的原因很简单</a></div><span class="my_story_list_date">2020-11-5 20:0</span></div><div class="col-sm"><div><a target="_blank" href="/story/1033238.html"><img src="http://img2.diglog.com/img/2020/11/thumb_8558cc48d118c1527ddf864ef6921a02.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033238.html">
TC课程提供学生优惠券：Space 2020</a></div><span class="my_story_list_date">2020-11-5 17:24</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032986.html"><img src="http://img2.diglog.com/img/2020/11/thumb_b611b9f380586a2db7f0182f8e5a697b.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032986.html">
有没有合适的东西？在TC会议上展示和推介：Space 2020</a></div><span class="my_story_list_date">2020-11-3 23:31</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032983.html"><img src="http://img2.diglog.com/img/2020/11/thumb_a2cc3137e4ee29dcbb58282675d87469.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032983.html">
金融科技风险投资在2020年第三季度的4个收获</a></div><span class="my_story_list_date">2020-11-3 23:3</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>