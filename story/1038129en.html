<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>为什么我们从bcc-tools切换到libbpf-tools进行BPF性能分析 Why We Switched from bcc-tools to libbpf-tools for BPF Performance Analysis</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Why We Switched from bcc-tools to libbpf-tools for BPF Performance Analysis<br/>为什么我们从bcc-tools切换到libbpf-tools进行BPF性能分析 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-07 04:28:06</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/12/fd947fbbf3e284478aae1be18e4ad13e.jpg"><img src="http://img2.diglog.com/img/2020/12/fd947fbbf3e284478aae1be18e4ad13e.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Distributed clusters might encounter performance problems or unpredictable failures, especially when they are running in the cloud. Of all the kinds of failures, kernel failures may be the most difficult to analyze and simulate.</p><p>分布式集群可能会遇到性能问题或不可预测的故障，尤其是当它们在云中运行时。在所有类型的故障中，内核故障可能是最难分析和模拟的。</p><p> A practical solution is  Berkeley Packet Filter (BPF), a highly flexible, efficient virtual machine that runs in the Linux kernel. It allows bytecode to be safely executed in various hooks, which exist in a variety of Linux kernel subsystems. BPF is mainly used for networking, tracing, and security.</p><p> 实用的解决方案是Berkeley数据包筛选器（BPF），它是一种高度灵活，高效的虚拟机，可在Linux内核中运行。它允许字节码在各种钩子中安全执行，这些钩子存在于各种Linux内核子系统中。 BPF主要用于网络，跟踪和安全性。</p><p>  The  BPF Compiler Collection (BCC) toolkit offers many useful resources and examples to construct effective kernel tracing and manipulation programs. However, it has disadvantages.</p><p>  BPF编译器集合（BCC）工具包提供了许多有用的资源和示例，以构建有效的内核跟踪和操作程序。但是，它有缺点。</p><p> libbpf + BPF CO-RE (Compile Once – Run Everywhere) is a different development and deployment mode than the BCC framework.  It greatly reduces storage space and runtime overhead, which enables BPF to support more hardware environments, and it optimizes programmers&#39; development experience.</p><p> libbpf + BPF CO-RE（一次编译–随处运行）是与BCC框架不同的开发和部署模式。它大大减少了存储空间和运行时开销，这使BPF支持更多的硬件环境，并且优化了程序员。开发经验。</p><p> In this post, I&#39;ll describe why libbpf-tools, a collection of applications based on the libbpf + BPF CO-RE mode, is a better solution than bcc-tools and how we&#39;re using libbpf-tools at  PingCAP.</p><p> 在这篇文章中，我将介绍为什么libbpf-tools（一个基于libbpf + BPF CO-RE模式的应用程序集合）比bcc-tools更好的解决方案，以及我们如何在以下位置使用libbpf-tools PingCAP。</p><p>   BCC embeds LLVM or Clang to rewrite, compile, and load BPF programs. Although it does its best to simplify BPF developers&#39; work, it has these drawbacks:</p><p>   BCC嵌入LLVM或Clang来重写，编译和加载BPF程序。尽管它尽最大努力简化BPF开发人员。工作，它具有以下缺点：</p><p> It uses the Clang front-end to modify user-written BPF programs. When a problem occurs, it&#39;s difficult to find the problem and figure out a solution.</p><p> 它使用Clang前端来修改用户编写的BPF程序。出现问题时，很难找到问题并找出解决方案。 </p><p>  Because the libbcc library contains a huge LLVM or Clang library, when you use it, you might encounter some issues:</p><p>因为libbcc库包含一个庞大的LLVM或Clang库，所以在使用它时，可能会遇到一些问题：</p><p> When a tool starts, it takes many CPU and memory resources to compile the BPF program. If it runs on a server that lacks system resources, it might trigger a problem.</p><p> 工具启动时，需要很多CPU和内存资源来编译BPF程序。如果它在缺少系统资源的服务器上运行，则可能会引发问题。</p><p> BCC depends on kernel header packages, which you must install on each target host. If you need unexported content in the kernel, you must manually copy and paste the type definition into the BPF code.</p><p> BCC取决于内核标头程序包，您必须在每个目标主机上安装该程序包。如果内核中需要未导出的内容，则必须手动将类型定义复制并粘贴到BPF代码中。</p><p> Because BPF programs are compiled during runtime, many simple compilation errors can only be detected at runtime. This affects your development experience.</p><p> 由于BPF程序是在运行时编译的，因此许多简单的编译错误只能在运行时检测到。这会影响您的开发经验。</p><p>  When you implement BPF CO-RE, you can directly use the libbpf library provided by kernel developers to develop BPF programs. The development method is the same as writing ordinary C user-mode programs: one compilation generates a small binary file.</p><p>  实现BPF CO-RE时，可以直接使用内核开发人员提供的libbpf库来开发BPF程序。开发方法与编写普通的C用户模式程序相同：一个编译会生成一个小的二进制文件。</p><p> Libbpf acts like a BPF program loader and relocates, loads, and checks BPF programs. BPF developers only need to focus on the BPF programs&#39; correctness and performance.</p><p> Libbpf的行为类似于BPF程序加载器，并重新定位，加载和检查BPF程序。 BPF开发人员只需要关注BPF程序。正确性和性能。</p><p> This approach minimizes overhead and removes huge dependencies, which makes the overall development process smoother.</p><p> 这种方法最大程度地减少了开销并消除了巨大的依赖关系，从而使整个开发过程更加顺畅。 </p><p>   Performance optimization master  Brendan Gregg used libbpf + BPF CO-RE to convert a BCC tool and compared their performance data.  He said: &#34;As my colleague Jason pointed out,  the memory footprint of opensnoop as CO-RE is much lower than opensnoop.py.  9 Mbytes for CO-RE vs 80 Mbytes for Python.&#34;</p><p>性能优化大师Brendan Gregg使用libbpf + BPF CO-RE转换了BCC工具并比较了它们的性能数据。他说：＆＃34;正如我的同事Jason指出的那样，由于CO-RE，opensnoop的内存占用量远远低于opensnoop.py。 CO-RE为9 MB，而Python为80 MB。＆＃34;</p><p> According to his research, compared with BCC at runtime, libbpf + BPF CO-RE reduced memory overhead by nearly nine times, which greatly benefits servers with scarce physical memory.</p><p> 根据他的研究，与运行时的BCC相比，libbpf + BPF CO-RE将内存开销减少了近9倍，这为物理内存不足的服务器带来了极大的好处。</p><p>  At PingCAP, we&#39;ve been following BPF and its community development for a long time. In the past, every time we added a new machine, we had to install a set of BCC dependencies on it, which was troublesome. After  Andrii Nakryiko (the libbpf + BPF CO-RE project&#39;s leader) added the first libbpf-tools to the BCC project, we did our research and switched from bcc-tools to libbpf-tools. Fortunately, during the switch, we got guidance from him, Brendan, and  Yonghong Song (the BTF project&#39;s leader). We&#39;ve converted 18 BCC or bpftrace tools to  libbpf + BPF CO-RE, and we&#39;re using them in our company.</p><p>  在PingCAP，我们一直关注BPF及其社区的发展。过去，每次添加新计算机时，都必须在该计算机上安装一组BCC依赖项，这很麻烦。在Andrii Nakryiko（libbpf + BPF CO-RE项目的负责人）将第一个libbpf-tools添加到BCC项目之后，我们进行了研究，并从bcc-tools切换到libbpf-tools。幸运的是，在转换期间，我们得到了他，Brendan和Song Yonghong（BTF项目负责人）的指导。我们已经将18个BCC或bpftrace工具转换为libbpf + BPF CO-RE，并且在我们公司中正在使用它们。</p><p> For example, when we analyzed the I/O performance of a specific workload, we used multiple performance analysis tools at the block layer:</p><p> 例如，当我们分析特定工作负载的I / O性能时，我们在块层使用了多个性能分析工具：</p><p>  The analysis results helped us optimize I/O performance. We&#39;re also exploring whether the scheduler-related libbpf-tools are helpful for tuning the  TiDB database.</p><p>  分析结果帮助我们优化了I / O性能。我们还在探索与调度程序相关的libbpf工具是否对调整TiDB数据库有用。</p><p> These tools are universal: feel free to give them a try. In the future, we&#39;ll implement more tools based on libbpf-tools. If you&#39;d like to learn more about our experience with these tools, you can join the  TiDB community on Slack.</p><p> 这些工具具有通用性：请随时尝试。将来，我们将基于libbpf-tools实施更多工具。如果您想详细了解我们在这些工具上的经验，可以加入Slack上的TiDB社区。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://pingcap.com/blog/why-we-switched-from-bcc-tools-to-libbpf-tools-for-bpf-performance-analysis">https://pingcap.com/blog/why-we-switched-from-bcc-tools-to-libbpf-tools-for-bpf-performance-analysis</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/性能/">#性能</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/tools/">#tools</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/bpf/">#bpf</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>