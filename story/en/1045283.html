<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>松露上的Java –完全元循环 Java on Truffle – Going Fully Metacircular</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Java on Truffle – Going Fully Metacircular<br/>松露上的Java –完全元循环 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-20 12:15:37</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/1/1d055cb5fd0b7292877861b7e04c5c07.png"><img src="http://img2.diglog.com/img/2021/1/1d055cb5fd0b7292877861b7e04c5c07.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Up until now, GraalVM has offered two ways to run Java programs: using the Java HotSpot VM with the GraalVM JIT (just-in-time) compiler, and compiled to a native executable using GraalVM Native Image.</p><p>到目前为止，GraalVM提供了两种运行Java程序的方法：将Java HotSpot VM与GraalVM JIT（即时）编译器一起使用，以及使用GraalVM Native Image编译为本机可执行文件。</p><p>  Today, we’re happy to announce a new way to run Java on GraalVM. GraalVM 21.0 introduces a new installable component, named  espresso, which provides a JVM implementation written in Java.</p><p>  今天，我们很高兴地宣布一种在GraalVM上运行Java的新方法。 GraalVM 21.0引入了一个名为espresso的新可安装组件，该组件提供了用Java编写的JVM实现。</p><p>  Espresso makes it possible to run Java code via the Truffle framework elevating Java to the level of the other languages supported on GraalVM.</p><p>  Espresso可以通过Truffle框架运行Java代码，从而将Java提升到GraalVM支持的其他语言级别。</p><p>  Trying Java on Truffle out is extraordinary straightforward. It is available as a component installable into a base GraalVM distribution with a  gu command.</p><p>  在Truffle上尝试Java非常简单。它可以作为组件使用gu命令安装到基本GraalVM发行版中。</p><p>  After the installation to run your favorite app on Java on Truffle you just need to pass  -truffle to the  java command.</p><p>  安装后，可以在Truffle上的Java上运行您喜欢的应用程序，您只需将-truffle传递给java命令即可。</p><p>  Download Java on Truffle and give it a spin! There are  some example apps with the instructions that illustrate the particular capabilities of Java on Truffle.</p><p>  在Truffle上下载Java并尝试一下！有一些示例应用程序，其说明说明了Truffle上Java的特定功能。</p><p> Note that current raw performance of Java on Truffle isn’t representative of what it will be capable of in the near future. The peak performance is several times lower than running the same code in the usual JIT mode. The warmup also hasn’t been optimized yet. We focused in this initial release entirely on the functionality, compatibility, and making Java on Truffle open source available for a broader community.</p><p> 请注意，目前Truffle上Java的原始性能并不能代表其在不久的将来将具有的功能。峰值性能比通常的JIT模式下运行相同的代码要低好几倍。预热也尚未优化。在此初始发行版中，我们完全专注于功能，兼容性以及使Truffle上的Java开源可用于更广泛的社区。 </p><p> Expect performance, both warmup and peak performance to  increase rapidly in each of our upcoming 21.x releases.</p><p>在我们即将发布的每个21.x版本中，预期性能（预热和峰值性能）都会迅速提高。</p><p> Let’s now look in more details what Java on Truffle is, explore some notable use cases where it can help you, and try to place the project into the larger GraalVM and Java ecosystems.</p><p> 现在，让我们详细了解什么是Truffle上的Java，探索一些可以帮助您的著名用例，并尝试将项目放入更大的GraalVM和Java生态系统中。</p><p>  Java on Truffle is a JVM implemented using the Truffle language implementation framework. It provides all core components of a Java virtual machine:</p><p>  Truffle上的Java是使用Truffle语言实现框架实现的JVM。它提供了Java虚拟机的所有核心组件：</p><p>  A very important detail of this implementation is that it’s implemented in Java.  Java on Truffle is Java on Java! Self-hosting is the holy grail of Java virtual machine research and development.</p><p>  此实现的一个非常重要的细节是它是用Java实现的。松露上的Java是Java上的Java！自我托管是Java虚拟机研发的圣杯。</p><p> What it can do is run Java programs. Well, programs written in other JVM languages too of course. As you can see from the list above, it also supports the debug protocol, so you can debug Java applications using it too.</p><p> 它可以做的是运行Java程序。好吧，当然也可以使用其他JVM语言编写的程序。从上面的列表中可以看到，它还支持调试协议，因此您也可以使用它调试Java应用程序。</p><p> Java on Truffle is available for both Java 8 and Java 11 based GraalVM distributions, so technically you can use it as a replacement for the JVM of your choice. Java on Truffle is currently experimental and not very fast yet, so it is not recommended for production workloads today, but let’s explore what you  can get from running applications with Java on Truffle.</p><p> Truffle上的Java可用于基于Java 8和Java 11的GraalVM发行版，因此从技术上讲，您可以将其用作您选择的JVM的替代品。 Truffle上的Java目前仍处于试验阶段，还不是很快，因此不建议在今天的生产工作负载中使用，但让我们探索一下在Truffle上使用Java运行应用程序可以得到什么。</p><p>  As we mentioned previously Java on Truffle is implemented in Java. It’s a virtual machine implementation, so in order to actually run Java code it needs access to the class library and the native libraries and methods JDK provides. Java on Truffle reuses the JARs and native libraries from the GraalVM distribution.</p><p>  如前所述，松露上的Java是用Java实现的。这是一种虚拟机实施，因此，要真正运行Java代码，需要访问JDK提供的类库以及本机库和方法。松露上的Java重用了GraalVM发行版中的JAR和本机库。 </p><p>  Being implemented in Java and being able to run Java gives Java on Truffle a very interesting property: it can run itself. Indeed, Java on Truffle is a metacircular VM, it can run itself several levels deep (albeit slower and slower every time). There were previous efforts for achieving a practical Java on Java implementation,</p><p>用Java实现并能够运行Java使得Truffle上的Java具有非常有趣的特性：它可以自行运行。的确，Truffle上的Java是一个元循环VM，它可以在多个层次上运行（尽管每次运行的速度越来越慢）。以前曾尝试实现实用的Java on Java实现，</p><p> Being a Java program gives a number of advantages. One of them is ability to be compiled to the native executable with the native image, we’ll explore an interesting use case for that in the following chapter.</p><p> 成为Java程序有许多优点。其中一项功能是可以使用本机映像编译为本机可执行文件，我们将在下一章中探讨一个有趣的用例。</p><p> Another advantage is that the code is nice, familiar and understandable to Java developers. Consider going to the GitHub repository and looking at the source code for it. Your day-to-day tools work for it, your IDE supports it, you can explore the code base the same way you explore any other Java dependecies. This transparency and familiarity should allow Java on Truffle be efficient at rapidly changing to the better.</p><p> 另一个好处是该代码很好，对Java开发人员熟悉且易于理解。考虑进入GitHub存储库并查看其源代码。您的日常工具都可以使用它，IDE支持它，您可以像浏览其他Java依赖一样探索代码库。这种透明性和熟悉性应该使Truffle上的Java能够快速有效地变得更好。</p><p>  Java on Truffle is an actual JVM, and it’s also a Java program, which means you can run it within another Java program. This opens very interesting avenues for compartmentalisation of different components in your applications. For example, if you point Java on Truffle to a JDK11 distribution it can run Java 11. With access to Java 8, it becomes Java 8. When you have both distributions available, you can run Java on Truffle in the context of a Java 8 app and use it to run Java 11 byte code, and vice versa. If there’s a library that is only available for Java 8, you can migrate to a newer base JDK and still run that particular library, with some programmatic efforts to establish the interoperability, in the compatible JDK 8 within the same Java process.</p><p>  Truffle上的Java是实际的JVM，它也是一个Java程序，这意味着您可以在另一个Java程序中运行它。这为将应用程序中的不同组件分隔开了非常有趣的途径。例如，如果将Truffle上的Java指向JDK11发行版，则它可以运行Java11。访问Java 8时，它将变为Java8。当两个发行版都可用时，可以在Java 8的上下文中在Truffle上运行Java。应用程序并使用它来运行Java 11字节代码，反之亦然。如果有一个仅适用于Java 8的库，则您可以迁移到较新的基本JDK，并通过一些编程工作来在兼容的JDK 8中以相同的Java流程运行该特定库。</p><p>   Since Java on Truffle, Truffle, the GraalVM compiler and all other necessary components to run Java on Truffle efficiently are all written in Java, it is possible to build a native image executable with the infrastructure to run Java on Truffle.</p><p>   由于Truffle上的Java，Truffle，GraalVM编译器以及在Truffle上有效运行Java的所有其他必要组件都是用Java编写的，因此可以使用在Truffle上运行Java的基础结构来构建本机映像可执行文件。</p><p> This means that you can take a Java app, build a JVM into it, and then run that app either on a JVM or as a native image. Note that in the latter case, Java on Truffle can actually execute arbitrary Java code which doesn’t necessarily need to be known at the build time.</p><p> 这意味着您可以使用Java应用程序，在其中构建JVM，然后在JVM上或作为本机映像运行该应用程序。请注意，在后一种情况下，Truffle上的Java实际上可以执行任意Java代码，而这些Java代码在构建时不一定是必须的。</p><p> That’s right, Java on Truffle can bring the JIT compiler and the dynamic Java runtime to an ahead-of-time compiled binary.</p><p> 没错，Java on Truffle可以将JIT编译器和动态Java运行时带到预先编译的二进制文件中。 </p><p>  We’ve prepared a sample application to illustrate this concept. There’s a JShell implementation example that takes a normal JShell app, which consists of two separate parts: frontend CLI app and the backend computation engine, and replaces the latter with the Java on Truffle implementation.</p><p>我们准备了一个示例应用程序来说明此概念。有一个JShell实施示例，其中包含一个普通的JShell应用，该应用由两个独立的部分组成：前端CLI应用和后端计算引擎，并用Truffle上的Java替换后者。</p><p> It actually very neatly reuses all the classes from the original implementation by just loading them. So the original part of the sample application is the “glue” code that connects the host Java part to the Java on Truffle part of the app.</p><p> 实际上，通过加载它们，可以非常巧妙地重用原始实现中的所有类。因此，示例应用程序的原始部分是“胶水”代码，该代码将主机Java部分连接到应用程序的Truffle上的Java部分。</p><p> The sample can be compiled as a native executable, resulting in a nice binary that starts faster than the usual JShell because of the native executable performance characteristics and still can execute the Java code we throw at it.</p><p> 该示例可以作为本机可执行文件进行编译，由于本机可执行文件的性能特点，它可以以比正常JShell更快的速度启动一个不错的二进制文件，并且仍然可以执行我们扔给它的Java代码。</p><p> Here’s a screenshot of the Tetris game loaded and started from the JShell implemented with Java on Truffle.</p><p> 这是从在Truffle上使用Java实现的JShell加载并启动的俄罗斯方块游戏的屏幕截图。</p><p>  Mixing AOT and JIT is a fascinating option for applications that cannot leverage the native image performance improvements because their functionality depends on dynamic code which does not work easily with Native Image.</p><p>  对于无法利用本机映像性能改进的应用程序而言，将AOT和JIT混合是一种引人入胜的选择，因为它们的功能取决于动态代码，而动态代码不适用于本机映像。</p><p>  Another really cool feature where Java on Truffle is more powerful than HotSpot is the enhanced Hot Swap ability — changing classes at runtime during a debugging session.</p><p>  Truffle上的Java比HotSpot更强大的另一个非常酷的功能是增强的热交换功能-在调试会话期间在运行时更改类。</p><p>   What will make hot swap even more powerful is the ability to make changes to class fields. It’s in the works and will be added in a future release.</p><p>   使热插拔更加强大的是对类字段进行更改的能力。它正在开发中，并将在以后的版本中添加。 </p><p>  The setup is the same as with HotSpot: you start the debugger, change the code, recompile the class, hit “Reload the classes” in your IDE debugger and resume the program with the new code running next time the changed class is used.</p><p>设置与HotSpot相同：启动调试器，更改代码，重新编译类，在IDE调试器中单击“重新加载类”，并在下次使用更改后的类时使用新代码恢复程序。</p><p>  Java on Truffle benefits out of the box from the developer tooling support that GraalVM languages get from the Truffle framework.</p><p>  Truffle上的Java受益于GraalVM语言从Truffle框架获得的开发人员工具支持。</p><p> For example, you can run your application with some  java -truffle --cpusampler and have the sampling profiler run on your code. You can enable the tracing profiler or memory tracer to tell you which parts of the code generate more memory pressure than others.</p><p> 例如，您可以使用一些java -truffle --cpusampler运行应用程序，并在代码上运行采样分析器。您可以启用跟踪分析器或内存跟踪器，以告诉您代码的哪些部分比其他部分产生更多的内存压力。</p><p> Another facet of the ecosystem is the supported languages. Java on Truffle allows you to create polyglot programs where different components are written in different languages. The details about how to load code written in other languages, export and import objects between languages, and so on are a little bit more involved than the scope of the current article, but details can be found  from the docs.</p><p> 生态系统的另一个方面是受支持的语言。松露上的Java允许您创建以多种语言编写不同组件的多语言程序。与如何加载用其他语言编写的代码，在语言之间导出和导入对象等有关的细节比当前文章的范围要复杂得多，但是可以从文档中找到细节。</p><p>  GraalVM 21.0 is the initial release of Java on Truffle. It’s an experimental component right now and there are major improvements planned for it in upcoming releases.</p><p>  GraalVM 21.0是Truffle上Java的初始版本。目前，这是一个实验性组件，计划在即将发布的版本中对其进行重大改进。</p><p> There are many things to improve, from supporting javaagents, to having a better implementation of the interop protocol with other languages, major performance improvements, and so on.</p><p> 从支持javaagents到使用其他语言更好地实现interop协议，改进主要性能等等，有许多事情需要改进。</p><p> We’ll be working on these and other improvement, and would be absolutely thrilled to hear any and all feedback, feature requests, potential use cases, discovered issues, and shortcomings of the current version. You can share your feedback via  Slack,  GitHub, or  Twitter. To get started, head to  graalvm.org/java-on-truffle.</p><p> 我们将努力进行这些改进和其他改进，并且非常高兴听到所有反馈，功能请求，潜在用例，发现的问题以及当前版本的缺点。您可以通过Slack，GitHub或Twitter分享您的反馈。首先，请访问graalvm.org/java-on-truffle。 </p><p> Java on Truffle is a new and very exciting way to run your Java code. Take a look and consider the possibilities!</p><p>松露上的Java是一种运行Java代码的非常令人兴奋的新方法。 看看并考虑可能性！ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://medium.com/graalvm/java-on-truffle-going-fully-metacircular-215531e3f840">https://medium.com/graalvm/java-on-truffle-going-fully-metacircular-215531e3f840</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/java/">#java</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/松露/">#松露</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/truffle/">#truffle</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>