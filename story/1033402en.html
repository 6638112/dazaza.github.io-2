<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>不管你说什么我都是</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">不管你说什么我都是</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-06 07:19:47</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/11/79b7febd50e9beb0254ae7c59326f8f3.png"><img src="http://img2.diglog.com/img/2020/11/79b7febd50e9beb0254ae7c59326f8f3.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Last year in March (this was 2019 in case you forgot; doesn’t that feel like forever ago?), we open sourced  Cartography, our Python tool that consolidates technical assets and the relationships between them in a graph database.</p><p>去年3月(如果你忘了，这是2019年，感觉不是很久以前了吗？)，我们开放了源码地图，这是我们的Python工具，将技术资产和它们之间的关系整合到一个图形数据库中。</p><p>  Using graphs helps us visualize and reason about security problems in a very powerful way. One such problem is understanding cloud permissions relationships: we needed an answer to the question “who has permission to read and write to my sensitive data resources?”</p><p>使用图形帮助我们以一种非常强大的方式可视化和推理安全问题。其中一个问题是理解云权限关系：我们需要一个问题的答案：“谁有权读写我的敏感数据资源？”</p><p>   Lyft is an  AWS shop, and AWS’ access control mechanism is called  IAM. It determines which  Principals (e.g. users, groups, and roles) may perform which  Actions on which  Resources(e.g. storage buckets, compute instances, etc). IAM is powerful, highly customizable, and can work across account boundaries. IAM can be easy to configure incorrectly, and mistakes here can enable adversaries to easily move around and perform malicious actions in your environment.</p><p>Lyft是一家AWS商店，AWS的访问控制机制被称为IAM。它确定哪些主体(例如，用户、组和角色)可以对哪些资源(例如，存储桶、计算实例等)执行哪些操作。IAM功能强大、高度可定制，可以跨账户边界工作。IAM很容易配置不正确，这里的错误会使攻击者很容易在您的环境中四处移动并执行恶意操作。</p><p>   AWS roles, users, and groups have policies attached to them, which determine the  Actions they are allowed to perform or not perform against a defined set of  Resources. IAM can get very complicated: you can specify advanced clauses like  NotAction (which determine what a  Resource can’t do) or  NotResource (which determine the resources this statement does not apply to). Further, you can use the  * character to have a policy apply to objects that match a given text string. A principal’s resulting access is determined by all the policy statements mapped to it.</p><p>AWS角色、用户和组都附加了策略，这些策略决定了允许他们对一组定义的资源执行或不执行的操作。IAM可能会变得非常复杂：您可以指定高级子句，如NotAction(确定资源不能做什么)或NotResource(确定此语句不适用于哪些资源)。此外，您可以使用*字符将策略应用于与给定文本字符串匹配的对象。主体的最终访问权限由映射到该主体的所有策略语句确定。</p><p> As a motivating example, we wanted to quickly see which principals had root or “root-like” privileges in our environment. An IAM policy like this allows the equivalent of root privileges to all principals it is attached to because it allows any action to be performed on any resource:</p><p>作为一个鼓舞人心的例子，我们希望快速了解哪些主体在我们的环境中拥有根权限或“类似根”权限。这样的IAM策略允许它附加到的所有主体具有等同的超级用户权限，因为它允许在任何资源上执行任何操作：</p><p>  Cartography uses a Neo4j graph database, so we can use this query to search for these principals:</p><p>地图学使用Neo4j图形数据库，因此我们可以使用以下查询来搜索以下原则：</p><p> MATCH (stat:AWSPolicyStatement)--(pol:AWSPolicy)--(principal:AWSPrincipal) WHERE stat.effect = &#34;Allow&#34; AND any(x IN stat.resource WHERE x=&#34;*&#34;) AND any(x IN stat.action WHERE x=&#34;*&#34; ) RETURN *</p><p>匹配(stat:AWSPolicyStatement)--(pol:AWSPolicy)--(principal:AWSPrincipal)WHERE STAT.EFECT=&#34；ALLOW&#34；ANY(x IN stat.resource WHERE x=&#34；*&#34；)和ANY(x IN stat.action WHERE x=&#34；*&#34；)返回*。</p><p> If you stare at the query long enough, it makes sense: we look for  PolicyStatements that are attached to  AWSPolicy nodes that are attached to  AWSPrincipals where  * is set as both a  Resource and an  Action.</p><p>如果您查看查询的时间足够长，就会发现这是有意义的：我们查找附加到AWSPolicy节点的PolicyStatement，这些节点附加到AWSPrincipals，其中*既设置为Resource又设置为Action。</p><p> The result can look something like this. If you try this yourself, you might be in for an unpleasant surprise if you aren’t expecting  any principals to be highly privileged:</p><p>结果可能如下所示。如果你自己试一试，如果你不指望任何校长享有高度特权，你可能会遇到一个令人不快的惊喜：</p><p>  It’s great that we have the data, but it’s cumbersome to need to remember all the  rules of IAM policy evaluation to answer this question. It would save us a lot of time to be able to simply ask “who has permission to read from my storage buckets?” or “who has permission to run queries on my DynamoDB tables?”</p><p>我们有数据很好，但要回答这个问题，需要记住IAM政策评估的所有规则是很麻烦的。如果我们能够简单地问“谁有权从我的存储桶中读取数据”，这将为我们节省大量时间。或“谁有权在我的DynamoDB表上运行查询？”</p><p> Resource Permission Relationships: Using the graph to evaluate a principal’s resulting accesses offline</p><p>资源权限关系：使用图表评估主体脱机访问的结果。</p><p> With all of this data in the graph, earlier in April of this year we thought that it’d be a great idea to evaluate IAM policies offline so that we could determine a given principal’s resulting accesses (for those familiar with Windows security, this calculation might remind you a bit of  RSOP). We called this feature Resource Permission Relationships.</p><p>有了图表中的所有这些数据，在今年4月初，我们认为离线评估IAM策略是个好主意，这样我们就可以确定给定主体的最终访问权限(对于熟悉Windows安全的人来说，这个计算可能会让您想起RSOP)。我们将此功能称为资源权限关系。</p><p>   As seen above, our plan was for Cartography to automatically map AWS principals to the resources that they can access! These mappings would be specified in a  permission_relationships.yaml file, and you can read how to configure this  here. To understand how this works, we’ll walk you through the above picture’s CAN_READ example:</p><p>如上所述，我们的计划是让地图绘制自动将AWS主体映射到他们可以访问的资源！这些映射将在PERMISSION_Relationship s.yaml文件中指定，您可以在此处阅读如何进行配置。为了理解它的工作原理，我们将向您介绍上图中的can_read示例：</p><p> Cartography will search all AWSPolicyStatement nodes that allow the  S3:GetObject permission and find all  AWSPrincipal nodes attached to these statements. Cartography also verifies that no other  AWSPolicyStatement nodes  deny the  S3:GetObject permission.</p><p>制图将搜索所有允许S3：GetObject权限的AWSPolicyStatement节点，并查找附加到这些语句的所有AWSPrincipal节点。制图还会验证是否没有其他AWSPolicyStatement节点拒绝S3：GetObject权限。</p><p> Then, Cartography will search for all  S3Bucket nodes in the current AWS account (since  ResourceType is specified as  S3Bucket above) and draw a graph edge labeled  CAN_READ from the  AWSPrincipal to the  S3Bucket.</p><p>然后，地图绘制将搜索当前AWS帐户中的所有S3Bucket节点(因为上面将ResourceType指定为S3Bucket)，并从AWSPrincipal到S3Bucket绘制一条标记为Can_Read的图形边。</p><p> In summary, we have taken the path (:AWSPrincipal)--&gt;(:AWSPolicy)--&gt;(:AWSPolicyStatement{effect:&#34;Allow&#34;, resource:&#34;s3&#34;, Action:&#34;S3:GetObject&#34;}), evaluated it against  S3Bucket nodes, and simplified it to draw an edge from the principal to the S3 bucket like this:  (:AWSPrincipal)-[:CAN_READ]-&gt;(:S3Bucket). The questions “what does this principal have permission to do?” and “who has access to my resource?” can now be queried at scale as they are precomputed and stored in the graph.</p><p>总之，我们采用了路径(：AWSPrincipal)--&gt；(：AWSPolicy)--&gt；(：AWSPolicyStatement{effect：&#34；Allow&#34；，资源：&#34；S3&34；，操作：&#34；S3：GetObject&#34；})，根据S3Bucket节点对其进行评估，并将其简化为绘制从主体到S3存储桶的边，如下所示：(：AWSPrincipal)-[：Can_Read]-&gt；(：S3Bucket)。问题是“这个校长被允许做什么？”以及“谁有权访问我的资源？”现在可以按比例查询，因为它们是预先计算并存储在图表中的。</p><p> Let’s verify who has read or write privileges to a sensitive s3 bucket:</p><p>让我们验证一下谁对敏感的S3存储桶拥有读或写权限：</p><p>    Since group expansion has already been calculated, this is the resulting set of roles and users that can access the sensitive S3 bucket. Only identity-based policies are evaluated at the moment, we plan to add resource policies in a future update.</p><p>由于已经计算了组扩展，因此这是可以访问敏感S3存储桶的角色和用户的结果集。目前只评估基于身份的策略，我们计划在未来的更新中添加资源策略。</p><p> Finding out an individual user has access to is also simple, as Cartography syncs Okta identity data:</p><p>查找个人用户有权访问也很简单，因为地图会同步Okta身份数据：</p><p>   You can also query for aggregate data over your entire graph. For example, who in your organization has access to the greatest number of S3 buckets?</p><p>您还可以查询整个图表上的聚合数据。例如，您的组织中谁可以访问最多数量的S3存储桶？</p><p>   At the time of development, we knew of other great open-source projects that dealt with IAM like  policyuniverse and  Cloudsplaining, but we did not know of anything that performed offline evaluation in the way we wanted. We found that the closest project to our idea was NCC Group’s  PMapper (neat!), but PMapper focuses on returning a single query answer and doesn’t yield as much of a full, explorable picture to the extent that Cartography does. There are more benefits to having this logic in Cartography itself, which we will cover in the next scenario.</p><p>在开发时，我们知道还有其他与IAM打交道的伟大开源项目，比如Policy Universal和CloudSplaining，但我们还不知道有什么项目能以我们想要的方式进行离线评估。我们发现，与我们的想法最接近的项目是NCC Group的PMapper(太棒了！)，但是PMapper专注于返回单个查询答案，并不能像地图绘制那样生成完整的、可探索的图片。在地图学本身拥有这一逻辑还有更多的好处，我们将在下一个场景中讨论这一点。</p><p>  You might have noticed that we only included 3 RPRs in the previous section regarding S3 buckets and DynamoDB tables, and you might be wondering why we didn’t perform this policy expansion logic for all principals and for all resources so that the graph would be as complete as possible. This is infeasible because AWS has  a lot of built-in IAM policies that may not even apply to any principals in your environment. Running this calculation for everything is wasteful so we opted instead to include some sample RPRs in the default  permission_relationships.yaml file and allow you to customize this to your needs. You can copy the process described in the next section to do this.</p><p>您可能已经注意到，在上一节中关于S3存储桶和DynamoDB表，我们只包括了3个RPR，您可能想知道为什么我们没有为所有主体和所有资源执行此策略扩展逻辑，以便图表尽可能完整。这是不可行的，因为AWS有很多内置的IAM策略，这些策略甚至可能不适用于您环境中的任何主体。对所有内容运行此计算都是浪费的，因此我们选择在默认的permission_relationship s.yaml文件中包含一些样例RPR，并允许您根据需要对其进行定制。您可以复制下一节中描述的流程来执行此操作。</p><p>  More recently, we had a task to monitor the IAM principals that have admin access to AWS  Redshift instances. This was a simple 6 line change to our  permission_relationships.yaml file (and you can see the PR  here):</p><p>最近，我们有一项任务是监控对AWS RedShift实例具有管理员访问权限的IAM主体。这是对Permisse_relationship s.yaml文件的6行简单更改(您可以在此处看到PR)：</p><p>  This short config searches the graph for policy statements that allow any one of the four above actions ( redshift:*,  redshift:CreateClusterUser, etc). Then, we find which AWS principals in the current account are attached to these statements. Finally, we draw a link from each principal to all  RedshiftCluster nodes in the current account of the form  (:AWSPrincipal)-[:CAN_ADMINISTER]-&gt;(:RedshiftCluster).</p><p>此简短配置在图表中搜索允许上述四种操作(redShift：*、redShift：CreateClusterUser等)中任何一种的策略语句。然后，我们会找出当前帐户中的哪些AWS主体附加到这些声明中。最后，我们在(：AWSPrincipal)-[：CAN_ADMINISTER]-&gt；(：RedshiftCluster).形式的当前帐户中绘制一个从每个主体到所有RedShitClusters节点的链接</p><p> Our rationale here is that if an identity is able to perform any one of those four actions on a Redshift cluster, then we consider that a so-called “Redshift admin” and we want to draw a relationship from the identity to the cluster so that we can quickly query for them.</p><p>我们在这里的基本原理是，如果一个身份能够在RedShift集群上执行这四个操作中的任何一个，那么我们将其视为所谓的“RedShift管理员”，并且我们希望从该身份到该集群绘制一个关系，以便我们可以快速地查询它们。</p><p> The result looks like this where the yellow  AWSGroup below has the  redshift:* action attached to it, which allows it to perform any action on all Redshift clusters.</p><p>结果如下所示，下面的黄色AWSGroup附加了redShift：*操作，这允许它在所有RedShift集群上执行任何操作。</p><p>  You can draw your own resource permission relationships by copying our examples to your own yaml file and specifying its absolute path in the Cartography command-line interface’s  --permission-relationships-file argument.</p><p>您可以绘制自己的资源权限关系，方法是将我们的示例复制到您自己的YAML文件中，并在地图命令行界面的--permission-relationship-file参数中指定其绝对路径。</p><p>  We have established mappings from AWS principal to sensitive Redshift resources, but as mentioned above in our  Related Work section, this is still slightly duplicative of PMapper’s functionality. Why even build this into Cartography?</p><p>我们已经建立了从AWS主体到敏感红移资源的映射，但正如上面我们的相关工作部分所提到的，这仍然与PMapper的功能略有重复。为什么要把这个融入制图学呢？</p><p> Now that we have enriched the IAM data in the graph, we can use Cartography’s  Drift Detection feature to let us know via Slack alerts whenever the list of Redshift admins changes, and that we should investigate why this list changed. We’ll blog on the details of Drift Detection in a future post if there’s interest (and once we dig ourselves out from under of the pile of other wonderful ideas we want to build), but as a teaser, the result looks like this:</p><p>现在我们已经丰富了图表中的IAM数据，我们可以使用地图的漂移检测功能，在RedShift管理员列表发生变化时通过松弛警报通知我们，我们应该调查该列表发生变化的原因。如果有兴趣的话，我们会在未来的一篇博文中介绍漂移探测的细节(一旦我们从我们想要构建的其他奇妙想法中脱颖而出)，但作为一个预告片，结果看起来是这样的：</p><p>   We’ve shared Cartography at  several  security  conferences over our first year and a half as an open source project, but this is the first time that we’ve blogged about it here on the Lyft Engineering blog. The problem of understanding IAM permissions lends itself well to a graph-based solution, and we’re just scratching the surface of what we have planned.</p><p>在我们作为开源项目的头一年半时间里，我们已经在几个安全会议上分享了地图绘制，但这是我们第一次在Lyft Engineering博客上发布关于它的博客。理解IAM权限的问题很适合于基于图形的解决方案，而我们只是触及了计划的皮毛。</p><p> There are lots of ideas we have around engineering a  more reliable data  sync,  speeding up the sync process, making our plugin framework  even more newcomer-friendly, and making the data  useful for more people. More than just providing data, we’re excited about using the graph for both  offensive and  defensive automated actions: imagine having a robot army running around your environment using the graph as a map and fixing all the security problems that it finds. There are many possibilities to use this idea to its full potential and we look forward to building out this platform together with the open source infosec community.</p><p>我们有很多想法来设计一个更可靠的数据同步，加快同步过程，让我们的插件框架对新手更加友好，让数据对更多的人有用。除了提供数据，我们对使用图表进行攻击性和防御性自动化操作感到兴奋：想象一下，有一支机器人大军在你的环境中运行，使用图表作为地图，并修复它发现的所有安全问题。有很多可能性可以充分利用这个想法，我们期待着与开源信息安全社区一起构建这个平台。</p><p> We hope that you’ve found this post informative and that you feel inspired to check out our tool at  https://github.com/lyft/cartography.</p><p>我们希望您能发现这篇文章内容丰富，并希望您受到启发，在https://github.com/lyft/cartography.上查看我们的工具</p><p> If you have questions or want to reach out, please say hi in channel #cartography on the  Lyft OSS Slack or at our monthly public  community meeting.</p><p>如果您有问题或想联系我们，请在Lyft OSS Slack上的#制图频道或在我们每月的公共社区会议上打个招呼。</p><p> Join us building open source tools to solve security problems at scale;  Lyft Security   is hiring !</p><p>加入我们的行列，构建开源工具来大规模解决安全问题；Lyft Security正在招聘！</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://eng.lyft.com/iam-whatever-you-say-iam-febce59d1e3b">https://eng.lyft.com/iam-whatever-you-say-iam-febce59d1e3b</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/iam/">#iam</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/资源/">#资源</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>