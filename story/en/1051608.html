<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>netaddr.ip：Go的新IP地址类型 Netaddr.ip: a new IP address type for Go</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Netaddr.ip: a new IP address type for Go<br/>netaddr.ip：Go的新IP地址类型 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-11 06:11:43</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/3/ea1865f54c8d4d8aaf0a14292b37ffd9.png"><img src="http://img2.diglog.com/img/2021/3/ea1865f54c8d4d8aaf0a14292b37ffd9.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Tailscale is a networking application so naturally we need to work withand manipulate IP addresses and sets of IP addresses often.</p><p>TailScale是一个网络应用程序，所以自然地我们需要使用和经常使用操作IP地址和IP地址集。</p><p> Being written almost entirely in  Go, the obvious choice would be forTailscale to use the Go standard library’s  net.IP address type for individualIPs and   net.IPNet type fornetworks. Unfortunately, the standard library’s types have a number ofproblems, so we wrote a new package,   inet.af/netaddr ( github) containing a new IP type and  more.</p><p> 几乎完全完全编写，明显的选择将是FortailScale使用Go Standard Library的Net.IP地址类型for Idenderips和net.ipnet类型fornetworks。不幸的是，标准库的类型具有多个问题，因此我们编写了一个新的软件包，Inet.af/netaddr（github），包含新的IP类型等。</p><p>  When I was working on Go full time, I filed Go issue #18804 to track somethings that aren’t great about Go’s IP address:</p><p>  当我在全职工作时，我提交了问题＃18804以跟踪Go的IP地址不太好的话：</p><p> It’s mutable. The   underlyingtype of a  net.IP is just a []byte, which means anything you pass it to might mutateit. Immutable data structures are safer, easier to reason about, anddon’t require defensive copies.</p><p> 它是可变的。 net.ip的下面的界限只是一个[]字节，这意味着你将它传递到可能会变动。不变的数据结构更安全，更容易理解，并且不需要防御副本。</p><p> It’s not  comparablebecause a slice in Go is not comparable, which means it doesn’tsupport Go’s  == operator and can’t be used as a map key.</p><p> 因为Go的切片没有比较，这意味着它尚未展示Go's ==运算符，并且不能用作地图键。</p><p> There are two IP address types in the standard library:  net.IP for justa basic IPv4 or IPv6 address, and then also net.IPAddr if you need to support IPv6 zone scopes.Having two types in the standard library means youneed to decide which type to accept or return from your code, orhave two+ variants, which gets annoying (e.g. Go’s   Resolver.LookupIPvs   Resolver.LookupIPAddr)</p><p> 标准库中有两个IP地址类型：Net.IP for Justa Basic IPv4或IPv6地址，然后也是Net.IPADDR，如果需要支持IPv6区域范围。在标准库中有两种类型意味着您是您确定哪种类型要接受或从代码中返回，或返回两个+变体，这会变得烦人（例如Go的Resolver.Lookupvvs Resolver.LookupIPAddr）</p><p> It’s large. A Go slice is 3 words (so 24 bytes total on 64-bitmachines) just for the slice header, without counting the underlyingarray that the slice points to ( background).So an IP address with Go’s  net.IP istwo parts: the 24 byte slice header, and then also the 4 or 16 bytesof IP address. If you want an IPv6 zone, you have to use  net.IPAddr witha 16 byte string header also.</p><p> 它很大。对于切片标题，Go Slice是3个单词（SO 24字节上总共24个字节），而不为切片标题计算切片指向（背景）的下面的arrayArtay。所以具有Go的Net.ip Istwo部分的IP地址：24字节切片标题，然后也是4或16字节的IP地址。如果您想要IPv6区域，还必须使用Net.IPADDR与16字节字符串标头。 </p><p> It allocates,  #43451. Go’s net package is full of allocations everywhere,putting more work on the GC and thus the CPU. If you call net.ParseIP or receive a UDP packet, it needs to allocate theunderlying array where it records the IP address, to put thatpointer in the returned slice header of the  net.IP.</p><p>它分配了，＃43451。 Go's Net Package在任何地方都充满了分配，在GC上进行了更多的工作，从而为CPU提供了更多的工作。如果您调用net.parseip或接收UDP数据包，则需要在它记录IP地址的情况下分配underingling array，以将该点放入返回的net.ip的标题中。</p><p> When parsing an IP from its string form, Go’s IP type  can’tdistinguish between IPv4-mapped IPv6addressesand IPv4 addresses. The Go IP type doesn’t record the original address family.This is tracked in Go issue  #37921.</p><p> 从其字符串表单解析IP时，Go的IP类型无法在IPv4映射的IPv6AddressesAnd IPv4地址之间无法区分。 Go IP类型不会记录原始地址族。在Go问题中跟踪该问题＃37921。</p><p> It’s a transparent type. The definition of  net.IP is:  type IP []byte,which means its   underlying type is a byte slice,which is part of its public API and unchangeable. By contrast, Go’s  time.Time type is defined like  type Time struct { /* unexported */ }so it’s free to change without breaking API promises. In fact, Go’s  Time did changeits representation recently in Go 1.9 when it gained transparent monotonic time support.That would not have been possible if the type weren’t opaque.As some trivia: the Go  Time  used to be transparent prior to Go 1.Unfortunately we weren’t wise enough at the time to do the samefor the IP address type.</p><p> 这是一种透明的类型。 net.ip的定义是：类型ip []字节，这意味着它的底层类型是一个字节切片，它是其公共API的一部分和不可改变。相比之下，GO的时间。时间类型是定义的，如类型时间结构{/ *未被驱动* /}，因此在不破坏API承诺的情况下可以自由更改。事实上，Go的时间是最近在1.9获得透明单调时间支持时更新的时间。如果类型没有透明，则不会成为可能。一些琐事：在GO之前过去常常是透明的。遗憾的是，我们在IP地址类型的情况下不够努力。</p><p> Some of this was by design at the time, before Go 1 locked in the compatibility promise in 2012, butmuch of it was just never considered well or predated enoughexperience with Go to learn what patterns worked well and whichdidn’t. In any case, the Go standard library can’t change much now.</p><p> 其中一些是当时的设计，前1锁在2012年的兼容性承诺之前，它的兼容性刚刚被认为是嗯或达到足够的经验，并通过去了解哪些模式效果很好，没有。在任何情况下，Go标准库现在无法更改。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://tailscale.com/blog/netaddr-new-ip-type-for-go/">https://tailscale.com/blog/netaddr-new-ip-type-for-go/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/ip/">#ip</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/address/">#address</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/类型/">#类型</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>