<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>GO接口走私扩展API对中间件的影响</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">GO接口走私扩展API对中间件的影响</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-11 15:34:12</div><div class="page_narrow text-break page_content"><p>最近，Go博客“保持你的模块兼容”(Keep Your Modules Compatible)就是在你添加功能并想要扩展你模块的API时这样做的。当模块的API涉及接口时，他们建议的方法之一是我所说的接口混杂和其他人所说的接口升级。让我引述这篇文章：</p><p>当您遇到想要向现有接口添加方法的情况时，或许可以遵循此策略。从使用新方法创建新接口开始，或使用新方法标识现有接口。接下来，确定需要支持它的相关功能，为第二个接口键入check，并添加使用它的代码。</p><p>这是一种相当流行的方法，Go&#s标准库和第三方软件包中的许多软件包都使用这种方法。然而，它也有阴暗面，那就是它对中间件的不幸影响。</p><p>最常见的一种中间件最能说明中间件的问题，它是插在http处理程序链中以修改结果的东西。很多中间件希望查看或处理HTTP回复的某些方面，例如根据结果代码收集度量，这意味着它必须修改和代理传递给子http.Handler的http.ResponseWriter。随着时间的推移，http包已经在ResponseWriters上获得了一整个走私接口集合，例如http.CloseNotifier(已弃用)、http.Flusher、http.Hijacker和http.Pusher。在未来，可能会有更多。</p><p>如果您是一个中间件，则您重新传递的ResponseWriter可能支持一些、许多或所有这些附加API。但是，Go并不提供通过proxyResponseWriter传递此支持的好方法，您将把它传递给子处理程序。不管怎样，普罗米修斯人都很努力地去做，结果是相当混乱的，涉及到API的可能组合的组合爆炸。如io.ReaderFrom所示，这些额外的APIsdon甚至不一定来自http包。可能需要支持来自任何地方的自鸣得意的接口。</p><p>对此问题的一个答案是，您只是不在您的中间件中支持这些额外的API，或者您只支持其中的几个。这样做的问题是，人们试图很好地使用您的中间件的ResponseWriter和客户端代码都是在使用这些扩展的API的环境中开发、测试和正常使用的，而不是被切断。我们都知道，如果你不测试它，它是不会起作用的。您的中间件可能是第一个尝试使用真正狭窄的API传递下一跳ResponseWriter的代码，因为这种狭窄的API可能大多来自中间件。当然，如果结果中有任何错误，人们会指责您的中间件。</p><p>所有这些都不是不可逾越的。但是，撇开问题和麻烦不谈，这意味着如果人们使用中间件来扩展API，那么通过走私接口来扩展API肯定是不透明的。这是一个实际问题，您的新API在一定时间内将无法使用，直到中间件被扩展以应对它(如果它曾经可以使用的话)。</p><p>另一个问题是，在您的新API本身普及之前，这种为应对新API而进行的中间件扩展不会发生。GO目前不支持基于其他包的版本或其API的状态进行条件构建，因此中间件不能包含对新API接口的任何使用，除非它必须针对早于新API接口的包版本进行构建。</p><p>(人们可以在HTTP中间件上解决这个问题，因为他们只能在Go的特定最低版本上构建文件。您的软件包没有这种神奇的功能；它只适用于Go标准库中的新API。)。</p><p>因为这并不是什么新鲜事，这个问题早在2014年围棋的界面升级中就被注意到了，它是最早将这种模式称为界面升级的地方之一。本文注意到了代理问题，并以一个Call结尾，该调用要求节约使用接口升级。在我看来，这是一个很好的建议，但与通常使用界面升级来扩展API的想法非常不同。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://utcc.utoronto.ca/~cks/space/blog/programming/GoMiddlewareVsInterfaceSmuggling">https://utcc.utoronto.ca/~cks/space/blog/programming/GoMiddlewareVsInterfaceSmuggling</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/走私/">#走私</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/http/">#http</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>