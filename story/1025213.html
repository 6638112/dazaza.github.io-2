<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Tarsnap-清理旧备份</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Tarsnap-清理旧备份</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-21 02:51:10</div><div class="page_narrow text-break page_content"><p>我使用Tarsnap存储我的关键数据。例如，我使用它来备份我的bacula数据库转储。我用巴库拉来备份我的主人。有问题的数据库跟踪从哪台主机备份的内容、文件大小、校验和、备份现在的位置以及许多其他项目。丢失这些数据令人恼火，但不是灾难。可以从备份卷重新创建，但这很耗时。实际上，每天都会转储该文件，并将其重新同步到多个位置。</p><p>我还通过Tarsnap每天备份该数据库。我至少从2015-10-09就开始这么做了。</p><p>这是Tarsnap重复数据消除和压缩的一个很好的示例。我有5年的备份，只占96G，最新的备份是113G。</p><p>我对那个Bacula配置档案很好奇。巴库拉配置只有600K左右：</p><p>检查该计算机的存档列表，我发现2015年10月初有6个数据库备份。</p><p>#tarsnap-d-f bacula.int.BaculaDatabase.2015-10-02总大小压缩大小所有档案196056412740 57482749453(唯一数据)50147278933 14694175940此档案48831544077 14324291125已删除数据2073099 1672760#。</p><p>[Dan@bacula：~]$sudo tarsnap-d\&gt；-f bacula.int.BaculaDatabase.2015-10-03\&gt；-f bacula.int.BaculaDatabase.2015-10-05\&gt；-f bacula.int.BaculaDatabase.2015-10-06\&gt；-f bacula.int.BaculaDatabase.2015-10-07\&gt；-f bacula.int.BaculaDatabase.2015-10-08总大小压缩大小所有档案147224869967 43158468600(唯一数据)50147260360 14694156775Bacula.int.BaculaDatabase.2015-10-03 48831542773 14324280853已删除数据18573 19165总大小压缩大小所有档案98393327194 28834187747(唯一数据)50147241787 14694137610Bacula.int.BaculaDatabase.2015-10-05 48831542773 14324280853已删除数据18573 19165总大小压缩大小所有档案49561784421 14509906894(唯一数据)49265856159 14448990041Bacula.int.BaculaDatabase.2015-10-06 48831542773 14324280853已删除数据881385628 245147569总大小压缩大小所有档案314745728 65670242(唯一数据)19214507 4841679Bacula.int.BaculaDatabase.2015-10-。07 49247038693 14444236652已删除数据49246641652 14444148362总大小压缩大小所有档案314744195 65668842(唯一数据)19212974 4840279Bacula.int.BaculaDatabase.2015-10-08 1533 1400已删除数据1533 1400[Dan@bacula：~]$[Dan@bacula：~]$sudo tarsnap-d\。</p><p>我不会在“机器最近的帐户使用情况”页面中看到更改，因为它“在UTC午夜过后不久更新”。我明天再来。</p><p>同时，我想我可以删除2020年前所有旧的bacula数据库备份。为了好玩，我将保留01-01的每个备份，以及最旧的备份。</p><p>[Dan@KNOWN：~]$head/root/tarsnap-KNOWN-ARCHIVE-LISTBacula.int.BaculaDatabase.2020-08-13 2020-08-13 13：25：00/usr/local/bin/tarsnap-c-f bacula.int.BaculaDatabase.2020-08-13 bacula.dumpBacula.int.BaculaDatabase.2018-08-17 2018-08-17 13：25：00/usr/local/bin/tarsnap-c-f bacula.int.BaculaDatabase.2018-08-17 bacula.dumpBacula.int.BaculaDatabase.2018-11-08 2018。-11-08 13：25：01/usr/local/bin/tarsnap-c-f bacula.int.BaculaDatabase.2018-11-08 bacula.dumpBacula.int.BaculaDatabase.2020-07-08 2020-07-08 13：25：00/usr/local/bin/tarsnap-c-f˜tarbacula.int.BaculaDatabase.2020-07-08 bacula.dumpBacula.int.BaculaDatabase.2016-05-25 2016-05-25 13：25：02/usr/local/bin/tarsnap-c-f bacula.int.BaculaDatabase.2016-05。-25个bacula.dumpBacula.int.BaculaDatabase.2018-08-09 2018-08-09 13：25：02/usr/local/bin/tarsnap-c-f bacula.int.BaculaDatabase.2018-08-09 bacula.dumpBacula.int.BaculaDatabase.2016-10-12 2016-10-12 13：25：00/usr/local/bin/tarsnap-c-f bacula.int.BaculaDatabase.2016-10-12 bacula.dumpBacula.int.BaculaDatabase.2016-01-20 2016-01-20 13：25：00/usr/local/bin。/tarsnap-c-f bacula.int.BaculaDatabase.2016-01-20 bacula.dumpBacula.int.BaculaDatabase.2019-02-06 2019-02-06 13：25：00/usr/local/bin/tarsnap-c-f bacula.int.BaculaDatabase.2019-02-06 bacula.dumpBacula.int.BaculaDatabase.2016-03-18 2016-03-18 13：25：04/usr/local/bin/tarsnap-c-f bacula.int.BaculaDatabase.2016-03-18 bacula.dump[Dan@Knowledge：~]$Cut-。F1-w/root/tarsnap-now-archive-list|headBacula.int.BaculaDatabase.2020-08-13Bacula.int.BaculaDatabase.2018-08-17Bacula.int.BaculaDatabase.2018-11-08Bacula.int.BaculaDatabase.2020-07-08Bacula.int.BaculaDatabase.2016-05-25Bacula.int.BaculaDatabase.2018-08-09Bacula.int.BaculaDatabase.2016-10-12Bacula.int.BaculaDatabase.2016-01-20Bacula.int.BaculaDatabase.2019-02-06Bacula.int.BaculaDatabase.2016-03-18[Dan@Knowledge：~]$。</p><p>[Dan@Knowledge：/root]$Sort Tarsnap-Knowledge-archive-list|Tail-2Bacula.int.BaculaDatabase.2020-09-05 2020-09-05 13：25：00/usr/local/bin/tarsnap-c-f bacula.int.BaculaDatabase.2020-09-05 bacula.dumpBacula.int.BaculaDatabase.2020-09-07 2020-09-07 13：25：00/usr/local/bin/tarsnap-c-f bacula.int.BaculaDatabase.2020-09-07 bacula.dump[Dan@Knowledge：/root]$。</p><p>[Dan@Knowledge：/root]$Sort Tarsnap-Knowledge-Archive-List|head-2Bacula.int.BaculaDatabase.2015-10-08 2015-10-08 19：01：17/usr/local/bin/tarsnap-c-f bacula.int.BaculaDatabase.2015-10-08 bacula.dumpBacula.int.BaculaDatabase.2015-10-09 2015-10-09 13：25：00/usr/local/bin/tarsnap-c-f bacula.int.BaculaDatabase.2015-10-09 bacula.dump。</p><p>5年前的备份。是啊，这可能有点过分了，即使对我来说也是如此。我通常把它们放在家里三年。</p><p>[Dan@Knowledge：~]$Cut-f 1-w/root/Tarsnap-Knowledge-archive-list|egrep-e&#39；-01-01|2015-10-08&#39；|排序Bacula.int.BaculaDatabase.2015-10-08Bacula.int.BaculaDatabase.2016-01-01Bacula.int.BaculaDatabase.2017-01-01Bacula.int.BaculaDatabase.2019-01-01Bacula.int.BaculaDatabase.2020-01-01[Dan@Knowledge：~]$。</p><p>[Dan@Knowledge：~]$Cut-f 1-w/root/Tarsnap-Knowledge-Archive-list|egrep-ve&#39；-01-01|2015-10-08&#39；&gt；Tarsnap-要删除的卷[Dan@Knowledge：~]$wc-l tarsnap-要删除的卷1746 Tarsnap-要删除的卷。</p><p>[DAN@KNOWN：~]$CUT-f 1-w/根/Tarsnap-Know-Archive-List|egrep-ve&#39；-01-01|2015-10-08|bacula.int.BaculaDatabase.2020&#39；&gt；Tarsnap-Volumes-to-Delete[Dan@Knowledge：~]$wc-l tarsnap-要删除的卷1503 Tarsnap-要删除的卷[Dan@Knowledge：~]$</p><p>[Dan@Knowledge：~]$head Tarsnap-要删除的卷#！/bin/sh-f bacula.int.BaculaDatabase.2018-08-17\-f bacula.int.BaculaDatabase.2018-11-08\-f bacula.int.BaculaDatabase.2016-05-25\-f bacula.int.BaculaDatabase.2018-08-09\-f bacula.int.BaculaDatabase.2016-10-12\-f bacula.int.BaculaDatabase.2016-01-20\-f bacula.int.BaculaDatabase。.2019-02-06\-f bacula.int.BaculaDatabase.2016-03-18\-f bacula.int.BaculaDatabase.2018-01-15\[Dan@Knowledge：~]$。</p><p>此删除操作将需要一段时间，因此我启动了tmux会话。我对文件做了chmod+x。</p><p>我开始执行命令，然后继续执行其他命令。它正在删除1500个档案。我想至少要几个小时。</p><p>$PS auwwx|grep tmuxDAN 78234 0.0 0.0 14344 5872-IS 13：150：00.36TMUX：SERVER(/tmp//TMUX-1001/DEFAULT)(TMUX)。</p><p>TMUX从13点15分开始，现在是20点49分-所以大约需要7.5个小时才能走到一半。这件事应该会在一夜之间完成。</p><p>我想要比较磁盘使用前后的情况，但我可能需要等到0000UTC更新统计数据。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://dan.langille.org/2020/09/10/tarsnap-cleaning-up-old-backups/">https://dan.langille.org/2020/09/10/tarsnap-cleaning-up-old-backups/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/tarsnap/">#tarsnap</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/cleaning/">#cleaning</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>