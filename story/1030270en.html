<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>维基媒体的CDN</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">维基媒体的CDN</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-21 16:44:04</div><div class="page_narrow text-break page_content"><p>The Wikimedia Foundation, the non-profit organization behind Wikipedia and other well known wiki-based projects, operates websites and services that are high volume and rank in the world’s top 20. We serve about 21 Billion read requests per month and sustain 55 Million edits to our articles. On a normal day over 90% of these read requests are served by our caching solution, our own Content Delivery Network (CDN). Like other parts of our technology stack, the CDN is based on Open Source software and is constantly evolving. During the last couple of years, we have performed various changes in terms of on-disk HTTP caching and request routing.</p><p>维基媒体基金会(Wikimedia Foundation)是维基百科(Wikipedia)和其他知名维基项目背后的非营利性组织，运营着大量的网站和服务，跻身世界前20名。我们每月为大约210亿份阅读请求提供服务，并对我们的文章进行5500万次编辑。在正常情况下，90%以上的读取请求由我们的缓存解决方案-我们自己的内容交付网络(CDN)-提供服务。与我们技术堆栈的其他部分一样，CDN基于开放源码软件，并且正在不断发展。在过去的几年中，我们在磁盘HTTP缓存和请求路由方面进行了各种更改。</p><p> This 3 part series of articles will describe some of the changes, which included replacing Varnish with Apache Traffic Server (ATS) as the on-disk HTTP cache component of the CDN. ATS allowed us to significantly simplify the CDN architecture, increase our uptime, and accelerate the procedure to switch between our two primary data centers in Virginia and Texas.</p><p>这个由3部分组成的系列文章将描述一些更改，包括将Varish替换为Apache Traffic Server(ATS)作为CDN的磁盘HTTP缓存组件。ATS使我们大大简化了CDN架构，增加了正常运行时间，并加快了在弗吉尼亚州和德克萨斯州的两个主要数据中心之间切换的过程。</p><p>  Wikimedia serves its content from 2 main data centers (DC) and 3 caching-only points of presence (PoP). The two main data centers run all stateful services such as databases, job queues, application servers, and the like, as well as load balancers and HTTP caches. Instead, PoPs only run HTTP caches and the load balancers required to route traffic among them. The two main DCs are located in the United States, specifically in Virginia (short DC name: eqiad) and Texas (short DC name: codfw). The eqiad data center is the one normally serving cache misses, while codfw is a  hot standby. Caching-only PoPs are available in Amsterdam (esams), Singapore (eqsin), and California (ulsfo).</p><p>Wikimedia从2个主要数据中心(DC)和3个仅缓存的入网点(POP)提供内容。两个主要数据中心运行所有有状态服务，如数据库、作业队列、应用程序服务器等，以及负载平衡器和HTTP缓存。相反，POP只运行HTTP缓存和在它们之间路由流量所需的负载均衡器。两个主要的DC位于美国，特别是弗吉尼亚州(DC简称：eQiad)和德克萨斯州(DC简称：codfw)。EQIAD数据中心通常提供高速缓存未命中服务，而CoDfw是热备用的。阿姆斯特丹(ESAMS)、新加坡(Eqsin)和加利福尼亚州(Ulsfo)提供仅缓存POP。</p><p>  Our work is done in the open, and dashboards are no exception. See, for instance, the  traffic patterns of Wikimedia DCs shown above. The CDN serves up to 150K requests per second.</p><p>我们的工作是公开进行的，仪表盘也不例外。例如，参见上面所示的维基媒体DC的流量模式。CDN每秒可处理高达15万个请求。</p><p>   The diagram depicts the CDN architecture up to 2018. We omitted the Singapore PoP for clarity, but it works fundamentally as the California PoP.</p><p>该图描绘了截至2018年的CDN架构。为了清楚起见，我们省略了新加坡流行音乐，但它基本上与加州流行音乐一样。</p><p> Users are routed via GeoDNS to the PoP geographically closest to them. Their request results in a cache lookup, and in case of a cache hit the HTTP response is sent from the PoP straight back to the user, with no further processing required. In case of cache miss, instead, the request is sent further through the CDN to the next caching PoP as shown by the arrows. In case of cache misses all the way down, the request ultimately makes its way to the main primary DC.</p><p>用户通过GeoDNS路由到地理上离他们最近的POP。他们的请求导致缓存查找，在缓存命中的情况下，HTTP响应从POP直接发送回用户，不需要进一步处理。相反，在缓存未命中的情况下，请求将进一步通过CDN发送到下一个缓存POP，如箭头所示。在缓存未命中的情况下，请求最终到达主主DC。</p><p> The response goes back through the CDN (getting stored in the caches it traverses if allowed by Cache-Control and similar response headers) and finally reaches the user. To preserve the privacy of our users, HTTP requests between PoPs need to be sent encrypted. We chose to use IPSec to encrypt traffic due to the lack of outgoing HTTPS support in  Varnish.  Green arrows show the standard request flow through the CDN, while white paths represent IPSec connections in stand-by, to be used in case a given PoP needs to be taken down for operational reasons.</p><p>响应通过CDN返回(如果Cache-Control和类似的响应头允许，则存储在它遍历的缓存中)，并最终到达用户。为了保护我们用户的隐私，POP之间的HTTP请求需要加密发送。由于Varish缺乏传出HTTPS支持，我们选择使用IPSec来加密流量。绿色箭头表示通过CDN的标准请求流，白色路径表示待机状态的IPSec连接，以便在给定POP因操作原因需要关闭时使用。</p><p> Looking more closely at what happens inside a PoP, we can see that each cache node runs three different HTTP servers: one instance of NGINX for TLS termination, one in-memory instance of Varnish for caching in RAM, and one instance of Varnish for on-disk caching. NGINX is necessary to serve HTTPS traffic given that Varnish does not support incoming HTTPS either, but can otherwise be ignored for the purposes of this article.</p><p>更仔细地观察POP内部发生的情况，我们可以看到每个缓存节点运行三个不同的HTTP服务器：一个用于TLS终止的Nginx实例，一个用于RAM缓存的内存中的Varish实例，以及一个用于磁盘缓存的Varish实例。考虑到Varish也不支持传入的HTTPS，nginx对于服务HTTPS流量是必要的，但是对于本文而言，可以忽略nginx。</p><p>    (1) The load balancer picks a cache node by applying  consistent hashing to the client IP. In case of a cache hit on the in-memory Varnish, the HTTP response is sent back directly to the user. As an optimization, the response goes back to the user without going through the load balancer. This technique is known as  Direct Routing and is particularly useful for HTTP traffic, which features comparatively small requests and large responses. Cache misses are further processed by the CDN.</p><p>(1)负载均衡器通过对客户端IP进行一致哈希来挑选缓存节点。如果缓存命中内存中的Varish，HTTP响应将直接发送回用户。作为优化，响应将返回给用户，而无需通过负载均衡器。此技术称为直接路由，对于请求相对较小、响应相对较大的HTTP流量特别有用。高速缓存未命中由CDN进一步处理。</p><p> (2) The in-memory Varnish applies consistent hashing on the request URL to pick another cache node within the PoP (local backend) and sends the HTTP request to the on-disk Varnish instance of the node so chosen. In case of a further cache miss, request processing continues at the on-disk Varnish level in another pop (remote backend).</p><p>(2)内存中的Varish对请求URL应用一致的散列，以挑选POP(本地后端)内的另一个缓存节点，并将HTTP请求发送到如此选择的节点的盘上Varish实例。如果进一步未命中缓存，请求处理将在另一个POP(远程后端)中的磁盘上Varish级别继续进行。</p><p> (3) The request is sent to another on-disk Varnish running in the next PoP. In the example above, the request goes from esams (EU, Netherlands) to eqiad (US, Virginia). The request is sent over an IPSec tunnel. In case of yet another cache miss on the remote, on-disk Varnish, the request is sent to the next remote PoP (if any), or it reaches the origin server.</p><p>(3)该请求被发送到在下一个POP中运行的另一个磁盘上的Varish。在上面的示例中，请求从esams(欧盟，荷兰)发送到eQiad(美国，弗吉尼亚州)。该请求通过IPSec隧道发送。如果在远程磁盘Varish上再次发生缓存未命中，则请求将被发送到下一个远程POP(如果有)，或者它将到达源服务器。</p><p> (4) The origin server processes the request, and in our example, the HTTP response goes back via the remote on-disk Varnish in Virginia, the local on-disk Varnish in Amsterdam, the in-memory Varnish in Amsterdam, and finally reaches the user. If cacheable, the response is stored on the various caches it traverses, so that any later request for this object can be served from the caches instead.</p><p>(4)源站对请求进行处理，在我们的示例中，HTTP响应通过位于弗吉尼亚的远程盘上Varish、位于阿姆斯特丹的本地盘上Varish、位于阿姆斯特丹的内存中Varish返回，最终到达用户。如果可缓存，则响应存储在它所遍历的各个缓存中，这样以后对此对象的任何请求都可以从缓存中得到服务。</p><p>  The architecture described so far served us well for a while, though we did encounter various problems and identify areas for improvement.</p><p>到目前为止，所描述的体系结构在一段时间内为我们提供了很好的服务，尽管我们确实遇到了各种问题，并确定了需要改进的地方。</p><p> Generally speaking, the hit rates on remote on-disk Varnish instances have always been very low (around 1%). Step (3) as detailed earlier in this post was there simply as a workaround for lack of TLS support in Varnish and could be avoided using an HTTPS-capable caching proxy instead.</p><p>一般来说，远程盘上Varish实例的命中率一直很低(1%左右)。正如本文前面详述的那样，步骤(3)只是作为Varish中缺乏TLS支持的一种解决办法，可以使用支持HTTPS的缓存代理来避免。</p><p> Furthermore, the on-disk cache instances were affected by serious scalability and reliability issues. Varnish supports various types of  storage backends for its cache contents. Up to version 3, the  persistent storage backend was our backend of choice and worked very well in our usage scenario: it worked reliably and allowed us to store cache objects on disk. Further, the cache was persistent, in the sense that we could restart Varnish without losing the cache.</p><p>此外，磁盘上的缓存实例还受到严重的可伸缩性和可靠性问题的影响。Varish支持其缓存内容的各种类型的存储后端。在版本3之前，持久存储后端是我们选择的后端，并且在我们的使用场景中工作得非常好：它工作可靠，并且允许我们将缓存对象存储在磁盘上。此外，缓存是持久的，从这个意义上说，我们可以在不丢失缓存的情况下重新启动Varish。</p><p> The persistent storage backend was deprecated in Varnish version 4, and replaced in the proprietary version of Varnish by a storage backend with similar features and called  Massive Storage Engine.   FOSS users were thus left with the option of using the  file storage backend, which had two major drawbacks: (1) no support for persistence (2) scalability issues.</p><p>永久存储后端在Varish版本4中已弃用，在专有版本的Varish中被具有类似功能的称为海量存储引擎的存储后端所取代。因此，自由/开源软件用户可以选择使用文件存储后端，这有两个主要缺点：(1)不支持持久性(2)可伸缩性问题。</p><p> The second problem, in particular, was occurring after a few days of production use: a sizable number of requests would result in 503 errors, and normal operation could be resumed only by restarting Varnish. As a bandaid, we introduced a cron-job restarting Varnish on a weekly basis. Unfortunately, this frequency of restarts did not prove to be sufficient, and we had to resort to restarting Varnish twice a week to reduce the frequency of user-facing outages. The issue turned out to be a  known architectural limitation of the file storage engine. After  several  debugging sessions we concluded that it was time to start looking for alternatives.</p><p>值得一提的是，第二个问题发生在生产使用几天之后：大量的请求将导致503个错误，只有重新启动Varish才能恢复正常操作。作为创可贴，我们每周介绍一次cron-job重新启动Varish。不幸的是，事实证明这种重新启动的频率还不够，我们不得不每周重新启动Varish两次，以减少面向用户的停机频率。该问题被证明是文件存储引擎的已知体系结构限制。经过几次调试后，我们得出结论，是时候开始寻找替代方案了。</p><p> As a viable replacement for Varnish we identified  Apache Traffic Server: an  Apache Software Foundation project used and developed by many large organizations including Apple, Verizon, Linkedin, and Comcast. A migration to ATS would solve our two major pain points with Varnish: it supports persistent storage on-disk reliably, as well as incoming and outgoing HTTPS.</p><p>作为Varish的可行替代品，我们确定了Apache Traffic Server：Apache Software Foundation项目，由许多大型组织使用和开发，包括Apple、Verizon、LinkedIn和Comcast。迁移到ATS将解决我们使用Varish的两个主要痛点：它可靠地支持磁盘上的持久存储，以及传入和传出HTTPS。</p><p> In the next post, we will describe the architectural changes made possible by migrating the on-disk component of our CDN to Apache Traffic Server.</p><p>在下一篇文章中，我们将描述通过将CDN的磁盘组件迁移到Apache Traffic Server而实现的架构更改。</p><p>  Featured image credit:  North America from low orbiting satellite Suomi NPP, NASA/NOAA/GSFC/Suomi NPP/VIIRS/Norman Kuring,  Public Domain</p><p>特色图片来源：北美低轨道卫星索米NPP，NASA/NOAA/GSFC/索米NPP/VIIRS/诺曼·库林，公共领域。</p><p>   Skip back to main navigation</p><p>跳回到主导航</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://techblog.wikimedia.org/2020/10/14/wikimedias-cdn/">https://techblog.wikimedia.org/2020/10/14/wikimedias-cdn/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/媒体/">#媒体</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/wikimedia/">#wikimedia</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/缓存/">#缓存</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>