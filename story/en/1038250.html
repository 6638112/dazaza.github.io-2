<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>IMGZ的体系结构 The Architecture of IMGZ</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">The Architecture of IMGZ<br/>IMGZ的体系结构 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-08 00:41:07</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/12/980e729939d2c6c9f22829284b0a7ed5.png"><img src="http://img2.diglog.com/img/2020/12/980e729939d2c6c9f22829284b0a7ed5.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Every day at work, hundreds of customers ask us &#34;can I get a large cappuccino?&#34;. Later, we go home and use the money to narrowly avoid starvation while working on IMGZ, the best image host, in true Silicon Valley spirit. We thought that some of the architectural challenges we faced while building the service would interest others, and decided to write about them to help our readers and change the world.</p><p>每天上班时，成千上万的客户问我们＆＃34;我能买一杯大的卡布奇诺咖啡吗？＆＃34;。后来，我们回到家，用本钱在真正的硅谷精神下，为最好的图像主机IMGZ工作时，避免饥饿。我们认为在构建服务时遇到的一些架构挑战会使其他人感兴趣，因此决定撰写有关这些挑战的文章，以帮助我们的读者并改变世界。</p><p> If you aren&#39;t familiar with IMGZ, it&#39;s an image host with a twist: You pay to host images, thus ensuring that we always have your best interests in mind and won&#39;t turn into a social network. In essence, we flip the traditional &#34;startup giving away VC money to users&#34; on its head, and take money  from users. If that sounds good to you, you can sign up  on our home page and we&#39;ll only be mildly surprised.</p><p> 如果您不熟悉IMGZ，那就是图片托管服务商，您会有所不同：您为托管图片支付费用，从而确保我们始终牢记您的最大利益，并且不会成为社交网站网络。从本质上讲，我们翻转了传统的“初创公司”，向用户赠送了VC资金。从用户那里赚钱。如果这对您来说听起来不错，您可以在我们的主页上注册，我们只会让您感到惊讶。</p><p> At IMGZ, we&#39;re passionate about two things: Serving images, and speaking about ourself in the plural so it doesn&#39;t look like it&#39;s the one-man sideproject it is, and we don&#39;t even really care about serving images that much. Today, though, we&#39;re going to talk about the former, and take a deep dive into the technical details of serving more than one million bytes of images per day while maintaining the elusive &#34;nine fives&#34; reliability guarantee we&#39;re loved for and usually uphold.</p><p> 在IMGZ，我们对两件事充满热情：提供图片，并以复数形式谈论自己，所以看起来它不是一个人的项目，而我们却不这样做。 ； t甚至不十分在意投放图片。不过，今天，我们将讨论前者，并深入探讨每天提供超过一百万字节图像的技术细节，同时保持难以捉摸的“九五”。可靠性保证是我们钟爱的产品，通常会坚持使用。</p><p>  Our architecture is pretty simple, a fairly run-of-the-mill, scrappy-startup SaaS architecture which you&#39;ve no doubt seen countless times before:</p><p>  我们的体系结构非常简单，是一个相当成熟的，草率的启动SaaS体系结构，您无疑会在之前看到过无数次：</p><p>  While designing the IMGZ storage and serving model, we wanted scalability and reliability to be our foremost concerns.After months of designs and grueling research, we ended up designing a Kafka-based georeplicated image processing pipeline over a multitenant, distributed, resilient microservices architecture, where metadata about each image is kept in a georeplicated MongoDB instance, and with images themselves stored in DynamoDB on AWS, ensuring scalability and low latency.</p><p>  在设计IMGZ存储和服务模型时，我们希望可扩展性和可靠性成为我们的首要考虑。经过几个月的设计和艰苦的研究，我们最终在多租户，分布式，弹性微服务架构上设计了基于Kafka的地理复制图像处理管道，其中，每个图像的元数据都保存在地理复制的MongoDB实例中，图像本身存储在AWS上的DynamoDB中，以确保可伸缩性和低延迟。</p><p> When we realized we didn&#39;t have investors to impress, we trashed that plan, as it sounded like too much work.We realize that architecture design nowadays is mostly aspirational, but at some point a startup needs to come to terms with the fact that it doesn&#39;t have ten million users right now, it probably won&#39;t have ten million users soon, and it&#39;ll likely never have ten users.Instead, we stored the images in a small Postgres database (yes, the actual image data itself), with a small Django app handling the business logic. Sexy.</p><p> 当我们意识到自己没有给投资者留下深刻印象时，我们就放弃了该计划，因为听起来好像工作量太大了。我们意识到当今的架构设计主要是出于抱负，但在某个时候，一家初创公司需要与事实上它现在没有一千万个用户，它可能很快不会有一千万个用户，并且可能永远不会有十个用户。相反，我们将图像存储在一个小的Postgres中数据库（是的，实际的图像数据本身），以及一个处理业务逻辑的小型Django应用。好性感</p><p> When the user uploads an image, we process it, create thumbnails for displaying in various views of the website, and store it along with its metadata in the database, at least in theory.When a user requests the image, the request first goes through our CDN, which fetches the image from our server and then caches it forever, so each image is only served by us at most once.For our CDN (for serving, caching, georeplication, etc), we use CloudFlare&#39;s free tier, which is excellent.We ensure that we&#39;ll always remain in the free tier by providing a paid service nobody would actually ever pay for.</p><p> 当用户上传图像时，我们会对其进行处理，创建缩略图以在网站的各种视图中显示，并将其连同元数据一起存储在数据库中，至少在理论上是这样。当用户请求图像时，请求首先经过我们的CDN，该CDN会从我们的服务器中获取图像，然后将其永久缓存，因此每个图像最多只能由我们提供一次。对于我们的CDN（用于服务，缓存，地理复制等），我们免费使用CloudFlare级别，这非常好。我们通过提供无人支付的有偿服务来确保始终保持免费。 </p><p>    Images, just like the one above, are the heart of our service, but let&#39;s not digress.The hardware is a $5/mo Hetzner VM that serves ~10 other projects, so it&#39;s pretty beefy.As our favorite proverb goes, &#34;you don&#39;t need lots of resources when all your content is static and you can get someone else to serve it for free&#34;.</p><p>像上面的图像一样，图像是我们服务的核心，但请不要离题。硬件是Hetzner VM的$ 5 / mo的虚拟机，可服务约10个其他项目，因此它非常强大。我们最喜欢的谚语是，当您所有的内容都是静态的并且不需要其他资源免费服务时，您就不需要大量的资源。</p><p> We&#39;re pretty confident in our ability to scale our infrastructure in the event that more users join the service, as our VPS provider has a button we can press to make the server larger, solving all scalability problems once and for all.</p><p> 如果更多的用户加入该服务，我们对扩展基础架构的能力非常有信心，因为我们的VPS提供商拥有一个按钮，我们可以按此按钮来增大服务器的体积，从而一劳永逸地解决所有可扩展性问题。</p><p>  This article was a bit boring, wasn&#39;t it? That&#39;s by design: Your architecture doesn&#39;t have to be exciting to work, especially in the early stages of a company. Doing the easiest thing that works (taking care not to paint yoursellf into a corner) is often the best way to start, since you usually don&#39;t even know where you&#39;ll end up.</p><p>  这篇文章有点无聊，不是吗？那是由设计决定的：您的体系结构不必激动人心地工作，尤其是在公司的早期阶段。做最简单的事情（注意不要把自己画在角落里）通常是最好的开始方法，因为您通常甚至不知道自己最终会去哪里。</p><p> To summarize, our architecture follows the tried-and-true Silicon Valley approach: Build the simplest thing you can, by piggybacking off of everyone&#39;s free tier, while they hope you one day become successful and pay them exorbitant amounts of money in return. The strategy to outsmarting them is simple:</p><p> 总而言之，我们的架构遵循久经考验的硅谷方法：通过ing带每个人的免费套餐来构建您可以做的最简单的事情，而他们希望您有一天能成功并付给他们不菲的金钱作为回报。使其聪明的策略很简单： </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/imgz/">#imgz</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/服务/">#服务</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>