<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>使用Docker自定义GitHub操作</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">使用Docker自定义GitHub操作</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-12 17:39:28</div><div class="page_narrow text-break page_content"><p>I finally decided to dip my toes into GitHub actions recently, for a relatively simple task: build and deploy my personal site. The site is built with  zola and deployed to  netlify.</p><p>最近，我终于决定尝试GitHub的行动，只为一个相对简单的任务：构建和部署我的个人网站。该网站是与左拉一起建造的，并被部署成网络。</p><p>   Then I simply make sure my site source is checked out and run the  build and  deploy commands.</p><p>然后，我只需确保我的站点源代码已签出，并运行Build和Deploy命令。</p><p>  An   action is a single step that may be performed in a larger   workflow, which strings together multiple actions and is kicked off in response to various events (like a  git push, or a PR). You can have a workflow that calls a single action, but an action can&#39;t be used without being called in a workflow.</p><p>动作是可以在更大的工作流程中执行的单个步骤，它将多个动作串在一起，并在响应各种事件(如GIT推送或公关)时启动。您可以使用调用单个操作的工作流，但如果不在工作流中调用操作，则不能使用该操作。</p><p>  I noticed the marketplace approach first of all, and the emphasis on actions that did one small thing which you compose together. This can definitely be a nice approach to things, but my preferred way of working on CI tasks like this is to have access to a Docker container where I have a bit more control of my environment, and can codify it into a familiar Dockerfile.</p><p>我首先注意到了市场方法，以及对行动的强调，这些行动完成了你们共同撰写的一件小事。这绝对是一种很好的方法，但我更喜欢这样处理CI任务的方式是访问Docker容器，在那里我可以更好地控制我的环境，并可以将其编码到熟悉的Dockerfile中。</p><p> My thinking is, if I can get this sort of approach to work, I&#39;ll have less required domain knowledge of GitHub actions, and can instead just lean on my Docker knowledge to set up whatever operations I may need.</p><p>我的想法是，如果我能用这种方法工作，我对GitHub操作所需的领域知识就会少一些，而只需依靠我在Docker上的知识就可以设置我可能需要的任何操作。</p><p> Needless to say, I simply sidestepped the marketplace and found the  documentation for utilizing Docker, which thankfully is a valid option! 🎉</p><p>不用说，我只是避开了市场，找到了使用Docker的文档，谢天谢地，这是一个有效的选择！🎉。</p><p>  I stumbled through this quite a bit, but ultimately am happy with the approach. I&#39;m able to have a  Dockerfile and custom   entrypoint.sh file that can receive inputs via env vars from the action configuration. I&#39;m also able to pipe secrets, stored in my GitHub repo, into the action from the workflow file.</p><p>我跌跌撞撞地经历了这一点，但最终还是对这种方法感到满意。我能够拥有Dockerfile和自定义entry ypoint.sh文件，它们可以通过环境变量接收来自操作配置的输入。我还能够通过管道将存储在GitHub资源库中的秘密从工作流文件传送到操作中。</p><p>  # .github/actions/build-and-deploy/action.yml name : &#39; Build and deploy &#39; description : &#39; Build site with Zola and deploy to Netlify &#39; inputs :  auth_token :  description : &#39; Netlify auth token &#39;  required :  true  site_id :  description : &#39; Netlify site ID to deploy to &#39;  required :  true  deploy_dir :  description : &#39; Directory to deploy to netlify &#39;  required :  true  zola_version :  description : &#39; Version of zola to pull &#39;  required :  true  default : &#39; 0.12.2 &#39; runs :  using : &#39; docker &#39;  image : &#39; Dockerfile &#39;  env :  ZOLA_VERSION :  ${{ inputs.zola_version }} NETLIFY_AUTH_TOKEN :  ${{ inputs.auth_token }} NETLIFY_SITE_ID :  ${{ inputs.site_id }} NETLIFY_DEPLOY_DIR :  ${{ inputs.deploy_dir }}</p><p>#.github/action/build-and-ploy/action.yml名称：&#39；构建和部署&#39；描述：&#39；使用Zola构建站点并部署到Netlify；输入：AUTH_TOKEN：Description：&#39；Netlify auth Token&#39；必需：true site_id：Description：&#39；Netlify要部署到&#39；的Netlify站点ID；必需：True Deploy_dir：Description：&#39；要部署到Netlify的目录。必需：True Zola_Version：描述：&#39；要获取的Zola版本；必需：True默认：&#39；0.12.2&#39；运行：使用：&#39；docker&#39；图像：&#39；Dockerfile&#39；环境：ZOLA_VERSION：${{inputs.zola_Version}}NETLIFY_AUTH_TOKEN：${{inputs.auth_Token}}NETLIFY_SITE_ID：${{inputs.site_id}}NETLIFY_Deploy_DIR：${inputs.Deploy_dir}}</p><p> This file defines our action, which will be called from a workflow which we will configure later. The main thing to notice here is how we are accepting inputs, and passing those on to our Docker container through environment variables.</p><p>此文件定义我们的操作，该操作将从我们稍后配置的工作流中调用。这里需要注意的主要问题是我们如何接受输入，并通过环境变量将这些输入传递给我们的Docker容器。</p><p> This was one of the things I stumbled over. Currently there is no support for passing  build args to our Dockerfile, and the environment variables we provide are not available during the build stage, only once the   ENTRYPOINT is called.</p><p>这是我偶然发现的事情之一。目前不支持将构建参数传递到Dockerfile，并且我们提供的环境变量在构建阶段不可用，只有在调用入口点之后才能使用。</p><p> I was stuck on this for a decent chunk of time before realizing that   runs.args with  docker are  not build args, they are arguments sent to the  entrypoint. Don&#39;t make the same mistakes I did!</p><p>在意识到runs.args和docker不是构建参数，它们是发送到入口点的参数之前，我被困在这一点上有相当长的一段时间。不要重蹈我的覆辙！</p><p> The implication here is that any steps in your action that require one of these inputs must happen in the  ENTRYPOINT provided via  env. I&#39;ll mention this again shortly.</p><p>这里的意思是，您的操作中需要这些输入之一的任何步骤都必须发生在通过env提供的入口点中。我很快就会再次提到这一点。</p><p>  The  Dockerfile is pretty minimal, simply setting up the base environment I want, which is  node:lts in this case, and then copy in my custom  [entrypoint.sh](http://entrypoint.sh) script.</p><p>Docker文件非常小，只需设置我想要的基本环境(在本例中为NODE：lts)，然后复制我的自定义[Entrypoint.sh](http://entrypoint.sh)脚本)。</p><p>  Tip!  Don&#39;t set a  WORKDIR. The action sets the workdir to the  $GITHUB_WORKSPACE variable which is where your project source will be located.</p><p>小费！不要设置工作目录。该操作将workdir设置为$GITHUB_WORKSPACE变量，该变量是您的项目源代码所在的位置。</p><p>  # .github/actions/build-and-deploy/entrypoint.sh#!/usr/bin/env bash ZOLA_URL=https://github.com/getzola/zola/releases/download/v${ZOLA_VERSION}/zola-v${ZOLA_VERSION}-x86_64-unknown-linux-gnu.tar.gzcurl -L $ZOLA_URL | tar xz -C /usr/local/bin # Install netlify npm i -g netlify-cli # Kick off build and deploy zola buildnetlify deploy \ --prod \ --dir=$NETLIFY_DEPLOY_DIR \ --auth=$NETLIFY_AUTH_TOKEN \ --site=$NETLIFY_SITE_ID</p><p>#.github/actions/build-and-deploy/entrypoint.sh#！/usr/bin/env bash ZOLA_URL=https://github.com/getzola/zola/releases/download/v${ZOLA_VERSION}/zola-v${ZOLA_VERSION}-x86_64-unknown-linux-gnu.tar.gzcurl-L$ZOLA_URL|tar XZ-C/USR/LOCAL/BIN#安装netlify npm i-g netlify-cli#启动构建和部署Zola Buildnetlify部署\--产品\--目录=$NETLIFY_DEPLOY_。目录\--AUTH=$NETLIFY_AUTH_TOKEN\--SITE=$NETLIFY_SITE_ID。</p><p> You can see here we&#39;re referencing the  env vars we defined in our action file. Originally I had the zola and netlify install steps happening in the  Dockerfile, but due to the inability to pass build args to the image, I wasn&#39;t able to get the  $ZOLA_VERSION passed in. Once I had that realization, it seemed just as viable to put everything in  entrypoint.sh.</p><p>您可以在这里看到，我们正在引用我们在操作文件中定义的环境变量。最初，我在Dockerfile中执行了Zola和netlify安装步骤，但由于无法将构建参数传递给镜像，所以我无法传入$Zola_Version。一旦我意识到这一点，将所有内容都放在entry ypoint.sh中似乎同样可行。</p><p>  # .github/workflows/build-and-deploy.yml name :  build-and-deploy on :  push :  branches : [ master ] jobs :  build-and-deploy :  runs-on :  ubuntu-latest steps : -  uses :  actions/checkout@v2  -  uses :  ./.github/actions/build-and-deploy with :  zola_version : &#39; 0.12.2 &#39;  auth_token :  ${{ secrets.NETLIFY_AUTH_TOKEN }} site_id :  ${{ secrets.NETLIFY_SITE_ID }} deploy_dir : &#39; public &#39;</p><p>#.github/workworks/build-and-ploye.yml名称：Build-and-Deploy on：Push：Branch：[master]Jobs：Build-and-Deploy：Running-On：Ubuntu-最新步骤：-用法：Actions/Checkout@v2-用法：./.github/Actions/Build-Deploy with：Zola_Version：&#39；0.12.2&#39；Zola_Version：&#39；0.12.2&#39；AUTH_TOKEN：${secs.NETLIFY_AUTH_TOKEN}}site_id：${secs.NETLIFY_SITE_ID}}Deploy_dir：&#39；public&#39；</p><p> This is our final configuration file, turning our new custom action into a workflow. We start by setting our workflow triggers in the  on block. In this case we just want to run this workflow on pushes to  master.</p><p>这是我们的最终配置文件，将新的自定义操作转换为工作流。我们首先在ON块中设置工作流触发器。在本例中，我们只想在推送到MASTER上运行此工作流。</p><p> Next is our  jobs block. We can define multiple jobs which would all run in parallel. If we need anything serial, it should happen within a single job. In our case, we have just one job with two actions.</p><p>下一步是我们的工作区块。我们可以定义多个并行运行的作业。如果我们需要任何连续的东西，它应该发生在一个单一的任务。在我们的例子中，我们只有一个作业和两个动作。</p><p> The job itself starts with the checkout action, which handles checking out the repo&#39;s source into the job workspace, then we call our custom action by providing a path to the action folder.</p><p>作业本身以签出操作开始，该操作处理将存储库的源签出到作业工作区，然后我们通过提供操作文件夹的路径来调用自定义操作。</p><p> In our  with block we provide values for the inputs we defined on our action. You&#39;ll notice that two of the values are provided via  secrets, which is a  feature of GitHub I wasn&#39;t aware of before this. It&#39;s very easy to work with!</p><p>在With块中，我们为我们在操作上定义的输入提供值。您会注意到其中两个值是通过Secret提供的，这是我在此之前不知道的GitHub的一个功能。使用它非常容易！</p><p>  I think the main drawback here is potentially slow job run times, since we&#39;re installing our dependencies each time. Depending on what&#39;s actually slow, there are a number of ways it could be addressed.</p><p>我认为这里的主要缺点是作业运行时间可能很慢，因为我们每次都要安装依赖项。根据实际缓慢程度的不同，有很多方法可以解决这个问题。</p><p> In general, finding a base Docker image that has as much of what you need as possible (without too much bloat) is going to help. Maintaining your own images in a registry somewhere comes with it&#39;s own overhead, but that&#39;s also an option.</p><p>总而言之，找到一个基本的Docker图像会有所帮助，它可以尽可能多地满足您的需求(而不会过于臃肿)。在某个注册表中维护您自己的图像会带来自己的开销，但这也是一种选择。</p><p> I&#39;m sure using the marketplace approach could also be a way to address the performance issues, assuming you find actions that have your dependencies installed and configured appropriately, but the goal of this post was to explore a minimal action configuration while leveraging the power of Docker 😄.</p><p>我确信使用Marketplace方法也可能是解决性能问题的一种方法，假设您找到的操作都安装了依赖项并进行了适当的配置，但本文的目标是探索最小的操作配置，同时利用Docker😄的强大功能。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://sethetter.com/posts/github-actions-with-docker/">https://sethetter.com/posts/github-actions-with-docker/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/github/">#github</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/docker/">#docker</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/操作/">#操作</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1034509.html"><img src="http://img2.diglog.com/img/2020/11/thumb_3b082e925eba474388c430e422f0b424.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1034509.html">使用PHP 7.4编码并通过Rector和GitHub操作部署到7.1</a></div><span class="my_story_list_date">2020-11-11 18:58</span></div><div class="col-sm"><div><a target="_blank" href="/story/1033880.html"><img src="http://img2.diglog.com/img/2020/11/thumb_1a65df924f8779c225ea2e11e4155568.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033880.html">使用Alfred在浏览器中打开GitHub存储库</a></div><span class="my_story_list_date">2020-11-9 0:51</span></div><div class="col-sm"><div><a target="_blank" href="/story/1033660.html"><img src="http://img2.diglog.com/img/2020/11/thumb_e8a462cce56d2b68b4d24fbea8d89f37.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033660.html">GitHub YouTube-DL下架不仅仅是美国法律的问题</a></div><span class="my_story_list_date">2020-11-7 14:13</span></div><div class="col-sm"><div><a target="_blank" href="/story/1033454.html"><img src="http://img2.diglog.com/img/2020/11/thumb_35598305cd417b83b8fab05e3a4f7b31.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033454.html">GitHub的源代码昨晚在GitHub网站…上泄露。说大也大吧</a></div><span class="my_story_list_date">2020-11-6 7:41</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>