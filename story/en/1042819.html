<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>与printf（）和C参数传递有关的一个小难题 A little puzzle with printf() and C argument passing</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">A little puzzle with printf() and C argument passing<br/>与printf（）和C参数传递有关的一个小难题 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-01 17:19:29</div><div class="page_narrow text-break page_content"><p>In  The Easy Ones – Three Bugs Hiding in the Open,Bruce Dawson gave us a little C puzzle in passing:</p><p>布鲁斯·道森（Bruce Dawson）在《轻松的人–公开中的三个漏洞》中给我们带来了一个C难题：</p><p> The  variable arguments inprintf formatting means that it is easy to get type mismatches. Thepractical results vary considerably:</p><p> inprintf格式的可变参数意味着很容易获得类型不匹配。实际结果差异很大：</p><p> printf(“0x%08lx”, p); // Printing a pointer as an int – truncation or worse on 64-bit</p><p> printf（“ 0x％08lx”，p）; //将指针打印为int –在64位上截断或更差</p><p> printf(“%d, %f”, f, i); // Swapping float and int – could print nonsense, or might actually work (!)</p><p> printf（“％d，％f”，f，i）; //交换float和int –可以打印废话，或者可以实际工作（！）</p><p> printf(“%s %d”, i, s); // Swapping the order of string and int – will probably crash</p><p> printf（“％s％d”，i，s）; //交换string和int的顺序–可能会崩溃</p><p> I had to think about this for a bit, and then I realized why andhow it can work (and why similar integer versus float argumentconfusion can also work for other functions, even ones with fixedargument lists). What it comes down to is that in some  ABIs,arguments are passed in registers (at least early arguments, beforeyou run out of registers), and  floating point arguments are passedin different registers than integers (and pointers). This istrue even for functions that take variable arguments and will walkthrough them using stdarg macros (or at least it can be, dependingon the ABI).</p><p> 我不得不考虑一下，然后我意识到了它为什么起作用以及如何起作用（以及为什么类似的整数与浮点参数混淆也可以用于其他函数，甚至是带有固定参数列表的函数）。结果是，在某些ABI中，参数在寄存器中传递（至少早期参数，在用完寄存器之前），并且浮点参数在整数（和指针）之外的其他寄存器中传递。即使对于采用可变参数并使用stdarg宏逐步遍历它们的函数，也是如此（或者至少可以，取决于ABI）。</p><p> Because floating point and non floating point arguments are passedin different sets of registers, what matters isn&#39;t the total orderof arguments but the order of floating point or non-fp arguments.So here, regardless of where &#39;%f&#39; is in the printf format, it alwayscauses printf() to get the first floating point argument, which cannever be confused with an integer argument. Similarly, the first&#39;%d&#39; causes printf() to look for the second non-fp argument,regardless of where it was in the argument order; it could be atthe end of several floating point arguments and still work.</p><p> 由于浮点和非浮点参数在不同的寄存器集中传递，因此重要的不是参数的总顺序，而是浮点或非fp参数的顺序。因此在这里，无论在何处％f ＃39;格式为printf时，它总是使printf（）获得第一个浮点参数，永远不能将其与整数参数混淆。同样，第一个＆＃39; d＆＃39;导致printf（）查找第二个非fp参数，而不管其在参数顺序中的位置；它可能在几个浮点参数的末尾并且仍然有效。 </p><p> (The &#39;%d&#39; makes printf() look for the second non-fp argument becausethe first one was the format string. In an ABI that passed pointersin a separate place than integers, it would still work out, since nowthe first &#39;%d&#39; would be looking for the first integer argument.)</p><p>（＆＃39;％d＆＃39;使printf（）寻找第二个非fp参数，因为第一个是格式字符串。在ABI中，指针在与整数分开的地方传递指针，但它仍然可以解决，因为现在第一个＆＃39％d＆＃39;将在寻找第一个整数参数。）</p><p> Using the excellent services of godbolt.org, we can see this inaction on 64-bit x86 in  a very small example (I used a very small example and adecent optimization level to get clear, minimal assembly code). Thefloating point argument is passed in  xmm0, while the format stringand the integer argument are passed in  edi and  esi respectively(I don&#39;t know what  eax is doing, but it probably has somethingto do with the ABI). A similar thing happens on 64-bit ARM v8 (akaAarch64), as we can also see on godbolt with  the same example onAarch64.</p><p> 使用godbolt.org的出色服务，我们可以在一个非常小的示例中看到这种在64位x86上不起作用的情况（我使用了一个非常小的示例和适当的优化级别来获得清晰的最小汇编代码）。浮点参数在xmm0中传递，而格式字符串和整数参数分别在edi和esi中传递（我不知道eax在做什么，但它可能与ABI有关。）在64位ARM v8（akaAarch64）上也发生了类似的事情，就像我们在Godbolt上看到的相同示例onAarch64一样。</p><p> (Based on  this page,the Aarch64  x0 and  w1 are in the same set of registers. Apparently d0 is a 64-bit version of the first floating point register, from here[pdf]. I wound up looking up all of this to be sure I understoodwhat was going on in the Aarch64 call, so I might as well write itdown here.)</p><p> （基于此页面，Aarch64 x0和w1位于同一组寄存器中。显然d0是第一个浮点寄存器的64位版本，从这里开始[pdf]。我最终将所有这些查找为确保我了解Aarch64调用中发生了什么，所以我不妨在这里写下来。）</p><p> Since pointers and integers are normally passed in the same set ofregisters (at least on 64-bit x86 and Aarch64), we can also see whythe third example is very likely to fail. Since the same set ofregisters is used for both argument types, it&#39;s possible to use aninteger argument as a pointer argument, with a segmentation faultas the likely result. Similarly, we can predict that &#39; printf(&#34;%s%f&#34;, f, s);&#39; might well work.</p><p> 由于指针和整数通常在同一组寄存器中传递（至少在64位x86和Aarch64上），因此我们也可以看到为什么第三个示例很可能失败。由于两种参数类型都使用相同的寄存器集，因此可以将整数参数用作指针参数，可能会出现分段错误。同样，我们可以预测到＆＃39; printf（＆＃34;％s％f＆＃34 ;, f，s）;＆＃39;可能会工作。</p><p> PS: This confusion can happen in any language that follows the CABI on a platform with this sort of split usage of registers (althoughmany languages may prevent this sort of argument type confusion).Not all languages do; famously, Go currently passes all argumentson the stack (as of Go 1.15 and soon Go 1.16).</p><p> PS：这种混淆可能会在平台上使用CABI的任何一种使用这种对寄存器进行拆分的语言出现（尽管许多语言都可以防止这种自变量类型的混淆）。著名的是，Go当前将所有参数传递给堆栈（从Go 1.15开始，不久成为Go 1.16）。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://utcc.utoronto.ca/~cks/space/blog/programming/PrintfAndArgumentPassing">https://utcc.utoronto.ca/~cks/space/blog/programming/PrintfAndArgumentPassing</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/printf/">#printf</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/参数/">#参数</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>