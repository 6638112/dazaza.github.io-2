<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CUCU：一个你能理解的编译器(1/3)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">CUCU：一个你能理解的编译器(1/3)</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-19 10:50:59</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/7/3cd67f8c773c5df13d60d9d2e7f8918c.png"><img src="http://img.diglog.com/img/2020/7/3cd67f8c773c5df13d60d9d2e7f8918c.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>我会试着告诉你这有多简单。第一部分很有理论性，所以要有耐心。</p><p>CUCU是玩具语言的玩具编译器。我希望它尽可能接近ANSI CA，这样每个有效的CUCU程序都可以用C编译器编译，没有任何错误。当然，整个ANSI C标准的支持非常困难，所以我选择了一个非常小的C语言子集。</p><p>Int cucu_strlen(char*s){int i=0；而(s[i]){i=i+1；}return i；}。</p><p>我们即将为我们的语言定义一个语法。这是重要的一步，因为我们编译器设计中的一切都依赖于它。</p><p>那么，让我们从上到下。我们的源文件包含一个程序。什么是程序？我们知道它是变量声明、函数声明和函数定义的列表，例如：</p><p>Int func(char*s，int len)；/*函数声明*/int i；/*变量声明*/int func(char*s，int len){/*函数定义*/...}。</p><p>让我们试着用EBNF的形式把它写下来(如果你不知道什么是EBNF，这是绝对可以的，它真的很直观)：</p><p>这个符号说：“程序是变量声明、函数声明和函数定义的重复序列。但是所有这些描述和定义是什么呢？好的，让我们再深入一点：</p><p>&lt；var-decl&gt；：：=&lt；type&gt；&lt；ident&gt；&#34；；&#34；&lt；func-decl&gt；：：=&lt；type&gt；&lt；ident&gt；&#34；(&#34；&lt；func-args&gt；&#34；)&#34；&#34；；&#34；&#34；&。Ident&gt；&#34；(&#34；&lt；func-args&gt；&#34；)&#34；&lt；func-body&gt；&lt；func-args&gt；：：={&lt；type&gt；&lt；ident&gt；&#34；，&#34；}&lt；type&gt；：：==&#34；int&#34；|&#34。</p><p>因此，变量声明很简单：它是一个类型名称，后跟标识符，再跟一个分号，就像我们在C中通常做的那样，例如：</p><p>函数声明稍微复杂一些。它是一个“类型+标识符”，以及大括号内的函数参数&lt；func-args&gt；的可选列表。</p><p>反过来，函数参数列表是一系列逗号分隔的“类型+标识符”，如下所示：</p><p>实际上，CUCU中的尾随逗号仍然允许，但不是必需的。它只会简化我们的解析器代码。</p><p>支持的数据类型仅为int和char*。标识符是由字母、数字和下划线符号组成的序列。</p><p>只剩下&lt；Func-Body&gt；了。但让我们先来谈谈语句和表达式。</p><p>语句是语言中最小的独立元素。以下是OUT语言中的有效语句：</p><p>/*这些是简单语句*/i=2+3；/*赋值语句*/my_func(I)；/*函数调用语句*/return i；/*return语句*//*这些是复合语句*/if(x&gt；0){..。}其他{.。}While(x&gt；0){..。}。</p><p>表达式是语句的较小部分。与语句相反，表达式始终返回值。通常，这只是一个算术问题。例如，在语句func(x[2]，i+j)中，表达式为x[2]和i+j。</p><p>那么，回过头来看看&lt；Funcc-Body&gt；。它只是一个有效的语句(通常是块语句)。</p><p>&lt；Funcc-body&gt；：：=&lt；语句&gt；&lt；语句&gt；：：=&#34；{&#34；{&lt；语句&gt；}&#34；}&#34；/*块语句*/|[&lt；type&gt；]&lt；ident&gt；[&#34；=&#34；&lt；expr&gt；]&#34；；&。返回&#34；&lt；expr&&gt;；&#34；；|&#34；IF&#34；&#34；(&#34；&lt；expr&&gt;；)&#34；&lt；语句&gt；[&#34；Else&34；&lt；语句&gt；]|&#34；While&#34；&#34；(&#34；&lt；expr&gt；&lt；语句&gt；|&lt；表达式&gt；&#34；；&#34；</p><p>&lt；expr&&gt;；：：=&lt；bit-expr&gt；|&lt；bit-expr&gt；=&lt；expr&&gt;；&lt；bit-expr&gt；：：=&lt；eq-expr&gt；|&lt；bitwise-expr&gt；&amp；&lt；eq-expr&gt；|&lt；bit-expr&gt；Eq-expr&gt；==&lt；rel-expr&&gt;；|&lt；eq-expr&&gt;；！=&lt；rel-expr&&gt;；&lt；rel-expr&gt；：：=&lt；Shift-expr&&gt;&gt;；|&lt；rel-expr&&gt;；&lt；Shift-expr&&gt;；&lt；Shift-expr&gt；：Add-expr&gt；|&lt；Shift-expr&&gt;；&gt；&gt；&lt；add-expr&gt；&lt；add-expr&gt；：：=&lt；Postfix-expr&gt；|&lt；add-expr&gt；+&lt；Postfix-expr&gt；|&lt；add-expr&gt；-&lt；postfix-expr&gt&。[&lt；expr&&gt;]|&lt；后缀-expr&&gt;；(&lt；expr&&gt;；{&#34；，&lt；expr&gt；})&lt；prim-expr&gt；：==&lt；number&gt；|&lt；ident&gt；|&lt；string&gt；|&#34；(&#34；&lt；expr。</p><p>就这样。您注意到表达式表示法中的递归了吗？基本上，上面的符号向我们显示了运算符从下到上的优先顺序：首先计算括号和方括号，最后进行赋值。</p><p>例如，根据此语法，表达式8&gt；&gt；1+1将被求值为2(如8&gt；&gt；(1+1))，而不是5(如(8&gt；&gt；1)+1)，因为&gt；&gt；的优先级低于+。</p><p>现在我们学完了语法，准备开始了。第一件要做的事就是艾拉·莱克瑟。我们的编译器接受字节流作为输入，而lexer允许将该流拆分成更小的标记，以便稍后处理。它为我们提供了一定程度的抽象，并简化了解析器。</p><p>例如，字节序列“int i=2+31；”将被拆分成标记：</p><p>在正常的成人词法分析器中，每个词位(标记)都有一个类型和一个值，因此我们将得到一个配对列表，而不是上面的列表：&lt；type：int&&gt;；，&lt；ID：i&lt；，&lt；Assign：=&&gt;；，&lt；NUM：2&gt；，&lt；plus：+&&gt;；，&lt；NUM：31&gt；，&lt；Semi：；&gt。我们要通过它的值来检测lexemetype，这根本不是学术性的！</p><p>词法分析器的主要问题是，一旦从流中读取了一个字节，它就不能“不可读”。如果我们读取了一个不能添加到当前令牌中的字节，该怎么办呢？在处理当前令牌之前，我们应该将其存储在哪里？</p><p>几乎每个词法分析器都需要提前阅读。我们的语法非常简单，所以我们只需要一个单字节的缓冲区-nextc。它存储一个字节，该字节是从流中读取的，但尚未推送到令牌字符串。</p><p>另外，我需要警告您-我在CUCU代码中经常使用全局变量。我知道这是一种糟糕的风格，但是如果我把所有的值都作为函数参数传递，编译器就会失去它的简单性。</p><p>如果不是标识符-请尝试读取一系列特殊运算符，如&amp；、|、&lt；、&gt；、=、！。</p><p>如果不是运算符-请尝试读取字符串文字“&amp；mldr”。或者“&amp；mldr.”</p><p>如果再次失败-只需读取单个字节。它可能是另一个单字节字符，如“(”或“[&#34；。</p><p>#include&lt；stdio.h&gt；/*对于vpritnf*/#include&lt；stdarg.h&gt；/*对于va_list*/#include&lt；stdlib.h&gt；/*对于exit()*/#include&lt；ctype.h&gt；/*对于isspace，isalpha...。*/#定义MAXTOKSZ 256静态文件*f；/*输入文件*/static char tok[MAXTOKSZ]；static int tokpos；static int nextc；void readchr(){if(tokpos==MAXTOKSZ-1){tok[tokpos]=&#39；\0&#39；；fprintf(stderr，&#34；标记太长：%s\n&#34；，Nextc=fgetc(F)；}void readtok(){for(；；){While(isspace(Nextc)){nextc=fgetc(F)；}tokpos=0；While(isalnum(Nextc)||nextc==&#39；_&#39；){readchr()；}if(tokpos==0){While(nextc==&#39；&lt；&#39。||nextc==&#39；&gt；&#39；||nextc==&#39；！&#39；||nextc==&#39；|&#39；){readchr()；}}if(tokpos==0){if(nextc==&#39；\&#39；&#39；||nextc==&#39){char c=nextc；Readchr()；While(nextc！=c){readchr()；}readchr()；}false if(nextc==&#39；/&#39；){readchr()；if(nextc==&#39；*&#39；){nextc=fgetc(F)；While(nextc！=&#39；/&#39；){While(下一个！=&#39；*&#39；){nextc=fgetc(F)；}}Else if(nextc！=EOF){readchr()；}}Break；}tok[tokpos]=&#39；\0&#39；；}int main(){f=stdin；nextc=fgetc(F)；对于(；；){readtok()；printf(&#34；内标识：%s\n&#34；，tok)；如果(tok[0]==&#39；\0&#39；)Break；}返回0；}。</p><p>如果我们将一个C文件作为编译器输入-它将打印一个令牌列表，每行一个。</p><p>我希望你喜欢这篇文章。你可以在Github、Twitter或通过RSS订阅，并向其投稿。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://zserge.com/posts/cucu-part1/">https://zserge.com/posts/cucu-part1/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/编译/">#编译</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/理解/">#理解</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/compiler/">#compiler</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/expr/">#expr</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1010197.html"><img src="http://img.diglog.com/img/2020/7/thumb_fe5ff336acc9de4afb0853043ce93294.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1010197.html">Go与C#：编译器、运行时、类型系统、模块</a></div><span class="my_story_list_date">2020-7-7 5:42</span></div><div class="col-sm"><div><a target="_blank" href="/story/1010110.html"><img src="http://img.diglog.com/img/2020/7/thumb_88ff4dec58afa367d96369000fda9bc3.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1010110.html">即时编译器速成课程(2017)</a></div><span class="my_story_list_date">2020-7-6 21:19</span></div><div class="col-sm"><div><a target="_blank" href="/story/1009216.html"><img src="http://img.diglog.com/img/2020/7/thumb_ed473defc8c65c73e82fc3ee418156ef.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1009216.html">驯服ClojureScript项目中的高级编译错误</a></div><span class="my_story_list_date">2020-7-1 10:42</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008952.html"><img src="http://img.diglog.com/img/2020/6/thumb_63abb9829dd62f67d526ec3bc01f68e4.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008952.html">铁锈编译缓慢的几个原因</a></div><span class="my_story_list_date">2020-6-30 21:11</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>