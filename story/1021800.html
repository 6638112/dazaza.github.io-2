<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>在Babashka的命令行中使用Clojure</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">在Babashka的命令行中使用Clojure</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-03 02:34:37</div><div class="page_narrow text-break page_content"><p>普通的Clojure代码-可以在REPL中运行，也可以在Babashka的命令行中运行(整个文件可以在这里找到)。</p><p>我从来没有费心去学习Bash，这样我就可以真正流利地使用它了。如果我需要基本的Bash以外的东西，我会立即在命令行脚本中使用Python。</p><p>我目前正在再次实现我的Clojure Simple服务器，这一次使用Integrant库。在这个新版本中，我实现了三个数据存储：CSV、AWS DynamoDB和Postgres。我已经实现了将开发数据导入到DynamoDB(使用Python)，这一次我使用Babashka将开发数据导入Postgres-主要是为了找个借口尝试在用Bash编写脚本时是否可以用Clojure替换Python。</p><p>Babashka真正巧妙的地方在于，您可以将Babashka脚本作为Clojure项目的一部分来开发，也可以独立开发，但使用您最喜欢的Clojure IDE。上图显示了我最喜欢的Clojure IDE(草书)中的Clojure代码。我有将数据导入postgres目录中的postgres数据库的Clojure代码，因此我的dess.edn中有以下额外路径：</p><p>好的是，我可以将Clojure代码作为项目的其他Clojure代码的一部分进行开发。让我们首先创建一个简短的bash脚本，该脚本告诉Babashka使用标志运行Clojure代码，以便我们在使用Babashka或使用Clojure IDE REPL(文件run-bb-load-data.sh)运行代码时在Clojure代码中知道：</p><p>然后，在Clojure代码中，我们在名称空间(文件bb_postgres.clj)中有一个顶级表单(run-me)：</p><p>(defn run-me[]&#34；只有在从设置环境变量的Babashka脚本运行时才加载数据。我们不希望repl在重新加载名称空间时加载数据。在Repl实验中，使用下面的丰富注释。(让[Running-BB？(SYSTEM/getenv&#34；Running_bb&#34；)](if(=Running-BB？&#34；true&#34；)(import-data)(run-me)。</p><p>也就是说，当重新加载名称空间时，REPL运行代码，但是如果没有设置标志，它实际上不会做任何事情-只有当我们使用Babashka运行代码时，它才会导入代码。这样做的原因是，当我将名称空间作为Clojure工作流的一部分重新加载时，我不希望数据导入发生。出于测试导入数据或任何其他功能的开发目的，我在文件末尾有一个丰富的注释：</p><p>(COMMENT(def data-dir&#34；dev-resources/data&34；)(get-raw-products data-dir 2)(get-product-groups data-dir)(do(delete-products！))。(DELETE-PRODUCT-GROUPS！)。(val(Get-Users data-dir))(load-Users(val(Get-Users data-dir)(import-data)(db-get-all-product-group)(db-get-all-products)。</p><p>注释块在这里，当然，这样REPL在重新加载时就不会运行此代码。您在注释块中看到的函数调用只是按不特定顺序添加的实验。我可以单独发送这些表单中的任何一个，以便在REPL中进行评估-这是使用REPL进行开发时的典型Clojure技巧。</p><p>我非常喜欢现在可以在shell脚本中使用Clojure的想法。当然，我也可以在没有Babashka的情况下在shell脚本中使用Clojure，但是JVM引导需要相当长的时间，这使得在命令行中测试脚本有点痛苦。Babashka-Babashka靴子则不是这样闪电般快：</p><p>在我的个人脚本中使用Babashka的用例可能有点类似于我在本练习中使用Babashka将数据导入Postgres数据库：</p><p>(Defn Run-SQL[命令](sh/sh&#34；psql&#34；&#34；--host&#34；&#34；--port&#34；&#34；5532&#34；&#34；--username=simpleserver&#34；&#34；--dbname=simpleserver&#34；&#34；--c&#34；命令)(defn insert-product-group！[product-group](println&#34；insert product-group：&#34；product-group)(让[[id name]product-group命令(str&#34；插入到product_group值中(&#39；&#34；id&#34；&#39；，&#39；&#34；name&#34；&#39；)；&#34；)](run-sql命令)(defn load-product-groups[product-groups](doseq[PG product-group](insert-product-group！Pg)(Defn get-product-groups[data-dir](let[raw(with-open[read(io/read(str data-dir&#34；；/product-groups.csv&#34；))](doall(csv/read-csv read)product-group(into{}(map(fn[[Item]](str/Split Item#&#34；\t&#34；)raw))]product-group)(Defn import-data[](let[data-dir&#34；dev-resources/data&#34；product-group(get-product-groups data-dir)]；...(load-product-group product-group)；...。</p><p>即解析CSV，转换数据，然后使用转换后的数据调用某个程序，可能会读取返回的内容并执行其他操作。您可以使用普通的老式Bash来完成所有这些工作，但是我从来没有费心去学习Bash，因为我可以做的不仅仅是使用Bash测试一些标志和调用其他程序。</p><p>我使用Babashka将开发数据加载到Postgres数据存储中。在开发期间，我构建了一个自定义Postgres映像，并提供了启动数据存储(文件Justfile)的方法：</p><p>Run-docker-pose.sh启动postgres docker容器，创建模式，最后调用./run-bb-load-data.sh将数据加载到开发Postgres数据存储中：</p><p>#！/usr/bin/env bash echo&#34；注意：如果再次运行，记得销毁容器！&#34；echo&#34；starting docker-compose-p ss-postgres-f docker-compose-p ss-postgres-f docker-compose-setup-local-postgres.yml up-d睡眠5 echo&#34；创建简单服务器架构...&#34；./create-schema.sh睡眠1 echo&#34；正在加载数据...&#34；./run-bb-load-data.sh睡眠1docker日志-f ss-postgres_postgres_1。</p><p>最后，让我们在执行一些Linux shell脚本时比较Python和Clojure(Babashka)。</p><p>轻松自在。如果您使用过这两种语言，那么它们都非常容易和快速地工作。开发Python脚本非常快-您只需在命令行中运行脚本即可。使用Clojure还有一个额外的好处：您可以使用Clojure REPL。</p><p>库支持：Python胜出。当您使用Python编写脚本时，您意识到使用某个AWS库(例如table_importer.py-AWS boto3库)会很好。当然，对Babashka的库支持并不广泛--但是Babashka支持clojure.core之外的相当多的名称空间，还有一些附加库：Babashka内置的名称空间--请关注该页面，也许Babashka库支持在未来会不断增长！</p><p>因此，库支持可能不如Python好。但是我真的很喜欢Clojure，如果我用Clojure实现应用程序，用Babashka编写一些特别的脚本真的很不错。</p><p>在我的工具箱中有另一个脚本工具很好：Babashka。时间会告诉我，多亏了Babashka，我是否会开始使用Clojure而不是Python作为我的首选脚本语言。至少在这次练习中，巴巴什卡做得很好。</p><p>作者在Metosin工作，在云项目中使用Clojure。如果您有兴趣在芬兰开始一个Clojure项目，或者有兴趣在芬兰接受Clojure培训，您可以通过发送电子邮件到我的Metosin电子邮件地址或通过LinkedIn联系我。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.karimarttila.fi/clojure/2020/09/01/using-clojure-in-command-line-with-babashka.html">https://www.karimarttila.fi/clojure/2020/09/01/using-clojure-in-command-line-with-babashka.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/babashka/">#babashka</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/command/">#command</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/clojure/">#clojure</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>