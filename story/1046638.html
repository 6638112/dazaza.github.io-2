<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>在sudo中模糊最近的缓冲区溢出将花费多长时间？ </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">在sudo中模糊最近的缓冲区溢出将花费多长时间？ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-29 13:13:44</div><div class="page_narrow text-break page_content"><p>在经历了最近的sudo漏洞之后，我被问到了一个显而易见的问题：如何在近10年内不注意到这种事情？它们真的很难找到，不太可能被模糊发现还是没人尝试过？</p><p> 我很好奇是否可以在合理的时间内使用著名的afl模糊器发现此错误。</p><p> 首先，显然sudo是setuid二进制文件。以root用户身份随机输入运行潜在的错误二进制文件不是最安全的方法。为了避免任何潜在的意外系统损坏，我为此设置了一个新的虚拟机，为此测试选择了sudo 1.9.5.p1。 afl旨在将输出生成到fileor stdout中，但是我们要模糊命令行参数。因此，我们需要自行修补sudo，以忽略实际的argv并改为从stdin加载它。</p><p> 尽管作者本人并不确定这样做是否有用，但afl来源有助于在argv-fuzz-inl.h中提供适当的功能：</p><p> AFL不支持argvfuzzing，因为TBH在实践中并不是非常有用。在experimental / argv_fuzzing /中有一个示例，显示了如果您确实想在一般情况下如何执行此操作。</p><p>  argv-fuzz-inl.h提供的示例从stdin读取NUL分隔的参数。请注意，sudo在单个二进制文件中同时提供了sudo和sudoedit实用程序，因此要测试这两者，我们还需要将fuzzer argv [0]公开。 argv-fuzz-inl.h中的代码不执行此操作，因此需要对其进行修复：</p><p>   --- a / src / sudo.c +++ b / src / sudo.c @@ -66,6 +66,8 @@ #include＆＃34; sudo_plugin.h＆＃34; #include＆＃34; sudo_plugin_int.h＆＃34; +＃include＆＃34; argv-fuzz-inl.h＆＃34; + / * *局部变量* / @@ -149,6 +151,7 @@ sudo_dso_public int main（int argc，char * argv []， char * envp []）; int main（int argc，char * argv []，char * envp []）{+ AFL_INIT_ARGV（）; int nargc，状态= 0； char ** nargv，** env_add，** user_info; </p><p>快速测试表明，从stdin传递的测试用例中，sudo / sudoedit选择不能正常工作，因为出于某种原因，它使用__progname。快速解决方法：</p><p> --- a / lib / util / progname.c +++ b / lib / util / progname.c @@ -83,7 +83,7 @@ void initprogname2（const char *名称，const char * const *允许）{int i;-＃ifdef HAVE ___ PROGNAME +＃如果0 extern const char * __ progname;如果（__progname！= NULL＆amp;＆amp; * __ progname！=＆＃39; \ 0＆＃39;）</p><p> 最后，我们不想等待密码输入，因此只需使其无条件失败即可：</p><p> --- a / plugins / sudoers / auth / sudo_auth.c +++ b / plugins / sudoers / auth / sudo_auth.c @@ -259,7 +259,7 @@ verify_user（struct passwd * pw，char * prompt，int validated ，＆＃34;-禁用身份验证配置选项。＆＃34;））; debug_return_int（-1）; }-+返回0； / *在密码输入期间启用挂起。 * / sigemptyset（＆amp; sa.sa_mask）; sa.sa_flags = SA_RESTART;</p><p> 由于某种原因afl-gcc工具无法使用，因此我使用了基于LLVM的工具。我们只需要为./configure覆盖CC：</p><p>    准备就绪后，我以并行模式启动了四个afl实例。半小时后，出现一个实例…</p><p>   debian @ debian：〜/ fuzz $ xxd sync_dir / fuzz3 / crashes / id：000000，sig：06，src：000561，op：havoc，rep：200000000：7375 646f 6564 6974 002d 7320 2d20 8052 sudoedit.-s-.R00000010 ：202d 7320 ff20 8001 0073 2073 20ff 2080 -s。 ...的.00000020：0100 7320 2d35 8080 ff20 8001 0073 202d ..s -5 ... ... s -00000030：0880 80f8 3f2d 7320 2d20 802d 7320 2d20 ....？-s-.-s-00000040：803b 202d 7320 ff20 8001 0073 202d 2080。; -s。 ... s-.00000050：8080 3b39 9573 20ef 2080 806a 8000 7f80 ..; 9.s。 ..j .... 00000060：3b20 2d73 202d 2080 8020 3995 7320 ef09; -s-.. 9.s ..00000070：8080 6a80 007f 803b 202d 7320 2d20 8080 ..j ....; -s-..00000080：3bf6 202d 732d 7320 2d20 8052 202d 7320;。 -s-s-.R -s 00000090：ff20 2d35 8080 ff20 8001 0073 202d 0880。 -5 ... ... s-.. 000000a0：80f8 3f2d 7373 202d 2080 8080 3b39 9573 ..？-ss-...; 9.s000000b0：20ef 2080 806a 8000 7f80 3b20 2d73 202d。 ..j ....; -s -000000c0：2080 8020 3995 7320 ef09 8080 6a80 007f .. 9.s .... j ... 000000d0：803b 202d 7320 2d20 8080 3bf6 202d 732d。; -s-..;。 -s-000000e0：7320 2d20 8052 202d 7320 ff20 8001 0073 s-.R -s。 ... s000000f0：202d 3580 80ff 2080 0100 7320 2d08 8080 -5 ... ... s -... 00000100：f83f 2d73 202d 2080 2d73 202d 2080 3b20。？-s-.-s-。; 00000110：8000 7f80 3b20 2d73 202d 2080 803b f620 ....; -s-..;。 00000120：2d73 202d 2080 3b20 2d73 20ff 2080 0100 -s-。 -s。 ... 00000130：7320 2d20 8064 f83f 2d73 202d 2080 803b s-.d。？-s-..; 00000140：392d 8054 8080 8080 5c20 2d74 202d 2680 9-.T ....-t-＆amp ;. 00000150：0100 80 ... </p><p>当然，这是利用sudoedit -s崩溃的原因。 假设我并行运行4个实例，标题中的问题答案是：大约2小时的CPU时间。  是的 2小时的CPU时间足以在广泛使用的setuid实用程序中找到严重的安全漏洞。  在过去的十年中，没有人对sudo感到困惑吗？或者，也许sudo经过了测试但被遗忘了sudoedit？（老实说，在此之前，我不知道sudoedit存在）。 我想得出的结论是，快速使用模糊测试程序可以发现广泛使用的实用程序中仍然存在严重的错误。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://milek7.pl/howlongsudofuzz/">https://milek7.pl/howlongsudofuzz/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/溢出/">#溢出</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/fuzz/">#fuzz</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/sudo/">#sudo</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1045750.html"><img src="http://img2.diglog.com/img/2021/1/thumb_b77fa0b00ab08178a69f75b91b272a22.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1045750.html">堆栈溢出的力量 </a></div><span class="my_story_list_date">2021-1-22 15:25</span></div><div class="col-sm"><div><a target="_blank" href="/story/1026087.html"><img src="http://img2.diglog.com/img/2020/9/thumb_c72a4bdf84c77ccc3eff0558d5edc17a.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1026087.html">在C++中整数溢出陷阱的开销有多大？</a></div><span class="my_story_list_date">2020-9-24 14:18</span></div><div class="col-sm"><div><a target="_blank" href="/story/1023492.html"><img src="http://img2.diglog.com/img/2020/9/thumb_b24c7e643cb8dd20ac659d923b512966.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1023492.html">堆栈溢出正在为团队购买评论</a></div><span class="my_story_list_date">2020-9-12 8:16</span></div><div class="col-sm"><div><a target="_blank" href="/story/1016153.html"><img src="http://img.diglog.com/img/2020/8/thumb_3cf11483891a9fc23a4c96f0bf5dd58c.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1016153.html">数学溢出用户解决博士论文危机</a></div><span class="my_story_list_date">2020-8-4 22:6</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>