<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>用Yubikeys保护我的个人SSH基础结构 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">用Yubikeys保护我的个人SSH基础结构 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-02-09 21:35:27</div><div class="page_narrow text-break page_content"><p>我在一月份的“现在”帖子中提到的一个最近完成的项目是使用Yubikeys在我的个人计算基础结构中锁定SSH。在这篇文章中，我将概述我的目标，我采取的策略以及在此过程中遇到的问题和解决方案。</p><p>  从历史上看，我在个人项目中使用了非常基本的SSH设置：每台笔记本电脑/台式机/服务器上的用户帐户在〜/ .ssh中都有自己的密钥，并且我会尝试在所有服务器上保留authorized_keys列表或多或少是最新的。这带来了许多明显的安全问题。</p><p> 我想确保，如果攻击者获得对我一台服务器的访问权限，则他们将无法使用该访问权限转移到我控制的任何其他计算机上。为此，我转而使用一些Yubikeys来存储我的SSH密钥。不再在任何服务器上存储关键材料，以防假想的攻击者窃取。 Yubikey要求提供PIN，因此这是两因素身份验证的示例：我实际拥有的东西和我知道的东西。</p><p> SSH代理转发用于允许我从一台服务器SSH到另一台服务器，或从远程服务器上的GitHub获取代码。</p><p> 我使用私有Git存储库在计算机之间同步SSH配置（包括authorized_keys），并使用模块化本地配置系统使我能够快速启用仅适用于我的计算机子集的常用SSH配置块。</p><p>   使用Yubikeys存储SSH密钥需要yubikey-agent。进行设置非常简单；真正的工作是弄清楚如何解决我以后遇到的各种困难。</p><p> （此标题下的命令和配置更改适用于带有附加的Yubikey的客户端计算机。） </p><p>设置SSH_AUTH_SOCK环境变量（在.bashrc或.zshrc中执行此操作）。在我的dotfile中，我首先检查是否已安装yubikey-agent，然后继续：</p><p>  通过为〜/ .ssh / config中的主机块添加ForwardAgent yes，为特定的受信任主机启用SSH代理转发（不要为所有主机启用它，这是一个潜在的安全问题）。一个完整的示例可能如下所示：</p><p>  在本博文后面的内容中，这可能会破坏一些话题，但我们还将其添加到〜/ .ssh / config中：Host * IdentityAgent /usr/local/var/run/yubikey-agent.sock</p><p> 这允许从终端外部启动的应用程序（例如GUI Git客户端Fork.app）查找并使用yubikey-agent。</p><p>  我想使用新的macOS应用程序Secretive，该应用程序将SSH密钥存储在较新的MacBooks上的Secure Enclave中，并且需要Touch ID进行身份验证。不幸的是，由于Reasons™，我仍在使用macOS Mojave，Secretive需要Catalina或Big Sur。我计划尽快迁移到Big Sur，因为我想在16英寸型号发布时得到M1 MacBook Pro，所以我将能够尽快尝试Secretive。 （值得注意的是，这会改变安全模型，因为第二个因素是生物特征而非PIN，但仍然是两个因素。）</p><p>  我将〜/ .ssh目录保存在一个私有Git存储库中，但有几个重要的例外（永不提交键！）。这使我可以轻松地在系统之间同步配置和authorized_keys更改。我在cdzombak / ssh-example中创建了一个简化版本，您可以将其用作自己设置的基础。</p><p>  authorized_keys是您在Yubikeys上添加与新的专用SSH密钥关联的公共密钥的位置。 </p><p>在config中，您将为服务器添加主机块。在顶部，它设置了我多年来积累的一些SSH最佳实践。</p><p> fix-permissions.sh确保〜/ .ssh / authorized_keys和〜/ .ssh / rc具有正确的权限。我从存储库中拉出后运行它；如果导致任何更改，则应更正存储库中文件的权限。</p><p> 通过SSH登录到计算机后，rc会运行。在这种情况下，它将更新〜/ .ssh / sock中的符号链接以指向新的SSH代理套接字。有关为什么需要这样做的说明，请参见下面的“长时屏幕会话”部分。</p><p> config.templates /包含SSH配置块，可以将其包含在给定的计算机上，但不应在所有地方都包含。其中最重要的是yubikey-agent，启用后将如上所述将IdentityAgent设置为yubikey-agent套接字；还有homedir-ssh-auth-sock，它将SSH登录后将IdentityAgent设置为rc创建的symlink。在任何给定的计算机上，我都启用这两种配置中的一种，并且仅启用其中一种，具体取决于它是连接了Yubikey的客户端计算机还是依赖于代理转发来进行任何SSH连接的服务器。</p><p> config.local /被config包含，被Git忽略。我可以从此处将符号链接添加到config.templates中，以在计算机上启用特定的SSH配置块。</p><p> 最后两个-config.local和config.templates-很重要，因为这就是我在不同机器之间实现SSH配置变化的方式。自述文件介绍了如何在给定计算机上启用配置模板。</p><p>   我将GNU屏幕用作终端多路复用器，并在SSH会话之间提供了持久性。这是SSH代理转发的问题：当我第一次SSH并启动屏幕会话时，将设置SSH_AUTH_SOCK环境变量。但是，当我从其他地方登录并重新连接到屏幕会话时，SSH_AUTH_SOCK环境变量将不会得到更新，因此在启动新的屏幕会话之前，SSH代理转发已中断。 </p><p>要点帮助我解决了这种情况。此解决方案有几部分。 （此标题下的命令和配置更改适用于您将通过SSH连接到的服务器。）</p><p> 首先，我们必须为我们的SSH代理套接字提供一个位置，该位置在两次登录之间不会更改。 〜/ .ssh / rc中的以下几行实现了这一点：</p><p>  大！然后，我们只需要客户端使用此新的，始终更新的套接字即可。为此，我们配置〜/ .screenrc来设置环境变量SSH_AUTH_SOCK：</p><p>  最后，我们还希望在我们的SSH配置中包含IdentityAgent〜/ .ssh / sock / ssh_auth_sock。为此，我们可以在模块化SSH配置设置中包含homedir-ssh-auth-sock配置块：</p><p>   使用sudo运行命令时，您正在新环境中工作；您用户的环境变量不会保留。当然，这将破坏SSH代理转发。</p><p> 为了解决这个问题，我们想在使用sudo时保留SSH_AUTH_SOCK环境变量。 （此标题下的命令和配置更改适用于您将通过SSH连接到的服务器。）</p><p>   这意味着，当使用sudo以root用户（而不是任何其他用户）身份运行命令时，SSH_AUTH_SOCK变量保持不变，并且代理转发按预期工作。 </p><p>Fork应用程序的问题跟踪器中的此问题在这里确实很有帮助。 .bashrc和.zshrc不适用于GUI应用程序（除非您从终端启动它们），因此仅在外壳配置文件中设置SSH_AUTH_SOCK无效。</p><p> 这就是为什么我们在SSH配置中需要IdentityAgent /usr/local/var/run/yubikey-agent.sock。要在我的模块化SSH配置设置中启用此功能，请执行以下操作：</p><p>    设置好之后，我的Yubikey会定期闪烁，好像我尝试通过SSH进行连接一样，但是我没有尝试使用SSH做任何事情！这令人担忧，直到我意识到那只是Fork试图在后台更新存储库信息。</p><p> 我决定在笔记本电脑上将Git配置为在与GitHub和Bitbucket通信时使用HTTPS而不是SSH，因此Fork可以根据需要在后台工作。</p><p> 为此，我们将以下内容添加到〜/ .gitconfig。 （此更改适用于您希望Git使用HTTPS而不是SSH的任何Mac。）</p><p> [url＆＃34; https：//＆＃34;]代替Of = git：// [url＆＃34; https：//github.com/&#34;]代替Of = git@github.com：[url ＆＃34; https：//bitbucket.org/&#34;]代替Of = git@bitbucket.org：[凭据] helper = osxkeychain</p><p> 现在，当您首次尝试对GitHub或Bitbucket存储库执行Git操作时，Git将提示您输入凭据： </p><p>对于GitHub，您的密码是具有回购范围的Personal Access Token。对于Bitbucket，您的密码是具有存储库/写入和存储库/读取权限的应用程序密码。</p><p>   我确实有一个用例，其中一台服务器需要使用SSH上的rsync定期将数据同步到另一台服务器，这意味着不需要物理，实时交互的Yubikey。</p><p> 为此，接收服务器具有受限制的用户帐户，该帐户仅允许访问必要的数据。启动同步的发送服务器具有SSH密钥，该密钥仅用于此任务；并且只能登录到接收服务器上的受限用户帐户。</p><p> 为了获得额外的中等安全性（这仍然不是真正的第二要点），接收服务器会使用其authorized_keys文件中的from指令来限制SSH密钥可以登录的IP地址。有关更多详细信息，请参见将SSH登录限制为特定的IP地址和为OpenSSH配置授权密钥。</p><p>  当笔记本电脑不方便使用时，我偶尔会在iPhone上使用提示2。该应用程序生成自己的SSH密钥，该密钥存储在iPhone中（不在Panic Sync中存储），我将相应的公共密钥添加到SSH配置存储库中的authorized_keys中。</p><p> 我认为这是相当安全的，因为密钥保留在我的手机上，并且固定在Face ID＆amp; iPhone的PIN码，这意味着必须满足两个因素：我拥有的东西和其中之一（生物统计学或我知道的东西）。</p><p> Secure ShellFish也有类似的故事。我用它来远程访问家庭NAS上的文件。在这种情况下，Secure ShellFish的SSH密钥实际上仅允许以有限的权限登录到NAS上的用户帐户。它没有添加到我的“核心” SSH配置中。 </p><p>如果所有其他Yubikey丢失或毁坏，则另外的Yubikey可以住在防火保险箱中，以帮助恢复。  我现在暂时不理会。 我什至只经常使用一台Windows计算机，而无需使用SSH进行任何操作。 很高兴了解支持Yubikeys或Google Titan安全密钥的SSH代理解决方案，但我没有动力自己进行这项工作。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.dzombak.com/blog/2021/02/Securing-my-personal-SSH-infrastructure-with-Yubikeys.html">https://www.dzombak.com/blog/2021/02/Securing-my-personal-SSH-infrastructure-with-Yubikeys.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/保护/">#保护</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/personal/">#personal</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ssh/">#ssh</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1046226.html"><img src="http://img2.diglog.com/img/2021/1/thumb_9e5d443d7975edc2bba73640592207e5.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1046226.html">欧盟必须保护隐私权，而不是攻击端到端加密 </a></div><span class="my_story_list_date">2021-1-28 22:27</span></div><div class="col-sm"><div><a target="_blank" href="/story/1044872.html"><img src="http://img2.diglog.com/img/2021/1/thumb_4e0a2ccb76ffc9292880e32105fb2186.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1044872.html">尼尔·阿姆斯特朗（Neil Armstrong）在月球上的脚印现在受美国法律保护 </a></div><span class="my_story_list_date">2021-1-18 19:34</span></div><div class="col-sm"><div><a target="_blank" href="/story/1042727.html"><img src="http://img2.diglog.com/img/2021/1/thumb_b5a1b79cf5879aa71093c4d203477ac6.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1042727.html">鲨家庭在旅途中寻找美食 </a></div><span class="my_story_list_date">2021-1-1 8:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030936.html"><img src="http://img2.diglog.com/img/2020/10/thumb_931e0e1fbebc366fd726138a2e8a0e4d.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030936.html">我们必须动员起来，避免一个孤独的地球</a></div><span class="my_story_list_date">2020-10-24 15:27</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>