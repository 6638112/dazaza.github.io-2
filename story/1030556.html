<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>用saltssh替换ansible</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">用saltssh替换ansible</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-22 22:34:12</div><div class="page_narrow text-break page_content"><p>直到最近，我还一直使用Ansible来管理这台机器(或机器)。我想要在该机器上进行配置管理，这样，如果某个磁盘、VM或整个主机提供商消失，我会有一个神奇的按钮，可以从无到有开始重建，抓起一杯咖啡，然后让一切恢复原样。我想要Ansible来完成这项任务，因为它相当容易和容易接近，只需要从主机系统访问SSH就可以了，而且是用Python编写的。不像Pupet、Chef、CFEngine和SaltStack-或者我是这么认为的--我想要Ansible来完成这项任务，只需要从主机系统访问SSH就可以了，而且是用Python编写的。不像Pupet、Chef、CFEngine和SaltStack-或者我是这么认为的。</p><p>随着使用Ansible的时间的推移，我注意到当我对剧本进行更改时，我反复面临着相同的挑战：要么我运行整个剧本并等待许多事实上的无操作任务，要么我投资于使用标签进行注释，节省了一些运行时间，但需要解决标签在Ansible中存在的缺点。</p><p>Ansible中的标记有两个困扰我的问题。首先，您需要手动将相同的标记传播到所有依赖项任务，特别是在When-Condition中引用的任务，否则您将遇到未定义变量的问题，因为应注册该变量的任务尚未执行。因此，这是我必须手动处理的问题。</p><p>其次，标签和循环在Ansible中不能很好地协同工作。我想做的是将迭代项用作标签，如下所示：</p><p>-hosts：所有任务：-name：安装发行版软件包Package：name：&#34；{{item}}&#34；state：Present with_list：-git-htop标记：#NOTE NOT WORK！#GETS OUT OUT：ERROR！&#39；Item&#39；未定义-&#34；{{Item}}&#34；</p><p>不幸的是，这会导致错误！&#39；项目&#39；未定义，因为标签不支持Ansible中那样的循环。撇开引入新变量不谈，从概念上讲，我唯一的选择是将项目列表复制到标签中：</p><p>-hosts：所有任务：-name：安装发行版软件包：name：&#34；{{item}}&#34；state：Present with_list：-git-htop标记：#works，但不是Cool-git-htop。</p><p>如果我现在请求这些标记中的任何一个，我也需要允许整个循环运行，这意味着在没有任何附加值的情况下等待。我正在请求Ansible安装大约20个软件包，所以这里在运行时会有相当大的浪费。</p><p>我不想在大多数时间里解决标签的这些缺点，所以我在那段时间里开始了多任务处理，执行了整个剧本，当有结果的时候，我又回到了它的位置上。</p><p>然而，我很难接受另一件事：当我连续两次运行剧本时，对于第二次运行，Ansible将需要大约4分钟的时间来确认所有的工作都已经完成。为什么？我必须接受它是那么慢吗？</p><p>所以我开始寻找提高Ansible速度的方法，以及SSH流水线，禁用事实收集，Mitgen有所帮助，但不会使运行时间低于3分钟，所以我不是很高兴。顺便说一句，Mitogen在撰写本文时不支持Ansible&gt；=2.10，因此速度的提高将以在过去使用Ansible 2.9的时间更长为代价，这也不是很理想。(这也不是很理想)。</p><p>所以我接受了3分钟作为该攻略的最短运行时间，并开始考虑到其他地方寻找。</p><p>也许Salt有办法摆脱那些奴才、主人、守护程序和代理，这些似乎是我几年前在上一份工作中与SaltStack做过的事情。让我高兴的是，这一次我确实发现了salssh。saltssh是在2013-09-26发布的Salt 0.17.0中引入的，它实际上并不是新的。</p><p>我可以把我现有的Ansible攻略移植到Salt-ssh上吗？它会有趣并且工作得很好吗？当它实际上不需要做任何事情的时候，它会比3分钟更快吗？</p><p>为基于Caddy的SSL反向代理创建特定的Docker网络以与网站容器对话。</p><p>配置并激活DNF-Automatic，以便在Tracer检测到需要时自动更新软件包、重新启动过时的服务并重新启动虚拟机</p><p>调整systemd解析的配置以不再向世界公开LLMNR端口5355，而无需。</p><p>通过调整内核命令行并重新创建GRUB配置以使更改生效，将Docker的cgroup降级为v1。</p><p>克隆一些包含docker-compose网站项目的Git存储库，并使它们与上游保持最新。</p><p>启动多个基于docker-compose的服务，并在其底层Git克隆更改时让它们进行重建和重新启动。</p><p>我开始阅读官方的无代理Salt：入门指南，但很快就卡住了。我想以非特权用户的身份执行，但是尽管详细遵守了教程，我还是收到了无法写入/var/cache/的错误-出于很好的原因-如下所示：</p><p>#salt-ssh&#39；*&#39；test.ping[错误]无法呈现花名册文件：traceback(最近一次调用)：[..]。权限错误：[错误13]权限被拒绝：&#39；/var/cache/salt/master/roots/mtime_map&#39；</p><p>虽然文档使用的是绝对路径，如/home/volant/salt-ssh/Everywhere，但我希望在任何地方都能与Git存储库一起使用的相对路径，更不用说教程中的log_file需要是ssh_log_file。</p><p>过了一段时间之后，所有这些都解决了，这个最小的设置就满足了所有这些要求：以非特权用户身份执行、在root_dir：.帮助下的相对路径、通过state_output_diff：true显著降低噪音的输出，以及开始添加类似剧本的内容的位置。鸟瞰：</p><p>#树。├──Master├──Column│：├──data.sls│：└──top.sls├──花名册├──SALT│：└──setup.sls└──saltfile。</p><p>有了它作为基础，我现在可以将剧本移植到一个新文件salt/setup.sls中。</p><p>例如，让调整Open SSH服务器配置以了解我的公钥(我将存储在salt/ssh/files/Authorized-key-root.txt)，禁用基于密码的登录(以防止暴力登录尝试)，并确保服务器使用调整后的配置：</p><p>Ssh-daemon：#为根ssh_auth.Present设置SSH公钥：-user：root-source：salt：//ssh/files/Authorized-key-root.txt#禁用基于密码的SSH文件登录。keyvalue：-name：/etc/ssh/sshd_config-key：PasswordAuthentication-value：&#34；no&#34；-分隔符：&#34；&#34；-unComment：&#34；#&#34；-要求：-ssh_auth：ssh-daemon#重新启动sshd服务以应用配置服务中的更改。运行：-name：sshd-reload：true-watch：-file：ssh-daemon。</p><p>#sal.ssh&#39；*&#39；test.ping#salt-ssh&#39；*&#39；grains.item#salt-ssh&#39；*&#39；state.Apply setup test=True#salt-ssh&#39；*&#39；state.Apply setup。</p><p>我大概花了一天半的时间把整本剧本搬到盐湖，并对结果充满信心。它给我带来了什么？</p><p>显著缩短运行时间：从使用Ansible的3-4分钟降至使用salt-ssh的约1分钟。</p><p>在状态依赖关系和执行顺序方面有更大的灵活性(但也有一定的责任</p><p>能够在攻略(状态文件)中正确使用JJJA模板，这与Ansible不同。</p><p>我认为这是公平的说，我现在认为我自己是一个盐-ssh的皈依者：新的设置不再是我所能接受的，而是salt-ssh。</p><p>我真正希望的是SaltStack在修复错误方面做得更好。我在3001.1版本中遇到的所有问题和限制都与我认为足够主流的功能有关，考虑到社区的规模，我甚至不应该看到这些功能。</p><p>我希望这些不是SaltStack结构性问题的迹象。VMware在2020年9月收购了SaltStack，所以我希望这会是最好的结果。一旦我确信我不会浪费时间，我很高兴能帮上忙。</p><p>有关使用Salt-ssh取代Ansible的更多信息，您可能会对Duncan Mac-Vicar P.；的文章“像Ansible一样使用Salt”感兴趣。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.hartwork.org/posts/replacing-ansible-with-salt-ssh-for-speed-and-for-good/">https://blog.hartwork.org/posts/replacing-ansible-with-salt-ssh-for-speed-and-for-good/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/替换/">#替换</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ansible/">#ansible</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ssh/">#ssh</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1021099.html"><img src="http://img.diglog.com/img/2020/8/thumb_acbf005225bb769e4fe1a757f81c4864.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1021099.html">我们用存储类内存替换了固态硬盘。以下是我们了解到的情况</a></div><span class="my_story_list_date">2020-8-29 14:4</span></div><div class="col-sm"><div><a target="_blank" href="/story/1010319.html"><img src="http://img.diglog.com/img/2020/7/thumb_06e7669ae9c5660f1da0f227a89d078e.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1010319.html">
Instagram在新的全球测试中用“Shop”替换了“Activity”选项卡</a></div><span class="my_story_list_date">2020-7-7 21:19</span></div><div class="col-sm"><div><a target="_blank" href="/story/1009654.html"><img src="http://img.diglog.com/img/2020/7/thumb_49c2f874abe68d59cc87f87c718c1f33.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1009654.html">推特正在取消诸如“主”和“从”这样的编码术语。</a></div><span class="my_story_list_date">2020-7-3 20:58</span></div><div class="col-sm"><div><a target="_blank" href="/story/1005773.html"><img src="http://img.diglog.com/img/2020/6/thumb_7cf484ceeae6bc7fc2161eddc603cd15.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005773.html">替换相似性</a></div><span class="my_story_list_date">2020-6-9 7:29</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>