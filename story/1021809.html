<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>AWS标签最佳实践：使用Terraform和CloudForment强制实施标签</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">AWS标签最佳实践：使用Terraform和CloudForment强制实施标签</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-03 03:45:16</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/9/7986e48c29541c15782c858b018db864.jpg"><img src="http://img2.diglog.com/img/2020/9/7986e48c29541c15782c858b018db864.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>一旦您采用了AWS标记策略，您将需要确保您现有的所有AWS资源以及您创建的任何新资源都遵守该策略。一致性是关键-如果您不主动执行您的AWS标记策略，您将总是在追赶和追赶团队成员，以确保他们向其资源添加正确的标记。</p><p>虽然您可以使用AWS CLI或AWS Tag Editor手动将AWS标记应用于您的资源，但您可能会发现这在规模上很麻烦且容易出错。更好的方法是自动将AWS标签应用于您的资源，并使用规则强制其一致使用。</p><p>根据您用来在AWS上维护基础设施的工具，您在新资源上主动实施AWS标签的方法可能会有所不同。在本指南中，我将重点介绍两个工具：TerraForm和AWS CloudForment。您将了解如何使用每个标签来创建和更新资源上的AWS成本分配标签，然后强制正确使用新资源的特定标签。通过主动实施您的AWS标记策略，您将最大限度地减少审核和更正不正确的AWS标记所花费的时间，并迫使开发人员了解适合您环境的最佳AWS标记最佳实践。</p><p>我将介绍的第一个基础设施管理工具是Terraform。TerraForm可与各种云托管提供商协作，帮助您调配和维护您的AWS资源。使用Terraform，您可以用代码定义您的服务器、数据库和网络，并以编程方式将您的更改应用到您的AWS帐户。</p><p>如果您是Terraform的新手，他们在GitHub上有一个文档齐全的入门指南和几个AWS模板示例。在本节中，我将向您展示GitHub上提供的演示Terraform项目和模块的一些片段。您将在此Terraform AWS标签中了解以下内容：</p><p>如果要使用Terraform部署具有AWS标签的EC2实例，则您的配置可能包括以下内容：</p><p>Resource&#34；aws_instance&#34；&#34；cart&#34；{connection{type=&#34；ssh&#34；user=&#34；ubuntu&#34；host=self.public_IP private_key=file(var.private_key_path)}instance_type=&#34；t2.micro&#34；AMI=var.aws_amis[var.aws_region]key_name=aws_key_pair.auth.key_name vpc_security_group_ids=[aws_security_group.default.id]子网id=aws_subnet.default.id Provisioner&#34；remote-exec&#34；{inline=[&#34；sudo apt-get-y update&#34；，&#34；sudo apt。，]}标签={Contact=&#34；j-mark&#34；env=&#34；dev&#34；service=&#34；cart&#34；}}。</p><p>上面的示例包括三个AWS成本分配标记：Contact、env和service，值描述为字符串。应用此配置时，Terraform将连接到AWS并部署具有您指定的AWS标签的EC2实例。</p><p>TerraForm使得使用AWS标签以可逆且一致的方式更新现有资源变得容易。如果您使用AWS标记来跟踪资源的联系人(例如，上例中的J-mark)，则可能需要在团队成员离职或更换角色时更新AWS标记。</p><p>要更新资源上的AWS标记，只需在您的Terraform配置中更新相应的标记即可。新标记将覆盖以前分配给资源的任何标记，包括添加到Terraform外部的标记。</p><p>例如，要更改上面EC2实例上的联系成本分配标记，您可以使用以下内容更新上面的标记块：</p><p>当您应用此配置时，AWS标签将在AWS控制台中自动更新：</p><p>如果您将您的Terraform配置文件保存在版本控制中(这可能是一个好主意)，您将能够看到标签是如何随着时间的推移而改变的。您还可以使用与应用程序代码相同的代码审查过程来审查更改，以帮助您捕获标记策略执行过程中的错误。</p><p>随着基础设施的发展，代码审查过程可能不足以防止不正确的AWS标记。幸运的是，您可以在Terraform中使用变量和自定义验证规则强制执行AWS标记名和值。</p><p>在上面的示例中，标记列表被硬编码到EC2实例定义中。更具伸缩性的模式是将EC2实例模板拆分成自己的模块，并使用标记变量。然后，您可以编写自定义验证规则来检查标记是否符合您的策略。</p><p>变量&#34；标签&#34；{description=&#34；此资源的标签。&#34；验证{Condition=Length(var.tag)&gt；0&amp；&amp；包含([&#34；j-mark&#34；，&#34；l-duke&#34；]，var.tags.Contact)&amp；&amp；var.tags.env！=null&amp；&amp；包含([&#34；cart&#34；，&#。，&#34；Cart：Search&#34；]，var.tags.service)ERROR_MESSAGE=&#34；应用的资源标签无效。&#34；}}</p><p>现在，当您运行带有缺失或无效标签的Terraform Plan时，会出现错误：</p><p>您的规则可以在Terraform的配置语言允许的范围内尽可能复杂，因此regex()、substr()和DISTINCT()等函数都是可用的。这就是说，对这种方法有一些警告。</p><p>首先，自定义变量验证是Terraform中的一个实验性特性。实验要素可能会发生变化，这意味着您可能需要密切关注Terraform更新规则。要启用VARIABLE_VALIDATION，请将以下内容添加到您的Terraform块中：</p><p>其次，Terraform的变量验证仅在基础设施生命周期的Terraform规划阶段进行。它不能防止用户直接在AWS控制台中意外更改您的标签，而且效果取决于您编写的验证规则。如果您开始使用新资源，但忘记添加验证规则，最终可能会得到许多不符合您的标记策略的资源。</p><p>付费Terraform Cloud客户的另一个选择是Sentinel，它允许您为您的资源创建自定义策略。我不会在这里介绍此方法，但是Terraform已经创建了一个示例策略来向您展示如何强制执行强制AWS标签。</p><p>与Terraform类似，AWS CloudFortification允许您根据配置文件调配AWS资源。与Terraform不同，CloudForment是亚马逊产品的一部分，因此如果您想使用其他基础设施提供商，它不一定会对您有所帮助。在CloudFortification中标记资源的方法类似于Terraform使用的方法，但是正如您将看到的，配置格式是不同的。</p><p>如果您不熟悉AWS CloudFortification，亚马逊的官方演练将帮助您开始部署一些基本模板。在本节中，我将向您展示演示AWS CloudFortification模板中的一些片段，该模板也可以在GitHub上获得。您将在此Terraform AWS标记部分了解以下内容：</p><p>AWS CloudForment旨在使用单个模板文件轻松创建AWS资源。使用CloudFortification模板，可以使用AWS标签部署的每个资源。</p><p>例如，要使用上面的Terraform示例中使用的三个相同的AWS标记创建新的EC2实例，请将标记数组添加到资源的属性块中：</p><p>&#34；资源&#34；：{&#34；WebServerInstance&#34；：{&#34；类型&#34；：&#34；AWS：：EC2：：实例&#34；，&#34；元数据&#34；：{...}，&#34；属性&#34；：{&#34；标记&#34；：[{&#34；键&#34；：&#34；联系人&#34；，&#34；值&#34；：&#34；j-mark&#34；}，{&#34；key&#34；：&#34；env&#34；，&#34；value&#34；：&#34；dev&#34；}，{&#34；key&#34；：&#34；service&#34；，&#34；value&#34；：&#34；cart&#34；}]，...}}，...}，</p><p>使用AWS CLI，您可以将此CloudFortification模板部署为新堆栈。这将确保您的模板有效，并使用其在AWS上的标签创建指定的资源：</p><p>如果您的模板中有很多类似的资源，您可以使用带有create-stack或update-stack命令的--tag标志一次将AWS标记部署到堆栈中的所有资源：</p><p>#使用标记锯创建堆栈-堆栈--模板正文file://path/to/your/template.json--堆栈名称=&lt；您的堆栈名称&&gt;--Tags=&#34；Key=env，Value=dev；#使用标记锯云表单更新-堆栈-模板-正文file://path/to/your/template.json--堆栈名称=&lt；您的堆栈名称&--Tags=&#34；Key=env，Value=dev；更新堆栈。</p><p>如果您想要更改上面创建的EC2实例上的联系人，只需更改模板文件的标记部分，然后使用[update-stack](https://awscli.amazonaws.com/v2/documentation/api/latest/reference/cloudformation/update-stack.html)命令部署您的更改。</p><p>当您更新模板文件外部的标签时，AWS CloudForment的行为与Terraform的行为相同。手动设置的任何标记都将被update-stack命令覆盖，因此请确保团队中的每个人都通过CloudFortification部署标记。</p><p>AWS提供组织标记策略和配置管理规则来帮助您查找标记不正确的资源，但这两种工具都无法阻止您创建缺少标记或无效标记的资源。主动实施标记策略的一种方法是使用CloudForformationLinter。</p><p>Cfn-lint是一个命令行工具，可确保您的AWS CloudFortification模板格式正确。它检查JSON或YAML文件的格式、输入的正确类型以及数百个其他最佳实践。虽然默认情况下不检查特定标记的存在，但您可以在Python中编写自定义规则来执行此操作。</p><p>例如，如果要确保您的CloudForformationWeb服务器遵循与上面的Terraform示例相同的规则，并且具有：</p><p>From cfnlint.ules从cfnlint.ules导入CloudFormationLintRulefrom cfnlint.ules导入RuleMatchclass TagsRequired(CloudFormationLintRule)：id=&#39；E9000&#39；Shordesc=&#39；标记已正确设置；description=&#39；检查WebServerInsta&#39；def Match(Self，CFN)的所有标记规则：Matches=[]Approved_Contacts=[&。]WEB_SERVERS=[x for x in cfn.search_deep_keys(&#39；WebServerInstance&#39；)if x[0]==&#39；Resources&#39；]对于WEB_SERVERS中的WEB_SERVER：Tags=web_server[-1][&#39；Properties&#39；][&#39；Tags&#39；]If Not Tags：Message=&#34；所有资源必须至少有一个标记&#34；Matches.append(RuleMatch(web_server，message.format()If Not Next((x表示x in tag if x.get(&#39；key&#39；)==&#39；env&#39；)，None)：message=&#34；所有资源在标签中必须有&#39；env&#39；tag&#34；matches.append(RuleMatch(web_server，message.format()。如果tag.get(&#39；key&#39；)==&#39；service&#39；和tag.get(&#39；value&#39；)不在VALID_SERVICES：message=&#34；中，则联系人必须是批准的联系人&#34；matches.append(RuleMatch(web_server，message.format()如果tag.get(&#39；key&#39；)==&#39；service&#39；和tag.get(&#39；value&#39；)不在VALID_SERVICES：MESSAGE=&#34；服务必须是。Matches.append(RuleMatch(web_server，message.format()返回匹配。</p><p>使用LINTING验证您的AWS CloudFortification规则是主动实施您的AWS标签的好方法。如果您将CloudFortification模板存储在版本控制中，则可以使用预提交钩子或将其作为持续集成工作流的一部分来运行cfn-lint。</p><p>因为这些规则是用Python编写的，所以您可以根据需要将其复杂化，但它们也有缺点。与Terraform的自定义变量验证一样，linting规则不会告诉您不受CloudFortification管理的资源中存在的问题，因此当它们与反应式标签审计和调整策略结合使用时效果最好。</p><p>正确标记的资源将帮助您预测和控制您的成本，但是您的标记策略不能仅仅是被动的。拥有主动实施的模式将需要前期投资，但从长远来看将为您节省时间和金钱。</p><p>一旦你采用了标记策略和主动实施方法，当你落后的时候，最后一块拼图就是迎头赶上。在本指南的最后部分，您将了解如何审核和查找标记错误的资源，以确保您的标记策略在未来继续取得成功。</p><p>如果您有兴趣获得标记方面的帮助，请联系我们的CTO：francois@cloudfoast.io，接收免费的标记合规性报告。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://cloudforecast.io/blog/aws-tagging-best-practices-guide-part-2/">https://cloudforecast.io/blog/aws-tagging-best-practices-guide-part-2/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/标签/">#标签</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/tagging/">#tagging</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/aws/">#aws</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1020239.html"><img src="http://img.diglog.com/img/2020/8/thumb_c4db5c89e09871a942a818546618dcad.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1020239.html">
Google Chrome更新带来了更好的选项卡管理、二维码以及性能提升</a></div><span class="my_story_list_date">2020-8-26 3:46</span></div><div class="col-sm"><div><a target="_blank" href="/story/1019331.html"><img src="http://img.diglog.com/img/2020/8/thumb_e701fd1af8f51c7f82bf9f2faa53a550.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019331.html">报告称，Facebook上84%的医疗错误信息从未贴上警告标签，浏览量高达数十亿次</a></div><span class="my_story_list_date">2020-8-20 18:23</span></div><div class="col-sm"><div><a target="_blank" href="/story/1016452.html"><img src="http://img.diglog.com/img/2020/8/thumb_845b1fdeaa6be88a9cd44063832b11a1.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1016452.html">Instagram表示，在搜索与乔·拜登(Joe Biden)和特朗普(Trump)相关的标签时，一个“漏洞”导致其标签推荐偏向与特朗普相关的内容</a></div><span class="my_story_list_date">2020-8-6 0:39</span></div><div class="col-sm"><div><a target="_blank" href="/story/1012943.html"><img src="http://img.diglog.com/img/2020/7/thumb_8070009d229f31f83663fd5dbca8efc4.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1012943.html">正面-无标签学习(2017)</a></div><span class="my_story_list_date">2020-7-20 6:23</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>