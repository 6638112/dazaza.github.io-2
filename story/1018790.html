<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>有效气流发展</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">有效气流发展</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-18 07:54:06</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/8/59277b5a5e9b8d198b75a48e1ddc4e5a.jpg"><img src="http://img.diglog.com/img/2020/8/59277b5a5e9b8d198b75a48e1ddc4e5a.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>近两年来，气流一直是Curoology数据堆栈中不可或缺的一部分。在此过程中，我们采用了气流开发模式，极大地加快了我们的工作流程。在这篇文章中，我们想与大家分享一下我们在Curoology发展和操作气流的旅程中的一些经验教训。</p><p>我们将假设您熟悉ETL和气流及其核心概念-本文不会深入讨论这些概念，但有许多其他资源可以做到这一点。</p><p>在我们深入研究之前，了解气流在治疗数据故事中的作用可能会有所帮助。当Airflow被引入我们的堆栈时，有几个第三方服务本质上提供了某种形式的“ETL-as-a-Service”-这些服务为交易或广告活动元数据等关键数据提供了入口。随着我们需求的增长，最终这些即插即用的ETL服务开始不能满足我们的需求，我们开始将这些管道引入内部。</p><p>在内部移动管道的另一个原因是为了确保可靠性：既要保证数据完整性，也要保证管道本身的可靠性。与现成的解决方案相比，SLA往往更容易实现；当您的团队拥有故障管道和停机时间时，可以直接采取行动。因此，随着我们的堆栈的发展，气流在这个故事中变得越来越重要，取代了ETL即服务提供商。</p><p>简而言之，Airflow充当我们最重要的数据的主要入口平面，从供应商那里拉入数据，并将这些数据持久保存在我们的数据仓库系统中。需要注意的是，气流只负责将数据移动到我们的仓库或数据湖中，并没有更多：这是我们发现气流真正闪耀的地方，特别是在“ELT”范例的上下文中。</p><p>随着我们将管道转移到内部，我们已经开始建立创作这类管道的标准化方法。我们的许多管道本质上都是与供应商的类似REST的API对话的连接器。这样的集成并不是特别有挑战性，特别是在气流的通用语言Python中。</p><p>然而，当我们开始构建这些集成时，前几个过程很笨拙，不适合模块化。为了解决这个问题，我们将目光投向了Airflow的插件系统。</p><p>诚然，这不是灵丹妙药，最初的传球也同样混乱。我们的第一次尝试将所有东西都集中到一个单一的插件中，这使得一些代码可以重用，但是使得将来的添加变得不必要的耦合和困难。</p><p>随着项目的进展，我们最终后退了一步，更多地从战术上思考如何有效地利用气流框架。我们偶然发现了一些由Astronomer提供的现有技术，Feel Inspiration将我们的整体重构为面向平台的“连接器”：封装与供应商API交互所需逻辑的气流插件。</p><p>连接器是围绕特定供应商或平台定向的气流插件。例如，我们有一个Facebook连接器。这些连接器通常至少由两件东西组成：</p><p>钩子往往尽可能地轻量级：它们毕竟只是一个用于与API对话的通用接口。而操作符往往更复杂，不那么通用，封装了特定任务的专门化业务逻辑。</p><p>为了说明这一点，我们来看一个简化版本的Facebook连接器。我们的插件目录可能如下所示：</p><p>插件/facebook_plugin/├──__init__.py├──Hooks│├──__init__.py││├──__init__.py│└──facebook_init__.py└──运算符├──__init__.py└──facebook_Campaign_to_S3_Operator.py。</p><p>这里我们有一个钩子来管理与Facebook的Graph API的通信，还有一个操作符负责在S3中持久化Facebook广告活动元数据。我们可以想象这些实现会是什么样子。为了利用它们做一些有用的事情，我们需要将它们放入某种DAG中。例如：</p><p>气流开发的一个挑战是知道特定的DAG做了您期望它做的事情。虽然Airflow本身不一定提供很多开箱即用的解决方案，但Python为自动化测试提供了特殊的工具。然而，应用这些技术并不总是像使用其他框架那样简单。</p><p>上面描述的插件模式适合相当标准的单元式测试，但有一些注意事项。例如，我们为所有挂钩和操作符提供测试。我们结合使用pytest和pytest-vcr，以允许我们针对真实的API响应创建具有可重现结果的测试。这里需要注意的是，这些测试需要通过unittest.mock进行相当数量的深度模拟，这可能是不透明的，并且很难推理。</p><p>这是我们的测试相对于连接器的布局方式的简化视图：</p><p>Plugins/facebook_plugin/├──__init__.py├──Hooks│├──__init__.py│和├──Cassettes│和│├──测试_facebook_graph_│_get.yaml│和└──测试_facebook_graph_hook.post.yaml│和├──facebook_graph_hook.py│和└──测试_facebook_graph_hook.py└─。─Operators├──__init__.py├──Cassettes│└──├──_facebook_Campaign_to_S3_Operator.yaml Testfacebook_Campaign_to_S3_Operator.py└──TEST_facebook_Campaign_to_S3_Operator.py。</p><p>盒式磁带由pytest-vcr包提供，包含测试消耗的可重放请求和响应。</p><p>这种测试风格的目标是确保执行关键代码路径，并确保我们从调用API方法或任务执行方法中检索到的数据符合预期的形状。这不能替代在线数据完整性检查(尽管它们也是DAG原创性的一部分)，但它们是有用的健全性检查。</p><p>摆脱ETL供应商的一个目标是增加我们对系统中数据质量的信心。为此，我们建立了一个小型约定库，对数据的外观进行在线断言。这些断言可能在数据从线路上传出时发生，或者在数据到达我们的仓库或数据湖之后发生。</p><p>未来工作的一个主要焦点将是为集成风格的测试构建更好的测试工具，这目前是一个相对的盲点。为了实现这一点，我们已经开始在一个系统上工作，以便轻松地建立独立的环境。这将在不久的将来形成端到端测试的基础。</p><p>气流仍然是我们数据堆栈中的重要一层。也就是说，气流是一种具有许多功能和可调参数的复杂工具。Curoology平台团队发现，与我们早期使用该框架的一些尝试相比，通过采用一些关键模式，我们能够有效地利用气流。</p><p>我们正在继续发展我们对有效气流模式的理解。特别是，随着我们转向基于S3的数据湖，我们发现了进一步简化连接器的机会。我们还在探索通过Docker和Kubernetes创作机器学习工作流的模式。毫无疑问，在这个过程中还会有更多的发现。</p><p>平台团队正在寻找充满激情的数据工程师来帮助构建支持我们内部业务合作伙伴的数据堆栈-从营销自动化到统计建模、ML和NLP的一切都依赖于我们团队正在构建的基础设施。如果您对此感兴趣，请与我们联系！</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://curology.com/blog/tech/posts/effective-airflow?hn">https://curology.com/blog/tech/posts/effective-airflow?hn</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/气流/">#气流</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/airflow/">#airflow</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/数据/">#数据</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>