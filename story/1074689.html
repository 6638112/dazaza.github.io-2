<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>你怎么能信任磁盘来写数据呢？</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">你怎么能信任磁盘来写数据呢？</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2022-02-22 18:02:22</div><div class="page_narrow text-break page_content"><p>通常情况下，离硬件越近，离现实越远。不仅在M1内核及其性能中可以看到这一点，而且在存储方面也是一个很好的规则。</p><p>我一拿到第一台M1 Mac电脑，就对其进行了现成的磁盘基准测试，以比较其内部SSD与iMac Pro的速度。其中一些结果表明，近20 GB/s的传输速率高得离谱，这似乎是缓存的结果。换句话说，SSD欺骗了测试，使其无法测量向磁盘写入数据的速率，而只是将数据传输到高速缓存中，写入本身会在一段时间后更慢地进行。</p><p>经过大量的实验和测试，我开发出了自己的基准测试应用程序Stibium，它在各种SSD上都给出了相当可靠的结果。</p><p>缓存和磁盘性能问题最近在M1 Mac上再次出现，这一次是在朝日Linux的开发中。因为它在M1机型上运行，而不是在虚拟机上运行，所以它必须自行驱动，为此，赫克托·马丁和他的团队正在深入研究苹果的硬件。这似乎导致了人们对性能和数据完整性之间的权衡的担忧，但最终可能会回到缓存/缓冲区及其刷新的老问题，以及不能确切说出真相的磁盘。</p><p>macOS有两种刷新磁盘写入的低级方法：fsync（）和fcntl（）中的F_FULLFSYNC命令。然而，绝大多数应用程序都没有达到这个水平，让macOS来决定该怎么做。选择很重要，因为它们的工作方式非常不同。fsync（）使文件的所有修改数据和元数据都移动到磁盘，并从计算机中刷新。但是，磁盘本身可能会将数据留在自己的缓冲区中一段时间，然后以较慢的速度写入存储器。F_FULLFSYNC做同样的事情，但随后要求磁盘刷新其所有缓冲区，并将数据写入其存储器。</p><p>当磁盘执行命令要求的操作时，F_FULLFSYNC通常比fsync（）慢得多，正如您所预料的那样。如果您相信fsync（）与F_FULLFSYNC的工作原理相同，那么您可能会在磁盘的真正性能上受到严重误导。此外，如果一个磁盘忽略在F_FULLFSYNC上刷新其缓冲区的请求，那么它看起来会比另一个符合要求的磁盘快得多。有趣的是，苹果公司针对后一个命令的手册页指出，“已知某些FireWire驱动器也会忽略刷新其缓冲数据的请求”。</p><p>不过，这不仅仅关乎磁盘的性能和市场营销，正如本文所探讨的，刷新行为对文件系统、数据库和可靠性至关重要。</p><p>一个简单的例子是，如果磁盘突然断电会发生什么。如果使用fsync（）将对文件系统的更改刷新到磁盘上，那么磁盘的缓冲区中很可能仍有这些更改。APFS通过在删除旧数据之前写入新数据，使用写时拷贝来确保突发灾难不会导致其文件系统数据出现问题。由于磁盘缓冲区可能会无序清空，因此在断电时，可能是在从缓冲区写入新数据之前执行了删除操作，或者是后来的新数据被无序写入。正如苹果公司的fsync（）文档所述：“这不是一个理论上的边缘案例。这个场景很容易在现实世界的工作负载和驱动器电源故障中重现。”</p><p>这就是为什么macOS有F_FULLFSYNC，以及为什么它在其支持的主要文件系统HFS+、FAT、UDF和APFS上实现，根据其手册页。</p><p>还有一条重要信息与Mac用户直接相关。如果你转向苹果的旧Time Machine over SMB规范，你会看到一整节关于F_FULLFSYNC的内容，其中指出“Time Machine客户端在定期检查点发出此命令，以确保备份中不会发生数据损坏。”当Time Machine备份到本地存储时，可能也是这样。如果是这样的话，它会让我们放心，它会不遗余力地防止损坏的备份，而且，考虑到F_FULLFSYNC即使在快速本地存储上也会对性能造成影响，它还解释了为什么备份速度会比您希望的慢。</p><p>当您试图测量磁盘的性能时，磁盘的缓存行为可能是显而易见的，并可能导致虚假的高传输速率。当您需要可靠性时，它变得最重要，因此macOS确保在APFS、HFS+、FAT和UDF中需要时正确刷新对磁盘的写入。在时间机器编写备份时，它们也会定期出现，以保护它们不受损坏。</p><p>我非常感谢@rosyna、@janl和@evntdrvn提供了所有线索；然而，任何错误都是我的错。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/磁盘/">#磁盘</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/disk/">#disk</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>