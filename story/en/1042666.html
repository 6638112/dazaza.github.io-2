<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>安装在Raspberry Pi HQ相机上的16mm长焦镜头的自动对焦 Autofocus for the 16mm Telephoto Lens Mounted on the Raspberry Pi HQ Camera</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Autofocus for the 16mm Telephoto Lens Mounted on the Raspberry Pi HQ Camera<br/>安装在Raspberry Pi HQ相机上的16mm长焦镜头的自动对焦 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-01 08:06:40</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/1/e3bab3ae6890c874ae5b6ebc4245c395.jpg"><img src="http://img2.diglog.com/img/2021/1/e3bab3ae6890c874ae5b6ebc4245c395.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>This tutorial opens the series of articles about &#34;Project JiJi&#34; and describes how to add autofocus to the 16 mm Telephoto Lens mounted on the Raspberry Pi HQ Camera. In the past months, I&#39;ve been working on a project to add autofocus to the lens and this is the result:</p><p>本教程将打开有关＆＃34; Project JiJi＆＃34;的系列文章。并说明如何为安装在Raspberry Pi HQ相机上的16毫米远摄镜头增加自动对焦。在过去的几个月中，我一直在致力于为镜头添加自动对焦的项目，结果是：</p><p>  Adding some background to this: The Raspberry Pi Foundation offers different Raspberry Pi Camera modules since 2013. The first module (5-megapixel) was produced in 2013, and an 8-megapixel module upgrade (v2) was released in 2016. Both models have visible light and infrared versions. This year (2020), the Foundation launched the HQ Camera. This is a 12-megapixel High Quality (thus HQ) camera (Sony IMX477), which adds the possibility to use a lens with CS-mount. It is a great upgrade, but the lens and the camera lack autofocus up to now.</p><p>  为此增加了一些背景：Raspberry Pi Foundation自2013年以来提供了不同的Raspberry Pi相机模块。2013年生产了第一个模块（5兆像素），2016年发布了8像素升级模块（v2）。可见光和红外版本。今年（2020年），基金会推出了HQ相机。这是一台12百万像素的高质量（因此为HQ）相机（Sony IMX477），增加了使用带有CS卡口的镜头的可能性。这是一个很大的升级，但是到目前为止，镜头和相机都没有自动对焦。</p><p> If you are impatient, you can find the hardware design, firmware and software on the  lemariva/rPIFocus and  lemariva/uPyFocus repositories. But, you should come back and read the tutorial until the end, so that you can understand how it works, and if you want to, you can also cooperate on this project!</p><p> 如果您不耐烦，可以在lemariva / rPIFocus和lemariva / uPyFocus存储库中找到硬件设计，固件和软件。但是，您应该回来阅读本教程，直到最后，这样您才能了解它的工作原理，并且如果您愿意，还可以在该项目上进行合作！</p><p>     In this article, I will explain how to build the project yourself. I won&#39;t go deeper in detail. These will be covered in future articles.</p><p>     在本文中，我将解释如何自己构建项目。我不会更详细地介绍。这些将在以后的文章中介绍。</p><p>  As you may have already noticed, to add autofocus to the camera, you will need to order a PCB and solder and mount some parts. In the Github repository, under the folder  `pcb`, you&#39;ll find the schematic as well as the board files for the PCB. To open those files, you&#39;ll need  Eagle. Eagle is still free for hobbyists, thus, download and install it to open the files. You can export Gerber files using  this export-to-gerber tutorial.</p><p>  如您可能已经注意到的，要为相机添加自动对焦，您需要订购PCB并焊接并安装一些零件。在Github存储库中的文件夹“ pcb”下，您将找到原理图以及PCB的电路板文件。要打开这些文件，您将需要Eagle。业余爱好者仍然可以免费使用Eagle，因此，请下载并安装它以打开文件。您可以使用此导出到Gerber教程导出Gerber文件。</p><p> To simplify the process for you, I also added the Gerber files that you can directly send to your PCB provider. I use and recommend  jlcpcb. They are fast, cheap, reliable and the quality of the boards is pretty good. Check out the setting and costs for this project in Fig. 1. Don&#39;t forget to select the LeadFree HASL-RoHS surface finish!</p><p> 为了简化您的过程，我还添加了Gerber文件，您可以将其直接发送给PCB提供商。我使用并推荐jlcpcb。它们快速，便宜，可靠，并且电路板的质量非常好。在图1中检查该项目的设置和成本。不要忘记选择Leadlead HASL-RoHS表面处理！</p><p>  I designed the PCB for people with two types of skills: advanced and basic. So, if you&#39;re a pro, grab your solder and solder every element (ICs) for yourself, or, if your skills are basic, don&#39;t worry, grab your solder and solder the small hobbies boards that you can buy from the selection above. Two steppers rotate the focus and aperture rings. They are controlled by the M5Stack ATOM, which also measures the steppers&#39; currents and offers an RestAPI to send the commands (see Fig. 2 for an basic PCB schematic).</p><p>  我为具有两种技能的人员设计了PCB：高级和基础技能。因此，如果您是专业人士，请拿起自己的焊料，自己焊接所有元件（IC），或者，如果您的技能是基本技能，请不要着急，拿起您的焊料并焊接自己的小型爱好板可以从上面的选择中购买。两个步进器旋转聚焦环和光圈环。它们由M5Stack ATOM控制，M5Stack ATOM还测量步进器。当前，并提供一个RestAPI来发送命令（基本的PCB原理图请参见图2）。 </p><p>  Fig. 3 to Fig. 8 show you some close photos of the design to help you to mount the elements. Fig. 3 shows you how to mount the aperture and focus belt rings. They usually have a standard of 0.8 mm pitch. So the motor pinions should be compatible with that. Fig. 4 shows the mounted motor. Check the cable color - or the order! They are connected to the A4988 drivers (Fig. 5) and that&#39;s the right connection. Otherwise, the driver won&#39;t be able to switch the electromagnets in the right sequence and the motor won&#39;t rotate. I planned a cut on the PCB so that the pinion distance to the belt ring can be modified and the motor can be fixed as shown in Fig. 6 (using a 2.5 mm screw) - not the best way, but it works ;). To fix the camera to the board, I used a 3/8 inch screw and an adapter to mount that to a tripod (see Fig. 7). The screw fixes the camera to the board. The camera tends to rotate, and it releases the screw. If that&#39;s the case, you can fix it using the two 3mm holes on the left of the camera base (see Fig. 8) with an e.g. rectangular piece of wood over the board. Finally, you need to mount the INA219 and two pinheads for the M5Stack ATOM Matrix. The INA219 measures the current of the steppers, which are used to identify the rotational limits of the focus and aperture rings. Therefore, after booting, the system calibrates itself and it doesn&#39;t require encoders to measure the steppers positions.</p><p>图3至图8为您展示了该设计的一些近距离照片，以帮助您安装元件。图3显示了如何安装光圈环和聚焦带环。它们的标准间距通常为0.8毫米。因此，电动机小齿轮应与此兼容。图4显示了已安装的电动机。检查电缆颜色-或订购！它们已连接到A4988驱动程序（图5），并且连接正确。否则，驾驶员将无法以正确的顺序切换电磁体，并且电动机将无法旋转。我计划在PCB上进行切割，以便可以修改到皮带环的小齿轮距离，并可以如图6所示固定电动机（使用2.5毫米螺钉）-并不是最好的方法，但是它是有效的;）。要将相机固定在板上，我使用了3/8英寸的螺钉和一个适配器将其安装到三脚架上（见图7）。螺钉将摄像机固定在板上。相机倾向于旋转，并释放螺丝。在这种情况下，您可以使用相机底座左侧的两个3mm孔（见图8）将其固定，例如矩形的木板。最后，您需要安装INA219和两个用于M5Stack ATOM矩阵的针头。 INA219测量步进器的电流，该电流用于识别聚焦环和光圈环的旋转极限。因此，启动后，系统会自行校准，并且不需要编码器来测量步进器的位置。</p><p>  As you can see in Fig. 9, there are some ICs, capacitors, and resistors that aren&#39;t assembled and also two cables (red and black). The cables supply 7.5V for the motors. The ICs, capacitors, and resistors are planned to provide 5V and 3.3V to the M5Stack, A4988 drivers, and the INA219. Currently (in that Fig. 9), they are supplied via the USB cable connected, on one end, to the M5Stack, on the other, to the Raspberry Pi. So, you have two ways to supply the system :). But, yes, you need two power suppliers: one for the steppers (7.5V) and one for the Raspberry Pi (5V). The 5V on the board (via ICs) won&#39;t be able to supply the Raspberry Pi. Sorry, but I didn&#39;t want to use bigger ICs for that.</p><p>  正如您在图9中所看到的，有一些IC，电容器和电阻器没有组装，还有两条电缆（红色和黑色）。电缆为电机提供7.5V电压。该IC，电容器和电阻器计划为M5Stack，A4988驱动器和INA219提供5V和3.3V。目前（在图9中），它们是通过USB电缆提供的，一端连接到M5Stack，另一端连接到Raspberry Pi。因此，您可以通过两种方式提供系统：)。但是，是的，您需要两个电源：一个用于步进器（7.5V），另一个用于Raspberry Pi（5V）。板上的5V（通过IC）将无法为Raspberry Pi提供电源。抱歉，但我不想为此使用更大的IC。</p><p>  As I described before, the M5Stack ATOM Matrix controls the motors and offers a RestAPI to receive the commands. The M5Stack application is programmed in MicroPython. If you haven&#39;t heard about MicroPython, you can check this tutorial:  Getting Started with MicroPython on ESP32, M5Stack, and ESP8266. MicroPython is a lean and efficient implementation of the Python 3 programming language that includes a small subset of the Python standard library and is optimized to run on microcontrollers and in &#34;constrained environments&#34;.The application is located  lemariva/uPyFocus.</p><p>  如前所述，M5Stack ATOM Matrix控制电机并提供RestAPI来接收命令。 M5Stack应用程序是用MicroPython编程的。如果您还没有听说过MicroPython，可以查看以下教程：ESP32，M5Stack和ESP8266上的MicroPython入门。 MicroPython是Python 3编程语言的一种精简而高效的实现，其中包括Python标准库的一小部分，并且经过优化可在微控制器上和受约束的环境中运行。该应用程序位于lemariva / uPyFocus。</p><p>  Open the file and add your Wi-Fi credentials in this section:  The M5Stack needs to connect to your Wi-Fi so that the Raspberry Pi (also connected to your Wi-Fi/LAN) can find it and sends the commands to control the steppers.</p><p>  打开文件并在此部分添加您的Wi-Fi凭据：M5Stack需要连接到Wi-Fi，以便Raspberry Pi（也已连接到Wi-Fi / LAN）可以找到它并发送命令以控制踏步机。</p><p> After uploading the code, the M5Stack resets and starts with the calibration routine (check video section: nnn). Take note of the IP that the M5Stack reports while connecting to your Wi-Fi. You&#39;ll need that to configure the Microservices Application.</p><p> 上载代码后，M5Stack重置并从校准例程开始（检查视频部分：nnn）。在连接到Wi-Fi时记下M5Stack报告的IP。您将需要它来配置微服务应用程序。</p><p>  The application that runs on the Raspberry Pi is a microservices application. That means different services are orchestrated to offer an application. The orchestration is performed by docker-compose and the services are containerized using Docker.</p><p>  在Raspberry Pi上运行的应用程序是微服务应用程序。这意味着精心设计了不同的服务来提供应用程序。编排由docker-compose执行，服务使用Docker进行容器化。</p><p>   If you want to learn more about Docker on Embedded System, just read this tutorial:  Tutorial: Docker on Embedded Systems (Raspberry Pi &amp; Beagleboard)</p><p>   如果您想了解有关嵌入式系统上Docker的更多信息，请阅读本教程：教程：嵌入式系统上的Docker（Raspberry Pi＆amp; Beagleboard） </p><p> To orchestrate the services, you need to install  docker-compose. This can be done by typing:</p><p>要编排服务，您需要安装docker-compose。可以通过键入以下内容来完成：</p><p>     To take photos faster, you can create a disk on RAM. A RAM disk offers faster access to the data compared to an SD card or a connected USB disk. Thus, this allows the application to reduce the time between photos. To do that, you need to create a folder by typing on a Terminal:</p><p>     为了更快地拍照，可以在RAM上创建磁盘。与SD卡或连接的USB磁盘相比，RAM磁盘可以更快地访问数据。因此，这允许应用程序减少照片之间的时间。为此，您需要通过在终端上键入来创建一个文件夹：</p><p>  Then, you need to modify the  /etc/fstab file and add a line at the end of the file:</p><p>  然后，您需要修改/ etc / fstab文件，并在文件末尾添加一行：</p><p> sudo nano /etc/fstab### add the following line at the file&#39;s end:tmpfs /mnt/ramdisk tmpfs nodev,nosuid,size=50M 0 0</p><p> sudo nano / etc / fstab ###在文件末尾添加以下行：tmpfs / mnt / ramdisk tmpfs nodev，nosuid，size = 50M 0 0</p><p>         backend: it communicates with the frontend via a RestAPI (Flask server), controls the camera, sends the signals to the M5Stack to control the motors, sends the signals and data to the other services to identify objects and take photos. Basically, it is the core service. It is programmed in Python.</p><p>         后端：它通过RestAPI（Flask服务器）与前端通信，控制摄像头，将信号发送到M5Stack以控制电机，将信号和数据发送到其他服务以识别对象并拍照。基本上，它是核心服务。它是用Python编程的。</p><p> obj-detector: it receives an image over UDP and identifies the object on it and returns a JSON message. It is programmed in Python. It uses TensorFlow and connects to the Coral USB Accelerator to process the data in real-time.</p><p> obj-detector：它通过UDP接收图像并识别其上的对象并返回JSON消息。它是用Python编程的。它使用TensorFlow并连接到Coral USB Accelerator来实时处理数据。</p><p> photo-service: it receives a signal via RestAPI (Flask server) to take photos and it processes them to create HDR photos. It is programmed in Python and it uses Celery for multitasking/non-blocking response to the RestAPI.</p><p> 照片服务：它通过RestAPI（Flask服务器）接收信号来拍照，并对其进行处理以创建HDR照片。它使用Python编程，并且使用Celery对RestAPI进行多任务/非阻塞响应。 </p><p>   Open a browser and visit the URL address:  http://&lt;ip-raspberrypi&gt;:4200, you&#39;ll see an interface like in Fig. 9. (shhhh... I&#39;ve just noticed that I wrote Raspberry HD camera and not HQ camera... :()</p><p>打开浏览器并访问URL地址：http：//＆lt; ip-raspberrypi＆gt;：4200，您将看到如图9所示的界面。（嘘...我刚刚注意到我写了Raspberry HD摄像机而不是HQ摄像机... :(）</p><p>  The Docker images are located in Docker Hub. I&#39;m currently using a Free Plan, thus if nobody has used an image for at least 6 months, Docker Hub will delete it. So, it could happen that if you see this post, and some/one of the image(s) are/is not there, you can build them/it yourself following the instructions on Github, or send me a comment. I will try to upload them/it ASAP.</p><p>  Docker映像位于Docker Hub中。我目前正在使用免费计划，因此，如果没有人使用图像至少六个月，则Docker Hub会删除它。因此，有可能发生的情况是，如果您看到这篇文章，但其中一些/一个或多个图像不存在，则可以按照Github上的说明自行构建它们，或给我发送评论。我将尝试尽快上传它们。</p><p>  This is the first part of this article series about Project JiJi. In this article, I described the steps to build and mount the hardware, flash the M5Stack, and start the Microservices application on the Raspberry Pi 4. The software components are still buggy and in optimization processes, but they have started to produce some outputs :). You can check and download the sample photos (Fig. 11 to 14). The HDR files ( /FORMAT=32-bit_rle_rgbe) were processed using  Luminance HDR v2.6.0.</p><p>  这是有关JiJi项目的系列文章的第一部分。在本文中，我描述了在Raspberry Pi 4上构建和安装硬件，刷新M5Stack并启动Microservices应用程序的步骤。软件组件仍然存在问题，并且处于优化过程中，但是它们已经开始产生一些输出： ）。您可以检查并下载示例照片（图11至14）。使用Luminance HDR v2.6.0处理了HDR文件（/ FORMAT = 32-bit_rle_rgbe）。</p><p> One more thing: If you want to cooperate on this project, you&#39;re really welcome to do so and please contact me!</p><p> 还有一件事：如果您想在这个项目上进行合作，非常欢迎您这样做，请与我联系！ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://lemariva.com/blog/2020/12/raspberry-pi-hq-camera-autofocus-telephoto-lens">https://lemariva.com/blog/2020/12/raspberry-pi-hq-camera-autofocus-telephoto-lens</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/相机/">#相机</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/raspberry/">#raspberry</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/telephoto/">#telephoto</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>