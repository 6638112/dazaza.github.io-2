<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>修复了Commodore Basic中最古老和最具爆破的错误 Fixing the Oldest and Nastiest Bug in Commodore Basic</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Fixing the Oldest and Nastiest Bug in Commodore Basic<br/>修复了Commodore Basic中最古老和最具爆破的错误 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-01 19:55:35</div><div class="page_narrow text-break page_content"><p>We again are able to enjoy another guest-post from Bitshifter, as he fixes and enhances the C65 ROMs for use on the MEGA65:</p><p>我们再次能够享受来自Bitshifter的另一个招待员，因为他修复和增强了Mega65的C65 ROM：</p><p>      Ahuge part of working on the ROM for the MEGA65, which contains theresident part of the operating system and BASIC interpreter, isDebugging. Not counting the character sets, the source code, writtenin 45GS02 assembler, has about 30000 lines, separated into themodules kernel, editor, DOS, BASIC and graphics.  Thedebugging is necessary mainly for two reasons: 1) Programmers,developers, software engineers are humans. 2) A source code,that is not your own, is full of traps, side effects and assumptions,that one is not aware of. Of course my own code is full of trapsand side effects too, but I know them (at least for the next fewmonths).</p><p>      Ahuge部分在MEGA65上工作的，其中包含操作系统的Thisident部分和基本口译员，ISDebugging。不计算字符集，源代码编写了45gs02汇编程序，具有大约30000行，分为主机核，编辑器，DOS，基本和图形。 TheDebugging是必要的主要是有两个原因：1）程序员，开发人员，软件工程师是人类。 2）一个源代码，即不是你自己的，充满了陷阱，副作用和假设，那个人不知道。当然，我自己的代码也充满了Trapsand副作用，但我知道它们（至少在下几个月）。</p><p>    Whileworking on the ROM, fixing Commodore bugs, optimising code to getfree space for extensions and introducing new features (and sometimesnew bugs), I write often some hundred lines of assembly code and makechanges on existing code. Sometimes these changes seem to workperfectly, some result in crashes and freezes, because of errors andsome only seem to work fine in my own test, but fail if a developernamed „ubik“ demonstrates situations, which the code cannothandle.  Well, I’ll not tell a long story, how I debug,but come directly to the bug mentioned in the title. I tracked hisexistence down to BASIC 2.0 as used in the VIC-20, C64 and the earlyPET/CBM series and it seems, that it was never detected, documentedor fixed.  It is related to temporary strings, the stack ofdescriptors for temporary strings, that has a size of 3, and the socalled „garbage collection“, which in reality doesn’t collectgarbage, but does a defragmentation of string storage.</p><p>    虽然在ROM上工作，修复了Commodore错误，优化了代码以获得扩展的readree空间，并引入新功能（以及有时是新的错误），我在现有代码上编写了一些百分点的汇编代码和makechanges。有时这些变化似乎是workperfectly，有些结果崩溃和冻结，因为错误似乎只在我自己的测试中工作很好，但如果开发出版社“Ubik”演示了代码ancothandle的情况。好吧，我不会讲一个长篇小说，我是如何调试的，但直接到标题中提到的错误。我在VIC-20，C64和LooseTet / CBM系列中使用的基本表达到Basic 2.0，似乎从未检测到的，记录员已修复。它与临时字符串有关，临时字符串的堆栈OFESCRIPTORS，具有3的大小，以及ICALLED“垃圾收集”，其实际上没有Collectarbage，但是串通存储的碎片整理。</p><p>         Theinterpreter needed 6 temporary strings, these are the strings, whichare followed by the two byte „garbage“ word in magenta, to createthe resulting permanent string, marked here with the „back link“word in yellow.</p><p>         TheItnerPreter需要6个临时字符串，这些是字符串，依据杂志中的两个字节“垃圾”字，以创建生成的永久字符串，标记为黄色的“后链接”字。</p><p>    Eachtime, where a string is modified or new assigned, it gets a newallocation in string memory and the old string is flagged as„garbage“ by replacing its back link, which points to the stringdescriptor, by the garbage word, which is the length of the string,followed by $ff (The high byte $ff can never appear as part of a backlink, because the highest address in string memory is $F6FF,therefore it is safe, to use this value as flag).</p><p>    每次，在修改字符串或新分配的情况下，它会通过替换其后链接，将旧字符串标记为“垃圾”，该链接指向垃圾字，这是垃圾字的垃圾字，这是长度该字符串，后跟$ ff（高字节$ ff永远不会显示为反向链接的一部分，因为字符串内存中的最高地址是$ f6ff，因此它是安全的，使用此值作为标志）。</p><p>      Inprograms with much string activity, the occupied string space, whichgrows from top ($f6ff) to bottom (top of array space), will be filledvery fast and if there is no more space left for creating a newstring, the call of the defragmentation routine is triggered. Thisstarts at top of screen memory and copies all strings, which do notcarry the garbage flag, to adjacent addresses, skipping the garbagestrings. Doing this it is necessary, to update the string pointers ofthe descriptors. That’s the purpose of the backlink: After copyinga string to the new address the back link is used to find thedescriptor, and the two pointer bytes of the descriptor get the newaddress. Te descriptor can reside in scalar space, e.g. for avariable like AB$, or in array space, e.g. XY$(I,J) or it can be atemporary descriptor on the descriptor stack in the zero page. Andthis is, where the bug lurks.  The descriptor stack is 9bytes long in the zero page and has therefore room for 3 descriptors.Additionally we have a stackpointer, which has four valid values for0,1,2 or 3 descriptors in use. And we have a LASTPT called variable,which points to the last temporary descriptor, which was used toallocate a string. This is an optimisation tool. When a string is nomore needed and it is the last string, that was allocated, thepointer to the used string memory can be updated by the length (plus2 for the back link) instead of just flagging the string as garbage.This method can slow down the speed of filling the string memorysomewhat and let’s the defragmentation happen less often.</p><p>      具有很多字符串活动的内容，从顶部（$ f6ff）到底部（阵列空间顶部）的占用字符串空间，将迅速充分，如果没有更多的空间来创建新字符串，则碎片整理例程呼叫被触发。在屏幕内存顶部的轨道，并将所有字符串复制到相邻地址，跳过GarbageStrings。执行此操作是必要的，以更新描述符的字符串指针。这是反向链接的目的：将汇集到新地址的字符串后，后退链接用于查找中文符号，并且描述符的两个指针字节获取NewAddress。 TE描述符可以驻留在标量空间中，例如，对于可行的像AB $，或在阵列空间中，例如XY $（i，j）或它可以是ZERO页面中的描述符堆栈上的ATIMPORY描述符。那是，臭虫潜伏在哪里。描述符堆栈在零页中长度为9bytes，因此为3描述符有3个描述符.Aditionally我们有一个stackpointer，它在使用中有四个有效值为0,1,2或3个描述符。我们有一个名为变量的滞留变量，这指向最后一个临时描述符，它被使用toallocate一个字符串。这是一个优化工具。当一个字符串是需要的，它是最后一个字符串，所分配的字符串，可以通过长度（背部链接的plus2）更新到使用的字符串内存的点，而不是仅将字符串标记为垃圾。这方法可以减速填充字符串记忆的速度和让碎片整理的速度不太经常发生。</p><p>             Thelow byte therefore has the value, that was either initialised atpower up or has the value from a previous use. This use can forexample be the loading of a program, because this involves stringhandling for the filename and therefore the use of the descriptorstack.</p><p>             因此，Thelow字节具有值，即初始化Atpower，或者具有以前使用的价值。此使用可以for表单是程序的加载，因为这涉及FileName的StringHandling，因此使用描述符。 </p><p>      Soit can happen, that the routine, that pops a value from thedescriptor stack compares the current pointer with LASTPT, seesequality and decides not to flag the string as garbage, but to updatethe pointer to free string memory instead. This is an error, if thevalue of LASTPT is from a previous usage and was not set in thecurrent statement. Alas, it will have no consequences in 99.9 % ofthe cases, because at the end of a statement all temporarydescriptors are freed anyway.  The bug can drive mischiefif following conditions meet:</p><p>SOIT可能发生，即流行中的例程，其中来自对齐的人堆栈的值，将当前指针与鹿茸，seesequality进行比较，并决定不将字符串标记为垃圾，而是将指针兑换为可用字符串内存。这是一个错误，如果allptvalue来自以前的用法，并且未在TheCurrent语句中设置。唉，它在99.9％的案件中没有后果，因为在一份声明结束时，无论如何，所有临时的职业标志都是释放的。在满足条件下，错误可以驱动错误的错误：</p><p>                  Thena really rare event can happen:  The garbage collection istriggered in the middle of a complex string formula with temporarydescriptors on the stack. The garbage collection is aware oftemporary descriptors and copies their strings too and updates thedescriptors, but if one of the descriptors freed his string due to afalse LASTPT comparison, his string is outside of the garbagecollection area and will not be updated. And this causes strangethings to be happen. The descripror has now a pointer, that does notpoint to a valid string. So the whole system of links and back linksis corrupt. To make the bug hunting more interesting, this corruptpointer often does no obvious harm until the next garbage collection,or the collection after it, but each will make the error worse, untilback links appear in screen memory or strings dissappear or thecomputer freezes.</p><p>                  然后，真的很少会发生罕见的事件：垃圾收集在一个复杂字符串公式的中间触发了堆栈上的临时标记。垃圾收集是了解的，也了解他们的字符串并更新其字符串并更新目录，但如果由于afAlse速度比较，其中一个描述符释放了他的字符串，则他的字符串位于GarbageCollection区域之外，不会更新。这导致陌生人发生。 Descripror现在具有指针，它对有效字符串并不值。所以整个链接和返回Linksis腐败的系统。为了使错误狩猎更有趣，这种腐败点通常没有明显伤害，直到下一个垃圾收集，或者在它之后收集，但每个都会使错误更差，直接链接出现在屏幕内存中或围绕冻结或冻结的字符串。</p><p>               insteadthe first part, setting the low byte, was forgotten.  BTW,the highy byte is always zero, because the descriptor stack residesin the zero page, so this usage of the high byte is redundant.  Ifound this bug in all versions of Commodore BASIC, that Iinvestigated, VIC-20, C64, C128, C65, MEGA65.  But itneeded the „11 BASIC“ preprocessor/compiler of UBIK, to let thebug appear.  And it was very difficult to detect, becauseonly huge programs with heavy string activity could activate it.</p><p>               而不是第一部分，设置低字节，被遗忘。 BTW，HOOLY字节始终为零，因为描述符堆栈驻留为零页面，因此此使用高字节是冗余的。 IFound此错误在Commodore Basic的所有版本中，即Iinvestigated，VIC-20，C64，C128，C65，Mega65。但是，它是ubik的“11个基本”预处理器/编译器，让BEG出现。并且非常困难，因为具有繁忙的弦活动的巨大节目可以激活它。</p><p>      Sothe old programmer’s talk is true:  You can only find thepenultimate error in a program! There is always the ultimateerror, that remained undetected.</p><p>      SOTHE Old Programmer的谈话是真的：您只能在程序中找到培养型错误！总是有UltimeError，它仍然未被发现。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://c65gs.blogspot.com/2021/03/guest-post-from-bitshifter-fixing.html">https://c65gs.blogspot.com/2021/03/guest-post-from-bitshifter-fixing.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/commodore/">#commodore</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/oldest/">#oldest</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/字符串/">#字符串</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>