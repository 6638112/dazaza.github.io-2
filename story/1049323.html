<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>常见的Nginx错误配置使您的Web服务器容易受到攻击 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">常见的Nginx错误配置使您的Web服务器容易受到攻击 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-02-25 15:35:56</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/2/7861fb9f365b3c986c52e9288280e5af.png"><img src="http://img2.diglog.com/img/2021/2/7861fb9f365b3c986c52e9288280e5af.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Nginx是支持世界上所有网站三分之一的Web服务器。 Detectify Crowdsource已检测到一些常见的Nginx错误配置，如果不进行检查，将使您的网站容易受到攻击。以下是在攻击者利用它们之前发现一些最常见的错误配置的方法。</p><p>  Nginx是Internet上最常用的Web服务器之一，因为它轻巧，模块化并且具有用户友好的配置格式。在Detectify，我们为成千上万的客户扫描Nginx中的配置错误和安全漏洞。我们的Crowdsource网络会定期提交影响Nginx的新的有趣漏洞，然后将其作为安全性测试实施到我们的Web应用程序扫描程序中。</p><p> 我们使用Google BigQuery分析了从GitHub下载的近50,000个唯一的Nginx配置文件。有了这些数据，我们可以发现不同配置错误的普遍程度。</p><p>    服务器 { 根/ etc / nginx; 位置/hello.txt { try_files $ uri $ uri / = 404; proxy_pass http://127.0.0.1:8080/; }}</p><p> root指令指定Nginx的根文件夹。在上面的示例中，根文件夹是/ etc / nginx，这意味着我们可以访问该文件夹中的文件。上面的配置没有/的位置（location / {...}），只有/hello.txt的位置。因此，将对root指令进行全局设置，这意味着对/的请求会将您带到本地路径/ etc / nginx。</p><p> 像GET /nginx.conf这样简单的请求将显示存储在/etc/nginx/nginx.conf中的Nginx配置文件的内容。如果将根设置为/ etc，则对/nginx/nginx.conf的GET请求将显示配置文件。在某些情况下，可以访问其他配置文件，访问日志，甚至可以进行HTTP基本身份验证的加密凭据。在我们收集的近50,000个Nginx配置文件中，最常见的根路径如下：</p><p>   服务器 { 监听80 default_server;服务器名称 _;位置/ static { 别名/ usr / share / nginx / static /; }位置/ api { proxy_pass http：// apiserver / v1 /; }} </p><p>借助斜杠偏移配置错误，由于缺少斜杠，因此有可能沿路径上移一步。 Orange Tsai在Blackhat的演讲“ Breaking Parser Logic！”中使这项技术广为人知。在本次演讲中，他展示了location指令与alias指令结合使用的缺失斜杠如何使读取Web应用程序的源代码成为可能。鲜为人知的是，它还可以与其他指令（例如proxy_pass）一起使用。让我们来分解一下正在发生的事情以及它为什么起作用。</p><p>  如果Nginx服务器运行服务器可以访问的以下配置，则可以假定只能访问http：// apiserver / v1 /下的路径。</p><p>  当请求http：// server / api / user时，Nginx将首先规范化URL。然后，它查看前缀/ api是否与URL匹配，在这种情况下，URL会匹配。然后，从URL中删除该前缀，以便保留路径/ user。然后将此路径添加到proxy_pass URL中，从而得到最终URL http：// apiserver / v1 // user。请注意，URL中存在双斜杠，因为location指令不以斜杠结尾，并且proxy_pass URL路径以斜杠结尾。大多数Web服务器会将http：// apiserver / v1 // user标准化为http：// apiserver / v1 / user，这意味着即使配置错误，所有内容仍将按预期运行，并且可能不会引起注意。</p><p> 通过请求http：//server/api../可以利用这种错误配置，这将导致Nginx请求标准化为http：// apiserver /的URL http：//apiserver/v1/../。这可能产生的影响取决于利用这种错误配置可以达到的效果。例如，这可能导致Apache服务器状态通过URL http：//server/api../server-status公开，或者可以使那些不打算公开访问的路径可访问。</p><p> Nginx服务器配置错误的一个迹象是，当URL中的斜杠被删除时，服务器仍然返回相同的响应。例如，如果http：// server / api / user和http：// server / apiuser返回相同的响应，则服务器可能容易受到攻击。这将导致发送以下请求：</p><p>   一些框架，脚本和Nginx配置不安全地使用Nginx存储的变量。这可能会导致诸如XSS，绕过HttpOnly保护，信息泄露甚至在某些情况下甚至是RCE之类的问题。</p><p>    主要问题是Nginx会将所有URL发送到以.php结尾的PHP解释器，即使该文件在光盘上不存在。正如Nginx创建的“陷阱和常见错误”文档中概述的那样，这是许多Nginx配置中的常见错误。 </p><p>如果PHP脚本试图基于SCRIPT_NAME定义基本URL，则将发生XSS。</p><p>   与Nginx变量有关的另一个错误配置是使用$ uri或$ document_uri而不是$ request_uri。 $ uri和$ document_uri包含规范化的URI，而Nginx中的规范化包括URL解码URI。 Volema发现，在Nginx配置中创建重定向会导致CRLF注入时，通常使用$ uri。</p><p>   HTTP请求的新行字符为\ r（回车）和\ n（换行）。对新行字符进行URL编码将导致以下字符％0d％0a的表示形式。如果将这些字符包含在对服务器的配置错误的请求（例如http：// localhost /％0d％0aDetectify：％20clrf）中，由于$ uri变量包含URL解码的new行字符。</p><p> HTTP / 1.1 302临时移动伺服器：nginx / 1.19.3内容类型：text / html内容长度：145连接：保持活动状态位置：https：//example.com/ 检测：clrf</p><p>   在某些情况下，用户提供的数据可以视为Nginx变量。目前尚不清楚为什么会发生这种情况，但是如本H1报告所示，这种情况并不罕见或不容易测试。如果搜索错误消息，我们可以看到它是在SSI过滤器模块中找到的，从而表明这是由于SSI引起的。</p><p>   我们扫描了这种错误配置，发现了几个实例，用户可以在其中打印Nginx变量的值。发现的易受攻击实例的数量有所下降，这可能表明已对其进行了修补。</p><p>  使用Nginx的proxy_pass，可以拦截后端创建的错误和HTTP标头。如果要隐藏内部错误消息和标头，以便由Nginx处理，则这非常有用。如果后端回答一个，Nginx将自动提供自定义错误页面。但是，如果Nginx不理解这是HTTP响应怎么办？ </p><p>如果客户端向Nginx发送了无效的HTTP请求，则该请求将按原样转发到后端，后端将使用其原始内容进行应答。然后，Nginx将无法理解无效的HTTP响应，而会将其转发给客户端。想象这样的uWSGI应用程序：</p><p>    如果后端的响应状态大于300，proxy_intercept_errors将提供自定义响应。在上面的uWSGI应用程序中，我们将发送500错误，Nginx将拦截该错误。</p><p> proxy_hide_header几乎可以自我解释；它将从客户端隐藏任何指定的HTTP标头。</p><p>        默认情况下，merge_slashes指令设置为“ on”，这是一种将两个或多个正斜杠压缩为一个的机制，因此///将变为/。如果Nginx用作反向代理，并且被代理的应用程序容易受到本地文件包含的影响，则在请求中使用多余的斜杠可能会留出利用空间。 Danny Robinson和Rotem Bar对此进行了详细描述。</p><p>   我们已经创建了一个GitHub存储库，您可以在其中使用Docker来设置您自己的易受攻击的Nginx测试服务器，以及本文中讨论的一些错误配置，然后尝试自己找到它们！</p><p>   Nginx是一个非常强大的Web服务器平台，很容易理解为什么它被广泛使用。但是，通过灵活的配置，您可以犯错误，从而可能会对安全产生影响。请勿勾选这些常见的错误配置，以免让攻击者轻易地入侵您的网站。 Detectify可以检测所有这些错误配置，如果您没有时间手动检查自己，则可以帮助您保护网站免受潜在攻击者的侵害。立即注册免费的2周试用版，开始使用！ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/">https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/错误/">#错误</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/nginx/">#nginx</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1046831.html"><img src="http://img2.diglog.com/img/2021/1/thumb_ed49c8d4e6252fe98ade250bd67ab967.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1046831.html">Extra Crunch综述：Edtech风险投资调查，5个创始人错误，fintech流动性等 </a></div><span class="my_story_list_date">2021-1-30 7:37</span></div><div class="col-sm"><div><a target="_blank" href="/story/1045650.html"><img src="http://img2.diglog.com/img/2021/1/thumb_eeeddd65f8b20bae23fe8696b05ccb79.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1045650.html">F-35驾驶舱的优缺点 </a></div><span class="my_story_list_date">2021-1-22 4:57</span></div><div class="col-sm"><div><a target="_blank" href="/story/1045324.html"><img src="http://img2.diglog.com/img/2021/1/thumb_5f63c04a23404eeb4b88f6421ddb2a74.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1045324.html">2020年Go和C ++中的错误与异常 </a></div><span class="my_story_list_date">2021-1-20 19:33</span></div><div class="col-sm"><div><a target="_blank" href="/story/1044706.html"><img src="http://img2.diglog.com/img/2021/1/thumb_a118864b86975e5d188b679f20b39fc3.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1044706.html">杰米·扎温斯基（Jamie Zawinski）称肉桂屏幕保护程序锁绕过错误为“不合情理” </a></div><span class="my_story_list_date">2021-1-17 19:50</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>