<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>在Postgres中使用Python和Pandas构建推荐引擎</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">在Postgres中使用Python和Pandas构建推荐引擎</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-28 10:04:03</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/c969aaacb6f2e948b3df52e085ae5422.png"><img src="http://img2.diglog.com/img/2020/10/c969aaacb6f2e948b3df52e085ae5422.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>总的来说，我是数据的铁杆粉丝。数据可以告诉您许多有关用户正在做什么的信息，并可以帮助您获得各种洞察力。其中一个方面是根据过去的历史或其他做出类似选择的人提出建议。事实上，几年前，我写了一个小应用，看看我是否可以根据其他葡萄酒的评级来推荐葡萄酒。这是一个很小的应用程序，我只在几个朋友之间分享了这个应用程序，其中一些人的口味相似，一些人的口味不同。起初，这在很大程度上是一个编写推荐引擎的学术练习，但如果我能在这个过程中找到一些我喜欢的新酒，那就太好了。事实证明，它在推荐东西方面比我预期的要有效得多，即使只有一小部分葡萄酒得到了评级。</p><p>我喜欢的另一件事是Postgres(在那里并不令人惊讶)，今天早些时候我开始想，为什么我不能直接在它里面做更多的机器学习呢？是的，有Madlib，但是如果我想编写我自己的推荐引擎呢？所以我总共绕行了几个小时，你瞧，我在Postgres大概可以做比我以前意识到的更多的事情。下面是直接在postgres中设置推荐引擎的快速演练。</p><p>首先，我快速浏览了Python中的一些示例推荐引擎。为了简单起见，我想要一些更小、更简洁的东西--我不太介意它是否利用了其他库。在这种情况下，我遇到了一个干净的rec-engine示例，它利用了Pandas和一个简单的数据模型来使生活变得更容易。</p><p>我获取了示例应用程序使用的确切数据集，并将其转换为SQL以加载它：</p><p>创建表ORDERS(id int，product_id int)；创建PRODUCTS表(id序列，名称文本)；将值(1，1)、(1，2)、(2，3)、(2，10)、(2，13)、(3，3)、(4，8)、(4，9)、(4，12)、(5，3)、(5，5)、(5，7)、(5，12)、(6，1)、(7，5)、(7，13)、(8，4)、(9，3)、(10，3)、(10，13)、(11，1)、(11，8)、(11，4)、(12，8)、(12，12)、(9，3)、(10，3)、(10，13)、(11，8)、(11，4)、(12，8)、(12，12)(13，5)，(13，2)，(13，7)，(14，3)，(14，13)，(14，5)，(15，3)，(15，13)；在产品(#34；名称&34；)中插入值(&#39；棒球球拍#39；)、(#39；棒球手套)、(#39；足球)、(#39；篮球篮圈)、(#39；足球头盔)、(#39；击球手套)、(#39；棒球手套)、(#39；曲棍球棒)、(#39；曲棍球棒)、(#39；球杆)、(#39；曲棍球棒)、(#39；曲棍球棒)、(#39；曲棍球棒)、(#39；曲棍球棒)、(#39；曲棍球棒)、(#39；)、(#39；)、(#39；)、(#39；)、(&#39；)、(&#39；)、(&#39；)、(&#39；)、(&#39；冰鞋、足球、守门员面具、冰球、冰鞋；</p><p>Python示例直接从CSV加载DataFrame。就我而言，我想要波斯格雷斯的一切。在上面的代码中，我拥有表中的所有数据，但是将这些数据放到DataFrame中...。嗯，我并不是很想解析回CSV格式。可能有很多方法可以做到这一点(创建一个JSONB对象，创建一个自定义类型，等等)，但是我选择了一些方法，虽然非常简单，但是可以很容易地遵循……。2个阵列以相同方式排序，然后根据它们创建数据帧。</p><p>因此，为了做到这一点，我将定义我的功能并进口熊猫：</p><p>CREATE OR REPLACE函数getRecommendations(id整数，orderid int[]，orderedproducts int[]，ProductID int[]，ProductNames Text[])返回jsonAS$$import Pandas as PD</p><p>如果您注意到，我传入的不是所有订单，而是一个数组或字典，它是2个数组，然后产品是2个数组。为了将数据传递给SQL函数，我会将它们构造为：</p><p>下一组数据将与刚刚嵌入到我的PostgreSQL函数中的PYHTON示例相同：</p><p>Orders_for_product=Orders[orders.product_id==id].order_id.Unique()；Related_Orders=orders[orders.order_id.isin(orders_for_product)]accompanying_products_by_order=Related_Orders[Related_orders.product_id！=id]NUM_INSTANCE_BY_ADVERATING_PRODUCT=accompanying_products_by_order.groupby(&#34；product_id&#34；)[&#34；product_id&#34；].count().reset_index(name=&#34；实例&#34；)NUM_ORDERS_FOR_PRODUCT=ORDERS_FOR_PRODUCT_SIZPRODUCT_INSTANCES=pd.DataFrame(num_instance_by_accompanying_product)product_instances[&#34；frequency&#34；]=product_instances[&#34；instances&#34；]/num_orders_for_productrecommended_products=pd.DataFrame(product_instances.sort_values(&#34；frequency&#34；，升序=FALSE).head(3))。</p><p>当我进入到我的产品部分时，我将做与我对订单所做的相同的事情--创建一个字典，然后加载DataFrame。最后，我运行将结果集作为JSONB对象返回。当我将所有这些放在一起时，端到端函数如下所示：</p><p>CREATE OR REPLACE函数getRecomendations(id INTEGER，orderid int[]，orderedproducts int[]，ProductId int[]，ProductNames Text[])返回jsonAS$$import熊猫as pd o={&#39；order_id&#39；：orderids，&#39；product_id&#39；：orderedproducts}order=pd.DataFrame(data=o)order_for_product=orders[orders.product_id==id].order_id.ique()：orderedproducts}order=pd.DataFrame(data=o)order_for_product=orders[orders.product_id==id].order_id.ique()；Related_Orders=orders[orders.order_id.isin(orders_for_product)]伴随产品_by_Order=相关订单[Related_orders.product_id！=id]NUM_INSTANCE_BY_ADVERSING_PRODUCT=accompanying_products_by_order.groupby(&#34；product_id&#34；)[&#34；product_id&#34；].count().reset_index(name=&#34；instances&#34；)NUM_ORDERS_FOR_PRODUCT=ORDERS_FOR_PRODUCT。SIZE PRODUCT_INSTANCES=pd.DataFrame(num_instance_by_accompanying_product)PRODUCT_INSTANCES[&#34；FREQUENCE&#34；]=product_instances[&#34；instances&#34；]/num_orders_for_product REPORTED_PRODUCTS=pd.DataFrame(product_instances.sort_values(&#34；frequency&#34；，升序=FALSE).head(3))p={&#39；PRODUCT_ID&#39；：ProductID，&#39；名称&#。用法：ProductNames}Products=pd.DataFrame(Data=p)Recommendated_Products=pd.Merge(Recommendated_Products，Products，on=&#34；PRODUCT_ID&#34；)RETURN recommended_products.to_json(orient=&#34；table&#34；)$$Language&#39；plpython3u&#39；；</p><p>SELECT JSON_PRYTY(getRecommendations(3，(SELECT ARRAY(SELECT ARRAY(SELECT ID FROM ORDERS ORDERS ORDER BY ORDER BY ID)，(SELECT ARRAY(SELECT PRODUCT_ID从ORDERS ORDER BY ID))，(SELECT ARRAY(从产品ORDER BY ID选择名称)；{&#34；schema&#34；：{&#34；fields&#34；：[{&#34；name&#34；：&#34；index&#34；，&#34；类型&#34；：&#34；整数&#34；}，{&#34；名称&#34；：&#34；product_id&#34；，&#34；类型&#34；：&#34；整数&#34；}，{&#34；名称&#34；：&#34；实例&#34；，&#34；类型&#34；：&#34；整数&#34；}，{&#34；名称&#34；：&#34；频率&#34；，&#34；类型&#34；：&#34；编号&#34；}，{&#34；名称&#34；：&#34；名称&#34；，&#34；类型&#34；：&#34；字符串&#34；}]，&#34；PrimiyKey&#34；：[&#34；index&#34；]，&#34；PANAS_VERSION&#34；：&#34；0.20.0&#34；}，&#34；数据&#34；：[{&#34；索引#34；：0，&#34；product_id&#34；：13，&#34；实例&#34；：4，&#34；频率&#34；：0.5714285714，&#34；名称&#34；：&#34；cleats&#34；}，{&#34；index&#34；：1，&#34；product_id&#34；：5，&#34；实例&#34；：2，&#34；频率&#34；：0.2857142857，&#34；名称&#34；：&#34；足球头盔&#34；}，{&#34；index&#34；：2，&#34；product_id&#34；：7，&#34；实例&#34；：1，&#34；频率&#34；：0.1428571429，&#34；名称&#34；：&#34；棒球&#34；}]}。</p><p>仅仅因为你能做某事并不总是意味着你应该做。将所有应用程序逻辑直接嵌入到数据库中可能会使跟踪迁移和发布变得困难。同时，一条复杂的管道每晚进行提取，将一些内容加载到Spark中，生成结果，然后将结果反馈到数据库中，这并不完全是轻量级的。对于plpython3u和pandas，计划使用pg_cron每天运行类似的内容可能是一个简单得多的解决方案。有了SciPy、NumPy和Pandas的组合，这里有很多有趣的潜力，我很想听听其他人提出的@crunchydata有什么实际用途。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://info.crunchydata.com/blog/recommendation_engine_in_postgres_with_pandas_and_python">https://info.crunchydata.com/blog/recommendation_engine_in_postgres_with_pandas_and_python</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/python/">#python</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/推荐/">#推荐</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/product/">#product</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1031446.html"><img src="http://img2.diglog.com/img/2020/10/thumb_51ce4d0597c92556e291d1a74d251921.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031446.html">使用Austin TUI在不降低性能的情况下监视正在运行的Python应用程序</a></div><span class="my_story_list_date">2020-10-27 19:47</span></div><div class="col-sm"><div><a target="_blank" href="/story/1031069.html"><img src="http://img2.diglog.com/img/2020/10/thumb_ca280e09fd83e1f2f155b5d81ec8893c.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031069.html">Python需要改变吗？</a></div><span class="my_story_list_date">2020-10-25 15:53</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030931.html"><img src="http://img2.diglog.com/img/2020/10/thumb_b6d2f44664370d45e7761c500cdb97d3.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030931.html">对159个国家的17K名开发人员的调查：JavaScript是最受欢迎的语言，有1240万活跃开发人员，紧随其后的是Python，有900万，然后是Java，有820万</a></div><span class="my_story_list_date">2020-10-24 14:8</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030098.html"><img src="http://img2.diglog.com/img/2020/10/thumb_98dc7dcc7c64dcbb78b63fb6fc5684d1.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030098.html">Pylo：几个Prolog引擎的Python前端</a></div><span class="my_story_list_date">2020-10-21 0:7</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>