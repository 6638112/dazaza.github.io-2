<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>使用硬件安全模块发布F-Droid Repo</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">使用硬件安全模块发布F-Droid Repo</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-22 15:22:38</div><div class="page_narrow text-break page_content"><p>The following is a tutorial for publishing apps through F-Droid using ahardware security module (HSM). The HSM used in this post is a  NitrokeyHSM2. Other hardware tokens shouldhave similar functionality, but you’ll have to use different commands forinteracting with the HSM.</p><p>以下是使用硬件安全模块(HSM)通过F-Droid发布应用程序的教程。本文中使用的HSM是NitrokeyHSM2。其他硬件令牌应该具有类似的功能，但是您必须使用不同的命令来与HSM交互。</p><p> Storing signing keys in an HSM provides major security advantages once a keyis generated inside a HSM it can never be extracted in plain textform. Instead the data to be signed is sent to the HSM which will producethe signature with the internally held key material. They also apply sometamper resistance technologies which makes physical extraction of the keyvery difficult.</p><p>将签名密钥存储在HSM中提供了主要的安全优势，一旦密钥在HSM中生成，它就永远不能以纯文本形式提取。取而代之的是，要签名的数据被发送到HSM，HSM将用内部保存的密钥材料生成签名。他们还应用了一些电容式电阻技术，这使得密钥的物理提取变得非常困难。</p><p> A signing key for an Android application is part of the identity of saidapp. As a security measure an update for an app can only be installed whenthe new apk is signed with the same private key as the old one. Storing thekeys in an HSM makes sure that even if an attacker compromises yourinfrastructure they will not be able to steal the signing keys. In factthere’s never any ambiguity if an attacker might have gotten access to thekeys. The physical HSM would need to be stolen and that is at least obviousat that point. The intruder could still possibly use the HSM to signmalicious apps though.</p><p>Android应用程序的签名密钥是SAIDAPP身份的一部分。作为一种安全措施，只有当新的APK与旧的APK使用相同的私钥签名时，才能安装应用程序的更新。将密钥存储在HSM中可以确保即使攻击者破坏了您的基础设施，他们也无法窃取签名密钥。事实上，如果攻击者可能已经获得了密钥，那就没有任何含糊之处了。物理HSM将需要被盗，至少在这一点上是显而易见的。尽管如此，入侵者仍有可能使用HSM对恶意应用程序进行签名。</p><p> F-Droid has two signing steps. All apks as well as the repository index aresigned. All of those keys should ideally be stored inside a HSM.</p><p>F-Droid有两个签名步骤。所有APK以及存储库索引都已签名。理想情况下，所有这些密钥都应该存储在HSM中。</p><p> Disclaimer: I asked Nitrokey if they could sponsor some Nitrokey HSMs to get F-Droid’s publishing workflow to work with it. They agreed to send me three of them and asked me to write a blog post about my results.</p><p>免责声明：我问Nitrokey是否可以赞助一些Nitrokey HSM，让F-Droid的出版工作流程与之配合使用。他们同意寄给我三个，并让我写一篇关于我的结果的博客文章。</p><p>  It’s highly recommended to initialize the Nitrokey with a Device KeyEncryption Key (DKEK) before use. This allows key backup and restore ontoanother Nitrokey initialized with the same DKEK in case of a Hardwarefailure. It’s also required for importing existing signing keys into the HSM(see below).</p><p>强烈建议在使用之前使用设备密钥加密密钥(DKEK)初始化Nitrokey。这允许在硬件出现故障时将密钥备份和恢复到使用相同DKEK初始化的另一个Nitrokey上。将现有签名密钥导入HSM也需要该密钥(见下文)。</p><p> A step-by-step guide on how to set this up and the possible options formanaging DKEK shares and passphrases can be found here</p><p>有关如何设置此功能以及管理DKEK共享和密码的可能选项的分步指南可在此处找到。</p><p> Needless to say that you should keep the DKEK stored at a very secure place.</p><p>不用说，你应该把DKEK存放在一个非常安全的地方。</p><p>  The Nitrokey HSM2 can only import keys that are “wrapped” (encrypted) withthe correct DKEK, so to import a plain key from a java keystore this key hasto be manually wrapped with the DKEK first. The manufacturer of theSmartCard inside the Nitrokey HSMs( CardContact) has a tool calledsmartcard-shell which can do this. The tools isn’t that great to use (it’s ajava GUI tool scripted with javascript). I ported this process to a smallcommand-line python tool, which can be found here.</p><p>Nitrokey HSM2只能导入使用正确的DKEK“包装”(加密)的密钥，因此要从Java密钥库导入明文密钥，必须首先使用DKEK手动包装此密钥。Nitrokey HSM(CardContact)内的智能卡制造商有一种叫做智能卡外壳的工具可以做到这一点。这些工具使用起来不是很好(它是用javascript编写的java GUI工具)。我将这个过程移植到一个小的命令行Python工具，可以在这里找到它。</p><p>  You should use the latest 2.0a version ofF-Droid or install it from git master. A few HSM usage issues have recentlybeen ironed out.</p><p>您应该使用最新的2.0a版本Off-Droid或从git master安装它。最近已经解决了一些HSM使用问题。</p><p> Initialize a new repo as follows, this will setup the necessary config filesfor using fdroid with a HSM</p><p>按如下方式初始化新的存储库，这将设置用于HSM的fdroid所需的配置文件。</p><p>  You’ll need to then at least change  keystorepass in  config.py whichneeds to be set to the Nitrokeys smartcard pin. If you have imported anexisting repository signing key, this needs to be set as repo_keyalias. Otherwise you can create a new key directly on the HSM(change  keydname to what the certificate details should look like for yourepo.)</p><p>然后，您至少需要更改config.py中的keystorepass，它需要设置为Nitrokey智能卡管脚。如果您已经导入了现有的存储库签名密钥，则需要将其设置为repo_keyalias。否则，您可以直接在HSM上创建新密钥(将keydname更改为您的repo应该显示的证书详细信息)。</p><p>   From now on everything should work as usual as long as the Nitrokey isplugged into your machine. F-Droid will automatically use it when singingapps with  fdroid publish and when generating a signed repository indexwith  fdroid update.</p><p>从现在开始，只要Nitrokey插到你的机器上，一切都会照常工作。当使用fdroid发布应用程序时，以及在使用fdroid更新生成签名的存储库索引时，F-Droid将自动使用它。</p><p>  The Nitrokey HSM2 has only limited space for signing keys, it can store upto 38 2048 bit RSA keys. There’s a  work-in-progressMR making useof the wrapped key functionality to only load app signing keys onto the HSMon demand. This allows using an unlimited amount of different keys with asingle Nitrokey.</p><p>Nitrokey HSM2用于签名密钥的空间有限，最多可存储38个2048位RSA密钥。有一个正在进行中的MR，它利用封装的密钥功能，只按需将应用程序签名密钥加载到HSM上。这允许对单个Nitrokey使用无限数量的不同密钥。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://f-droid.org/en/2020/10/05/ntrokey-signing.html">https://f-droid.org/en/2020/10/05/ntrokey-signing.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/发布/">#发布</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/硬件/">#硬件</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/硬件安全/">#硬件安全</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/droid/">#droid</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/密钥/">#密钥</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1030454.html"><img src="http://img2.diglog.com/img/2020/10/thumb_48fbd57131941a86aab78078267b7829.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030454.html">特斯拉将在今年年底前广泛发布全自动驾驶</a></div><span class="my_story_list_date">2020-10-22 10:6</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030426.html"><img src="http://img2.diglog.com/img/2020/10/thumb_d2ce81b5c132f2f5335b417dadcb0472.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030426.html">特斯拉发布2020年第三季度业绩</a></div><span class="my_story_list_date">2020-10-22 9:33</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030215.html"><img src="http://img2.diglog.com/img/2020/10/thumb_31bd49c1d21a0bedacb4873c2a3817fd.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030215.html">微软发布基于Chromium的Edge Preview for Linux</a></div><span class="my_story_list_date">2020-10-21 8:46</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030205.html"><img src="http://img2.diglog.com/img/2020/10/thumb_0c6e6d9d6fd42be921aaa0e34015f8bd.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030205.html">特斯拉今天将向早期访问计划(EAP)成员发布FSD Beta</a></div><span class="my_story_list_date">2020-10-21 8:3</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>