<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Ubuntu 20.04的zsys将ZFS快照添加到包管理中</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Ubuntu 20.04的zsys将ZFS快照添加到包管理中</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-31 17:44:28</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/8/fe4528dfa035af634655507af2d68e95.jpg"><img src="http://img.diglog.com/img/2020/8/fe4528dfa035af634655507af2d68e95.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>去年10月，一个实验性的ZFS安装程序出现在Eoan Ermine中，这是2019年的第二个临时Ubuntu版本。下个月，焦点Fossa(Ubuntu的下一个LTS(长期支持)版本)将会放弃，它保留了ZFS安装程序，同时使用羽翼未丰的zsys包为Ubuntu的系统管理增加了几个新功能。</p><p>Phoronix本周末报道说，zsys现在正在软件包管理操作之前拍摄快照，所以我们决定安装最新的Ubuntu 20.04每日版本，看看新功能是如何工作的。</p><p>Focus的安装和其他任何Ubuntu版本差不多，但是它保留了19.10&39；的ZFS安装程序--它仍然隐藏在高级功能后面，仍然被贴上试验性的标签。选择ZFS安装后，您可以对生成的分区布局表示同意-一个主分区用于UEFI引导，三个逻辑分区用于交换、引导ZFS池和根ZFS池。几分钟后，您就可以安装Ubuntu了。</p><p>安装Fossa之后，我们做的第一件事就是验证已安装的zsys版本。APT管理快照是最近在0.4.1中添加的，我们已经学会了不要想当然地认为Linux发行版的测试版或测试版前每日版本上安装的东西是理所当然的。实际上，默认情况下已经安装了Zsys，并且版本是0.4.1。</p><p>在新安装的系统上还没有任何快照，所以我们快速安装了gimp。之后，我们看到zsys已经在rpool上存在的每个数据集中拍摄了快照。在安装新软件包之前拍摄快照意味着，如果出现问题，我们可以很容易地将系统恢复到安装新软件包之前的状态。将系统划分为这么多不同的数据集意味着，反过来，我们只能回滚系统中受软件包管理器影响的那些部分-例如，我们可以回滚软件包，而不会影响用户主目录中的数据。</p><p>在安装GIMP并看到新的快照可用后，我们尝试安装第二个软件包。一个APT安装PV之后，我们再次检查快照。尽管我们仍然找到了在安装GIMP之前拍摄的快照，但是没有新的快照可以回滚我们的PV安装。在又进行了几次没有新快照的实验性安装和删除之后，我们开始grep/etc目录，以找出原因。</p><p>在apt.conf.d中，我们找到一个名为90_zsys_system_autosnapshot的配置文件，该文件将预安装挂钩添加到dpkg。在对软件包系统进行任何更改之前，此预安装挂钩调用zsys-system-autosnapshot。我们不确定为什么没有获得任何新的快照，所以我们尝试直接运行zsys-system-autosnapshot-仍然没有新的快照。</p><p>然后，当我们查看zsys-system-autosnapshot本身时，没有拍摄新快照的原因是显而易见的。最短时间间隔内置于该脚本中，这样，如果距离上次拍摄快照的时间不到20分钟，则它将退出而不执行任何操作。</p><p>我们对这一最小间隔功能持相当怀疑的态度。一方面，一旦您积累了几千个快照，您就可以开始看到文件系统性能问题。另一方面，我们预计会有大量有问题的软件包安装没有以这种方式包含在快照中。</p><p>我们应该注意到，zsys还远远没有完成。该工具承诺提供各种附加功能，而且它已经很有用了--但它仍然缺少普通用户需要看到的许多改进之处。</p><p>我们可以看到，zsys将这些自动生成的快照称为系统状态，zsysctl save将拍摄这些快照，zsysctl show将为我们提供保存了哪些状态集的高级概述。但是，目前还没有相应的zsysctl加载，在加载之前，尝试使用这些保存来实际从灾难中恢复的操作仍将比应有的操作多一点。</p><p>Ubuntu的ZFS安装程序将基础系统分割成令人眼花缭乱的21个独立的数据集，因此zsys确实需要高级的回滚助手。使用zfs命令本身回滚任何单个数据集非常容易-例如，zfs Rollback rpool/userdata/jim_v1qce1@autosys_pmxbuj-但我们预计用户在导航此类命令时不会感到愉快。</p><p>我们完全期待zsysctl最终会添加更容易回滚的功能。它只是还没有出现--至少在没有启用GRUB的引导菜单并重新启动的情况下是不会出现的。</p><p>虽然zsysctl不会在系统运行时公开状态加载功能，但这些功能在引导时出现在GRUB菜单中。然而，在使用默认设置的Ubuntu桌面安装上，GRUB菜单很难通过命令加载--按键的方式取决于UEFI或BIOS引导，而且时间也很危险。我们根本无法在我们的虚拟机上取消隐藏菜单，因为它的启动时间非常快。</p><p>您可以取消隐藏菜单并给自己几秒钟的时间来响应它，方法是使用sudo nano/etc/default/GRUB编辑GRUB默认值。在将GRUB_TIMEOUT_STYLE设置为MENU而不是HIDDEN，并给自己几秒钟时间使用GRUB_TIMEOUT=5进行响应之后，您将需要发出sudo update-GRUB命令来应用您的更改。当你这样做的时候，你会从os-prober中看到一个美观的错误，但是不要担心-它是无害的，而且你的更新实际上已经被应用了。</p><p>一旦我们可以实际看到GRUB菜单，我们就可以导航到History并看到一系列已保存的状态。对于每个州，我们可以选择仅恢复系统，也可以选择恢复系统和userdata-userdata，至少目前是这样，这意味着仅恢复主目录。不幸的是，没有仅恢复用户数据的选项。对于每个选项，您还可以选择是正常引导还是进入恢复模式。</p><p>我们有四个保存的状态可用，并决定拆分中间状态，仅恢复系统状态，返回两个快照。在系统完成引导(比正常时间稍长)之后，我们又看了一眼文件系统引擎盖下的情况。</p><p>系统挂载点看起来并没有什么不同--但仔细观察就会发现，引导环境仍然挂载了一些ZFS快照，而这通常是不会的。这看起来像是未能清理GRUB安装过程中发生的一些魔力，因为快照是以只读方式挂载在它们正常的.zfs目录中的，而不是挂载到生产文件系统会碰到它们的某个位置。</p><p>更重要的是，我们可以看到GRUB和zsys在ZFS层次结构中创建了一个全新的名称空间，即rpool/root/ubuntu_6toptv。我们仍然从最初的名称空间-ubuntu_w01csd-引导，但我们的两组较旧的快照或系统状态已移至较新的名称空间。</p><p>结果是，恢复到较早的系统状态似乎并不像通常的简单ZFS回滚操作那样是破坏性操作。我们一开始有四组快照，在恢复到较旧的快照后，仍有四组快照可用。</p><p>虽然它仍然是决定性的阿尔法-而且实际上还没有连接到运行-zsys也有一个自动修剪陈旧快照的设施。Zsys团队再次选择忽略现有的ZFS术语，将该服务称为垃圾收集服务，而不是将其命名为与快照本身有关的名称。</p><p>这里的词源学reboot似乎源于一种愿望，即让用户以包含多个分组快照的更高级别的术语进行思考。我们不太确定我们对此有何感想。如果处理得当，可能确实会减少最终用户的困惑。不过，sysadmin类型-无论是随意的还是专业的-更有可能受到脚本和现实之间的一层混淆的阻碍。现在，只有sysadmin类型的人才不会看到这些东西，因为它是下一个无法发现的最好的东西。</p><p>实际的工具使用命令jzsysctl service gc-a调用，该命令对系统上存在的所有zsys名称空间执行垃圾收集。如果您自己在相对较新的系统上运行该命令，您可能不会看到任何事情发生。它不会销毁任何快照，除非存在至少20个快照，然后根据年龄对它们进行精简。</p><p>垃圾收集规则集目前在zsys编译之前是可配置的，但在安装后无法访问-构建软件包后将其值硬编码到zsys和二进制文件中。就目前情况而言，最终用户和管理员无法访问这些参数。</p><p>正如Ubuntu开发者Didier Roche在Twitter上解释的那样，Ubuntu20.04系统目前还不能自动运行izsysctl服务GC。罗氏强烈建议暂时不要在任何生产系统上运行该命令，因为它是一个数据破坏功能，目前仍处于开发阶段。一旦它在测试和开发上有更多的时间，就会增加一个系统计时器来定期调用它。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://arstechnica.com/gadgets/2020/03/ubuntu-20-04s-zsys-adds-zfs-snapshots-to-package-management/">https://arstechnica.com/gadgets/2020/03/ubuntu-20-04s-zsys-adds-zfs-snapshots-to-package-management/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/ubuntu/">#ubuntu</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/zfs/">#zfs</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/adds/">#adds</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/快照/">#快照</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1016866.html"><img src="http://img.diglog.com/img/2020/8/thumb_30990b6cc2a5f781791e2cd6d0e02d6c.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1016866.html">Docker安装和升级指南-CentOS和Ubuntu</a></div><span class="my_story_list_date">2020-8-7 22:13</span></div><div class="col-sm"><div><a target="_blank" href="/story/1016814.html"><img src="http://img.diglog.com/img/2020/8/thumb_b628518e48cca4f8458e2d5c69ddbb2d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1016814.html">Ubuntu，2004-20.04 LTS</a></div><span class="my_story_list_date">2020-8-7 8:0</span></div><div class="col-sm"><div><a target="_blank" href="/story/1016542.html"><img src="http://img.diglog.com/img/2020/8/thumb_bed37ca51eb41322881badf47b6085e1.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1016542.html">用WSL和Ubuntu在Windows中构建跨平台的电子应用</a></div><span class="my_story_list_date">2020-8-6 7:14</span></div><div class="col-sm"><div><a target="_blank" href="/story/1015702.html"><img src="http://img.diglog.com/img/2020/8/thumb_2f52f25668fbcec6865d359145763158.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1015702.html">Mark Shuttleworth谈Ubuntu的受欢迎程度和规范盈利能力</a></div><span class="my_story_list_date">2020-8-2 9:11</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>