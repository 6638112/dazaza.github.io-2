<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>使用多阶段构建的较小的Docker映像</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">使用多阶段构建的较小的Docker映像</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-17 06:42:14</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/c51e4db2a1d234d9b999247de43b0b4d.png"><img src="http://img2.diglog.com/img/2020/10/c51e4db2a1d234d9b999247de43b0b4d.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Docker 17引入了一项名为多阶段构建的新功能，大大简化了优化Docker映像的过程。这篇文章概述了多阶段构建，以及如何使用它们来简化Dockerfile并大大减小映像大小。🥳。</p><p>来自戈朗：1.14-编译时的高山ADD。.run go build-o myapp.#将工件复制到最小运行时映像FROM alpine：3.11COPY--from=编译/app/myapp./myappCMD[&#34；./myapp&#34；]。</p><p>减小Docker镜像大小的最简单方法是将依赖项分为编译和运行时两类，然后在使用后移除编译时依赖项。</p><p>不幸的是，依赖项清理非常困难，并且很快就变成了维护的噩梦。多阶段构建完全消除了清除依赖项的需要。✨。</p><p>Docker的多阶段构建提供了使用独立映像进行编译和运行时的能力，从而绕过了依赖项清理。这意味着我们可以简单地将必要的构建构件从编译映像(非常大)复制到不同的(非常小)运行时映像。</p><p>#~#来自Golang的编译映像(~500MB)#：1.14-阿尔卑斯山作为后端#添加源码ADD。。#执行编译运行Go build-o myapp。#~##Runtime Image(~30 MB)#来自Alpine：3.11#Very Minimal Image#从以前的映像COPY--from=backend/app/myapp./myappCMD[&#34；./myapp&#34；]编译成二进制文件COPY--from=backend/app/myapp./myappCMD[&#34；./myapp&#34；]。</p><p>作为参考，高山码头图像为6MB，Golang：Alpine图像为300MB。仅通过从不同的基本映像开始即可节省294MB的空间-不需要依赖项管理！🤯。</p><p>#~#编译和运行时图像(490MB)#来自Golang：1.14-alpineWORKDIR/appADD。.RUN Go build-o myapp.CMD[&#34；./myapp&#34；]</p><p>在上面的GO示例中使用多阶段构建将我们的映像大小从490MB降到只有26MB！在你兴奋之前，重要的是要记住，通过仔细管理和清理依赖关系，我们本可以达到类似的结果，但老实说，如果没有几个小时的不必要的研究，我甚至不知道如何做到这一点。多阶段构建是更好的解决方案。</p><p>多阶段构建不一定是线性的。例如，大多数Web应用程序需要编译多个组件，其中最明显的划分是前端和后端。要实现这一点，我们可以为每个位置创建一个编译映像，然后将两个位置的资源复制到最终的运行时映像中。</p><p>这里是我的个人博客中的一个真实示例，它使用基于节点的映像来构建前端资产，使用Golang基本映像来构建后端服务器。从那里，运行时映像将编译的工件复制到自身。</p><p>#~~~#前端图像#来自节点：12-高山作为前端ADD。./appWORKDIR/APP/FrontendRun NPM install&amp；&amp；npm运行Build#~~~#Backend Image#from golang：1.14-alpine as backendWORKDIR/appADD。.RUN Go Install./...#~~~#Runtime Image#from Alpine：3.11COPY--FROM=前端/APP/前端/静态。/前端/静态COPY--FROM=后端/GO/BIN/WEB。/WebCMD[&#34；./WEB&#34；]。</p><p>上面的示例使用了Go，因为它在运行时依赖项之间有明确的分离，但是对于更复杂的情况又如何呢？例如，Python需要Python解释器才能执行。Python包还经常依赖于C库来执行诸如数据库交互和图像操作之类的性能关键型任务。一般来说，Python的策略与Go相同，但由于Python应用程序有更多的运行时依赖项需要考虑，这使得策略变得复杂。</p><p>#~~~#编译镜像#来自Python：3.8-alpine as编译#编译Python包所需的安装依赖项Run apk add--no-cache postgreSQL-dev libffi-dev MUSL-dev GCC#创建PythonVirtualenv并使用它运行python-m venv/opt/venvENV path=&#34；/opt/venv/bin：$path&#34；#add requirements fileADD requirements.txt.#安装要求(通过不缓存来节省空间)运行pip install-r requirements.txt--no-cache-dir#~~~#运行时映像##注意：Python库很大，但需要FROM python：3.8-alpine#安装所需的运行时依赖项Run apk add--无缓存postgreSQL-libs#将代码复制到映像中#提示：使用.dockerIgnore排除大项目或机密COPY。.#从viralenv复制依赖项并使用itCOPY--from=编译/opt/venv/opt/venvENV path=&#34；/opt/venv/bin：$path&#34；#定义命令以运行Django appCMD Daphne--port 8000--bind 0.0.0.0 project.asgi：application。</p><p>您将注意到，分离Python应用程序的编译和运行时依赖项比Go复杂得多。运行时映像的大小约为200MB，而我们的GO映像约为20MB。这是解释型语言需要更多依赖项的一个不幸的副作用，而且无法真正避免。然而，它仍然比使用未经优化的Python映像要好，后者将超过500MB。</p><p>Docker的.dockerIgnore应该与多阶段构建结合使用。使用添加或复制命令将文件添加到映像时，可以使用.dockerIgnore排除包含敏感机密的不必要文件夹或文件。缓存目录、Git数据和文档等内容占用大量空间，应该忽略。最重要的是，应该忽略包含秘密或敏感信息的文件，这样它们就不会散布在图像内部(特别是如果它是公开可访问的)。</p><p>这真的是所有关于Docker的多阶段构建的知识。这是我最喜欢的现代Docker功能之一，我仍然不敢相信与过去的糟糕时代相比，它做了这么多优化。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://codesalad.dev/blog/smaller-docker-images-using-multi-stage-builds-8">https://codesalad.dev/blog/smaller-docker-images-using-multi-stage-builds-8</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/docker/">#docker</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/阶段/">#阶段</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/编译/">#编译</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1026303.html"><img src="http://img2.diglog.com/img/2020/9/thumb_cc5bfb0230e49dc3bc3bb7680f205cd9.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1026303.html">简单的WireGuard Docker网络设置</a></div><span class="my_story_list_date">2020-9-25 5:32</span></div><div class="col-sm"><div><a target="_blank" href="/story/1023393.html"><img src="http://img2.diglog.com/img/2020/9/thumb_4b1e079520b716db8d5b43146ede3545.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1023393.html">使用conda-pack缩小您的Conda Docker映像</a></div><span class="my_story_list_date">2020-9-12 2:50</span></div><div class="col-sm"><div><a target="_blank" href="/story/1020098.html"><img src="http://img.diglog.com/img/2020/8/thumb_f50cf7950020549f7a8c734cdfd9993d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1020098.html">Docker to Rate Limit镜像拉取</a></div><span class="my_story_list_date">2020-8-25 8:40</span></div><div class="col-sm"><div><a target="_blank" href="/story/1019350.html"><img src="http://img.diglog.com/img/2020/8/thumb_23b15fc551a88bd6c3b96cf317281423.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019350.html">深入研究Python的官方Docker图像</a></div><span class="my_story_list_date">2020-8-20 21:45</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>