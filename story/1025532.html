<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>真的是雅塔里街吗？</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">真的是雅塔里街吗？</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-22 18:17:40</div><div class="page_narrow text-break page_content"><p>本博客之前曾研究过DOS的BIOS模块中的一个非常非常奇怪的代码片段。简单地说，当决定引导扇区是否可能具有有效的BPB时，DOS会检查第一个字节是相对跳转(操作码E9h)还是短跳转(操作码EBh)，这两个字节都由不同的DOS版本使用。但是它也用69h操作码检查“直接跳转”。</p><p>在日期为1987年5月1日的MS-DOS 3.21 Oak源文件中，代码如下所示：</p><p>CMP字节PTR cs：[DiskSector]，069H；是直接跳转吗？JE Check_Signature；不需要查找NOP CMP字节PTR cs：[DiskSector]，0E9H；DOS 2.0跳转？JE CHECK_Signature；不需要NOP CMP字节PTR cs：[DiskSector]，0EBH；跳短怎么样。JNE BadDisk CMP字节PTR cs：[DiskSector]+2,090H；下一个是NOP吗？JNE坏盘。</p><p>代码在日期为1987年7月24日的MS-DOS 3.3 OAK源文件中没有实质性差异：</p><p>CMP字节PTR cs：[DiskSector]，069H；是直接跳转吗？JE CHECK_BPB_MediaByte；DON&#39；T是否需要查找NOP CMP字节PTR cs：[DiskSector]，0E9H；DOS 2.0跳转？JE CHECK_BPB_MediaByte；不需要NOP CMP字节PTR cs：[DiskSector]，0EBH；跳短怎么样。JNE INVALIDBOOTSEC CMP字节PTR cs：[DiskSector]+2,090H；下一个是NOP吗？JNE INVALIDBOOTSEC。</p><p>标签不同，但逻辑是相同的。但是，当然x86上没有这种“直接跳转”，69h操作码(8086上没有文档记录，更高的CPU上没有IMUL)毫无意义。那是什么？</p><p>一位读者之前曾提出这样的想法，即该代码可能是为了支持Atari St软盘。这在某种程度上是有道理的，但在某种程度上是不合理的。让我们从它是如何说不通的开始吧。</p><p>Atari ST使用的是摩托罗拉68000 CPU(ST指的是16/32，指的是68kCPU的外部和内部数据宽度)，虽然引导扇区以跳转指令(BRA.S)开始，但其操作码是60h而不是69h。</p><p>但雅达利ST确实有很多方面是有意义的。Atari ST是少数使用胖格式软盘的非PC、非x86平台之一。Atari ST使用的是与PC相同的3.5英寸DD(最初)介质。雅达利ST和DOS之间在3.5英寸软盘上交换数据实际上是可能的。</p><p>雅达利ST于1985年推出。神秘的操作码69h检查是什么时候添加到DOS中的？碰巧的是，我们可以相当准确地确定时间线。检查PC DOS 3.1和3.2中的IBMBIO.COM清楚地显示，69h检查是在DOS 3.2中添加的。PC DOS 3.1中的IBMBIO.COM文件的日期为1985年3月，而PC DOS 3.2中的IBMBIO.COM文件的日期为1985年12月。换句话说，微软一定是在1985年的某个时候添加了69h检查。</p><p>从时间轴的角度来看，在1985年添加对Atari ST媒体的支持是很有意义的。碰巧PC DOS 3.2是第一个支持3.5英寸媒体的。</p><p>“直接跳转”的评论不那么明显，但至少有一定的道理。68k BRA指令是直接的，因为相对偏移量是指令操作码序列的一部分。与68k JMP不同，BRA指令不支持任何类型的间接寻址。</p><p>操作码不匹配也可以解释。可能是打字错误，因为“9”和“0”在键盘上紧挨着。这也可能是误读；特别是在手写文本上，草率地写成的0可能看起来像一个9。此外，8086程序员很可能不知道68k操作码，因此不会发现错误。</p><p>更重要的是，错误的检查可能很容易逃脱测试。首先，Atari ST可引导软盘确实以60h操作码(不是69h)开始，但非可引导ST软盘无论如何都没有这样的要求。除了DOS不需要有效的BPB即可使用软盘。如果在Atari ST上格式化720k软盘，则无法识别其引导扇区，但可以识别其胖介质字节。DOS将能够很好地使用它，并且测试人员不会注意到BPB有效性检查失败。</p><p>请注意，对于雅达利ST 800K软盘而言，上述情况并非如此。除非DOS具有有效的BPB(即引导扇区)，否则DOS将无法正确处理这些问题。然而，这可能是没有经过测试的东西。</p><p>总而言之，即使它实际上是错误的，添加69h检查来支持Atari ST磁盘并不像看起来那么不可思议。这绝不是确凿的证据，但也不疯狂。而且，如果正如间接证据所显示的那样，在1985年添加该检查是为了支持某些非x86平台，那么Atari ST也是一个很好的解释。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="http://www.os2museum.com/wp/really-atari-st/">http://www.os2museum.com/wp/really-atari-st/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/atari/">#atari</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/dos/">#dos</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>