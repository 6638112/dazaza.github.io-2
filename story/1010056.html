<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>核心BGP-插入BGP</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">核心BGP-插入BGP</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-06 11:18:44</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/7/f8c4fa988907bc2f0d5aa0515ef6860c.png"><img src="http://img.diglog.com/img/2020/7/f8c4fa988907bc2f0d5aa0515ef6860c.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>BGP是支持Internet的众多协议之一。你很有可能听说过它，即使你不在计算机网络领域或周围工作。如果您不熟悉，我将尝试提供一些简短的背景知识：</p><p>在最后一个要点上展开，由于BGP的灵活性和可扩展性，很难准确总结它是如何/在哪里使用的。各个IETF工作组继续为90年代初形成的协议发布与BGP相关的RFC。随着BGP领域和应用范围的扩大，我们需要能够跟上形势的软件。</p><p>在这篇文章中，我将提供我使用BGP的一些个人经验和历史，并介绍一个新的BGP库CoreBGP，该库可用于构建下一代支持BGP的应用程序。</p><p>2010年10月，我第一次参加在佐治亚州亚特兰大举行的NANOG会议，原因是我在工作中意外陷入网络运营工程师的职位。当时我在一家中等规模的主机提供商工作，对BGP很感兴趣。据维基百科(Wikpedia)报道，一到亚特兰大，我就依稀记得有些困惑，因为我告诉一名出租车司机，我需要下车的酒店在桃树街(Peachtree St.)。后来我了解到，亚特兰大有71条街道的名字里有一个“桃树”(Peachtree)的变体。</p><p>最终，我到达了我需要去的地方，我参加的第一个演讲是菲利普·史密斯(Philip Smith)所著的互联网服务提供商的BGP技术。在深入了解ISP使用的技术之前，Philip先从基础开始。在这次演讲中，很多灯泡都为我熄灭了。我还没有看到任何其他的BGP演示涵盖如此广泛的信息，但仍然以初学者友好的方式进行，对任何专家来说都是有用的，而且非常有趣。</p><p>快进10年后，我在运营使用BGP的网络方面获得了相当多的经验。最近几年，我转向了软件工程，在那里我有机会实现各种支持BGP的应用程序，以实现网络可观察性、数据分析和SDN目的。</p><p>每次我启动一个新的支持BGP的应用程序时，我都必须回答以下问题--哪个现有的BGP实现应该是它的基础？</p><p>在为数不多的开放源码BGP实现中，我亲身体验过使用以下各项的项目：</p><p>鸟牌在需要丰富的政策语言的地方大放异彩。GoBGP有一个功能丰富的GRPC API，可以作为库嵌入。OpenDayLight的BGP实施是更大的SDN控制器解决方案的一部分，并广泛支持BGP-LS。Quagga可以可靠地产生MRT转储，并且已经存在很长时间了，尽管我相信FRRouting现在被认为是它的继任者。</p><p>这些都是成熟的、成熟的实现。其中一些已在大型ISP、云提供商和互联网交换点投入生产。它们是专门构建的，并进行各种权衡以适应其用例(编程语言、线程模型、数据结构、应用编程接口等…)。。</p><p>但是，如果我们构建的东西与这些广泛使用的实现的主要用例不一致，该怎么办呢？如果我们选择围绕它们建立，我们可能会被最终带来负担的决定所束缚。在我们自己的数据结构中交换路由表，或者添加新的NLRI都不是一件容易的事。即使一个实现打算以库的形式嵌入，它仍然会让我们陷入资源消耗的困境。显然需要插入或挂钩到BGP FSM的特定部分，而不需要继承进入成熟的BGP守护进程的决策。</p><p>在第27届IEEE国际网络协议会议(ICNP)上，卢万天主教大学的一个小组提交了一篇关于插件化路由协议案例的论文：</p><p>摘要路由协议(如BGP和OSPF)是Internet服务提供商(ISP)网络的关键组件。这些协议和运营商的要求会随着时间的推移而发展，但网络运营商通常需要很多年才能说服他们的不同路由器供应商和IETF扩展路由协议。一些网络运营商，特别是在企业和数据中心，已经采用了集中控制的软件定义网络(SDN)，以使其更加灵活。我们提出了一种新的实现路由协议的方法，使网络运营商能够在创新的同时仍然使用分布式路由协议，从而保持了与集中式路由方法相比的所有优势。我们使用能够执行插件的虚拟机来扩展路由协议。这些插件通过简单的API扩展协议或修改其底层算法，以满足运营商的特定需求。我们修改了FRRouting提供的OSPF和BGP实现，并通过几个用例演示了我们方法的适用性。</p><p>在他们的论文中，他们提出了一种插入前面提到的开源BGP实现FRRouting的方法。插件存在于函数级别，或者在调用之前(PRE)、作为替换(REPLACE)或者就在返回之前(POST)。他们的BGP插件主要关注消息的接收，并在不久之后做出决定：</p><p>BGP守护进程也进行了类似的扩展。我们在从邻居接收BGP消息的函数、过滤器和决策过程内部添加插入点。我们还向uBPF VM执行的插件公开特定函数。</p><p>通过利用链接到FRRouting协议实现的用户空间eBPF VM(UBPF)，他们对插件沙箱采取了一种聪明的方法。每个插件编译成eBPF字节码，并在所述VM内运行。可以加载和卸载插件，而不会影响主要协议实现。使用eBPF VM还允许他们利用所有先前存在的Linux内核工具。</p><p>我发现这种方法很鼓舞人心，但仍然与我的用例不太匹配：</p><p>插件似乎是围绕“传入”事件或消息构建的。如果我想要向对等设备注入更新消息，而不管FRRouting想要发送什么，该怎么办？</p><p>FRRouting在构建时并没有考虑到这个插件模型。对FRRouting的更改/更新将导致VM钩点的维护难题。</p><p>eBPF字节码通常从C编译而来，与更现代的语言相比，编写C可能会很耗时。</p><p>这种经验和研究使我创建了CoreBGP，这是一个BGP库，我可以在支持BGP的应用程序中重用它。</p><p>CoreBGP是用GO编写的BGP库，它使用事件驱动的可插拔模型实现BGP FSM。它公开了一个API，使用户能够：</p><p>CoreBGP不解码更新消息(除了报头验证)、管理路由表或发送自己的更新消息。这些责任都向下传递给用户。因此，目标用户是希望承担该责任的人。</p><p>//Plugin是BGP对端插件。当对等方的FSM在发送Open消息之前//处于连接状态时，类型插件接口{//GetCapability被激发。返回的功能包含在发送给对等体的//Open消息中。GetCapability(Peer*PeerConfig)[]*Capability//在OpenSent状态下，当收到对端//的Open消息时，会触发OnOpenMessage。返回非NIL通知将导致将其发送到//对等方，并且FSM将转换到空闲状态。/根据RFC5492，BGP扬声器应仅在缺少所需功能//时发送通知；应//忽略未知或不支持的功能。OnOpenMessage(Peer*PeerConfig，Capability[]*Capability)*Notification//Onestablished在对等方的FSM转换到ESTABLISHED//状态时触发。当从对等体接收到Update//消息时，将触发返回的UpdateMessageHandler。/提供的编写器可用于在//FSM当前已建立状态的生存期内向对等方发送更新消息。一旦OnClose()激发，就应该//丢弃它。Onestabled(Peer*PeerConfig，Writer UpdateMessageWriter)UpdateMessageHandler//OnClose在对等方的FSM从ESTABLISHED//状态转换出来时触发。OnClose(Peer*PeerConfig)}</p><p>下面是一个示例插件，它在对等点进入/离开已建立状态以及接收到更新消息时进行记录：</p><p>type plugin struct{}func(p*plugin)GetCapability(c*corebp.PeerConfig)[]*corebp.Capability{caps：=make([]*corebp.Capability，0)return caps}func(p*plugin)OnOpenMessage(Peer*coregp.PeerConfig，Capability[]*corebackgp.Capability)*coregp.Notification{return nil}func(p*plugin)OnOpenMessage(Peer*corebgp.PeerConfig，Capability[]*corebp.Capability)*coregp.Notification{return nil}func(p*plugin)。Println(&#34；Peer establed&#34；)//发送肋骨末尾编写器。WriteUpdate([]byte{0，0，0，0})return p.handleUpdate}func(p*plugin)OnClose(Peer*coregp.PeerConfig){log.。Println(&#34；Peer Closed&#34；)}func(p*plugin)handleUpdate(Peer*coregp.PeerConfig，u[]byte)*corebp.Notification{log.。Printf(&#34；获取len的更新消息：%d&#34；，len(U))返回空}。</p><p>插件在添加到管理其生存期的服务器时会附加到对等方：</p><p>路由器ID：=网络。ParseIP(&#34；192.0.2.1&#34；)srv，错误：=corebgp。如果err！=nil{log.。Fatalf(&#34；构造服务器时出错：%v&#34；，err)}p：=&amp；plugin{}err=srv。AddPeer(&amp；corebgp.PeerConfig{IP：NET.。解析IP(&#34；198.51.100.10&#34；)，本地服务器：65001，远程服务器：65010，}，p)如果错误！=无{log.。Fatalf(&#34；添加对等方时出错：%v&#34；，错误)}。</p><p>CoreBGP足够灵活，可以作为成熟的BGP守护进程的基础。相反，它也适合简单地记录更新消息的用例，如上面的示例所暗示的那样。</p><p>有关更多示例，请查看示例目录和pkg.go.dev以获取完整的API。CoreBGP是开源的，可以在GitHub上获得。请试一试，报告错误，并贡献自己的力量！</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.jordanwhited.com/posts/corebgp-plugging-in-to-bgp/">https://www.jordanwhited.com/posts/corebgp-plugging-in-to-bgp/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/bgp/">#bgp</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/plugging/">#plugging</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>