<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>tty demystified（2008） </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">tty demystified（2008） </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-15 22:32:32</div><div class="page_narrow text-break page_content"><p>TTY子系统是Linux设计的核心，并且unix一般来说。幸办的是，它的重要性往往被忽视，并且很难找到关于它的介绍性文章。我相信，Linux中的基本了解对于开发人员和高级用户至关重要。</p><p> 尽管如此：你要看的东西不是特别优雅。 Infact，TTY子系统 - 虽然来自用户的相当职能＆＃39; S点观察 - 是一种特殊情况的扭曲一点混乱。要了解这个游戏的方式，我们必须及时回去。</p><p>  1869年，股票机被发明。它是一个由打字机组成的电动机械手机，长对电线和自动取款器，其目的是将股票价格分配在长距离内。这一概念逐渐发展成为基于ASCII的Teletype。在LARGENETWORK中曾在世界各地连接的TELEX，它被称为TOPEX，它用于转移商业电影邮，而是连接到任何计算机。</p><p> 同时，计算机 - 仍然相当大的高效，但能够对多阵列变得足够强大，以便在实时与用户互动。当命令行最终重新策略了旧批处理模型时，电传兑型被用作输入和输出设备，因为它们在市场上很容易获得。</p><p> 周围有一个多型电网模型，略有不同，软件兼容层的软件兼容层。在UNIX世界中，该方法是让操作系统内核处理所有低leveldetail，如字长，波特率，流量控制，平价，控制规范，为基本的线路编辑等。花式游标运动，颜色输出和其他高级功能在20世纪70年代后期通过诸如VT-100的固态视频终端，留给了应用。</p><p> 在现在的时候，我们发现自己在一个物理图型和视频终端实际上​​灭绝的世界。除非您访问博物馆或Ahardware爱好者，否则所有的TTY＆＃39;重新看出，将被仿真的视频 - 软件模拟真实的东西。但正如我们正要的那样，旧铸铁野兽的遗产仍然潜伏在句子下面。</p><p>   终端（物理电网）的用户类型。该终端通过计算机上的UART（通用异步接收器和扫描器）连接到UART（通用异步接收器和扫描）连接。操作系统包含一个UART驱动程序，它管理字节的物理传输，包括奇偶校验检查和FlowControl。在Naïve系统中，UART驱动程序将直接向某些应用程序传递到某些应用程序。但这种方法缺乏关注的基本特征： </p><p>线编辑。大多数用户在键入时犯错误，因此Backspacekey通常有用。这当然可以通过ApplicationSthem来实现，但根据UNIX设计理念，应用程序应尽可能简单。因此，作为方便，操作系统提供了编辑缓冲区和一些基本编辑命令（退格，擦除字，清除线，重印），默认在线纪律内部启用。高级应用程序可能会禁用这些功能在原始模式中占据线路项而不是默认烹饪（或规范）模式。大多数交互式应用程序（编辑器，邮件用户代理，shell，依赖于诅咒或readline的所有程序）在原始模式下运行，并处理所有行编辑命令sthem。该行纪律还包含回波和线路之间的字符呼应和自动转换的选项。将其视为可确保的内核级SED（1），如果您愿意。</p><p> 顺便提及，内核提供了几个不同的线路学科。它们的唯一内容是一次连接到给定的串行设备。提供行编辑的DefaultDiscipline称为N_TTY（驱动程序/ char / n_tty.c，如果您＆＃39; re感到冒险）。其他目的用于其他目的，例如管理分组交换数据（PPP，IRDA，串行小鼠），但这在本文的范围之外。</p><p> 会话管理。用户可能想要运行多个程序，并一次与它们交互。如果程序进入围绕循环，则用户可能希望杀死它或暂停它。在后台中遇到的程序应该能够在尝试编写终端之前执行，此时它们应该被暂停。同样，用户输入只能被引导到前台程序。操作系统中的TTY驱动程序中的这些功能（驱动程序/ char / tty_io.c）。</p><p> 操作系统进程是＆＃34;活着＆＃34; （具有执行上下文），这意味着它可以执行操作。 TTY驱动程序并不活跃;在OrcuitEnteDTerMinology中，TTY驱动器是一种被动对象。它有一些数据字段和SomeMethods，但它实际上可以做某事的唯一方法是从进程的上下文或内核interpthandler调用其中一个方法。行纪律同样是一种被动实体。</p><p> 一起，一个特定的UART驱动程序，线路纪律实例Andtty驱动程序可以称为TTY设备，或有时只是TTY。 Auser进程可以通过操纵/ dev下的相应设备文件来影响任何TTY设备的行为。需要对DeviceFile写入权限，因此当用户在特定TTY上登录时，该用户必须使用设备文件的所有者。这是传统上由登录（1）程序完成，该程序与root权限运行。</p><p>   除了系统现在必须处理Modemhangup情况之外，这并没有太大变化。</p><p>   TTY驱动程序和线路纪律表现就像在PROVIAUSEXAMPLES中一样，但没有涉及UART或物理终端。相反，在软件中模拟了视频终端（包括帧缓冲器和图形字符属性的复杂状态机），并在软件中仿真，逆转到VGA显示。 </p><p>控制台子系统有点僵化。如果我们将终端仿真移动到Userland，事情会变得更灵活（AndAbstract）。这就是Xterm（1）及其克隆的工作方式：</p><p>  为了便于将终端仿真移动到Usillland，而仍然是沉降的沉降子系统（会话管理和线条纪律），则发明了伪终端或PTY。当您可能已经猜到时，当您开始运行伪终端中的伪终端时，àla屏幕（1）或ssh（1）时，事情会变得更加复杂。</p><p> 现在让＆＃39; s返回回来，看看所有这些都适合工程模型。</p><p>    通过作业控制信号停止，或者因为它正在被调试器追踪。</p><p> 通过运行ps l，您可以看到哪些进程正在运行，并且eSesleping。如果进程正在睡觉，WChan列（＆＃34;等待队列的姓名＆＃34;等待队列的姓名）将告诉您进程正在等待的内核事件。</p><p> $ PS LF UID PID PID PRI NI vsz RSS WCHAN STAT TTY TIME Command0 500 5942 5928 15 0 12916 1460 DED SS PTS / 14 0:00  -  / BIN / BASH0 500 12235 5942 15 0 21004 3572等待S + PTS / 14 0:01 VIM INDEX.PHP0 500 12580 12235 15 0 8080 1440 WAIT S + PTS / 14 0:00 / BIN / BASH-C（PS L）＆GT; / TMP / V727757 / 1 2＆GT;＆amp; 10 500 12581 12580 15 0 4412 824  - r + pts / 14 0:00 ps l</p><p> ＆＃34;等待＆＃34;等待队列对应于等待（2）SYSCALL，因此这些进程将随时移动到运行状态。在其中一个流程中的一个状态变化时，将移动到运行状态。有两个睡眠状态：中断，不间断的睡眠。可中断睡眠（最常见的情况）意味着虽然该过程是等待队列的一部分，但是当发送信号时，它可能实际上也可以被击落到运行状态。如果在Hease源代码内部查看，您会发现等待Anevent的任何内核代码必须检查Schedule（）返回后是否暂时挂起，并在该情况下中止TheSysCall。 </p><p>在上面的PS列表中，STAT列显示每种过程的当前状态。相同的列还可以包含一个或多个属性，或标志：</p><p>    作业控制是按^ z暂停程序时会发生什么，或者在使用＆amp中启动后台的程序时;工作与过程组相同。 Mabs，FG和BG等内部shell命令可用于操作现有的作业内存。每个会话由会话领导者管理，TheShell，它使用复杂协议与内核密切合作，使用复杂的信号和系统调用。</p><p>       TTY驱动程序（/ dev / pts / 0）。大小：45x13Controlling过程组：（101）前景过程组：（103）UART配置（忽略，因为这是一个XTerm）：波特率，奇偶校验，单词长度等.Line纪律配置：熟/原始模式，线路校正，中断字符的含义.Line纪律状态：编辑缓冲区（当前为空），缓冲区内的光标位置等。</p><p> Pipe0可读端（连接到PID 104作为文件描述符0）可写结束（连接到PID 103作为文件描述符1）缓冲区</p><p> 基本思想是，每个管道都是一份工作，因为应该同时操纵（停止，恢复，杀死）的每个过程的工作。＆＃39; s为什么kill（2）允许您向整个进程组发送信号。默认情况下，fork（2）将新创建的子进程放在同一进程组作为其父的子程序，以便例如来自Keyboard的A ^ C将影响父母和子。但是，作为其遗产领导职责的一部分，壳牌每次都会创造一个新的过程组，每次都是一个管道。</p><p> TTY驱动程序跟踪前景过程组ID，但仅以满足于Apassive方式。会议领导者必须明确更新此信息必要。同样，TTY驱动程序跟踪ConnectentTerminal的大小，但是必须由终端Miltator甚至由用户明确地更新此信息。</p><p> 正如您在上图所示，几个进程都有/ dev / pts / 0连接到它们的标准输入。但只有前景job（ls |排序管道）将从Thetty接收输入。同样，只允许前景作业写入TTYDEVICE（在默认配置中）。如果猫进程要尝试TTY，内核将使用信号暂停它。 </p><p>现在让＆＃39;仔细看看TTY驱动程序如何，线路中的线程中的驾驶员和内核中的uart驱动程序与userland进程通信。</p><p> UNIX文件（包括TTY设备文件）当然可以从Andwr写入读取，并通过魔法IOCTL（2）呼叫（UNIX的Swissarmy-Cha）进行了进一步操作，其中已经定义了许多相关的操作。尽管如此，必须从进程启动IOCTL请求，因此当内核需要与Anapplication异步传播时，他们可以享受＆＃39; t。</p><p> 在Hitchhiker和第39页的Galaxy指南中，Douglas Adams提到了一种沉闷的沉闷行星，居住在一堆沮丧的人类和某种动物的动物患有锋利的牙齿，通过在大腿中咬住艰难的大学与人类沟通。这与Unix相似，其中通过向它们发送瘫痪或致命信号来使用过程中的内核管理。处理可以拦截一些信号，并尝试适应情况，但大多数人都不会＆＃39; t。</p><p> 因此，信号是一种粗略机制，允许内核与过程进行交流。 Unix中的信号aren＆＃39; t干净或一般;相反，每个信号是唯一的，必须单独研究。</p><p> 您可以使用命令kill -l查看系统实现的信号。这是它可能的样子：</p><p> $ kill -l 1）Sighup 2）Sigint 3）Sigquit 4）Sigtrap 6）SigBrt 7）SigBus 8）Sigfpe 9）Sigkill 10）SiguSR1 11）SigseGV 12）SigSeG13）Sigpipe 14）Sigpipe 14）Sigpipe14）Sigpipe 14） Sigtkflt17）SigCont 19）Sigttep21）SigtTIN 22）Sigtttou 23）Sigurg 24）SigXCPU25）SigVtORM 27）SigVtOF 28）SigWinCH29）SigWinCH29）SigWinCH29）SigiO 30）SigpWr 31）Sigsys 34）Sigsys 34）Sigsys 34）Sigsys 34）Sigsys 36）Sigsys 36 ）SIGRTMIN + 2 37）SIGRTMIN + 3 38）SIGRTMIN + 439）SIGRTMIN + 6 42）SIGRTMIN + 722）SIGRTMIN + 843）SIGRTMIN + 944）SIGRTMIN + 10 45）SIGRTMIN + 11 46）SIGRTMIN +1247）SIGRTMIN + 13 48）SIGRTMIN + 14 49）SIGRTMIN + 15 50）SIGRTMAX-1451）SIGRTMAX-12 53）SIGRTMAX-11 54）SIGRTMAX-1055）SIGRTMAX-9 56）SIGRTMAX-8 57 ）SIGRTMAX-7 58）SIGRTMAX-5 60）SIGRTMAX-4 61）SIGRTMAX-3 62）SIGRTMAX-263）SIGRTMAX-1 64）SIGRTMAX</p><p> 如您所见，信号以1.然而，当它们以Bitmasks（例如，PS S的输出）中被达到时，对应的最低有效位对应信号1。 </p><p>本文将专注于以下信号：Sighup，Sigint，Sigquit，SigPipe，Sigchld，Sigstop，Sigcont，Sigtstp，Sigttin，Sigttou和Sigwinch。</p><p> 稍微通过检测到挂起次要条件时，UART驱动程序将由UART驱动程序发送到整个会话。通常，这将杀死所有流程。一些人，例如Nohup（1）和屏幕（1），脱离他们的会话（和TTY），使他们的子流程赢得了＆＃39; T通知Ahangup。</p><p> 如果在输入流中出现在输入流中的交互式注意性字符（通常^ c，具有ASCIICODE 3）的交互式注意字符（通常为^ c），则SIGINT将由TTY驱动器发送到当前的前景作业。有关TTY设备的访问权限的任何人都可以更改Anteractive Internition Character并切换此功能;此外，Shesession Manager跟踪每项作业的TTY配置，并在有作业交换机时进行更新。</p><p> sigquit就像sigint一样，但quit字符通常是^ \，默认操作是不同的。</p><p> 内核将SigPipe发送到尝试写入管道的任何进程。这很有用，因为否则就是这样的工作|头永远不会终止。</p><p> 当流程模具或更改状态（停止/继续）时，内核将SIGCHLD发送到其父进程。 SigChld信号携带额外的信息，即终止过程的进程ID，用户ID，退出状态（Ortermination信号）和一些执行时间表。会话领导者（shell）跟踪其使用该作业的作业。</p><p> 该信号将无条件地暂停接收者，即它的信令可以＆＃39; t被重新配置。但是，请注意，在作业控制期间，内核发送的Sigstopisn＆＃39;相反，^ z aliantriggers一个sigtstp，它可以由应用程序拦截。然后可以是拍摄的。将光标移动到屏幕的底部，在屏幕上以oothers将终端放在已知状态，随后将自己放置使用Sigstop睡眠。 </p><p>Sigcont将取消暂停停止的过程。当用户调用fg命令时，它是通过theShell明确发送的。由于Sigstop可以＆＃39; t expected，意外的sigcont信号可能指示该过程一时暂停，然后悬挂。</p><p> sigtstp就像sigint和sigquit一样，但魔法字符是纯粹的^ z和默认动作是暂停过程。</p><p> 如果在后台作业中的进程尝试从TTY设备读取，则Thetty将SigTtin信号发送到整个作业。这通常会挂起job。</p><p> 如果后台作业中的进程尝试写入TTY设备，则将TTYSENDS将SIGTTOU信号传输到整个作业。这通常会暂停作业。可以以每张图3的基础关闭此功能。</p><p> 如上所述，TTY设备会跟踪终端大小，但需要手动更新此信息。每当发生这种情况时，TTY都会将SigWinch提供给前景作业。行为良好的交互式应用程序，例如编辑，反应此，从TTYDevice获取新的终端大小并相应地重绘。</p><p>  假设您正在编辑（基于终端）编辑器的文件中的文件。光标位于屏幕中间的某个地方，编辑器是关于一些处理器密集型任务的编辑器，例如在大文件上搜索和置换。现在你按^ z。由于LinioSicipline已被配置为拦截此字符（^ Z为Asingle Byte，并且使用ASCII代码26），您必须等待编辑器才能实现其任务并开始从TTY设备开始读取。相反，线路学科会立即将SIGTSTP发送到前景过程组。此过程格组包含编辑器，以及它创建的任何子进程。</p><p> 编辑器已为SIGTSTP安装了一个信号处理程序，因此内核将进程执行到执行信号处理程序代码。此代码通过编写TTY设备，通过编写相应的控制序列序列，将CURSORTO移动到屏幕上的最后一行。由于编辑器仍处于前台，因此根据要求传输ControlSequences。但是，编辑器发送一个sigstop才能自己的进程组。 </p><p>编辑现在已经停止了。将此事实报告给SEARS SIGCHLD信号排列，该信号包括悬挂过程的ID。当前台作业中的所有进程被暂停时，该领导者从TTY设备中读取当前配置，并存储稍后检索。会议领导者继续使用IOCTL Call的TTY将自己安装为tyurnent前景过程组。然后，它打印出类似的东西＆＃34; [1] +停止＆＃34;通知用户暂停工作的作业。</p><p> 此时，PS（1）将告诉您编辑程序进程是停止状态（＆＃34; t＆＃34;）。如果我们尝试通过使用BGBuilt-In shell命令唤醒它，或者通过使用kill（1）将sigcont发送到Process（es），编辑器将开始执行其Sigcont信号处理程序。这名来的处理程序可能会尝试通过写入Thtty设备来重绘编辑GUI。但由于编辑现在是后台作业，因此TTY设备将允许它。相反，TTY会将SIGTTOU发送给编辑器，停止迭代。这一事实将使用Sigchld传达给会话领导者，并且贝壳将再次写作＆＃34; [1] +停止＆＃34;到终端。</p><p> 但是，当我们键入FG时，shell首先恢复早期保存的LinedicIsine配置。它通知TTY驱动程序从现在开始将编辑工作视为前景作业。 Andinally，它将Sigcont信号发送到过程组。编辑器处理重绘它的GUI，这次它不会被简易卢比打扰它现在是前景作业的一部分。</p><p>   在xterm中运行是的，你会看到很多＆＃34; Y＆＃34;穿过你的眼睛。自然而然，是的，是的，能够生成＃34; Y＆＃34;线的线条比XTerm应用程序更快，能够解析它们，更新其帧缓冲区，与X服务器通信，以滚动窗口等。这些程序如何合作有可能？</p><p> 答案在于阻止I / O.伪终端只能在内核缓冲区内保留ACAINAIN的数据量，并且当该缓冲区饱和时，符号是呼叫写入（2），然后写（2）将阻止，将是进程移动到其保留的可中断液体状态XTerm进程有机会关闭一些缓冲字节。</p><p> 如果TTY连接到串行端口，则发生同样的事情。是的，能够以高于例如9600波特率的速率传输数据，但如果串行端口限制为该速度，则内核很快就会填满，任何后续写入（2）调用块Process（或失败错误代码eagain如果进程存在哈重锁定I / O）。</p><p> 如果我告诉过你怎么办，即使内核缓冲区中有空间剩余空间，也可以显式地将TTY放在Ablocking状态中？这是直到通知，每个过程都试图将（2）写入TTYAutomicoct块。这种功能的使用是什么？ </p><p>假设我们＆＃39;在9600波兰语中与一些旧的VT-100硬件进行交谈。 我们发送了  ...... </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="http://www.linusakesson.net/programming/tty/index.php">http://www.linusakesson.net/programming/tty/index.php</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/tty/">#tty</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>