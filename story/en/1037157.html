<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>DwarFS：快速的高压缩率只读文件系统DwarFS: A fast high compression read-only file system</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">DwarFS: A fast high compression read-only file system<br/>DwarFS：快速的高压缩率只读文件系统</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-30 00:53:43</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/11/cded299ce5f14bae2b82503879a340e1.png"><img src="http://img2.diglog.com/img/2020/11/cded299ce5f14bae2b82503879a340e1.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>DwarFS is a read-only file system with a focus on achieving  veryhigh compression ratios in particular for very redundant data.</p><p>DwarFS是一个只读文件系统，着重于实现非常高的压缩率，尤其是对于非常冗余的数据。</p><p> This probably doesn&#39;t sound very exciting, because if it&#39;s redundant,it  should compress well. However, I found that other read-only,compressed file systems don&#39;t do a very good job at making use ofthis redundancy. See  here for a comparison with othercompressed file systems.</p><p> 这听起来可能并不令人兴奋，因为如果有多余的话，它应该可以很好地压缩。但是，我发现其他只读压缩文件系统在利用此冗余方面做得不好。请参阅此处以与其他压缩文件系统进行比较。</p><p> DwarFS also  doesn&#39;t compromise on speed and for my use cases I&#39;vefound it to be on par with or perform better than SquashFS. For myprimary use case,  DwarFS compression is an order of magnitude betterthan SquashFS compression, it&#39;s  4 times faster to build the filesystem, it&#39;s typically faster to access files on DwarFS and it usesless CPU resources.</p><p> DwarFS也不影响速度，在我的用例中，我发现它与SquashFS相当或性能更好。在我的主要用例中，DwarFS压缩比SquashFS压缩好一个数量级，构建文件系统的速度快4倍，访问DwarFS上的文件的速度通常更快，并且它占用了无用的CPU资源。</p><p>  Clustering of files by similarity using a similarity hash function.This makes it easier to exploit the redundancy across file boundaries.</p><p>  使用相似性哈希函数按相似性将文件聚类，这使得跨文件边界的冗余利用变得更加容易。</p><p> Segmentation analysis across file system blocks in order to reducethe size of the uncompressed file system. This saves memory whenusing the compressed file system and thus potentially allows forhigher cache hit rates as more data can be kept in the cache.</p><p> 跨文件系统块的分段分析，以减小未压缩文件系统的大小。这在使用压缩文件系统时节省了内存，因此有可能允许更高的缓存命中率，因为可以在缓存中保留更多数据。</p><p> Highly multi-threaded implementation. Both the file system creation tool as well as the FUSE driver are able to make good use of themany cores of your system.</p><p> 高度多线程的实现。文件系统创建工具和FUSE驱动程序都能够充分利用系统的许多核心。</p><p>  I started working on DwarFS in 2013 and my main use case and majormotivation was that I had several hundred different versions of Perlthat were taking up something around 30 gigabytes of disk space, andI was unwilling to spend more than 10% of my hard drive keeping themaround for when I happened to need them.</p><p>  我从2013年开始研究DwarFS，主要用例和主要动机是我有数百个不同版本的Perl占用了大约30 GB的磁盘空间，并且我不愿意花费超过10％的硬盘驱动器来维持它们当我碰巧需要它们的时候</p><p> Up until then, I had been using  Cromfsfor squeezing them into a manageable size. However, I was getting moreand more annoyed by the time it took to build the filesystem imageand, to make things worse, more often than not it was crashing afterabout an hour or so.</p><p>直到那时，我一直在使用Cromfs将它们压缩到可管理的大小。但是，构建文件系统映像所花费的时间让我越来越烦，而且使事情变得更糟的是，它通常在大约一个小时后崩溃。</p><p> I had obviously also looked into  SquashFS,but never got anywhere close to the compression rates of Cromfs.</p><p> 我显然也研究过SquashFS，但是从来没有接近Cromfs的压缩率。</p><p> This alone wouldn&#39;t have been enough to get me into writing DwarFS,but at around the same time, I was pretty obsessed with the recentdevelopments and features of newer C++ standards and really wanteda C++ hobby project to work on. Also, I&#39;ve wanted to do somethingwith  FUSEfor quite some time. Last but not least, I had been thinking aboutthe problem of compressed file systems for a bit and had some ideasthat I definitely wanted to try.</p><p> 仅凭这一点还不足以让我编写DwarFS，但是大约在同一时间，我非常着迷于更新的C ++标准的最新开发和功能，并真的希望可以从事C ++的业余项目。另外，我很想用FUSE做一些事情。最后但并非最不重要的一点是，我一直在思考压缩文件系统的问题，并且有一些我肯定想尝试的想法。</p><p> The majority of the code was written in 2013, then I did a coupleof cleanups, bugfixes and refactors every once in a while, but Inever really got it to a state where I would feel happy releasingit. It was too awkward to build with its dependency on Facebook&#39;s(quite awesome)  folly libraryand it didn&#39;t have any documentation.</p><p> 大部分代码是在2013年编写的，然后我不时进行几次清理，错误修复和重构，但Inever确实使它处在一个让我感到高兴的状态。依赖于Facebook的（非常了不起的）愚蠢的库来构建它太尴尬了，它没有任何文档。</p><p> Digging out the project again this year, things didn&#39;t look as grimas they used to. Folly now builds with CMake and so I just pulledit in as a submodule. Most other dependencies can be satisfiedfrom packages that should be widely available. And I&#39;ve writtensome rudimentary docs as well.</p><p> 今年再次挖掘该项目时，情况看起来不再像以前那样糟糕。 Folly现在使用CMake进行构建，因此我只是将其作为子模块加入了。可以从应该广泛使用的软件包中满足大多数其他依赖关系。而且我还写了一些基本文档。</p><p>    It uses both  Boost and Folly, though the latter isincluded as a submodule since very few distributions actuallyoffer packages for it. Folly itself has a number of dependencies,so please check  herefor an up-to-date list.</p><p>    它同时使用Boost和Folly，尽管后者作为子模块包含在内，因为很少有发行版为此提供软件包。 Folly本身具有许多依赖性，因此请在此处查看最新列表。</p><p> It also uses  Facebook Thrift,in particular the  frozen library, for storing metadata in a highlyspace-efficient, memory-mappable and well defined format. It&#39;s alsoincluded as a submodule, and we only build the compiler and a veryreduced library that contains just enough for DwarFS to work.</p><p> 它还使用Facebook Thrift（尤其是冻结的库）以高空间效率，内存可映射和定义明确的格式存储元数据。它也作为子模块包括在内，我们只构建编译器和一个精简的库，其中包含足以使DwarFS正常工作的库。</p><p> Other than that, DwarFS really only depends on FUSE3 and on a setof compression libraries that Folly already depends on (namely lz4,  zstdand  liblzma).</p><p>除此之外，DwarFS实际上仅依赖FUSE3和Folly已经依赖的一组压缩库（即lz4，zstd和liblzma）。</p><p>   # apt install \ g++ \ clang \ cmake \ make \ bison \ flex \ pkg-config \ binutils-dev \ libboost-all-dev \ libevent-dev \ libdouble-conversion-dev \ libgoogle-glog-dev \ libgflags-dev \ libiberty-dev \ liblz4-dev \ liblzma-dev \ libzstd-dev \ libsnappy-dev \ libjemalloc-dev \ libssl-dev \ libunwind-dev \ libfmt-dev \ libfuse3-dev \ libsparsehash-dev \ zlib1g-dev</p><p>   ＃apt install \ g ++ \ clang \ cmake \ make \ bison \ flex \ pkg-config \ binutils-dev \ libboost-all-dev \ libevent-dev \ libdouble-conversion-dev \ libgoogle-glog-dev \ libgflags-dev \ libiberty-dev \ liblz4-dev \ liblzma-dev \ libzstd-dev \ libsnappy-dev \ libjemalloc-dev \ libssl-dev \ libunwind-dev \ libfmt-dev \ libfuse3-dev \ libsparsehash-dev \ zlib1g-dev</p><p> You can pick either  clang or  g++, but at least recent  clangversions will produce substantially faster code:</p><p> 您可以选择clang或g ++，但是至少最近的clangversions会产生更快的代码：</p><p> $ hyperfine ./dwarfs_test-*Benchmark #1: ./dwarfs_test-clang-O2 Time (mean ± σ): 9.425 s ± 0.049 s [User: 15.724 s, System: 0.773 s] Range (min … max): 9.373 s … 9.523 s 10 runs Benchmark #2: ./dwarfs_test-clang-O3 Time (mean ± σ): 9.328 s ± 0.045 s [User: 15.593 s, System: 0.791 s] Range (min … max): 9.277 s … 9.418 s 10 runs Benchmark #3: ./dwarfs_test-gcc-O2 Time (mean ± σ): 13.798 s ± 0.035 s [User: 20.161 s, System: 0.767 s] Range (min … max): 13.731 s … 13.852 s 10 runs Benchmark #4: ./dwarfs_test-gcc-O3 Time (mean ± σ): 13.223 s ± 0.034 s [User: 19.576 s, System: 0.769 s] Range (min … max): 13.176 s … 13.278 s 10 runs Summary &#39;./dwarfs_test-clang-O3&#39; ran 1.01 ± 0.01 times faster than &#39;./dwarfs_test-clang-O2&#39; 1.42 ± 0.01 times faster than &#39;./dwarfs_test-gcc-O3&#39; 1.48 ± 0.01 times faster than &#39;./dwarfs_test-gcc-O2&#39;$ hyperfine -L prog $(echo ./mkdwarfs-* | tr &#39; &#39; ,) &#39;{prog} --no-progress --log-level warn -i tree -o /dev/null -C null&#39;Benchmark #1: ./mkdwarfs-clang-O2 --no-progress --log-level warn -i tree -o /dev/null -C null Time (mean ± σ): 4.358 s ± 0.033 s [User: 6.364 s, System: 0.622 s] Range (min … max): 4.321 s … 4.408 s 10 runs Benchmark #2: ./mkdwarfs-clang-O3 --no-progress --log-level warn -i tree -o /dev/null -C null Time (mean ± σ): 4.282 s ± 0.035 s [User: 6.249 s, System: 0.623 s] Range (min … max): 4.244 s … 4.349 s 10 runs Benchmark #3: ./mkdwarfs-gcc-O2 --no-progress --log-level warn -i tree -o /dev/null -C null Time (mean ± σ): 6.212 s ± 0.031 s [User: 8.185 s, System: 0.638 s] Range (min … max): 6.159 s … 6.250 s 10 runs Benchmark #4: ./mkdwarfs-gcc-O3 --no-progress --log-level warn -i tree -o /dev/null -C null Time (mean ± σ): 5.740 s ± 0.037 s [User: 7.742 s, System: 0.645 s] Range (min … max): 5.685 s … 5.796 s 10 runs Summary &#39;./mkdwarfs-clang-O3 --no-progress --log-level warn -i tree -o /dev/null -C null&#39; ran 1.02 ± 0.01 times faster than &#39;./mkdwarfs-clang-O2 --no-progress --log-level warn -i tree -o /dev/null -C null&#39; 1.34 ± 0.01 times faster than &#39;./mkdwarfs-gcc-O3 --no-progress --log-level warn -i tree -o /dev/null -C null&#39; 1.45 ± 0.01 times faster than &#39;./mkdwarfs-gcc-O2 --no-progress --log-level warn -i tree -o /dev/null -C null&#39;</p><p> $ hyperfine ./dwarfs_test-*基准测试＃1：./dwarfs_test-clang-O2时间（平均值±σ）：9.425 s±0.049 s [用户：15.724 s，系统：0.773 s]范围（最小值…最大值）：9.373 s …9.523 s 10运行基准测试2：./dwarfs_test-clang-O3时间（平均值±σ）：9.328 s±0.045 s [用户：15.593 s，系统：0.791 s]范围（最小…最大）：9.277 s…9.418 s 10运行基准3：./ dwarfs_test-gcc-O2时间（平均值±σ）：13.798 s±0.035 s [用户：20.161 s，系统：0.767 s]范围（最小…最大）：13.731 s…13.852 s 10运行基准4：./ dwarfs_test-gcc-O3时间（平均值±σ）：13.223 s±0.034 s [用户：19.576 s，系统：0.769 s]范围（最小…最大）：13.176 s…13.278 s 10次运行摘要'./dwarfs_test-clang-O3'比'./dwarfs_test-clang-O2'1.42±0.01倍快于'./dwarfs_test-gcc-O3'1.48±0.01倍于'./dwarfs_test -gcc-O2'$超精细-L prog $（echo ./mkdwarfs-* | tr''，）'{prog} --no-progress --log-level警告-i tree -o / dev / null -C null'基准测试＃1：./ mkdwarfs-clang-O2-无进度-日志级别警告-i树-o / dev / null -C空时间（平均值±σ）：4.358 s±0.033 s [用户：6.364 s，系统：0.622 s]范围（最小值…最大值）：4.321 s…4.408 s 10运行基准测试2：./ mkdwarfs-clang-O3 -no-progress -log级警告-i tree -o / dev / null -C空时间（平均值±σ）：4.282 s±0.035 s [用户：6.249 s，系统：0.623 s]范围（最小值…最大值）：4.244 s…4.349 s 10次运行基准3：./ mkdwarfs-gcc-O2-否进行-日志级别警告-i树- o / dev / null -C空时间（平均值±σ）：6.212 s±0.031 s [用户：8.185 s，系统：0.638 s]范围（最小…最大）：6.159 s…6.250 s 10次运行基准4 ：。 / mkdwarfs-gcc-O3 --no-progress --log-level警告-i树-o / dev / null -C空时间（平均值±σ）：5.740 s±0.037 s [用户：7.742 s，系统：0.645 s]范围（最小值…最大值）：5.685 s…5.796 s十次运行摘要'./mkdwarfs-clang-O3 --no-progress --log-level警告-i tree -o / dev / null -C null'跑比'./mkdwarfs-clang-O2 -no-progress -log-level warn -i tree -o / dev / null -C null'快1.02±0.01倍fa ster比'./mkdwarfs-gcc-O3 --no-progress --log级警告-i tree -o / dev / null -C null'1.45±0.01倍比'./mkdwarfs-gcc-O2-不进行--log级警告-i树-o / dev / null -C null'</p><p>         If possible, try building with clang as your compiler, this willmake DwarFS significantly faster. If you have both gcc and clanginstalled, use:</p><p>         如果可能，请尝试使用clang作为编译器进行构建，这将使DwarFS明显更快。如果同时安装了gcc和clang，请使用：</p><p>  To build with experimental Lua support, you need to install both lua and  luabind. The latter isn&#39;t very well maintained and Ihope to get rid of the dependency in the future. Add  -DWITH_LUA=1to the  cmake command line to enable Lua support.</p><p>  要使用实验性Lua支持进行构建，您需要同时安装lua和luabind。后者的维护不是很好，我希望将来摆脱依赖。将-DWITH_LUA = 1添加到cmake命令行以启用Lua支持。</p><p>        Please check out the man pages for  mkdwarfsand  dwarfs.  dwarfsck will be built and installedas well, but it&#39;s still work in progress.</p><p>        请查看有关mkdwarfsand dwarfs的手册页。 dwarfsck也将被构建和安装，但仍在进行中。</p><p>   These tests were done on an Intel(R) Xeon(R) CPU D-1528 @ 1.90GHz6 core CPU with 64 GiB of RAM. The system was mostly idle duringall of the tests.</p><p>这些测试是在具有64 GiB RAM的Intel®Xeon®CPU D-1528 @ 1.90GHz6核心CPU上完成的。在所有测试期间，系统大部分处于空闲状态。</p><p> The source directory contained  1139 different Perl installationsfrom 284 distinct releases, a total of 47.65 GiB of data in 1,927,501files and 330,733 directories. The source directory was freshlyunpacked from a tar archive to a 850 EVO 1TB SSD, so most of itscontents were likely cached.</p><p> 源目录包含来自284个不同发行版的1139种不同的Perl安装，1,927,501个文件和330,733个目录中的47.65 GiB数据。源目录是从tar存档中刚解压缩到850 EVO 1TB SSD的，因此大多数内容可能都已缓存。</p><p> I&#39;m using the same compression type and compression level forSquashFS that is the default setting for DwarFS:</p><p> 我对SquashFS使用的压缩类型和压缩级别与DwarFS的默认设置相同：</p><p> $ time mksquashfs install perl-install.squashfs -comp zstd -Xcompression-level 22Parallel mksquashfs: Using 12 processorsCreating 4.0 filesystem on perl-install.squashfs, block size 131072.[=====================================================================-] 2107401/2107401 100%Exportable Squashfs 4.0 filesystem, zstd compressed, data block size 131072 compressed data, compressed metadata, compressed fragments, compressed xattrs, compressed ids duplicates are removedFilesystem size 4637597.63 Kbytes (4528.90 Mbytes) 9.29% of uncompressed filesystem size (49922299.04 Kbytes)Inode table size 19100802 bytes (18653.13 Kbytes) 26.06% of uncompressed inode table size (73307702 bytes)Directory table size 19128340 bytes (18680.02 Kbytes) 46.28% of uncompressed directory table size (41335540 bytes)Number of duplicate files found 1780387Number of inodes 2255794Number of files 1925061Number of fragments 28713Number of symbolic links 0Number of device nodes 0Number of fifo nodes 0Number of socket nodes 0Number of directories 330733Number of ids (unique uids + gids) 2Number of uids 1 mhx (1000)Number of gids 1 users (100)real 69m18.427suser 817m15.199ssys 1m38.237s</p><p> $ time mksquashfs install perl-install.squashfs -comp zstd -Xcompression-level 22并行mksquashfs：使用12个处理器在perl-install.squashfs上创建4.0文件系统，块大小为131072。[============= ================================================== =====-] 2107401/2107401 100％可移动Squashfs 4.0文件系统，zstd压缩，数据块大小131072压缩数据，压缩元数据，压缩片段，压缩xattrs，压缩id重复项已删除文件系统大小4637597.63 KB（4528.90 MB）9.29％未压缩文件系统大小（49922299.04 KB）的Inode表大小19100802字节（18653.13 KB）未压缩的inode表大小的26.06％（73307702字节）目录表大小19128340字节（18680.02 KB）的46.28％未压缩目录表大小（41335540字节）找到重复的文件1780387索引节点数2255794文件数1925061片段数28713符号链接数0设备节点数0 fifo节点数0袜子数et节点0目录数330733 ID数（唯一uids + gids）2 uids数1 mhx（1000）gids数1用户（100）实际69m18.427suser 817m15.199ssys 1m38.237s</p><p>  $ time ./mkdwarfs -i install -o perl-install.dwarfs02:48:48.592349 scanning install02:49:00.603961 waiting for background scanners...02:50:18.391026 assigning directory and link inodes...02:50:18.736203 finding duplicate files...02:50:28.618659 saved 28.2 GiB / 47.65 GiB in 1782826/1927501 duplicate files02:50:28.618742 ordering 144675 inodes by similarity...02:50:29.196793 144675 inodes ordered [578ms]02:50:29.196877 assigning file inodes...02:50:29.199317 building metadata...02:50:29.199403 building blocks...02:50:29.199450 saving names and links...02:50:29.702547 updating name and link indices...03:03:45.892033 waiting for block compression to finish...03:03:45.897608 saving chunks...03:03:45.924720 saving directories...03:03:49.809202 waiting for compression to finish...03:04:31.251687 compressed 47.65 GiB to 555.7 MiB (ratio=0.0113884)03:04:31.737918 filesystem created without errors [943.1s]-------------------------------------------------------------------------------scanned/found: 330733/330733 dirs, 0/0 links, 1927501/1927501 filesoriginal size: 47.65 GiB, dedupe: 28.2 GiB (1782826 files), segment: 12.42 GiBfilesystem: 7.027 GiB in 450 blocks (754024 chunks, 144675/144675 inodes)compressed filesystem: 450 blocks/555.7 MiB written|=============================================================================|real 15m43.302suser 115m10.704ssys 2m56.544s</p><p>  $ time ./mkdwarfs -i install -o perl-install.dwarfs02：48：48.592349扫描install02：49：00.603961等待后台扫描程序... 02：50：18.391026分配目录和链接索引节点... 02：50：18.736203查找重复文件... 02：50：28.618659在1782826/1927501中保存了28.2 GiB / 47.65 GiB复制文件02：50：28.618742通过相似性排序144675个inode ... 02：50：29.196793 144675个inode已排序[578ms] 02:50： 29.196877分配文件索引节点... 02：50：29.199317构建元数据... 02：50：29.199403构建块... 02：50：29.199450保存名称和链接... 02：50：29.702547更新名称和链接索引。 ..03：03：45.892033等待块压缩完成... 03：03：45.897608保存块... 03：03：45.924720保存目录... 03：03：49.809202等待压缩完成... 03 ：04：31.251687将47.65 GiB压缩为555.7 MiB（ratio = 0.0113884）03：04：31.737918创建的文件系统没有错误[943.1s] ---------------------- -------------------------------------------------- -------扫描/傅nd：330733/330733 dirs，0/0链接，1927501/1927501文件原始大小：47.65 GiB，重复数据删除：28.2 GiB（1782826文件），段：12.42 GiB文件系统：7.027 GiB在450块（754024块，144675/144675 inode）中压缩文件系统：450块/555.7 MiB写入| ========================================= ==================================== |真实15m43.302suser 115m10.704ssys 2m56.544s</p><p> So in this comparison,  mkdwarfs is more than 4 times faster than  mksquashfs.In total CPU time, it&#39;s actually 7 times less CPU resources.</p><p> 因此，在此比较中，mkdwarfs比mksquashfs快4倍以上，在总CPU时间上，实际上比CPU资源少7倍。</p><p> $ ls -l perl-install.*fs-rw-r--r-- 1 mhx users 582654491 Nov 29 03:04 perl-install.dwarfs-rw-r--r-- 1 mhx users 4748902400 Nov 25 00:37 perl-install.squashfs</p><p> $ ls -l perl-install。* fs-rw-r--r-- 1个mhx用户582654491 Nov 29 03:04 perl-install.dwarfs-rw-r--r-- 1个mhx用户4748902400 Nov 25 00： 37个perl-install.squashfs</p><p> In terms of compression ratio, the  DwarFS file system is more than 8 timessmaller than the SquashFS file system. With DwarFS, the content has been compressed down to 1.1% (!) of its original size.</p><p>在压缩率方面，DwarFS文件系统比SquashFS文件系统小8倍以上。使用DwarFS，内容已压缩到其原始大小的1.1％（！）。</p><p> DwarFS also features an option to recompress an existing file system witha different compression algorithm. This can be useful as it allows relativelyfast experimentation with different algorithms and options without requiringa full rebuild of the file system. For example, recompressing the above filesystem with the best possible compression ( -l 9):</p><p> DwarFS还具有一个选项，可以使用不同的压缩算法来重新压缩现有文件系统。这很有用，因为它允许使用不同的算法和选项进行相对较快的实验，而无需完全重建文件系统。例如，使用最佳压缩率（-l 9）重新压缩上述文件系统：</p><p> $ time ./mkdwarfs --recompress -i perl-install.dwarfs -o perl-lzma.dwarfs -l 903:18:44.670116 filesystem rewritten [659.4s]-------------------------------------------------------------------------------scanned/found: 0/0 dirs, 0/0 links, 0/0 filesoriginal size: 47.65 GiB, dedupe: 0 B (0 files), segment: 0 Bfilesystem: 7.027 GiB in 450 blocks (0 chunks, 0/0 inodes)compressed filesystem: 450 blocks/457.5 MiB written|============================================================ |real 10m59.538suser 120m51.326ssys 1m43.097s$ ls -l perl-*.dwarfs-rw-r--r-- 1 mhx users 582654491 Nov 29 03:04 perl-install.dwarfs-rw-r--r-- 1 mhx users 479756881 Nov 29 03:18 perl-lzma.dwarfs</p><p> $ time ./mkdwarfs --recompress -i perl-install.dwarfs -o perl-lzma.dwarfs -l 903：18：44.670116重写了文件系统[659.4s] --------------- -------------------------------------------------- --------------扫描/找到：0/0个目录，0/0个链接，0/0个文件原始大小：47.65 GiB，重复数据删除：0 B（0个文件），段：0 B文件系统：450块（0块，0/0索引节点）中的7.027 GiB压缩文件系统：450块/457.5 MiB写入| ======================= | ================================== |真实10m59.538suser 120m51.326ssys 1m43.097s $ ls -l perl-*。dwarfs-rw-r--r-- 1个mhx用户582654491 Nov 29 03:04 perl-install.dwarfs-rw-r--r-- 1个mhx用户479756881 Nov 29 03:18 perl-lzma。矮人</p><p> This reduces the file system size by another 18%, pushing the totalcompression ratio below 1%.</p><p> 这样可以将文件系统的大小再减少18％，使总压缩率低于1％。</p><p> In terms of how fast the file system is when using it, a quick testI&#39;ve done is to freshly mount the filesystem created above and runeach of the 1139  perl executables to print their version.</p><p> 就文件系统使用时的速度而言，我所做的一项快速测试是重新安装上面创建的文件系统，并运行每个1139 perl可执行文件以打印其版本。</p><p> $ hyperfine -c &#34;umount mnt&#34; -p &#34;umount mnt; ./dwarfs perl-install.dwarfs mnt -o cachesize=1g -o workers=4; sleep 1&#34; -P procs 5 20 -D 5 &#34;ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P{procs} sh -c &#39;\$0 -v &gt;/dev/null&#39;&#34;Benchmark #1: ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P5 sh -c &#39;$0 -v &gt;/dev/null&#39; Time (mean ± σ): 4.092 s ± 0.031 s [User: 2.183 s, System: 4.355 s] Range (min … max): 4.022 s … 4.122 s 10 runs Benchmark #2: ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P10 sh -c &#39;$0 -v &gt;/dev/null&#39; Time (mean ± σ): 2.698 s ± 0.027 s [User: 1.979 s, System: 3.977 s] Range (min … max): 2.657 s … 2.732 s 10 runs Benchmark #3: ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P15 sh -c &#39;$0 -v &gt;/dev/null&#39; Time (mean ± σ): 2.341 s ± 0.029 s [User: 1.883 s, System: 3.794 s] Range (min … max): 2.303 s … 2.397 s 10 runs Benchmark #4: ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P20 sh -c &#39;$0 -v &gt;/dev/null&#39; Time (mean ± σ): 2.207 s ± 0.037 s [User: 1.818 s, System: 3.673 s] Range (min … max): 2.163 s … 2.278 s 10 runs</p><p> $ hyperfine -c“ umount mnt” -p“ umount mnt; ./dwarfs perl-install.dwarfs mnt -o cachesize = 1g -o worker = 4; sleep 1” -P procs 5 20 -D 5“ ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P {procs} sh -c'\ $ 0 -v> / dev / null'“基准＃1：ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P5 sh -c'$ 0 -v> / dev / null'时间（平均值±σ）：4.092 s±0.031 s [用户：2.183 s，系统：4.355 s]范围（ min…max）：4.022 s…4.122 s 10次运行基准测试2：ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P10 sh -c'$ 0 -v> / dev / null'时间（平均值±σ）：2.698 s±0.027 s [用户：1.979 s，系统：3.977 s]范围（最小值…最大值）：2.657 s…2.732 s 10次运行基准测试3：ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P15 sh -c'$ 0 -v> / dev / null'时间（平均值±σ）：2.341 s±0.029 s [用户：1.883 s，系统：3.794 s]范围（ min…max）：2.303 s…2.397 s 10次运行基准测试4：ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P20 sh -c'$ 0 -v> / dev / null'时间（平均值±σ）：2.207 s±0.037 s [用户：1.818 s，系统：3.673 s]范围（最小…最大）：2.163 s…2.278 s 10次运行</p><p> These timings are for  initial runs on a freshly mounted file system,running 5, 10, 15 and 20 processes in parallel. 2.2 seconds means thatit takes only about 2 milliseconds per Perl binary.</p><p> 这些时间是针对新安装的文件系统上的初始运行，并行运行5、10、15和20个进程。 2.2秒意味着每个Perl二进制文件仅花费大约2毫秒。</p><p> Following are timings for  subsequent runs, both on DwarFS (at  mnt)and the original EXT4 (at  install). DwarFS is around 15% slower here:</p><p>以下是在DwarFS（位于mnt）和原始EXT4（位于安装）上后续运行的时间。 DwarFS的速度大约慢15％：</p><p> $ hyperfine -P procs 10 20 -D 10 -w1 &#34;ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P{procs} sh -c &#39;\$0 -v &gt;/dev/null&#39;&#34; &#34;ls -1 install/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P{procs} sh -c &#39;\$0 -v &gt;/dev/null&#39;&#34;Benchmark #1: ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P10 sh -c &#39;$0 -v &gt;/dev/null&#39; Time (mean ± σ): 655.8 ms ± 5.5 ms [User: 1.716 s, System: 2.784 s] Range (min … max): 647.6 ms … 664.3 ms 10 runs Benchmark #2: ls -1 install/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P10 sh -c &#39;$0 -v &gt;/dev/null&#39; Time (mean ± σ): 583.9 ms ± 5.0 ms [User: 1.715 s, System: 2.773 s] Range (min … max): 577.0 ms … 592.0 ms 10 runs Benchmark #3: ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P20 sh -c &#39;$0 -v &gt;/dev/null&#39; Time (mean ± σ): 638.2 ms ± 10.7 ms [User: 1.667 s, System: 2.736 s] Range (min … max): 629.1 ms … 658.4 ms 10 runs Benchmark #4: ls -1 install/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P20 sh -c &#39;$0 -v &gt;/dev/null&#39; Time (mean ± σ): 567.0 ms ± 3.2 ms [User: 1.684 s, System: 2.719 s] Range (min … max): 561.5 ms … 570.5 ms 10 runs</p><p> $ hyperfine -P procs 10 20 -D 10 -w1“ ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P {procs} sh -c'\ $ 0 -v > / dev / null'“” ls -1 install / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P {procs} sh -c'\ $ 0 -v> / dev / null '“基准测试1：ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P10 sh -c'$ 0 -v> / dev / null'时间（平均值±σ）：655.8 ms±5.5 ms [用户：1.716 s，系统：2.784 s]范围（最小值…最大值）：647.6毫秒…664.3毫秒10次运行基准测试2：ls -1 install / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P10 sh -c'$ 0 -v> / dev / null'时间（平均值±σ）：583.9 ms±5.0 ms [用户：1.715 s，系统：2.773 s]范围（ min…max）：577.0 ms…592.0 ms 10次运行基准测试3：ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P20 sh -c'$ 0 -v> / dev / null'时间（平均值±σ）：638.2 ms±10.7 ms [用户：1.667 s，系统：2.736 s]范围（最小值…最大值）：629.1毫秒…658.4毫秒10次运行基准4：ls -1 install / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P20 sh -c'$ 0 -v> / dev / null'时间（平均值±σ）：567.0 ms±3.2 ms [用户：1.684 s，系统：2.719 s]范围（最小…最大）：561.5毫秒…570.5毫秒10次运行</p><p>  $ hyperfine -c &#34;umount mnt&#34; -p &#34;umount mnt; ./dwarfs perl-lzma.dwarfs mnt -o cachesize=1g -o workers=4; sleep 1&#34; -P procs 5 20 -D 5 &#34;ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P{procs} sh -c &#39;\$0 -v &gt;/dev/null&#39;&#34;Benchmark #1: ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P5 sh -c &#39;$0 -v &gt;/dev/null&#39; Time (mean ± σ): 20.372 s ± 0.135 s [User: 2.338 s, System: 4.511 s] Range (min … max): 20.208 s … 20.601 s 10 runs Benchmark #2: ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P10 sh -c &#39;$0 -v &gt;/dev/null&#39; Time (mean ± σ): 13.015 s ± 0.094 s [User: 2.148 s, System: 4.120 s] Range (min … max): 12.863 s … 13.144 s 10 runs Benchmark #3: ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P15 sh -c &#39;$0 -v &gt;/dev/null&#39; Time (mean ± σ): 11.533 s ± 0.058 s [User: 2.013 s, System: 3.970 s] Range (min … max): 11.469 s … 11.649 s 10 runs Benchmark #4: ls -1 mnt/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P20 sh -c &#39;$0 -v &gt;/dev/null&#39; Time (mean ± σ): 11.402 s ± 0.095 s [User: 1.906 s, System: 3.787 s] Range (min … max): 11.297 s … 11.568 s 10 runs</p><p>  $ hyperfine -c“ umount mnt” -p“ umount mnt; ./dwarfs perl-lzma.dwarfs mnt -o cachesize = 1g -o worker = 4; sleep 1” -P procs 5 20 -D 5“ ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P {procs} sh -c'\ $ 0 -v> / dev / null'“基准＃1：ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P5 sh -c'$ 0 -v> / dev / null'时间（平均值±σ）：20.372 s±0.135 s [用户：2.338 s，系统：4.511 s]范围（ min…max）：20.208 s…20.601 s 10次运行基准测试2：ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P10 sh -c'$ 0 -v> / dev / null'时间（平均值±σ）：13.015 s±0.094 s [用户：2.148 s，系统：4.120 s]范围（ min…max）：12.863 s…13.144 s 10次运行基准测试3：ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P15 sh -c'$ 0 -v> / dev / null'时间（平均值±σ）：11.533 s±0.058 s [用户：2.013 s，系统：3.970 s]范围（ min…max）：11.469 s…11.649 s 10次运行基准4：ls -1 mnt / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P20 sh -c'$ 0 -v> / dev / null'时间（平均值±σ）：11.402 s±0.095 s [用户：1.906 s，系统：3.787 s]范围（ min…max）：11.297 s…11.568 s 10次运行</p><p> So you might want to consider using zstd instead of lzma if you&#39;dlike to optimize for file system performance. It&#39;s also the defaultcompression used by  mkdwarfs.</p><p> 因此，如果您想针对文件系统性能进行优化，则可能要考虑使用zstd而不是lzma。这也是mkdwarfs使用的默认压缩。</p><p> On a different system, Intel(R) Core(TM) i7-8550U CPU @ 1.80GHz,with 4 cores, I did more tests with both SquashFS and DwarFS(just because on the 6 core box my kernel didn&#39;t have supportfor zstd in SquashFS):</p><p> 在不同的系统上，英特尔®酷睿TM i7-8550U CPU @ 1.80GHz，具有4个内核，我对SquashFS和DwarFS进行了更多测试（仅因为在6核盒子上我的内核不支持zstd在SquashFS中）：</p><p> hyperfine -c &#39;sudo umount /tmp/perl/install&#39; -p &#39;umount /tmp/perl/install; ./dwarfs perl-install.dwarfs /tmp/perl/install -o cachesize=1g -o workers=4; sleep 1&#39; -n dwarfs-zstd &#34;ls -1 /tmp/perl/install/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P20 sh -c &#39;\$0 -v &gt;/dev/null&#39;&#34; -p &#39;sudo umount /tmp/perl/install; sudo mount -t squashfs perl-install.squashfs /tmp/perl/install; sleep 1&#39; -n squashfs-zstd &#34;ls -1 /tmp/perl/install/*/*/bin/perl5* | xargs -d $&#39;\n&#39; -n1 -P20 sh -c &#39;\$0 -v &gt;/dev/null&#39;&#34;Benchmark #1: dwarfs-zstd Time (mean ± σ): 2.071 s ± 0.372 s [User: 1.727 s, System: 2.866 s] Range (min … max): 1.711 s … 2.532 s 10 runs Benchmark #2: squashfs-zstd Time (mean ± σ): 3.668 s ± 0.070 s [User: 2.173 s, System: 21.287 s] Range (min … max): 3.616 s … 3.846 s 10 runs Summary &#39;dwarfs-zstd&#39; ran 1.77 ± 0.32 times faster than &#39;squashfs-zstd&#39;</p><p> hyperfine -c'sudo umount / tmp / perl / install'-p'umount / tmp / perl / install; ./dwarfs perl-install.dwarfs / tmp / perl / install -o cachesize = 1g -o worker = 4;睡眠1'-n dwarfs-zstd“ ls -1 / tmp / perl / install / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P20 sh -c'\ $ 0 -v> / dev / null'“ -p'sudo umount / tmp / perl / install; sudo mount -t squashfs perl-install.squashfs / tmp / perl / install;睡眠1'-n squashfs-zstd“ ls -1 / tmp / perl / install / * / * / bin / perl5 * | xargs -d $'\ n'-n1 -P20 sh -c'\ $ 0 -v> / dev / null'“ Benchmark＃1：dwarfs-zstd时间（平均值±σ）：2.071 s±0.372 s [用户：1.727 s，系统：2.866 s]范围（最小…最大）：1.711 s…2.532 s 10次运行基准＃2：squashfs-zstd时间（平均值±σ）：3.668 s±0.070 s [用户：2.173 s，系统：21.287 s]范围（最小值…最大值）：3.616 s…3.846 s 10次运行摘要“ dwarfs-zstd”运行比'squashfs-zstd'快1.77±0.32倍</p><p> So DwarFS is almost twice as fast as SquashFS. But what&#39;s more,SquashFS also uses significantly more CPU power. However, the numbersshown above for DwarFS obviously don&#39;t include the time spent in the dwarfs process, so I repeated the test outside of hyperfine:</p><p> 因此，DwarFS的速度几乎是SquashFS的两倍。但更重要的是，SquashFS还使用了更多的CPU能力。但是，上面显示的DwarFS数字显然不包括在侏儒过程中花费的时间，因此我在超精细之外重复了测试：</p><p>  So in total, DwarFS was using 10.5 seconds of CPU time, whereasSquashFS was using 23.5 seconds, more than twice as much. Ignorethe &#39;real&#39; time, this is only how long it took me to unmount thefile system again after mounting it.</p><p>因此，总共DwarFS使用10.5秒的CPU时间，而SquashFS使用23.5秒，是两倍多。忽略“实时”时间，这仅是我在挂载文件系统之后再次卸载文件系统所花费的时间。</p><p> Another real-life test was to build and test a Perl module with 624different Perl versions in the compressed file system. The module I&#39;veused,  Tie::Hash::Indexed,has an XS component that requires a C compiler to build. So this reallyaccesses a lot of different stuff in the file system:</p><p> 另一个实际测试是在压缩文件系统中构建和测试具有624个不同Perl版本的Perl模块。我使用的模块Tie :: Hash :: Indexed具有一个XS组件，该组件需要C编译器来构建。因此，这确实访问了文件系统中的许多不同内容：</p><p>   #!/bin/bash set -euperl= $1dir=  $(echo   &#34; $perl &#34;  | cut -d/ --output-delimiter=- -f5,6 )rsync -a Tie-Hash-Indexed-0.08/  $dir/ cd  $dir $1 Makefile.PL  &gt;/dev/null  2&gt;&amp;1make  test  &gt;/dev/null  2&gt;&amp;1 cd ..rm -rf  $dir echo  $perl</p><p>   ＃！/ bin / bash set -euperl = $ 1dir = $（echo“ $ perl” | cut -d / --output-delimiter =--f5,6）rsync -a Tie-Hash-Indexed-0.08 / $ dir / cd $ dir $ 1 Makefile.PL> / dev / null 2>＆1make测试> / dev / null 2>＆1 cd ..rm -rf $ dir echo $ perl</p><p> The following command will run up to 8 builds in parallel on the 4 corei7 CPU, including debug, optimized and threaded versions of all Perlreleases between 5.10.0 and 5.33.3, a total of 624  perl installations:</p><p> 以下命令将在4个corei7 CPU上并行运行多达8个构建，包括5.10.0和5.33.3之间的所有Perlreleases的调试，优化和线程版本，总共624个perl安装：</p><p> $ time ls -1 /tmp/perl/install/*/perl-5.??.?/bin/perl5* | sort -t / -k 8 | xargs -d $&#39;\n&#39; -P 8 -n 1 ./build.sh</p><p> $ time ls -1 /tmp/perl/install/*/perl-5.??.?/bin/perl5* |排序-t / -k 8 | xargs -d $'\ n'-P 8 -n 1 ./build.sh</p><p> Tests were done with a cleanly mounted file system to make sure the cacheswere empty.  ccache was primed to make sure all compiler runs could besatisfied from the cache. With SquashFS, the timing was:</p><p> 使用干净安装的文件系统进行了测试，以确保高速缓存为空。 ccache已准备好以确保可以从缓存中满足所有编译器的运行要求。使用SquashFS的时间是：</p><p>      So again, DwarFS used less raw CPU power, but in terms of wallclock time,the difference is really marginal.</p><p>      同样，DwarFS使用的原始CPU功耗更少，但就挂钟时间而言，两者之间的差异确实很小。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/压缩率/">#压缩率</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/fast/">#fast</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/dev/">#dev</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>