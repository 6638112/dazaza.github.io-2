<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>SSL客户为什么报告谷歌的证书“自签名”？ Why does SSL client report Google’s certificate “self-signed”?</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Why does SSL client report Google’s certificate “self-signed”?<br/>SSL客户为什么报告谷歌的证书“自签名”？ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-12 23:37:26</div><div class="page_narrow text-break page_content"><p>In previous post, I implemented a simple HTTPS client, but the program has a small flaw, i.e., when connecting to "www.google.com:443", it will report following error in verifying certificate: error code is 18:self signed certificate error code is from SSL_get_verify_result: long SSL_get_verify_result(const SSL *ssl) { return ssl->verify_result; } and 18 is mapping to X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT, which means "self-signed certificate". But for other websites, e.g., facebook.com, no error is outputted. Use OpenSSL's client-arg program to test: # LD_LIBRARY_PATH=/root/openssl/build gdb --args ./client-arg -connect "www.google.com:443" ...... Thread 2 hit Breakpoint 1, main (argc=3, argv=0xfffffc7fffdf4c38) at client-arg.c:99 99 BIO_puts(sbio, "GET / HTTP/1.0\n\n"); (gdb) p ssl->verify_result $1 = 18 (gdb) The same error code: 18. But openssl-s_client can guarantee the certificate is not "self-signed": # LD_LIBRARY_PATH=/root/openssl/build openssl s_client -connect google.com:443 CONNECTED(00000004) depth=2 OU = GlobalSign Root CA - R2, O = GlobalSign, CN = GlobalSign verify return:1 depth=1 C = US, O = Google Trust Services, CN = GTS CA 1O1 verify return:1 depth=0 C = US, ST = California, L = Mountain View, O = Google LLC, CN = *.google.com verify return:1 --- Certificate chain 0 s:C = US, ST = California, L = Mountain View, O = Google LLC, CN = *.google.com i:C = US, O = Google Trust Services, CN = GTS CA 1O1 1 s:C = US, O = Google Trust Services, CN = GTS CA 1O1 i:OU = GlobalSign Root CA - R2, O = GlobalSign, CN = GlobalSign --- ...... Hmm, I need to find the root cause. First of all, I searched the code to see when X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT is set, and found only one spot: if (self_signed) return verify_cb_cert(ctx, NULL, num - 1, sk_X509_num(ctx->chain) == 1 ? X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT : X509_V_ERR_SELF_SIGNED_CERT_IN_CHAIN); The interesting thing is the amount of certificates in the chain is only 1, but from above openssl-s_client's output, there are 2 certificates in the chain. OK, let's see the content of this "self-signed" certificate. After some debugging, I finally found tls_process_server_certificate, which is used to process the server's certificate. With the help of gdb, I can dump the content of certificate: # gdb --args ./client www.google.com:443 ....... (gdb) b tls_process_server_certificate ...... Thread 2 hit Breakpoint 1, tls_process_server_certificate (s=0xf09e90, pkt=0xfffffc7fffdefe30) at ../ssl/statem/statem_clnt.c:1768 1768 X509 *x = NULL; ...... 1806 if (certbytes != (certstart + cert_len)) { (gdb) 1811 if (SSL_IS_TLS13(s)) { (gdb) dump binary memory cert certstart certstart + cert_len ...... Try to check the cert file: # cat cert ...... �0� *�H�� (No SNI provided; please fix your client.10Uinvalid2.invalid0�"0 ��bO���� ..... The reason is obvious: "No SNI provided; please fix your client.". Ah, I need to set SNI explicitly. After invoking SSL_set_tlsext_host_name, the certificate chain becomes correct (The new code can be downloaded here). Summary: I am not an SSL/TLS expert, and OpenSSL project is complex and daunting. But with some basic SSL/TLS knowledge and the help of debugger, I can find the root cause of issues independently. Don't give up, digest code bit by bit, finally you will win!</p><p>在以前的帖子中，我实现了一个简单的HTTPS客户端，但程序有一个小缺陷，即连接到“www.google.com:443”时，它将在验证证书中报告以下错误：错误代码是18：自签名证书错误代码来自ssl_get_verify_result：long ssl_get_verify_result（const ssl * ssl）{return ssl-> verify_result; 18映射到x509_v_err_depth_zero_self_signed_cert，这意味着“自签名证书”。但对于其他网站，例如，Facebook.com，没有输出错误。使用openssl的client-arg程序测试：#ld_library_path = / root / openssl / build gdb --args ./client-arg -connect“www.google.com:443”......线程2命中断点1， main（argc = 3，argv = 0xfffffcfc7fffdf4c38）在client-arg.c：99 99 Bio_puts（SBIO，“get / http / 1.0 \ n \ n”）; （gdb）p ssl-> verical_result $ 1 = 18（gdb）相同的错误代码：18。但openssl-s_client可以保证证书不是“自签名”：#ld_library_path = / root / openssl / build openssl s_client -connect Google.com:443已连接（00000004）深度= 2 OU = Globalsign Root Ca  -  R2，O = GlobalSign，CN = GlobalSign验证返回：1深度= 1 C = US，O = Google Trust Services，CN = GTS CA 1O1验证返回：1深度= 0 C = US，ST =加利福尼亚州，L =山景，o = Google LLC，CN = * .Google.com验证返回：1 ---证书链0 S：C = US，ST =加利福尼亚州，L =山景，o = Google LLC，CN = * .Google.com I：C = US，O = Google Trust服务，CN = GTS CA 1O1 1 S：C = US，O = Google Trust Services，CN = GTS CA 1O1 I：OU = Globalsign Root Ca  -  R2，O = Globalsign，CN = Globalsign  -  ...... HMM，我需要找到根本原因。首先，我搜索了代码，看看x509_v_err_depth_zero_self_signed_cert and any spect：if（self_signed）respender verify_cb_cert（ctx，null，num  -  1，sk_x509_num（ctx->链）== 1？x509_v_err_depth_zero_self_signed_cert：x509_v_err_self_signed_cert_in_chain ）;有趣的是链中的证书量只有1，但从openssl-s_client的输出中，链中有2个证书。好的，让我们看看这个“自签名”证书的内容。在一些调试之后，我终于找到了tls_process_server_certificate，它用于处理服务器的证书。在GDB的帮助下，我可以转储证书的内容：＃gdb --args ./client www.google.com:443 .......（gdb）b tls_process_server_certificate ......线程2命中断点1，tls_process_server_certificate（s = 0xf09e90，pkt = 0xfffffc7fffdefe30）at ../ssl/statem/statem_clnt.c:1768 1768 x 509 * x = null; ...... 1806如果（certbytes！=（certstart + cert_len））{（gdb）1811 if（ssl_is_tls13）{（gdb）转储二进制内存certstreart certstart + cert_len ......尝试检查证书文件：＃cat cert ......�0�*�h��（没有提供SNI;请修复您的客户端.10uinvalid2.invalid0�“0��bo����.....原因是显而易见的：“没有提供SNI;请修复您的客户。”。啊，我需要明确设置SNI。调用SSL_SET_TLSEXT_HOST_NAME后，证书链可以在此处下载）。摘要：我不是SSL / TLS专家和OpenSSL项目很复杂，令人生畏。但是，对于一些基本的SSL / TLS知识和调试器的帮助，我可以独立找到问题的根本原因。不要放弃，摘要，逐个摘要代码最后你会赢！ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://nanxiao.me/en/why-does-ssl-client-report-googles-certificate-self-signed/">https://nanxiao.me/en/why-does-ssl-client-report-googles-certificate-self-signed/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/客户/">#客户</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/client/">#client</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ssl/">#ssl</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1057801.html"><img src="http://img2.diglog.com/img/2021/4/thumb_2e47567dc848a682bce56927532e1e82.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1057801.html">谷歌正在推出“抬头”，这是一个数字良好的功能，告诉用户在像素设备上行走时抬起头部 </a></div><span class="my_story_list_date">2021-4-12 19:47</span></div><div class="col-sm"><div><a target="_blank" href="/story/1057791.html"><img src="http://img2.diglog.com/img/2021/4/thumb_3cac146e90cd760e86f8d278c2bcd6cd.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1057791.html">NHS Covid-19应用更新被阻止破坏苹果和谷歌的规则 </a></div><span class="my_story_list_date">2021-4-12 18:20</span></div><div class="col-sm"><div><a target="_blank" href="/story/1057790.html"><img src="http://img2.diglog.com/img/2021/4/thumb_21ca4b7d9411614014ef2dd47eec6b54.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1057790.html">谷歌SRE和开发商如何共同努力 </a></div><span class="my_story_list_date">2021-4-12 18:20</span></div><div class="col-sm"><div><a target="_blank" href="/story/1057773.html"><img src="http://img2.diglog.com/img/2021/4/thumb_0074b0fe4e23783563f7c8f272bed7fa.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1057773.html">据报道，谷歌统一“项目伯南克”促进其广告购买系统 </a></div><span class="my_story_list_date">2021-4-12 16:52</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>