<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我们如何更快地制作10倍 How We Made Our Maps 10x Faster</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">How We Made Our Maps 10x Faster<br/>我们如何更快地制作10倍 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-06-29 22:27:47</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/6/55691a6c9190fabafac0c2d219395f3f.png"><img src="http://img2.diglog.com/img/2021/6/55691a6c9190fabafac0c2d219395f3f.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>In 2006, Redfin was the first company to put homes on a map⁰. This was even before Google Maps was a performant platform. They launched with Microsoft Virtual Earth before migrating to Google Maps in 2008¹. This was a legendary achievement in proptech, massively empowering homebuyers to shop on their own. Ever since, high quality map browsing has been table stakes for any real estate shopping tool.</p><p>2006年，Redfin是第一家在地图上放置房屋的公司。这是甚至在谷歌地图是一个表演平台之前。他们在2008年迁移到谷歌地图之前，他们使用了Microsoft虚拟地球。这是普罗特施机的传奇成就，大量赋予购房者自己购物。从那以后，高质量的地图浏览一直是任何房地产购物工具的表格赌注。</p><p> Going into Q2, the maps on Opendoor were having performance issues. When a user viewed  homes in Phoenix, it could take 15+ seconds before they see anything on the map.</p><p> 进入Q2，Opendoor的地图正在具有性能问题。当用户在Phoenix中查看家园时，在地图上看到任何内容之前，它可能需要15秒。</p><p>  Before we could start optimizing map speed, we needed to figure out why it felt slow. After some profiling with Chrome dev tools, it became apparent that there was a slow call to our REST API to fetch the property listing data to display on the map. Looking further, Datadog showed us that the bulk of this time was spent in ActiveModelSerializers and fetching from the DB. We then constructed a metric that captured the user pain we wanted to address: p90 time to fetch property data for the map. We use a 90th percentile to capture the predominant user experience while excluding outliers.</p><p>  在我们开始优化地图速度之前，我们需要弄清楚为什么它感到慢。经过一些与Chrome Dev Tools的分析，显而易见的是，对我们REST API进行了缓慢的调用来获取房产列表数据以在地图上显示。正在寻找DataDog向我们展示了这次大部分时间在ActiveModelserializers中花费并从DB获取。然后，我们构建了一个捕获用户疼痛的度量标准，我们想要解决：P90时间来获取地图的属性数据。我们使用第90个百分位数来捕获主要用户体验，同时排除异常值。</p><p>   The 10.54s p90 to &lt;1s p90 optimization happened in 5 parts over about 1 month:</p><p>   10.54s p90至＆lt; 1s p90优化发生在5份大约1个份：</p><p>   We use Rails  active_model_serializers to describe the fields that the REST API will return. A common problem in Rails apps is the same serializer being used for multiple endpoints and bloating to contain fields needed for multiple use-cases. This causes over-fetching of data both from our APIs and from the backing DB (we store listings in MongoDB). We also updated our  Mongoid queries to use  projections to return only the data necessary to fulfill the request from MongoDB. Creating specialized serializers just for the map component and reducing data fetches solved these issues and got us nearly a 2x speedup.</p><p>   我们使用Rails Active_Model_Serializers描述REST API将返回的字段。 Rails应用程序中的常见问题是用于多个端点的串行器，并且嵌入到包含多个使用情况所需的字段。这导致从我们的API和备用数据库中的数据过度取出（我们在MongoDB中存储列表）。我们还更新了我们的Mongoid查询以使用预测仅返回完成MongoDB的请求所需的数据。仅为地图组件创建专用序列化器并减少数据提取解决了这些问题，并让我们几乎是2倍的加速。</p><p> A common problem in Rails apps is the same serializer being used for multiple endpoints and bloating to contain fields needed for multiple use-cases.</p><p> Rails应用程序中的常见问题是用于多个端点的串行器，并且嵌入到包含多个使用情况所需的字段。</p><p>   While fixing the DB problem, we noticed that we had smart logic in place to cache the serialized list of properties when the front-end requested an unfiltered list of properties for a region. This is the most common type of query because it’s the default state when a user lands on a map. Unfortunately a bug had been introduced that turned off this caching behavior in all cases. We corrected this behavior and added integration tests around the endpoint to ensure the cache is populated, then hit on subsequent requests. Alerts on latency spikes and cache hit rate will catch and flag us to investigate caching system failures in prod (more on that below).</p><p>   在修复DB问题时，我们注意到，当前端请求未过滤的区域的属性列表时，我们注意到我们具有智能逻辑以缓存序列化属性列表。这是最常见的查询类型，因为它是用户在地图上登陆时的默认状态。不幸的是，在所有情况下，都会引入错误的错误。我们纠正了此行为，并在端点周围添加了集成测试，以确保填充缓存，然后按后的请求。延迟尖峰和缓存命中率的警报将捕获并标记我们以调查产品中的缓存系统故障（更详细信息）。 </p><p>  Datadog showed a lot of bouncing around between our serializers and mongo. It turned out that one of the fields had added an n+1 query by doing a fetch in one of the serializer fields as it was serializing a list of properties. We did this by using  Mongoid’s includes() when querying for properties from the database. Optimizing queries so that all data was fetched in bulk before anything was serialized won us a few more seconds.</p><p>DataDog在我们的Serializers和Mongo之间表现出很多回圈。事实证明，通过在其中一个序列化程序字段中进行序列化属性列表，其中一个字段中的一个字段通过在其中一个序列化程序字段中添加了n + 1查询。在查询数据库的属性时，我们通过使用mongoid的包含（）来完成此操作。优化查询，以便在序列化之前批量获取所有数据，以越来越几秒钟。</p><p>  Both the properties on the map and the properties in the list were fetched by the same query. This was a design decision made to keep the logic simple and minimize the payload size if a property appears in both the list and the map. Profiling revealed that payload size wasn’t really an issue, but each list required its own CloudSearch and database query. Splitting these into two separate API calls done in parallel from the front-end was an easy win and didn’t require any encounters with multi-threading in Rails.</p><p>  地图上的属性和列表中的属性都由相同的查询获取。如果属性出现在列表和地图中，则这是一个设计决策，使逻辑简单，并最小化有效载荷大小。分析显示有效载荷大小并不是一个问题，但每个列表都需要自己的CloudSearch和数据库查询。将这些分为两个与前端并行完成的两个单独的API调用是一场轻松的胜利，并且不需要任何在轨道中具有多线程的遇到。</p><p>  Our final win came from avoiding the database entirely on some requests. Normally we fetch property listings from CloudSearch then hydrate them with a few extra fields from MongoDB. Instead, we switched the front-end to only expect latitude/longitude point locations and display clusters if there are more than 120 properties to show. This means that when point clusters are showing we don’t have to touch MongoDB, and in the cases we do, it’s a small number of properties and relatively quick.</p><p>  我们的最终胜利完全来自避免了数据库。通常，我们从CloudSearch获取房产列表，然后用MongoDB的一些额外的字段来水合物。相反，我们将前端切换到仅期望纬度/经度点位置，并且如果有超过120个属性来显示纬度/经度点位置并显示群集。这意味着当点集群显示我们不必触摸MongoDB时，在我们做的情况下，它是少数属性和相对较快的。</p><p>  The final step was ensuring we have a great way to catch regressions. While automated tests are useful to catch bugs at the code level, alerting is important because subtle config changes can break distributed systems (like the cache) in ways automated testing in a staging environment may not catch. We now get notified by Datadog when there’s an anomalous latency change and we have useful dashboards with associated metrics.</p><p>  最后一步是确保我们有一种捕获回归的好方法。虽然自动化测试对于在代码级别捕获错误时，警报很重要，因为微妙的配置更改可以在暂存环境中自动测试的方式打破分布式系统（如缓存）可能不会捕获。我们现在在有一个异常的延迟变化时由DataDog通知，并且我们有具有相关指标的有用仪表板。</p><p>    As a result, we’re seeing great performance from our home shopping tools and have seen even faster adoption of  Opendoor-Backed Offers, an offering that backs our buyers’ home offers with all cash to give them a competitive edge in today’s hot market. Performance work on web and mobile is a top priority for me and my team. We will continue investing resources into our home shopping tools with the goal of delivering the best experience possible to our customers.</p><p>    因此，我们从家庭购物工具中看到了卓越的表现，并且可以更快地采用Opendoor-Backed优惠，这是一款支持我们买家的家庭优惠的产品，并在今天的热门市场中给予他们竞争优势。 Web和Mobile的性能工作是我和我的团队的首要任务。我们将继续将资源投入资源进入我们家庭购物工具，其目标是为客户提供最佳体验。</p><p> If this type of work sounds interesting, Opendoor is hiring! Head to our   careers page  to learn more.</p><p> 如果这种类型的作品听起来有趣，OpenDoor正在招聘！前往我们的职业生涯页面以了解更多信息。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://medium.com/opendoor-labs/how-we-made-our-maps-10x-faster-e2fa1eaebc65">https://medium.com/opendoor-labs/how-we-made-our-maps-10x-faster-e2fa1eaebc65</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/制作/">#制作</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/maps/">#maps</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/地图/">#地图</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>