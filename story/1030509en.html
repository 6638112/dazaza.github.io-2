<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>AWS NLB和混合TCP连接</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">AWS NLB和混合TCP连接</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-22 18:59:56</div><div class="page_narrow text-break page_content"><p>One of my services was running into timeouts, because connections were being reset by clients. I had assumed that it couldn’t be the  Network Load Balancers (NLBs) fault, a battle-tested piece in the cloud stack.The following is about NLBs, cross-zone-loadbalancing and multiple NLBs pointing to the same set of EC2 instances and how that revealed unexpected behaviour in the NLB.</p><p>我的一个服务遇到了超时，因为客户端正在重置连接。我曾假设这不可能是网络负载平衡器(NLB)故障，这是云堆栈中经受过战斗考验的部分。下面是关于NLB、跨区域负载平衡和指向同一组EC2实例的多个NLB，以及这如何揭示NLB中的意外行为。</p><p>  don’t use a public IPv4 address and an NLB for the same target</p><p>不要将公共IPv4地址和NLB用于同一目标。</p><p>  My system was doing lots of requests to two NLBs over the internet.Unfortunately in quite some cases there were timeouts in the application code.The timeouts were quite aggressive at 1 second. Since a normal package loss during connecting usually takes 3 seconds before a retry on linux, I initially explained it away as naturally occurring packet loss. But the number of failures grew ever higher with the link not even close to being saturated and other calls to external targets being fine.</p><p>我的系统通过互联网向两个NLB发出了大量请求。不幸的是，在相当多的情况下，应用程序代码中存在超时，超时时间为1秒。由于连接过程中正常的包丢失通常需要3秒才能在Linux上重试，所以我最初将其解释为自然发生的包丢失。但失败的数量越来越多，链路甚至还没有接近饱和，其他对外部目标的调用也没有问题。</p><p> When I finally got myself to take tcpdumps of the traffic, something strange emerged: TCP RST packages.</p><p>当我最终让自己接受流量的tcpdump时，出现了一些奇怪的东西：TCP RST包。</p><p>  The configuration in which these issues actually surfaced had multiple machines behind a NAT, talking to multiple EC2 instances behind two NLBs with cross-zone-loadbalancing enabled.</p><p>这些问题实际出现的配置在NAT后面有多台机器，在启用了跨区域负载平衡的两个NLB后面与多个EC2实例对话。</p><p> But that’s the messy reality, let’s keep it simple for this article. In the following let’s have 1 client, 1 NLB and 1 EC2 instance, because the issue would still be the same.The NLB has cross-zone loadbalancing enabled.</p><p>但这就是混乱的现实，让我们在本文中保持简单。在下面的示例中，我们假设有1个客户端、1个NLB和1个EC2实例，因为问题仍然是一样的。NLB启用了跨区域负载平衡。</p><p>  In TCP, connections are identified by the quadruple of source ip, source port, target ip and target port.When you create a new TCP connection, it is made sure that no other connection with the same quadruple is in use.</p><p>在TCP中，通过源IP、源端口、目标IP和目标端口的四元组来标识连接。当您创建新的TCP连接时，请确保没有其他具有相同四元组的连接在使用中。</p><p>  (Fast forward a couple of days of staring at tcpdump and head-scratching) Here is an excerpt of tcpdump as the client sees it, with all the noise removed:</p><p>(快进几天，盯着tcpdump看，摸不着头脑)以下是客户看到的tcpdump的摘录，去掉了所有噪音：</p><p> Format clientip:clientport &lt;-&gt; targetip:targetport (so a bit different than it looks in wireshark) ... This connection has been established for some time90.63.58.20:36230 &lt;- 34.242.162.234:443 Seq=1234 Ack=5432 [ACK]</p><p>格式clientip：clientport&lt；-&gt；targeTip：targetport(因此与Wireshark中的外观略有不同)...。此连接已建立一段时间90.63.58.20：36230&lt；-34.242.162.234：443Seq=1234Ack=5432[ACK]。</p><p> EC2 instance (private IP) says through the NLB (34.242.162.234) to the client (90.63.58.20):  Hey, I just received your data, all is good.This connection is healthy and sending data. Everything as expected. Now our client wants to make a new connection and sends a SYN package.</p><p>EC2实例(内网IP)通过NLB(34.242.162.234)向客户端(90.63.58.20)表示：嘿，我刚收到您的数据，一切正常，这个连接是健康的，正在发送数据。一切都和预期的一样。现在，我们的客户端想要建立一个新连接并发送一个SYN包。</p><p>  As you notice, the source ports are identical, but this is fine, as the target IPs are different.Next in the 3-way handshake of TCP we would expect a  [SYN,ACK] with  Ack=6952</p><p>正如您注意到的，源端口是相同的，但这很好，因为目标IP不同。接下来，在TCP的3次握手中，我们预计会出现[SYN，ACK]，Ack=6952。</p><p>  This packet has the same quadruple, but it isn’t our  [SYN,ACK]… wait a sec. Where is this coming from? Does this ack belong on the other connection that the client had with  34.242.162.234!?The Ack numbers match, but that can’t be, can it?</p><p>此数据包具有相同的四元组，但它不是我们的[SYN，ACK]…。等一下。这是从哪里来的？此Ack是否属于客户端与34.242.162.234！的另一个连接？Ack编号匹配，但不可能是这样，对吗？</p><p>   Well, at least the client is as confused as I am and sends an RST. It just sucks that this means our SYN will never be properly answered.</p><p>嗯，至少客户和我一样困惑，还发了一封RST。这意味着我们的SYN永远不会得到正确的回答，这真是太糟糕了。</p><p> Is the SYN of the new connection overwriting an existing connection in the NLB’s connection table?</p><p>新连接的SYN是否覆盖NLB连接表中的现有连接？</p><p>  Since I had so much trust in AWS NLBs I first assumed the issue to lie somewhere (anywhere) else. I imagined it could theoretically be a faulty switch or a misconfigured NAT gateway on the client side.But it turned out to be neither of them. It was actually the AWS NLB mixing up the connections.How can this happen?</p><p>由于我如此信任AWS NLB，我首先认为问题出在其他地方(任何地方)。我以为理论上可能是客户端的交换机故障或NAT网关配置错误，但结果两者都不是。实际上是AWS NLB混淆了连接。怎么会这样呢？</p><p>  When the traffic goes through the NLBs the target IP address get rewritten to the internal IP address of the EC2 instanc.</p><p>当流量通过NLB时，目标IP地址被重写为EC2实例的内部IP地址。</p><p>  Now how would it look from the client if three connections are created in a round-robin fashion?</p><p>现在，如果以循环方式创建三个连接，从客户端看会是什么样子？</p><p>  Now this looks unproblematic, nice quadruples - no RST packages.But what happens if we have more and longer-lived connections? Could collisions happen?</p><p>现在，这看起来没有问题，不错的四倍-没有RST包。但是，如果我们有更多更持久的连接，会发生什么呢？会发生碰撞吗？</p><p>  As I said in the background, the kernel ensures that there are no quadruple collisions.And this is still the case in this case. The same source port can be reused, as long as the target ip or port are different. As the connections go to different IPs of the NLB, this is the case… but only from the view of the client.In the NLB the addresses are translated to an internal IP.So on the EC2 instance the quadruples look like this:</p><p>正如我在后台所说的，内核确保不会发生四重冲突，在这种情况下仍然是这样。只要目标IP或端口不同，就可以重复使用相同的源端口。当连接到达NLB的不同IP时，情况就是…。但仅从客户端的角度来看。在NLB中，地址被转换为内部IP。因此，在EC2实例上，四元组如下所示：</p><p>  Now this looks problematic. Two TCP connections share the same quadruple.Thus the NLB cannot distinguish between them and sends the packets on either of them.</p><p>现在这看起来有问题了。两个TCP连接共享相同的四元组，因此NLB无法区分它们，并在其中任何一个上发送数据包。</p><p>  An ordinary NAT would handle such collisions just fine. When a collision is detected, not only the address is translated but also the port.This makes it possible to handle the complete port range before collisions occur.NLBs apparently don’t act like NATs. I couldn’t find this spelled out anywhere, but apparently they always preserve the source port. This basically means that whenever a client makes more than  one connection to the NLB, collisions may occur.During my research I found out I am  not the only one irritated by that and that they opened a support ticket and got the confirmation that this is indeed intended behaviour.</p><p>普通的NAT可以很好地处理这种冲突。当检测到冲突时，不仅地址被转换，端口也被转换，这使得在冲突发生之前处理整个端口范围成为可能。NLB显然不像NAT那样工作。我在任何地方都找不到这一点，但显然他们总是保留源端口。这基本上意味着，当客户端与NLB建立多个连接时，可能会发生冲突。在我的研究过程中，我发现不是只有我对此感到恼火，他们打开了支持票证，并得到了确认这确实是有意为之的行为。</p><p> In any case I don’t think anyone would derive this from  just the docs and TCP knowledge.There should at least be a big warning sign in  the documentation.</p><p>在任何情况下，我认为任何人都不会仅仅从文档和TCP知识中得出这一点，文档中至少应该有一个很大的警告标志。</p><p>  This issue not only occurs with cross-zone-loadbalancing, but any time two external IPv4-addresses point to the same EC2 instance in AWS.This includes multiple NLBs pointing at the same target or an instance having both a public IPv4 address and being behind an NLB.</p><p>此问题不仅发生在跨区域负载平衡上，而且在AWS中，只要两个外部IPv4地址指向同一EC2实例，就会出现此问题。这包括指向同一目标的多个NLB，或者同时具有公共IPv4地址且位于NLB之后的实例。</p><p> What I take away from this is to never have two NLBs pointed at the same target groups as well as to turn cross-az loadbalancing off for most use-cases.And never assume that a part of your stack is infallible.</p><p>我从中学到的是永远不要让两个NLB指向相同的目标组，并且在大多数用例中关闭跨AZ负载平衡，并且永远不要假设堆栈的一部分是不会出错的。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.niels-ole.com/cloud/aws/linux/2020/10/18/nlb-resets.html">https://www.niels-ole.com/cloud/aws/linux/2020/10/18/nlb-resets.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/nlb/">#nlb</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/nlbs/">#nlbs</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>