<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Rust基准自动火焰记录仪 Automatic Flamegraphs for Benchmarks in Rust</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Automatic Flamegraphs for Benchmarks in Rust<br/>Rust基准自动火焰记录仪 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-29 05:56:14</div><div class="page_narrow text-break page_content"><p>This is just a short post about something I recently discovered in the Rust ecosystem:</p><p>这只是关于我最近在Rust生态系统中发现的东西的简短文章：</p><p>  If you have a Medium subscription and want to support me, you can  read this post on Medium.</p><p>  如果您订阅了Medium，并希望支持我，则可以阅读Medium上的这篇文章。</p><p>  Criterion is a well-known and often-used benchmarking framework in the Rust ecosystem.If you’ve not yet heard of it, definitely check it out!</p><p>  Criterion是Rust生态系统中一个众所周知且经常使用的基准测试框架。如果您还没有听说过，一定要查看一下！</p><p> Since  v0.3, Criterion supports  in-process profiling hooks.They allow us to use a custom profiler while running benchmarks.After registering a custom profiler, we can enable them by running the benchmark suite with the  --profile-time flag.</p><p> 从v0.3开始，Criterion支持进程内分析挂钩，它们允许我们在运行基准测试时使用自定义探查器。注册自定义探查器后，我们可以通过使用--profile-time标志运行基准测试套件来启用它们。</p><p> Having hooks for a custom profiler for your benchmarks allows you to do  awesome stuff, for example generating flamegraphs for every benchmark with   pprof.</p><p> 为基准测试有一个用于自定义探查器的钩子，您可以做一些很棒的事情，例如，使用pprof为每个基准测试生成火焰图。</p><p>   “These numbers are great. But how can we do this faster? Where do we spend the most time?”</p><p>   这些数字很棒。但是我们怎样才能更快地做到这一点呢？我们在哪里花费最多的时间？”</p><p>  Previously, I got my hands dirty using   cargo-flamegraph, which is a really good tool on its own.But the problem is that when using   cargo-flamegraph with benchmarks, you will usually get some unnecessary clutter, e.g. the setup routine for your benchmark and the enclosing framework code from Criterion.</p><p>  以前，我只靠使用可靠的实用工具-cargo-flamegraph弄脏了手，但是问题是，当使用带有基准的cargo-flamegraph时，通常会出现一些不必要的混乱情况，例如基准测试的设置例程以及Criterion附带的框架代码。 </p><p>  pprof is a CPU profiler that can be used to profile specific parts of your program on Linux.The best of all: It even supports generating flamegraphs with the feature flag  flamegraph.</p><p>pprof是一个CPU事件探查器，可用于在Linux上探查程序的特定部分。最重要的是：它甚至支持使用功能标志flamegraph生成探查图。</p><p>   We will now create a custom profiler for  criterion with  pprof that will print flamegraphs for each benchmark.</p><p>   现在，我们将使用pprof为标准创建自定义探查器，该探查器将为每个基准打印火焰图。</p><p>  [ dev - dependencies ] pprof  =  {  version  =  &#34;0.3&#34; ,  features  =  [ &#34;flamegraph&#34; ]  } criterion  =  &#34;0.3&#34; # criterion-macro = &#34;0.3&#34; # optional, if you use custom test frameworks</p><p>  [dev-依赖项] pprof = {版本=＆＃34; 0.3＆＃34; ，功能= [＆＃34; flamegraph＆＃34; ]}准则=＆＃34; 0.3＆＃34; ＃条件宏=＆＃34; 0.3＆＃34; ＃可选，如果您使用自定义测试框架</p><p> Now create a new file in your  benches/ folder. Let’s call it  perf.rs.Here we will implement our new  FlamegraphProfiler.</p><p> 现在在您的长椅/文件夹中创建一个新文件。我们称之为perf.rs。在这里，我们将实现新的FlamegraphProfiler。</p><p> The interface for implementing a custom profiler is actually quite straight-forward.We only need to implement the   criterion::profiler::Profiler trait from Criterion and we are good to go.</p><p> 实现自定义事件探查器的接口实际上很简单，我们只需要实现Criterion的Criteria :: profiler :: Profiler特质就可以了。</p><p> use   std:: { fs:: File ,   os:: raw:: c_int ,   path:: Path };    use   criterion:: profiler:: Profiler ;   use   pprof:: ProfilerGuard ;     /// Small custom profiler that can be used with Criterion to create a flamegraph for benchmarks. /// Also see [the Criterion documentation on this][custom-profiler]. /// /// ## Example on how to enable the custom profiler: /// /// ``` /// mod perf; /// use perf::FlamegraphProfiler; /// /// fn fibonacci_profiled(criterion: &amp;mut Criterion) { /// // Use the criterion struct as normal here. /// } /// /// fn custom() -&gt; Criterion { /// Criterion::default().with_profiler(FlamegraphProfiler::new()) /// } /// /// criterion_group! { /// name = benches; /// config = custom(); /// targets = fibonacci_profiled /// } /// ``` /// /// The neat thing about this is that it will sample _only_ the benchmark, and not other stuff like /// the setup process. /// /// Further, it will only kick in if `--profile-time &lt;time&gt;` is passed to the benchmark binary. /// A flamegraph will be created for each individual benchmark in its report directory under /// `profile/flamegraph.svg`. /// /// [custom-profiler]: https://bheisler.github.io/criterion.rs/book/user_guide/profiling.html#implementing-in-process-profiling-hooks  pub   struct  FlamegraphProfiler &lt; &#39;a &gt;   {    frequency:  c_int ,    active_profiler:  Option &lt; ProfilerGuard &lt; &#39;a &gt;&gt; ,   }    impl &lt; &#39;a &gt;   FlamegraphProfiler &lt; &#39;a &gt;   {    #[allow(dead_code)]    pub   fn  new ( frequency:  c_int )  -&gt;  Self   {    FlamegraphProfiler   {    frequency ,    active_profiler:  None ,    }    }   }    impl &lt; &#39;a &gt;   Profiler   for   FlamegraphProfiler &lt; &#39;a &gt;   {    fn  start_profiling ( &amp; mut   self ,   _benchmark_id:  &amp; str ,   _benchmark_dir:  &amp; Path )   {    self . active_profiler   =   Some ( ProfilerGuard:: new ( self . frequency ). unwrap ());    }     fn  stop_profiling ( &amp; mut   self ,   _benchmark_id:  &amp; str ,   benchmark_dir:  &amp; Path )   {    std:: fs:: create_dir_all ( benchmark_dir ). unwrap ();    let   flamegraph_path   =   benchmark_dir . join ( &#34;flamegraph.svg&#34; );    let   flamegraph_file   =   File:: create ( &amp; flamegraph_path )    . expect ( &#34;File system error while creating flamegraph.svg&#34; );    if   let   Some ( profiler )   =   self . active_profiler . take ()   {    profiler    . report ()    . build ()    . unwrap ()    . flamegraph ( flamegraph_file )    . expect ( &#34;Error writing flamegraph&#34; );    }    }   }</p><p> 使用std :: {fs :: File，os :: raw :: c_int，path :: Path};使用标准：：探查器：：探查器；使用pprof :: ProfilerGuard; ///可以与Criterion一起使用的小型自定义探查器，可以为基准创建火焰图。 ///另请参见[关于此的条件文档] [custom-profiler]。 /// /// ##有关如何启用定制分析器的示例：/// ///```/// mod perf; ///使用perf :: FlamegraphProfiler; /// /// fn fibonacci_profiled（criterion：＆amp; mut Criterion）{/// //在此处正常使用准则struct。 ///} /// /// fn custom（）-＆gt; Criterion {/// Criterion :: default（）。with_profiler（FlamegraphProfiler :: new（））///} /// /// criteria_group！ {///名称=长凳； /// config = custom（）; ///目标= fibonacci_profiled ///} ///```/// ///这样做的好处是它将仅对基准进行采样，而不对诸如///设置过程之类的东西进行采样。 /// ///此外，只有将`--profile-time＆lt; time＆gt;`传递给基准二进制文件时，它才会启动。 ///将在其报告目录中的每个单独基准中创建一个火焰图，///`profile / flamegraph.svg`下。 /// /// [custom-profiler]：https://bheisler.github.io/criterion.rs/book/user_guide/profiling.html#implementing-in-process-profiling-hooks发布结构FlamegraphProfiler＆lt; ＆＃39; a＆gt; {频率：c_int，active_profiler：选项＆lt; ProfilerGuard＆lt; ＆＃39; a＆gt; ，} impl＆lt; ＆＃39; a＆gt; FlamegraphProfiler＆lt; ＆＃39; a＆gt; {＃[allow（dead_code）] pub fn new（频率：c_int）-＆gt;自我{FlamegraphProfiler {频率，active_profiler：无，}}} impl＆lt; ＆＃39; a＆gt; FlamegraphProfiler＆lt; ＆＃39; a＆gt; {fn start_profiling（＆amp; mut self，_benchmark_id：＆amp; str，_benchmark_dir：＆amp; Path）{self。 active_profiler = Some（ProfilerGuard :: new（self。frequency）。unwrap（））; } fn stop_profiling（＆amp; mut self，_benchmark_id：＆amp; str，Benchmark_dir：＆amp; Path）{std :: fs :: create_dir_all（beta_dir）。解开（）;让flamegraph_path = Benchmark_dir。加入（＆＃34; flamegraph.svg＆＃34;）; let flamegraph_file = File :: create（＆amp; flamegraph_path）。期望（＆＃34;创建flamegraph.svg＆＃34;时发生文件系统错误）；如果让Some（分析者）=自我。 active_profiler。接受（）{分析器。报告（）。 build（）。展开（）。 Flamegraph（flamegraph_file）。期望（＆＃34;编写flamegraph错误＆＃34;）; }}}</p><p> To use the new profiler, we need to register it with Criterion.See also  Criterion’s advanced configuration.</p><p> 要使用新的探查器，我们需要在Criterion中注册它。另请参阅Criterion的高级配置。 </p><p> If you are using the  custom test framework feature with  criterion-macro, you can configure it with:</p><p>如果您将自定义测试框架功能与criteria-macro结合使用，则可以使用以下命令对其进行配置：</p><p> #![feature(custom_test_frameworks)]   #![test_runner(criterion::runner)]    use   criterion:: { Criterion ,   black_box };   use   criterion_macro:: criterion ;    mod  perf ;     fn  fibonacci ( n:  u64 )  -&gt;  u64  {    match   n   {    0   |   1   =&gt;   1 ,    n   =&gt;   fibonacci ( n   -   1 )   +   fibonacci ( n   -   2 ),    }   }     fn  custom_criterion ()  -&gt;  Criterion   {    Criterion:: default (). with_profiler ( perf:: FlamegraphProfiler:: new ( 100 ))   }    #[criterion(custom_criterion())]   fn  bench_custom ( c:  &amp; mut   Criterion )   {    c . bench_function ( &#34;Fibonacci-Custom&#34; ,   | b |   b . iter ( ||   fibonacci ( black_box ( 20 ))));   }</p><p> ＃！[feature（custom_test_frameworks）]＃！[test_runner（criterion :: runner）]使用准则：： {Criterion，black_box};使用standard_macro ::条件;国防部性能; fn斐波那契（n：u64）-> u64 {匹配n {0 | 1 => 1，n ＝＞ 1。斐波那契（n-1）+斐波那契（n-2），}} fn custom_criterion（）-＆gt;条件{Criterion :: default（）。 with_profiler（perf :: FlamegraphProfiler :: new（100））}＃[criterion（custom_criterion（））] fn bench_custom（c：＆amp; mut Criterion）{c。 bench_function（＆＃34; Fibonacci-Custom＆＃34;，| b | b。iter（|| fibonacci（black_box（20））））; }</p><p>  mod  perf ;    criterion_group ! {    name   =   benches ;    // This can be any expression that returns a `Criterion` object.    config   =   Criterion:: default (). with_profiler ( perf:: FlamegraphProfiler:: new ( 100 );    targets   =   bench   }</p><p>  国防部性能;条件组！ {名称=长凳; //这可以是任何返回`Criterion`对象的表达式。 config = Criterion :: default（）。 with_profiler（perf :: FlamegraphProfiler :: new（100）;目标=工作台}</p><p> Now that we have set up our custom profiler we can actually use it for our benchmarks as described in the next section.</p><p> 既然我们已经设置了自定义探查器，那么就可以将其实际用于基准测试，如下一节所述。</p><p>   To enable performance profiling without running the benchmarks as root, you may need to adjust the value of  perf_event_paranoid in the Linux kernel to an appropriate value for your environment. The most permissive value is  -1.</p><p>   要在不以root用户身份运行基准的情况下启用性能分析，您可能需要将Linux内核中的perf_event_paranoid的值调整为适合您的环境的值。最允许的值为-1。</p><p>     This command will run the benchmarks in  benches/my_bench.rs for 5 seconds with the use of our custom  FlamegraphProfiler.</p><p>     使用我们的自定义FlamegraphProfiler，此命令将在benchs / my_bench.rs中运行基准5秒钟。</p><p> Note: You need to specify the name of your benchmark because otherwise you might get the error  Unrecognized option: &#39;profile-time&#39;.See also   cargo bench gives “Unrecognized Option” errors for valid command-line options.</p><p> 注意：您需要指定基准的名称，否则可能会收到错误Unrecognized选项：＆＃39; profile-time＆＃39;。有关有效的命令行选项，另请参见长条凳给出“ Uncognized Option”的错误。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.jibbow.com/posts/criterion-flamegraphs/">https://www.jibbow.com/posts/criterion-flamegraphs/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/基准/">#基准</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/criterion/">#criterion</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>