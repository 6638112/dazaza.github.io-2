<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>FPGA PS2键盘打字机(硬件历险记，第8部分)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">FPGA PS2键盘打字机(硬件历险记，第8部分)</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-03 14:45:21</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/11/658894646018d3332aa745e8ce20f3d5.jpg"><img src="http://img2.diglog.com/img/2020/11/658894646018d3332aa745e8ce20f3d5.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Interfacing a PS2 keyboard with an FPGA What will we do with a drunken keyboard? What will we do with a drunken keyboard? What will we do with a drunken keyboard? Early in the morning! A sea shanty from early 19th century After I implemented a display of memory-mapped display in the Adventures in hardware, part 6 - Stopwatch memory mapped LCD controller I wanted to play with the LCD display a bit more. I also got a PS2 keyboard, and it felt that these two go together. So join me in attempting something that might be impractical in actual engineering scenarios: an electronic typewriter, where the words you type are shown on the screen. Preview of the final project Handling the PS2 protocol The transmitting device (keyboard or mouse) triggers the clock at range 10-16.7 kHz, then these bits come over the data pin, on the each falling edge of the PS2 clock: 1 start bit 8 data bits 1 parity bit 1 stop bit This assignment describes a simple approach to collecting the data, triggered by the @negedge clk and just collecting 8 data bits and ignoring others in an 11-state state machine. PS2 clock pin waveform captured on an oscilloscope It was a bit of a nuisance to try to capture the PS2 clock on oscilloscope. Again, reading the specs more correctly could have left me less surprised, as it explicitly states that the clock signal is generated only when there is some data coming down the wire. PS2 receiver If we want to play nice with the rest of the system, we should encapsulate the protocol into a PS2 receiver module with the following interface (as per this article): module ps2_rx ( input wire clk, reset, input wire ps2d, //PS2 data input wire ps2c, //PS2 clock input wire rx_en, //receiver enable output reg rx_done_tick, //signal that data is available output wire [7:0] dout //PS2 scancode ); Note that I didn’t come up with the PS2 receiver code on my own, but looking at various implementations online showed me different approaches to handling the input and the states. We can then connect this module to the rest of the system by using the rx_done_tick signal. In this case I directly move the received scancode through a converter into ASCII code (by the following Verilog module) into the display RAM, which is later shown on screen. This is what happened when I typed “hello” on the keyboard: The * symbol stands for unknown scancode PS2 Make and break codes Hm, not really what I expected. Looking at PS2 protocol again, it operates with a concept of make (press) and break (release) codes, so a scancode for H (0x48) is sent first when it’s pushed, then the “break code” 0xF0 is sent when it’s released, followed. by the scancode of H (0x48) again. This is a bit more complicated for special keys, such as alt, arrow keys, home, end, etc which have multi-word make codes. In case the H key is held, it generates code sequence 48 48 48 48 ... F0 48. Of course, when you hold A and press B, then release B and then release A, you’ll get a sequence of make codes for A, B, break code for B and break code for A. Key Make Break A 1C F0,1C B 32 F0,32 Backspace 66 F0,66 L Shift 12 F0,12 Enter 5A F0,5A Left ← E0,6B E0,F0,6B Numpad 4 6B F0,6B Home E0,6C E0,F0,6C Numpad 7 6C F0,6C Pause E1,1D,45,E1,9D,C5 -None - In this simple typewriter case, let’s pretend that we’re not interested in the keyboard key released event. It also so happens that the last word of multi-word make codes usually correspond to an alternate version of the key on the regular keyboard. So the left arrow ← has the same code 6B as Keypad 4 E0,6B, which on my keyboard has a left arrow pictured on it. It means that we probably can get away with interpreting just the last word of the make code and get the meaning of the most right, if we pretend the numeric part of the keyboard doesn’t exist. Improvements Handling only the key press, not release We should upgrade our keyboard driver by adding another module around it, that handles keypresses. It has a new output: makeBreak, which will output 1 for make and 0 for break code. Then in the top module we can handle these situation separately - by ignoring the scancode with the break code flag completely. E0 seems to be followed by a single scan code, E1 seems to be followed by two scan codes. There are some weird keys with long scancode sequence: Pause: E1 1D 45 E1 9D C5, Print screen: e0 2a e0 37. I’ll pretend these don’t exist. I named the new module ps2_keypress_driver, it actually ignores the events if they come in with the break codes. It also advances the address of the byte being written into the memory, so now as we type HELLO it stores the corresponding ASCII codes 48 45 4C 4C 4F, and they get displayed. //write current ascii code into $current_address and advance the address by 1 write_address > 4) + 1) << 4); Note: I know that having multiple if statements to handle special key logic feels strange and kludgy, I feel it too and know that there must be a better way to structure the logic. The complete product, demonstration What did I learn Active-high vs Active-low Check if your reset button is active-low or active-high logic (https://en.wikipedia.org/wiki/Logic_level#Active_state). I have spent an hour looking at code, debugging various signals only to realize my reset button sends logical one if not pressed. Two vs one process state machines I learned about “two process” design method (as per https://www.gaisler.com/doc/vhdl2proc.pdf) - one sequential, one combinatorial vs “one process”, which does everything in … a single process. The opinions online differ. Apparently the two process one makes sense if you come from electrical engineering background and appears more often in textbooks and articles. I found the latter easier to debug, write and especially reason about what’s going to happen after every cycle / state change and eventually converted the two process starting sample code to a single process one. Connectivity warning / stuck output I again ran into a problem of the synthesizer optimized most of my logic away. While looking for the root cause, this warning helped: Warning (12241): 1 hierarchies have connectivity warnings - see the Connectivity Checks report folder Connectivity checks was useful - it told me which port I missed to wire when connecting a module to the top module and it was stuck on GND. Read the specs in more detail I’m still missing out on the protocol / datasheet nuances and realize some important bits later. Compared to software, I find debugging hardware much harder and time consuming, so it’s best to avoid or catch the bugs early. Making smaller gifs with ffmpeg I cut the gif palette size with palettegen=max_colors=64 to improve the compression a bit. ffmpeg -ss 00:03 -t 00:03.7 -i input.mp4 -an -vf "transpose=2, crop=in_w-200:in_h-50:0:0, fps=11, scale=-1:360:flags=lanczos, split[s0][s1];[s0]palettegen=max_colors=64[p];[s1][p]paletteuse" -loop 1 output.gif What’s next? An easy thing to extend the project would be to handle the Shift key and generate lowercase ASCII codes as well. Also, one could either follow up on the keyboard interface and do something with the text in the buffer when a certain key (Enter) gets pressed - for example send it over a serial port or control various peripherals (LEDs) based on control keys. Or, as an exercise, add more bells and whistles, such as typing on the bottom line scrolling the entire buffer up on a keypress, moving the cursor with arrow keys, playing back the buffer in morse code over a speaker - realistically, I’m probably not going to do any of those. What I’d like to do is to store the ASCII code of the last key pressed into a special buffer, memory mapped to a certain memory address, so the future software running on the board can pick it up, such as in the neat 6502asm emulator. The code Hosted with ❤️ on GitHub: https://github.com/jborza/fpga-ps2-typewriter</p><p>将PS2键盘与FPGA接口，我们将如何处理醉酒键盘？我们要用醉酒的键盘做什么？我们要用醉酒的键盘做什么？一大早！19世纪初的一个海上棚屋，我在“历险记”第6部分--秒表内存映射LCD控制器中实现了内存映射显示后，我想多玩一下LCD显示。我还买了一个PS2键盘，感觉这两个可以搭配在一起。所以，和我一起尝试一些在实际工程场景中可能不切实际的东西：一台电子打字机，你键入的单词会显示在屏幕上。处理PS2协议的最终项目预览传输设备(键盘或鼠标)在10-16.7 kHz范围内触发时钟，然后在PS2时钟的每个下降沿上，这些位经过数据引脚：1个起始位8个数据位1个奇偶校验位1个停止位此分配描述了一种简单的数据收集方法，该方法由@Negedge CLK触发，在11状态机器中仅收集8个数据位而忽略其他数据位。在示波器上捕获PS2时钟引脚波形试图在示波器上捕获PS2时钟有点麻烦。再说一次，更正确地阅读规范可能会让我不那么惊讶，因为它明确地指出，只有当有一些数据通过线路时才会生成时钟信号。PS2接收器如果我们想要与系统的其余部分友好相处，我们应该将协议封装到PS2接收器模块中，接口如下(根据本文)：模块PS2_RX(输入线CLK，RESET，输入线ps2d，//PS2数据输入线ps2c，//PS2时钟输入线rx_en，//Receiver Enable Output reg rx_one_tick，//表示数据可用输出线[7：0]DOUT//PS2 scancode)；注意，PS2接收器代码不是我自己想出来的，但是在线查看各种实现向我展示了处理输入和状态的不同方法。然后，我们可以使用RX_DONE_TICK信号将此模块连接到系统的其余部分。在这种情况下，我直接将接收到的扫描码通过转换器转换成ASCII码(通过下面的Verilog模块)到显示RAM中，稍后在屏幕上显示。这是当我在键盘上键入“hello”时发生的情况：*符号代表未知的扫描码PS2生成和中断代码HM，这并不是我所期望的。再来看看PS2协议，它使用Make(按下)和Break(释放)代码的概念进行操作，因此H(0x48)的扫描码在被推送时首先被发送，然后在它被释放时发送“Break Code”0xF0，紧随其后的是“Break Code”0xF0。再次使用H(0x48)的扫描码。对于特殊的键，如ALT、箭头键、HOME、END等，这有点复杂，因为这些键有多个单词组成的代码。在按住H键的情况下，它会生成代码序列48 48 48...。F0 48。当然，当您按住A并按下B，然后松开B再松开A时，您会得到一系列的Make代码，分别是A、B、B和A的Break代码。键Make Break A 1C F0，1C B 32 F0，32 Backspace 66 F0，66 L Shift 12 F0，12 Enter 5A F0，5A Left←E0，6B E0，F0，6B Numpad 4 6B F0，6B Home E0，6C E0，F0，6C Numpad 7 6C F0，6C暂停E1，1D，45，E1，9D，C5-None-在这个简单的打字机案例中，让我们假装对键盘释放事件不感兴趣。同样碰巧的是，多字制码的最后一个字通常对应于常规键盘上的键的另一个版本。因此，左箭头←的代码与键盘4 E0，6B的代码相同，在我的键盘上，键盘上有一个左箭头图片。这意味着，如果我们假装键盘上的数字部分不存在，我们可能只需要解释make代码的最后一个词，就可以得到最正确的含义。改进仅处理按键，而不是释放我们应该升级键盘驱动程序，在其周围添加另一个处理按键的模块。它有一个新输出：makeBreak，它将为make输出1，为Break代码输出0。然后，在顶部模块中，我们可以通过完全忽略带有中断码标志的扫描码来单独处理这些情况。E0后面似乎有一个扫描码，E1后面似乎有两个扫描码。有一些扫描码序列较长的奇怪密钥：Pause：e11D 45 e1 9D C5，Print Screen：e0 2a e0 37。我会假装这些不存在。我将新模块命名为ps2_keypress_driver，如果事件带有中断代码，它实际上会忽略这些事件。它还推进了写入内存的字节的地址，所以现在当我们键入Hello时，它会存储相应的ASCII码48454C4C4F，然后它们就会显示出来。//将当前ASCII代码写入$CURRENT_ADDRESS并将地址前进1 WRITE_ADDRESS&lt;=CURRENT_ADDRESS；RAM_IN&lt;=ASCII_SCAN_DATA；CURRENT_ADDRESS&lt;=CURRENT_ADDRESS+1；WE&lt;=1‘b1；实现退格键。实施结束</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="http://jborza.com/hardware/2020/10/31/hardware-adventures-8-ps2-typewriter.html">http://jborza.com/hardware/2020/10/31/hardware-adventures-8-ps2-typewriter.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/硬件/">#硬件</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/键盘/">#键盘</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ps2/">#ps2</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1032654.html"><img src="http://img2.diglog.com/img/2020/11/thumb_0223d07386be748502b18ba2d0b454f9.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032654.html">“把一些东西放进硬件”(ASIC)通常不会让程序变得更快</a></div><span class="my_story_list_date">2020-11-2 2:48</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032325.html"><img src="http://img2.diglog.com/img/2020/10/thumb_c066198a7d3914710b3fa57a66a0e513.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032325.html">RISC-V正试图发起一场开放硬件革命</a></div><span class="my_story_list_date">2020-10-31 2:1</span></div><div class="col-sm"><div><a target="_blank" href="/story/1031582.html"><img src="http://img2.diglog.com/img/2020/10/thumb_21ededac314d85399d5606f786c2d456.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031582.html">Pro1 X智能手机配有硬件键盘，专为运行LineageOS或Ubuntu而设计</a></div><span class="my_story_list_date">2020-10-28 3:8</span></div><div class="col-sm"><div><a target="_blank" href="/story/1031228.html"><img src="http://img2.diglog.com/img/2020/10/thumb_0c1f03d4ce6d853fbfbfa49a4f5259a2.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031228.html">ESP8266作为开源硬件</a></div><span class="my_story_list_date">2020-10-26 21:53</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>