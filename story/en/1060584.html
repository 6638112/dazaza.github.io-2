<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>将旧数字时钟（带室外温度计）置于类固醇上 Putting an old digital clock (with an outdoor thermometer) on steroids</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Putting an old digital clock (with an outdoor thermometer) on steroids<br/>将旧数字时钟（带室外温度计）置于类固醇上 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-05-05 20:52:01</div><div class="page_narrow text-break page_content"><p>According to the label on the back, it is a rebranded “Electronics TomorrowLTD.” model no. 7904.</p><p>根据背面的标签，它是一个重创的“Electronics Notherltd”。型号。 7904。</p><p>  But recently I wasn’t so thrilled with the outdoor temperature sensor. It’sclunky, runs on 2 AAA batteries, and has the additional problem of being juston one side of the apartment. So you get skewed readings throughout the day,as the sun moves in the sky.</p><p>  但最近，我对室外温度传感器并不令人兴奋。它会在2个AAA电池上运行，并有额外的问题是公寓的一侧。所以你全天都会得到倾斜的读数，因为太阳在天空中移动。</p><p>       First step is to figure out what protocol does the outdoor temperature sensorspeak to the clock. And pray it’s something simple. Given the clock is wellpast puberty now, it’s safe to assume it’s not going to be in the rocket scienceterritory.</p><p>       第一步是弄清楚户外温度Sensorspeak ob的协议。并祈祷这是一个简单的东西。鉴于时钟是威尔斯普斯普利蒂现在，假设它不会在火箭科学表情中是安全的。</p><p>  Using the highly scientific approach of  “let’s go through all the ISM bandswhile I pull the batteries in and out of the outdoor sensor,” I scoredon 433.9 MHz:</p><p>  使用高度科学的方法“让我们通过所有ISM箱子，我将电池拉出室外传感器，”我克定了433.9 MHz：</p><p>  and a bit of searching later, I landed squarely on rtl_433 which is an awesome protocoldecoder that understands many dialects frequently spoken on the ISM bands.</p><p>  稍后一点搜索，我在RTL_433上落地，这是一个很棒的ProtocoldeCoder，了解在ISM频段上经常发出的许多方言。</p><p>     #define PACKET_SIZE 32 bool  pattern_template [ PACKET_SIZE ]  =  {  0 , 0 , 0 , 1 ,  // [0..3] static pattern  0 , 0 , 1 , 0 ,  // [4..7] channel (0=2, 2=1, 4=3)  1 , 0 , 1 , 1 , 1 , 1 , 1 , 1 , 1 , 1 ,  // [8..17] temperature_c = pattern - 500 / 10  0 , 0 , 0 , 0 , 0 , 0 , 0 ,  // [18..24] static pattern  0 ,  // [25] battery (0 = OK); WARN: our receiver takes bat low (1) as sticky  0 ,  // [26] static pattern  0 ,  // [27] unknown  0 , 0 , 0 , 0  // [28..31] crc-4 of [0..27], poly 0x9, init 0x1 };</p><p>     #define packet_size 32 bool pattern_template [packet_size] = {0,0,0,1，// [0..3]静态模式0,0,1,0，// [4..7]通道（0 = 2 ，2 = 1,4 = 3）1,0,1,1,1,1,1,1,1,1,1,1，1，// [8..17]温度_c =图案 -  500/10 0,0,0， 0,0,0,0，// [18..24]静态图案0，// [25]电池（0 = OK）;警告：我们的接收器采用棒低（1）粘滞0，// [26]静态模式0，// [27]未知0,0,0,0 // [28..31] CRC-4 [0 。.27]，poly 0x9，init 0x1};</p><p>  I had a cheap 434 MHz transmitterlying around, so I wired it to an ESP32 board:</p><p>  我周围有一个廉价的434 MHz，所以我将它连接到ESP32板上： </p><p>   Essentially, I’m just bit-banging the protocol. Because it turns out, it’sa simple  OOK(on-off keying) scheme.</p><p>基本上，我只是在敲击方案。因为它结果，它是简单的OOK（开关键控）方案。</p><p> // ... static  void  transmit ( bool  state )  {  uint16_t  l  =  state  ?  one_bit_length  :  zero_bit_length ;  gpio_set_level ( TXPIN ,  1 );  vTaskDelay ( l  /  portTICK_PERIOD_MS );  gpio_set_level ( TXPIN ,  0 );  vTaskDelay (( bit_length  -  l )  /  portTICK_PERIOD_MS ); } static  void  transmit_array ( bool  * ar ,  uint8_t  size )  {  for  ( uint8_t  i  =  0 ;  i  &lt;  size ;  i ++ )  {  transmit ( ar [ i ]);  } } // ... void  tx434_task ( void  * pvParameters ) {  bool  packet [ PACKET_SIZE ];  ESP_LOGI ( TAG ,  &#34;Configuring&#34; );  gpio_pad_select_gpio ( LEDPIN );  gpio_set_direction ( LEDPIN ,  GPIO_MODE_OUTPUT );  gpio_pad_select_gpio ( TXPIN );  gpio_set_direction ( TXPIN ,  GPIO_MODE_OUTPUT );  ESP_LOGI ( TAG ,  &#34;Entering loop&#34; );  while  ( 1 )  {  float  temp_to_send  =  TEMP_ERRVAL ;  time_t  now ;  if  ( temp_set )  {  time ( &amp; now );  if  ( last_ts  +  TEMP_TIMEOUT  &gt;=  now )  {  temp_to_send  =  current_temp ;  }  }  init_with_temp ( packet ,  temp_to_send ,  false ,  1 );  ESP_LOGI ( TAG ,  &#34;Sending: %.01f&#34; ,  temp_to_send );  led_on ();  transmit_array ( preamble_bits ,  4 );  transmit_array ( preamble_bits ,  4 );  transmit_array ( packet ,  PACKET_SIZE );  gap ();  transmit_array ( preamble_bits ,  4 );  transmit_array ( packet ,  PACKET_SIZE );  gap ();  transmit_array ( preamble_bits ,  4 );  transmit_array ( packet ,  PACKET_SIZE );  led_off ();  ESP_LOGI ( TAG ,  &#34;Going to sleep&#34; );  vTaskDelay ( 179  *  1000  /  portTICK_PERIOD_MS );  }  }</p><p> // ...静态void传输（bool状态）{uint16_t l =状态？ one_bit_length：zero_bit_length; gpio_set_level（txpin，1）; vtaskdelay（l / porttick_period_ms）; gpio_set_level（txpin，0）; vtaskdelay（（bit_length  -  l）/ porttick_period_ms）;静态void transmit_Array（Bool * AR，UINT8_T大小）{for（uint8_t i = 0; i＆lt; size; i ++）{发送（AR [i]）; }} // ... void tx434_task（void * pvparameters）{bool packet [packet_size]; esp_logi（标记，＆＃34;配置＆＃34;）; gpio_pad_select_gpio（LEDPIN）; gpio_set_direction（LEDPIN，GPIO_MODE_OUTPUT）; gpio_pad_select_gpio（txpin）; gpio_set_direction（txpin，gpio_mode_output）; Esp_Logi（标签，＆＃34;进入循环＆＃34;）;虽然（1）{float temp_to_send = temp_errval; Time_t现在; if（temp_set）{时间（＆amp;现在）; if（last_ts + temp_timeout＆gt; =现在）{temp_to_send = current_temp; }} init_with_temp（packet，temp_to_send，false，1）; esp_logi（标签，＆＃34;发送：％.01f＆＃34;，temp_to_send）;带领 （）;传输array（preamble_bits，4）;传输array（preamble_bits，4）;传输array（数据包，packet_size）;差距 （）;传输array（preamble_bits，4）;传输array（数据包，packet_size）;差距 （）;传输array（preamble_bits，4）;传输array（数据包，packet_size）; LED_OFF（）; esp_logi（标签，＆＃34;去睡觉＆＃34;）; vtaskdelay（179 * 1000 / porttick_period_ms）; }}</p><p>   Having a proof of concept of the transmitter figured out, I turned to the finalarchitecture.</p><p>   我转向终结结构的概念证明。</p><p> I’m a big fan of HTTP. It’s easy to debug, ubiquitous, dead easy to target.</p><p> 我是HTTP的忠实粉丝。它很容易调试，无处不在，易于达到目标。</p><p>   I could have gone with the esp32 doing everything. But an additional upside ofhaving a more powerful webserver in the middle is that I can now check thetemperature also on my phone  3 and don’t have to re-flash the esp32 when Idecide to tinker with the webserver some more  4.</p><p>   我可以通过esp32做一切。但是在中间的一个更强大的网络服务器的额外上行的额外上行的是我现在可以在手机3上检查测温体3，并且不必在idecide以与web服务器的修补程序一起重新闪烁esp32。</p><p>  I did a quick search of what’s available, and turns out that Go has rather superbsupport for both Bluetooth LE and RuuviTag in particular.</p><p>  我很快就可以了解可用的东西，并表明，特别是对蓝牙le和ruuvitag的比较有效。</p><p> So I’m not wasting a minute writing the pusher in a more programmer-friendlylanguage.</p><p> 所以我不会浪费一分钟，以更具程序员 - 友好语言写作推动者。 </p><p>  // ruuvipush.go package  main import  (  &#34;context&#34;  &#34;fmt&#34;  &#34;net/http&#34;  &#34;net/url&#34;  &#34;os&#34;  &#34;strconv&#34;  &#34;github.com/go-ble/ble&#34;  &#34;github.com/go-ble/ble/examples/lib/dev&#34;  &#34;github.com/peterhellberg/ruuvitag&#34; ) var  apiurl  =  &#34;nonsense&#34; func  setup ( ctx  context . Context )  context . Context  {  d ,  err  :=  dev . DefaultDevice ()  if  err  !=  nil  {  panic ( err )  }  ble . SetDefaultDevice ( d )  return  ble . WithSigHandler ( context . WithCancel ( ctx )) } func  main ()  {  if  len ( os . Args [ 1 : ])  &gt;=  1  {  apiurl  =  os . Args [ 1 ]  }  else  {  fmt . Printf ( &#34;Usage: $0 &lt;apiurl&gt; \n &#34; )  os . Exit ( 1 )  }  ctx  :=  setup ( context . Background ())  ble . Scan ( ctx ,  true ,  handler ,  filter ) } func  handler ( a  ble . Advertisement )  {  raw ,  err  :=  ruuvitag . ParseRAWv1 ( a . ManufacturerData ())  if  err  ==  nil  {  // fmt.Printf(&#34;[%s] RSSI: %3d: %+v\n&#34;, a.Addr(), a.RSSI(), raw)  resp ,  err  :=  http . PostForm ( apiurl ,  url . Values {  &#34;id&#34; :  { a . Addr () . String ()},  &#34;temperature&#34; :  { strconv . FormatFloat ( raw . Temperature ,  &#39;f&#39; ,  6 ,  64 )}})  if  err  !=  nil  {  fmt . Printf ( &#34;Failed to post: %v \n &#34; ,  err )  }  else  {  resp . Body . Close ()  }  } } func  filter ( a  ble . Advertisement )  bool  {  return  ruuvitag . IsRAWv1 ( a . ManufacturerData ()) }</p><p>// ruuvipush.go package main import（＆＃34;上下文＆＃34;＆＃34; fmt＆＃34;＆＃34; net / http＆＃34;＆＃34; net / url＆＃34;＆＃34;操作系统＃34;＆＃34; strconv＆＃34;＆＃34; github.com/go-ble/ble&#34;＆＃34; github.com/-ble/ble/examples/lib/dev& #34;＆ ＃34; github.com/peterhellberg/ruuvitag&#34;）var apiurl =＆＃34;胡说八道。 Func设置（CTX上下文。上下文）上下文。上下文{D，err：= dev。 defaultDevice（）如果err！= nil {panic（err）} ble。 setdefaultdevice（d）返回ble。 withsighandler（上下文。使用cancel（ctx））} func main（）{如果len（args [1：]）＆gt; = 1 {apiurl = os。 args [1]}别的{fmt。 Printf（＆＃34;使用：$ 0＆lt; apiurl＆gt; \ n＆＃34;）操作系统。退出（1）} ctx：= setup（上下文。背景（））ble。扫描（CTX，True，Handler，Filter）} Func Handler（BLE。广告）{RAW，ERR：= RUUvitag。 parserawv1（a。制造商adata（））如果err == nil {// fmt.printf（＆＃34; [％s] rssi：％3d：％+ v \ n＆＃34; a.addr（），a。 RSSI（），RAW）RESP，ERR：= HTTP。 Postform（APIURL，URL。值{＆＃34; ID＆＃34;：{a。Addr（）。String（）}，＆＃34;温度＆＃34;：{strconv。formatfloat（RAW。温度，＆＃39 ; F＆＃39;，6,64）}}）如果err！= nil {fmt。 printf（＆＃34;未能发布：％v \ n＆＃34;，err）} else {resp。身体 。关闭（）}}} Func筛选器（BLE。广告）BOOL {RETURN RUUVITAG。 ISRAWv1（a。制造商DATA（））}</p><p> and the webserver itself is so boringly simple, that I’ll just point you to temperatures.rbrather than pasting it here.</p><p> 而且网络服务器本身是如此令人毛骨悚然的简单，我将指出你的气温。伯特比在这里粘贴它。</p><p> I’m still undecided whether to display an average across all the Ruuvi tags,or the minimum. Time will tell what’s better.</p><p> 我仍然尚未考虑是否在所有Ruuvi标签上显示平均值，或最小。时间会告诉什么更好。</p><p> In any case, throwing it up as  daemontoolsservices on an Alpine Linux is also laughably easy. If you want the details,it’s all in the  ruuvi-tempserverrepo.</p><p> 无论如何，作为高山Linux上的DaemontoolsServices扔掉它也很容易。如果您想要详细信息，它都在Ruvi-TempserverRepo中。</p><p>  Well, there you have it. Putting a digital clock on steroids doesn’t have to behard.</p><p>  好吧，你有它。将数字时钟放在类固醇上不必撇台。</p><p> In fact, the only  hard  medium rare part was to code up the transmitter. Therest was just easy copy &amp; paste “programming”.</p><p> 事实上，唯一的硬介质罕见部分是编写发射机。它只是简单的复制＆amp;粘贴“编程”。</p><p> RuuviTag is a small temperature/humidity/pressuresensor that transmits data over BLE. With the CR2477 battery, its battery lifeis measured in ~years.  ↩</p><p> Ruvitag是一个小的温度/湿度/压力镜，可通过BLE传输数据。使用CR2477电池，其电池寿命在〜多年中测量。 ↩ </p><p> RTL-SDR is a cheap DVB-T dongle sporting Realtek RTL2832U chip that somesmart folks turned into a  SDR receiver.If you can’t get it under $10, you aren’t trying hard enough.  ↩</p><p>RTL-SDR是一个廉价的DVB-T加密狗Sporting Realtek RTL2832U芯片，SomesMart人员变成了一个SDR接收者。如果你不能超过10美元，你就没有努力。 ↩ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://wejn.org/2021/05/putting-old-temp-clock-on-steroids/">https://wejn.org/2021/05/putting-old-temp-clock-on-steroids/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/时钟/">#时钟</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/digital/">#digital</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/err/">#err</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>