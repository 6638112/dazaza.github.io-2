<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>懈怠工程：Jenkins工作如何突破Jenkins UI Slack Engineering: How a Jenkins Job Broke Our Jenkins UI</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Slack Engineering: How a Jenkins Job Broke Our Jenkins UI<br/>懈怠工程：Jenkins工作如何突破Jenkins UI </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-06-04 01:42:08</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/6/c12f9a539e99f89296fcb01d91a14bf4.png"><img src="http://img2.diglog.com/img/2021/6/c12f9a539e99f89296fcb01d91a14bf4.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>At Slack we manage  a sophisticated Jenkins infrastructure to continuously build and test our mobile apps before release. We have hundreds of jobs running in a variety of different environments. One day something very odd happened — our Jenkins UI stopped working although the jobs continued to run. This post is a breakdown of how we ended up in this state and how we fixed the problem. From this experience, we’re also sharing some general-purpose tips on troubleshooting a Jenkins issue.</p><p>在Slack，我们管理一个复杂的Jenkins基础架构，以在发布之前不断构建和测试我们的移动应用程序。我们有数百个在各种不同环境中运行的工作。有一天很奇怪的事情发生了 - 我们的Jenkins UI停止工作，尽管工作继续运行。这篇文章是我们在这种状态的最终结束以及我们如何解决问题的细目。从这种体验中，我们还在分享一些关于jenkins问题的通用技巧。</p><p>      As part of our automation setup, we continuously run integrity jobs to inspect our Jenkins nodes. These jobs check system configurations and properties and look to see if any node is failing those checks. The checks automatically mark Jenkins nodes as offline when any of those checks fail and notifies our Mobile Build &amp; Release team via a Slack message.</p><p>      作为我们自动化设置的一部分，我们不断运行完整性作业来检查我们的Jenkins节点。这些作业检查系统配置和属性，并查看是否有任何节点都会失败。当任何这些检查都失败并通知我们的移动版本时，检查会将Jenkins节点标记为脱机。通过懈怠释放团队。</p><p>    With this knowledge, and after restoring the Jenkins UI by rebooting the main instance so that our dev teams were unblocked, we started our investigation.</p><p>    通过这种知识，通过重新启动主要实例以便恢复Jenkins UI以便我们的Dev团队畅通无阻，我们开始进行调查。</p><p>  We thought that there was some connection between the integrity job and the UI, but the error message from the UI didn’t reveal much. We then tried to reproduce the error. In a separate Jenkins staging environment, which was running the same Jenkins version and plugins as our Jenkins production environment, we manipulated one of the nodes on purpose and reran the integrity job. And again, the UI broke, so we could reproduce the issue.</p><p>  我们认为诚信作业与UI之间存在一些联系，但UI的错误消息没有透露太多。然后我们试图重现错误。在一个单独的Jenkins暂存环境中，它运行了与我们的Jenkins生产环境相同的Jenkins版本和插件，我们以目的地操纵其中一个节点并重新划分的诚信作业。又一次，UI破坏了，所以我们可以重现这个问题。</p><p>   Note: “hudson.slaves” is part of the interface that Jenkins provides; in our own code at Slack, we’ve fully moved over to “controller” and “agent” as the preferred terminology.</p><p>   注意：“Hudson.slaves”是Jenkins提供的界面的一部分;在我们自己的代码中，我们完全将“控制器”和“代理”作为首选术语完全转移到“控制器”和“代理”中。</p><p> We use a common pattern that calls the Jenkins Java API with an instance of the  OfflineMessage class to provide the cause of a particular node getting marked as offline to provide context:</p><p> 我们使用一个常见的模式，将Jenkins Java API调用了offlineMessage类的实例，以提供特定节点的原因被标记为脱机以提供上下文：</p><p> def markNodeOffline() { def node = getCurrentNode(env.NODE_NAME) node.toComputer().setTemporarilyOffline( true, OfflineCause.create(new OfflineMessage()) )}class OfflineMessage extends org.jvnet.localizer.Localizable { def message OfflineMessage() { super(null, null, []) def timestr = new Date().format( &#34;HH:mm dd/MM/yy z&#34;, TimeZone.getDefault() ) this.message = &#34;The node was taken offline at ${timestr} due to corrupted host file&#34; } String toString() { this.message } String toString(java.util.Locale l) { toString() }}</p><p> def marknodeoffline（）{ def node = getCurrentNode（env.node_name） node.tocomputer（）。SeteMporallyOffline（ True，Offlineause.Create（新的OfflineMessage（）） ）}class offlinemessage扩展了org.jvnet.localizer.localizable { def消息 offlinemessage（）{ 超级（null，null，[]） def timestr =新日期（）。格式（ ＆＃34; hh：mm dd / mm / yy z＆＃34;，timezone.getdefault（） ） 此.Message =＆＃34;由于损坏的主机文件和＃34，该节点以$ {timestr}脱机; } 字符串toString（）{ 这条信息 } 串toString（java.util.locale l）{ ToString（） }} </p><p> We added the  typical @NonCPS annotation to the affected methods ( toString()) and retriggered the job. The error was gone from the job logs, but the Jenkins UI still broke. So while it might have been related to the missing annotation, this change did not resolve the issue. Reproducing the behavior once more, we started tailing the Jenkins logs while trying to load the UI. We noticed the following error:</p><p>我们将典型的@ noncps注释添加到受影响的方法（toString（））并重新启动作业。错误从作业日志消失，但jenkins ui仍然破产。因此，虽然它可能与缺少的注释有关时，这种变化并没有解决问题。再次再次再现行为，我们开始在尝试加载UI时拖尾日志。我们注意到以下错误：</p><p> 2020-12-05 02:44:44.201+0000 [id=24] WARNING h.i.i.InstallUncaughtExceptionHandler#handleException: Caught unhandled exception with ID a4bf874a-5029-4f37-b6e6-217ca8bb76de org.apache.commons.jelly.JellyTagException: jar:file:/var/cache/jenkins/war/WEB-INF/lib/jenkins-core-2.235.5.jar!/hudson/model/Computer/index.jelly:63:66: Rejecting unsandboxed property get: OfflineMessage.message</p><p> 2020-12-05 02：44：44.201 + 0000 [ID = 24]警告HIIINSTALLUNCAughtExceptionHandler＃hargeException：捕获了未处理的异常与id a4bf874a-5029-4f37-b6e6-217ca8bb76de org.apache.commons.jelly.jellytagexception：jar：文件：/var/cache/jenkins/war/war/war/war/war/war/jenkins-core-2.235.5.jar！/hudson/model/computer/index.jelly：63：66：拒绝Undandboxed属性获取：offlinemessage.message</p><p>   @Overridepublic Object onGetProperty( Invoker invoker, Object receiver, String property) throws Throwable { throw new SecurityException( &#34;Rejecting unsandboxed property get: &#34; + getClassName(receiver) + &#34;.&#34; + property );}</p><p>   @Override.公共对象IngetProperty（ Invoker Invoker，Object Receiver，String属性）扔扔扔{ 抛出新的securityException（ ＆＃34;拒绝Undandboxed属性获得：＆＃34; + getClassName（接收器）+＆＃34;。＆＃34; +财产 ）;}</p><p> Tracing back the origin of this code change, we found out that a recent CVE ( CVE-2020-2279) had been  addressed by the Jenkins maintainers. As one of the security fixes, the  groovy-sandbox  restricted the access for certain interactions. The library was packaged in the  Script Security Plugin, which had been updated with our latest Jenkins upgrade. A temporary downgrade of the plugin in our staging Jenkins environment and a rerun of the pipeline confirmed our theory. The UI didn’t break this time as we found the root cause. Now, let’s fix it!</p><p> 追溯这段代码变更的起源，我们发现最近的CVE（CVE-2020-2279）已由Jenkins维护者解决。作为安全修复的一个，Groovy-Sandbox限制了某些交互的访问。该库在脚本安全插件中打包，该插件已更新，我们的最新Jenkins升级更新。在我们的舞台环境中暂时降级了插件和管道的重新定位证实了我们的理论。当我们找到根本原因时，UI没有打破这个时间。现在，让我们解决它！</p><p>  Sandboxing in Jenkins is often the root cause of build pipeline issues, and so our goal was to replace the  OfflineMessage class with something simpler to avoid similar issues. As it turns out, the Jenkins Java API provides a straightforward interface that takes a  String as parameter to describe the cause of a node being offline (as compared to an instance of a class that implements  Localizable):  hudson.slaves.OfflineCause.ByCLI. Instead of implementing our own message class, which internally also used a  String for the offline cause message, we now simply call the  ByCLI constructor:</p><p>  Jenkins的沙箱通常是构建管道问题的根本原因，因此我们的目标是用更简单的东西取代offlinemessage类以避免类似的问题。事实证明，Jenkins Java API提供了一个直接的接口，它将字符串作为参数，以描述脱机的节点的原因（与实现本地化的类的实例相比）：hudson.slaves.offlineause.bycli。而不是实现自己的邮件类，而不是在内部使用的字符串用于离线导致消息，我们现在只需调用ByCli构造函数：</p><p> def createMessage() { def timestr = new Date().format( &#34;HH:mm dd/MM/yy z&#34;, TimeZone.getDefault() ) &#34;The node was taken offline at ${timestr} due to corrupted host file&#34;.toString()}def markNodeOffline() { def node = getCurrentNode(env.NODE_NAME) node.toComputer().setTemporarilyOffline( true, new OfflineCause.ByCLI(createMessage()) )}</p><p> def createmessage（）{ def timestr =新日期（）。格式（ ＆＃34; hh：mm dd / mm / yy z＆＃34;，timezone.getdefault（） ） ＆＃34;由于损坏的主机文件＆＃34; .tostring（），该节点是以$ {timestr}脱离的$ {timestr}; .tostring（）}def marknodeoffline（）{ def node = getCurrentNode（env.node_name） node.tocomputer（）。SeteMporallyOffline（ TRUE，NEW OFFLINEAUE.BYCLI（CreateMessage（）） ）}</p><p> With the fix rolled out, we enabled our Jenkins integrity check job again and were able to confirm it didn’t break the Jenkins UI anymore. Hurray!</p><p> 通过修复推出，我们使我们的Jenkins Integrity Check作业再次启用，并且能够确认它不会再打破Jenkins UI。欢呼！ </p><p>  There are few lessons learned here that universally apply to the management and troubleshooting of a Jenkins-powered CI/CD infrastructure.</p><p>这里有很少的经验教训，普遍适用于Jenkins供电的CI / CD基础架构的管理和故障排除。</p><p>  It pays to have separate environments and to follow staged rollouts, especially in the cloud, to reduce the blast radius and detect potential issues early on as features and new capabilities get shipped to users as quickly as possible. Having a dedicated Jenkins staging environment that mirrors our production environment provided us the perfect experimentation ground to confirm our hypotheses on the root cause of issues. Maintaining the mirror requires effort to ensure parity between the environments (e.g. plugin versions) and customizations to Jenkins jobs to execute in “dry-run” mode in non-production environments. We account for this in our maintenance tasks and pipeline setups.</p><p>  有单独的环境和遵循分阶段的卷展览，特别是在云中，以减少爆炸半径，并尽可能快地向用户发货到用户身上的爆炸半径并检测潜在问题。拥有专门的Jenkins暂存环境，镜像我们的生产环境为我们提供了完美的实验场，以确认我们的假设对问题的根本原因。维护镜像需要精力，以确保环境之间的奇偶校验（例如插件版本）和自定义为Jenkins作业以在非生产环境中以“干​​运行”模式执行。我们在我们的维护任务和管道设置中占此占据。</p><p>  Jenkins is powerful and exposes many convenient functions to pipelines that run on it. For anything that goes beyond the standard capabilities, Jenkins allows customizations through  its API that can be backed into Jenkins pipeline libraries and custom Groovy code. However, this tightly couples pipelines and jobs to the underlying Jenkins infrastructure. So, we recommend keeping custom integrations with the Jenkins API as lean and simple as possible to lower the risk of getting caught off guard when Jenkins releases or plugin updates introduce breaking changes.</p><p>  Jenkins强大，揭示了许多方便的函数，向流水线运行。对于超出标准功能的任何内容，Jenkins允许通过其API进行自定义，这些API可以备份到Jenkins Pipeline库和自定义Groovy代码中。然而，这将管道和工作紧紧地耦合到底层的Jenkins基础设施。因此，我们建议使用Jenkins API保持自定义集成作为精简和简单，以降低Jenkins版本或插件更新时介绍破坏更改时捕获后卫的风险。</p><p>  Groovy is typically the language of choice for extending Jenkins with custom code. It gets executed in  a special Groovy sandbox to increase the security posture. The Jenkins maintainers do an amazing job keeping the sandbox’s security level high (e.g. addressing CVEs), which often leads to tightened defaults. This can catch teams by surprise, especially when updating the plugin as a regular maintenance task. Studying changelogs is always advised, but especially recommended for core plugins of the Jenkins ecosystem.</p><p>  Groovy通常是用自定义代码扩展Jenkins的首选语言。它在特殊的Groovy Sandbox中执行，以增加安全姿势。 Jenkins维护者们做了一个惊人的工作，让沙箱的安全级别高（例如寻址CVES），这通常会导致收紧默认值。这可以通过惊喜捕获团队，特别是在更新插件作为常规维护任务时。始终建议研究变更乐，但特别推荐用于Jenkins生态系统的核心插件。</p><p>  Continuously-updated and well-documented runbooks can save you from headaches and many hours spent reading Jenkins logs. This actually applies universally to the DevOps world. In our case, this means a thoroughly documented upgrade process for the Jenkins core and crucial plugins. It also means having all important pipelines and Jenkins jobs that interact with the Jenkins API included in our upgrade and validation processes.</p><p>  持续更新的且记录良好的流程图可以节省您的头痛，并且花在阅读Jenkins日志的数小时。这实际上适用于Devops World。在我们的情况下，这意味着Jenkins核心和关键插件的完全记录的升级过程。它还意味着拥有所有重要的管道和Jenkins就业，与我们升级和验证流程中包含的Jenkins API互动。</p><p>  Going down the rabbit hole of Jenkins internals showed us the advantages of our staging environment, but also revealed shortcomings in our upgrade processes. We hope this troubleshooting has been as insightful to you as it has been to us!</p><p>  沿着Jenkins Internals的兔子洞表明我们的舞台环境的优势，也揭示了我们升级过程中的缺点。我们希望这个故障排除一直是对我们有富敏感！ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://slack.engineering/how-a-jenkins-job-broke-our-jenkins-ui/">https://slack.engineering/how-a-jenkins-job-broke-our-jenkins-ui/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/jenkins/">#jenkins</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>