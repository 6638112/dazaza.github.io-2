<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>异步打开和关闭Asyncio中的文件</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">异步打开和关闭Asyncio中的文件</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-07 05:07:28</div><div class="page_narrow text-break page_content"><p>Python asyncio支持异步联网、子进程和进程间通信。但是，它没有用于异步文件操作-打开、读取、写入或关闭。这可能部分是因为操作系统本身也缺乏这些功能。如果文件操作需要很长时间(可能是因为文件在网络挂载上)，则整个Pythonprocess将挂起。可以解决这个问题，所以让我们构建可以异步打开和关闭文件的autility。</p><p>解决操作系统对特定异步操作支持不足的通常方法是将线程专用于等待这些操作。通过使用线程池，我们甚至可以在需要线程时避免产生线程的开销。另外，Asyncio被设计成无论如何都能很好地处理线程池。</p><p>在我们开始之前，我们需要一些方法来测试它是否正常工作。我们需要一个速度很慢的文件系统。一种想法是使用ptrace拦截相关的系统调用，尽管这并不是那么简单。在等待打开(2)的线程暂停时，其他线程需要继续运行，但是ptrace会暂停整个进程。幸运的是，无论如何都有一个更简单的解决方案：LD_PRELOAD。</p><p>将LD_PRELOAD环境变量设置为共享对象的名称将导致加载程序优先加载此共享对象，从而允许该共享对象覆盖其他库。我使用的是x86-64Linux(Debian)，所以我希望覆盖glibc中的open64(2)。这是我的开场白64.c：</p><p>#DEFINE_GNU_SOURCE#include&lt；dlfcn.h&gt；#include&lt；string.h&gt；#include&lt；unistd.h&gt；int open64(const char*path，int flag，int mode){if(！Strncmp(path，&#34；/tmp/&#34；，5){睡眠(3)；}int(*f)(const char*，int，int)=dlsym(RTLD_NEXT，&#34；open64&#34；)；return f(path，flag，mode)；}。</p><p>现在，Python在打开文件时必须通过我的C函数。如果该文件位于/tmp/下，则打开该文件将延迟3秒。因为我仍然想实际打开一个文件，所以我使用dlsym()来访问glibc中真正的open64()。我是这样建造的：</p><p>为了测试它是否可以与Python一起使用，让我们计算一下打开/tmp/x需要多长时间：</p><p>太棒了！(注意：设置环境变量之前的放置时间有点奇怪，但这是因为我使用的是Bash，而且它的时间是特殊的，因为这是该命令的shell版本。)</p><p>Python的标准open()最常用作上下文管理器，因此无论发生什么，文件都会自动关闭。</p><p>我希望我的异步打开使用Asyncwith遵循此模式。与类似，但是上下文管理器是异步获取和释放的。我将把我的版本命名为AOPEN()：</p><p>因此，AOPEN()将需要返回异步上下文管理器，这是一个具有方法__aenter__和__aexit__的对象，这两个方法都返回可等待对象。通常这是因为这些方法是协程函数，但是直接返回可等待的普通函数也可以工作，这就是我将为__aenter__所做的。</p><p>Class_AsyncOpen()：def__init__(self，args，kwargs)：...。定义__aenter__(自我)：...。异步def__aexit__(self，exc_type，exc，tb)：...。</p><p>最终，我们必须调用open()。Open()的参数将提供给稍后使用的构造函数。当您看到AOPEN()的定义时，这会更有意义。</p><p>当实际打开文件时，Python将调用__aenter__。我们不能直接调用open()，因为它会阻塞，所以我们将使用athread池来等待它。我们将使用当前事件循环附带的线程池，而不是创建线程池。Run_in_Executor()方法在线程池中运行函数-其中NONE表示使用默认池-返回表示未来结果的异步未来，在本例中为打开的文件对象。</p><p>Def__aenter__(Self)：def thread_open()：返回open(*sel.。_args，**self。_kwargs)循环=异步。Get_event_loop()self。_未来=循环。Run_in_Executor(NONE，THREAD_OPEN)返回SELF。_未来。</p><p>由于此__aenter__不是协程函数，因此它将直接返回未来作为其等待的结果。打电话的人会等着的。</p><p>默认线程池限制为每个核心一个线程，这是最明显的选择，尽管在这里并不理想。这对于CPU受限的操作很好，但对于I/O受限的操作就不行了。在真实程序中，我们可能希望使用更大的线程池。</p><p>关闭文件可能会阻塞，因此我们也将在线程池中执行此操作。首先，从将来拉出文件对象，然后在线程池中将其关闭，直到文件实际关闭：</p><p>异步def__aexit__(self，exc_type，exc，tb)：file=等待自身。_Future定义THREAD_CLOSE()：文件。CLOSE()LOOP=Asyncio。GET_EVENT_LOOP()正在等待循环。Run_in_Executor(NONE，THREAD_CLOSE)。</p><p>OPEN和CLOSE在此上下文管理器中成对出现，但它可能与任意数量的OTHER_AsyncOpen上下文管理器并发。打开的文件数量会有一些上限，所以我们需要注意不要同时使用太多这样的东西，这在使用unboundedqueue时很容易发生。在没有反压力的情况下，任务打开文件的速度比关闭文件的速度略快即可。</p><p>首先定义一个“心跳”任务，它将告诉我们在我们等待打开文件时异步循环仍在嘎嘎作响。</p><p>下面是AOPEN()的一个测试函数，它异步打开一个以整数命名的/tmp/下的文件，(同步)将该整数写入文件，然后异步关闭它。</p><p>Main()函数创建心跳任务，并通过截获的文件打开例程并发打开4个文件：</p><p>Async def main()：BEAT=Asyncio。CREATE_TASK(HEADBEAT())TASKS=[Asyncio.。范围(4)内i的CREATE_TASK(WRITE(I))]等待异步。聚集(*任务)节拍。取消()异步。运行(main())</p><p>正如预期的那样，所有4个任务的3秒对应的6个心跳同时花费在截取的打开()上等待。如果你想亲自试一下，这里有完整的源代码：</p><p>只有打开和关闭文件是异步的。读取和写入保持不变，仍然是完全同步和阻塞的，所以这只是一个半解决方案。一个完整的解决方案几乎没有那么简单，因为异步是异步的/等待。异步读取和写入将需要具有不同颜色的所有新API。您需要一个aprint()来补充print()，依此类推，每个返回一个等待等待的。</p><p>这是异步/等待的不幸缺点之一。我更喜欢传统的、先发制人的并发，但我们并不总是有这样的奢侈品。</p><p>对这篇文章有什么评论吗？通过发送电子邮件至~Skeeto/public-inbox@lists.sr.ht[邮件列表礼仪]开始我的公共收件箱中的讨论，或查看现有讨论。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://nullprogram.com/blog/2020/09/04/">https://nullprogram.com/blog/2020/09/04/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/关闭/">#关闭</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/opening/">#opening</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1020349.html"><img src="http://img.diglog.com/img/2020/8/thumb_080e3b0db1f05ffd1aed9f27aaae1e92.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1020349.html">Reddit关闭美国国家安全局前技术总监比尔·宾尼的AMA</a></div><span class="my_story_list_date">2020-8-26 13:27</span></div><div class="col-sm"><div><a target="_blank" href="/story/1015543.html"><img src="http://img.diglog.com/img/2020/8/thumb_bae296f2e4e5e98a41bd6474920f97d9.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1015543.html">微软正在关闭包括iOS和Android在内的多个设备上的Cortana</a></div><span class="my_story_list_date">2020-8-1 8:23</span></div><div class="col-sm"><div><a target="_blank" href="/story/1015402.html"><img src="http://img.diglog.com/img/2020/7/thumb_b448d67d9b075bc12b2fc432a21dfaa4.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1015402.html">推特关闭了前三K党领袖大卫·杜克的账户</a></div><span class="my_story_list_date">2020-7-31 19:55</span></div><div class="col-sm"><div><a target="_blank" href="/story/1010608.html"><img src="http://img.diglog.com/img/2020/7/thumb_b674c5a7053553597e0c4cb028740152.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1010608.html">Odwalla关闭：旧金山湾区奶昔品牌停止运营</a></div><span class="my_story_list_date">2020-7-9 2:0</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>