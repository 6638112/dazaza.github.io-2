<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我们检查的Python代码库中有3%的单元测试失败3 percent of Python codebases we checked had silently failing unit tests</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">3 percent of Python codebases we checked had silently failing unit tests<br/>我们检查的Python代码库中有3%的单元测试失败</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2022-02-17 11:27:44</div><div class="page_narrow text-break page_content"><p>Schrödinger’s unit-test : a unit test that passes but fails to test the thing we want to test.</p><p>薛定谔单元测试：一种通过但未能测试我们想要测试的东西的单元测试。</p><p>  This article focuses on our code scanning of 666 Python codebases to detect one such Schrödinger’s unit tests. Specifically, this gotcha (which we found in 20 codebases and later pushed an auto-generated fix for):</p><p>本文重点介绍我们对666个Python代码库的代码扫描，以检测这样一个薛定谔单元测试。具体来说，这个问题（我们在20个代码库中找到了它，后来推出了一个自动生成的修复程序）：</p><p> Do you see the mistake? It’s a relatively common mistake for a developer to make.  assertEqual and  assertTrue were muddled up. In fact of the 666 codebases we checked, we found 3% of them mixed the two up. This is a real problem that affects real codebases, even active large ones with a huge community and strong testing and code review practices:</p><p>你看到错误了吗？对于开发者来说，这是一个相对常见的错误。assertEqual和assertTrue被搞糊涂了。事实上，在我们检查的666个代码基中，我们发现有3%的代码基将两者混淆了。这是一个真正的问题，它会影响真正的代码库，甚至是具有巨大社区和强大测试和代码审查实践的活跃大型代码库：</p><p>  See the full lists in  this gist. The fact the problem is so widespread suggests a key cause of this mistake is because it’s so easy to miss during code review. A quick glance at the code does not raise any red flags. It “Looks Good To Me!”.</p><p>请参阅本要点中的完整列表。这个问题如此普遍的事实表明，这个错误的一个关键原因是，在代码审查期间很容易漏掉它。快速浏览代码不会引起任何危险。它“看起来不错！”。</p><p>  In the late 19th century Mark Twain apparently said  It’s not what you know that gets you. it’s what you think you know but ain’t. What was true in late 19th century literature is also true in early 21st Python unit testing: tests that don’t really test the thing we want to test is worse than no tests at all because a Schrödinger’s test gives unwarranted confidence that the feature is safe.</p><p>在19世纪末，马克·吐温显然说过，不是你所知道的让你着迷。在19世纪末的文献中是正确的，在21世纪初的Python单元测试中也是正确的：没有真正测试我们想要测试的东西的测试比根本没有测试更糟糕，因为薛定谔的测试会让人毫无根据地相信该特性是安全的。</p><p>  The change was peer reviewed and accepted during code review. (“LGTM!”)</p><p>在代码评审期间，该变更已被同行评审并接受。（“LGTM！”）</p><p> The change was then deployed to prod… only for it to fail upon first encounter with the user</p><p>然后将更改部署到prod…但在第一次遇到用户时，它就失败了</p><p> Upon revisiting the unit test it’s then noted that the unit test that gave such great confidence during the software development life cycle was in fact not testing the feature at all. If you encountered this problem then you encountered this class of unit tests which this specific TestCase.assertTrue is one of.</p><p>在重新审视单元测试时，我们注意到，在软件开发生命周期中给予如此大信心的单元测试实际上根本没有测试功能。如果您遇到了这个问题，那么您就遇到了这类单元测试，这些单元测试是针对这个特定的测试用例的。assertTrue是其中之一。</p><p>  While pytest is very popular, 28% of codebases  still use the built-in unittest package. The codebases that do use the built-in unittest package are at risk of the assertTrue gotcha:</p><p>虽然pytest非常流行，但28%的代码库仍然使用内置的unittest包。使用内置unittest包的代码库存在assertTrue gotcha的风险：</p><p>  The docs for  assertTrue state that  test that expr is True, but this is an incomplete explanation. Really it tests that the expr is  truthy, meaning if any of the following values are used in as the first argument the test will pass:</p><p>assertTrue的文档声明测试expr为真，但这是一个不完整的解释。实际上，它测试expr是否真实，这意味着如果将以下任何值用作第一个参数，测试将通过：</p><p>    assertTrue also accepts a second argument, which is the custom error message to show if the first argument is not truthy. This call signature allows the mistake to be made and the test to pass and therefore possibly fail silently.</p><p>assertTrue还接受第二个参数，这是显示第一个参数是否为truthy的自定义错误消息。这个调用签名允许犯错误，测试通过，因此可能会无声地失败。</p><p> For example when making 20 PRs fixing the problems we found one of the tests started to fail due to faulty application logic once the test was no longer a Schrödinger’s unit test:</p><p>例如，在制作20个PRs修复问题时，我们发现，一旦测试不再是薛定谔单元测试，其中一个测试由于应用程序逻辑错误而开始失败：</p><p>  We also found that at least two of the tests failed because the logic in the test was wrong. This is also bad if we consider unit tests to be a form of documentation describing how the product works. From a developer’s point of view, unit tests can be considered more trustworthy that comments and doc strings because comments and doc strings are  claims written (perhaps long ago and perhaps now obsolete or incomplete), while a passing unit test shows a logic  contract is being upheld…as long as the test is not a Schrödinger’s test!</p><p>我们还发现，至少有两个测试失败，因为测试中的逻辑是错误的。如果我们把单元测试看作是描述产品如何工作的一种文档形式，这也是不好的。从开发人员的角度来看，单元测试可以被认为比注释和文档字符串更可信，因为注释和文档字符串是编写的声明（可能很久以前，也可能现在已经过时或不完整），而通过的单元测试表明逻辑契约得到了维护……只要测试不是薛定谔测试！</p><p> Perhaps more data is needed, but this could mean 15% (3 in 20) of Schrödinger’s unit tests are hiding broken functionality.</p><p>也许需要更多的数据，但这可能意味着薛定谔的单元测试中有15%（20分之3）隐藏了损坏的功能。</p><p>  When the  CodeReview.doctor github bot detects this mistake in a GitHub pull request the following solution is suggested:</p><p>当代码审查时。doctor github bot在github pull请求中检测到此错误，建议使用以下解决方案：</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/python/">#python</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/代码/">#代码</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>