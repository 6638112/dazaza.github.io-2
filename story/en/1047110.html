<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>您真的不需要virtualenv You don't really need a virtualenv</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">You don't really need a virtualenv<br/>您真的不需要virtualenv </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-02-06 19:58:40</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/2/f9c6cb20cf612939c96e478cdd5e4a60.jpeg"><img src="http://img2.diglog.com/img/2021/2/f9c6cb20cf612939c96e478cdd5e4a60.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>When you develop a Python project, you need to install the project&#39;s dependencies. For a long time, tutorials and articles have told you to use a virtual environment to isolate the project&#39;s dependencies. This way you don&#39;t contaminate the working set of other projects, or the global interpreter, to avoid possible version conflicts. We usually have to do these things:</p><p>开发Python项目时，需要安装项目的依赖项。长期以来，教程和文章都告诉您使用虚拟环境来隔离项目的依赖关系。这样，您就不会污染其他项目的工作集或全局解释器，以避免可能的版本冲突。我们通常必须执行以下操作：</p><p> $ python3 -m venv venv  # make a virtualenv named `venv`$   venv/bin/activate  # activate the virtualenv (venv ) $ pip  install -r requirements.txt  # install the dependencies</p><p> $ python3 -m venv venv＃创建一个名为`venv`的virtualenv $ venv / bin / activate＃激活virtualenv（venv）$ pip install -r requirements.txt＃安装依赖项</p><p> There are also workflow tools that simplify this process, such as  Pipenv and  Poetry. They create virtual environments for you without perception and then install dependencies into them. They are used by a wide range of users. A virtual environment contains a Python interpreter and has the same directory structure as a normal installation so that it can be used as if it were a standalone Python installation.</p><p> 也有简化此过程的工作流工具，例如Pipenv和Poetry。他们为您创建了虚拟环境，而无需感知，然后将依赖项安装到其中。它们被广泛的用户使用。虚拟环境包含一个Python解释器，并且具有与普通安装相同的目录结构，因此可以像使用独立的Python安装一样使用它。</p><p>  Virtualenvs help us isolate project dependencies, but things get tricky when it comes to nested venvs: One installs the virtualenv manager(like Pipenv or Poetry) using a venv encapsulated Python, and creates more venvs using the tool which is based on an encapsulated Python. One day a minor release of Python is out and one has to check all those venvs and upgrade them if required before they can safely delete the out-dated Python version.</p><p>  Virtualenvs可以帮助我们隔离项目依赖关系，但是在嵌套venvs方面会变得棘手：使用venv封装的Python安装virtualenv管理器（例如Pipenv或Poetry），然后使用基于封装的Python的工具创建更多的venvs。有一天，一个较小的Python版本发布了，必须检查所有这些venv并根据需要对其进行升级，然后才能安全删除过时的Python版本。</p><p> Another scenario is global tools. There are many tools that are not tied to any specific virtualenv and are supposed to work with each of them. Examples are profiling tools and third-party REPLs. We also wish them to be installed in their own isolated environments. It&#39;s impossible to make them work with virtualenv, even if you have activated the virtualenv of the target project you want to work on because the tool is lying in its own virtualenv and it can only see the libraries installed in it. So we have to install the tool for each project.</p><p> 另一种情况是全局工具。有许多工具没有与任何特定的virtualenv绑定，而是应该与每个工具一起使用。示例包括分析工具和第三方REPL。我们也希望将它们安装在自己的隔离环境中。即使您已激活要处理的目标项目的virtualenv，也无法使其与virtualenv一起使用，因为该工具位于其自己的virtualenv中，并且只能看到其中安装的库。因此，我们必须为每个项目安装该工具。</p><p> I&#39;ve been maintaining the Pipenv project as a collaborator for the past two years and became a member of PyPA in early 2020. I am always thinking if the virtual environment is really a must-to-have for Python projects, just like  npm, it doesn&#39;t need a cloned  node binary, but just a  node_modules directory that is unique for each project.</p><p> 在过去的两年中，我一直以协作者的身份维持Pipenv项目，并在2020年初成为PyPA的成员。我一直在思考虚拟环境是否真的是Python项目必不可少的，就像npm，它不需要克隆的节点二进制文件，而只需要每个项目唯一的node_modules目录。</p><p>  The solution has been existing for a long time.  PEP 582 was originated in 2018 and is still a draft proposal till the time I wrote this article, but I found out it is exactly what  node_modules are in Python.</p><p>  该解决方案已经存在很长时间了。 PEP 582起源于2018年，直到我撰写本文时仍是一项提案草案，但我发现它正是Python中的node_modules。 </p><p>  .├── __pypackages__│ └── 3.8│ └── lib└── my_script.py</p><p>.├──__pypackages__│└──3.8│└──lib└──my_script.py</p><p> As specified in the PEP 582, if you run  python3.8 /path/to/my_script.py,  __pypackages__/3.8/lib will be added to  sys.path, and the libraries inside will become import-able in  my_script.py.</p><p> 如PEP 582中所指定，如果您运行python3.8 /path/to/my_script.py，则__pypackages __ / 3.8 / lib将被添加到sys.path，并且内部库将可在my_script.py中导入。</p><p> Now let&#39;s review the two problems I mentioned in the last section and see how they change with the power of PEP 582. For the first problem, the main cause is that the virtual environment is bound to a cloned Python interpreter on which the subsequent library searching based. It takes advantage of Python&#39;s existing mechanisms without any other complex changes but makes the entire virtual environment to become unavailable when the Python interpreter is stale. With the local packages directory, you don&#39;t have a Python interpreter any more, the library path is directly appended to  sys.path, so you can freely move and copy it.</p><p> 现在，让我们回顾一下我在上一节中提到的两个问题，并看看它们是如何随着PEP 582的功能而变化的。对于第一个问题，主要原因是虚拟环境绑定到了一个克隆的Python解释器上，后续基于库的搜索。它利用了Python现有的机制，没有进行任何其他复杂的更改，但是当Python解释器过时时，整个虚拟环境将变得不可用。使用本地软件包目录，您将不再拥有Python解释器，库路径直接附加到sys.path，因此您可以自由移动和复制它。</p><p> For the second, once again, you just call the tool against the project you want to analyze, and the  __pypackages__ sitting inside the project will be loaded automatically. This way you only need to keep one copy of the global tool and make it work with multiple projects.</p><p> 再次，您只需要针对要分析的项目调用该工具，位于项目内部的__pypackages__将自动加载。这样，您只需要保留一份全局工具的副本，并使其可用于多个项目。</p><p>  Starting from the PEP, I made  PDM, a new Python package manager and workflow tool that leverages PEP 582 to get rid of virtualenv entirely. It installs dependencies into the local package directory  __package__ and makes Python interpreters aware of it with  a very simple setup. It is not only an implementation of PEP 582 but also the only package manager that supports  PEP 621, a new metadata format based on  pyproject.toml which becomes the standard recently. It is foreseen that pip will also gradually support this format. Besides, PDM uses the same dependency resolver as pip and has a full-featured plugin system, allowing for community-contributed plugins to enhance the functionalities.</p><p>  从PEP开始，我制作了PDM，这是一个新的Python包管理器和工作流工具，它利用PEP 582完全摆脱了virtualenv。它将依赖项安装到本地包目录__package__中，并使Python解释器可以通过非常简单的设置来了解它。它不仅是PEP 582的实现，而且是唯一支持PEP 621的程序包管理器，PEP 621是基于pyproject.toml的新元数据格式，最近成为标准。可以预见，pip也将逐渐支持此格式。此外，PDM使用与pip相同的依赖项解析器，并具有功能齐全的插件系统，从而允许社区贡献的插件来增强功能。</p><p> In PDM, PEP 582 is not mandatory, you can also stick with virtualenv. PDM can detect  existing venvs but not create new ones.</p><p> 在PDM中，PEP 582不是必需的，您也可以坚持使用virtualenv。 PDM可以检测现有的静脉，但不能创建新的静脉。</p><p> Another thing that is noteworthy is its dependency resolution mechanism -- it tries to lock versions that are compatible with the  requires-python value of the project. Say your project requires Python 2.7 or 3.6 upper and you want to add  pytest as a development dependency, in Pipenv(ver.  2020.11.15) you have to pin  pytest = &#34;&lt;5&#34; manually in  Pipfile. And in Poetry(ver.  1.1.4) if you run  poetry add -D pytest you will get:</p><p> 值得注意的另一件事是其依赖关系解析机制-它试图锁定与项目的require-python值兼容的版本。假设您的项目需要使用Python 2.7或3.6更高版本，并且要添加pytest作为开发依赖项，在Pipenv（ver。2020.11.15）中，您必须固定pytest =＆＃34;＆lt; 5＆＃34;手动在Pipfile中。在诗歌（1.1.4版）中，如果您运行诗歌，请添加-D pytest，您将获得： </p><p> The current project&#39;s Python requirement  ( &gt; = 2.7, &lt; 3.0  ||  &gt; = 3.6, &lt; 4.0 ) is not compatible with some of the required packages Python requirement: - pytest requires Python  &gt; = 3.6, so it will not be satisfied  for Python  &gt; = 2.7, &lt; 3.0</p><p>当前项目的Python要求（＆gt; = 2.7，＆lt; 3.0 ||＆gt; = 3.6，＆lt; 4.0）与某些必需的Python软件包不兼容：-pytest需要Python＆gt; = 3.6，因此对于Python＆gt; = 2.7，＆lt; 3.0</p><p> Yes, it tells you to upgrade your Python requires version. However, in PDM, you can lock successfully:</p><p> 是的，它告诉您升级您的Python需要版本。但是，在PDM中，您可以成功锁定：</p><p> ❯ pdm  add -d pytestAdding packages to dev dependencies: pytest✔ 🔒 Lock successfulChanges are written to pdm.lock.Changes are written to pyproject.toml.Synchronizing working   with lock file:  11 to add,  0 to update,  0 to remove ✔ Install atomicwrites  1.4.0 successful ✔ Install colorama  0.4.4 successful ✔ Install packaging  20.8 successful ✔ Install more-itertools  5.0.0 successful ✔ Install pyparsing  2.4.7 successful ✔ Install attrs  20.3.0 successful ✔ Install pluggy  0.13.1 successful ✔ Install py  1.10.0 successful ✔ Install pytest  4.6.11 successful ✔ Install six  1.15.0 successful ✔ Install wcwidth  0.2.5 successful🎉 All complete !</p><p> ❯pdm add -d pytest将软件包添加到dev依赖项中：pytest✔🔒锁定成功将更改写入pdm.lock。将更改写入pyproject.toml。与锁定文件同步工作：添加11个，更新0个，删除0个✔安装atomicwrites 1.4.0成功✔安装colorama 0.4.4成功✔安装包装20.8成功✔安装more-itertools 5.0.0成功✔安装pyparsing 2.4.7成功✔安装attrs 20.3.0成功✔安装pluggy 0.13.1成功✔安装py 1.10.0成功✔安装pytest 4.6.11成功✔安装六个1.15.0成功✔安装wcwidth 0.2.5成功🎉全部完成！</p><p> As you can see,  pytest is pinned to  4.* that is compatible with Python 2.7 and Python 3.6+.</p><p> 如您所见，pytest固定到与Python 2.7和Python 3.6+兼容的4. *。</p><p>   You may have seen this  comic before, there are already so many package managers in Python&#39;s world, do we need a new one? No, I think. Gladly we have seen many improvements in the Python packaging ecosystem and the official installer pip, such as  PEP 517/ PEP 518, and the  new dependency resolver, more to come in the future. But before the day comes, why not try something different from the traditional, why not make something new that makes at least myself happy. If you think so, PDM should be an option, hopefully.</p><p>   您可能以前看过这部漫画，在Python世界中已经有这么多的软件包管理器，我们需要一个新的软件包管理器吗？不，我想。很高兴我们看到Python封装生态系统和官方安装程序pip有了很多改进，例如PEP 517 / PEP 518和新的依赖项解析器，这些在将来还会有更多改进。但是，在一天到来之前，为什么不尝试尝试不同于传统的尝试，为什么不尝试使自己至少感到高兴的新事物呢？如果您这样认为，希望可以选择PDM。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://frostming.com/2021/01-22/introducing-pdm/">https://frostming.com/2021/01-22/introducing-pdm/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/需要/">#需要</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/don/">#don</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/python/">#python</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>