<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>划船设备上的BTRF Btrfs on Zoned Block Devices</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Btrfs on Zoned Block Devices<br/>划船设备上的BTRF </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-22 11:49:22</div><div class="page_narrow text-break page_content"><p>The following subscription-only content has been made available to you by an LWN subscriber. Thousands of subscribers depend on LWN for the best news from the Linux and free software communities. If you enjoy this article, please consider  subscribing to LWN. Thank youfor visiting LWN.net!</p><p>LWN订阅者已为您提供以下订阅内容。成千上万的订阅者依赖LWN了解Linux和自由软件社区的最佳新闻。如果您喜欢本文，请考虑订阅LWN。感谢您访问lwn.net！</p><p> Zonedblock devices have some unfamiliar characteristics that result fromcompromises made in the name of higher storage density. They are dividedinto zones, some or all of which do not support random access for writeoperations. Instead, these &#34;sequential&#34; zones can only be written inorder, from the first block to the last. This constraint poses a newchallenge for filesystems, which are normally designed with the assumptionthat storage blocks can be written in any order. It is thus not surprisingthat zoned-device support in mainstream filesystems in Linux has been slowin coming; that is changing, though, with the  additionof support for zoned block devices to Btrfs in Linux 5.12.</p><p> ZonedBlock设备具有一些不熟悉的特征，从储存密度更高的名称中制作的umcompromises。它们是DividedInto区域，其中一些或所有这些都不支持Writeperations的随机访问。相反，这些＆＃34;顺序＆＃34;区域只能从第一个块写入最后一个块。此约束对文件系统构成了新核，通常使用假设设计，存储块可以按任何顺序写入。因此，Linux中主流文件系统中的Zoned-Device支持不是惊喜，这一直略微速度;但是，即在Linux 5.12中支持划分的块设备到BTRFS的增加。</p><p> The only way to overwrite data in a zoned drive&#39;s sequential zone is toreset the write pointer to the beginning of the zone, which immediatelyerases the entire content of that zone. On the other hand, random readaccess is fully supported. Many zoned devices also provide some&#34;conventional&#34; zones that support random read and write operations.Zoned devices were first seen in the form of  shingledmagnetic recording (SMR) drives; the kernel has low-level support forthese devices. Zoned devices using flash storage also exist; they tradeflexibility for reduced hardware complexity. These devices were added tothe NVMe standard in the form of  the Zoned Namespaces (ZNS)command set, which has been supported in Linux since the 5.9 release. Work has been going on for a number of years to support zoneddrives in Linux filesystems. Copy-on-write filesystems should beeasier to adapt, as they are designed to avoid overwriting datablocks. Among the existing Linux filesystems,  F2FS already supportszoned devices, and allows normal operations on such devices (butrequires that the drive provide at least one conventional zone). Inaddition, zonefs, a special filesystem for zoned devices,  was included in the 5.6 kernel.Using zonefs requires applications designed for thispurpose, as the filesystem does not support the creation of normal files.Some types of applications do fit the model well, however, for examplethose with log-structured data.</p><p> 覆盖分区驱动器中的数据的唯一方法是将写入指针Toreset ToreSet TORESET到区域的开头，它立即启动该区域的整个内容。另一方面，完全支持随机readaccess。许多分区设备还提供一些＆＃34;常规＆＃34;支持随机读写操作的区域。首先以ShingledMagic录制（SMR）驱动器形式看到的设备。内核具有低级别的支持。使用闪存存储的分区设备也存在;他们对减少硬件复杂性的交易性。这些设备以分区命名空间（ZNS）命令集的形式添加了Tothe NVME标准，它自5.9版本以来已经在Linux中支持。在Linux文件系统中支持Zoneddrives的多年来一直在发生工作。复制写入文件系统应该非常适应，因为它们旨在避免覆盖Datablocks。在现有的Linux文件系统中，F2FS已经支持的设备，并且允许在此类设备上进行正常操作（但是驱动器提供至少一个传统区域的驱动器）。 Inaddition，Zonefs，Zoned设备的特殊文件系统包含在5.6内核中.USING ZONEFS需要为此提供的应用程序，因为文件系统不支持创建正常文件。但是应用程序类型的应用程序确实适合模型，但是，用于使用日志结构数据的示例。</p><p> Support for zoned devices in more mainstream filesystems has also beenin progress in recent years. This is the case for Btrfs, which has seenthe support of zoned devices in the works since at least 2019, whenNoahiro Aota  presented thestatus of this work at the 2019 Linux Storage, Filesystem, andMemory-Management Summit. He has continued the work since, andfinally has seen the 15th revision merged into 5.12.</p><p> 近年来，在更多主流文件系统中对分区设备的支持也取得了进展。这是Btrfs的情况，它在自2019年以来，BTRFS支持的作品中的划分器件，当时Noahiro AOTA在2019年的Linux存储，文件系统，和管理峰会上呈现了这项工作的Thestatus。他开始工作以来，并最终已经看到第15次修订合并为5.12。</p><p>  Supporting zoned devices requires changes in the way the filesystemstructures are organized on disk, as it is often impossible tooverwrite existing data. One implication is that data structures that change over time must either be placed in a conventional zone or beimplemented in a way that does not require them to be in a single, fixed location. The only on-disk structure that had a fixed location in Btrfs wasthe superblock, which may have  upto two copies. In the case of zoned devices, an easy solutionwould be to require the availability of conventional zones for thesuperblock and its copies. However, the location of the second copy  fallsinto a sequential zone on many existing devices; in addition, deviceswith no conventional zones should also be supported. For those reasons,Aota implemented a log-based superblock using twozones as circular buffers to  protectagainst power failures. The filesystem writes the updated superblockssequentially to the first zone, and switches to the second one when thefirst one is full. It can then reset the first zone safely.</p><p>  支持分区设备需要更改文件系统结构在磁盘上组织的方式，因为它通常不可能覆盖现有数据。一种含义是，随着时间的推移而改变的数据结构必须放在传统区域中或以不需要它们处于单个固定位置的方式映衬。在BTRF中拥有固定位置的唯一磁盘结构是超级块，这可能有两个副本。在分区器件的情况下，易于解决方案应该需要用于Thsuperblock及其副本的传统区域的可用性。但是，第二副本Fallsinto在许多现有设备上的顺序区域;此外，还应支持任何不应支持传统区域的设备。出于这些原因，AOTA使用双倍实现基于日志的超块作为循环缓冲器，以保护AGST电源故障。文件系统将更新的SuperBlockS顺序写入第一个区域，并在填充文件时切换到第二个区域。然后它可以安全地重置第一区域。</p><p> Another structure that required changes was the tree log. Blocks for this log were allocated together with other types ofmetadata blocks; since the tree log is written at a different time thanother metadata, this approach would generate non-sequential writes. The solutionis to separate the tree-log blocks from the other metadata; then eachdata stream can be written separately and sequentially.</p><p> 需要更改的另一个结构是树日志。此日志的块与其他类型的MeteData块一起分配;由于树日志在不同的时间内写入Metadata，因此该方法将生成非顺序写入。解决方案将树木日志块与其他元数据分开;然后可以单独编写每个数据流并顺序写入。</p><p> At the lower level, other changes impact Btrfs chunks(also called block groups), which are a Btrfs data structure thatrepresents a range of data blocks on disk. In the case of zoned Btrfs,the default chunk size was changed so that it is aligned to the zone size.The allocation of blocks in a chunk also changes to meet the zoned-devicerequirements: it becomes sequential from the beginning of the chunk. If blocks are freed behind the allocation pointer, they will beignored by further allocations. As a result, blocks will be alwaysallocated sequentially. The zone of a specific chunk will be allowedfor reuse (reset) only when all blocks in the chunk are freed.</p><p> 在较低级别的情况下，其他更改影响BTRFS块（也称为块组），这是BTRFS数据结构，该数据结构在磁盘上进行一系列数据块。在分区BTRF的情况下，默认块大小被更改，以便它与区域大小对齐。块中的块分配也会更改以满足划分的区域：从块的开头变得顺序。如果块在分配指针背后被释放，则会通过进一步的分配估计。因此，块将始终按顺序扩展。只有在块中的所有块被释放时，将才能允许特定块的区域重用（重置）。 </p><p> In addition to the data-layout modifications, Btrfs willwrite to sequential zones using the &#34;zone append&#34; command (represented bythe  REQ_OP_ZONE_APPENDblock-device operation) on the underlying device instead of using a simplewrite. This command needs a zone to operate on, but does not require awrite pointer; it returns address of the written block. This means that theorder in which structures are writtendoes not matter and a block-group lock is not required; theperformance improvement reported by Aota in the cover letter is 36%for 4KB random writes.</p><p>除了数据布局修改之外，BTRFS WILLWRITE使用＆＃34的顺序区域;区域附加＆＃34;命令（由req_op_zone_appendblock-device操作）上的底层设备而不是使用SimpleWrite。此命令需要一个区域进行操作，但不需要摇摆符;它返回书面块的地址。这意味着，这是一种结构是写作的命令无关紧要，并且不需要块组锁定; 4KB随机写入的ATA在求职信中报告的性价比改进是36％。</p><p> With the patch set, Btrfs supports NVMe drives with the ZNSfunctionality natively, and the  sd driver provides emulationof the zoned command set for SAS and SATA hard drives.</p><p> 使用补丁集，BTRF本地支持使用ZnSF功能性的NVME驱动器，SD驱动程序为SAS和SATA硬盘驱动器提供ZONED命令集的仿真。</p><p>  The current zoned-device support shows a number of limitations and areasneeding further improvements. The high-level list appears in the  mergerequest for 5.12, and the complete one in the cover letter.</p><p>  目前的分区设备支持显示了许多限制和辐射进一步的改进。高级列表将显示在5.12的Mergerequest中，并在求职信中完成一个。</p><p> The first issue that users may face is that 5.12supports only the  single Btrfs  profile.That means no support for features like data duplication and RAID. Thedifficulty of supporting other profiles lies in the need to handle separatelogical addresses for the same data in different zones. The example Aotagives in the cover letter is the DUP profile (duplicating data). In this case, whenthe filesystem issues an append command, two zones may respond withdifferent offsets.</p><p> 用户可能面临的第一个问题是5.12Supports只有单个BTRFS配置文件。这意味着不支持数据复制和RAID等功能。支持其他简档的基因尤为需要处理不同区域中相同数据的分离地址。求职信中的示例Aotagives是DUP配置文件（重复数据）。在这种情况下，文件系统发出Append命令，两个区域可能会响应不同的偏移。</p><p> Administrators should be also aware that if a volume containsmultiple zoned disks, the zone sizes for all disks should be thesame.</p><p> 管理员也应该也意识到，如果卷包含多个分区磁盘，则所有磁盘的区域尺寸应该是Chesame。</p><p> The current   btrfs-progsrelease does not yet support zoned devices; a branch with that support canbe found in  Aota&#39;srepository.  I tested a zoned Btrfs filesystem alongside a non-zoned one, usingsame size partitions on a SATA drive. The zoned device was emulated.To create a zoned Btrfs filesystem, one needs to use Aota&#39;s version of mkfs.btrfs with the  -O zoned option, but also force data and metadatainto the &#34;single&#34; profile:</p><p> 目前的BTRFS-PROGSRELEASE尚不支持划定设备;一个与之支持的分支，在AOTA＆＃39; srepository。我在SATA驱动器上沿着非分区的一个划分的BTRFS文件系统测试了一个ZONED BTRFS文件系统。被仿真。要创建一个分区的BTRFS文件系统，需要使用AOTA＆＃39; s版本的mkfs.btrfs与-o zoned选项，还要强制数据和元adatainto the＆＃34;单＆＃34;轮廓：</p><p>  The two filesystems worked the same way for the most part.The performance was also roughly the same. Btrfs features likecreating snapshots also worked equally well on zoned and non-zoned devices.The only difference one could notice is higher space usage on the zonedfilesystem, as would be expected.  Zoned block devices behave differently than the traditional ones, sothere is no surprise that a filesystem requires layout changes to supportthose devices, and that the development took many months. For Btrfs, thebasic support is present now, so interested users may test it. This supporthas limitations, however, and we can expect that additional features willbe added in upcoming kernel versions.</p><p>  这两个文件系统最多的方式工作。性能也大致相同。 BTRFS功能利用类似的快照在分区和非分区设备上也同样运行。唯一的区别可能会注意到Zonedfilesystem上的空间使用率更高，如预期的那样。分区块设备的行为不同于传统的设备，因此Sothere毫不奇怪文件系统需要将布局更改为支持设备，并且开发花了很多月份。对于BTRF，现在存在TheBasic支持，因此感兴趣的用户可能会测试它。但是，此支持列表限制，我们可以期望在即将到来的内核版本中添加了附加功能。 </p><p>         ( Log in to post comments)</p><p>（ 登录后发表评论）</p><p>  &gt; Are files with the &#34;nocow&#34; attribute set supported?   To my understanding, `NOCOW` in btrfs is akin to a hint and is honored on a best-effort basis. For example, you can create snapshots of NOCOW files normally.</p><p>  ＆gt;是＆＃34; nocow＆＃34的文件;属性集支持？为了我的理解，“Nocow`”在BTRF中类似于暗示，并以尽力而为的基础。例如，您可以正常创建Nocow文件的快照。</p><p> The nocow attribute is sticky and is not a hint. That snapshotting of nocow files write works because first write to a nocow file on the new snapshot will do one time cow, the original file is unaffected.</p><p> Nocow属性是粘性的，不是一个提示。那个Nocow文件的快照编写有效，因为首先写入新快照上的Nocow文件将执行一次母牛，原始文件不受影响。</p><p> So, technically, `NOCOW` is violated that one time. OK, I assumed this principle expands to the rest of operations in btrfs.</p><p> 所以，技术上，“Nocow`被侵犯了一次。好的，我假设这个原则扩展到BTRF的其余操作。</p><p>  The flag means copying of a file should be done proactively and not on-demand, it doesn&#39;t preclude making copies outright. That would make it DRM (in the derogatory sense, not the graphics one).</p><p>  该标志意味着复制文件应该主动完成，而不是点击，它不会完全排除副本。这将使它成为DRM（在贬义的感觉中，而不是图形一个）。</p><p>  I would expect that btrfs to work more efficiently on a zone interface on flash/SMR than on a block interface that&#39;s then mapped by a FTL (or it&#39;s SMR equivalent) to zone-like hardware like flash and SMR HDDs. However, I guess that btrfs on ZNS emulated on a SATA block interface to whatever is below will eliminate any such advantage, so it&#39;s a good result for the patch that there is no slowdown from using it in that setting.</p><p>  我希望BTRF在Flash / SMR上的区域接口上更有效地工作，而不是在＆＃39; s的块接口上由FTL（或它＆＃39; s smr等效）映射到闪存和闪存等区域的硬件SMR HDD。但是，我猜，在SATA块接口上模拟的Zns上的BTRF可以消除任何此类优势，所以它＆＃39;＆＃39;修补程序在该设置中使用它没有放缓的良好结果。</p><p>   I&#39;ve found zone size &amp; count is often missing from the products&#39; datasheets, for reasons I can&#39;t comprehend.  It can be queried from the device, but of course you need one to do that.  The other reply to your comment is about right. For a source, please see Table 2 in this document:  https://www.researchgate.net/publication/317393826_Perfor...</p><p>   我发现区域大小和amp;数量往往缺少产品＆＃39;数据表，原因我可以＆＃39; t理解。它可以从设备查询，但当然您需要一个要做。其他回复您的评论是对正确的。对于源，请参见本文档中的表2：https：//www.researchgate.net/publication/317393826_perfor ... </p><p>  &#34;With the patch set, Btrfs supports NVMe drives with the ZNS functionality natively, and the sd driver provides emulation of the zoned command set for SAS and SATA hard drives.&#34;  Emulation? Not really, unless you are talking about zone append. SCSI (t10) has its own standard for how to talk to zoned devices called ZBC. Ditto for ATA (t13) called ZAC. Both those standards predate ZNS. Further NVMe&#39;s multiple queues don&#39;t guarantee write ordering which gives zoned storage a real (NVMe only) headache. So they (a big disk company) had to invent &#34;zone append&#34; in which you tell storage that you want to write data and at completion the storage device tells you where it was written. Best not to get a transport error on that completion.</p><p>＆＃34;使用补丁集，BTRFS本地支持使用ZNS功能的NVME驱动器，SD驱动程序提供用于SAS和SATA硬盘驱动器的分区命令集的仿真。＆＃34; 仿真？ 不是真的，除非你在谈论区域附录。 SCSI（T10）有自己的标准，用于如何与称为ZBC的划分设备交谈。 ata（t13）的同意多为zac。 这两种标准都是预测ZNS。 进一步的nvme＆＃39; s多个队列don＆＃39; t保证写字排序，它给出了划分存储一个真实的（仅限NVME）头痛。 所以他们（一个大磁盘公司）必须发明＆＃34; zone附录＆＃34; 在其中，您可以在其中告诉您想要编写数据的存储，并且完成存储设备会告诉您写入的位置。 最好不要在该完成时获得运输错误。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://lwn.net/SubscriberLink/853308/c386b5aab35db7b6/">https://lwn.net/SubscriberLink/853308/c386b5aab35db7b6/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/划船/">#划船</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/zoned/">#zoned</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/区域/">#区域</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>