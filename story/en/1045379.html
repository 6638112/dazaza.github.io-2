<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>将Firefox移植到Apple Silicon Porting Firefox to Apple Silicon</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Porting Firefox to Apple Silicon<br/>将Firefox移植到Apple Silicon </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-21 01:59:31</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/1/c4b536fc6f84bf3ac85d3350b1bbd857.png"><img src="http://img2.diglog.com/img/2021/1/c4b536fc6f84bf3ac85d3350b1bbd857.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>The release of Apple Silicon-based Macs at the end of last year generated a flurry of news coverage and some surprises at the machine’s performance. This post details some background information on the experience of porting Firefox to run natively on these CPUs.</p><p>去年年底发布的基于Apple Silicon的Macs引起了一连串的新闻报道，并对该机器的性能产生了一些惊喜。这篇文章详细介绍了一些有关将Firefox移植为在这些CPU上本机运行的经验的背景信息。</p><p> We’ll start with some background on the Mac transition and give an overview of Firefox internals that needed to know about the new architecture, before moving on to the concept of Universal Binaries.</p><p> 我们将从Mac过渡的背景知识入手，并在继续介绍Universal Binaries概念之前，概述需要了解新架构的Firefox内部组件。</p><p> We’ll then explain how DRM/EME works on the new platform, talk about our experience with macOS Big Sur, and discuss various updater problems we had to deal with. We’ll conclude with the release and an overview of various other improvements that are in the pipeline.</p><p> 然后，我们将说明DRM / EME如何在新平台上工作，谈论我们在macOS Big Sur上的经验，并讨论我们必须处理的各种更新程序问题。我们将以该发行版结束，并对即将进行的其他各种改进进行概述。</p><p>  Speculation that Apple would switch its Mac lineup to use ARM CPUs had been ongoing in the industry for several years. As early as 2013,   Apple had referred to the custom ARM chips they were putting in the iPhone as “desktop-class” designs .</p><p>  业界一直在猜测苹果将其Mac产品线改为使用ARM CPU。早在2013年，苹果就将他们在iPhone中放入的定制ARM芯片称为“桌面级”设计。</p><p> While the claim initially met some scepticism, near the end of 2018 computer hardware magazine AnandTech published the results of running the   industry-standard SPEC benchmark on the iPhone XS , showing that even workloads that reflect real-world desktop use cases reached desktop chip performance, and were doing so at significantly better power efficiency.  This provided us with some warning that Apple might be ready to start the transition to the ARM architecture in the near future.</p><p> 尽管这一说法最初引起了一些怀疑，但在2018年底，计算机硬件杂志AnandTech公布了在iPhone XS上运行行业标准SPEC基准测试的结果，表明即使反映现实桌面用例的工作负载也达到了桌面芯片性能，并且这样做可以显着提高电源效率。这给了我们一些警告，苹果可能准备在不久的将来开始向ARM体系结构过渡。</p><p> From the perspective of Mozillla’s platform team, an area of particular interest for such an architecture change on macOS is Firefox’s use of macOS APIs. Firefox and Gecko’s roots go back to the Netscape codebase, which already supported the Mac as it was in 1994.</p><p> 从Mozillla的平台团队的角度来看，在macOS上进行这种架构更改的一个特别令人感兴趣的领域是Firefox对macOS API的使用。 Firefox和Gecko的起源可以追溯到Netscape代码库，该库在1994年就已经支持Mac。</p><p> Although continuously updated, Firefox still uses a wide range of macOS APIs that followed the Mac’s evolution over the years (Carbon, Cocoa, HIITheme, Quartz, …).</p><p> 尽管不断更新，但Firefox仍使用多种macOS API，以跟随Mac多年来的发展（Carbon，Cocoa，HIITheme，Quartz等）。 </p><p> Apple has generally kept them — the code is there and working, after all — and has even added compatibility shims in some places where behavior has changed. But they’re not willing to keep compatibility forever, and in fact had removed 32-bit support in the previous macOS Catalina which had an impact on applications that were relying on this, among them many games.</p><p>苹果公司通常会保留它们-毕竟代码已经存在并且可以正常工作-甚至在行为发生变化的某些地方甚至增加了兼容性垫片。但是他们不愿永远保持兼容性，事实上，它们已经取消了先前的macOS Catalina中的32位支持，这对依赖此功能的应用程序（包括许多游戏）产生了影响。</p><p> As such, we were concerned that not all APIs would still be supported on the new architecture and we’d have to go in and rewrite some amount of widget, toolkit or theming code in short order.</p><p> 因此，我们担心并不是所有API仍会在新架构上受支持，因此我们不得不进入并在短时间内重写一些小部件，工具箱或主题代码。</p><p> Based on the performance from the aforementioned benchmarks and Apple’s historical release schedule, the platform team estimated in March that “macOS 10.16” was likely to appear around September or October 2020 and that there was a significant risk it could involve API changes in order to add ARM support, which we took into account in our planning.</p><p> 根据上述基准的性能和苹果的历史发布时间表，平台团队在3月份估计“ macOS 10.16”可能会在2020年9月或2020年10月左右出现，并且存在很大的风险，可能需要更改API才能添加在计划中已考虑到ARM支持。</p><p>  On the 22nd of June 2020, Apple confirmed it would begin moving its Mac hardware to their own ARM chips – referred to as Apple Silicon. They also confirmed that the machines would ship with an Intel x64 emulator (Rosetta 2) and would support iOS apps.</p><p>  2020年6月22日，苹果公司确认将开始将其Mac硬件转移到他们自己的ARM芯片（称为Apple Silicon）上。他们还确认，这些机器将配备Intel x64仿真器（Rosetta 2）并支持iOS应用。</p><p> The latter led to some guessing within Mozilla’s platform team as to whether the new Macs would have a touchscreen. While we were — and still are — quite ready to support it, at least the eventual first Apple Silicon-based Macs didn’t end up having one.</p><p> 后者导致Mozilla的平台团队对新型Mac是否具有触摸屏产生了猜测。尽管我们曾经（现在仍然）准备好支持它，但至少最终第一批基于Apple Silicon的Mac最终并没有使用它。</p><p> Together with the announcement of the transition, Apple also announced the availability of Developer Transition Kits (DTK),   essentially containing the iPad Pro’s chip in a Mac Mini housing . What Apple didn’t share was when exactly the final machines were coming to market.</p><p> 在宣布过渡的同时，苹果还宣布了开发人员过渡套件（DTK）的推出，该套件实质上是在Mac Mini外壳中包含iPad Pro的芯片。苹果公司没有分享的是确切的最终机器何时上市。</p><p> Based on the timing of the DTK availability and Apple’s hint that it would be “by the end of the year”, we guessed this was likely to be somewhat before the Christmas holidays.</p><p> 根据DTK上市的时间以及苹果暗示它将在“到今年年底”的暗示，我们猜测这可能是圣诞节假期之前的事。 </p><p> Looking back, we noticed that Apple has very consistently been able to make hardware available near immediately after announcing it, so we figured that any next planned announcement should be taken as a release date.</p><p>回顾过去，我们注意到Apple始终能够在宣布硬件后立即提供可用的硬件，因此我们认为下一次计划发布的日期都应视为发布日期。</p><p> When another announcement was planned for November 10th – about a month before our original estimate – we took it as the shipping date. And indeed, Apple did end up shipping the first hardware one week later on November 17th.</p><p> 当计划于11月10日（比我们的最初估计要早一个月）发布新公告时，我们将其作为发货日期。确实，苹果确实在一周后的11月17日交付了第一批硬件。</p><p>  Of all the work needed to support the new hardware, porting Firefox to the 64-bit ARM architecture was not actually something we needed to do: we’ve supported 64-bit ARM on Android and Linux for years.</p><p>  在支持新硬件所需的所有工作中，将Firefox移植到64位ARM架构实际上并不是我们要做的事情：多年来，我们在Android和Linux上都支持64位ARM。</p><p> We refrained from publishing the 64-bit Android builds until late 2019 because before that point our JavaScript JIT was not fully optimized for 64-bit ARM, and the resulting 64-bit version would have been slower than the 32-bit one.</p><p> 我们避免在2019年末之前发布64位Android版本，因为在此之前，我们的JavaScript JIT尚未针对64位ARM进行完全优化，因此生成的64位版本将比32位版本慢。</p><p> There wasn’t much demand for the browser to be able to use over 4GB of memory on phones either! In 2019,   we released the first Firefox version for Windows on 64 bit ARM  which gave us some additional experience in exactly the kind of effort we were facing now.</p><p> 浏览器也不需要能够在手机上使用超过4GB的内存！在2019年，我们发布了第一个适用于Windows的64位ARM版本的Firefox版本，这为我们提供了一些额外的经验，这正是我们现在面临的努力。</p><p> While Windows on ARM hardware has failed to catch on with our users so far,  expectations were for the Apple transition to be very different. Not only was there a good reason to expect hardware performance to be groundbreaking as explained in the first section.</p><p> 到目前为止，尽管Windows on ARM硬件未能赶上我们的用户，但人们对Apple过渡的期望却大不相同。正如第一部分所述，不仅有充分理由期望硬件性能具有突破性。</p><p> Apple made it clear they were switching their entire lineup and not releasing a single device as a “feeler”. To top it off, they had a proven track record of successful architecture transitions on the Mac.</p><p> 苹果公司明确表示，他们将更换整个产品线，而不是发布单个设备作为“感觉”。最重要的是，他们在Mac上成功进行架构转换方面有着良好的记录。 </p><p> So with 64-bit ARM support already in the codebase, the first pass of work was to go through all the Firefox code, dependencies, and various third-party build systems to see if they correctly dealt with the novel idea that a Mac could have an ARM chip inside.</p><p>因此，在代码库中已经有64位ARM支持的情况下，第一步工作是遍历所有Firefox代码，依赖项和各种第三方构建系统，以查看它们是否正确处理了Mac可能具有的新颖思想。内部装有ARM芯片。</p><p> Secondly, we needed to adapt and fix the various parts of the Firefox codebase that deal with low-level calling conventions and particularly the interfaces between the JavaScript and C++ (and nowadays Rust) parts of the code.</p><p> 其次，我们需要适应和修复Firefox代码库中处理低级调用约定的各个部分，尤其是JavaScript和C ++（以及现在的Rust）部分之间的接口。</p><p> Rust in particular was a concern. Firefox depends on Rust code, and we require a working Rust compiler to build the browser. Although   Apple Silicon support for Rust was underway , it took until mid-August for there to be functional compiler builds, which limited the amount of progress possible for Firefox.</p><p> 尤其是防锈。 Firefox依赖于Rust代码，我们需要一个可运行的Rust编译器来构建浏览器。尽管Apple Silicon对Rust的支持正在进行中，但直到8月中旬才有了功能编译器的构建，这限制了Firefox可能取得的进展。</p><p> Once the compiler was working, a similar exercise needed to be done with all the Rust crates we depend on. The need to update the compiler and the reliance of some crates on the exact compiler version, especially parts dealing with SIMD support, would end up biting us later on as it made it hard to push Apple Silicon support forward to an earlier release of Firefox without potentially affecting other platforms.</p><p> 一旦编译器开始工作，就需要对我们依赖的所有Rust板条箱进行类似的练习。需要更新编译器以及依赖某些板条箱依赖确切的编译器版本，尤其是涉及SIMD支持的部件，最终会在以后困扰我们，因为这很难将Apple Silicon支持向前推到早期版本的Firefox，而没有可能影响其他平台。</p><p>  An important decision to be made was whether to produce separate builds for Intel- and ARM-based Macs, or to generate   Universal Binaries  which bundle both builds and select the correct version at runtime. Producing Universal Binaries is a bit more complicated, but we had existing tooling in place dating back to the time when Apple supported both 32-bit and 64-bit binaries, which could be adapted.</p><p>  一个重要的决定是要为基于Intel和ARM的Mac生产单独的版本，还是要生成将两个版本捆绑在一起并在运行时选择正确版本的Universal Binaries。制作通用二进制文件稍微复杂一些，但是我们可以使用现有的工具，其历史可以追溯到Apple支持32位和64位二进制文​​件（可以进行修改）的时间。</p><p> It greatly simplifies things for the user — there is no risk of downloading the wrong version — and also meant that our download pages and some infrastructure like localization could remain unchanged.</p><p> 它极大地简化了用户的工作-没有下载错误版本的风险-并意味着我们的下载页面和某些本地化等基础架构可以保持不变。</p><p> The main downside is the installer significantly increasing in size, not just for ARM users but also for Intel ones. As this only affects the initial install, and users typically receive new versions through updates that are much smaller, we felt that this was an acceptable downside and proceeded along this route.</p><p> 主要缺点是安装程序的大小显着增加，不仅对于ARM用户而且对于Intel用户而言。由于这只会影响初始安装，并且用户通常会通过小得多的更新获得新版本，因此我们认为这是可以接受的缺点，因此可以按照此方法进行操作。 </p><p>  While we can port the open-source parts of Firefox to 64-bit ARM ourselves, Netflix and some other video streaming services such as Hulu, Disney+, or Amazon Prime require their video to be decoded with closed source, proprietary DRM software.</p><p>虽然我们可以将Firefox的开源部分自己移植到64位ARM，但Netflix和其他一些视频流服务（例如Hulu，Disney +或Amazon Prime）要求使用封闭源，专有DRM软件对视频进行解码。</p><p> If the user visits such a site,   Firefox will automatically download and install such a proprietary EME/CDM module . This presented a problem to us as we would be dependent on those third-party vendors to publish ARM64 versions of those decoders.</p><p> 如果用户访问了这样的站点，Firefox将自动下载并安装这样的专有EME / CDM模块。这给我们带来了一个问题，因为我们将依赖那些第三方供应商来发布这些解码器的ARM64版本。</p><p> We did not manage to get a commitment to a release date for such updates, and even if we did, there was no guarantee that they would be before the unknown release date of the Apple Silicon hardware.  As a significant number of our users use the browser to watch video online, this presented a potential showstopper for a native Apple Silicon release.</p><p> 我们没有承诺此类更新的发布日期，即使我们这样做，也无法保证它们会在Apple Silicon硬件的未知发布日期之前。随着大量用户使用浏览器在线观看视频，这为本地Apple Silicon版本提供了潜在的突破。</p><p> We ended up leveraging a technique that we are also using for the Windows on ARM version of Firefox. The DRM video decoder already executes in a separate process so we can sandbox the proprietary code from the user’s system.</p><p> 我们最终利用了一种技术，该技术也用于ARM版本的Firefox上的Windows。 DRM视频解码器已经在单独的过程中执行，因此我们可以将用户系统中的专有代码沙盒化。</p><p> If we force this decoding process to run under emulation, we would be able to use the existing Intel x64 decoder modules and have them communicate with the main browser that was running natively.</p><p> 如果我们强制该解码过程在仿真下运行，我们将能够使用现有的Intel x64解码器模块并使它们与本机运行的主浏览器进行通信。</p><p> There were a few catches to getting this to work: because the process that loads the Google Widevine DRM module itself depends on some runtime libraries, we needed Intel x64 copies of those as well.</p><p> 要使它起作用，有一些陷阱：因为加载Google Widevine DRM模块本身的过程取决于某些运行时库，所以我们也需要这些库的Intel x64副本。</p><p> Luckily, due to the Universal Binary containing both versions of Firefox, we were able to pick them up directly from the Application Bundle.</p><p> 幸运的是，由于通用二进制文件包含两个版本的Firefox，我们能够直接从应用程序捆绑包中将其提取。 </p><p> Secondly, Apple did not actually ship their Rosetta 2 emulator preinstalled on the Apple Silicon machines but its installation is triggered when the user tries to run an Intel application.</p><p>其次，Apple实际上并未将其预装的Rosetta 2仿真器交付到Apple Silicon计算机上，但当用户尝试运行Intel应用程序时会触发其安装。</p><p> So while it is very likely in practice that Rosetta is installed on the user’s system, we could not rely on this always being the case. Triggering the installation of Rosetta programmatically works, but   some of our colleagues found out the hard way it is not very reliable , so we backed off on doing this in our first release and fell back to   referring people that hit the relevant error to a support article .</p><p> 因此，尽管实际上很可能在用户的系统上安装了Rosetta，但我们不能总是这样。触发Rosetta的安装以编程方式起作用，但是我们的一些同事发现很难做到这一点，因此我们在第一个发行版中放弃了这样做，而是转而将遇到相关错误的人员推荐给支持文章。 。</p><p>  The macOS Big Sur betas arrived independently of the Apple Silicon hardware and allowed us to get an early look at the compatibility story. To our relief, no APIs we depended on were deprecated and any backwards compatibility problems or missing shims were limited to small cosmetic issues, which we   typically managed to fix quickly .   Other open-source projects with a similarly old codebase were not as lucky .</p><p>  macOS Big Sur Betas独立于Apple Silicon硬件而来，使我们能够更早地了解兼容性故事。令我们欣慰的是，我们不弃用我们所依赖的API，任何向后兼容性问题或缺少垫片都限于小型外观问题，而这些问题通常我们可以很快解决。其他具有类似旧代码库的开源项目并不那么幸运。</p><p> Bumping the version numbers from 10.x to 11.0 – somewhat predictably – produced errors   both in our code  and in   external websites relying on UA sniffing , despite Apple’s attempts to mitigate the problem by returning the old version number in apps built with older SDKs.</p><p> 尽管Apple尝试通过在使用旧版SDK构建的应用中返回旧版本号来缓解该问题，但将版本号从10.x升至11.0（某种程度上可以预测）在我们的代码和依赖UA嗅探的外部网站中均产生了错误。</p><p>  Pushing the updated Firefox application bundle to users – which was now a Universal Binary supporting both types of Apple hardware, instead of only Intel x64 as before – revealed some further complications.</p><p>  将更新的Firefox应用程序包推送给用户-现在是支持两种类型的Apple硬件的通用二进制文件，而不是以前的仅Intel x64-显示出更多的复杂性。</p><p> During an update, after updating the files on disk, Firefox will relaunch the updated version of itself. Any application on Apple Silicon that is running under Intel x64 emulation and launches another process will also cause that process to be launched under emulation.</p><p> 在更新过程中，更新磁盘上的文件后，Firefox将重新启动其自身的更新版本。 Apple Silicon上任何在Intel x64仿真下运行并启动另一个进程的应用程序也会导致该进程在仿真下启动。</p><p> So when the old Firefox 83 – running under emulation – launches the new Firefox 84 with native support, it would not launch the new native binary but end up forcing it to be run under emulation as well, at least until the application was fully restarted.</p><p> 因此，当在仿真下运行的旧版Firefox 83启动具有本机支持的新Firefox 84时，它将不会启动新的本机二进制文件，但最终也迫使其也在仿真下运行，至少直到应用程序完全重新启动为止。 </p><p> While we   developed a workaround  for this, we didn’t feel it was sufficiently tested by the release date for the marginal benefit it gave and ended up simply   adding a release note to cover this case .</p><p>尽管我们为此开发了一种变通方法，但我们认为发布日期之前并未对其进行足够的边际收益测试，最终只是添加了发行说明来解决此问题。</p><p> More of a concern was user reports that some antivirus software was flagging all our Universal Binaries as malware, and corrupting the Firefox installation the moment the update arrived.</p><p> 更令人担忧的是，用户报告说某些防病毒软件将我们的所有Universal Binaries标记为恶意软件，并在更新到来时破坏了Firefox的安装。</p><p> The software was using machine learning techniques and presumably observed that our combined Universal Binaries didn’t quite look like any other legitimate software it had ever seen before.</p><p> 该软件正在使用机器学习技术，并且大概观察到我们组合的Universal Binaries看起来与以前从未见过的其他合法软件完全不同。</p><p> Attempts to contact the vendor through regular support channels were unsuccessful so we ended up searching LinkedIn and managed to find an engineer working on the core antivirus detection.</p><p> 通过常规支持渠道与供应商联系的尝试均未成功，因此我们最终搜索了LinkedIn，并设法找到了负责核心防病毒检测的工程师。</p><p> They immediately understood the seriousness of the problem and took prompt action to get a fix shipped, thus preventing quite the disaster for the users of this product. It’s notable that without this last-ditch effort we would have been effectively blocked from releasing a native Apple Silicon version for an indefinite period.</p><p> 他们立即了解了问题的严重性，并采取了迅速的措施来提供修复程序，从而为该产品的用户避免了灾难。值得注意的是，如果没有最后的努力，我们将被无限期地禁止发行本地Apple Silicon版本。</p><p> This wouldn’t be the first time that   browser makers are exasperated  at the   misaligned incentives for anti-virus vendors  when anti-virus software and browsers   don’t get along .</p><p> 当防病毒软件和浏览器不相处时，这并不是浏览器制造商第一次对反病毒供应商的激励动机不满感到愤怒。</p><p>  Comparing the Firefox release schedule with the predicted release date from Apple meant that our Firefox 83 – scheduled for November 17th – aligned with the availability of release hardware.</p><p>  将Firefox的发布时间表与Apple的预计发布日期进行比较，意味着我们的Firefox 83（计划于11月17日发布）与发布硬件的可用性保持一致。 </p><p> While it would have been nice to announce native support in the stable version as soon as the first production machines arrived to customers, this would also have meant that it would be completely untested on the real hardware.</p><p>最好在第一批生产机器到达客户后就宣布稳定版本的本机支持，但这也意味着它将在真实硬件上完全未经测试。</p><p> We decided to be conservative here and keep our initial support to the Firefox 84 beta, which was released the same day as Firefox 83, giving both us and our users a window of time to evaluate the stability of the product on the actual Apple Silicon hardware.</p><p> 我们决定在这里保持保守，并保持对Firefox 84 beta（与Firefox 83当天发布）的最初支持，这给我们和用户提供了时间来评估产品在实际Apple Silicon硬件上的稳定性。 。</p><p> Though somewhat disappointed that after being one of the first to   announce native support in Nightly  we ended up delaying a stable release slightly, the difficulties experienced by other browser vendors with shipping a working version supported our decision. Firefox with native Apple Silicon support went into the wider world when 84 beta rolled into the Firefox 84 release, on December 15th, 2020.</p><p> 尽管有些失望，因为它是Nightly中第一个宣布本机支持的人，但最终还是稍微延迟了稳定版本，但其他浏览器供应商在交付有效版本时遇到的困难支持了我们的决定。 2020年12月15日，当84 beta发布到Firefox 84版本中时，具有本地Apple Silicon支持的Firefox进入了更广阔的世界。</p><p> While most benchmarking of Apple Silicon indicated that the performance impact of Rosetta emulation was typically low and that   applications could be expected to run at about 70-80% of native performance , we saw much larger gains when testing the native Firefox build, including doubled performance on some key benchmarks and a spectacular 2.5 times faster startup.</p><p> 尽管大多数Apple Silicon基准测试表明，Rosetta仿真对性能的影响通常很小，并且可以预期应用程序以本机性能的70-80％运行，但是在测试本机Firefox版本时，我们看到了更大的收益，包括性能翻倍在某些关键基准上，启动速度惊人地提高了2.5倍。</p><p> One reasonable explanation for this faster startup could be that many parts of Firefox itself are written in the web’s own languages – JavaScript, CSS, and HTML – and thus use a JavaScript JIT for much of its own functionality.</p><p> 这种更快启动的合理解释可能是Firefox本身的许多部分都是用网络自己的语言（JavaScript，CSS和HTML）编写的，因此将JavaScript JIT用于其自身的许多功能。</p><p> On startup, the JIT has to translate the JavaScript to machine code and while this is typically a very fast operation when running under emulation Rosetta has to then translate this JIT-generated machine code to machine code for another architecture.</p><p> 启动时，JIT必须将JavaScript转换为机器代码，而在仿真下运行时，这通常是非常快速的操作，Rosetta则必须将此JIT生成的机器代码转换为另一体系结构的机器代码。</p><p> Apple   introduced a translation cache  that likely removes this overhead completely for most applications but it does not work for code that is output by a JIT. With the native build, this second translation is avoided completely and we’re back to having a snappy browser.</p><p> 苹果公司推出了一个翻译缓存，它可能会为大多数应用程序完全消除这种开销，但不适用于JIT输出的代码。使用本机版本，完全避免了第二种翻译，我们回到了一个快速的浏览器。 </p><p>  With the initial release out, there are a number of further improvements that we can and will make to the Apple Silicon version, some of which will already be available in Firefox 85.</p><p>随着最初的发布，我们可以并且将对Apple Silicon版本进行许多进一步的改进，其中一些将已经在Firefox 85中提供。</p><p> First of all, we had to disable   WebRender  in the initial version because it triggered graphics driver bugs in the first Big Sur releases for Apple Silicon. Now that these have been addressed and we’ve validated WebRender on the final hardware,   we have re-enabled it  and it will ship in 85.</p><p> 首先，我们必须在初始版本中禁用WebRender，因为它在Apple Silicon的第一个Big Sur版本中触发了图形驱动程序错误。现在，这些问题已经解决，并且我们已经在最终的硬件上验证了WebRender，我们已经重新启用它，它将在85个版本中发布。</p><p> Secondly, Firefox currently uses the   baseline compiler for WebAssembly on 64-bit ARM . There is a   faster optimizing compiler called Cranelift   available for testing on Firefox Nightly , and in a few weeks, we expect to finish the 64-bit ARM port of our own optimizing compiler, Ion,   which is likely to become the new default .</p><p> 其次，Firefox当前在64位ARM上将基线编译器用于WebAssembly。有一个名为Cranelift的更快的优化编译器可在Firefox Nightly上进行测试，并且在几周之内，我们预计将完成我们自己的优化编译器Ion的64位ARM端口，这很可能会成为新的默认编译器。</p><p> The Apple Silicon chips are one of the first desktop chips that are a heterogeneous design with distinct performance and efficiency cores. We’re   revising much of our core threading  and thread pooling architecture to   handle the distinction better , improve efficiency, and eventually be   able to schedule less performance-critical tasks on the efficiency cores .</p><p> Apple Silicon芯片是首批采用异构设计并具有独特性能和效率核心的台式机芯片之一。我们正在对大部分核心线程和线程池体系结构进行修订，以更好地处理区别，提高效率，并最终能够在效率内核上安排对性能要求不高的任务。</p><p> Finally, we’re cleaning up and modernizing our usage of legacy macOS drawing APIs, and in some cases,   removing our custom drawing code entirely . This is expected to help with some of the   outstanding glitches in dark mode support , as   the legacy macOS APIs simply don’t support it  and the   color values must be obtained via newer APIs . It will also remove some of our deprecation worries!</p><p> 最后，我们要清理和更新旧版macOS绘图API的用法，并在某些情况下完全删除自定义绘图代码。预期这将有助于解决暗模式支持中的一些突出问题，因为传统的macOS API根本不支持它，并且必须通过更新的API获取颜色值。这也将消除我们对折旧的担心！</p><p> We hope you enjoyed this inside view of how the Firefox team experienced the Apple Silicon transition and we’re looking forward to pushing the Firefox experience on macOS to even higher levels in the year to come.</p><p> 我们希望您喜欢Firefox团队如何经历Apple Silicon过渡的内在看法，并且我们希望在来年将macOS上的Firefox体验推向更高的水平。</p><p>  Thanks to Mike Hommey and Haik Aftandilian for their substantial input to this post. They also did a lot of the engineering work described here. Further editorial suggestions were provided by Andrew Overholt, Sylvestre Ledru, and Selena Deckelmann.</p><p>  感谢Mike Hommey和Haik Aftandilian对这个职位的大量投入。他们还完成了此处描述的许多工程工作。 Andrew Overholt，Sylvestre Ledru和Selena Deckelmann提供了进一步的编辑建议。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://hacks.mozilla.org/2021/01/porting-firefox-to-apple-silicon/">https://hacks.mozilla.org/2021/01/porting-firefox-to-apple-silicon/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/移植/">#移植</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>