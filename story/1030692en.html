<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>使用WireGuard和OpenBSD安全地传输智能手机流量</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">使用WireGuard和OpenBSD安全地传输智能手机流量</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-23 06:39:04</div><div class="page_narrow text-break page_content"><p>Learn how to securely tunnel smart phone trafficover a  WireGuard VPN with an OpenBSD 6.8 endpoint using the newlyreleased in-kernel  wg(4)driver with only base utilities.</p><p>了解如何使用仅包含基本实用程序的新发布的内核内WG(4)驱动程序，在具有OpenBSD 6.8端点的WireGuard VPN上安全地传输智能手机流量。</p><p>   When you browse the internet, check emails, use social media, etc. onyour laptop or smart phone, the traffic must go from your device, throughthe local network, then through the wider internet until it ultimatelyreaches the destination server. Whoever runs the local Wi-Fi or cellnetwork can see what websites you visit, and if the connection to thewebsite is not encrypted, exactly what you are sending and receivingfrom the site. Further, if the Wi-Fi network is not encrypted (an openinsecure network with no password), then any user on the network canalso read your traffic!</p><p>当您在笔记本电脑或智能手机上浏览互联网、查看电子邮件、使用社交媒体等时，流量必须从您的设备通过本地网络，然后通过更广泛的互联网，直到最终到达目的地服务器。无论谁运行本地Wi-Fi或手机网络，都可以看到您访问的网站，如果网站连接未加密，您从该网站发送和接收的确切内容。此外，如果Wi-Fi网络未加密(没有密码的开放式不安全网络)，则网络上的任何用户也可以读取您的流量！</p><p> One way to keep your browsing and activity private and securedfrom the people on the local network is to tunnel it through anencrypted Virtual Private Network (VPN). I commonly do this whenusing public Wi-Fi at airports, libraries, restaurants, etc. tosecure my internet traffic from potential eavesdroppers. Ways toobtain a VPN include buying one from a commercial VPN provider, butthis shifts the issue of who can look at your traffic from peopleon the Wi-Fi to this provider. Instead, I setup my own VPN (using WireGuard) on a virtual private server(VPS) that I own on  Vultr that runs on OpenBSD, my favorite operating system.</p><p>保护您的浏览和活动不被本地网络上的人访问和保护的一种方法是通过加密的虚拟专用网络(VPN)进行隧道传输。当我在机场、图书馆、餐馆等使用公共Wi-Fi来保护我的互联网流量不被潜在窃听者窃听时，我通常会这样做。获得VPN的方法包括从商业VPN提供商那里购买一个，但这将谁可以查看您的流量的问题从Wi-Fi上的人转移到了这家提供商。相反，我将自己的VPN(使用WireGuard)设置在我在Vultr上拥有的虚拟专用服务器(VPS)上，该服务器运行在我最喜欢的操作系统OpenBSD上。</p><p>  WireGuard is becoming the go-to softwareto create a VPN. Compared to common alternatives (OpenVPN, IPsec) itis simpler, faster, and uses modern cryptography (making it arguablymore secure). OpenBSD has had user-land support for WireGuard using WireGuard-go. OpenBSD 6.8was released today (2020-10-18) and now includes an in-kernel WireGuardimplementation  wg(4). Beingin-kernel, this implementation is faster. It also means we can skipusing extra software and use base-only utilities for simple, easyconfiguration.</p><p>WireGuard正在成为创建VPN的首选软件。与常见的替代方案(OpenVPN、IPsec)相比，它更简单、更快，并且使用现代加密技术(可以说它更安全)。OpenBSD已经使用WireGuard-Go为WireGuard提供了用户端支持。OpenBSD6.8于今天(2020-10-18)发布，现在包括内核内的WireGuardimplementation WG(4)。作为内核中的一员，这种实现速度更快。这也意味着我们可以跳过额外的软件，使用仅限基础的实用程序来实现简单、容易的配置。</p><p>  Your smart phone will enable the VPN through one-click on the WireGuardapp. All traffic on your phone will then go over an encrypted tunnel tothe OpenBSD endpoint server, after which, it will route to the rest ofthe internet. This will protect your traffic from anyone snooping on theWi-Fi or cell network.</p><p>您的智能手机将通过单击WireGuardapp启用VPN。然后，您手机上的所有流量都将通过加密隧道到达OpenBSD端点服务器，之后，它将路由到互联网的其余部分。这将保护您的流量免受任何人在WI-Fi或蜂窝网络上的窥探。</p><p>  Below shows configuration for an OpenBSD server to be a WireGuardendpoint. All instructions below pertain to OpenBSD 6.8 released on2020-10-18.</p><p>下面显示了OpenBSD服务器作为WireGuard端点的配置。下面的所有说明都与2020-10-18发布的OpenBSD6.8有关。</p><p>   Configure OpenBSD&#39;s firewall/packet filter, pf(4) to open the port for WireGuard,allow traffic between WireGuard peers, and forward tunneled trafficfrom the client to the internet. To do so, add the following linesto your  pf.conf(5):</p><p>配置OpenBSD的防火墙/数据包过滤器PF(4)以打开WireGuard的端口，允许WireGuard对等项之间的通信，并将隧道通信从客户端转发到互联网。为此，请将以下行添加到pf.conf(5)：</p><p> # wireguard # open wireguard port pass in on egress proto udp from any to any port 51820 # allow communication between wireguard peers pass on wg0 # allow clients connected to wg0 to tunnel their outside world traffic pass out on egress inet from (wg0:network) nat-to (egress:0)</p><p>#wireguard#open wireguard port pass on export proto udp from any to any port 51820#允许wireguard对等方之间的通信在wg0上传递#允许连接到wg0的客户端将其外部世界流量从(wg0：network)nat-to(exress：0)隧道传出</p><p>  Previous to OpenBSD 6.8, configuration required the wireguard-toolspackages. Now that WireGuard is in base, we can do allconfiguration with base utils. This is all nicely documentedin the manual pages (  wg(4), ifconfig(4)) and summarised below:</p><p>在OpenBSD 6.8之前，配置需要wireguard-toolspack。现在WireGuard在Base中，我们可以使用Base Utils进行所有配置。手册页(工作组(4)、ifconfig(4))对此进行了很好的记录，并总结如下：</p><p>  WireGuard uses a Curve25519 key that is 32 bytes in length andbase64 encoded. A Curve25519 key needs 5 particular bits to beconfigured in a certain way to valid, but wg(4) can correctthis from any randomly generated 32 bytes. Therefore, we justneed a 32 bytes random base 64 encoded string and can use openssl(1) for that:</p><p>WireGuard使用长度为32字节、base64编码的Curve25519密钥。Curve25519密钥需要5个特定位才能以某种方式配置为有效，但是WG(4)可以从任意随机生成的32个字节中纠正这一点。因此，我们只需要一个32字节的随机base 64编码字符串，并且可以使用openssl(1)来实现：</p><p>  This will save the private key to  ep_private.key. Keep a hold ofthis for now. We can delete it after the set-up is complete.</p><p>这会将私钥保存到EP_Private ate.key。暂时拿着这个。我们可以在设置完成后将其删除。</p><p>  Bringing up the wg0 interface generates a public key from theprivate key. You will need to give this public key to the client (yourlaptop, smart phone etc), so save it for now:</p><p>启动wg0接口将从私钥生成公钥。您需要将此公钥提供给客户端(您的笔记本电脑、智能手机等)，因此暂时保存它：</p><p> # ifconfig wg0 | grep wgpubkey | cut -d &#39; &#39; -f 2 &gt; ep_public.key</p><p>#ifconfig wg0|grep wgpubkey|Cut-d&#39；&#39；-f 2&gt；ep_public.key。</p><p> This IP address will be the IP address your endpoint will have onthe VPN. The OpenBSD endpoint will be reachable at 10.0.0.1by clients (smartphone, laptop, etc) which will also be on the10.0.0.0/24 subnet. I recommend picking an ip address range randomlyto prevent any collision between a network you may join and yourWireGuard network (eg 10.12.24.0/24). To keep things simple for thistutorial I&#39;ll just use 10.0.0.0/24 subnet and give the end point thefirst IP address:</p><p>此IP地址将是您的端点将在VPN上拥有的IP地址。客户端(智能手机、笔记本电脑等)将可以在10.0.0.1访问OpenBSD端点，这些客户端也将位于10.0.0.0/24子网上。我建议随机选择一个IP地址范围，以防止您可能加入的网络与您的WireGuard网络(例如10.12.24.0/24)之间的任何冲突。为简单起见，我将使用10.0.0.0/24子网，并为端点提供第一个IP地址：</p><p>   Below is a bit of a hack so we can use base utilities only. It bringsup a temporary wg interface with a generated private key just so we canextract the generated public key.</p><p>下面是一个小技巧，所以我们只能使用基本实用程序。它使用生成的私钥生成一个临时的WG接口，这样我们就可以提取生成的公钥。</p><p> This will save the private key to  client1_private.key. Keep a hold ofthis for now. We can delete it after the set-up is complete.</p><p>这会将私钥保存到client1_private ate.key。暂时拿着这个。我们可以在设置完成后将其删除。</p><p> Note, I&#39;m picking a different port (this can be whatever you want)since wg0 is already up on 51820.</p><p>请注意，我正在选择一个不同的端口(这可以是您想要的任何端口)，因为wg0已经在51820上运行。</p><p> You will need to use this public key on the OpenBSD endpoint inorder for the client to connect.</p><p>您需要在OpenBSD端点上使用此公钥，以便客户端进行连接。</p><p> # ifconfig wg1 | grep wgpubkey | cut -d &#39; &#39; -f 2 &gt; client1_public.key</p><p>#ifconfig wg1|grep wgpubkey|Cut-d；&#39；-f 2&gt；client1_public.key。</p><p>  Now that we have the client&#39;s public key, we can establish a WireGuardpeer on the endpoint to allow the client to connect:</p><p>现在我们有了客户端的公钥，我们可以在端点上建立一个WireGuardPeer，以允许客户端连接：</p><p>  This will limit the IP address of the peer to 10.0.0.2. Changed the IPaddress to the IP address you would like on the subnet you picked.</p><p>这会将对等方的IP地址限制为10.0.0.2。在您选择的子网上将IP地址更改为您想要的IP地址。</p><p>  With the above instructions, your endpoint works. However, it will notwork once you reboot the operating system. Save this configuration withthe below text in  /etc/hostname.wg0:</p><p>按照上述说明，您的端点可以正常工作。但是，一旦您重新启动操作系统，它将不起作用。在/etc/hostname.wg0中使用以下文本保存此配置：</p><p>  Making sure to replace  REPLACE_WITH_EP_PRIVATE_KEY with the text storedin  ep_private.key and  REPLACE_WITH_CLIENT1_PUBLIC_KEY with the textstored in  client1_public.key.</p><p>请确保将_WITH_EP_PRIVATE_KEY替换为存储在EP_Private.key中的文本，并将_WITH_CLIENT1_PUBLIC_KEY替换为存储在client1_public.key中的文本。</p><p> Make sure the permissions for  /etc/hostname.wg0 are correct so usersoutside of root and those in the group wheel cannot read the keys:</p><p>确保/etc/hostname.wg0的权限正确，以便root以外的用户和组轮子中的用户无法读取密钥：</p><p>    With the endpoint set-up, now you just need to configure your smartphone to use the tunnel. The authors of WireGuard provide apps for both Androidand iOS. Theseapplications make configuration easy. You just need to take a photo of aQR code made from a client.conf that you can write on your computer. Theclient.conf should have the following contents:</p><p>端点设置完成后，现在您只需配置您的智能手机即可使用隧道。WireGuard的作者提供适用于Android和iOS的应用程序。这些应用程序使配置变得简单。你只需要拍一张由client.conf制作的A二维码的照片，就可以写在你的电脑上了。该lient.conf应包含以下内容：</p><p>  Make sure to replace  REPLACE_WITH_CLIENT1_PRIVATE_KEY with thecontents from  client1_private.key,  REPLACE_WITH_EP_PUBLIC_KEY withthe contents from  ep_public.key, and  OPENBSD_EP_IP_ADDRESS with theIPv4 address of your OpenBSD end point.</p><p>确保将_WITH_CLIENT1_PRIVATE_KEY替换为client1_Private.key中的内容，将_WITH_EP_PUBLIC_KEY替换为EP_public_key中的内容，并将OpenBSD_EP_IP_ADDRESS替换为OpenBSD端点的IPv4地址。</p><p> Next, generate a qr code with this information using the  libqrencodepackage. If you do not want to install a package outside of base, youcan enter the above info by hand into your phone instead. Then do thefollowing to create the code:</p><p>接下来，使用libqrencodesackage使用此信息生成二维码。如果您不想在基础之外安装软件包，您可以将上述信息手动输入到您的手机中。然后执行以下操作以创建代码：</p><p>  If you have issues taking a photo from the QR code generated in yourterminal, you can also save it as an image and take a photo of theimage.</p><p>如果您在使用终端生成的二维码拍照时遇到问题，您也可以将其另存为图像并为其拍照。</p><p> Open your WireGuard application and take a photo of the QR code,and the app is now configured! Toggle the switch in the appto turn it on. To verify it is working, go to a website like icanhazip.com to see your IP address. It shouldchange when the WireGuard tunnel is up to the same address as yourOpenBSD end point.</p><p>打开您的WireGuard应用程序并拍摄二维码的照片，该应用程序现在已配置完毕！拨动应用程序中的开关将其打开。要验证它是否正常工作，请转到像icanhazip.com这样的网站查看您的IP地址。当WireGuard隧道达到与您的OpenBSD端点相同的地址时，它应该会改变。</p><p>     Please contact me with any questions or input on the article using anyof the methods on my  contact page.</p><p>如果您对本文有任何疑问或意见，请使用我联系页面上的任何一种方法与我联系。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://thomasward.com/openbsd-wireguard/">https://thomasward.com/openbsd-wireguard/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/wireguard/">#wireguard</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/tunnel/">#tunnel</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1030591.html"><img src="http://img2.diglog.com/img/2020/10/thumb_774914de6bb18c065982d36c366149e8.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030591.html">亲身体验华为新款Mate 40 Pro：令人难以置信的摄像头和强大的处理器，但应用程序选择很糟糕，很难推荐这款手机</a></div><span class="my_story_list_date">2020-10-23 0:19</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030385.html"><img src="http://img2.diglog.com/img/2020/10/thumb_070eb8b4b8ea9a1fbede3da2aee37061.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030385.html">App Annie在第三季度对Z代智能手机用户进行的调查发现，他们平均每月花在非游戏应用程序上的时间超过4.1小时，比年龄较大的人口统计数据多10%</a></div><span class="my_story_list_date">2020-10-22 9:9</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030381.html"><img src="http://img2.diglog.com/img/2020/10/thumb_69637e13c411d60f507477cf7fb2bc60.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030381.html">摩根大通推出QuickAccept，这是一项面向中小企业的智能手机读卡器和支付服务，免费提供POS交易的即时存款，与Square不同</a></div><span class="my_story_list_date">2020-10-22 9:8</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030375.html"><img src="http://img2.diglog.com/img/2020/10/thumb_c799d5a7ee38b0c8d8afb52324b20e99.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030375.html">报告：至少2000个美国执法机构，包括50个最大的警察部门中的49个，拥有访问锁定的加密手机的工具</a></div><span class="my_story_list_date">2020-10-22 9:6</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>