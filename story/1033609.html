<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>将我们的定制操作系统与标准库挂钩</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">将我们的定制操作系统与标准库挂钩</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-07 11:12:51</div><div class="page_narrow text-break page_content"><p>标准库包含大量我们不想自己编写的代码，包括printf、scanf、数学函数等等。因此，我们需要确保我们的操作系统可以链接到这个库，并且一切都“正常工作”。这篇文章将向你展示我如何将我们的操作系统链接到一个标准库newlib，以及在这样做的过程中遇到的考验和磨难。</p><p>程序库允许程序员在更高的层次上开始编写程序。如果有人还记得80年代，当个人电脑引导到一个基本的编辑器时，你基本上必须从头开始编写你的程序。</p><p>术语库只表示存储代码的某个地方。通常，此代码是编译和汇编的源代码的目标文件。共享对象也可以按需加载，但这需要一些来自动态链接器的额外支持。请看我关于动态链接的帖子：动态链接。</p><p>许多最有用的例程将只需编写一次，然后存储到共享对象(So)或存档(A)中。我们知道，库允许我们引入已经编写的代码，但库还有一个更根本的原因--使与操作系统的接口变得容易。</p><p>如果你读过我关于使用Rust的RISC-V操作系统的博客文章，你就会知道一个应用程序是如何从操作系统本身发出请求的。通常，这是通过系统调用完成的。这些系统调用被赋予一个编号。例如，在x86-64系统上的Linux中，系统调用#0是exit系统调用。然而，没有什么能真正说明我们必须使用这些数字。</p><p>如果我们看一看libgoss，这是一个为newlib编写的低级库，我们可以看到以下标准：</p><p>因此，正如您所看到的，低级库的工作是确保参数位于正确的位置，系统调用号位于正确的寄存器中，并且实际执行了系统调用。对于RISC-V，我们执行的最后一条指令是eCall，即“环境调用”。这条指令将使我们进入操作系统。操作系统将通过首先了解它正在处理系统调用来处理此问题。其次，它将查看系统调用号并将其路由到正确的例程。</p><p>我们可以通过一个通用函数(如printf())来了解这一点。此函数将首先使用应用程序形成一个完整的字符串。因此，类似printf(“Hello%s”，“Stephen”)的内容将导致该函数构建一个字符串，其内容为“Hello Stephen\0”。最后一步是printf()将其打印到标准输出文件句柄。除非有任何重定向，否则这通常是控制台。因此，库函数最终必须调用WRITE系统调用，首先列出文件描述符(Number)，其次是指向字符串的指针，最后是要写入的字节数。</p><p>在系统调用结束时，控制权交回给用户应用程序。在这种情况下，printf()必须处理从WRITE系统调用接收到的任何返回值。如果我们执行系统调用跟踪或strace，我们可以看到WRITE确实是printf的最终目标。</p><p>在上面的输出中，我们可以看到printf()决定调用WRITE WITH WITE WITH FILE DESCRIPTOR 1(这是标准输出)和字符串缓冲区“Hello Stephen”(最后13个字符)。请注意，printf()必须能够找到空终止符(\0)来计算打印字符数。</p><p>当我们查看内核时，我们必须能够处理库如何进行系统调用。正如您所看到的，这些系统调用中的大多数都遵循UNIX SYSV约定，比如exit、read、write等等，其中所有内容都是文件描述符，包括网络套接字和实际文件。</p><p>下面的例子显示了我是如何实现开放系统调用的。您可以看到，由于应用程序使用的是虚拟内存，因此我需要找出它在物理内存中的位置，以便内核可以找到它。将两者混合或跨越河流从来都不是一个好主意。</p><p>在上面的代码中，我检查用户给出的路径(第一个参数)是否在虚拟文件系统中的某个位置。如果是，那么我们可以创建一个新的文件描述符，并将其链接到该文件。正如您可以看出的，这个系统调用绝不能完全处理所有不同类型的文件，包括节点(套接字、FIFO等)。</p><p>C++标准实际上包含有关标准库的信息。这包括复杂性保证和内存占用。</p><p>该库还最好了解底层架构的所有漏洞。例如，如果CPU支持AVX或SSE扩展，strcpy(字符串复制)就可以利用它们。</p><p>看看我在这里免费找到的C++2011标准，http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2011/n3242.pdf概述了需要支持才能被视为C++标准的不同标准函数。</p><p>这里只是第717页上容器库需求的一个例子(731是PDF页面)。</p><p>库的另一个有趣部分是，它们的某些部分可以帮助语言正常运行。这些库通常称为运行时。大多数语言现在都有运行库，运行库是在程序运行时执行的代码，而不是在编译或链接时执行的代码。</p><p>你们当中有多少人真的知道int main不是我们运行程序的真正切入点？相反，它属于一个名为_start的内存标签。该标签是ELF(可执行和可链接格式)入口点，操作系统将在该入口点设置您的应用程序开始运行。</p><p>_start最终将调用int main，但它必须设置一些内容，包括命令行参数，或者至少将它们放入int argc中，以及char*argv[]参数。</p><p>我们可以在crt0.S程序集文件中看到_start例程，它代表C运行时。0是第一个运行时，因为可以在不同的文件中添加更多的运行时，比如crt1.S等等。</p><p>您可以在上面的代码中看到，甚至在调用main之前，BSS(未初始化的全局变量)被清除为0，全局指针(GP)被设置，atexit函数(全局终止函数)被注册。最后，argc、argv和envp都找到了合适的位置。对于RISC-V，这是a0、a1和a2。</p><p>您可以看到，最后发生的事情是退出呼叫。这将获取Main的返回值，该返回值将位于寄存器a0中。尾部指令意味着它不会返回。Call和Tail都是RISC-V中的伪指令，可以在RISC-V规范中看到：</p><p>动态链接要求我们分析可执行和可链接格式(ELF)，这比我们在Rust中使用的RISC-V操作系统更强大一些。动态链接器需要位于存储设备某处的可执行解释器。实际上，您可以查看可执行文件，以了解在调用这些动态链接的函数时它将请求哪个解释器。</p><p>您可以看到上面的可执行文件将使用/lib64/ld-linux-x86-64.so.2来运行我编译的这个简单的测试可执行文件。我们可以实际运行那个解释器，看看它说了什么：</p><p>正如您所看到的，INTERP是一个特定的程序头，我们的操作系统必须能够处理它并产生指向动态链接器的线程。然而，这远远超出了我们的定制操作系统所能处理的范围。所以现在，我们的操作系统需要将标准库静态链接到我们的程序中。这意味着程序需要的所有函数和例程都必须存储在可执行文件中。这大大增加了程序的大小，这取决于在可执行文件的生命周期中进行的库函数调用的次数。</p><p>我甚至还没有开始深入研究设计和创建一个图书馆。在我的软件工程课程中，我展示了库可以是将许多不同团队的代码聚合到单个项目中的一个很好的工具。请记住，我是用一个相当低层次的镜头来看这件事的。</p><p>大多数图书馆都有一个特定的体系结构和操作系统。这给定制操作系统带来了一些挑战。事实上，很多时候，我只是为了避免以后的痛苦而复制Linux的约定。从总体上看，这似乎没什么大不了的。然而，它迫使您以某种方式思考操作系统。</p><p>获得一个大的哲学-Linux在过去的几年里发生了变化，但它仍然有一个核心的哲学。从它衍生出来的许多操作系统，包括安卓，现在都被淘汰了，以换取新的、令人耳目一新的操作系统。事实上，谷歌已经启动了Fuchsia项目，该项目旨在构建一个模块化操作系统，以取代其移动设备中的Android。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.stephenmarz.com/2020/10/25/hooking-up-our-custom-os-to-a-standard-library/">https://blog.stephenmarz.com/2020/10/25/hooking-up-our-custom-os-to-a-standard-library/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/操作系统/">#操作系统</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/custom/">#custom</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1032928.html"><img src="http://img2.diglog.com/img/2020/11/thumb_8d3e1d9d8c55c53bd5580ebac2ad9667.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032928.html">Daharia OS操作系统，结合了GNU/Linux和Fuchsia操作系统的优点</a></div><span class="my_story_list_date">2020-11-3 14:22</span></div><div class="col-sm"><div><a target="_blank" href="/story/1031674.html"><img src="http://img2.diglog.com/img/2020/10/thumb_aa894409fa807c74d89e9d9ad6dea94c.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031674.html">将MacOS作为虚拟化操作系统运行的Linux PC比hackinstosh更快</a></div><span class="my_story_list_date">2020-10-28 9:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1031071.html"><img src="http://img2.diglog.com/img/2020/10/thumb_c56b42a97bb7499813c376e3e11a86e7.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031071.html">MuditaOS：一个开源的e-ink移动操作系统</a></div><span class="my_story_list_date">2020-10-25 16:14</span></div><div class="col-sm"><div><a target="_blank" href="/story/1029192.html"><img src="http://img2.diglog.com/img/2020/10/thumb_e52669aa0dd5e737b281e50437ffa6bf.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1029192.html">Chromebook寿命缓慢上升：一些机型获得9年的操作系统更新</a></div><span class="my_story_list_date">2020-10-16 19:45</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>