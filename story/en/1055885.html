<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>一个人认为打开一个txt文件很好，他想错了。 Macos CVE-2019-8761 A man thought opening a TXT file is fine, he thought wrong. macOS CVE-2019-8761</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">A man thought opening a TXT file is fine, he thought wrong. macOS CVE-2019-8761<br/>一个人认为打开一个txt文件很好，他想错了。 Macos CVE-2019-8761 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-03 08:30:52</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/4/5a8451319e0324e2d6d289803b1e9c71.png"><img src="http://img2.diglog.com/img/2021/4/5a8451319e0324e2d6d289803b1e9c71.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Sorry for the clickbaity title, but CVE-2019-8761 really is an interesting macOS bug that lets attackers execute HTML within a TXT file, leak files, and do all sorts of other funky things.</p><p>对不起的ClickBaity标题，但CVE-2019-8761真的是一个有趣的麦克斯错误，让攻击者在TXT文件中执行HTML，泄漏文件，并做各种其他时髦的事情。</p><p>   This research originated when I realized the default text reader on OSX, TextEdit is used to open files with TXT extension by default. On the interface of TextEdit, it looked like you can do basic customization to your text (you can turn text bold, italic, change color etc...), so I was wondering how a TXT file was storing and parsing this information. It seems it uses RTF format instead of TXT if we add customizations to the text.</p><p>   当我在OSX上实现了默认文本读取器时，该研究源于默认情况下使用TXT扩展名打开文件。在TextEdit的界面上，它看起来像你可以为你的文字做基本的自定义（你可以打开文字粗体，斜体，改变颜色等......），所以我想知道TXT文件如何存储和解析这些信息。如果我们为文本添加自定义，它似乎使用RTF格式而不是TXT。</p><p>  A TXT file is a very interesting attack vector in my opinion, because of its innocent nature that carries nothing but text. however, we have previously seen    memory corruption bugs leading to RCE by Tavis Ormary in Microsoft Notepad. TXT files are also assumed by anti-virus software, firewalls, and even Mac&#39;s own Gatekeeper as safe downloads that can&#39;t possibly be malicious.</p><p>  在我看来，TXT文件是一个非常有趣的攻击向量，因为它的无辜性质，除了文本。但是，我们之前已经看到了Microsoft Notepad的Tavis Ormare导致RCE的内存损坏错误。 TXT文件也由反病毒软件，防火墙，甚至是MAC＆＃39;自己的门守视为可以＆＃39; t可能是恶意的安全下载。</p><p>  After some quick back and forth testing between files, I quickly realized that TextEdit can be tricked into thinking the file opened is an RTF-HTML file even when the file extension is TXT. The ability to inject HTML into a TXT file obviously opened lots of potential attack vectors.</p><p>  经过一些快速的文件来回测试文件，我很快就意识到了TextEdit可以追求思考，即使文件扩展为TXT，也可以将文件打开是RTF-HTML文件。将HTML注入到TXT文件中的能力显然打开了大量潜在攻击向量。</p><p>      It seems TextEdit for some reason thought it should parse the HTML even while the file format was TXT. So we can inject a bunch of limited HTML into a text file, now what?</p><p>      它似乎是由于某种原因似乎也应该解析HTML，即使文件格式是TXT。所以我们可以将一堆有限的HTML注入文本文件，现在是什么？</p><p>    One of the first bugs I discovered using this showed me that Gatekeeper doesn’t quarantine TXT files even if they were downloaded from a suspicious website. For example, I found a TXT file force-downloaded from Tor browser, when opened can bypass Gatekeeper and leak the  real  IP address of the victim without any warning. This wasn’t very straightforward though.</p><p>    我发现的第一个错误之一显示了我，即使从可疑网站下载，Gatekeeper也不会隔离TXT文件。例如，我发现从TOR浏览器中下载的TXT文件，当打开时可以绕过网守并泄漏受害者的真实IP地址而没有任何警告。这不是很简单。</p><p>  I first tried to see how much of the HTML is parsed and interpreted by TextEdit. It seems there was very limited parsing and many of the interesting HTML attributes were not available. I then went ahead and got the awesome Cure53&#39;s project   HTTPLeaks,  which is a wonderful file to discover if an HTML/CSS attribute leaks data to a third party.</p><p>  我首先尝试看看由TextEdit解析和解释了多少HTML。似乎存在非常有限的解析，并且许多有趣的HTML属性没有可用。然后，我继续令人敬畏的Cure53＆＃39; s httpreaks，它是一个奇妙的文件，可以发现HTML / CSS属性是否泄露到第三方。 </p><p>  I replaced all the URLs in the HTTPLeaks attributes with a server I control and saved it as TXT to see if the TXT file made a request to my server. It didn&#39;t.  After some fuzzing, I found two interesting CSS and HTML attributes that got some sort of weird response from local files.</p><p>我使用服务器控制HTTPreaks属性中的所有URL，并将其保存为TXT，以查看TXT文件是否为我的服务器提出了请求。它没有。＆＃39; t。在一些模糊之后，我发现了两个有趣的CSS和HTML属性，从本地文件中获得了某种奇怪的响应。</p><p>     was allowed to load local CSS files. However, the only scheme that worked was file:/// and not even http/s://. While this means we can&#39;t make external requests, it also means we can hit or open other local files that are stored locally. This creates a very obvious DOS vulnerability that acts like a blind SSRF by writing a recursive file inclusion  or, reading files with infinite data streams like /dev/urandom, /dev/zero. a 2kb text file can crash your mac. COOL, but completely useless.</p><p>     允许加载本地CSS文件。但是，唯一一个工作的方案是文件：///甚至不是http / s：//。虽然这意味着我们可以＆＃39; t制作外部请求，但它也意味着我们可以击中或打开本地存储的其他本地文件。这将创建一个非常明显的DOS漏洞，它通过编写递归文件包含或读取与/ dev / urandom，/ dev / reloge等无限数据流的文件来实现盲的ssrf。 2KB文本文件可能会崩溃您的Mac。很酷，但完全没用。</p><p>  After digging into OSX internals, I came across the AutoMount feature that lets file:/// urls make remote requests. AutoFS is a program on OSX that uses the kernel to make a mounting request to a drive. Automount can also make remote requests to an external drive. Doing &#39;ls /net/EXAMPLE.com&#39; forces OSX send a remote request to EXAMPLE.com</p><p>  挖入OSX内部后，我遇到了允许文件：/// URL的Automount的功能进行远程请求。 Autofs是OSX上的程序，它使用内核向驱动器进行安装请求。 Automount还可以向外部驱动器进行远程请求。做＆＃39; ls /net/example.com&#39;强制osx向example.com发送远程请求</p><p>  While they did a good job blocking TextEdit from making external requests, this was the one thing they forgot when they allowed file:/// scheme, on OSX file:///net/11.22.33.44/a.css connects to 11.22.33.44.</p><p>  虽然他们做得很好地阻止TextEdit来制作外部请求，但这是他们在允许文件中忘记的一件事：///方案，在OSX文件中：///net/11.22.33.44/a.css连接到11.22。 33.44。</p><p>            So I will know when you opened the TXT file I sent you. Not only that, but apparently AutoMount uses the kernel to make TCP connections so even if you were using a proxy, it was leaking your real IP address. I found another browser trick that lets force-downloaded TXT files to be opened without user interaction or warning (since Gatekeeper doesn&#39;t exist for TXT) leaking IP straight out of Tor browser.</p><p>            所以我会知道你什么时候打开我发给你的txt文件。不仅如此，而且显然自动搜索使用内核使TCP连接即使您使用的代理也是如此，它正在泄露您的真实IP地址。我找到了另一个浏览器技巧，可以在没有用户交互或警告的情况下强制下载的TXT文件（因为Gatekeeper不存在TXT）直接从Tor浏览器中泄漏IP。</p><p>  Leaking IP Addresses and knowing when your TXT file is open is cool n all, but what else can we do? It seems a lot worse!</p><p>  泄漏IP地址并知道当您的TXT文件打开时很酷，但我们还能做些什么？这似乎更糟！</p><p>      It turns out an attacker can embed local files using the &lt;iframedoc src=&#34;file:///etc/passwd&#34;&gt; and look at their contents within the TXT file.</p><p>      它拒绝攻击者可以使用＆lt; iframedoc src =＆＃34;文件：// etc / passwd＆＃34;＆gt;并查看其在TXT文件中的内容。 </p><p>  I will not leave a PoC for this chapter but I promise you, it will not be that difficult to figure out after reading the above two parts. While we can embed/open local files, we still can&#39;t execute javascript so it might seem like there is no way to send them out at first glance. But this is where dangling markup comes in.</p><p>我不会为本章节留下PoC，但我向您保证，在阅读上述两部分后，难以弄清楚。虽然我们可以嵌入/打开本地文件，但我们仍然可以＆＃39; t执行javascript，所以它看起来可能乍一看没有办法。但这就是悬空标记进来的地方。</p><p>  Dangling Markup attacks are nice browser tricks that serve as scriptless attacks to leak data when dynamic scripting is disabled. For example, they can often be used to steal anti-CSRF tokens in cases where CSP stops javascript execution.</p><p>  悬空标记攻击是良好的浏览器技巧，它用作禁用动态脚本时泄漏数据的脚本攻击。例如，在CSP停止JavaScript执行的情况下，它们通常可以使用它们来窃取反CSRF令牌。</p><p>  By combining the  &lt;style&gt;  CSS attribute with the  &lt;iframedoc&gt;  attribute, an attacker can first include an unclosed style tag,  embed the contents of the file they want to steal and then leak the content as dangling parameters to their evil site as soon as the file is open.</p><p>  通过组合＆lt; style＆gt; CSS属性与＆lt; iframedoc＆gt;属性，攻击者可以首先包含一个未闭合的样式标记，嵌入他们想要窃取的文件的内容，然后一旦文件打开，就会将内容泄漏为邪恶站点。</p><p>  This vulnerability was reported to Apple in Dec 2019, and it got patched somewhere in 2020. I don’t know why a CVE-2019 ID is given. Given how simple it is to exploit, I’d give it a high CVSS.</p><p>  该漏洞在2019年12月向Apple报告，它在2020年的某处修补了。我不知道为什么给出CVE-2019 ID。鉴于利用多么简单，我会给它一个高CVSS。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.paulosyibelo.com/2021/04/this-man-thought-opening-txt-file-is.html">https://www.paulosyibelo.com/2021/04/this-man-thought-opening-txt-file-is.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/认为/">#认为</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/thought/">#thought</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/文件/">#文件</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>