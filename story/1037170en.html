<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我可以通过Postgres做所有事情：Elixir程序员的经验教训I can do all things through Postgres: Lessons for the Elixir programmer</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">I can do all things through Postgres: Lessons for the Elixir programmer<br/>我可以通过Postgres做所有事情：Elixir程序员的经验教训</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-30 03:02:33</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/11/1ba822d3deea68457c900755620e600e.jpeg"><img src="http://img2.diglog.com/img/2020/11/1ba822d3deea68457c900755620e600e.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>If you have even a cursory knowledge of the Bible, you might recognize that tongue-in-cheek title paraphrased from Philippians 4:13. While I chose it because I thought it was catchy, it is also fair to say many developers have a religious affinity for certain databases.</p><p>如果您甚至对圣经一无所知，您可能会认识到腓利比书4:13所说的嘲讽标题。尽管我之所以选择它是因为我认为它很吸引人，但也可以说许多开发人员对某些数据库有宗教信仰。</p><p>  The goal of this post is to shed some light on another way of thinking about development problems. As you’ll see, these problems could all be solved with Elixir code. I want to give some concrete examples of problems that are better solved with the database.</p><p>  这篇文章的目的是阐明关于发展问题的另一种思考方式。如您所见，这些问题都可以通过Elixir代码解决。我想给出一些具体的问题示例，这些问题可以通过数据库更好地解决。</p><p>  There are some problems Postgres is just better at solving. Since it was introduced over 20 years ago, a lot of work has gone into adding features and performance.</p><p>  Postgres有一些问题只能解决。自从20多年前推出以来，许多工作都在增加功能和性能上。</p><p> In addition, I have seen a lot of projects where the application CPUs are constantly under load and the DB server CPU hovers around 5%. All things being equal, these techniques must just be good for redistributing load across your resources.</p><p> 另外，我看到了很多项目，其中应用程序CPU一直处于负载状态，而DB服务器CPU徘徊在5％左右。在所有条件都相同的情况下，这些技术必须很好地在整个资源中重新分配负载。</p><p>  All of the examples assume you are using Ecto, but the concepts can easily be ported over to other systems. Moving logic into Postgres does not mean ditching your ORM. Thankfully, through a combination of  migrations and  fragments, we can inject SQL sparingly to accomplish our goals.</p><p>  所有示例均假设您使用的是Ecto，但是这些概念可以轻松地移植到其他系统上。将逻辑移入Postgres并不意味着放弃您的ORM。幸运的是，通过结合迁移和片段，我们可以少量地注入SQL以实现我们的目标。</p><p>  In this example, the schema represents a car. There are 3 columns: engine_type, mpg, and kwh. A car should never have data in all 3 fields. Only a car with an electric motor should have kwh. And only a gasoline engine should have mpg.</p><p>  在此示例中，架构表示汽车。一共有3列：engine_type，mpg和kwh。汽车永远不应在所有3个字段中都有数据。仅带电动机的汽车应具有kwh。并且只有汽油发动机应该具有mpg。</p><p> Let’s say you want to make sure that logic is validated in a changeset, you might create a custom validator like this:</p><p> 假设您要确保在变更集中验证了逻辑，则可以这样创建一个自定义验证器：</p><p>  Using postgres, the migration gets a new check constraint. Supporting this constraint only requires adding a  check_constraint/3 function to the changeset. With this strategy the database will ensure the business logic is followed and the changeset will return a useful error if it doesn’t.</p><p>使用postgres，迁移会获得新的检查约束。支持此约束只需要向变更集添加一个check_constraint / 3函数。采用这种策略，数据库将确保遵循业务逻辑，并且变更集将返回有用的错误（如果没有）。</p><p>   In addition, all data in the database will be validated. Even if it doesn’t go through the changeset (maybe you imported data from an external source.) I think it’s common to take a belt-and-suspenders approach to data validation by validating on the front-end as well as the back-end. Adding this type of validation at the db level is belt-and-suspenders-and-an-elastic-wasteband.</p><p>   此外，还将验证数据库中的所有数据。即使它没有通过变更集（也许您是从外部来源导入的数据），我也认为采用皮带悬挂式方法通过在前端和后端进行验证来验证数据是很常见的。结束。在db级别添加这种类型的验证的是腰带和悬吊带以及弹性废料带。</p><p>  Citext is an extension to postgres. It adds a new datatype that is essentially a case-insensitive string. Installing it is very easy (as you can see below.)</p><p>  Citext是Postgres的扩展。它添加了一个新的数据类型，该数据类型本质上是不区分大小写的字符串。安装非常简单（如下所示）。</p><p>  Under the hood, postgres is actually converting both sides of the query to lowercase. Incidentally, this is generally what you would do in your application code to achieve the same end.</p><p>  在幕后，postgres实际上将查询的两端都转换为小写。顺便说一句，这通常是您在应用程序代码中为达到相同目的而要做的事情。</p><p>  As you can see, the elixir code required to perform a case-insensitive search is a bit more complex. In addition, if you decided to add this to an existing database you would need to migrate all of the existing data. Using Citext doesn’t have that requirement.</p><p>  如您所见，执行不区分大小写的搜索所需的Elixir代码要复杂一些。另外，如果您决定将此添加到现有数据库中，则需要迁移所有现有数据。使用Citext并没有这个要求。</p><p>  Let’s say your users search for cars based on price. You want to show them the cars that are exactly the price they asked for, but also some cars that are a little more and a little less. In elixir, that might mean getting 3 lists of results and merging them.</p><p>  假设您的用户根据价格搜索汽车。您想向他们展示价格恰好是他们想要的汽车，但也要向他们展示一些价格越来越少的汽车。在长生不老药中，这可能意味着获取3个结果列表并将其合并。</p><p>  Postgres is storing data in order already. Using the window functions  lag and  lead, you can have postgres target the exact match and then just grab the rows around it in the index. Think of this like going to a car lot where every car is parked in order of price. If you start out at the $5,000 car, the ones close in price will be parked right next to it.</p><p>  Postgres已经在按顺序存储数据。使用窗口函数lag和Lead，您可以让postgres定位完全匹配的对象，然后仅在索引中获取其周围的行。认为这就像去一辆车，那里每辆车都按价格顺序停放。如果您以5,000美元的汽车开始，那么价格接近的汽车将停在其旁边。</p><p>  In the above example you can also see the use of CTEs. The top section (starting with “WITH”) defines the CTE used in the query.</p><p>在上面的示例中，您还可以看到CTE的用法。顶部（以“ WITH”开头）定义了查询中使用的CTE。</p><p> A  CTE is a temporary result set which you can reference within another SQL statement including SELECT, INSERT, UPDATE, or DELETE. It is useful anytime you would have a recursive query.</p><p> CTE是一个临时结果集，您可以在另一个SQL语句（包括SELECT，INSERT，UPDATE或DELETE）中进行引用。每当您有递归查询时，它都会很有用。</p><p>  Searching for fuzzy matches can be very inefficient in elixir. Let’s say you wanted a text search that looks at both the car’s make as well as it’s model. In addition, you want to return near matches in case the user misspells the name.</p><p>  在fuzzy剂中搜索模糊匹配可能效率很低。假设您要进行文字搜索，以同时查看汽车的品牌和型号。此外，如果用户拼错名称，则要返回匹配项。</p><p> In elixir, you might need to load every car, then iterate over each (twice) to calculate the string similarity and to sort the results. In this example, we are using the  jaro_distance which is available in the String module.</p><p> 在elixir中，您可能需要加载每辆汽车，然后对每辆汽车进行两次（两次）迭代，以计算字符串相似度并对结果进行排序。在此示例中，我们使用String模块中可用的jaro_distance。</p><p>  By moving that logic into the database query we can use functions that are built in to postgres. Levenshtein distance calculation is available in postgres without the need for any plug-ins.</p><p>  通过将该逻辑移到数据库查询中，我们可以使用postgres内置的函数。在postgres中可以使用Levenshtein距离计算，而无需任何插件。</p><p>  I have just scratched the surface of the capabilities of postgres. I hope I have given you some ideas on how to leverage this very powerful tool you already have installed.</p><p>  我刚刚介绍了postgres功能的表面。希望我给您一些有关如何利用已经安装的功能非常强大的工具的想法。</p><p> Postgres has a lot of strengths when organizing, querying, and transforming data (that’s kind of what it was designed for.) There are definitely a time and place to leave logic in your application, but I hope you will at least consider how moving logic into postgres could help you.</p><p> 在组织，查询和转换数据时，Postgres具有很多优势（这就是它的设计目的。）在您的应用程序中肯定有一个将逻辑留在时间和地点的方法，但是我希望您至少考虑一下如何移动逻辑进入postgres可以为您提供帮助。</p><p> Some of the features I left out include views, triggers, and pg_notify. If those interest you, check out  this article on caching an elixir app.</p><p>我遗漏的一些功能包括视图，触发器和pg_notify。如果您有兴趣，请查看有关缓存不老长寿应用程序的本文。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://medium.com/@toddresudek/i-can-do-all-things-through-postgres-lessons-for-the-elixir-programmer-400fd805c23a">https://medium.com/@toddresudek/i-can-do-all-things-through-postgres-lessons-for-the-elixir-programmer-400fd805c23a</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/elixir/">#elixir</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/lessons/">#lessons</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/postgres/">#postgres</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>