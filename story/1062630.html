<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>为什么加载平衡GRPC很棘手？ </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">为什么加载平衡GRPC很棘手？ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-05-14 14:05:21</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/5/6b34bf4f02fbf5fecf0daafacf7bf21b.png"><img src="http://img2.diglog.com/img/2021/5/6b34bf4f02fbf5fecf0daafacf7bf21b.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>随着过去几年微服务的增长，GRPC在这些较小的服务之间进行了很多人气。在幕后，GRPC使用HTTP / 2来多用同一连接内的许多请求和双工流。</p><p> 使用快速非常轻的二进制协议，具有结构化数据作为服务之间的通信媒介，确实非常有吸引力，但在使用GRPC时存在一些考虑因素，最重要的是如何处理负载平衡。</p><p>  GRPC连接是粘性的。意思是，当从客户端到服务器进行连接时，可以为许多请求（多路复用）重复使用相同的连接，只要尽可能长。这是为了避免为TCP握手花费的所有初始时间和资源。因此，当客户端抓取到服务器实例时，它将保持它。</p><p> 现在，当同一客户端开始发送大量的请求时，它们都将转到同一服务器实例。这正是问题，没有机会将该负载分发给其他实例。他们都转到同样的例子。</p><p>  以下是负载平衡GRPC间通信和各种方法的一些方法的方法。</p><p>  当在服务器端完成负载平衡时，它会使客户端非常瘦，完全不知道它在服务器上处理方式：</p><p>   网络负载平衡器在OSI（开放系统互连）模型的第4层处运行。因此它非常快，可以处理更多的连接。当新的TCP流量连接进入时，负载均衡器选择实例，并将连接路由到连接的寿命的该单一实例。 </p><p>现在请记住，GRPC连接是粘性且持久的，因此它将保持在客户端与负载均衡器后面的同一服务器实例之间的相同连接，只要它可以。</p><p>   如果单个服务器实例上的加载（内存或CPU）高于自动缩放策略，则会导致新实例在该目标组中旋转。</p><p> 但目标组中的一个新实例不会有所帮助。为什么？同样，因为GRPC连接是持久性和粘性的。发送大量请求的客户端将继续向他们发送相同的服务器实例它具有连接。</p><p> 因此，新的服务器实例已旋转，但没有一个请求过载将进入新实例。具有沉重用法的单个服务器实例仍在接收来自客户端的请求（因为客户端保留同一连接）。</p><p> 有可能使自动缩放策略保持触发并向目标组添加新实例（因为有一个具有过载的CPU /内存的单个实例）。但这些新实例接近零流量。自动缩放策略可以继续触发并可能最大化目标组中的允许实例，而无需实际受益于发送到新实例的请求。</p><p>  为了有机会分发负载，我们必须用以下方法之一放弃粘性和持久的连接：</p><p>  如果您对连接GRPC客户端进行了控制，则可以将客户端定期断开连接并重新连接。这一动作将强制客户将新请求向负载均衡器发送并作为对此请求的响应，这次将此时间更健康实例回。这种技术强制负载是平衡的。 </p><p>如果您没有控制连接GRPC客户端，则可以在服务器端实现类似的逻辑。使服务器在某个时候强制关闭连接，当他们重新连接时，它会自动导致新的连接转到更健康的实例。</p><p>   AWS应用程序负载均衡器是第7层负载均衡器和支持HTTP / 2，直到10月20日至10月20日，HTTP / 2的支持仅从客户端到负载均衡器。然后，将连接从负载均衡器从负载均衡器中降级到HTTP / 1.1到BALB背后的支持目标实例。</p><p> 因此，此前您无法使用GRPC使用ALB，因为它一直需要HTTP / 2。</p><p> 但是，在2010年10月.2020。AWS宣布，ALB现在一直支持HTTP / 2，使其非常适合GRPC通信。</p><p> 虽然ALB的此功能相对较新，但粘性GRPC连接和NLB的参数也适用于ALB。如果yu从开始发送大量请求的客户端的单个粘性和持久的连接，则重新装载一个服务器实例，该服务器实例可容纳连接，并且请求不是应加载均衡。</p><p>  同样，我们可以将我们的服务器实例放在DNS服务发现后，而不是弹性负载平衡器。服务发现基本上是DNS服务，当请求进入时，它将以随机顺序返回其后面的所有实例的IP地址列表（或健康的子集）。因此，当客户端选择要连接的服务器并执行DNS查找时，服务发现返回排序的备份实例的IP地址。</p><p> 几乎所有与NLB的关注都适用于DNS服务发现负载平衡。当客户端抓住与单个实例的连接时，它将坚持并继续重新使用。无论它如何找到服务器实例，都是IT ALB，NLB或服务发现。 </p><p>如果您完全控制客户端，可以在客户端实现负载平衡逻辑。使客户端了解所有可用的服务器及其健康以及选择连接到的所有服务器和选择哪一个。这将导致客户在逻辑中更重。因此，它们不仅应该包含逻辑要做他们应该做的事情，而且还需要实现负载平衡，健康检查等的逻辑。</p><p> 这是一个可行的选项，在一个条件下：如果您完全控制所有客户端。您不能让错误的客户端连接到您的服务并导致各种负载平衡问题。它只需要一个有缺陷的客户来引起足够的麻烦。</p><p>   根据官方GRPC负载均衡的推荐，此方法使用外部负载均衡器或单臂负载均衡器，用于在服务器实例之间分发流量。</p><p> 客户端达到外部服务，它将返回可用服务器，服务发现和所有其他所需信息的列表。</p><p> 理想情况下，客户端将有一些逻辑，也可以帮助决定决定。这种方法容易出于上面提到的粘性连接的问题，因此需要仔细实施。</p><p> 官方实现使用每个呼叫负载平衡，而不是每个连接。所以每个呼叫都是单独平衡的负载。这是理想的和理想的情况，它将避免具有沉重的粘性连接。</p><p> 看看检查所有框，还有一个大缺点：它需要一个完全专用的服务。 </p><p>因此，要从外观负载均衡中受益，您需要实现并部署一个全新的专用服务，只需加载您的其他服务之间的GRPC连接。每项新服务都有自己的维护，操作，监控，警报等。</p><p>  服务器端负载平衡，具有非常重要的问题，我们无法受​​益于GRPC的主要优点，这是粘性可重复使用的连接。</p><p> 客户端负载平衡，需要完全控制客户端，如果有一个错误的客户端，它可能会破坏所有的计划。</p><p> 看起来除了负载平衡，是负载均衡Grpc连接的最逻辑和性能的解决方案，但它需要自己的完整和专用服务，这意味着架构中的新服务来实现和操作。也是一个新的失败点。</p><p> 处理GRPC架构中负载增加的关注和挑战是一个重要的。它需要适当关注妥善处理，解决方案取决于我们所拥有的情况。</p><p>     最后，作为软件工程中的所有其他东西，GRPC都带来了贸易问题。意识到贸易问题是至关重要的，并相应地选择。</p><p> 如果您发现本文有趣，您可以在Twitter上关注我，因为我在那里分享了我的学习。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://majidfn.com/blog/20201222-grpc-load-balancing/">https://majidfn.com/blog/20201222-grpc-load-balancing/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/加载/">#加载</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/balancing/">#balancing</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/客户端/">#客户端</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1057347.html"><img src="http://img2.diglog.com/img/2021/4/thumb_775ef809fc8d0383d7951c872bcad710.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1057347.html">介质 - 热代码重新加载Python </a></div><span class="my_story_list_date">2021-4-10 3:29</span></div><div class="col-sm"><div><a target="_blank" href="/story/1057173.html"><img src="http://img2.diglog.com/img/2021/4/thumb_875d2dd192b063e506fc829fa00f2c67.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1057173.html">Facebook，Instagram和WhatsApp现在超级打破了（更新：但开始再次工作） </a></div><span class="my_story_list_date">2021-4-9 6:45</span></div><div class="col-sm"><div><a target="_blank" href="/story/1050208.html"><img src="http://img2.diglog.com/img/2021/3/thumb_879faadb4bc0067c2f246a925f6a9c65.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1050208.html">黑客将GTA在线加载时间减少了70％以上 </a></div><span class="my_story_list_date">2021-3-2 2:38</span></div><div class="col-sm"><div><a target="_blank" href="/story/1050004.html"><img src="http://img2.diglog.com/img/2021/3/thumb_42c8b23c91b35288f3fb3f647e5697ac.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1050004.html">我如何将GTA Online的加载时间减少70％ </a></div><span class="my_story_list_date">2021-3-1 4:14</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>