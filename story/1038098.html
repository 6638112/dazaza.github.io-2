<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>糖–一种针对Webasm / Wat的轻快语言 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">糖–一种针对Webasm / Wat的轻快语言 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-07 01:53:20</div><div class="page_narrow text-break page_content"><p>（home）尽管我可能在较早的文章中曾说过，但是直接在wat中编写代码并不是很好，所以我开始着手于编译器的工作。一个非常瘦的编译器。该语言应该与我们心爱的wat非常相似，但可以避免我们键入所有i32.const，local.get。</p><p>  没有自我托管的人，我什至没有malloc可以玩，更不用说越野车，执行不佳的通用Lisp的部分副本了。</p><p>  语法检查是最新技术，错误以可读格式输出（即，如果犯了最轻微的错误，您将得到一个神秘的sbcl调试跟踪）。</p><p> 为什么加糖？就是那个，或者是沃森，沃特普，沃萨玛塔，watulookin。还因为它只是语法糖，懂吗？</p><p>  没有手册；甚至没有mul / div或所有关系运算符都被编写，例如，＆lt; =尚未被编写！</p><p> 结果不是独立的，而是wasm文件。到目前为止，我发现最好的独立运行时是wasm-interp。请不要说出node.js。可以说是v8。</p><p>   这是之前关于webasm的博客文章中的malloc.wat示例，它用糖重新编写，比原始的原始wat更加简洁和方便（请参见下文）。 </p><p>; malloc.sugar-糖示例代码（内存（import＆＃34; js＆＃34;＆＃34; mem＆＃34;）10）（import＆＃34; console＆＃34;＆＃34; log＆＃34;（func js_log（i i32）））（全局命令i32＃x1000）（全局sbrk（mut i32）0）; -----在wasm-space中分配一些内存（defun（export＆＃34; malloc＆＃34;）（len i32）：result i32（locals（i32（newbrk（+ sbrk len））（mem sbrk））） （如果（＆gt; = newbrk memend）（返回0））（设置sbrk newbrk）mem）; -----使用js回调在wasm空间内存中写入字节（defun（export dump_range）（start i32 len i32）（locals（i32 i（end（+ start len）））））（for（i start end）（ js_log（get.u8 * i）））</p><p> 如果您直接在wat中进行编码，这就是您应该编写的内容。</p><p> （模块（内存（导入（＆＃34; js＆＃34;＆＃34; mem＆＃34;）10）（导入＆＃34;控制台＆＃34;＆＃34; log＆＃34;（func $ js_log（param $ i i32）））（全局$ memend i32（i32.const 4096））（全局$ sbrk（mut i32）（i32.const 0））;; -----在wasm空间中分配一些内存（func（export ＆＃34; malloc＆＃34;）（参数$ len i32）（结果i32）（本地$ newbrk i32）（本地$ mem i32）（local.set $ newbrk（i32.add（global.get $ sbrk））（本地.get $ len）））（if（i32.ge_u（local.get $ newbrk）（global.get $ memend））（返回（i32.const 0）））（local.set $ mem（global.get $ sbrk ））（global.set $ sbrk（local.get $ newbrk））（local.get $ mem））;; -----使用js回调将字节写入wasm空间内存中（func（export＆＃34; dump_range＆ ＃34;）（param $ start i32）（param $ len i32）（local $ i i32）（local $ end i32）（local.set $ end（i32.add（local.get $ start）（local.get $ len）））（local.set $ i（local.get $ start））（块$ break2（循环$ head1（br_if $ break2（i32.eq（local.get $ i）（local.get $ end）））） （致电$ js_log（i32.load8_u（local.get $ i）））（local.set $ i（i32.add（ i32.const 1）（local.get $ i）））（br $ head1））））））</p><p>  在您喜欢的文本编辑器中编写一个your-source.sugar源文件。然后在上面放糖以产生your-source.wat</p><p>      它包括一个宏系统，我曾经用它来实现inc，但是它尚不能从sugaritself中使用。同样，完整的CL defmacro / destructuring-bind lambda列表语法很难复制；更不用说反引号了。</p><p>   循环：从源文件中读取一个表格（编译表格）=> stdout编译形式：integer =＆gt; （i32.const int）符号=> （local / global.get varname）[在环境/范围内签入] list / s-expr / cons =＆gt; while ：（是宏形式）形式：=（扩展宏形式）是特殊形式吗？形式=＆gt; （特殊编译形式）[defun / import / export / global / set ...]是功能吗？ =＆gt;对于所有args（编译arg），请使用args调用func，否则=>错误未定义函数</p><p>  括号太多？规则1：没有方括号，只有缩进。规则0：我们遭受了括号cos的折磨，这给我们带来了defmacro的痛苦，这值得很多痛苦。 </p><p>您曾经生成代码吗？您认为这很酷吗？您会爱上普通的口吻。请试用2周。如果不满意，请保证退款。</p><p>  Lisp具有value-IF，即您可以在使用值的任何地方使用IF。就像C的三元函数一样，但是功能更强大。起初我以为WAT没有它，但是（if）有一个可选的（result type）子句，例如（func）以便它39; s分支可以返回（类型匹配）值。因此，您可以执行以下此类聪明的操作：请注意if和condition之间的（result i32）子句。</p><p>  wat（选择）类似于C三元运算符，尽管它内部可以具有块/语句序列。</p><p> select v if：select总是对所有3个子句求值，而（if）仅对条件和selected分支求值。 other（if）分支未评估。</p><p>     目前，我只有按位运算符和/或运算符＆＃39;＆amp;＆＃39;和＆＃39; bor＆＃39;列表上的下一个是快捷键逻辑和/或类似CL的运算符。</p><p> 理想情况下，我希望具有Lisp样式和/或返回表达式值而不是仅返回0或1的地方。也可以是独立的和/或我们可以拥有类似的东西</p><p>  快捷方式和/或实际上是编译为嵌套（if）表达式。缺少其他类型（i64，f32，f64）的全部功能副本。编译器无法类型推断哪个（见下文），因此它们将具有显式名称，例如+ f64，set.f64等。 </p><p>目前，我正在使用指针get * / set *，但是我想拥有aref和指向指针算术的隐式索引。</p><p>  还有更多循环。同时重复等。底层的block，loop，br_if，br被公开，因此可以进行写循环。只有在添加一些宏才能启用的情况下：</p><p>    某种结构可能很不错。即使最初所有字段都必须是i32，即仅是一个带有命名字段而不是编号字段的向量。</p><p>  即使是当前的错误消息，也会使您进入SBCL调试器，这可能是一个令人恐惧的地方-[ctrl-d]退出。</p><p>  知道值的类型将使编译器可以检查用户函数和内建函数调用的签名，还可以使我推断出set的正确类型，而不需要set.f32等。</p><p>  必须在函数开始时定义本地。这意味着实现LET（具有局部变量的作用域块）并非易事。当前的单遍编译器需要变得更加复杂，才能首先确定函数中需要多少个局部变量，然后预先分配它们并可能如果有冲突，请重命名它们。</p><p>  编译器作者的圣杯是他们用新语言重写了编译器。 Common Lisp远远超出了水准，这将是一项艰巨的任务。首先，我需要编写malloc ... </p><p>设置糖/普通口香糖可能微不足道或困难，具体取决于您对普通口香糖的熟悉程度:)  安装common lisp（我使用SBCL）超出了本文的范围。 （告诉我，这比npm难...）  sugar作为Unix脚本运行。 因为我更喜欢迭代而不是循环，所以我制作了一个自定义的sbcl内核。以下是如何制作这样一个内核的简短说明，从普通的sbcl开始。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://ph1lter.bitbucket.io/blog/2020-12-06-sugar-compiler.html">https://ph1lter.bitbucket.io/blog/2020-12-06-sugar-compiler.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/webasm/">#webasm</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/typed/">#typed</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/i32/">#i32</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>