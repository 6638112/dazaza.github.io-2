<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>为什么printk（）是如此复杂，以及如何解决它（2019） Why printk() is so complicated, and how to fix it (2019)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Why printk() is so complicated, and how to fix it (2019)<br/>为什么printk（）是如此复杂，以及如何解决它（2019） </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-07 04:56:41</div><div class="page_narrow text-break page_content"><p>The difficulties with  printk() over the years, Ogness said, comedown to the tension between non-interference and reliability. Trying toachieve both goals in the same place has been shown not to work, so abetter approach would be to split them apart. Non-interference can beaddressed by making  printk() fully preemptable, making the ringbuffer safe in all contexts, and moving console handling to dedicatedkernel threads. Reliability, instead, can be achieved by providing asynchronous channel for important messages, an &#34;atomic consoles&#34; concept,and the notion of &#34;emergency messages&#34;. Both goals depend on support from the  printk() ring buffer. Thisbuffer has multiple concurrent readers and a single writer; it is storedcontiguously in memory and is protected by a special spinlock (the &#34;CPUlock&#34;) that can be acquired multiple times on the same CPU. This lock, he said, feels a lotlike the old big kernel lock. Like any self-respecting kernel-development project, the  printk()work starts with the creation of  anew ring buffer meant to address the problems with the current one. Itis fully lockless, supporting multiple readers and writers in allcontexts. Metadata has been pushed out to a separate descriptor mechanism;it handles tasks like timestamps and sequencing. The ring buffer has some nicefeatures, but it is also complicated, including no less than ninememory-barrier pairs. It is hard to document and hard to review; he isalso not convinced that the multiple writer support — which adds a lot ofthe complexity — is really needed. The addition of the per-console kernel threads serves to decouple printk() calls from console handling. Each console will now go asfast as it can, and each can have its own log level. Shifting theresponsibility for consoles simplifies a lot of things, but leads to someunresolved questions about locking and whether a thread-basedimplementation can be relied upon to always get the messages out. Butreliability, Ogness said, will be handled by other mechanisms; theper-console threads are a non-interference mechanism. For reliability, the plan is to add an &#34;atomic console&#34; concept. Consoleswith this support would have a  write_atomic() method that can beexpected to work in any context. This method is defined to operatesynchronously, meaning that it will slow down the system considerably;it is thus only to be used for emergency messages. The advantage is that thereis no longer any need for  bust_spinlocks() or the global oops_in_progress variable. The challenge is creating console drivers that can actually implement write_atomic(). He did an implementation for consoles attached toan 8250 UART; it was &#34;not trivial&#34;. There will almost certainly be a lotof systems that never get atomic-console support, so some other sort ofsolution will be needed. He said that options include creating a specialconsole that fills a memory area instead, trying to print synchronouslyoutside of atomic context, or just &#34;falling back to the currentcraziness&#34;. Associated with atomic consoles is the idea of &#34;emergency messages&#34; thatmust go out right away. The biggest problem here may be deciding whichmessages are important enough to warrant that treatment. Log levels are&#34;kind of a gray area&#34; and, he said, not really the way to go. There areonly a few situations where  printk() output is really thatimportant; the right solution might be to hook into macros like BUG(). Ogness concluded by noting that this work began in February, withthe current version having been posted in August. Most of the featuresdescribed above have been implemented, he said, giving developers&#34;something to play with&#34;. A separate session was held later in the conference; your editor wasunfortunately unable to attend. Ogness has posted  a summary of theconclusions that were reached there, though. He thanked the community forits participation in this meeting, which &#34; certainlysaved hundreds of hours of reading/writing emails&#34;. From the summary, it seems that  analternative ring buffer implementation posted by Petr Mladek will beused instead; it is much simpler and thus easier to review. Ogness hasported the rest of his work to use this buffer and shown that it works.The per-console kernel threads will be used. The &#34;emergency messages&#34; idea seems to have been superseded by the idea ofan &#34;emergency state&#34; that affects the system as a whole. When the kernelis in that state, all messages will be flushed using the write_atomic() callback where it is available. Flushing toconsoles without atomic support will not be supported. The CPU lock willremain, but its purpose will be to synchronize the console threads when thesystem is in the emergency state. There will be other changes, including the addition of a pr_flush() function that will wait for all messages to be sent outto all consoles. Patches implementing all this work have not yet beenposted, but presumably they can be expected soon. [Your editor thanks the Linux Foundation, LWN&#39;s travel sponsor, forsupporting his travel to this event.]     ( Log in to post comments)</p><p>Warning: Can only detect less than 5000 characters</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://lwn.net/SubscriberLink/800946/a9ad9aba46f14e78/">https://lwn.net/SubscriberLink/800946/a9ad9aba46f14e78/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/printk/">#printk</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/warning/">#warning</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>