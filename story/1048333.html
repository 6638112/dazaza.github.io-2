<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>实践中的2次方选择权 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">实践中的2次方选择权 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-02-19 02:54:11</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/2/6ed5f93853e5814a1c23ead4306153cb.png"><img src="http://img2.diglog.com/img/2021/2/6ed5f93853e5814a1c23ead4306153cb.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>访问模式决定了应如何存储数据。经常写入的数据应采用面向行的格式，而经常查询的数据应采用面向列的格式。</p><p> Mixpanel的内部数据库Arb支持实时事件提取和对所有历史记录的快速分析查询。存储节点从队列中读取数据，然后使用面向行的预写日志（WAL）将其写入磁盘。</p><p>  我们运行一个称为压缩器的服务，该服务将数据从行格式转换为列格式。此服务在Google Kubernetes Engine（GKE）上的自动缩放节点池中运行。当存储节点具有一定大小或使用期限的行文件时，它会向随机压缩器节点发送请求以对其进行压缩。压缩程序将返回生成的列文件的句柄或错误。如果所有压缩程序都处于繁忙状态，则它们会减轻负载，并且存储节点会重做一些尝试。</p><p> 尽管压缩程序在查询的关键路径之外运行，但它必须可靠且高效，因为Arb中的所有新数据每天都会经过它。考虑到必须要做的工作，压缩服务在计算上非常昂贵。</p><p>  压缩器成本在2019年下半年稳步增长，部分原因是我们的客户不断增长，部分原因是用于数据转换的新用例。</p><p>  更糟糕的是，压实机未能在正确的时间自动缩放以吸收负载峰值。这导致工程师在负载高或服务范围内的事件期间手动将自动定标器的最小副本数设置为高数量。这既浪费了我们的工程师时间，又使我们花在了浪费资源的实例上。</p><p>  我们首先看一下利用率，对于计算范围自动缩放服务，我们希望达到80-90％。由于Kubernetes的Horizo​​ntal Pod Autoscaler（HPA）的工作方式，因此这种假设似乎是合理的。您可以使用目标服务（压缩器）和该服务的目标指标（平均CPU利用率为90％）对其进行配置。如果CPU利用率超出目标某个阈值，它将调度更多的Pod，如果利用率较低，则反之亦然。内置一些迟滞以避免持续的抖动。 </p><p>但是，在我们的情况下，平均CPU利用率约为40％。平均值可以隐藏偏斜，因此我们绘制了利用率中位数和第90个百分位数。这表明一半的压实机几乎没有工作，而前10％的压实机已用尽！聚合利用率很低，因为自动缩放算法使用平均值而不是百分位数来做出缩放决策：</p><p>   压缩器每分钟收到1000个请求，因此通过大量定律，这些请求应在我们拥有的30-40个节点之间达到平衡。</p><p> 事实证明，即使您随机分配请求，但是当单个加载项的分配非常不均匀时，也会发生偏差。在我们的情况下发生这种情况是因为我们拥有广泛的客户，从每天有数千个事件的初创公司到每天有数十亿个事件的大型公司。这种功率定律，最大的用户比最小的用户大得多，因此简单的平均值就没那么有用了。</p><p>  一旦我们确定歪斜是问题所在，我们就考虑了一些复杂程度各异的解决方案：</p><p> （高）使用队列：在我们的存储节点（客户端）和压缩程序之间插入一个队列。这将从当前的推模型切换到异步拉模型，在这种情况下，压缩器仅在有容量时才起作用。虽然这可以实现最佳利用，但它需要对基础架构进行更改，添加队列组件，并需要跟踪正在进行的压缩工作。</p><p> （中）使用代理：在存储节点和压缩程序之间插入负载平衡服务。该服务可以跟踪所有压缩程序的负载，并将传入的请求转发到负载最小的压缩程序。这维持了我们当前基于推的架构，但是在两者之间添加了代理。我们考虑了这一点，但决定用更简单的方法验证我们的假设。</p><p> 2种随机选择（P2C）的（低）功效：这里的想法很简单。他们不是随机选择1个压缩器，而是随机选择2个压缩器。它们然后向每个压缩器询问其当前负载，并将请求发送到两个负载较小的负载。从理论上讲，这属于上述两个解决方案的恒定因素。我们还编写了一个快速的Python模拟程序，以确认我们对此工作原理的直觉。 </p><p>我们从P2C方法开始，因为我们可以在不到一天的时间内实现它。我们并没有感到失望。这是在实施2的幂平衡之前和之后，我们的压缩节点上的中位数负载和第90个百分点负载。</p><p>  通过对平衡的上述改进以及其他一些较小的调整，我们可以可靠地使用平均利用率进行自动缩放，并看到压实机可预测地对负载峰值做出反应。反过来，由于不再需要减轻负载，因此在稳定状态下，我们的平均利用率提高到了约90％，错误率降低到了接近0。</p><p>  鉴于我们对系统行为的信心日益增强，我们决定采用可抢占式VM采取更高级的自动扩展策略。</p><p> 可抢占式VM是Google提供的低成本VM，非常适合无状态的后台工作负载。虽然价格是普通VM的1/3，但价格却是可靠的：Google可以在容量有限的情况下任意终止可抢占的VM。</p><p> 以前，我们仅将可抢占式VM用于Compacter。在喜人的情况下，这很好，但是当Google终止它们时却是灾难性的。因此，我们决定完全切换到常规VM，这提高了可靠性，但价格更高。</p><p> 但是，这一次，我们希望两全其美：如果在常见情况下可以获得可抢占式VM的成本收益，而在最坏情况下获得常规VM的可靠性收益，该怎么办？</p><p> 原来，我们可以！在进行了一些研究并找到了这篇出色的文章之后，我们对节点池进行了配置，以使Kubernetes会自动尝试使用便宜的VM（如果可用），然后转而使用更昂贵的VM。 </p><p>我们在2020年1月的两周内交付了这两种优化，这使我们的紧凑型服务成本降低了近70％。重要的是，这些方法经受了时间的考验，而团队的后续行动却很少。</p><p>   我们在学习过程中吸取了一些教训，希望对团队在云中构建大规模服务有用：</p><p> 自动缩放很难正确！它需要一个高信号目标指标，可以对偏斜具有弹性。在某些情况下，您可以将自动伸缩服务放在队列前面，并根据队列长度自动伸缩。但是，当呼叫者阻塞等待结果或错误时，引入队列会给系统增加实质性的复杂性。</p><p> 怀疑平均值。始终查看百分位数或完整分布，以更好地了解您的负载。由于功率法的原因，可能有一些请求构成了整个负载的重要部分。</p><p> P2C是解决偏斜的一种非常简单的技巧。在随后的几个月中，我们将其应用于Mixpanel的其他一些计算密集型自动缩放服务，并取得了类似的成功。也就是说，这并非没有取舍。使用P2C之前，请注意以下两个警告：</p><p> 它要求所有客户合作。如果您的服务只有一个要控制的客户端，则可以确保该客户端首先检查负载并始终将请求发送到负载较小的节点。但是，如果您有很多客户端，或者您无法控制这些客户端，则无法使用。如果哪怕一个客户都不遵守2协议的功能，那么所有的赌注都将偏斜！就我们而言，现在Compacter的内部客户数量很少。我们创建了一个客户端库，其中封装了所有客户端都使用的P2C逻辑和其他便利。如果客户真正是外部客户，最好使用现成的代理/负载平衡器来路由请求（该请求本身可能在后台使用P2C！）。</p><p> 它为每个请求引入了两个额外的往返行程，以检查2个随机节点上的负载。当实际请求比较繁重（例如在我们的案例中）并且客户端-服务器的延迟可以忽略不计（例如，单个GCP区域中的内部服务）时，此开销就可以了。当请求本身很小或客户端与服务器之间的往返延迟很高时，这不是很好。 </p><p>如果您对解决基础设施难题的创新解决方案感兴趣，我们正在招聘！ 通过我们的职业页面与我们联系。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://engineering.mixpanel.com/power-of-2-choices-in-practice-b6097020dfad">https://engineering.mixpanel.com/power-of-2-choices-in-practice-b6097020dfad</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/次方/">#次方</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/choices/">#choices</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/服务/">#服务</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>