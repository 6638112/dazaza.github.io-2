<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>一行代码的更改将我们的构建时间缩短了99%</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">一行代码的更改将我们的构建时间缩短了99%</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-26 09:26:12</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/994c862af7f1fa746b1f380f0e47d743.png"><img src="http://img2.diglog.com/img/2020/10/994c862af7f1fa746b1f380f0e47d743.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Urvashi Reddy | Software Engineer, Engineering Productivity Team Adam Berry | Tech Lead, Engineering Productivity Team Rui Li | Software Engineer, Engineering Productivity Team</p><p>Urvashi Reddy|软件工程师，工程生产力团队Adam Berry|技术负责人，工程生产力团队Rui Li|软件工程师，工程生产力团队。</p><p> The Engineering Productivity team at Pinterest came across a small change that had a large impact in reducing build times across pipelines. We found that setting the refspec option during git fetch reduced our build times by 99%.</p><p>Pinterest的工程生产力团队发现了一个很小的变化，它对减少跨管道的构建时间产生了很大的影响。我们发现，在GIT获取过程中设置refspec选项可以减少99%的构建时间。</p><p> The Engineering Productivity team at Pinterest is responsible for supporting the engineers who build and deploy software at the company. Our team maintains a number of infrastructure services and often works on large scale efforts — migrating all software at Pinterest  to Bazel, creating a Continuous Delivery platform called  Hermez, and maintaining  the monorepos that get committed to a few hundred times a day, to name a few.</p><p>Pinterest的工程生产力团队负责支持在公司构建和部署软件的工程师。我们的团队维护着大量的基础设施服务，并且经常进行大规模的工作--将Pinterest的所有软件迁移到Bazel，创建名为Hermez的持续交付平台，以及维护每天致力于几百次的monorepos，仅举几例。</p><p> All our larger efforts are designed to progress on the goal of making software development and delivery at Pinterest a fast and painless experience. Recently, we were reminded of how small details can also have a large impact on that goal. We discovered an overlooked Git option that significantly reduced the build times in our continuous integration pipelines. In order to understand how this small change had such a large impact, we need to share a little information on our monorepos and our pipelines.</p><p>我们所有更大的努力都是为了实现让Pinterest的软件开发和交付成为快速而轻松的体验的目标。最近，我们被提醒，小细节也可以对这一目标产生重大影响。我们发现了一个被忽视的Git选项，它极大地缩短了持续集成管道中的构建时间。为了理解这个小小的改变是如何产生如此大的影响的，我们需要分享一些关于我们的Monorepos和我们的管道的信息。</p><p>  We have six main repositories at Pinterest: Pinboard, Optimus, Cosmos, Magnus, iOS, and Android. Each one is a monorepo and houses a large collection of language-specific services. Pinboard is as old as the company and is the largest monorepo. Pinboard has more than 350K commits and is 20GB in size when cloned fully.</p><p>我们在Pinterest上有六个主要的存储库：插接板、擎天柱、Cosmos、Magnus、iOS和Android。每一个都是一个Monorepo，并包含大量特定于语言的服务集合。插接板和公司一样古老，也是最大的单回购。插接板有超过350K的提交，完全克隆时大小为20 GB。</p><p> Cloning monorepos that have a lot of code and history is time consuming, and we need to do it frequently throughout the day in our continuous integration pipelines. For Pinboard alone, we do more than 60K git pulls on business days. Most of our Jenkins pipeline configuration scripts (written in Groovy) start with a “Checkout” stage where we clone the repository that the later stages will build and test. Here’s what a typical “Checkout” stage looks like:</p><p>克隆具有大量代码和历史记录的monorepos非常耗时，而且我们需要在我们的持续集成管道中全天频繁地这样做。仅对于插接板，我们在工作日就做了超过60K的GIT拉动。我们的大多数Jenkins管道配置脚本(用Groovy编写)都从“签出”阶段开始，在此阶段我们克隆稍后阶段将构建和测试的存储库。下面是典型的“结账”阶段：</p><p>     Even though we’re telling Git to do a shallow clone, to not fetch any tags, and to fetch the last 50 commits, we’re still not running this operation as fast as we could be. That’s because we aren’t setting  the refspec option. Notice that by not setting it in the pipeline configuration script, we’re telling Git to fetch all refspecs:  +refs/heads/*:refs/remotes/origin/*. In the case of Pinboard, that operation would be fetching more than 2,500 branches.</p><p>即使我们告诉Git进行浅层克隆，不要获取任何标记，并获取最后50个提交，我们仍然没有尽可能快地运行此操作。这是因为我们没有设置refspec选项。注意，通过不在管道配置脚本中设置它，我们告诉Git获取所有refspecs：+refs/head/*：refs/remotes/Origin/*。在插接板的情况下，该操作将获取超过2500个分支。</p><p> By simply adding the refspec option and specifying which refs we care about (master, in our case), we can limit the refs to the branch we care about and save a lot of time. Here’s what that looks like in our pipeline code:</p><p>只需添加refspec选项并指定我们关心的引用(在本例中为master)，我们就可以将引用限制在我们关心的分支上，从而节省大量时间。下面是我们的管道代码中的内容：</p><p>  This simple one line change reduced our clone times by 99% and significantly reduced our build times as a result. Cloning our largest repo, Pinboard went from 40 minutes to 30 seconds. It goes to show that sometimes our small efforts can have a big impact as well.</p><p>这一简单的一行更改将我们的克隆时间减少了99%，并因此显著减少了我们的构建时间。复制了我们最大的回购，插接板从40分钟缩短到了30秒。这表明，有时候我们的小小努力也能产生很大的影响。</p><p>  Like most developer productivity teams, we work on large services that have a big impact on our day-to-day experience. However, it’s sometimes the one line fixes that can make a huge difference. Our work is about understanding that.</p><p>像大多数开发人员生产力团队一样，我们从事对我们的日常体验有很大影响的大型服务。然而，有时仅仅是一行修复就可以产生巨大的不同。我们的工作就是理解这一点。</p><p> If you have a passion for improving developer productivity, join our team! We’re hiring for engineering roles on our Engineering Productivity team.</p><p>如果您热衷于提高开发人员的工作效率，请加入我们的团队！我们正在招聘我们工程生产力团队的工程师职位。</p><p> To learn more about Engineering at Pinterest, check out our   Engineering Blog , and visit our   Pinterest Labs  site. To view and apply to open opportunities, visit our   Careers  page.</p><p>要了解有关Pinterest工程的更多信息，请查看我们的工程博客，并访问我们的Pinterest实验室网站。要查看和申请空缺机会，请访问我们的职业页面。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://medium.com/pinterest-engineering/how-a-one-line-change-decreased-our-build-times-by-99-b98453265370">https://medium.com/pinterest-engineering/how-a-one-line-change-decreased-our-build-times-by-99-b98453265370</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/代码/">#代码</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/更改/">#更改</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/change/">#change</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/pinterest/">#pinterest</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1031143.html"><img src="http://img2.diglog.com/img/2020/10/thumb_facaf186d4360c6b00d57586f53e5cf6.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031143.html">“30行代码是如何炸毁一台27吨重的发电机的”</a></div><span class="my_story_list_date">2020-10-26 6:56</span></div><div class="col-sm"><div><a target="_blank" href="/story/1031097.html"><img src="http://img2.diglog.com/img/2020/10/thumb_c3efa904682e069f89569fb53a11a7f2.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031097.html">为您的开发团队创建有效的教程</a></div><span class="my_story_list_date">2020-10-25 23:2</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030971.html"><img src="http://img2.diglog.com/img/2020/10/thumb_30361bf1ca7809ca30d3b13b305aaa67.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030971.html">Adobe XD for Visual Studio代码</a></div><span class="my_story_list_date">2020-10-25 3:7</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030799.html"><img src="http://img2.diglog.com/img/2020/10/thumb_d45451e0f71b872780c4d5648f5ab3ac.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030799.html">Rust-GPU：使Rust成为GPU代码的一流语言和生态系统</a></div><span class="my_story_list_date">2020-10-24 7:20</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>