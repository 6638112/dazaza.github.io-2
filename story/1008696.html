<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>在Raspberry PI 4上启动Linux的历险</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">在Raspberry PI 4上启动Linux的历险</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-28 15:09:11</div><div class="page_narrow text-break page_content"><p>Linux raspberry pi大约在两个月前，我开始为我正在进行的一个项目构建一个四节点的Raspberry pI4集群。找出在每个节点上安装Linux的最佳方法让我陷入困境，接下来的四周我都在刮牦牛胡子。</p><p>引导PI最常见的方式是从SD卡启动。但是它们又慢又不可靠--我不喜欢它们。某些型号的PI 2和PI 3支持从USB存储启动，但PI 4还不能这样做。因此，我不得不为每个PI使用SD卡。或者我是这样想的。</p><p>原来，Raspberry PI 2和3也支持网络引导。去年年底发布了支持PXE for PI 4的测试版固件。我在LinuxHit上找到了一篇文章，详细介绍了安装固件和设置网络引导的过程。</p><p>为了测试这一点，我在其中一个PI上更新了固件并配置了PXE服务器。我尝试通过网络和…启动另一个PI。成功了！以下是PXE服务器设置过程的要点：</p><p>将/boot和/的其余内容复制到本地文件系统上的单独文件夹中。我将我的文件分别复制到/tftp/raspbian-boot和/nfs/raspbian-root。</p><p>我不能从相同的引导和根文件系统引导所有三个节点，因为它们不是只读的。我不想为每个节点维护这些文件的副本。但这是一个已解决的问题-Docker已经允许您从单个基础映像启动多个容器。因此，我将按照Docker的做法-使用raspbian-root和raspbian-boot作为我的下层目录，为每个节点创建OverlayFS。我会像以前一样通过NFS分享它们。</p><p>其中一个节点的配置如下所示。其他两个节点遵循相同的模式。注意，我将raspbian-root和raspbian-boot移到了USB硬盘驱动器(挂载在/mnt)，以获得更好的读/写性能。DC-a6-32-XX-XX-XX是节点的MAC地址。我在dnsmasq中使用tftp-ique-root=mac选项，根据每个节点的MAC地址为其维护单独的引导环境。</p><p>$mount-t overlay nog-boot-o lowerdir=/mnt/raspbian-boot，upperdir=/mnt/up/nog-boot，workdir=/mnt/work/nog-boot-o nfs_export=on-o index=on-o redirect_dir=noollow/tftpboot/dc-a6-32-XX-XX-XX$mount-t overlay nog-root-o lowerdir=/mnt/R。workdir=/mnt/work/nog-root-o nfs_export=on-o index=on-o redirect_dir=NOFLOW/nfs/nog$cat/tftpboot/dc-a6-32-XX-XX-XX/cmdline.txtconsole=序列0,115200控制台=tty1root=/dev/nfs nfsroot=&lt；IP地址&gt；：/nfs/nog，vers=4.1，proto=TCP rw IP=dhcp rootwait level=Deadline</p><p>(如果您想知道nog是什么：我以星球大战宇宙中的行星命名我的服务器。遵循这一传统，我将Pis Mandalore(PXE服务器)命名为Nog、Ordo和Werda)。</p><p>NFS和OverlayFS彼此并不友好。在一个周末试图解决一些奇怪的问题后，我放弃了。</p><p>但是OverlayFS不是唯一存在的写入时拷贝文件系统，不是吗？ZFS和BTRFS提供我可以使用的子卷和快照。但在此之前，我拖延了两个星期，决定用哪一个。</p><p>计划很简单：我将分别为raspbian-root和raspbian-boot创建一个子卷。然后，我将为每个子卷创建三个快照-每个节点一个快照。我在外部驱动器上创建了一个btrfs文件系统，并运行以下命令。</p><p>$btrfs子卷创建raspbian-root$btrfs子卷为每个节点创建raspbian-boot#根据需要更改文件夹名称$btrfs子卷快照raspbian-boot nog-boot$btrfs子卷快照raspbian-root nog-root$mount--bind/mnt/nog-boot/tftpboot/DC-a6-32-XX-XX-XX$mount--bind/mnt/nog-root/nfs/nog#Don。：/nfs/nog，vers=4.1，proto=tcp rw ip=dhcp rootwait level=Deadline。</p><p>嗯，这招奏效了！我在没有SD卡的情况下运行PI！！现在，我需要做的就是创建systemd单元文件来启动所有需要的服务并挂载快照。我终于可以开始做我的项目了。</p><p>等一下。仔细查看cat/tftpboot/dc-a6-32-XX-XX-XX/cmdline.txt的输出。如果您和我一样，您将第一次意识到，此文件中的root=定义将从何处挂载根文件系统。现在，我们告诉它从/dev/nfs挂载。如果我连接一个外部驱动器并将root=设置为指向该外部驱动器，该怎么办？</p><p>RPI 4不能直接从USB驱动器启动。与中一样-开机时无法在USB驱动器上找到/引导。但是，如果我们使用cmdline.txt提供/boot，并使用cmdline.txt从USB驱动器挂载/引导，会怎么样呢？测试时间到了。</p><p>我将raspbian-root复制到USB驱动器，编辑fstab以挂载/使用分区的PARTUUID，并将其连接到Nog。然后我更新了/tftpboot/dc-a6-32-XX-XX-XX/cmdline.txt的内容。</p><p>在几次重启之后，它起作用了！我现在有一个运行在USB硬盘上的RPI 4！</p><p>让我们从我要找的东西开始吧。我只想不要处理SD卡，因为它们速度慢，不可靠。可靠性是相对的-一切都会在某个时候失败。但是一个质量不错的USB硬盘可能会比SD卡更耐用。因此，让我们只看一些读/写性能数据，看看它们之间的比较。</p><p>$sync；dd if=/dev/Zero of=twogefile bs=1M count=2048；sync#写入性能$sudo sh-c&#34；sync&amp；&amp；echo 3&gt；/proc/sys/vm/drop_caches&#34；$dd if=twogefile of=/dev/null bs=1M count=2048#读取性能。</p><p>通过网络引导，我能够获得类似于10类SD卡的读写速度。请注意，引导映像托管在连接到Mandalore(PXE服务器)的USB硬盘驱动器上。NFS似乎是这里的瓶颈-硬盘驱动器的原始读/写速度比这个要好得多。所有PI都连接到Netkit的8端口千兆以太网交换机。</p><p>不足为奇的是，当PI使用USB硬盘时，情况会有相当大的改善。请注意，我使用的外置驱动器是从非常旧的MacBook改装而来的5400rpm硬盘。我在易趣上花了10美元买的。YMMV。</p><p>现在，我让Mandalore从SD卡引导和/或从USB硬盘挂载。Nog、Ordo和Werda通过网络从Mandalore获取/引导和/或从USB硬盘挂载。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.mostlypointless.dev/posts/net-boot-rpi/">https://blog.mostlypointless.dev/posts/net-boot-rpi/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/启动/">#启动</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/booting/">#booting</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/nog/">#nog</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1008644.html"><img src="http://img.diglog.com/img/2020/6/thumb_b37af4f24ba713f8155fd205563e941a.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008644.html">针对电池续航时间和性能优化Linux笔记本电脑的广泛指南</a></div><span class="my_story_list_date">2020-6-28 3:52</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008000.html"><img src="http://img.diglog.com/img/2020/6/thumb_becf6dbf1e8f7269202376a0efd6ae18.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008000.html">Linux是Microsoft Azure中最常用的操作系统</a></div><span class="my_story_list_date">2020-6-25 2:18</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007957.html"><img src="http://img.diglog.com/img/2020/6/thumb_956927c6f3231e35eab9f9bd7dfdb666.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007957.html">微软正在为Windows添加Linux、Android和固件保护</a></div><span class="my_story_list_date">2020-6-24 21:20</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007946.html"><img src="http://img.diglog.com/img/2020/6/thumb_0bf31ddcada5885846190d01b95ee5fa.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007946.html">微软为Linux和Android做好杀毒准备</a></div><span class="my_story_list_date">2020-6-24 16:29</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>