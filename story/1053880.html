<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>更新50 Terabyte PostgreSQL数据库 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">更新50 Terabyte PostgreSQL数据库 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-22 08:43:21</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/3/c164e7fa6014bd77b15fc0af3429c425.jpeg"><img src="http://img2.diglog.com/img/2021/3/c164e7fa6014bd77b15fc0af3429c425.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>由于一些原因，我们在Adyen的数据库设置是唯一的。我们目前在多个集群中处理每秒5,000+ PostgreSQL事务。此外，作为处理敏感的财务数据的付款服务提供商，冗余比正常更为关键，并且停机是不可接受的。</p><p>  最重要的是，我们以快速的速度缩放我们的基础架构。 2015年，我们的数据库低于10岁。但我们最新的升级为50岁，仍然快速增长。随着全球数字付款卷预计到2020年，我们需要达到超过7000亿美元的年度交易，我们需要考虑比现在更大的卷。</p><p> 在这篇文章中，我将了解Adyen的不断发展的方法来更新我们的PostgreSQL数据库，以防止冗余，正常运行时间和可扩展性提出的要求和挑战。</p><p>  我的同事Michiel在选择解决方案时，我们如何在我们如何在选择“无情”时写道。我们做出了仔细决定，为解决方案的可靠性以及生态系统（支持，社区，文档等）的可靠性以及功能的成熟。我们使用PostgreSQL构建了数据库堆栈，因为它提供了我们需要的一致性，隔离和可靠性。此外，它是开放的来源，并拥有有源生态系统，包括多个支持和咨询公司。最后，当我们使用敏感的财务数据时，具有交易数据库的关键，因为它确保我们不会失去记录。</p><p>  我们的PostgreSQL数据库群集包括一个主服务器和至少三个从服务器，传播多个数据中心。数据库服务器是双插座机，具有768 GB的RAM。每个服务器都使用光纤通道或iSCSI连接到自己的共享存储设备，并具有150多个Tberytes的SSD和平均压缩比为1：6的原始容量。</p><p> 另一个详细信息要注意的是，我们以这样的方式构建了软件架构，即我们可以将流量停止到我们的PostgreSQL数据库，队列事务，并在不影响付款接受的情况下运行PostgreSQL更新。</p><p>  最近作为2015年，我们的数据库需求更加简单。我们升级到新PostgreSQL版本的方法遵循以下步骤： </p><p>1.牺牲奴隶服务器。 2.将从站升级到新PostgreSQL版本。 3.使用镶嵌设置数据库的逻辑复制。 4.切换镶嵌主人。 5.将其他两个从站升级到新版本。 6.取下逻辑复制。 7.将上次从站升级到新版本。</p><p> 在10岁的时候，我们花了几天时间在我们获得新的服务器上运行，而且这个过程正在变得逐渐变得更加耗时。此外，我们可以在长期内预见到卫生的潜在影响，因为在该过程中某些点处于处分奴隶而处死。在地平线上有一个50tbybyte数据库，所需的时间长度以及冗余的潜在风险开始变得不可接受。</p><p>  到9.6的时间被释放，我们需要更聪明，更可扩展的解决方案。实际上，我们的选择有限。由于我上面概述的原因，继续持续逻辑复制是不可能的。 PostgreSQL透视图中唯一的其他选项是在主设备上运行pg_upgrade。但是，这意味着您只有一个大师，这也是冗余视角的不可接受的情况。</p><p> 由于PostgreSQL选项不适合下一次升级，并行我们认为其他可能性。我们的存储设备能够在更小的时间范围内通过网络进行即时快照，并在远程存储设备上可用。我们开始结合选项，最终，我们的解决方案涉及以下步骤：</p><p>  1.停止数据库群集的流量。 2.使用脚本在主服务器上运行PostgreSQL升级，以便尽可能多的步骤自动化。这种方法的优点是加快过程，使其轻松可重复。 （3-5分钟）3。停止升级的主机上的PostgreSQL并创建卷的快照。 （最多10分钟）4.将升级的主的快照复制到从站的存储设备。 （2-5分钟）5。重新启动主人。 6.将快照导入从服务器，在从服务器上安装（已升级的）主卷。 7.通过简单地放入正确的recovery.conf文件，将Slave Server重新连接到主站。 8.只有在线，连接和最新的站点至少有两个从站，我们允许再次访问群集。因此，在访问群集时从来没有瞬间，在线少于两个从头开始。 9.再次启动软件。</p><p> 然后需要在所有集群中重复该过程。完全，该过程需要一天，包括准备工作。</p><p>  1.一旦设置了，它就会相对容易，因为某些测试运行并编写脚本，可以自动执行许多步骤。 2.它非常快，因为后续快照只有原件的差异。实际上，要复制快照只需几分钟。 3.它符合我们对冗余的要求。在我们开始升级之前，我们会制作所有服务器的快照。如果升级在某些时候会失败，我们可以简单地恢复到旧快照。这意味着我们可能会失去一个小时的时间，但我们不会丢失任何数据或妥协冗余。 </p><p>我们的新方法的美丽是，通过使用具有增加的容量的存储设备，通过添加更多群集和垂直地，可以继续无限制地缩放。  事实上，我们在过去一年中的活群数量增加了一倍，我们的最大群集已经长大到了74磅。 今年年晚些时候，我们期待着使用这种方法来更新到PostgreSQL 10.3+，没有任何与先前方法相关的头痛。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://medium.com/adyen/updating-a-50-terabyte-postgresql-database-f64384b799e7">https://medium.com/adyen/updating-a-50-terabyte-postgresql-database-f64384b799e7</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/database/">#database</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/数据库/">#数据库</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1053059.html"><img src="http://img2.diglog.com/img/2021/3/thumb_fdef45a26a7bbf9e154c9c9a42d2431e.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1053059.html">已经数十年了。 为什么数据库不管理自己？ </a></div><span class="my_story_list_date">2021-3-18 3:34</span></div><div class="col-sm"><div><a target="_blank" href="/story/1052814.html"><img src="http://img2.diglog.com/img/2021/3/thumb_b402ccc994da6d13d423296a5ec7eee1.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1052814.html">与prisma迁移的无障碍数据库迁移 </a></div><span class="my_story_list_date">2021-3-17 3:22</span></div><div class="col-sm"><div><a target="_blank" href="/story/1052586.html"><img src="http://img2.diglog.com/img/2021/3/thumb_4180f04677e0daf4014168f95ce14bc4.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1052586.html">Ciner用户将很快能够访问背景检查数据库 </a></div><span class="my_story_list_date">2021-3-16 5:48</span></div><div class="col-sm"><div><a target="_blank" href="/story/1052511.html"><img src="http://img2.diglog.com/img/2021/3/thumb_9b07e4b4e55f4059a03439e5010b7fe9.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1052511.html">低码数据库服务空气可通过Greenoaks Capital达到5.77亿美元的估值，以$ 5.777估价为3777亿美元，比去年为2.5亿美元估值 </a></div><span class="my_story_list_date">2021-3-15 23:26</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>