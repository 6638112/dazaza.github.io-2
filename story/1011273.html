<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>可移植的C库，支持易于使用的异步事件循环和协同程序</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">可移植的C库，支持易于使用的异步事件循环和协同程序</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-12 06:36:30</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/7/f1785908a9aac49cabbff329367644cb.png"><img src="http://img.diglog.com/img/2020/7/f1785908a9aac49cabbff329367644cb.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>灵感来自python中的协议线程、async.h、coroutines.h和异步/等待。这是基于Duff设备的C的异步/等待/法等待/事件循环实现。</p><p>它为每个状态使用96字节的内存，但为您提供了无缝嵌套能力、错误处理和堆栈管理。</p><p>它比其他实现更容易理解，因为异步状态/堆栈管理完全由lib处理。</p><p>您不能跨函数调用保留局部变量，但库提供了一种持久存储它们的方法(请参阅实践)。</p><p>使用async_new创建新的coro时，类型表示为空函数堆栈(局部变量)，对于char，则为tydeff。</p><p>阻塞并运行事件循环，直到main_coro完成。可以调用任意次以保留未完成的任务状态，如果退出后没有获得所有权，则释放main_coro。</p><p>在不阻塞当前进度的情况下将任务添加到事件循环，返回NULL并在失败时释放CORO。</p><p>在不阻塞当前进度的情况下将n个任务从状态数组添加到事件循环中，如果其中一个CORO为NULL或如果没有足够的内存添加它们，则不执行任何操作并返回NULL</p><p>将任务添加到事件循环并阻止进度，直到coro执行完毕。如果取消了CORO任务，则设置ASSYNC_ERRNO：ASSYNC_ECANCELED；如果没有足够的内存来创建任务，则设置ASYNC_ENOMEM并释放CORO；否则设置任何自定义错误代码，否则设置为ASYNC_OK。仅当CORO设置ASSYNC_ERRNO时，花括号内的代码才会执行，ASSYNC_ERRNO==ASYNC_OK上的花括号将被忽略。</p><p>从Function(Function必须遵循AsyncCallback签名)返回一个新的CORO，其参数和堆栈内存能够保存传递给T_LOCALS的类型：INT、STRUT、ARRAY、CUSTOM TYPE或ASYNC_NONE(如果根本不需要堆栈内存。</p><p>将几个CORO集合在一起，将它们并行运行成单个CORO，然后将其返回。如果Gather()被取消，则所有提交的CORO(尚未完成)也将被取消。</p><p>Async_Gather的各种版本，期望直接传递COROS(不需要在失败时清除它们)。</p><p>块执行延迟秒，精度因平台而异，但您可以在需要时使用不可移植的计时器轻松提供自己的实现。</p><p>等待CORO完成并超时。否则取消，并将ASSYNC_ERRO设置为ASYNC_ECANCELED。</p><p>使用async_alloc分配的空闲PTR无需等待事件循环为您执行此操作。在长时间运行的任务中可能很有用，但无论如何，带取消功能的malloc更可取，速度也更快。</p><p>如果内存块已成功排队并将在稍后由事件循环释放，则返回TRUE</p><p>取消当前的CORO。请注意，如果coro操作一些未使用async_alloc分配的自定义内存，则会导致内存泄漏。</p><p>为当前异步函数设置取消时要调用的取消函数。CANCEL_FUNC必须跟在AsyncCancelCallback类型签名之后。</p><p>也可以指定展开为当前异步函数的Async_Err类型的值的宏。</p><p>在手动处理状态或创建自定义事件循环之前，不应手动使用coro的空闲内存，忽略NULL。</p><p>未来的一些API方法可能会使用su_state作为输入coro类型，明确表示它窃取了当前所有权，在这种情况下，用户必须访问传递给s_astate对象的权限，或者在将所有权转移给该方法之前再次手动执行INCREF所有权。</p><p>将coro标记为当前正在使用的&#34；，这样它就不会被自动删除。在Async Function/Cancel Function&#34；中，后面必须跟ASYNC_DECREF。</p><p>将coro标记为不再使用。请注意，如果其他函数也在此coro上使用INCREF，则不会立即删除它。</p><p>准备适配器功能，不为ARG分配内存，以防分配错误时转到err_label；</p><p>使用ASYNC_NEW创建新协程时，将指向值的指针作为参数传递。然后赋值给函数体内的指针：</p><p>Async f(State){async_egin(State)；int*res=state-&gt；args；/*args这里是指向int a的指针(可以是指向任何c对象的指针)*/*res=42；.}.。int a；fawait(async_new(f，&amp；a，ASYNC_NONE)){printf(&#34；错误%s发生\n&#34；，async_strerror(Async_Errno))；}。</p><p>如果我们想要多个不同类型的返回值，我们可以用例如struct*替换int*。任何类型指针都可以。</p><p>只需创建一个包含所有所需变量的struct，然后在创建新coro时将struct作为类型传递。请参见下面的examples/example.c和简短示例。</p><p>#include&lt；stdio.h&gt；#include&#34；async2.h&#34；struct amain_stack{int i；}；async amain(S_Astate State){struct amain_stack*locals=state-&gt；locals=state-&gt；args；async_egin(State)；/*注意，本地变量-&gt；i赋值为0是在异步内部进行的。*不要将它们分配到外部！*/for(locals-&gt；i=0；locals-&gt；i&lt；3；locals-&gt；i++){printf(&#34；TASK%s：Iteration№%d\n&34；，args，locals-&gt；i+1)；/*让其他任务正常运行。与python类似，等待asyncio.sleep(0)使用。*/异步屈服；}异步结束；}int main(Void){struct async_event_loop*loop=async_get_event_loop()；loop-&gt；init()；async_create_task(async_new(amain，&#34；task 1&#34；，struct amain_stack))；/*分配足够的内存来保存类型为struct amain_stack*/async_create_task的本地变量。，struct amain_stack))；Loop-&gt；Run_Foreve()；Loop-&gt；Destroy()；}。</p><p>faWait(Async_Func(10)){if(Async_errno==ASYNC_ENOMEM){/*处理内存错误.。*/}}否则{/*协程已完成，没有错误*/}。</p><p>本地变量-&gt；task=Async_CREATE_TASK(coro())；ASYNC_XINCREF(本地变量-&gt；task)；/*获取任务的所有权，使其不会在完成后立即删除*//*执行.。*/IF(LOCALS-&&gt;TASK){AWAIT(Async_DONE(LOCALS-&&gt;TASK))；IF(LOCALS-&gT；TASK；ERR！=ASYNC_OK){/*手动处理任务错误*/}}ASYNC_XDECREF(LOCALS-&&gt;TASK)；</p><p>总是用Asyncio_Slear或Asyncio_Wait_For这样的方式包装协程，这样它们的使用就会非常简单(在它们准备时不需要在它们上使用Async_new)，这样您就可以提供可以接受任何参数的自定义异步函数，但是返回类型仍将被限制为s_astate。ASSYNC_PREPARE和ASYNC_PREPARE_NOARGS对于这样的函数包装非常有帮助。</p><p>使用基础dev方法如async_new_coro_和async_alloc_，以克服创建异步函数时的用户空间限制。</p><p>始终使用所有权包装所有使用的任务，否则有可能获得无效的指针访问。记住：一个INCREF-一个DECREF。</p><p>为您的友好方法提供取消功能，这样即使取消的功能也不会破坏所有权和CORO将被正确删除。</p><p>与协议线程一样，您必须非常小心地使用异步子例程中的switch语句和手动创建的局部变量(未存储在局部变量中的变量)。一般来说，最好避开它们。</p><p>与协议线程一样，您不能进行阻塞系统调用并保留异步语义。必须将这些更改为符合条件的非阻塞调用。</p><p>您不能在等待期间使用setjump和long jump函数，因为async2改变了通常的函数流，所以给定的代码很好：</p><p>这意味着您无法使用像Exceptions4c这样的C异常库来包装faWait或await或产生调用，而应使用async_errno和faWait花括号。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://github.com/Wirtos/async2.h">https://github.com/Wirtos/async2.h</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/循环/">#循环</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/library/">#library</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/async/">#async</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1011194.html"><img src="http://img.diglog.com/img/2020/7/thumb_0eee7cd84dcc8ac825efebcc405ed526.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1011194.html">
本周在应用程序方面：美国考虑TikTok禁令，应用程序第二季度创历史新高，iOS 14公开测试版到来</a></div><span class="my_story_list_date">2020-7-11 22:29</span></div><div class="col-sm"><div><a target="_blank" href="/story/1011137.html"><img src="http://img.diglog.com/img/2020/7/thumb_5cbfa9779643c240f49cc7334869527a.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1011137.html">微软详细介绍了它如何与谷歌合作，帮助开发者将他们的渐进式网络应用程序放入Play Store</a></div><span class="my_story_list_date">2020-7-11 11:12</span></div><div class="col-sm"><div><a target="_blank" href="/story/1011132.html"><img src="http://img.diglog.com/img/2020/7/thumb_06b0838e46023daa4ccdd4ad0594ef9c.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1011132.html">印度最高法院裁定，允许通过WhatsApp和Telegram等即时通讯应用程序以及电子邮件送达传票和法律通知</a></div><span class="my_story_list_date">2020-7-11 10:3</span></div><div class="col-sm"><div><a target="_blank" href="/story/1011041.html"><img src="http://img.diglog.com/img/2020/7/thumb_a4b6eb2a3238d6942222dc207e5fbaf3.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1011041.html">
边缘推销每月购买应用程序和订阅的津贴，作为最新的员工福利</a></div><span class="my_story_list_date">2020-7-11 0:51</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>