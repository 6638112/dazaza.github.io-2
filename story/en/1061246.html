<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>优化700 CPU远离生锈 Optimizing 700 CPUs Away with Rust</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Optimizing 700 CPUs Away with Rust<br/>优化700 CPU远离生锈 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-05-07 13:33:06</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/5/796a35c01e75fd4cc1dc7fc969701a98.png"><img src="http://img2.diglog.com/img/2021/5/796a35c01e75fd4cc1dc7fc969701a98.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>In Tenable.io, we are heavy users of Datadog custom metrics. Millions of metrics are sent through  Dogstatsd, providing deep insights into the complex platform. As the platform grew, we found that a significant number of metrics sent by legacy apps were obsolete. We tried to hunt down these obsoleted metrics in the codebase, but modifying legacy applications was extremely time consuming and risky.</p><p>在Tenable.io中，我们是DataDog自定义指标的沉重用户。通过Dogstatsd发送数百万度量，在复杂的平台上提供深刻的见解。随着平台的增长，我们发现遗留应用程序发送的大量指标已过时。我们试图在Codebase中追捕这些已经过量的指标，但修改遗留应用程序非常耗时和危险。</p><p> To address this, we deployed a  StatsD filter as a  Datadog agent  sidecar to filter out unnecessary metrics. The filter is a simple UDP datagram forwarder written in Node.js ( sample, not actual code). We chose Node.js because in our environment, its network performance outstripped other languages that equalled its speed to production. We were able to implement, test and deploy this change across all of the T.io platform within a week.</p><p> 要解决此问题，我们将一个Statsd Filter部署为DataDog代理Sidecar以过滤掉不必要的指标。过滤器是在Node.js中写入的简单UDP数据报转发器（示例，而不是实际代码）。我们选择了node.js因为在我们的环境中，其网络性能超越了其他语言，这些语言将其速度等于生产。我们能够在一周内在所有T.IO平台上实施，测试和部署此更改。</p><p>  While this worked for many months, performance issues began to crop up. As the platform continued to scale up, we were sending more and more metrics through the filter. During the first quarter of 2021, we added over 1.4 million new metrics as an effort to improve our observability. The filters needed more CPU resources to keep up with the new metrics. At this scale, even a minor inefficiency can lead to large wastage. Over time, we were consuming over  1000 CPUs and  400GB of memory on these filters. The overhead had become unacceptable.</p><p>  虽然这是多个月的工作，但绩效问题开始播出。由于平台继续扩大，我们通过过滤器发送越来越多的指标。在2021年的第一季度，我们增加了超过140万元的新指标，以提高我们的可观察性。过滤器需要更多CPU资源来跟上新的指标。在这种规模中，即使是轻微的低效率也会导致大量浪费。随着时间的推移，我们在这些过滤器上消耗了超过1000ccus和400gb的内存。开销已经变得不可接受。</p><p> We analyzed the performance metrics and decided to rewrite the filter in a more efficient language. We chose Rust for its high performance and safety characteristics. (See our other post on  Rust evaluations) The source code of the new Rust-based filter is available  here.</p><p> 我们分析了性能指标，并决定以更有效的语言重写过滤器。我们选择了RUDER以其高性能和安全特性。 （请参阅生锈评估的其他帖子）此处可提供新的基于RUST的过滤器的源代码。</p><p> The Rust-based filter is much more efficient than the original implementation. With the ability to fully manage the heap allocations, Rust’s memory allocation for handling each datagram is kept to a minimum. This means that the Rust-based filter only needs a few MB of memory to operate. As a result, we saw a 75% reduction in CPU usage and a 95% reduction in memory usage in production.</p><p> 基于RUST的滤波器比原始实现更有效。通过完全管理堆分配的能力，RUST的处理每个数据报的内存分配保持最小。这意味着基于RUST的过滤器只需要几MB的内存来操作。因此，我们的CPU使用率降低了75％，并且生产中的内存使用率降低了95％。</p><p>   In addition to reclaiming compute resources, the latency per packet has also dropped by over 50%. While latency isn’t a key performance indicator for this application, it is rewarding to see that we are running twice as fast for a fraction of the resources.</p><p>   除了回收计算资源外，每个数据包的延迟还丢弃超过50％。虽然延迟不是此应用程序的关键性能指示符，但它有助于看到我们正在运行两倍，以便为资源的一小部分运行。</p><p>  With this small change, we were able to optimize away over  700 CPU and  300GB of memory. This was all implemented, tested and deployed in a single sprint (two weeks). Once the new filter was deployed, we were able to confirm the resource reduction in Datadog metrics.</p><p>  通过这种小变化，我们能够优化700多个CPU和300GB的内存。这一切都实施，测试和部署在单个冲刺（两周）。部署新过滤器后，我们能够确认DataDog指标的资源减少。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://medium.com/tenable-techblog/optimizing-700-cpus-away-with-rust-dc7a000dbdb2">https://medium.com/tenable-techblog/optimizing-700-cpus-away-with-rust-dc7a000dbdb2</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/远离/">#远离</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/cpus/">#cpus</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/过滤器/">#过滤器</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>