<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>2020年的出货常量泛型</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">2020年的出货常量泛型</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-16 23:27:31</div><div class="page_narrow text-break page_content"><p>很难相信，自从我开通RFC2000以来，已经有3年多的时间了，它定义了Rust的常量泛型。同时，阅读RFC线程，这一领域也发生了巨大的变化：首先，在编写RFC的时候，const FNS是不稳定的，而且const甚至还没有使用MIRI进行评估。多年来，关于const泛型特性已经做了很多工作，但是仍然没有发布。然而，我认为我们已经定义了一个非常有用的常量泛型子集，该子集足够稳定，可以在短期内发布。</p><p>对于那些不知道的人来说，常量泛型指的是常量值的泛型，而不是类型。这允许通过例如特定整数值来参数化类型。不稳定的Rust，只有特殊的数组类型-[T；N]-有一个常量参数(数组的长度)，没有办法对所有的N值进行抽象，即使对于数组也是如此。常量泛型将允许创建由值参数化的新类型，以及实现在这些值上抽象的特征和函数。例如：</p><p>//这是一个自定义类型，由`usize`pub struct foo&lt；const N：usize&gt；{bytes：[U8；N]，}参数化；//这是一个已经针对//任意长度的数组实现的特征。实施[T；N]的调试，常量N：usize&gt；调试(&L；T){}。</p><p>一年多来，我们一直使用常量泛型特性来实现数组的特征，人为地将实现限制在长度为32的数组上。我们计划在即将发布的版本中取消这一限制。通过稳定常量泛型，我们可以开始允许外部板条箱实现所有数组的特征，以及许多其他有趣的用例。然而，这将有两个重要的限制。</p><p>const泛型可以具有的初始类型将仅限于整数基元类型，即有符号和无符号整数类型、布尔值和字符。目前，不允许使用复合类型或用户定义的类型，也不允许引用(意味着也不允许使用字符串)。这是当前实现的一个相对容易修复的缺点，并且构造泛型的用户定义类型将在近期而不是更长的时间内成为可能。</p><p>我想提一下，因为很多人没有意识到这一点，即使撇开rustc目前的限制不谈，也不是任何类型都可以用作const参数。重要的是，为了使Rust的类型系统健全，两个类型之间的相等必须是确定性的、自反性的、对称的，等等。也就是说，如果您的自定义类型通过掷硬币来实现相等，则该类型的两个值有时相等，有时不相等。这意味着，由这些值参数化的两个类型有时是相同的类型，有时是不同的类型，这会给类型系统带来相当大的麻烦。</p><p>(作为一个具体的例子，浮点数带来了挑战，例如，foo&lt；nan&gt；不会被认为是与其本身相同的类型，因为NaN不等于它自己。)。</p><p>这个问题的长期解决方案是“结构相等”的概念，它是严格正确的EQ类型子集，满足在类型系统中使用所需的属性。在实现匹配时，Rust已经使用了此结构相等属性。如果为您的类型及其所有成员派生Eq和PartialEq，则它应该满足不匹配和常量泛型所需的结构相等属性。</p><p>另一个限制是只能使用两种表达式来填充常量泛型位置：</p><p>常量泛型参数。例如，在引入了常量泛型的Imp&lt；const N：usize&gt；中，可以按字面意思使用该值填充常量泛型。</p><p>可以在不依赖于任何类型或常量参数的常量上下文中使用的表达式。这意味着文字、数学公式、使用常量、调用常量FN等，只要不涉及自由泛型。</p><p>这限制了用户想要使用const泛型做的许多更奇特、更有趣的事情，例如，您不能将两个数组长度组合在一起以形成类型为[T；N+M]的数组，甚至不能使用[T；N*2]将数组长度加倍。基本上不能有依赖于计算的类型，而计算依赖于其他泛型。正确合理地实现这一行为确实是实现常量泛型的难点，虽然工作正在进行，但还没有准备好。</p><p>这也意味着常量泛型不能基于关联的类型、关联的常量或泛型方法填充。没有返回[U8；mem：：size_of：：&lt；T&gt；()]的函数，没有使用Self Like[U8；Self：：Len]等。</p><p>这将意味着，例如，像加密散列特征这样的用例，允许每个实现为它们输出的散列指定不同的长度，仍然不在MVP的范围之内。这很可惜，但是这个功能最终还是会实现的。</p><p>所有这些限制听起来似乎功能相当有限，但我认为一旦用户能够使用它，就会发现很多真正强大的用例。首先，今天可能只由某些数组类型实现的特征，或者根本不实现的特征，将开始由所有数组实现，从而使数组成为语言中更为重要的一部分。我们已经找到了很棒的用例。请看此代码示例。</p><p>设data=[1，2，3，4，5，6]；设sum1=data。array_chunks()。贴图(|&amp；[x，y]|x*y)。sum：：&lt；I32&gt；()；assert_eq！(sum1，(1*2)+(3*4)+(5*6))；设sum2=数据。array_chunks()。贴图(|&amp；[x，y，z]|x*y*z)。sum：：&lt；I32&gt；()；assert_eq！(sum2，(1*2*3)+(4*5*6))；</p><p>根据传递给map函数的模式，编译器计算出第一次调用array_chunks应该将数据分块到长度为2的数组迭代器中，而在第二次调用中应该是长度为3的数组迭代器。这太酷了！</p><p>现在我们已经弄清楚了在不久的将来我们可以稳定什么，我正在围绕稳定这个功能的愿景大肆宣传和达成共识-这就是这篇博客文章的目的！下一步将由某人创建一个功能门，即这组有限的const泛型(与现有的整个const_Generics功能门相对)，然后让我们完成记录和稳定该功能门的标准过程。</p><p>我自己在RFC和现在之间的Const泛型中的参与很少，甚至根本不存在，本质上，我的角色(无论是在RFC还是现在)一直是确定一个我们可以就向前推进达成共识的范围。然而，在此期间，实现const泛型的艰苦工作已经进行了多年，我要特别赞扬贡献者eddyb、varkor、lcnr和oli-obk，他们在实现这一要求很高的特性方面所做的工作。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://without.boats/blog/shipping-const-generics/">https://without.boats/blog/shipping-const-generics/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/2020/">#2020</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/常量/">#常量</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/const/">#const</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/类型/">#类型</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1012292.html"><img src="http://img.diglog.com/img/2020/7/thumb_e2cf4cfb0db9dc090398ccb99a5b07ed.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1012292.html">
Bumble创始人惠特尼·沃尔夫·赫德将颠覆2020年</a></div><span class="my_story_list_date">2020-7-16 22:38</span></div><div class="col-sm"><div><a target="_blank" href="/story/1012111.html"><img src="http://img.diglog.com/img/2020/7/thumb_e1807fbd983e30dd2b2cdddc4e61eacd.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1012111.html">我横扫整个互联网的那一天：意外研究项目CVE-2020-1350</a></div><span class="my_story_list_date">2020-7-16 2:59</span></div><div class="col-sm"><div><a target="_blank" href="/story/1012091.html"><img src="http://img.diglog.com/img/2020/7/thumb_6217a3b68cc03057ec3814d2f942fc85.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1012091.html">Google的Cloud Next 2020活动泄露的幻灯片似乎显示了将会议、聊天、文档和房间整合到Gmail应用程序中的计划</a></div><span class="my_story_list_date">2020-7-16 2:11</span></div><div class="col-sm"><div><a target="_blank" href="/story/1011626.html"><img src="http://img.diglog.com/img/2020/7/thumb_932497d68c8dfde38b835f9b4f683d95.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1011626.html">2020年的加密税：真实场景下的税收指南</a></div><span class="my_story_list_date">2020-7-14 6:1</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>