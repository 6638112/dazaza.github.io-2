<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>用一辆价值10美元的覆盆子PI拆开一辆价值2000美元的自行车</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">用一辆价值10美元的覆盆子PI拆开一辆价值2000美元的自行车</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-02 03:25:50</div><div class="page_narrow text-break page_content"><p>几年前，我在一辆健身车上挥霍无度。这是一个相当昂贵的项目，无论是预付的订阅费还是持续的订阅费都是如此。但我能够证明它是合理的，因为我一直在骑它，这样每次骑一次就不会那么贵了。我很高兴地说，这对我的健康是一个巨大的恩惠，而且每一分钱都是物有所值。</p><p>这辆自行车是飞轮运动推出的飞轮家用自行车。你打开应用程序，选择一个班级，然后开始骑马。这款应用程序会向你显示教练的实时视频流，你在排行榜上的位置，以便你可以与班上其他人竞争，以及你的实时统计数据，如功率(瓦数)和节奏(Rpm)。如今，健身应用程序附带了所有常见的励志徽章，每一次骑行都会被记录下来，这样你就可以跟踪自己随着时间的推移而取得的进展。</p><p>在与竞争对手佩洛顿(Peloton)打了一场法律战后，飞轮最近突然关闭了Home Bike服务。这辆自行车仍然可以工作，因为你仍然可以踩踏板，调整阻力，从技术上得到锻炼。但这个应用程序不再是这样了，所以没有课程，没有比赛，也没有统计数据。</p><p>把它换成免费翻新的佩洛顿。以同样的月费加入佩洛顿，改为参加他们的课程。这不是一笔糟糕的交易，而且可以说是一次升级。</p><p>使用免费的LifeFitness ICG训练应用程序。飞轮家庭自行车是一款更名的LifeFitness IC5，所以它恰好可以和这款应用程序一起使用。这为你提供了实时的统计数据，如力量和节奏，以及跟踪你的进度的能力，但不提供任何实时的课程或比赛，也没有得到官方的支持。</p><p>添加一组功率计踏板($)。将这款自行车与大型多人在线自行车模拟器Zwift和其他训练应用程序一起使用。</p><p>对自行车进行反向工程。将其数据免费设置为与Zwift和其他培训应用程序配合使用。不需要电表踏板。</p><p>这篇帖子的其余部分是我编写一些代码的经历的演练，这些代码使飞轮家庭自行车能够与Zwift和其他培训应用程序一起工作。它可能也适用于LifeFitness IC5，而且对其他自行车的支持应该很容易添加。</p><p>主要目标是让飞轮家庭自行车与Zwift一起工作。如果它也能与TrainerRoad和Rouvy等其他自行车应用程序配合使用，那就太好了。</p><p>该解决方案应该是易于使用的非开发人员和非破坏性的自行车。</p><p>编写一些代码以从自行车的专有协议中获取功率和节奏数据。</p><p>编写一些代码将功率和节奏数据发送到模拟蓝牙自行车的Zwift。</p><p>只需要两条信息就可以让一辆自行车在Zwift上工作：功率(瓦特)和节奏(Rpm)。POWER可以让Zwift计算你在游戏中的速度和位置。Cadence改进了基于Cadence的锻炼体验，并使Zwift能够准确地设置角色动画。</p><p>我们从经验中知道，这款自行车能够产生这些信息，而且它使用蓝牙与官方飞轮应用程序进行通信，因此第一步是打开蓝牙服务浏览器，看看有什么可用。</p><p>自行车宣传具有两个特征(也称为数据值)的单一服务。对服务UUID的网络搜索告诉我们这是北欧UART服务，这是由北欧半导体定义的定制服务。它允许模拟串行端口来回发送任意数据。</p><p>这些特征是从自行车的角度命名的。为了将数据传输到自行车，我们写入Receive(RX)特征。为了从自行车接收数据，我们订阅了传输(TX)特性。</p><p>单击(TX)特征上的Subscribe显示自行车已经在发送一些数据。不过，这里的数据有点难看。下面的简短JavaScript程序使用Noble Bluetooth客户端库连接到自行车，并将所有接收到的数据转储到控制台，以便我们可以开始分析它。</p><p>/*连接到飞轮家庭自行车的蓝牙UART服务，并将*接收的数据记录到控制台。*/从&#39；@deduconware/noble&#39；；import{on，once}从&#39；events&#39；(async()=&gt；{//北欧UART服务和特征常量UUID=&#39；6e400001b5a3f393e0a9e50e24dcca9e&#39；const rxUuid=&#39；6e400002b5a3const rxUuid=&#39；6e400002b5a3const UUID=&#39；6e400002b5a3const rxUuid=&#39；6e400002b5a3。//等待适配器常量[STATE]=等待一次(NOBUE，&#39；stateChange&#39；)；IF(state！==&#39；poweredOn&#39；){抛出新错误(`蓝牙适配器状态${state}`)；}//扫描等待NOVE。StartScaningAsync([UUID]，false)；const[外围设备]=等待一次(NOBE，#39；DISCOVER&39；)；等待NOBUE。StopScaningAsync()；//连接等待外设。ConnectAsync()；const{特征：[TX，RX]}=等待外围设备。DiscoverSomeServicesAndCharacteristic sAsync([uuid]，[txUuid，rxUuid])；//开始接收等待发送。ScribeAsync()；const Packets=on(tx，&#39；read&#39；)；//在ctrl-c上退出，let exit=false；process。On(&#39；SIGINT&#39；，()=&gt；{exit=true；})；//打印所有接收的数据const start=new date()；等待(const[Packet]of Packets){IF(退出)Break；const t=new date()-start；const mm=`${Math.。地板(t/60)}`。PadStart(2，&#39；0&#39；)；const ss=`${t%60}`。PadStart(2，&#39；0&#39；)；const MMSS=`${mm}：${ss}`；控制台。Log(MMSS，Packet)；}//停止接收等待TX。UnscribeAsync()；//等待外设断开。DisconnectAsync()；})()；</p><p>运行该程序后，我们第一次清楚地看到了自行车发送的数据：</p><p>00：00&lt；Buffer ff 1f 0C 00 00 00&gt；Buffer 00 00 00&lt；Buffer 00 00 00&lt；Buffer 00 00 00 01 38 55&gt；Buffer ff 1f 0C 00 00 00&gt；缓冲区00：01&lt；Buffer 00 00 00 01 55&gt；Buffer 00 00 00&lt；Buffer 00 00 00&lt；Buffer 00 00 00 01 55&gt；Buffer ff 1f 0C 00 00 00 26 00 00 00&gt；00：02&lt；Buffer 00 00 00 0C 00 00 01 38 55&gt；00：03&lt；Buffer ff 1f 0C 00 00 00&lt；Buffer 00 00 00&lt；Buffer 00 00 00 0C 00 00 01 38 55&lt；00：04&lt；Buffer 00 00 00&lt；Buffer 00 00 00 0C 00 00 01 38 55&gt；00：04&lt；00：04&lt；缓冲区00 00 00 0C 00 00 00 01 38 55&gt；</p><p>蓝牙LE4.0和4.1允许每个数据包最多20字节的应用程序数据，因此这可能是在两个块中发送的单个34字节的消息。对程序稍作修改，就可以将两个块重新连接在一起，并添加一个标题以使输出更易于阅读和引用。</p><p>偏移量0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 3300：23&lt；缓冲区ff 1f 0C 00 00 00 0C 00 00 01 1e 55&gt；00：24&lt；缓冲区ff 1f 0C 00 00 00。缓冲区ff 1f 0C 00 00 00；缓冲区ff 1f 0C 00 00 00 01 1E 55&gt；00：26&lt；Buffer ff 1f 0C 00 00 00&lt；Buffer ff 1f 0C 00 00 00。(开始骑车)00：28&lt；Buffer ff 1f 0C 00 00 00 31 00 00 00 0d 00 00 00 01 2e 55&gt；00：29&lt；Buffer ff 1f 0C 00 00 00 0E 00 00 00 01 2d 55&gt；00：30&lt；Buffer ff 1f 0C 00 21 00 14 00 00 00 04 58 00 95 00 00 00：31&lt；buffer ff 1f 0C 00 21 00 14 00 00 00 04 58 00 95 00 00 00 10 00 00 00 01 fe55&gt；00：32&lt；buffer ff 1f 0C 00 21 00 14 00 00 00 04 60 00 95 00 00 00。Buffer ff 1f 0C 00 21 00 14 00 00 00 04 62 00 95 00 00 00：34&lt；buffer ff 1f 0C 00 21 00 14 00 00 00 04 62 00 95 00 00 00 13 00 00 01 c7 55&gt；00：35&lt；buffer ff 1f 0C 00 20 00 14 00 00 00 04 5e 00 93 00 00。缓冲器ff 1f 0C 001f 00 13 00 00 00 04 5e 00 90 00 00 00 15 00 01 00 01 c055&gt；</p><p>记录在静止状态下开始和结束，否则应该大约为60rpm。任何最大偏移量高于80rpm或低于50rpm，或者不是以0开始和结束，都是不匹配的，可以丢弃。我们只剩下两位候选人了：</p><p>从图表中可以清楚地看出，在偏移量12处，节奏是uint8。几个不同节奏下的额外测试证实了这一点。在偏移量11和13处有非零值，其确认节奏是uint8而不是uint16的低位字节。</p><p>这意味着自行车可以报告的最大节奏为每分钟255转。256转/分时会发生什么情况？换行到0还是钳位到255？事实证明，要骑得那么快是相当困难的，所以这仍然是一个谜。</p><p>完全相同的方法在这里也可以奏效：以稳定的已知瓦数骑行30-60秒，然后在数据中寻找该值。然而，我没有一个很好的方法来确切地知道我在做什么瓦数。</p><p>所以这一次我们将保持稳定的节奏，每隔几秒就增加一次阻力。数据应该显示出一系列的高原，每个高原都比上一个更高。绝对值也应该在一个合理的范围内，从100瓦左右开始，并保持在1000瓦以下。</p><p>这一次我们最有可能寻找的是16位整数，我们必须同时考虑大端和小端编码。</p><p>偏移量0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 3300：00&lt；缓冲区ff 1f 0C 00 00 00 2d 00 00 00 01 b2 00 12 00 25 ba 55&gt；00：01&lt；缓冲区ff 1f 0C 00 00 00。Buffer ff 1f 0C 00 00 00 28 00 00 2d 00 00 00&lt；b3 00 12 00 25 93 55&gt；00：03&lt；buffer ff 1f 0C 00 00 00 28 00 2d 00 00 00 01 b4 00 12 00 25 94 55&gt；00：04&lt；buffer ff 1f 0C 00 00 00 2d。Buffer ff 1f 0C 00 00 00 25 00 00 2d 00 00 00 01 b6 00 12 00 25 9b 55&gt；00：06&lt；buffer ff 1f 0C 00 00 00 29 00 00 2d 00 00 00 01 b7 00 12 00 25 96 55&gt；00：07&lt；buffer ff 1f 0C 00 00 56 00 35 00 00。缓冲器ff 1f 0C 005a 00 38 00 00 00 0C 35 00 f5 2d 00 00 00 01 b9 00 12 00 26 1c 55&gt；</p><p>任何最大偏移量小于100W或大于1000W，或者开头和结尾不是0的都可以丢弃。这一次，我们只剩下三种可能：偏移量3、5和13。</p><p>绝对值表明偏移3是以瓦为单位的当前功率。根据我的努力，偏移量13开始太高，而偏移量5没有达到足够高的峰值。</p><p>在对ICG训练应用程序进行了一些试验后，我发现这款自行车有一些飞轮应用程序没有暴露出来的隐藏功能。其中一个特点是，你可以进行测试，看看你在一个小时的骑行中可以承受的最大功率，这就是所谓的功能阈值功率(FTP)。FTP结果存储在自行车上，它以瓦数(偏移量3)和FTP百分比(偏移量5)报告您的功率。FTP%经常用于培训计划。当偏移量为3≈160时，自行车中存储的默认ftp显示为160W，偏移量为5≈100时。</p><p>偏移量13处的值是一个非常乐观的速度估计值，单位为km/h×10。可能是骑手体重默认为0。</p><p>另外，当我记录数据时，我注意到偏移量15是电阻刻度盘的位置，范围从0(容易)到100(硬)。这在程序的输出中很容易看到，因为它是唯一改变的值之一，所以在不踩踏板的情况下调整阻力时很容易看到这一点。这并不是让自行车与Zwift一起工作所必需的。</p><p>我在这次测试中注意到的另一件事是自行车上似乎有一个错误：</p><p>偏移量0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 02：21&lt；buffer ff 1f 0c 01 7b 00 ea 00 00 00 33 6c 01 f6 3a 00 00 00 7e 00 06 00 0E 67 55&gt；02：22&lt；buffer ff 1f 0c 01 92 00 f8 00 00 00 36 6b 02 05 3b 00。Buffer ff 1f 0C 01 96 00 fb 00 00 00 36 6b 02 08 3b 00 00 00 0f 9b 55&gt；02：24&lt；buffer ff 1f 0C 00 00 00 6b 00 00 00 81 00 07 00 0f F1 55&gt；02：25&lt；buffer ff 1f 0C 01 a2 01 02 00 00 00 38 6fF1 55&gt；02：25&lt；buffer ff 1f0C 00 00 00 6b；Buffer ff 1f 0C 01 a2 01 02 00 00 00 38 6f。Buffer ff 1f 0c 01 97 00 fb 00 00 00 36 6c 02 08 3b 00 00 00 83 00 07 00 10 81 55&gt；|电源节拍电阻。</p><p>2点24分的数据显示了一个短暂的信号，功率、电阻和其他一些值短暂下降到0，而节奏没有受到影响。然后在2点25分他们回来了。事实证明，在整个数据中都有几个这样的例子。</p><p>这意味着你可能正以非常高的努力骑车，突然之间你的力量在一秒钟内降到了0。这不是世界末日，但它有可能令人讨厌。似乎每隔几分钟就会发生一次。</p><p>飞轮没有公布自行车内部如何工作的任何细节，但原始制造商确实暗示了功率是如何计算的。从LifeFitness IC5页面：</p><p>WattRate®功率表以瓦为单位显示用户工作的精确测量。这种精度是通过测量施加到磁制动系统上的电阻的定位传感器来实现的。</p><p>因此，自行车实际上并不像电力表那样测量功率。取而代之的是，它将磁制动器的位置映射到某些工厂校准的曲线或查找表上的点。</p><p>一种可能的解释是定位传感器有硬件问题，或者更有可能是固件错误导致偶尔错误读取0。功率值是从电阻读数中得出的，因此它最终也是0。</p><p>一个简单的解决办法是，如果有的话，只使用以前的功率值：节奏非零，前一次功率非零，当前功率为零。一个轻微的改进是跟踪坡度，并在计算预测值时将其考虑在内。如果错误发生在快速加速或减速期间，应该会产生稍微好一点的结果。</p><p>偏移量0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 02：23&lt；Buffer ff 1f 0C 01 96 00 fb 00 00 00 36 6b 02 08 3b 00 00 00 07 00 0f 9b 55&gt；|power|cadence|阻力功率%速度。</p><p>我们已经有了我们需要的东西，但是我们可以对包的其余部分做出一些有根据的猜测。</p><p>名称“北欧UART服务”暗示该协议旨在用于真正的UART，如果是这样的话，第一个和最后几个字节将用于串行帧同步和错误检测。</p><p>对我们程序输出的最后一个小更改是，对于飞轮应用程序的“搭便车”功能，我们提供了一个非常原始的替代功能。</p><p>电源节拍电阻23W 63rpm 0%24W 73rpm 0%26W 73rpm 0%27W 82rpm 0%29W 82rpm 0%30W 89rpm 0%32W 89rpm 0%33W 99rpm 0%35W。</p><p>.</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/">https://ptx2.net/posts/unbricking-a-bike-with-a-raspberry-pi/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/pi/">#pi</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/raspberry/">#raspberry</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/自行车/">#自行车</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1012057.html"><img src="http://img.diglog.com/img/2020/7/thumb_00e41529f4ac12ef4dee0e17dc3b0d24.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1012057.html">
研究人员为海底数据网络开发基于激光的水下WiFi系统</a></div><span class="my_story_list_date">2020-7-15 23:41</span></div><div class="col-sm"><div><a target="_blank" href="/story/1010952.html"><img src="http://img.diglog.com/img/2020/7/thumb_7b9e73fd65fee1bd77a5c93334e6ff11.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1010952.html">裸机覆盆子PI Smalltalk-80</a></div><span class="my_story_list_date">2020-7-10 15:43</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007637.html"><img src="http://img.diglog.com/img/2020/6/thumb_f532236ad2ac3b71e8aeb5e0bd42820d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007637.html">Raspberry PI(Broadcom VideoCore IV)的Vulkan驱动程序</a></div><span class="my_story_list_date">2020-6-22 21:26</span></div><div class="col-sm"><div><a target="_blank" href="/story/1004469.html"><img src="http://img.diglog.com/img/2020/5/thumb_dab7f99d6b246e45f9dd31ad821ae2cd.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004469.html">覆盆子Pi OS：为什么它不再被称为‘Raspbian’</a></div><span class="my_story_list_date">2020-5-31 9:29</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>