<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>你需要redis吗？ 如何逃避Postgres Do you need Redis? how to get away with just Postgres</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Do you need Redis? how to get away with just Postgres<br/>你需要redis吗？ 如何逃避Postgres </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-06-12 15:20:11</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/6/3daee5283bddbd0bc50357600a4f772a.jpeg"><img src="http://img2.diglog.com/img/2021/6/3daee5283bddbd0bc50357600a4f772a.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>There’s a tried-and-true architecture that I’ve seen many times for supporting your web services and applications:</p><p>有一种尝试和真实的架构，我已经看到了很多次，以支持您的Web服务和应用程序：</p><p> Redis is fantastic, but what if I told you that its most common use cases for this stack could actually be achieved using only PostgreSQL?</p><p> Redis很棒，但如果我告诉你这堆栈最常见的用例，实际上只能使用PostgreSQL实现它最常见的用例吗？</p><p>  Perhaps the most common use of Redis I’ve seen is to coordinate dispatching of jobs from your web service to a pool of background workers. The concept is that you’d like to record the desire for some background job to be performed (perhaps with some input data) and to ensure that only one of your many background workers will pick it up. Redis helps with this because it provides a rich set of atomic operations for its data structures.</p><p>  也许我所看到的Redis最常见的用途是协调从您的Web服务向一家背景工人派遣工作。该概念是您希望录制要执行的一些背景作业的欲望（或许有一些输入数据），并确保您的许多背景工人只能拾取它。 Redis帮助此功能，因为它为其数据结构提供了丰富的原子操作集。</p><p> But since the introduction of version 9.5, PostgreSQL has a  SKIPLOCKED option for the  SELECT ... FOR ... statement ( here’s the documentation). When this option is specified, PostgreSQL will just ignore any rows that would require waiting for a lock to be released.</p><p> 但自版本9.5引入以来，PostgreSQL为Select ...有一个Skiplocked选项...对于...语句（这是文档）。指定此选项后，PostgreSQL将忽略需要等待释放锁的任何行。</p><p>  WITH job AS ( SELECT id FROM jobs WHERE status = &#39;pending&#39; LIMIT 1 FOR UPDATE SKIP LOCKED)UPDATE jobsSET status = &#39;running&#39;WHERE jobs.id = job.idRETURNING jobs.*;</p><p>  作业为（选择身份的工作=＆＃39的作业;待定＆＃39;更新跳过的限制1）更新Jobsset Status =＆＃39;运行＆＃39; whating.id = Job.idreturn作业。*;</p><p>  By specifying  FOR UPDATE SKIP LOCKED, a row-level lock is implicitly acquired for any rows returned from the  SELECT. Further, because you specified  SKIP LOCKED, there&#39;s no chance of this statement blocking on another transaction. If there&#39;s another job ready to be processed, it will be returned. There&#39;s no concern about multiple workers running this command receiving the same row because of the row-level lock.</p><p>  通过指定更新跳过锁定，隐式获取行级锁定，用于从“选择”返回的任何行。此外，因为您指定了跳过锁定，其中没有机会在另一个交易中阻止这种陈述。如果有另一份作业准备好进行处理，则将返回。没有担心运行此命令的多个工人因行级锁而接收同一行的多个工人。</p><p> The biggest caveat for this technique is that, if you have a large number of workers trying to pull off this queue and a large number of jobs feeding them, they may spend some time stepping through jobs and trying to acquire a lock. In practice, most of the apps I&#39;ve worked on have fewer than a dozen background workers, and the cost is not likely to be significant.</p><p> 这项技术的最大警告是，如果你有大量的工人试图脱掉这个队列和大量的工作喂养它们，他们可能会花一些时间踩到工作并试图获得锁定。在实践中，大多数应用程序I＆＃39; ve工作的少于十几个背景工人，成本不太可能很重要。 </p><p>  Let&#39;s imagine that you have a synchronization routine with a third-party service, and you only want one instance of it running for any given user across all server processes. This is another common application I&#39;ve seen for Redis: distributed locking.</p><p>让＆＃39想象一下，您可以使用第三方服务具有同步例程，并且您只希望在所有服务器进程中为任何给定用户运行的一个实例。这是另一种常见的应用程序I＆＃39;已经看过Redis：分布式锁定。</p><p> PostgreSQL can achieve this as well using its  advisory locks. Advisory locks allow you to leverage the same locking engine PostgreSQL uses internally for your own application-defined purposes.</p><p> PostgreSQL可以使用其咨询锁来实现这一目标。咨询锁允许您利用相同的锁定引擎PostgreSQL在内部用于您自己的应用程序定义的目的。</p><p>  I saved the coolest example for last: pushing events to your active clients. For example, say you need to notify a user that they have a new message available to read. Or perhaps you&#39;d like to stream data to the client as it becomes available. Typically, web sockets are the transport layer for these events while Redis serves as the Pub/Sub engine.</p><p>  我保存最新的榜样：将事件推到活动客户端。例如，假设您需要通知用户它们具有可用于读取的新邮件。或者，也许是您喜欢将数据传输到客户端，因为它可用。通常，幅材套接字是这些事件的传输层，而Redis用作PUB /子引擎。</p><p> However, since version 9, PostgreSQL also provides this functionality via the   LISTEN and   NOTIFY statements. Any PostgreSQL client can subscribe ( LISTEN) to a particular message channel, which is just an arbitrary string. When any other client sends a message ( NOTIFY) on that channel, all other subscribed clients will be notified. Optionally, a small message can be attached.</p><p> 但是，由于版本9，PostgreSQL还通过侦听和通知语句提供此功能。任何PostgreSQL客户端都可以订阅（侦听）到特定的消息频道，这只是一个任意字符串。当任何其他客户端在该频道上发送消息（通知）时，将通知所有其他订阅的客户端。可选地，可以附加小消息。</p><p> If you happen to be using Rails and ActionCable, using PostgreSQL is even supported out of the box.</p><p> 如果您碰巧使用Rails和ActuctCable，甚至支持使用PostgreSQL。</p><p>  Redis fundamentally fills a different niche than PostgreSQL and excels at things PostgreSQL doesn&#39;t aspire to. Examples include caching data with TTLs and storing and manipulating ephemeral data.</p><p>  Redis从根本上填充了不同的利基，而不是PostgreSQL，并在PostgreSQL的事物中求追求。示例包括使用TTL和存储和操作短暂数据缓存数据。</p><p> However, PostgreSQL has a lot more capabilities than you may expect when you approach it from the perspective of just another SQL database or some mysterious entity that lives behind your ORM.</p><p> 然而，PostgreSQL的能力比你可能期望的更多功能，当您从另一个SQL数据库或某些留在您的ORM后面的神秘实体的角度来看时。 </p><p> There&#39;s a good chance that the things you&#39;re using Redis for may actually be good tasks for PostgreSQL as well. It may be a worthy tradeoff to skip Redis and save on the operational costs and development complexity of relying on multiple data services.</p><p>在那里有一个很好的机会，你＆＃39;使用redis的事情实际上是PostgreSQL的好任务。 它可能是一个有价值的权衡，用于跳过Redis并节省依赖于多个数据服务的运营成本和发展复杂性。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://spin.atomicobject.com/2021/02/04/redis-postgresql/">https://spin.atomicobject.com/2021/02/04/redis-postgresql/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/需要/">#需要</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/redis/">#redis</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>