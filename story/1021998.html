<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Unix`who`命令</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Unix`who`命令</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-04 06:08:42</div><div class="page_narrow text-break page_content"><p>在从事一个完全不同的项目时，我开始问自己，世卫组织指挥部是如何在幕后工作的。最后，我觉得这是一个写博客的好话题。</p><p>让我们从基础开始吧。Who命令允许您列出当前登录到系统的用户。例如，在我的计算机上：</p><p>$whogauthier tty2 2020-08-30 15：06(Tty2)Gauthier pts/1 2020-08-30 15：06(tmux(1555.%0)Gauthier pts/2 2020-08-30 16：41(tmux(1555).%6)Gauthier pts/4 2020-08-30 15：57(tmux(1555).%3)。</p><p>它告诉我我登录了“物理”终端tty2和三个伪终端。事实上，我当前的Gnome Shell会话是在tty2上运行的，并且我打开了3个tmux窗口。</p><p>但它是从哪里获得这些信息的呢？可能来自一个文件，因为Linux中的所有东西都是一个文件，但是让我们检查一下是哪一个文件以及数据是如何存储在那里的。</p><p>为了了解who命令在做什么，我可以尝试找到源代码并深入研究它。但是我发现使用strace检查进程正在做什么是很有趣的。因为我们期望由谁来读取系统文件，所以我们只能关注打开的syscall。</p><p>$strace Who 2&&gt;&amp；1|grep openopenat(AT_FDCWD，&#34；/etc/ld.so.cache&#34；，O_RDONLY|O_CLOEXEC)=3openat(AT_FDCWD，&#34；/usr/lib/libc.so.6&#34；，O_RDONLY|O_CLOEXEC)=3openat(AT_FDCWD。，O_RDONLY|O_CLOEXEC)=3openat(AT_FDCWD，&#34；/etc/localtime&#34；，O_RDONLY|O_CLOEXEC)=3。</p><p>我们可以快速筛选出什么是有趣的，什么是不有趣的。前两个文件/etc/ld.so.cache、/usr/lib/libc.so.6是进程加载的共享库，我们对此很感兴趣。</p><p>然后打开/usr/lib/locale/locale-archive、/var/run/utmp和/etc/localtime。让我们看看这些文件存储的是什么。</p><p>在浏览这类主题时，在开始浏览Web之前先搜索手册页总是很有趣的。手册的第5部分致力于“文件格式和约定”，似乎是一个很好的起点。</p><p>区域设置定义文件包含localedef(1)命令将其转换为二进制区域设置数据库所需的所有信息。</p><p>地区是一套语言和文化规则。这些内容涵盖消息语言、不同字符集、词汇图形约定等方面。程序需要能够确定其区域设置并相应地执行操作，以便能够移植到不同的文化。</p><p>因此，who命令可能使用setlocale(3)函数从该文件中读取信息，以了解信息应该如何格式化和显示。</p><p>$LC_ALL=&#39；fr_FR.utf8&#39；作者tty2 9月2 11：38(：1)Gauthier pts/1 9月2 12：11(tmux(2445).%0)Gauthier pts/2 9月2 12：37(tmux(2445).%1)Gauthier pts/3 9月2 13：04(tmux(2445).%2)。</p><p>Etc/localtime文件配置应用程序用于呈现给用户的本地系统的系统范围时区。</p><p>可能是使用此文件(或使用使用此文件的函数)的用户使用用户配置的正确时区打印时间戳(WHO输出的第4列和第5列)。</p><p>Utmp文件允许用户发现有关当前谁在使用系统的信息。当前可能有更多用户使用该系统，因为并非所有程序都使用utmp日志记录。</p><p>太棒了！我们找到了WHO命令获取数据的位置。如果能够读取该文件来获取这些数据，而不使用Who命令，那就太好了。不幸的是：</p><p>该文件是一系列utmp结构，在&lt；utmp.h&gt；中声明如下(请注意，这只是几个定义之一；详细信息取决于libc的版本)：</p><p>此时，我们了解了who命令在做什么：它正在读取/var/run/utmp，解析内容并很好地形成它。让我们看看我们是否能重现这个简单的行为。</p><p>我们只需要做的就是：打开/var/run/utmp，读取n个字节(其中n是utmp结构的大小)，打印每个结构中包含的信息，继续直到我们到达文件的末尾。稍加整理，我们甚至可以让它看起来像最初的“谁指挥”(Who Command)。</p><p>#include&lt；utmp.h&gt；#include&lt；stdlib.h&gt；#include&lt；stdio.h&gt；#include&lt；time.h&gt；int main(){//设置正确的区域设置以正确显示信息setlocale(LC_ALL，&#34；&#34；)；//打开文件*file=fopen(&#34；/var/run/utmp&#。//仅为安全起见，if(file==null){return 1；}//初始化utmp结构struct utmp条目；//从文件中逐个读取条目，同时(Fread(&amp；entry，sizeof(Struct Utmp)，1，file)！=0){if(entry.ut_type！=user_process)Continue；//格式化日期(还记得谁使用/etc/localtime吗？)。Char date[80]；time_t raw_time=entry.ut_tw.tv_sec；struct tm*ts=localtime(&amp；raw_time)；strftime(date，sizeof(Date)，&#34；%Y-%m-%d%H：%M&#34；，ts)；//打印此条目的输出，尝试模拟&#39；用户的输出printf(&#34；%-8s%-12s%s。，entry.ut_user，entry.ut_line，date，entry.ut_host)；}fclose(File)；}。</p><p>$clang-o wh.c$./whogier tty2 2020-08-31 10：02(Tty2)Gauthier pts/1 2020-08-31 10：03(tmux(2220).%0)Gauthier pts/2 2020-08-31 10：08(tmux(2220).%1)Gauthier pts/3 2020-08-31 10：33(tmux(2220).%5)。</p><p>$strace./WHO 2&gt；&amp；1|grep-e openat(AT_FDCWD，&#34；/etc/ld.so.cache&#34；，O_RDONLY|O_CLOEXEC)=3openat(AT_FDCWD，&#34；/usr/lib/libc.so.6&#34；，O_RDONLY|O_CLOEXEC)=3openat(AT_FDCWD，&#34；/usr/lib/libc.so.6&#34；，O_RDONLY|O_CLOEXEC)=3openat(AT_FDCWD。/var/run/utmp&#34；，O_RDONLY)=3openat(AT_FDCWD，&#34；/etc/localtime&#34；，O_RDONLY|O_CLOEXEC)=4</p><p>当然，这只是对“谁”命令最基本的功能的嘲弄，并不处理任何选项，比如著名的“我是谁”或“妈妈讨厌谁”。</p><p>关于世界卫生组织的命令，还有很多要说的。例如，我们可以提到lastlog命令及其对应的文件/var/log/wtmp，深入研究utmp结构，或者只是尝试理解utmp代表什么。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://gauthier.uk/blog/who/">https://gauthier.uk/blog/who/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/unix/">#unix</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/文件/">#文件</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1009161.html"><img src="http://img.diglog.com/img/2020/7/thumb_365a49334eac3d73a8008da99e7cdefe.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1009161.html">比尔·香农·里普</a></div><span class="my_story_list_date">2020-7-1 5:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1004475.html"><img src="http://img.diglog.com/img/2020/5/thumb_2a56767d751fd2cc920f485b8361dd0f.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004475.html">Unix操作系统(1982)[视频]</a></div><span class="my_story_list_date">2020-5-31 10:5</span></div><div class="col-sm"><div><a target="_blank" href="/story/1000343.html"><img src="http://img.diglog.com/img/2020/5/thumb_f445aec87178b5c9e4b9fb45921abee9.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1000343.html">Unix上的时间</a></div><span class="my_story_list_date">2020-5-2 21:19</span></div><div class="col-sm"><div><a target="_blank" href="/story/technology_linux_761996.html"><img src="http://img.diglog.com/img/2013/6/thumb_ca4b42fd-13a7-42ea-a1b1-be5b4f4bb072.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/technology_linux_761996.html">Linux 为什么要用字符 ~ 来表示 home 目录</a></div><span class="my_story_list_date">2013-6-21 14:23</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>