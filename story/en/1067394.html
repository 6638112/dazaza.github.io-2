<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>x86-64 4kb page翻译设计：这是这个原因为4096字节对齐的原因？ x86–64 4Kb Page translation design: is this why pages are 4096 bytes aligned?</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">x86–64 4Kb Page translation design: is this why pages are 4096 bytes aligned?<br/>x86-64 4kb page翻译设计：这是这个原因为4096字节对齐的原因？ </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-06-22 16:43:33</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/6/1884f8fb9738c71dd30e341464e483f9.png"><img src="http://img2.diglog.com/img/2021/6/1884f8fb9738c71dd30e341464e483f9.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>I lost 3 weeks of my life trying to wrap my head around the Intel x86–64/AMD64 manuals to try implementing 4-Kbyte Page translation for my  hobbyist OS. The purpose of this small blog post is to document some of the things that in the manual aren’t clear at all. (especially for newcomers)</p><p>我丢失了3周的我的生命，试图在英特尔X86-64 / AMD64手册上包装我的头，以尝试为我的爱好者操作4-KBETE页面翻译。这个小博客文章的目的是记录手册中的一些东西并不清楚。 （特别是新人）</p><p>   You have seen that picture a billion times and i  f you are reading this post you know that you need to create these Page Tables in memory so that the hardware establishes a well-defined interface with the OS for allocating small chunks of memory before moving to 64-bit mode.</p><p>   您已经看到了大约十亿次的照片，如果您正在阅读此帖，您知道您需要在内存中创建这些页面表，以便硬件与操作系统建立一个明确定义的接口，以便在移动到64之前分配小块的小块-bit模式。</p><p>    Image that I want to create identity-mapped pages for the first 10MB of memory during the early stages of the boot process. This will be useful for loading the kernel in memory memory before moving to Long mode (64-bit).</p><p>    在引导过程的早期阶段期间，我想要为前10MB内存创建Identity映射页面的图像。在移动到长模式（64位）之前，这将是在内存存储器中加载内核的有用。</p><p>         The explanation to why we do that is due to the expected 4-Kbyte PDE entry format</p><p>         对我们为什么这样做的解释是由于预期的4-Kbyte PDE条目格式</p><p>    But if you look closely, you will find something very very odd. We are led to believe that the Page-Table Base Address (0x13000) should be set between the bits 51:12 as per the picture above.</p><p>    但如果你仔细看，你会发现一些非常奇怪的东西。我们被导致认为页面表基地地址（0x13000）应根据上图的图片在比特51:12之间设置。</p><p> If that assumption is correct, then 0x13000 should be left shifted 12 bits and become 0x13000000. So after the setting the page flags it would become effectively 0x13000003. Which means that the code snippet you shared before is wrong, is that right?</p><p> 如果该假设是正确的，则0x13000应左移12位并变为0x13000000。因此，在设置页面标志之后，它将变为0x13000003。这意味着您之前共享的代码片段是错误的，是对的吗？</p><p> Think like that if you want to spend 3 weeks trying to figure out why you OS doesn’t boot while questioning every career decision you’ve made in the meantime 😰</p><p> 如果你想花3周试图弄清楚你为什么没有启动的时候，那么在质疑你的情况下你的每一职业决定都没有启动 </p><p> The train of thought isn’t wrong per se, but the x86–64 design works a bit different from what we speculated.</p><p>思想的火车不是错误的，但X86-64设计有点不同于我们推测的东西。</p><p> Page data- structure tables are  always aligned on 4-Kbyte boundaries, so only the  address bits above bit 11 are stored in the translation-table base-address field. Bits 11:0 are assumed to be 0. (Taken from the AMD64 manual, page 150)</p><p> 页面数据结构表始终在4-kbyte边界上对齐，因此只有上述位11的地址位存储在翻译表基地址字段中。假设位11：0为0.（取自AMD64手册，第150页）</p><p> What this means in practice is that if our page is on address 0x13000 and flag bits are 0x03 = 0x13003, our hardware ‘re-utilises’ the 12-bits to set the flags while it knows that if it adds 0x1000 to the current page address, it can get to the next page. It’s hard not to speculate if that alone isn’t the whole reason why page tables are 4096 bytes aligned (or 0x1000 😜)</p><p> 这意味着在实践中是什么，如果我们的页面在地址0x13000上，标志位是0x03 = 0x13003，我们的硬件“重新利用”12位以在当前页面地址添加0x1000时设置标志，它可以到达下一页。如果单独的是单独的，这是难以推测的是Page Tables是4096字节的整个原因（或0x1000😜）</p><p> The problem is that although this is written in the manual, no emphasis is really given to this sparse sentence in a middle of a manual with thousands of pages 😫</p><p> 问题是，虽然这是在手册中编写的，但没有强调在一个手册中间的稀疏句子，千页😫</p><p> Well, it took me a long time to get to this and I’m sure that I will forget my name one day but won’t forget this battle with x86–64 paging implementation.</p><p> 好吧，我花了很长时间才能达到这个，我相信一天我会忘记我的名字，但不会忘记这场与x86-64分页的战斗。</p><p> I hope that if someone is struggling with the same problem that I could have reduced that time it took you to figure this out. ❤️</p><p> 我希望如果有人在努力与我可以减少那个时间的同样的问题，那就花了你来解决这个问题。 ❤️ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://deepdives.medium.com/x86-64-4kbyte-page-translation-design-is-this-the-reason-why-pages-are-4096-bytes-aligned-19952a0a55f4">https://deepdives.medium.com/x86-64-4kbyte-page-translation-design-is-this-the-reason-why-pages-are-4096-bytes-aligned-19952a0a55f4</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/page/">#page</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/页面/">#页面</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1067226.html"><img src="http://img2.diglog.com/img/2021/6/thumb_5d51e7954d251bef732fcb25c42a4e0d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1067226.html">新的“保存”图标 </a></div><span class="my_story_list_date">2021-6-22 0:42</span></div><div class="col-sm"><div><a target="_blank" href="/story/1066903.html"><img src="http://img2.diglog.com/img/2021/6/thumb_6cd0930f3044b8dc78a00250053d4315.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1066903.html">苏联设计的奇怪例子 </a></div><span class="my_story_list_date">2021-6-20 0:6</span></div><div class="col-sm"><div><a target="_blank" href="/story/1066829.html"><img src="http://img2.diglog.com/img/2021/6/thumb_84d43a86d7f453d06fe4fb5dfb1f2e92.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1066829.html">UI设计的屏幕截图，LED花旗集团不小心发送$ 893M </a></div><span class="my_story_list_date">2021-6-19 11:55</span></div><div class="col-sm"><div><a target="_blank" href="/story/1066755.html"><img src="http://img2.diglog.com/img/2021/6/thumb_9011e9be29143bbbde2cf607300594c4.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1066755.html">Windows 11中至少有10个不同的Microsoft设计约定 </a></div><span class="my_story_list_date">2021-6-19 3:48</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>