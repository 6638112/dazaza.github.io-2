<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>使用conda-pack缩小您的Conda Docker映像</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">使用conda-pack缩小您的Conda Docker映像</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-12 02:50:29</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/9/4b1e079520b716db8d5b43146ede3545.png"><img src="http://img2.diglog.com/img/2020/9/4b1e079520b716db8d5b43146ede3545.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>如果您正在构建一个基于conda的Docker映像，那么生成的图像可能会很大。例如，稍后我将展示一个仅包含Python3.8和NumPy的简单图像是如何超过950MB的！</p><p>大图像会浪费带宽、磁盘、时间和CPU：如何将图像变小？</p><p>在本文中，我将展示一种方法，通过将conda-pack工具与多阶段构建相结合，在仅使用Python和NumPy的示例中，图像缩小到330MB，几乎小了三分之二。</p><p>如果您不熟悉多阶段构建，我建议您先阅读我对多阶段构建的介绍。</p><p>让我们创建一个只有几个依赖项的标准Conda Docker映像。以下是环境.yml：</p><p>这里是Dockerfile；我们安装了Python3.8和NumPy，当我们运行它导入的NumPy映像时，它会导入NumPy以确保一切正常。(如果您不熟悉conda运行，您可能需要阅读我关于在Docker中激活conda环境的文章。)。</p><p>从Continumio/miniconda3复制环境.yml。运行Conda环境创建-f环境.yml入口点[&#34；Conda&#34；，&#34；运行&#34；，&#34；-n&#34；，&#34；Example&#34；，\&#34；python&#34；，&#34；-c&#34；，\&#34；import numpy；print(&#39；Success！&#39；)&#34；]。</p><p>注意：在讨论的主题之外，本文中的Dockerfile不是最佳实践的示例，因为增加的复杂性会模糊本文的要点。为了确保您编写的是安全、正确、快速的Docker文件，请参考我的快速入门指南，其中包括从安全性到性能的60多个最佳实践。</p><p>生成的图像是970MB，相当惊人地大。所有的磁盘空间都到哪里去了？</p><p>安装Conda工具链的基本环境占用大量空间；它有自己的Python副本，例如，本例中的Python3.7。</p><p>第二个原因意味着我们使用的基本映像Continumio/miniconda3是430MB。作为比较，python：3.8-slm-buster映像是115MB，它已经包含了我们想要使用的Python版本。</p><p>增加大小的第一个原因对于包管理器来说是相当标准的，通常可以通过配置或目标明确的rm-rf来解决。然而，第二个问题是特定于conda的：基本conda环境是安装包所必需的，但是一旦我们运行代码，它实际上不会添加太多内容。</p><p>进入conda-pack，这是一个工具，可以让您将conda环境打包到独立环境中，而不需要conda工具链。一旦我们以这种方式打包了我们的环境，我们就可以将其复制到只包含该自包含环境的新映像中。</p><p>同样，如果您不熟悉多阶段构建，我建议您先阅读我对多阶段构建的介绍。</p><p>#构建阶段映像：from Continumio/miniconda3 as build#正常安装软件包：copy Environmental ment.yml。运行conda env create-f Environment。yml#install conda-pack：run conda install-c conda-forge conda-pack#使用conda-pack在/venv中创建独立环境#in/venv：运行conda-pack-n示例-o/tmp/env.tar&amp；&amp；\mkdir/venv&amp；&amp；cd/venv&amp；&amp；tar xf/tmp/env.tar&amp；&。我将venv放在相同的路径中，它将位于最终映像中，#所以现在修复路径：run/venv/bin/conda-unpack#运行时阶段映像；我们可以使用debian作为#基本映像，因为conda环境也为我们包含了Python#。来自Debian：Buster作为运行时#copy/venv来自上一阶段：copy--from=build/venv/venv#运行映像时，在#激活的环境下运行代码：shell[&#34；/bin/bash&#34；，&#34；-c&#34；]入口点来源/venv/bin/activate&amp；&amp；\python-c&34；import numpy；print(&#39；成功！&#39；)&#34；</p><p>如果我们构建映像，得到的映像要小得多，而且它仍然工作得很好：</p><p>$docker映像build-t condapack。...$docker CONTAINER运行condapack成功！$docker image ls condapack存储库标记映像ID SIZEcondapack最新的6e7906bd0634 330MB。</p><p>Conda是一个有趣的打包系统，因为它包含了运行程序所需的所有东西，除了标准的C库之外。因此，当我们在Environment.yml中安装python=3.8包时，它会安装Python和它需要的所有C库。</p><p>当我们使用conda-pack将我们的conda环境打包到一个不需要conda的隔离环境中时，结果是一个目录，其中包含可以在几乎任何Linux发行版上运行的程序，因此我们只需将该目录复制到一个普通的旧的小Debian映像上，并获得一个独立运行的应用程序。</p><p>如果您在您的Docker映像中使用conda，那么conda-pack是一种缩小映像的简单方法。但是，请务必阅读我关于快速多阶段构建的文章；简单地使用多阶段构建会导致CI中的重建非常慢。</p><p>了解如何构建快速、可投入生产的Docker映像-阅读针对Python的Docker打包指南的其余部分。</p><p>从为您节省时间的快速构建到保证您安全的安全最佳实践，您如何快速获得打包Python应用程序用于生产所需的专业知识？</p><p>通过使用Docker Production QuickStart上的Python，快速了解最佳实践。</p><p>你需要在就业市场上保持竞争力--但是要学的东西太多了，你不知道从哪里开始。</p><p>加入2300多名Python开发人员和数据科学家的行列，学习实用工具和技术，从Docker打包到Python最佳实践，每周在您的收件箱中都会有一篇免费的新文章。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://pythonspeed.com/articles/conda-docker-image-size/">https://pythonspeed.com/articles/conda-docker-image-size/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/docker/">#docker</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/conda/">#conda</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1020098.html"><img src="http://img.diglog.com/img/2020/8/thumb_f50cf7950020549f7a8c734cdfd9993d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1020098.html">Docker to Rate Limit镜像拉取</a></div><span class="my_story_list_date">2020-8-25 8:40</span></div><div class="col-sm"><div><a target="_blank" href="/story/1019350.html"><img src="http://img.diglog.com/img/2020/8/thumb_23b15fc551a88bd6c3b96cf317281423.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019350.html">深入研究Python的官方Docker图像</a></div><span class="my_story_list_date">2020-8-20 21:45</span></div><div class="col-sm"><div><a target="_blank" href="/story/1017952.html"><img src="http://img.diglog.com/img/2020/8/thumb_de71493281044d99204e6c61e2742e2a.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1017952.html">Docker更新ToS：对免费帐户施加映像保留限制</a></div><span class="my_story_list_date">2020-8-13 23:19</span></div><div class="col-sm"><div><a target="_blank" href="/story/1017719.html"><img src="http://img.diglog.com/img/2020/8/thumb_b3ba3be9446e83deec9e1ee7ef72322c.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1017719.html">集装箱搭便车指南：万无一失的码头操作教程</a></div><span class="my_story_list_date">2020-8-12 22:12</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>