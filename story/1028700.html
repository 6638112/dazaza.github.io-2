<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Malloc即服务</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Malloc即服务</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-14 15:17:53</div><div class="page_narrow text-break page_content"><p>如果工作正常，上面的输入框将加载一个简单的框架malloc实现，并公开&#34；malloc&#34；和&#34；free&34；绑定。但巧妙的是，它是在没有Emscripten的情况下构建的：它是一个独立的C文件，直接编译成WebAssembly，根本没有JavaScript运行时。我在这里分享它，因为它可能对从事WebAssembly工具链工作的人很有用，也因为构建它是一种有趣的体验。</p><p>单机版。不需要stdlib；不需要Emscripten。可以包含在项目中，而不需要引入任何其他内容。</p><p>Emscripten包含两个很好的malloc实现(dlmalloc和emmalloc)，您可能应该改用它们。但是，如果你真的在寻找一种简单的麦乐克，沃尔洛克是不错的选择。</p><p>您可以在walloc项目页面查看所有细节；下面精选了一些重要内容。</p><p>产生的walloc.o本身就是一个符合标准的WebAssembly文件，但是它还包含额外的符号表和重定位部分，这些部分允许wasm-ld将单独的编译单元组合到单个最终的WebAssembly文件中。Walloc.c本身并不导入或导出任何内容，在WebAssembly意义上；要使绑定对JS可见，您需要添加一个小包装器：</p><p>Tyfinf__size_type__size_t；#定义WASM_EXPORT(名称)\__ATTRIBUTE__((EXPORT_NAME(#name)\name//声明它们来自walloc.c.void*malloc(Size_T Size)；void free(void*p)；void*WASM_export(Walloc)(Size_T Size){return malloc(Size)；}void WASM_export(Wfree)(void*ptr){free(Ptr)；}。</p><p>如果将其编译为exports.o并通过wasm-ld--no-entry--import-memory-o walloc.wasm exports.o walloc.o链接，则最终得到上面演示中使用的walloc.wasm。有关URL，请咨询您的检查员。</p><p>Walloc并不是最小的分配器。一个简单的永不释放的凹凸指针分配器是你能拥有的最快的东西。还有一个用于Rust的备用分配器wee_alloc，据说它比walloc小，尽管我认为它对小对象的空间效率较低。不过，沃尔克还是相当小的。</p><p>当C程序编译到WebAssembly时，生成的wasm模块(通常)具有相关的线性内存。它可以以这样的方式链接，即当它被实例化时由模块创建内存，或者使得模块由其主机给予内存。上面的示例将--import-memory传递给链接器，允许主机绑定模块实例的内存使用。</p><p>线性存储器具有常见的数据、堆栈和堆段。首先放置数据和堆栈。堆从&amp；__heap_base符号开始。(此符号由链接器计算和定义。)。Wasm程序可以随意使用&amp；__heap_base上面的所有字节。因此&amp；__heap_base是walloc管理的内存下限。</p><p>内存增长-&gt；+----|数据和堆栈|对齐|Walloc页面|...+。-+-^0^&amp；__HEAP_BASE^64 kB对齐。</p><p>有趣的是，不同的工具链使用了几种不同的数据和堆栈顺序。甚至在过去，堆栈也是这样发展起来的。来自Lehmann等人最近发表的“一切旧都是新的：WebAssembly的二进制安全性”一文中的图表是一个很好的总结：</p><p>防止意外溢出(实际上是下溢)的明智做法是让堆栈向下增长到0，数据位于更高的地址。但这可能会导致引用数据的WebAssembly代码占用更多字节，因为地址是使用支持短偏移量的可变长度编码写入的，因此它不是默认的，至少目前是这样。</p><p>无论如何！Walloc管理的内存上限是内存的总大小，它在64KB边界上对齐。(WebAssembly可确保此对齐。)。Walloc还管理64kb页面中的内存。它从最初分配给模块的任何内存开始，如果内存用完，它将扩展内存。宿主可以指定最大内存大小(以页为单位)；如果没有更多的页可用，walloc的malloc将简单地返回NULL；内存不足的处理由调用方决定。</p><p>有一个可用大对象的全局自由列表，每个大对象都有一个标头指示其大小。分配时，walloc会对该列表进行最合适的搜索。</p><p>如果空闲列表上没有能够满足分配的对象，walloc将按分配大小或当前walloc堆大小的一半(以较大者为准)扩展堆。生成的一个或多个页面形成可以满足分配的大对象。</p><p>如果自由列表中最好的对象末尾有超过一大块空间，则将其拆分，并将尾巴放回自由列表中。块是256字节。</p><p>+-+|页眉|块1|块2|...|块255|+-+^+0^+256^+512^+64kB。</p><p>由于每页为65536字节，每个块为256字节，因此一页中有256个块。页中开始分配的对象(无论大小)的第一个块包含标题块。页头对于页中的256个块中的每个块都有一个字节。如果相应的块开始一个大对象，则该字节为255；否则，该字节指示打包的小对象分配的大小类(见下文)。</p><p>+-+|页眉|大对象1|大对象2...|+-+。-+^+0^+256^+512^+64kB。</p><p>拆分大对象时，我们避免在页眉块上启动新的大对象。如果大对象包含整个页面，则它只能跨越页眉块所在的位置。</p><p>释放一个大对象会将其推送到全局自由列表中。通过查看页眉，我们知道指针是一个大对象。我们知道分配的大小，因为大对象标头在分配之前。当在释放之后发生下一次大对象分配时，将通过合并相邻的大对象来压缩自由列表。</p><p>小对象是从隔离的自由列表中分配的。粒大小为8字节。小对象分配被打包在统一分配大小的块中。每个大小的分配都有大小类别，从1到6个颗粒，然后是8、10、16和32个颗粒；总共有10个大小。例如，将从16粒块中满足例如12粒的分配。每个大小类别都有自己的空闲列表。</p><p>在分配时，如果相应的freelist上没有任何内容，walloc将分配一个新的大对象，然后将其页头中的块类型更改为Size类。然后，它遍历新的块，通过线程将对象彼此连接到一个空闲列表中。</p><p>+-+|页眉|大对象1|Granules=4|大对象2&#39；|+-+^+0^+256^+512^+768+1024^+64kB.。</p><p>在本例中，我们假设4粒自由列表为空，而大对象自由列表只包含大对象2，一直运行到页面末尾。我们分配了一个新的4粒块，将第一个块从大对象中拆分出来，并将新修剪的大对象推回到大对象自由列表中，相应地更新了页眉。然后，我们将新块中的4-Granules(32字节)分配线程在一起(该块有容纳其中8个的空间)，将它们视为struct freelist的实例，将它们推送到4-Granules分配的全局空闲列表上。</p><p>在刷新块中，对象N下一个链接指向对象N+1/-\||+-+-^-v-+-+granules=4：|(填充，可能)|Object 0|...|Object 7|+-+^4-Granule Freelist现在指向此处。</p><p>选择SIZE类时，任何浪费的空间(填充)都小于SIZE类。</p><p>释放一个小对象会将其推回到其Size类的空闲列表中。给定一个指针，我们通过查看页眉中的块类型来知道它的大小类。</p><p>嘿，祝你玩得开心！如果你觉得有用，请告诉我。祝您黑客活动愉快，下次再见！</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://wingolog.org/archives/2020/10/13/malloc-as-a-service">https://wingolog.org/archives/2020/10/13/malloc-as-a-service</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/malloc/">#malloc</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/walloc/">#walloc</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>