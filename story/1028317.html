<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>使用SCGI加快Web应用程序速度(2007)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">使用SCGI加快Web应用程序速度(2007)</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-12 22:29:11</div><div class="page_narrow text-break page_content"><p>如果您正在操作Web服务器，那么您很可能不仅仅是在提供静态文本和图像。您可能也在运行一些Web应用程序，在这些应用程序中，某些程序或脚本使用CGI(通用网关接口)动态生成页面。考虑到博客软件、bug跟踪器、新闻网站和内容管理系统--任何将浏览器从文档查看器转变为用户界面的东西。而且，您可能会自己编写或至少调整其中的一些内容。</p><p>本文展示了如何使用称为SCGI(简单通用网关接口)的CGI替代方案来构建速度更快的Web应用程序。SCGI是一个协议，而不仅仅是一个程序，但它的作者也提供了一个参考实现，这就是我们在这里使用的。它包括从Apache或lighttpd和Python类使用SCGI的模块，以帮助您创建SCGI应用程序。其他语言的实现也是可用的，但是我们在这里研究Apache2.x和Python的组合。</p><p>通常，Web应用程序在Web服务器的子进程中短暂但非常频繁地运行。当客户端请求页面时，Web服务器查询其配置，发现请求应该转到应用程序。它将请求委派给子进程，子进程随后加载并运行应用程序。程序可以是二进制的，也可以是Perl、Python或PHP的脚本、shell命令或其他任何东西。CGI标准定义了程序如何接收有关请求的详细信息，包括请求的URL、请求的正文、经过身份验证的用户身份和源IP地址。程序读取这些内容，生成一个页面来响应客户端的请求，然后退出。所有这些都会在下一次请求时再次发生。</p><p>加载、运行和退出程序的成本可能很高。对于草率的程序来说，这确实是有意义的：例如，它们可能会使用内存，而再也不会释放内存。在这种情况下，您希望程序短暂运行，然后让操作系统在运行后进行清理。但是，以今天流行的语言--Perl、Python、PHP、Java和Shell脚本--来说，这确实没有太多问题。一个编写良好的应用程序确实应该能够在一次运行中处理多个请求。</p><p>SCGI允许您的程序启动一次，并根据需要继续为请求提供服务。它的工作原理如下：一个独立的服务器进程(称为SCGI服务器)独立于Web服务器运行，并管理一个Web应用程序。Web服务器将该应用程序的所有请求转发到该应用程序的SCGI服务器。它以与常规CGI几乎相同的形式传递有关请求的详细信息。</p><p>SCGI服务器将请求委托给子进程，就像Web服务器对常规CGI应用程序所做的那样。子进程也会运行应用程序，但相似之处到此为止。应用程序可以静静等待新的请求，而不是在处理完那个请求后退出。SCGI服务器的每个子进程都运行应用程序的一个实例，每个进程都处于休眠状态，直到有工作要做。</p><p>当没有新的子进程可用于处理最新的请求时，SCGI服务器会生成一个新的子进程-当然，最多可以达到一个可配置的最大值。它还可以清理崩溃或退出的子进程，因此如果出现问题，您的Web应用程序仍然可以脱离困境。但是，大多数情况下，当请求到达时，应用程序已经准备好并等待它。这就是为什么Web应用程序框架Ruby on rails附带了在SCGI上运行的选项；否则它会太慢。</p><p>如果加速对您来说还不够，还有更多。SCGI服务器进程可以与Web服务器运行在同一系统上，但不必如此。您可以通过将一些Web应用程序委托给单独的系统来卸载服务器，最好是在防火墙后面，在那里只有Web服务器可以访问它们。</p><p>即使只有一台服务器，您也可以使用SCGI来保证无懈可击。正常的CGI应用程序以与Web服务器进程相同的用户身份启动。如果攻击者设法翻转正常的CGI应用程序，您的整个网站可能会处于危险之中。另一方面，AnSCGI服务器可以在它自己的用户身份下运行，因此即使它确实不正常地运行，也不会轻易影响Web服务器或其他应用程序。相反，您不再需要授予Web服务器访问应用程序的代码或数据的权限，只需要访问SCGI服务器运行的应用程序即可。其他所有人都必须通过Web服务器，该服务器依次与SCGI服务器通信。</p><p>您还可以在chroot环境或虚拟化服务器中运行应用程序。使用CGI，这很快就会变得昂贵且难以管理。使用SCGI时，您只需在隔离环境中启动一个服务器进程-无论它是chroot监狱、虚拟化服务器、不同的用户身份还是另一台计算机-整个应用程序都会留在那里。</p><p>您需要两个组件：用于构建SCGI应用程序的Python类和用于使Web服务器对应用程序“讲话SCGI”的模块。如果您使用Red Hat软件包管理(RPM)，则可以使用yum install python-scgiapache2-mod_scgi；安装这些软件包。Debian APT用户可以使用apt-get install python-scgilibapache2-mod-scgi。</p><p>您也可以手动安装任一组件。Apache模块需要C编译器和Apache的APXS脚本。有些发行版将apxs保存在单独的开发包中，而不是将其作为常规Apache包的一部分进行安装。</p><p>假设您现在有了这些组件，接下来下载源tarball scgi-1.12.tar.gz，并运行清单1中所示的命令。</p><p>#从tarball tar xzf scgi-1.12.tar.gzcd scgi-1.12解压源目录scgi-1.12#构建Python partpython setup.py build#安装Python模块；我们需要root特权sudo python setup.py install#现在构建并安装Apache module ecd apache2sudo make install#在Apache中启用SCGI模块。这可能会失败，#取决于您的Apache版本，但没关系。sudo a2enmod scgi#使Apache的新配置生效sudo/etc/init.d/apache2强制重新加载。</p><p>现在，让我们确保一切正常。Python包是一个带有一些类的模块，通常情况下，您需要将您的应用程序编写为一个移植该模块的程序。但是，对于调试，您也可以将其作为独立的应用程序运行。当它收到来自Web服务器的请求时，它只是将请求的详细信息打印为文本页面。非常适合第一次测试-不需要编码！</p><p>在您的系统上找到scgi_server.py模块。它应该是installedin/usr/lib/python2.4/site-package/scgi(2.4在您的系统上可能是2.3或2.5)。然后，运行该模块：</p><p>这将在系统的TCP端口上侦听来自Web服务器的请求，默认情况下使用端口4000。您可以通过将所需的端口号作为命令行参数传递，使其侦听不同的端口，例如：</p><p>模块会一直运行，直到你杀死它，所以在一个单独的外壳中启动它。请记住，即使在Web服务器的身份下，您也不需要以Rootor身份运行SCGI服务器。</p><p>既然SCGI应用程序正在等待请求，那么在您的网站上选择一个位置来委托给该应用程序。假设您希望它响应此服务器上对“/scgitest”的所有请求。将清单2所示的Apache配置片段写入/etc/apache2/conf.d中的一个新文件。</p><p>#加载SCGI模块。只有在手动安装并且&#34；a2enmod scgi&##命令失败的情况下才真正需要此功能。LoadModule scgi_module/usr/lib/apache2/modules/mod_scgi.so&lt；Location&#34；/scgitest&#34；&gt；#在#其他属性(如Access#control#...&lt；/location&gt；)上启用SCGI SCGIHandler。#运行#/scgitest的SCGI服务器的主机名和端口号。#localhost(127.0.0.1)上的端口4000是默认值。SCGIMount/scgitest 127.0.0.1：4000。</p><p>正如您在这里看到的，SCGI服务器实际上不需要与Web服务器运行在同一台计算机上。只需确保SCGI服务器的端口已正确安装防火墙，这样只有您的Web服务器才能访问它！这样，您的应用程序可以确保所有的CGI参数都已首先由Web服务器验证。如果攻击者可以直接连接到您的SCGI应用程序，您将无法信任该信息。例如，CGI参数AUTHENTATED_USER告诉您的应用程序请求来自特定的登录用户。只有当您从正确配置的Web服务器听到它时，您才能相信这一点。</p><p>使用sudo/etc/init.d/apache2reload让Apache重新加载其配置。您的服务器现在应该服务于一个新位置/scgitest，当您访问它时，它只会打印您的请求的CGI参数。通过在浏览器中查找来验证这一点。如果您的服务器地址是example.org，请将浏览器指向http://example.org/scgitest.。您应该会看到一个如清单3所示的页面。</p><p>服务器软件：&#39；Apache&#39；script_name：&#39；/scgitest&39；request_method：&#39；get&#39；server_protocol：&#39；HTTP/1.1&#39；query_string：&#39；&#39；content_length：&#39；0&#39；HTTP_Accept_Charset：&#39；UTF-8，*&#39；HTTP_USER_AGENT：&#39；Mozilla/5.0&#39；Server_name：&#39；testserver.example.org&#39；Remote_ADDR：&#39；10.99.11.99&#39；server_Port：&#39；80&#39；server_addr：&#39；192.0.34.166&#39；document_root：&#39；/srv/www/&#39；server_admin：&#39；webmaster@example.org&#39；HTTP_host：&#39；testserver.example.org&#39；REQUEST_URI：&#39；/scgitest&#39；HTTP_ACCEPT：&#39；text/html，文本/纯文本，*/*；q=0.5&#39；远程端口：&#39；47088&#39；HTTP_ACCEPT_LANGUAGE：&#39；EN&#39；SCGI：&#39；1&#39；HTTP_ACCEPT_ENCODING：&#39；GZIP，DEFLATE&39；</p><p>如果这不是您看到的，请看一下您放置模块的shell。它可能在那里打印了一些有用的错误消息。或者，如果SCGI服务器没有任何反应，则可能是请求一开始就没有到达它；请检查Apache错误日志。</p><p>运行此程序后，恭喜您-最糟糕的情况已经过去。请停止您的SCGI服务器进程，使其不会干扰我们下一步要重新执行的操作。</p><p>我们导入SCGI Python模块，然后编写应用程序作为通过Web服务器传入的SCGI请求的处理程序。处理程序采用我们从SCGIHandler派生的类的形式。CALLME没有想象力，但我已经将示例处理程序称为classTimeHandler。我们稍后将填写实际代码，但先从这个框架开始：</p><p>#！/usr/bin/pythonimport scgiimport scgi.scgi_serverclass TimeHandler(scgi.scgi_server.SCGIHandler)：pass#(这里还没有代码)#main程序：创建一个SCGIServer对象以#侦听端口4000。我们告诉SCGIServer实现我们的应用程序的#HANDLER类。server=scgi.scgi_server.SCGIServer(HANDLER_CLASS=TimeHandler，port=4000)#告诉SCGIServer开始服务请求。#this loops forever.server.serve()。</p><p>您可能会觉得奇怪，我们必须向SCGIServer传递我们的Handler类，而不是处理程序对象。原因是服务器对象将根据需要创建给定类的处理程序对象。</p><p>TimeHandler的第一个实例在本质上仍然与最初的SCGIHandler相同，因此它所做的一切就是打印请求参数。要在实际操作中看到这一点，请尝试运行此程序并像以前一样在浏览器中打开scgitestpage。您应该再次看到类似清单3的内容。</p><p>现在，我们想以ABROWER能理解的形式打印时间。我们不能简单地开始发送文本或HTML；我们首先必须发出一个HTTP标头，告诉浏览器需要什么样的输出。在这种情况下，让我们继续使用简单文本。在程序顶部附近TimeHandler类定义的正上方添加以下内容：</p><p>Import timedef print_time(Outfile)：#描述我们大约要生成的页面的HTTP头。必须以双MS-DOS样式的#&#34；CR/LF&34；行尾序列结束。在Python中，#转换为&#34；\r\n.outfile.write(&#34；Content-Type：Text/Plain\r\n\r\n&#34；)#现在以纯文本outfile.write(time.ctime()+&#34；)#写入我们页面：时间。</p><p>到目前为止，您可能想知道如何让我们的处理程序类调用this函数。使用SCGI 1.12或更高版本，这很容易。我们可以编写一个method TimeHandler.Production()来覆盖SCGIHandler的默认操作：</p><p>类TimeHandler(scgi.scgi_server.SCGIHandler)：#(删除&#34；pass&#34；语句--现在我们在这里有了真正的#代码)#这是我们接收请求的地方：def Production(self，env，bodysize，input，output)：#做我们的工作：使用输出PRINT_TIME(OUTPUT)的时间写入页面。</p><p>我们在这里忽略它们，但是Production()有几个参数：env是禁止将CGI参数名映射到它们的值的。接下来，BodySize是请求正文或有效负载的大小(以字节为单位)。如果您对请求正文感兴趣，可以从以下参数INPUT中读取最大正文大小的字节。最后，输出是我们将输出页面写入到的文件。</p><p>如果您使用的是SCGI 1.11或更早版本，则需要一些包装器代码来实现此功能。在这些旧版本中，您可以覆盖不同的方法SCGIHandler.handleconnection()，并且您可以自己完成更多的工作。简单地将清单4中的样板代码复制到TimeHandler类中。它将进行正确的设置并调用Production()，因此其他内容不会改变，我们可以编写Production()，就像我们有了较新版本的SCGI一样。</p><p>#将此定义插入您的处理程序类：类TimeHandler(scgi.scgi_server.SCGIHandler)：#...。Def handle_connection(self，conn)：input=connec.makefile(&#34；r&#34；)output=connec.makefile(&#34；w&#34；)env=self.read_env(Input)bodysize=int(env.get(&#39；content_length&#39；，0))try：self.product(env，bodysize，input，output)last：output.close()input.close()Conn.close()。</p><p>接下来，为了让事情更有趣，让我们将一些参数传递给request，并让程序处理它们。Web应用程序的参数约定是在URL上加一个问号，后跟一系列参数，参数之间用“与”号分隔。每个参数的格式为name=value。如果我们想要向程序传递一个名为Pizza、值为Hawaii的参数，以及另一个名为Drink、值为Beer的参数，我们的URL看起来应该是likehttp://example.org/scgitest?pizza=hawaii&amp；drink=beer.。</p><p>访问者传递给程序的任何参数都以单个CGI参数query_string结束。在本例中，参数应该是“Pizas=Hawaii&amp；Drink=Beer”。下面是我们的TimeHandler可以用它做的一些事情：</p><p>Class TimeHandler(scgi.scgi_server.SCGIHandler)：def Production(self，env，bodysize，input，output)#读取参数argstring=env[&#39；query_string&#39；]#将参数字符串分解为#对的列表，如&#34；name=value&#34；arglist=argstring.plit(&#39；&amp；&#39；)#为arglist中的arg设置将参数名称#映射到值args={}的字典：(key，value)=arg.plit(&#39；=&#39；)args[key]=value#打印时间，与以前一样，但带有一点额外建议print_time(Output)output.write(&#34；吃披萨的时间。我会吃%s，然后大口喝%s！\n&34；%(args[&#39；披萨]，args[#39；饮料]))，我会吃%s，喝%s！\n#34；%(args[&#39；披萨]，args[#39；饮料]))。</p><p>现在，我们编写的应用程序不仅打印时间，还建议在URL中传递披萨和饮料。试试看！您还可以尝试清单3中的其他CGI参数，以查找您的SCGI应用程序可以做的更多事情。</p><p>一旦您习惯了使用SCGI编写程序，您可能希望调整现有的应用程序以使用它。一些著名的Web应用程序(如MoinMoin(维基)和Trac(基于维基的协作开发环境))被实现为Python模块。这两个示例都带有可以从Apache调用的Python CGI脚本。CGIscripts非常短；除了导入应用程序的模块并调用它们上的函数外，它们实际上不做任何事情。</p><p>如果您找到这样一个应用程序，您真正需要做的就是将少量的Python代码移到Production()方法中，如您在这里看到的示例所示。如果您使用的是SCGI1.12或更高版本，您可能还想看看另一个SCGIHandler方法Production_cgilike()。</p><p>这差不多是我们能容纳的全部地方了。如果您想知道CGI参数是如何工作的，请尝试查看CGI标准，该标准将它们称为“请求元变量”(请参阅参考资料)。</p><p>最后，给你一个警告。您将注意到，如果您不能传递预期的参数，那么最后一个示例程序就会死得很惨。SCGIS服务器会替换失败的进程，因此在这种情况下，没有真正的问题。但是，这应该会提醒您在编写Web应用程序时需要多么小心。永远不要相信你从外面收到的信息！如果一个程序可以崩溃，那么很可能有人会颠覆它，或者让它停止运行。世界各地的人都是为了好玩或盈利而做这样的事，所以要认真对待风险。</p><p>Jeroen Vermeulen就职于泰国软件产业促进局的开源部门。他目前正在研究Suriyan，这是一个为那些没有时间使用服务器系统的人设计的服务器系统。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.linuxjournal.com/article/9310">https://www.linuxjournal.com/article/9310</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/scgi/">#scgi</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/web/">#web</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1028284.html"><img src="http://img2.diglog.com/img/2020/10/thumb_2c9dacf999124dd88e9351beba2084ad.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1028284.html">“程序员的价格”(2014)</a></div><span class="my_story_list_date">2020-10-12 21:47</span></div><div class="col-sm"><div><a target="_blank" href="/story/1028255.html"><img src="http://img2.diglog.com/img/2020/10/thumb_3cd67f8c773c5df13d60d9d2e7f8918c.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1028255.html">Awfice-小型办公套件应用程序的集合</a></div><span class="my_story_list_date">2020-10-12 19:31</span></div><div class="col-sm"><div><a target="_blank" href="/story/1028065.html"><img src="http://img2.diglog.com/img/2020/10/thumb_d3334852ab33b71b938fd161c8bbc2e0.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1028065.html">240多个Android应用程序在显示断章取义的广告时被抓获</a></div><span class="my_story_list_date">2020-10-11 16:52</span></div><div class="col-sm"><div><a target="_blank" href="/story/1028019.html"><img src="http://img2.diglog.com/img/2020/10/thumb_c68fbc88cfdc4789b78dfe46b987f415.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1028019.html">创建使用更少资源的Slake应用程序</a></div><span class="my_story_list_date">2020-10-11 16:30</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>