<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>XDP EBPF防火墙 Xdp eBPF Firewall in Rust</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Xdp eBPF Firewall in Rust<br/>XDP EBPF防火墙 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-26 10:51:59</div><div class="page_narrow text-break page_content"><p>One of the option available today to do sub-millisecond packet filtering at scale is to harness the facilities affordedby XDP, eBPF, Linux kernel and support provided by various NIC manufacturers.</p><p>今天可用的选项之一是在刻度下进行分毫秒的数据包过滤是为了利用各种NIC制造商提供的XDP，EBPF，Linux内核和支持的设施。</p><p> The two (XDP and eBPF) have grown quite rapidly in the 5.x release of the Linux kernel and there is absolutely no reasonyou would not want to use it for your low-latency, high-performance use case.</p><p> 两个（XDP和EBPF）在Linux内核的5.x发布中迅速增长，绝对没有理由不希望将其用于低延迟，高性能用例。</p><p> In this post, I will be demonstrating a sample XDP code that performs IP-layer firewall function traditionally done byNetfilter/IPtables (thanks for all the fish Rusty Russell!) but ran as a offloaded XDP program by the eBPF VM in theLinux kernel. The walk-through was thoroughly tested on Ubuntu 20.10 with LLVM version 11.0.0 on QEMU/virtio. LLVM is requiredtoday because it can produce eBPF targets.</p><p> 在这篇文章中，我将演示一个示例XDP代码，它传统上由NetFilter / Iptables完成的IP层防火墙函数（谢谢您对所有鱼生锈的Russell！），但在Thelinux内核中的EBPF VM作为卸载的XDP程序。步行通过QEMU / Virtio的LLVM版本11.0.0彻底测试了Ubuntu 20.10。 LLVM是必填节，因为它可以产生EBPF目标。</p><p> According to XDP developers, on a benchmark they conducted, XDP far out-performed traditional kernel network stack onLinux on all fronts -  tx,  rx and  forward (in the order of 12-25x!) when used with a NIC that that offloads XDPsuch as the ones from Intel/Mellanox/Netronome (mlx/ixgbe/nfp etc).</p><p> 根据XDP开发人员，在他们进行的基准测试中，XDP远离所有前端的传统内核网络堆栈onlinux  -  TX，RX和向前（按12-25倍的顺序），与NIC一起卸载XDPSUCH时来自英特尔/ Mellanox / Netronome（MLX / IXGBE / NFP等）的那些。</p><p>  We show that XDP achieves single-core packet processing per-formance as high as 24 million packets per second, and illustratethe flexibility of the programming model through three exampleuse cases: layer-3 routing, inline DDoS protection and layer-4 loadbalancing</p><p>  我们展示XDP每秒实现单核包处理的单核包处理，每秒高达2400万个数据包，并通过三个empluseUSE案例揭示编程模型的灵活性：第3层路由，内联DDOS保护和第4层LoadBaligancing</p><p>   $ sudo apt-get install \ build-essential \ libelf-dev \ ca-certificates \ ca-certificates-java \ zlib1g-dev \ llvm-11-dev \ libclang-11-dev \ linux-headers-$(uname -r)</p><p>   $ sudo apt-get install \ build-assigent \ libelf-dev \ ca-certificates \ ca-certificates-java \ zlib1g-dev \ llvm-11-dev \ libclang-11-dev \ linux-head  -  $（uname -r ）</p><p>  $ curl --proto &#39;=https&#39; --tlsv1.2 -sSf https://sh.rustup.rs | sh$ . ~/.bashrc # or logout then login.$ rustup install nightly$ rustup default nightly$ rustc --version</p><p>  $ curl  -  proto＆＃39; = https＆＃39; --tlsv1.2 -ssf https://sh.rustup.rs |谢。 〜/ .bashrc＃或注销然后登录。$ Rustup安装夜晚$ Rustup默认夜晚$ rustc -version </p><p>  $ sudo -i$ curl --proto &#39;=https&#39; --tlsv1.2 -sSf https://sh.rustup.rs | \ env RUSTUP_HOME=/opt/rust/rustup CARGO_HOME=/opt/rust/cargo \ sh -s -- --default-toolchain stable --profile default --no-modify-path -y$ tee -a /root/.bashrc &lt;&lt;HD# setup Rust environmentexport RUSTUP_HOME=/opt/rust/rustupexport PATH=${PATH}:/opt/rust/cargo/binHD$ . /root/.bashrc # or logout then login.$ rustup install nightly$ rustup default nightly$ rustc --version</p><p>$ sudo -i $ curl  -  proto＆＃39; = https＆＃39; --tlsv1.2 -ssf https://sh.rustup.rs | \ Env Rustup_home = / Opt / Rust / Rustup Cargo_Home = / Opt / Rust / Cargo \ Sh -s  -  --default-Toolchain稳定 - 新手默认--no-modify-path -y $ tee -a / root / .bashrc＆lt;＆lt;＆lt; hd＃setup rose renceentexport rustup_home = / opt / rust / rustupExport路径= $ {path}：/ opt / rust / cargo / binhd $。 /root/.bashrc＃或注销然后登录。$ Rustup安装夜间$ Rustup默认夜晚$ rustc -version</p><p>         [package] name  =  &#34;xdp-ebpf-fw&#34; version  =  &#34;0.1.0&#34; edition  =  &#39;2018&#39; [dependencies] cty  =  &#34;0.2&#34; redbpf-macros  =  &#34;1.3&#34; redbpf-probes  =  &#34;1.3&#34; [build-dependencies] cargo-bpf  =  {  version  =  &#34;1.3&#34; ,  default-features  =  false  } [features] default  =  [] probes  =  [] [lib] path  =  &#34;src/lib.rs&#34; [[bin]] name  =  &#34;fw&#34; path  =  &#34;src/fw/main.rs&#34; required-features  =  [&#34;probes&#34;]</p><p>         [包]名称=＆＃34; xdp-ebpf-fw＆＃34;版本=＆＃34; 0.1.0＆＃34; Edition =＆＃39; 2018＆＃39; [依赖关系] cty =＆＃34; 0.2＆＃34; Redbpf-macros =＆＃34; 1.3＆＃34; Redbpf-probes =＆＃34; 1.3＆＃34; [构建 - 依赖关系] Cargo-BPF = {Version =＆＃34; 1.3＆＃34; ，默认特征= false} [功能]默认= []探针= [] [lib] path =＆＃34; src / lib.rs＆＃34; [[bin]]名称=＆＃34; fw＆＃34;路径=＆＃34; src / fw / main.rs＆＃34;必需特征= [＆＃34;探头＆＃34;]</p><p>  #![no_std] #![no_main] use  core :: fmt :: Error ; use  cty :: * ; use  redbpf_probes :: xdp :: prelude :: * ; program! ( 0xFFFFFFFE ,  &#34;GPL&#34; ); const  TCP_XDP_DROP :  XdpAction  =  XdpAction :: Drop ; const  UDP_XDP_DROP :  XdpAction  =  XdpAction :: Drop ; const  XDP_PASS :  XdpAction  =  XdpAction :: Pass ; // XDP/eBPF based IP-layer firewall to drop all UDP packets. // And, also drop all TCP packets destined to port 80. #[xdp] pub  fn  xdp_ip_firewall ( ctx :  XdpContext )  -&gt;  XdpResult  {  if  let  Ok ( ip_protocol )  =  get_ip_protocol ( &amp; ctx )  {  match  ip_protocol  as  u32  {  IPPROTO_UDP  =&gt;  return  Ok ( UDP_XDP_DROP ),  // drop it on the floor  IPPROTO_TCP  =&gt;  {  if  let  Ok ( transport )  =  ctx .transport ()  {  if  transport .dest ()  ==  80  {  return  Ok ( TCP_XDP_DROP );  // drop it on the floor  }  }  }  _  =&gt;  return  Ok ( XDP_PASS ),  // pass it up the protocol stack  }  }  return  Ok ( XDP_PASS );  // pass it up the protocol stack } fn  get_ip_protocol ( ctx :  &amp; XdpContext )  -&gt;  Result &lt; u32 ,  Error &gt;  {  if  let  Ok ( ip )  =  ctx .ip ()  {  // We need to make raw pointer into a u32 so `unsafe` is required.  unsafe  {  return  Ok (( * ip ) .protocol  as  u32 );  }  }  // Anything above `255` is reserved.  return  Ok ( 0x10000 ); }</p><p>  ＃！[no_std]＃！[no_main]使用核心:: fmt ::错误;使用cty :: *;使用redbpf_probes :: xdp :: prelude :: *;程序！ （0xFFFFFFFE，＆＃34; GPL＆＃34;）; const tcp_xdp_drop：xdpaction = xdpaction :: drop; const udp_xdp_drop：xdpaction = xdpaction :: drop; const xdp_pass：xdpaction = xdpaction :: pass; //基于XDP / EBPF的IP层防火墙删除所有UDP数据包。 //，也将所有TCP报文丢弃到端口80.＃[XDP] PUB FN XDP_IP_FIREWALL（CTX：XDPContext） - ＆gt; xdpresult {如果let确定（ip_protocol）= get_ip_protocol（＆amp; ctx）{匹配ip_protocol，因为u32 {ipproto_udp =＆gt;返回OK（UDP_XDP_DROP），//将其放在底部IPPROTO_TCP =＆gt; {如果let确定（传输）= ctx .transport（）{如果传输.dest（）== 80 {returne ok（tcp_xdp_drop）; //将其放在地板上}}}}}} _ =＆gt;返回OK（XDP_PASS），//将其传递给协议栈}} return OK（XDP_PASS）; //将协议栈} fn get_ip_protocol（ctx：＆amp; xdpcontext）传递给调情堆栈} fn get_ip_protocol  - ＆gt;结果＆lt; U32，错误＆gt; {如果LET OK（IP）= CTX .IP（）{//我们需要将原始指针切入U32，所以需要不安全的方式。不安全{返回OK（（* IP）.PROTOCOLAS为U32）; }} //以上的任何东西都保留。返回OK（0x10000）; }</p><p>    On QEMU, we need to add 2 N queues (where  N is the number of vCPUs). The following  &lt;driver&gt; section is required inside  &lt;interface&gt; (use  virsh edit [vmname]) is required (for 4 vCPUs, allocate 8 queues) as of QEMU version 4.2.1.</p><p>    在Qemu上，我们需要添加2 n个队列（其中n是vcpus的数量）。以下＆lt;司机＆gt;在内部＆lt; interface＆gt中需要部分。 （使用virsh编辑[vmname]）是必需的（对于qemu版本4.2.1的4个vcpus，分配8次队列）。</p><p> &lt;interface ...&gt;[ ... ]&lt;driver name=&#39;vhost&#39; txmode=&#39;iothread&#39; ioeventfd=&#39;on&#39; event_idx=&#39;off&#39; queues=&#39;8&#39; rx_queue_size=&#39;256&#39; tx_queue_size=&#39;256&#39;&gt; &lt;host csum=&#39;off&#39; gso=&#39;off&#39; tso4=&#39;off&#39; tso6=&#39;off&#39; ecn=&#39;off&#39; ufo=&#39;off&#39; mrg_rxbuf=&#39;off&#39;/&gt; &lt;guest csum=&#39;off&#39; tso4=&#39;off&#39; tso6=&#39;off&#39; ecn=&#39;off&#39; ufo=&#39;off&#39;/&gt;&lt;/driver&gt;[ ... ]&lt;/interface&gt;</p><p> ＆lt; interface ...＆gt; [...]＆lt;驱动程序名称=＆＃39; vhost＆＃39; txmode =＆＃39; iothread＆＃39; ioeventfd =＆＃39;＆＃39; event_idx =＆＃39;关闭＆＃39;队列=＆＃39; 8＆＃39; rx_queue_size =＆＃39; 256＆＃39; tx_queue_size =＆＃39; 256＆＃39;＆gt; ＆lt;宿主csum =＆＃39;关闭＆＃39; GSO =＆＃39; OFF＆＃39; tso4 =＆＃39;关闭＆＃39; TSO6 =＆＃39; OFF＆＃39; ECN =＆＃39; OFF＆＃39; UFO =＆＃39; OFF＆＃39; MRG_RXBUF =＆＃39; OFF＆＃39; /＆gt; ＆lt; guest csum =＆＃39;关闭＆＃39; tso4 =＆＃39;关闭＆＃39; TSO6 =＆＃39; OFF＆＃39; ECN =＆＃39; OFF＆＃39; UFO =＆＃39; off＆＃39; /＆gt;＆lt; /＆gt;＆gt; [...]＆lt; / interface＆gt;</p><p>    If you like the post, feel free to support me via BuyMeACoffee or Patreon.                Thank you.</p><p>    如果您喜欢这篇文章，请随时通过Buymeacoffee或Patreon支持我。谢谢你。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://pub.gctl.io/xdp-ebpf-firewall-in-rust/">https://pub.gctl.io/xdp-ebpf-firewall-in-rust/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ebpf/">#ebpf</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/xdp/">#xdp</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>