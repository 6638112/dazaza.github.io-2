<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>OpenBSD上的工作D编译器 A working D compiler on OpenBSD</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">A working D compiler on OpenBSD<br/>OpenBSD上的工作D编译器 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-20 23:35:12</div><div class="page_narrow text-break page_content"><p>I got  GDC, the GNU D Compiler, working on  OpenBSD. Supporting  D has been a very long time coming. Here&#39;s the story of how we got here and where we need to go next.</p><p>我得到了GDC，GNU D编译器，在OpenBSD上工作。支持D已经很长时间了。在这里，我们在这里到达的故事以及我们需要走的故事。</p><p>  Way back in 2017 is when I first learned about D. Seemed interesting and we didn&#39;t have a port of it. I like challenges so I figured I would give it a try. I eventually managed to get  LDC, the LLVM D Compiler, to build on OpenBSD. Or, at least, its LTS version. That is the last version that does not need a D compiler to bootstrap and it claims to be able to build current versions of LDC. I never ended up trying it so I was never able to directly confirm this, but I have no reason to doubt them.</p><p>  回到2017年的方式是我第一次学习D.似乎有趣，我们没有港口。我喜欢挑战所以我想我会试一试。我最终设法获得LDC，LLVM D编译器，在OpenBSD上构建。或者，至少，它的LTS版本。这是一个不需要D编译器来引导的最后一个版本，并且声称能够构建最新版本的LDC。我从来没有结束尝试它，所以我从来没有能够直接证实这一点，但我没有理由怀疑他们。</p><p> But then I was stuck. See, D inherits the C library entirely. And the D standard library, Phobos, effectively requires complete bindings to libc. There were none for OpenBSD, though there was a completed Phobos for  FreeBSD. I tried to replicate the FreeBSD bindings on OpenBSD but was never able to finish it. There are enough subtle differences between FreeBSD and OpenBSD and I just did not have the time to finish it. It would have to be on the perpetual back burner until I could devote substantial resources to it.</p><p> 但后来我被困了。请参阅，d完全继承C库。而D标准库，PHOBOS，有效地需要与LIBC完全绑定。 OpenBSD没有OPER，虽然有一个完整的FreeBSD的PHOBOS。我试图复制OpenBSD上的FreeBSD绑定，但绝不能完成它。 FreeBSD和OpenBSD之间有足够的微妙差异，我只是没有时间完成它。直到我可以致力于它的重要资源，必须在永久的背部燃烧器上。</p><p>  In the interim years, people continued to add support for OpenBSD. There have been commits targeting OpenBSD support for  dmd, the D reference compiler,  druntime, the static support library that provides the libc bindings, and  phobos, the D standard library. I suspect no one really ever attempted to run the complete D toolchain on OpenBSD however. These commits were not enough. However, I am glad that I did not have to do that work so much thanks to everyone who made my job that much easier!</p><p>  在临时岁月中，人们继续为OpenBSD增加支持。已经提交针对DMD的OpenBSD支持，D参考编译器，Druntime，静态支持库提供Libc绑定，以及D标准库。然而，我怀疑没有人真正尝试在OpenBSD上运行完整的D Toolchain。这些提交不够。然而，我很高兴我不必这样做，感谢每个人的工作，这让我的工作更容易！</p><p>   It began with a stroke of happenstance. It is no secret that I have been tracking  GCC head on OpenBSD for a long time. As of GCC 9, GDC is  incorporated into gcc. And it just so happens that at the moment GDC&#39;s D frontend is still written in C++. We might well be able to compile it! So I added d to the list of languages to build on my buildbot and waited to see what happened.</p><p>   它开始了陷入困境。很久没有秘密，我一直在OpenBSD上跟踪GCC头。截至GCC 9，GDC被纳入GCC。它就是如此，即时GDC＆＃39; s d前端仍然用c ++写入。我们可能能够编译它！所以我在我的BuildBot上添加了要构建的语言列表，并等待看到发生了什么。</p><p> Well it failed. Probably unsurprisingly. First order of business: add OpenBSD to libphobos&#39;s configure.tgt. Try again and... more failure. In the math library bindings for OpenBSD, druntime was looking for an __fpclassifyd symbol but on OpenBSD that symbol is named __fpclassify. Fix that and... well, it built! But it didn&#39;t actually support OpenBSD. Turns out you have to add additional support files to the gcc build to get gdc to recognize OpenBSD. It took far too long to figure that out than I would have expected.</p><p> 好吧它失败了。可能不想出来。第一顺序业务：将OpenBSD添加到libphobos＆＃39; s configure.tgt。再试一次，...更多失败。在OpenBSD的数学库绑定中，Druntime正在寻找__fpclassifyd符号，但在OpenBSD上的符号名为__fpclassify。修复它......好吧，它建成了！但它实际上支持OpenBSD。事实证明，您必须向GCC Build添加其他支持文件以获取GDC识别OpenBSD。比我预期的那样太长了。</p><p> Some other fixes later and we finally had a fully built gdc that recognized OpenBSD. Most things worked. But strangely,  dub, the D package manager, would segfault when trying to fetch packages remotely. I ultimately discovered that using the static libgphobos.a rather than the shared libgphobos.so fixed the issue. I do not know why this works but I have gone ahead and disabled the building and installing of the shared libgphobos for now. It is akin to statically compiling libc into all your C programs, which I personally don&#39;t mind so much. The Phobos library is not that large and I don&#39;t have many D programs on my machine right now.</p><p> 其他一些修补程序稍后，我们终于拥有一个完全建立的GDC，即识别OpenBSD。大多数事情都在工作。但奇怪的是，DUB，D包管理器将在尝试远程获取软件包时拍摄。我最终发现，使用静态的libgphobos.a而不是共享libgphobos.so修复了问题。我不知道为什么这是作品，但我已经前进并禁用了现在的建筑物和安装共享的Libgphobos。它类似于静态编制Libc进入所有C程序，我个人不＆＃39;这么多。 Phobos库不是那么大，我现在没有在我的机器上有很多D节目。 </p><p>  I ended up forward-porting OpenBSD support for dmd, which was  committed. This dmd, which can be bootstrapped from gdc, is able to rebuild itself when using the forward-ported druntime, which is  pending commit. Having the reference compiler able to rebuild itself is a great step towards ensuring continual D support. Even though the D Language Foundation  does not officially support OpenBSD,  Walter Bright, the creator of D, told me that upstreaming support for OpenBSD is welcome. I am happy with that arrangement and it is much appreciated.</p><p>我最终提出了对DMD的转发OpenBSD支持，该支持是致电的。可以从GDC引导的DMD能够在使用前往移植的Druntime时重建，因此正在进行提交。具有能够重建本身的参考编译器是确保持续的D支持的一步。即使D语言基础没有正式支持OpenBSD，D，Creator的Walter Bright，请告诉我，欢迎对OpenBSD的上游支持。我对这种安排感到满意，很受欢迎。</p><p>  While all three D compilers can be built once you have GDC, only GDC fully works. This is because D requires  thread-local storage, which OpenBSD does not yet support. GDC gets around this by using the emulated TLS from GCC, with the addition of GDC&#39;s own additional TLS emulation. This works fine on OpenBSD. I have not yet tried to port the GDC TLS emulation over to DMD or LDC, but it is on my list of things to try. Perhaps that will be sufficient.</p><p>  虽然所有三个D编译器都可以构建一旦您拥有GDC，只有GDC全部工作。这是因为d需要线程本地存储，OpenBSD尚不支持。通过使用来自GCC的模拟TLS来实现GDC，添加GDC＆＃39;自己的额外TLS仿真。这在OpenBSD上有效。我尚未尝试将GDC TLS仿真映射到DMD或LDC，但它位于我的尝试列表中。也许这就是足够的。</p><p>  The very first thing I did after getting GDC fully working was to create a  package that provides D bindings for  pledge(2). Any decent language has such bindings. It was extremely easy to implement as well. And now that the package is published, you can simply add it as a dependency to your D programs and benefit from OpenBSD&#39;s security features. Yes, I will add  unveil(2) too eventually.</p><p>  GDC完全工作后我做的第一件事是创建一个为承诺提供D绑定的包（2）。任何体面的语言都有这样的绑定。它也很容易实施。现在包已发布，您可以简单地将其添加为您的D程序以及从OpenBSD中受益于OpenBSD和＃39; S安全功能。是的，我最终会加入揭幕（2）。</p><p>  I am not sure how a port of gdc would work. I still need to upstream the changes for gdc. I guess if people want to try gdc for themselves, I can provide you with packages that set it up on your system. But you will get the entirety of gcc-11.0.1. No apologies there. And zero support whatsoever. Not only is it not a real package, by the time you install it, I will already have moved on to whatever the latest HEAD of the gcc tree is. More ideally, we will get emulated TLS support on either DMD or LDC (or both). I could then easily perform the bootstrap with gdc. We can easily provide ports for both dmd and ldc once they are bootstrapped and have emulated TLS.</p><p>  我不确定GDC港口如何工作。我仍然需要上游GDC的变化。我想如果人们想要为自己尝试GDC，我可以为您提供将其设置在系统上的软件包。但是您将获得全部GCC-11.0.1。没有道歉。并零支持。当您安装它时不仅是真正的包，我将已经搬到了GCC树的最新头部。理想情况下，我们将在DMD或LDC（或两者）上获得模拟TLS支持。然后，我可以轻松地使用GDC执行Bootstrap。我们可以轻松为DMD和LDC进行启动并具有仿真TLS，为DMD和LDC提供端口。</p><p>  That&#39;s the condensed story of how I finished the last mile for D support on OpenBSD. I think I may submit this as a talk to the next  DConf conference. I think that would be fun and would provide a different kind of talk that would still be quite interesting for everyone.</p><p>  那个＆＃39;我如何在OpenBSD上完成最后一英里的最后一英里的凝聚体故事。我想我可以将此作为与下一个DConf会议的谈话。我认为这会很有趣，并会提供一种不同的谈话，对每个人来说仍然非常有趣。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://briancallahan.net/blog/20210320.html">https://briancallahan.net/blog/20210320.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/编译/">#编译</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/compiler/">#compiler</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/openbsd/">#openbsd</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>