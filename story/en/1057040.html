<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>电脑视觉和刺绣 Computer Vision and Embroidery</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Computer Vision and Embroidery<br/>电脑视觉和刺绣 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-08 22:09:02</div><div class="page_narrow text-break page_content"><p>Over the weekend, I wrote a program that tries to identify which DMC threads are used in embroidery hoop images. I didn’t take a computer vision course at university — nor had I used OpenCV before — so it was fun to learn a few things and I hope you learn from my learnings.</p><p>在周末，我写了一个试图确定刺绣箍图像中使用的DMC线程的程序。我没有在大学拍摄电脑视觉课程 - 我之前也没有使用过OpenCV  - 所以要学习一些事情很有趣，我希望你能从我的学习中学到。</p><p> It all started when my wife wanted to find out what colors were used in a few of the hoops posted to r/embroidery. Thus, I embarked on an over-engineered solution: a Python CLI that guesses and then overlays the DMC thread color palette on a given image.</p><p> 当我的妻子想了解一些在r /刺绣的篮子里使用了哪些颜色时，这一切都开始了。因此，我开始了过度设计的解决方案：猜测的Python CLI，然后覆盖给定图像上的DMC线程调色板。</p><p>  To get started, I reviewed 100 hoops recently posted to r/embroidery and saw that they were photographed straight on with the hoop near the center. Having a fairly uniform structure, I figured that a little computer vision script could help me out. The hoops being near-perfect circles made them a great target for OpenCV’s  Hough Circle Transform. However, the photographs were very noisy. Lots of things appeared like circles and the function took a long time due to the high resolution.</p><p>  要开始，我审查了100个篮球最近发布到R /刺绣，并看到它们直接拍摄了中心靠近中心的箍。具有相当均匀的结构，我认为一点电脑视觉脚本可以帮助我。篮球是近乎完美的圈子使它们成为OpenCV的Hough圈变换的伟大目标。然而，照片非常嘈杂。很多东西出现在圈子中，由于高分辨率，该功能花了很长时间。</p><p> So to better target the hoop area, I used a series of destructive filters — the image is scaled down, converted to gray and then the following are applied:  GaussianBlur,  medianBlur,  adaptiveThreshold,  erode,  dilate. As we see below, this makes the hoop more identifiable to  HoughCircles.</p><p> 因此，为了更好地瞄准箍区域，我使用了一系列破坏性滤波器 - 将图像缩小，转换为灰色，然后应用以下内容：高斯本金，中美洲，适应性的，侵蚀，扩张。正如我们所看到的，这使得箍与Houghcircles更可识别。</p><p>  I tuned the values for these filters after running the program on the 100 r/embroidery posts I had. The full source code for the program I built can be found at  healeycodes/embroidery-vision.</p><p>  在我拥有的100 r /绣花帖子上运行程序后，调整这些过滤器的值。我构建的程序的完整源代码可以在HEALEYCODES / HARVIZE-VISION中找到。</p><p> def  apply_destructive_filters (image ) :  &#34;&#34;&#34; Apply a series of destructive filters with the aim of making circles more visible to the HoughCircles function. &#34;&#34;&#34; kernel  = np .ones ( ( 5 ,  5 ) , np .uint8 ) filtered_image  = cv2 .cvtColor (image , cv2 .COLOR_BGR2GRAY ) filtered_image  = cv2 .GaussianBlur (filtered_image ,  ( 5 ,  5 ) ,  0 ) filtered_image  = cv2 .medianBlur (filtered_image ,  5 ) filtered_image  = cv2 .adaptiveThreshold ( filtered_image ,  255 , cv2 .ADAPTIVE_THRESH_GAUSSIAN_C , cv2 .THRESH_BINARY ,  11 ,  3.5  ) filtered_image  = cv2 .erode (filtered_image , kernel , iterations = 1 ) filtered_image  = cv2 .dilate (filtered_image , kernel , iterations = 1 )  return filtered_image</p><p> def apply_destructive_filters（图像）：＆＃34;＆＃34;＆＃34;应用一系列破坏性滤波器，目的是对Houghcircles功能更加明显的圆圈。 ＆＃34;＆＃34;＆＃34; kernel = np .ones（（5,5），np .uint8）filtered_image = cv2 .cvtcolor（图像，cv2 .color_bgr2gray）filtered_image = cv2 .gaussianblur（filtered_image，（5,5），0）filtered_image = cv2 .medianblur（ filtered_image，5）filtered_image = cv2 .adaptivethreshold（filtered_image，255，cv2 .adaptive_thresh_gaussian_c，cv2 .thresh_binary，11,3.5）filtered_image = cv2 .erode（filtered_image，内核，iterations = 1）filtered_image = cv2 .dilate（filtered_image，ernel，迭代= 1）返回filtered_image</p><p> It’s common for multiple circles to be found. When this happens, I pick the largest and most central one. This can be seen in the previous image. The valid circle is green. I sometimes found partial circles that matched the hoop criteria (large and central). However, these were background shapes. Users rarely posted zoomed in images of hoops so I discarded circles that went beyond the edge.</p><p> 可以找到多个圆圈是常见的。当发生这种情况时，我挑选最大，最中心的。这可以在上一个图像中看到。有效的圆圈是绿色的。我有时发现部分圆圈匹配箍标准（大和中央）。然而，这些是背景形状。用户很少发布在箍的图像中放大，因此我丢弃了超越边缘的圆圈。 </p><p> The valid circle often included part of the hoop’s border. I didn’t want to consider the color of the border as a thread so I shrunk the hoop area by 1% to hide it.</p><p>有效圆圈通常包括箍边框的一部分。我不想将边界的颜色视为一个螺纹，所以我缩小了箍区域1％以隐藏它。</p><p>  There are 454 DMC thread colors. They’re called things like  Beige Gray Ult Dk. The goal is to take the RBG color of the photographed threads and find the closest matching DMC color. I don’t account for lighting conditions (how would you do this?) which lowers the accuracy of the results. My program finds some threads and guesses wrong for the others. For nearest-color lookups, I used the k-d tree from  scipy.spatial.KDTree.</p><p>  有454个DMC螺纹颜色。他们被称为米色灰色ult dk这样的东西。目标是采取拍摄线程的RBG颜色并找到最接近的匹配DMC颜色。我不考虑照明条件（您将如何做到这一点？）降低结果的准确性。我的程序找到了一些线程并猜测其他线程。对于最近的颜色查找，我使用了来自Scipy.spatial.kdtree的K-D树。</p><p> def  rgb_to_dmc (r , g , b ) : tree  = sp .KDTree (rgb_colors ) _ , result  = tree .query ( (r , g , b ) )  # return the index of `rgb_colors`  return result</p><p> def rgb_to_dmc（r，g，b）：tree = sp .kdtree（rgb_colors）_，结果=树.query（（r，g，b））＃返回`rgb_colors`返回结果的索引</p><p> When I tried calling this on every pixel in the hoop area, the palette it built had too many colors. When there was one kind of dark red thread in the image, the palette would have six or seven different DMC reds. I needed to better group colors together so I quantized the image.</p><p> 当我尝试在箍区域中的每个像素上打电话时，它构建的调色板太多了。当图像中有一种深红色线时，调色板将有六个或七种不同的DMC红色。我需要将组颜色更好地一起，因此我量化了图像。</p><p> # https://stackoverflow.com/a/20715062 def  quantize_image (image , div = 64 ) :  &#34;&#34;&#34; Reduces the number of distinct colors used in an image. &#34;&#34;&#34; quantized  = image  // div  * div  + div  //  2  return quantized</p><p> ＃https://stackoverflow.com/a/20715062 def量化_image（图像，div = 64）：＆＃34;＆＃34;＆＃34;减少图像中使用的不同颜色的数量。 ＆＃34;＆＃34;＆＃34;量化=图像// div * div + div // 2返回量化</p><p> Compressing the color space like this means that instead of finding multiple dark reds we just find one (hopefully the right one). Here’s an image before and after the above function is applied.</p><p> 压缩颜色空间，如此意味着，而不是找到多个深红色，我们只找到一个（希望正确的黑色）。这是应用上述功能之前和之后的图像。</p><p>   Calling a k-d tree lookup for every pixel in a high resolution image was slow. For the example image I’ve been using in this post, there are 600k pixels (which mean the same number of lookups) but only 30 different colors. Adding a cache was a no-brainer. Python’s built in Least Recently Used (LRU) cache worked great and now our 600k calls are performed in constant time.</p><p>   为高分辨率图像中的每个像素调用K-D树查找很慢。对于我在此帖子中使用的示例图像，有600k像素（这意味着相同的查找数量），但只有30种不同的颜色。添加缓存是一个禁智的人。 Python建于最近使用的（LRU）缓存的建立得很好，现在我们的600K呼叫在不断的时间内执行。 </p><p>  With the colors found, I drew the palette over the image with the DMC identification numbers. The palette is also sent to standard output (a list of e.g.  #647 Beaver Gray Med 15.81%)</p><p>使用DMC识别号码，我将调色板绘制在图像上。调色板也被发送到标准输出（例如，例如，＃647 Beaver Gray Med 15.81％）</p><p>  I found using OpenCV’s APIs to be quite straight forward due to the amount of documentation and blog posts online. Whenever I had a question, a search brought me a vaguely related answer. Perhaps I underestimated the popularity of the library. The hardest part (as always) was figuring out the right question to ask.</p><p>  由于在线文档和博客帖子的数量，我发现使用OpenCV的API非常直接。每当我有一个问题时，一个搜索给我带来了一个模糊相关的答案。也许我低估了图书馆的普及。最困难的部分（一如既往地）是询问的正确问题。</p><p> # overlay the color palette on top of the image_ , w , _  = original_image .shapesize  =  int (w  /  len (filtered ) )y  = size for idx , color  in  enumerate (filtered ) : b , g , r  =  ( dmc_colors [color [ 0 ] ] [ &#34;blue&#34; ] , dmc_colors [color [ 0 ] ] [ &#34;green&#34; ] , dmc_colors [color [ 0 ] ] [ &#34;red&#34; ] ,  ) cv2 .rectangle ( original_image ,  (size  * idx ,  0 ) ,  ( (size  * idx )  + size , size ) ,  (b , g , r ) ,  - 1  ) cv2 .putText ( original_image , dmc_colors [color [ 0 ] ] [ &#34;floss&#34; ] ,  (size  * idx , size  -  7 ) , cv2 .FONT_HERSHEY_SIMPLEX ,  0.5 ,  ( 255  - b ,  255  - g ,  255  - r ) ,  1 ,  )</p><p> ＃覆盖图像顶部的调色板，w，_ = reation_image .shapesize = int（w / len（filtered））y = idx的大小，枚举中的颜色（过滤）：b，g，r =（dmc_colors [颜色[0]] [＆＃34;蓝色＆＃34;]，dmc_colors [color [0]] [＆＃34;绿色＆＃34;]，dmc_colors [color [0]] [＆＃34;红色＆＃34; ]，）cv2 .rectangle（original_image，（size * idx，0），（（size * idx）+大小，大小），（b，g，r）， -  1）cv2 .puttext（original_image，dmc_colors [color [color [ 0] [＆＃34;牙线＆＃34;]，（size * idx，size-7），cv2 .font_hershey_simplex，0.5，（255  -  b，255  -  g，255  -  r），1，）</p><p>  I try to do most of my work in public on GitHub. This helps people (many more people than I ever expected to help) but I’m most interested in the effect it has on expanding my network of like-minded makers. It’s a joy to receive a message, issue, or PR on any of my work.</p><p>  我试着在Github上公开做大部分工作。这有助于人们（更多的人比我预期的更多人提供帮助），但我最感兴趣的是它对扩大我的志同道合的制造商网络的影响。在任何工作中收到留言，问题或公关是一种喜悦。</p><p> When I make a repository public I aim to have a comprehensible README and some tests. For this project, the DMC color lookup is unit tested and example images are used for end to end testing. I added a GitHub Action so that it’s easy for people to check their PRs are passing (it’s also good to get an email when I’ve broken something by editing a source file on my phone!). This project is less likely to see collaboration as it’s a learning project for me and not really a general tool. It’s me-ware. Plus, it doesn’t really work.</p><p> 当我制作一个存储库公共时，我的目标是拥有一个可易化的自述文件和一些测试。对于此项目，DMC颜色查找是由测试的单元，示例图像用于端到端测试。我添加了一个GitHub动作，以便让人们检查他们的PRS是通过的（当我在手机上编辑源文件时，我也很高兴收到一封电子邮件！）。这个项目不太可能看到合作，因为它是我的学习项目，而不是一般工具。这是我的洁具。另外，它并没有真正的工作。</p><p> Lately, I’ve been using Mypy for my open source Python code. It’s been catching bugs and enforcing better code patterns. But sadly, I couldn’t get the OpenCV type stubs to work so I removed  mypy . from my usual GitHub Action.</p><p> 最近，我一直在使用Mypy为我的开源Python代码。它一直捕获错误并强制执行更好的代码模式。但可悲的是，我无法让OpenCV类型的存根工作，所以我删除了mypy。从我通常的github行动。</p><p>   Finally, I’ll finish up with an open source license like MIT. I’d hate for someone to learn something from one of my toy projects but not be able to use it. I always try to present my work as if there are end users for it — a process that makes coming back to my code far easier than if I hadn’t.</p><p>   最后，我将使用像麻省理工学院那样的开源许可证完成。我讨厌某人从我的玩具项目中学习一些东西，但不能使用它。我总是试着介绍我的工作，就好像有它的最终用户一样 - 一个过程让我的代码更容易，而不是我没有。 </p><p>  Comments or questions? I enjoy talking with readers over  email. I write about code. Get my posts, projects, and personal updates straight to your inbox!</p><p>评论或问题？ 我喜欢通过电子邮件与读者交谈。 我写了关于代码。 将我的帖子，项目和个人更新直接到您的收件箱！ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://healeycodes.com/computer-vision-and-embroidery/">https://healeycodes.com/computer-vision-and-embroidery/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/电脑/">#电脑</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/视觉/">#视觉</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/vision/">#vision</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/图像/">#图像</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>