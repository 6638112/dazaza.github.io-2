<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>将Kotlin二进制缩小99.2%</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">将Kotlin二进制缩小99.2%</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-26 14:39:12</div><div class="page_narrow text-break page_content"><p>我们会讲到收缩，但首先让我们激励一下有问题的双星。三年前，我写了一篇名为“隐藏的改变以拉动请求”的帖子，内容包括将重要的统计数据和差异作为评论推向公关。这避免了影响二进制大小、清单和依赖关系树的更改带来的意外。</p><p>显示依赖关系树使用Gradle的依赖关系任务和diff-U0来显示上次提交后的更改。该帖子中的示例将Kotlin版本从1.1-M03更改为1.1-M04，产生以下差异：</p><p>@@-125，2+125，3@@--|\-org.jetbrains.kotlin：kotlin-stdlib：1.0.4-&gt；1.1-m03-|\-org.jetbrains.kotlin：kotlin-run：1.1-m03+|\-org.jetbrains.kotlin：kotlin-stdlib：1.0.4-&gt；Kotlin：kotlin-运行时：1.1-M04+|\--org.jetbrains.kotlin：注释：13.0@-145，2+146@@-+-org.jetbrains.kotlin:kotlin-stdlib:1.1-M03-+---org.jetbrains.kotlin：kotlin-运行时：1.1-M03++-org.jetbrains.kotlin：kotlin-stdlib：1.1-M04。</p><p>除了看到反映的版本跳跃之外，我们还可以推断出关于更改的两个额外事实：</p><p>Kotlin运行时依赖项依赖于JetBrains的注释工件，如diff的第一部分所示。</p><p>删除了对kotlin-run的直接依赖，如diff的第二部分所示。这很好，因为第一节已经告诉我们，kotlin-run是kotlin-stdlib的依赖项。</p><p>这两个事实显示在显示的diff中，但是还有一个微妙的第三个事实，它只是隐含的。因为第一部分是缩进的，所以我们知道我们的一个直接依赖项对kotlin-stdlib具有传递依赖项。不幸的是，我们不知道哪个依赖项受到影响。</p><p>为了解决这个问题，我编写了一个名为Dependency-tree-diff的工具，它为树中的任何更改显示根依赖项的路径。</p><p>+-com.jakewharton.rxbinding:rxbinding-kotlin:1.0.0-|\-org.jetbrains.kotlin：kotlin-stdlib：1.0.4-&gt；1.1-M03-|\--org.jetbrains.kotlin：kotlin-runtime：1.1-M03+|\-org.jetbrains.kotlin：kotlin-stdlib：1.0.4-&gt；1.1-M04+|\-org.jetbrains.kotlin：kotlin-运行时：1.1-m04+|\-org.jetbrains.kotlin：注释：13.0-+-org.jetbrains.kotlin：kotlin-stdlib：1.1-M03(*)-\-org.jetbrains.kotlin：kotlin-run：1.1-m03+\--org.jet.jet。</p><p>我们隐含的第三个事实，即哪个其他直接依赖项受到影响，现在在输出中是显式的。变更创建者现在可以反映与受影响的依赖项是否存在任何兼容性问题。</p><p>此工具需要签入到我们的回购中并在CI上运行。在使用Kotlin脚本成功构建ADB事件镜像之后，该工具的第一个版本也使用了Kotlin脚本。虽然Kotlinc工作正常并且很小，但它没有安装在CI机器上。我们依赖Kotlin Gradle插件来编译Kotlin，而不是独立的二进制文件。</p><p>您可以在本地重定向Kotlin脚本缓存目录以捕获编译后的JAR，但它仍然依赖于Kotlin脚本工件，它很大，有很多依赖项，并且仍然非常动态。很明显，这不是正确的路径，但是我提交了KT-41304，希望将来能够更容易地生成一个.jar的脚本。</p><p>我切换到一个经典的Kotlin Gradle项目，并生成了一个包含kotlin-stdlib依赖项的胖.jar。在前置脚本以使JAR自动执行之后，二进制文件计入1699978字节(或~1.62MiB)。不错，但我们可以做得更好！</p><p>使用unzip-l列出.jar中的文件显示，除了.class之外，大多数是.kotlin_module或.kotlin_METADATA。它们由Kotlin编译器和Kotlin的反射使用，我们的二进制文件不需要它们。</p><p>我们可以将这些与用于Java9模块系统的module-info.class和META-INF/maven/中的文件一起从二进制文件中过滤出来，META-INF/maven/中的文件传播有关使用Maven工具构建的项目的信息。</p><p>删除所有这些文件后，新的二进制大小为1513414字节(约1.44MiB)，大小减少了11%。</p><p>R8是Android构建的代码优化器和混淆器。虽然它通常用于在转换为Dalvik可执行格式期间对Java类文件进行优化和模糊处理，但它也支持输出Java类文件。为了使用它，我们需要使用ProGuard的配置语法指定该工具的入口点。</p><p>除了入口点之外，还禁用了模糊处理，并且我们保留了源文件和行号属性，以便仍然可以理解发生的任何异常。</p><p>通过r8传递胖的.jar会生成一个新的缩小的.jar，然后可以使其成为可执行文件。生成的二进制文件现在只有41680字节(~41KiB)，大小减少了98%。好的!。</p><p>由于我们生成的是二进制文件而不是库，因此-allowaccess修改选项将允许公开隐藏成员，从而使类合并和内联等优化更加有效。将其相加将产生37630字节(~37KiB)的二进制。</p><p>在这里停车是绝对安全的，但我不擅长阻止…。</p><p>既然二进制文件足够小，我们就可以开始查看哪些代码对大小有影响。通常我会求助于javap来查看字节码，但是因为我们只关心看到API调用，所以我们可以解压二进制文件并在IntelliJ Idea中打开类文件，IntelliJ Idea将使用FernFlower反编译器来显示大致等价的Java。</p><p>Fun Main(vararg args：string){if(args.。Size==2){val old=args[0]。让(：：文件)。ReadText()Val new=args[1]。让(：：文件)。ReadText()。</p><p>公共静态最终空Main(字符串...。Var0){本征。CheckNotNullParameter(var0，&#34；args&#34；)；if(var0.。Length==2){String[]var10000=var0；String var3=var0[0]；var3=FilesKt__FileReadWriteKt。ReadText$default(new File(Var3)，(Charset)null，1)；String var1=var10000[1]；String var8=FilesKt__FileReadWriteKt。ReadText$default(new File(Var1)，(Charset)null，1)；</p><p>查看FilesKt__FileReadWriteKt会显示我们在过去某个时候编写的不幸的文件读取代码，它会拉入kotlin.ExceptionsKt、kotlin.jvm.intrinsics和kotlin.text.Charsets。</p><p>从java.io.File切换到java.nio.path.Path意味着我们可以使用内置方法读取内容。</p><p>FUN Main(vararg args：String){if(args.size==2){-val old=args[0].let(：：File).readText()-val new=args[1].let(：：file).readText()+val old=args[0].let(Paths：：get).let(Paths：：readString)+val new=args[0].let(Paths：：get).let(Paths：：readString)。</p><p>Private Fun findDependencyPath(text：string)：设置&lt；list&lt；string&gt；&gt；{VAL DependencyLines=text。LineSequence()。DropWhile{！它。以(&#34；+--&#34；)}开头。边吃边{它。IsNotEmpty()}。</p><p>Public static Final Set findDependencyPath(String Var0){string[]var10000=new string[]{&#34；\r\n&#34；，&#34；\n&#34；，&#34；\r&#34；}；list var1；DlimitedRangesSequence var2；</p><p>这表明我们正在使用拆分的Kotlin实现并使用其序列类型。Java11添加了一个String.linees()，它返回一个Stream，该流还包含已经在使用的dropWhile和takeWhile操作符。不幸的是，Kotlin还有一个String.linees()扩展，所以我们需要一个强制转换才能使用Java11方法。</p><p>Private Fun findDependencyPath(Text：String)：set&lt；list&lt；string&gt；&gt；{-Val DependencyLines=text.lineSequence()+Val DependencyLines=(Text as java.lang.String).ines().dropWhile{！it.startsWith(&#34；+--&#34；)}.TakeWhile{it.isNotEmpty()。</p><p>Kotlin是一种多平台语言，这意味着它有自己的空列表、集合和映射实现。然而，当以JVM为目标时，没有理由使用它们而不是java.util.Colltions提供的那些。我提交了KT-41333来追踪这项改进。</p><p>转储最终二进制文件的内容会显示其空集合(和相关类型)约占剩余大小的50%：</p><p>$UNZIP-l build/libs/dependency-tree-diff-r8.jarArchive：Build/libs/Dependency-Tree-Diff-r8.jar长度日期时间名称-84 12-31-1969 19：00 META-INF/MANIFEST.MF926 12-31-1969 19：00 com/jakewharton/gradle/dependencies/DependencyTrees$findDependencyPaths$dependencyLines$1.class 854 12-31-1969 19：00 com/jakewharton/gradle/dependencies/DependencyTrees$findDependencyPaths$dependencyLines$2。.class 6224 12-31-1969 19：00 com/jakewharton/gradle/dependencies/DependencyTreeDiff.class 604 12-31-1969 19：00 com/jakewharton/gradle/dependencies/Node.class 2534 12-31-1969 19：00 kotlin/collections/CollectionsKt__CollectionsKt.class 1120 12-31-1969 19：00 kotlin/Collection/EmptyIterator.class 3227 12-31-1969 19：00kotlin/Collection/EmptyList.class 2023 12-31-1969 19：00kotlin/Collection/EmptySet.class 1958 12-31-1969 19：00 kotlin/。Jvm/INTERNAL/CollectionToArray.class 1638 12-31-1969年19：00kotlin/jvm/Internal/Intrinsics.class-21192 11个文件。</p><p>除了这些额外的类型之外，字节码还包含一组额外的空检查。例如，上一节中findDependencyPath的反编译字节码实际上如下所示：</p><p>公共静态最终集findDependencyPath(String Var0){Intrinsics.。CheckNotNullParameter(var0，&#34；$this$LINES&#34；)；本征。CheckNotNullParameter(var0，&#34；$this$lineSequence&#34；)；string[]var10000=new string[]{&#34；\r\n&#34；，&#34；\n&#34；，&#34；\r&#34；}；内部。CheckNotNullParameter(var0，&#34；$this$plitToSequence&#34；)；本征。CheckNotNullParameter(var10000，&#34；delimiters&#34；)；本征。CheckNotNullParameter(var10000，&#34；$this$asList&#34；)；</p><p>这些Intrinics调用在函数参数上强制类型系统的空性不变量，但是在内联之后，除了第一个调用之外，所有其他调用都是多余的。类似这样的重复调用出现在整个代码中。这是一个R8错误，原因是Kotlin重命名了这些内部方法，而R8没有更新以正确跟踪该更改。</p><p>修复了这两个问题后，二进制文件很可能会变成个位数的KIBS，从而比原来的FAT.jar减少99%。</p><p>如果您正在构建JVM二进制文件或JVM库来着色依赖关系，请确保使用像r8或ProGuard这样的工具来删除未使用的代码路径，或者使用Graal本机映像来生成最小的本机二进制文件。此工具保留为Java字节码，以便单个.jar可以在多个平台上使用。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://jakewharton.com/shrinking-a-kotlin-binary/">https://jakewharton.com/shrinking-a-kotlin-binary/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/二进制/">#二进制</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/kotlin/">#kotlin</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>