<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>超越jsonb：postgres的通用非结构化数据类型</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">超越jsonb：postgres的通用非结构化数据类型</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-18 07:26:01</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/8/0816ae0e386207c744f2646c43b2b879.jpg"><img src="http://img.diglog.com/img/2020/8/0816ae0e386207c744f2646c43b2b879.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>不可否认，jsonb是国王。它是一种非常灵活的数据类型，允许非结构化/无模式存储。它有非常强大的索引机制，其内部表示相当紧凑和高效。它附带了高级运算符和表达式来查询/提取其中的一部分，最近还添加了SQL/JSON路径功能来扩展以符合SQL标准。</p><p>有无数的帖子和资源解释了这种数据类型的优点以及使用它可以实现的功能。没有什么要补充的，除了重申我对所有那些为它的创造和贡献而工作的人的感激之情。</p><p>但有个问题。JSONB支持…。就是JSON！太棒了，但是够了吗？</p><p>JSON是一种容器数据类型，这意味着它可以存储中包含的其他数据类型。它支持哪些数据类型？从JSON规范来看，它支持以下内容：</p><p>数组，或者更好地称为“包”或“容器”，可能是混合类型的元素序列。</p><p>对象，它是键-值对的集合，其中的值可以是任何其他JSON数据类型。</p><p>Jsonb在内部将这些JSON数据类型映射到Postgres类型。很容易看到已解析(JSON)数据类型：</p><p>从jsonb_each(&#39；{&#34；a&#34；：42，&#34；b&#34；：true，&#34；c&#34；：&#34；hi&#34；，&#34；d&#34；：NULL，&#34；e&#34；：[42，&#34；hi&#34；]，&#34；f&#34；：{&#。：1}}&#39；)；┌─┬─┬─┐│Key│Value│jsonb_Typeof│├─┼─┼─┤│a│42│Number││b│True│boolean││c│&#34；hi&#34；│String││d│NULL│NULL││e│[42，&#34；hi&#34；]│数组││f│{&#34；a&#34；：1}│Object│└─┴─┴─┘</p><p>标量类型映射为布尔、文本和数字。从本质上讲，有三种不同的数据类型。现在检查Postgres中可用的所有数据类型。有几十个。很明显，你可以用你自己的来扩展。本质上，您需要将任何现有数据类型合并为数字或文本，这不是有点限制吗？如果您想表示时间戳，该怎么办？将其转换为文本(Postgres会为您做这件事，但您明白这一点)。要不要一只篮子，或者一个点子？我的自定义令人惊叹的数据类型怎么办？</p><p>根据JSON规范，这是正确的，没有其他事情可做。所以问题不在于jsonb是否有任何实现缺陷，而在于postgres用户是否对“只使用JSON”就足够了。</p><p>我发现必须在JSON中存储二进制数据(ByteA)特别令人沮丧。由于JSON中没有byteA数据类型(因此，jsonb也没有)，您需要将其转换为文本表示形式。有几种解决方案，但没有一种足够好：</p><p>将其逐个字节转换为字符串。这可能是一个非常糟糕的选择，因为它面临两个主要问题：一个是postgres字符串不符合严格的UTF-8(这是另一篇博客文章…的主题)。，无法存储UTF-8空(\0)字符。因此，如果这些字节中有一个字节的值(很可能)为0，则无法存储该字节。其次，解释为字符串的字节序列与原始字节序列的顺序不同。</p><p>以Base64编码。除了额外的空格之外，不会保留排序(即，原始字节序列上的索引将产生与base64编码文本上的索引不同的顺序)。如果需要保留顺序，则解决方案是对解码值使用表达式索引。这无论如何都会增加开销。</p><p>用base32hex编码，这是一种更冗长的编码，但它保持了顺序。Postgres中没有用于此编码的函数。</p><p>那么，您将如何使用当前的JSON和jsonb存储其他特定的、更紧凑的或从其他数据类型的现有函数中获益呢？避免数据类型信息擦除的唯一选择是将数据类型编码为JSON字符串的一部分。类似于：</p><p>很容易看出这种方法的几个缺点：更多的冗长和存储需求；需要连续转换；需要根据数据类型进行条件转换。</p><p>我并不是唯一一个追求更通用、支持更多类似JSON数据类型的语言的人，比如：</p><p>DynamoDB的项HTTPAPI。这是一个非常有趣的情况，因为它是一个符合JSON的输入/输出接口，类型定义遵循与上面概述的方法类似的方法(其中值是一个同时包括类型和值本身的对象)，但声称以优化形式(而不是按原样)存储在内部。它有有趣的复合类型，如“同源数组”，其中元素必须是同一时间或集合，这禁止重复值。</p><p>那么，这种通用的非结构化数据类型在Postgres中是如何工作的呢？我想说它可以利用所有现有的jsonb基础设施。毕竟，jsonb已经知道每个元素的数据类型，因此只需要扩展Tomany，潜在的任意数据类型(也支持自定义数据类型)。因此，新的数据类型应该很容易添加。其他特征(如确保支持集合的数组元素之间的均匀性；或确保元素内的唯一性)可能需要一些区别。作为一个超集，我希望相同的代码库可以很好地适应这两种数据类型(过去也曾从hstore进行过类似的改造，以使用jsonb的代码库)。</p><p>其中一个主要要求是，这个通用的非结构化数据类型将是实际JSON的超集，因此任何JSON字符串(以及随后的json和jsonb值)都可以隐式转换为它。我设想最困难的部分，或者至少是那些可能引发更多讨论的部分，将是：</p><p>是否输入语法？一些想法：根据数据类型使用不同的值括起来。例如密钥：{{dmFsdWU=}}(Amazon Ion)。</p><p>将值转换为具有type(文档的键)和value的嵌套JSON对象，类似于DynamoDB的HTTP API：&#34；key&#34；：{&#34；N&#34；：&#34；42&#34；}。</p><p>那你怎么想？Postgres是否应该获得JSON超集数据类型，这是一种通用的非结构化数据类型？留下您的评论和/或将您的回复发到@ongresinc开始对话。</p><p>个人注释：我发现很难理解为什么Oleg Bartunov，在Postgres的JSON中最重要的贡献者之一，最近被从“主要贡献者”降级为“贡献者”，不仅我认为主要贡献是不能收回的，而且在这个特殊的情况下，感觉更难理解。让这成为我的公开呼吁，要求扭转这种情况，并为Postgres二十年的贡献提供适当的公众认可。↩︎</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.ongres.com/blog/a_generalized_unstructured_data_type_for_postgres/">https://www.ongres.com/blog/a_generalized_unstructured_data_type_for_postgres/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/jsonb/">#jsonb</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/数据类型/">#数据类型</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>