<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>用灵丹妙药编写SSDP目录</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">用灵丹妙药编写SSDP目录</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-25 13:59:21</div><div class="page_narrow text-break page_content"><p>我过去把我所有的空闲时间都花在随意设计玩具项目上。随着时间的推移，可能是在工业界呆了几年之后，我开始花太多时间思考如何编写可维护的代码，以至于我认为我开始失去了编程的乐趣：探索新想法和学习如何做我以前从未做过的事情。我想重新发现那种快乐，要做到这一点，我需要停止太多的完美主义。</p><p>我认为，在办公室环境中，截止日期会迫使我向前看，要求完成工作，但在我的个人生活中，缺乏这种压力意味着我可以花很长时间来设计和重新设计同一段代码，直到它变得完美为止(它从来都不是完美的)。</p><p>为了解决这个问题，我想试试写博客！如果我能让自己兴奋地与其他人分享我的代码，尽管它是不完美和未完成的，那么也许我就可以开始忘记过去几年来一直困扰我的瘫痪。</p><p>首先，我只想简单介绍一下我几个月前编写的一个小程序。我想了解SSDP是如何工作的，所以我实现了一个SSDP目录！对于那些没有意识到的人来说，SSDP是90年代开始的一个相当简单的协议，用于促进网络服务的发现。如今，从智能电视到色调灯，它也被各种设备使用。</p><p>SSDP的关键是所谓的组播寻址。实质上，服务将它们的存在广播到专门指定的多播地址，然后网络上的任何其他人都能够监听这些存在通知，以便跟踪新服务的出现和消失。</p><p>Defmodule SSDPDirectory.MulticastChannel使用GenServer别名__模块__别名SSDPDirectory。{Discovery，Presence}@MulticeGroup{239,255,255,250}@Multical_port 1900 def start_link(opts\\[])do GenServer.start_link(__MODULE__，：OK，OPTS)end@spec Broadcast(GenServer.name()，iodata)：OK def Broadcast(channel\\Multicic。%{socket：port}}def init(：OK)DO UDP_OPTIONS=[：BINARY，ACTIVE：TRUE，Add_Membership：{@MULTICK_GROUP，{0，0，0}}，MULTICK_IF：{0，0，0，0}，MULTICK_LOOP：FALSE，reuseaddr：TRUE]{：OK，Socket}=：GEN_udp.open(@MULTICK_PORT，UDP_OPTIONS){：OK，%{Socket：Socket}}end def Handle_CAST(。STATE)DO：OK=：GEN_UDP.SEND(state.socket，@组播_组，@组播_端口，数据包){：NOREPLY，STATE}End Task.Supervisor.start_child(SSDPDirectory.DecodingSupervisor，HANDLE_INFO({：udp，_Socket，_IP，_PORT，DATA}，STATE)do def fn-&gt；With{：OK，PACKET，REST}&lt；-：erlang.decode_Packet(：HTTP_bin，Data，[])，{：OK，HANDLER}&lt；-PACKET_HANDLER(PACKET)，{：OK，DECODED}&lt；-handler.decode(REST)do：OK=handler.handle(已解码)end){：无回复，STATE}end defp PACKET_HANDLER({：HTTP_REQUEST，&#34；NOTIFY&#34；，_target，_version})，DO：{：OK，Presence}defp Packet_Handler({：HTTP_Response，_Version，200，&#34；OK&34；})，DO：{：OK，Discovery.Response}Defp Packet_Handler(_Packet)，DO：：ErrorEnd。</p><p>大多数神奇之处都发生在init/1函数中。通过打开UDP套接字并将其加入到协议的多播组中，我们的进程现在能够接收广播到该组的数据包。该接收逻辑位于同一文件内的HANDLE_INFO/2函数中。</p><p>当接收到数据包时，我们会派生另一个负责处理该数据包的进程。此进程在Task.Supervisor下运行，以便将该进程的崩溃与MulticastChannel隔离。同样有趣的是，我们可以使用erlang.decode_Packet/3来解码传入的数据包。这是一个内置函数，允许我们逐个片段地解码各种数据包格式。在本例中，我们使用它将数据包解析为HTTP数据包。这也是Elixir的Mint解码HTTP响应的相同方式！</p><p>根据解码的数据包类型，PACKET_HANDLER/1然后将该数据包的处理委托给另一个模块。要么我们已经收到HTTP NOTIFY请求，并且我们正在处理在线状态通知，要么我们已经收到了对发现请求的响应。</p><p>让我们来看一下Presence案例。如果您很好奇，这里有一个在线状态通知示例：</p><p>Defmodule SSDPDirectory.Presence确实需要记录器别名__module__alias SSDPDirectory.HTTP@type命令：：Presence.Alive.t()|Presence.ByeBye.t()@spec decode(Binary)：Error|{：OK，command}def decode(Data)do case HTTP。decode_headers(data，[])do{：OK，Headers，_rest}-&gt；Process_Headers(Headers。无法解码通知请求：&#34；&lt；&gt；check(Data)end)：Error End End@spec Handle(Command)：OK def Handle(%Presence.Alive{}=command)do Presence.Alive.Handle(Command)end def Handle(%Presence.ByeBye{}=command)do Presence.ByeBye.Handle(命令)end defp process_Headers(Header)do_process_headers(Headers，%Presence.ByeBye.Handle(Command)end defp process_Headers(Headers)do_Process_Headers(Headers，%Presence.ByeBye{}=command)。SSDP：Alive&#34；，USN：usn，type：type}When not is_nil(Usn)and not is_nil(Type)-&gt；{：OK，%Presence.Alive{usn：usn，type：type，location：Map.get(args，：location)}}%{command：&#34；ssdp：再见&#34；，usn：usn，type：type}When not is_nil(USN)and not is。{：OK，%Presence.Bye{usn：usn，type：type}}_-&gt；：错误end defp do_process_headers([{&#34；nts&#34；，command}|rest]，args)do args=Map.put(args，：command，command)do_process_headers(rest，args)end defp do_process_headers([{&#34；nt&#34；，type}|rest]，args)do args=Map.put(args，：type，type)do_process_headers(rest，args)end defp do_process_headers([{&#34；usn&#34；，usn}|rest]，args)do args=Map.put(args，：usn，usn)do_process_headers(rest，args)end defp do_process_headers([{&#34；al&#。，location}|rest]，args)do args=Map.put(args，：location，location)do_process_headers(rest，args)end defp do_process_headers([{&#34；location&#34；，location}|rest]，args)do args=Map.put(args，：location，location)do_process_headers(rest，args)end defp do_process_headers([_|rest]，args)do_process。</p><p>看起来这里有很多事情要做，但实际上很简单。从decode/1开始，我们继续解码来自MulticastChannel的数据包。这一次我们感兴趣的是头文件，因此我们对其进行解码，然后对其进行处理，以确定我们正在处理的是哪种命令。</p><p>处理步骤只涉及递归头列表，并在映射中累加相关的头。一旦我们这样做了，我们只需构造相应的命令！</p><p>最后，命令处理程序根据正在处理的命令类型将任务委托给第三个模块。例如，在使用SSDP：AIVE命令的情况下：</p><p>Defmodule SSDPDirectory.Presence.Alive确实需要记录器别名__module__alias SSDPDirectory。{Cache，Service}@Enforce_Key[：usn，：type]defstruct[：location]++@@Enforce_Key@type t：：%Alive{}@规范句柄(Alive.t())：OK def Handle(%Alive{}=command)do_=Logger.debug(fn-&gt；&#34；处理SSDP。检查(命令)结束)服务=%Service{usn：Command.usn，类型：命令。类型：命令类型，位置：命令。位置}：确定=缓存。插入(服务)结束。</p><p>在这里，我们只使用命令中的参数构造服务，然后将其存储在缓存中：</p><p>Defmodule SSDPDirectory.Cache确实使用GenServer需要记录器别名__module__alias SSDPDirectory.Service def start_link(opts\\[])do GenServer.start_link(Cache，：OK，opts)end def content(cache\\Cache)do：ets.tab2list(Cache)|&gt；Enum.into(%{})end def insert(cache\\cache，%Service{}=service)do GenServer.call(cache，{：insert，service})end def delete(cache\\cache，%Service{}=service)do GenServer.call(cache，{：delete，service})end def flush(cache\\Cache)do GenServer.call(cache，：flush)end def init(：OK)do table=：ets.new(Cache，[：%{table：table}}end def HANDLE_CALL({：INSERT，%Service{usn：usn}=service}，_from，data)When not is_nil(Usn)do：ets.insert(data.table，{usn，service})_=Logger.debug(fn-&gt；&#34；缓存服务：&#34；&lt；&gt；检查(USN)结束){：REPLY，：OK，DATA}END DEF HANDLE_CALL({：DELETE，%Service{USN：USN}}，_FROM，Data)When Not is_nil(USN)do：ets.delete(data.table，usn)_=Logger.debug(FN-&&gt;；&34；END_ELECTED SERVICE：&#34；&lt；&GG。检查(USN)结束){：REPLY，：OK，DATA}END定义HANDLE_CALL(：FLUSH，_FROM，DATA)DO：ETs.DELETE_ALL_OBJECTS(data.table)_=Logger.debug(FN-&gt；&#34；已刷新缓存&#34；END){：REPLY，：OK，DATA}ENDND。</p><p>对于缓存，我使用启用了READ_CONTURRENT的ETS表。调用Cache.content/1将返回表中存储的所有服务，这或多或少会将我们带回起点！协议中还有一些其他模块用于处理不同的命令，并用于发起发现请求，但在大多数情况下，它并不是一个非常复杂的应用程序！</p><p>就像我在编写Elixir代码时经常遇到的那样，我真的很惊讶这种语言可以如此轻松地完成一些事情，比如加入多播组，然后异步解码发送到套接字的任何数据包。我想我花了大约3个小时来编写整个应用程序，这更多地归功于Erlang VM给了我真正强大的工具，而不是我做其他任何事情。即使考虑到我令人难以置信的冗长的编码风格-我把类型和结构抛来抛去就像是Haskell一样-您也可能在100行左右的简短代码中做同样的事情。</p><p>在某种程度上，我更多的是为自己而不是任何东西写东西，我不知道其他人是否对这种博客帖子感兴趣，所以如果你已经读到这里，谢谢你继续关注我：)</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://quinnwilton.com/blog/writing-an-ssdp-directory-in-elixir">https://quinnwilton.com/blog/writing-an-ssdp-directory-in-elixir</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/编写/">#编写</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ssdp/">#ssdp</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/data/">#data</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1018958.html"><img src="http://img.diglog.com/img/2020/8/thumb_4fd3106bdb0ca3816040f09aa324d8b5.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018958.html">CParser：用纯Lua编写的具有有用扩展的C预处理器</a></div><span class="my_story_list_date">2020-8-19 2:46</span></div><div class="col-sm"><div><a target="_blank" href="/story/1011527.html"><img src="http://img.diglog.com/img/2020/7/thumb_0a8c55e92bb18d8805b7d952e192d38b.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1011527.html">PGx：用Rust而不是oc C编写Postgres扩展</a></div><span class="my_story_list_date">2020-7-13 23:27</span></div><div class="col-sm"><div><a target="_blank" href="/story/1011280.html"><img src="http://img.diglog.com/img/2020/7/thumb_b4080db8e422b05d9fb3bd10cd9d3910.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1011280.html">如何直观地编写光线跟踪器</a></div><span class="my_story_list_date">2020-7-12 7:59</span></div><div class="col-sm"><div><a target="_blank" href="/story/1010892.html"><img src="http://img.diglog.com/img/2020/7/thumb_fe2a49a4ec3e6148a3154ed24981b296.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1010892.html">Monitor Control：控制Mac上的外置显示器亮度和音量</a></div><span class="my_story_list_date">2020-7-10 6:3</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>