<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>借助BuildKit的新缓存来加快Docker中的点下载 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">借助BuildKit的新缓存来加快Docker中的点下载 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-29 03:51:53</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/1/fdacf9b0a91324f1fea72d4acdc84ee7.png"><img src="http://img2.diglog.com/img/2021/1/fdacf9b0a91324f1fea72d4acdc84ee7.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Docker使用层缓存来加快构建速度，但是层缓存并不总是足够的。当您快速开发Python应用程序并因此频繁更改依赖项列表时，最终将下载相同的软件包。</p><p>  当您依赖小包装时，这没什么好玩的。下载占用数百兆字节的机器学习库时，这又没有什么好玩的。</p><p> 随着稳定的Docker BuildKit的发布，Docker现在支持一种可以缓存这些下载内容的新缓存机制。</p><p>      第一次运行此程序时，Docker当然必须从头开始运行pip install，并且pip将下载Flask及其依赖项。</p><p> $将构建上下文发送到Docker守护程序3.584kB步骤1/3：FROM python：3.9-slim-buster ---＆gt; b55839ea7a0e步骤2/3：COPY requirements.txt。 ---＆gt; 59cc359cfb53步骤3/3：运行pip install -r requirements.txt ---＆gt;在b0d01b9495b6中运行收集烧瓶下载Flask-1.1.2-py2.py3-none-any.whl（94 kB）收集click＆gt; = 5.1下载click-7.1.2-py2.py3-none-any.whl（82 kB）收集其危险信息> = 0.24正在下载itsdangerous-1.1.0-py2.py3-none-any.whl（16 kB）...已成功标记示例：最新</p><p> 第二次运行此操作时，Docker的层缓存开始了：requirements.txt不变，Dockerfile也没有，因此无需重新运行pip安装。</p><p> $ docker build -t示例--progress = plain。将构建上下文发送到Docker守护程序3.584kB步骤1/3：FROM python：3.9-slim-buster ---＆gt; b55839ea7a0e步骤2/3：COPY requirements.txt。 ---＆gt;使用缓存---> 59cc359cfb53步骤3/3：运行pip install -r requirements.txt ---＆gt;使用缓存---> 974a97388f3f成功构建974a97388f3f成功地标记了示例：最新 </p><p>现在，当我们重建时，pip install再次运行…并且它将重新下载Flask及其所有依赖项！</p><p> $ docker build -t示例--progress = plain。将构建上下文发送到Docker守护程序3.584kB步骤1/3：FROM python：3.9-slim-buster ---＆gt; b55839ea7a0e步骤2/3：COPY requirements.txt。 ---＆gt; 503a903dd4c9步骤3/3：运行pip install -r requirements.txt ---＆gt;在9d4aea743390中运行收集烧瓶下载Flask-1.1.2-py2.py3-none-any.whl（94 kB）收集click＆gt; = 5.1下载click-7.1.2-py2.py3-none-any.whl（82 kB）收集其危险信息> = 0.24下载其危险的1.1.0-py2.py3-none-any.whl（16 kB）收集Jinja2＆gt; = 2.10.1下载Jinja2-2.11.2-py2.py3-none-any.whl（125 kB）收集MarkupSafe。 = 0.23下载MarkupSafe-1.1.1.tar.gz（19 kB）收集Werkzeug。 = 0.15下载Werkzeug-1.0.1-py2.py3-none-any.whl（298 kB）正在收集matplotlib下载matplotlib-3.3.4-cp39-cp39-manylinux1_x86_64.whl（11.5 MB）...</p><p> 如果您要更改requirements.txt，则会浪费大量时间等待相同的软件包一遍又一遍地下载。</p><p>  当您在计算机上正常运行pip install（或Pipenv或Poetry）时，它会将下载内容缓存在您的主目录中，这样以后的安装就不需要重新下载相同的软件包了。是它自己的独立小文件系统，充其量是从先前缓存的层开始的。</p><p> 并且由于缓存单位是RUN命令，因此您可以下载所有软件包，也可以不下载任何软件包。</p><p> 为了解决这类问题，BuildKit增加了一种新的缓存：您可以跨构建缓存目录，应该假定它在任何时候都被删除了，从某种意义上说，它与在线CI提供的目录缓存非常相似。系统。</p><p> 要使用它，我们只需要向RUN添加一个附加选项即可。我将要缓存/root/.cache目录，因为Pipenv和Poetry还将在该目录中存储文件； pip默认使用〜/ .cache / pip。 </p><p>＃语法= docker / dockerfile：1.2来自python：3.9-slim-buster COPY requirements.txt。 RUN --mount =类型= cache，target = / root / .cache \ pip install -r requirements.txt＃...等等...</p><p> 注意：在正在讨论的非常具体的主题之外，本文中的Dockerfile并不是最佳实践的示例，因为增加的复杂性将使本文的重点难以理解。</p><p>  为确保您编写安全，正确，快速的Dockerfile，请考虑我的快速入门指南，其中包括打包过程和60多种最佳实践。</p><p> 我还将设置DOCKER_BUILDKIT环境变量，以确保使用了BuildKit。</p><p>    现在，当我构建Docker映像时，它将第一次必须从头开始下载所有内容：</p><p> $ docker build -t示例--progress = plain。 ...＃9 [stage-0 3/3] RUN --mount =类型= cache，target = / root / .cache pip install -r requirements.txt＃9 sha256：cff2b41a0170dccc42eda05f6a5495d3b00436849f28c262356eaea4a29a804f＃9 2.816收集瓶＃9 2.896下载Flask-1.1.2-py2.py3-none-any.whl（94 kB）＃9 3.202收集点击= 5.1＃9 3.215下载click-7.1.2-py2.py3-none-any.whl（82 kB）＃9 3.226收集其危险= 0.24＃9 3.240下载itsdangerous-1.1.0-py2.py3-none-any.whl（16 kB）＃9 3.246收集Jinja2＆gt; = 2.10.1＃9 3.269下载Jinja2-2.11.2-py2.py3-none-any.whl（125 kB）＃9 3.405收集MarkupSafe。 = 0.23＃9 3.423下载MarkupSafe-1.1.1.tar.gz（19 kB）...</p><p> 注意输出格式不同；那是因为我们正在使用BuildKit。 </p><p>通过普通的Docker缓存，我希望Flask和matplotlib能够再次下载。但是这次：</p><p> $ docker build -t示例--progress = plain。 ...＃9 [stage-0 3/3] RUN --mount =类型= cache，target = / root / .cache pip install -r requirements.txt＃9 sha256：42cbbeab455a114b05cbbcaa09a38fa56bc4ce6da820e3957055b164d24ef36f＃9 2.421收集Django＃9 2.504下载Django-3.1.5-py3-none-any.whl（7.8 MB）＃9 3.579收集asgiref＆lt; 4＆gt; = 3.2.10＃9 3.597下载asgiref-3.3.1-py3-none-any.whl（19 kB）＃9 3.603收集sqlparse＆gt; = 0.2.2＃9 3.618下载sqlparse-0.4.1-py3-none-any.whl（42 kB）＃9 3.624收集烧瓶＃9 3.626使用已缓存的Flask-1.1.2-py2.py3-none-any.whl （94 kB）＃9 3.910收集点击= 5.1＃9 3.912使用缓存的click-7.1.2-py2.py3-none-any.whl（82 kB）...</p><p> 请注意，所有“使用已缓存的＆lt; package＆gt;”-我们不必下载Flask，它是在本地缓存中找到的！</p><p>   缓存的文件存储在Docker内部。因此，如果您在每次都以新环境开头的某种Cloud CI服务中进行构建，则缓存将无法生存。</p><p> 您可能可以说服CI系统缓存/var/lib/docker/buildkit/cache.db（例如在GitHub Actions上使用cache动作）。我没有尝试过，所以我不确定是否会可以，但是如果这样做，您还将在各个版本之间保存下载。</p><p> 但是，您至少可以使用此技术来加快开发过程中或具有持久文件系统的CI服务器上的构建速度。</p><p>    了解如何构建快速的，可立即投入生产的Docker映像-阅读Docker Python打包指南的其余部分。 </p><p>从可以节省时间的快速构建，到可以确保安全的最佳安全实践，如何快速获得打包Python应用程序以进行生产所需的专业知识？  通过使用Docker Production Quickstart上的Python，快速学习最佳实践。  订阅我的时事通讯，并与2400多名Python开发人员和数据科学家一起学习实用的工具和技术，从Docker打包到测试再到Python最佳实践，并每周在收件箱中提供免费的新文章。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://pythonspeed.com/articles/docker-cache-pip-downloads/">https://pythonspeed.com/articles/docker-cache-pip-downloads/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/缓存/">#缓存</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/docker/">#docker</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/buildkit/">#buildkit</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/pip/">#pip</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1046038.html"><img src="http://img2.diglog.com/img/2021/1/thumb_f9af1d44d5df9b88000b39a44df3383a.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1046038.html">DNSpooq攻击如何毒化DNS缓存记录 </a></div><span class="my_story_list_date">2021-1-24 3:42</span></div><div class="col-sm"><div><a target="_blank" href="/story/1046020.html"><img src="http://img2.diglog.com/img/2021/1/thumb_3d33075e736db3cc8886c279e2b6e559.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1046020.html">缓存管理经验教训 </a></div><span class="my_story_list_date">2021-1-24 3:34</span></div><div class="col-sm"><div><a target="_blank" href="/story/1044170.html"><img src="http://img2.diglog.com/img/2021/1/thumb_aa16ca34802d7e14a8c399f336ea66b0.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1044170.html">InfiniCache：在临时无服务器功能之上构建的内存中缓存 </a></div><span class="my_story_list_date">2021-1-15 20:29</span></div><div class="col-sm"><div><a target="_blank" href="/story/1041373.html"><img src="http://img2.diglog.com/img/2020/12/thumb_9f7e4b14274b4ce29d242c7b8e37c8ce.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1041373.html">Firefox继续严厉跟踪缓存分区 </a></div><span class="my_story_list_date">2020-12-23 5:40</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>