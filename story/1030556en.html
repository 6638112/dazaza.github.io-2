<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>用saltssh替换ansible</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">用saltssh替换ansible</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-22 22:34:12</div><div class="page_narrow text-break page_content"><p>There is this machine (or &#34;box&#34;) that I used to manage using Ansibleuntil recently.I wanted configuration management on thatbox so that if ever disk or VM or the entire hosting provider would go away,I would have a magic button to start a rebuild from nothing,grab a coffee, and have things work the same again.I wanted Ansible for that task becauseit&#39;s fairly easy and approachable,requires nothing but working SSH access from the host system,and is written in Python.Unlike Puppet, Chef, CFEngine and SaltStack — or so I thought.</p><p>直到最近，我还一直使用Ansible来管理这台机器(或机器)。我想要在该机器上进行配置管理，这样，如果某个磁盘、VM或整个主机提供商消失，我会有一个神奇的按钮，可以从无到有开始重建，抓起一杯咖啡，然后让一切恢复原样。我想要Ansible来完成这项任务，因为它相当容易和容易接近，只需要从主机系统访问SSH就可以了，而且是用Python编写的。不像Pupet、Chef、CFEngine和SaltStack-或者我是这么认为的--我想要Ansible来完成这项任务，只需要从主机系统访问SSH就可以了，而且是用Python编写的。不像Pupet、Chef、CFEngine和SaltStack-或者我是这么认为的。</p><p> Over time using Ansible I noticed that when I made changes to a playbookI was repeatedly facing the same challenge:Either I run the whole playbook and wait for many de-facto no-op tasks or I invest in annotation with tags, save some runtimebut need to deal with the shortcomings that tags have in Ansible.</p><p>随着使用Ansible的时间的推移，我注意到当我对剧本进行更改时，我反复面临着相同的挑战：要么我运行整个剧本并等待许多事实上的无操作任务，要么我投资于使用标签进行注释，节省了一些运行时间，但需要解决标签在Ansible中存在的缺点。</p><p>  Tags in Ansible have two problems that bug me.First, you&#39;ll need to manually propagate the same tag to all dependency tasks,especially those referenced in  when-conditionalsor else you&#39;ll run into undefined-variable issuesbecause the task due to  register that variable has not been executed.So that&#39;s something I would have to take good care of manually.</p><p>Ansible中的标记有两个困扰我的问题。首先，您需要手动将相同的标记传播到所有依赖项任务，特别是在When-Condition中引用的任务，否则您将遇到未定义变量的问题，因为应注册该变量的任务尚未执行。因此，这是我必须手动处理的问题。</p><p> Secondly,tags and  loopsdo not work well together in Ansible.What I  would like to do is use the iteration item as a tag like this:</p><p>其次，标签和循环在Ansible中不能很好地协同工作。我想做的是将迭代项用作标签，如下所示：</p><p> -  hosts :  all  tasks :  -  name :  Install distro packages  package :  name :  &#34;{{   item   }}&#34;  state :  present  with_list :  -  git  -  htop  tags :  # NOTE Does not work!  # Gets us: ERROR! &#39;item&#39; is undefined  -  &#34;{{   item   }}&#34;</p><p>-hosts：所有任务：-name：安装发行版软件包Package：name：&#34；{{item}}&#34；state：Present with_list：-git-htop标记：#NOTE NOT WORK！#GETS OUT OUT：ERROR！&#39；Item&#39；未定义-&#34；{{Item}}&#34；</p><p> Unfortunately, this gets me  ERROR! &#39;item&#39; is undefined becausetags do not support loops like that in Ansible.Leaving aside the introduction of a new variable,conceptually my only option is to duplicate the items list into  tags:</p><p>不幸的是，这会导致错误！&#39；项目&#39；未定义，因为标签不支持Ansible中那样的循环。撇开引入新变量不谈，从概念上讲，我唯一的选择是将项目列表复制到标签中：</p><p> -  hosts :  all  tasks :  -  name :  Install distro packages  package :  name :  &#34;{{   item   }}&#34;  state :  present  with_list :  -  git  -  htop  tags :  # Works, but not cool  -  git  -  htop</p><p>-hosts：所有任务：-name：安装发行版软件包：name：&#34；{{item}}&#34；state：Present with_list：-git-htop标记：#works，但不是Cool-git-htop。</p><p> I&#39;ll also need to be okay with  the whole loop being run if I ask for anyof those tags now, which means waiting without any added value.I&#39;m asking Ansible for ~20 packages to be installed sothere is quite a bit of waste in runtime here.</p><p>如果我现在请求这些标记中的任何一个，我也需要允许整个循环运行，这意味着在没有任何附加值的情况下等待。我正在请求Ansible安装大约20个软件包，所以这里在运行时会有相当大的浪费。</p><p> I didn&#39;t feel like I wanted to deal with these shortcomings of tagsmost of the time so I instead started multi-tasking during that time,ran the whole playbook, and got back to it when there were results.</p><p>我不想在大多数时间里解决标签的这些缺点，所以我在那段时间里开始了多任务处理，执行了整个剧本，当有结果的时候，我又回到了它的位置上。</p><p> It was hard to accept one other thing though:When I ran the playbook two times in a row, for the second runAnsible would take about 4 minutes to do nothing but confirmingthat all the work was already done. Why?Would I have to accept that it was that slow?</p><p>然而，我很难接受另一件事：当我连续两次运行剧本时，对于第二次运行，Ansible将需要大约4分钟的时间来确认所有的工作都已经完成。为什么？我必须接受它是那么慢吗？</p><p>  So I started looking for ways to improve Ansible speed, and SSH pipelining,disabling fact gathering,and  Mitogenhelped but wouldn&#39;t get runtime below 3 minutes, so I was not very happy.On a sidenote Mitogen doesn&#39;t support Ansible &gt;=2.10as of this writing so that boost in speedwould come at the cost of being stuck with Ansible 2.9 in the past for longer,which is not ideal either.</p><p>所以我开始寻找提高Ansible速度的方法，以及SSH流水线，禁用事实收集，Mitgen有所帮助，但不会使运行时间低于3分钟，所以我不是很高兴。顺便说一句，Mitogen在撰写本文时不支持Ansible&gt；=2.10，因此速度的提高将以在过去使用Ansible 2.9的时间更长为代价，这也不是很理想。(这也不是很理想)。</p><p> So I accepted 3 minutes as the minimum runtime of that playbook.And started wondering about looking elsewhere.</p><p>所以我接受了3分钟作为该攻略的最短运行时间，并开始考虑到其他地方寻找。</p><p>  Maybe Salt had some way without all those minions, masters, daemons, agentsthat seemed like a given to mewhen I last had a few bits to do with SaltStackat a previous job a few years ago.To me delight, I did find salt-ssh this time.salt-ssh was introduced with the release of Salt 0.17.0 on 2013-09-26, it&#39;s not actually new.</p><p>也许Salt有办法摆脱那些奴才、主人、守护程序和代理，这些似乎是我几年前在上一份工作中与SaltStack做过的事情。让我高兴的是，这一次我确实发现了salssh。saltssh是在2013-09-26发布的Salt 0.17.0中引入的，它实际上并不是新的。</p><p>  Can I port my existing Ansible playbook to salt-ssh,will it be fun and work well, andwill it be faster than 3 minutes for when it doesn&#39;t actually need to do anything?</p><p>我可以把我现有的Ansible攻略移植到Salt-ssh上吗？它会有趣并且工作得很好吗？当它实际上不需要做任何事情的时候，它会比3分钟更快吗？</p><p>    Create a specific Docker network for a  Caddy-based SSL reverse proxy to talk to website containers</p><p>为基于Caddy的SSL反向代理创建特定的Docker网络以与网站容器对话。</p><p> Configures and activates dnf-automatic so that it updates packages by itself, restarts outdated services and reboots the VM when  tracer detects need to</p><p>配置并激活DNF-Automatic，以便在Tracer检测到需要时自动更新软件包、重新启动过时的服务并重新启动虚拟机</p><p> Adjusts systemd-resolved config to no longer expose LLMNR port 5355 to the world without need to</p><p>调整systemd解析的配置以不再向世界公开LLMNR端口5355，而无需。</p><p>   Downgrade cgroup to v1 for Docker by adjusting the kernel command line and re-creating the GRUB config for the change to have actual effect</p><p>通过调整内核命令行并重新创建GRUB配置以使更改生效，将Docker的cgroup降级为v1。</p><p>   Clone some Git repositories containing docker-compose website projects and keep them up to date with upstream</p><p>克隆一些包含docker-compose网站项目的Git存储库，并使它们与上游保持最新。</p><p> Spin up multiple docker-compose based service and have them do rebuilds and restarts whenever their underlying Git clone changed</p><p>启动多个基于docker-compose的服务，并在其底层Git克隆更改时让它们进行重建和重新启动。</p><p>   I started making my way through the official Agentless Salt: Get Started Tutorialand got stuck quickly.I wanted execution as an unprivileged user butdespite obeying the tutorial in detailI got errors about not being able to write to  /var/cache/ — for good reasons — like these:</p><p>我开始阅读官方的无代理Salt：入门指南，但很快就卡住了。我想以非特权用户的身份执行，但是尽管详细遵守了教程，我还是收到了无法写入/var/cache/的错误-出于很好的原因-如下所示：</p><p> # salt-ssh  &#39;*&#39; test.ping [ERROR ] Unable to render roster file: Traceback (most recent call last): [..] PermissionError: [Errno 13] Permission denied: &#39;/var/cache/salt/master/roots/mtime_map&#39;</p><p>#salt-ssh&#39；*&#39；test.ping[错误]无法呈现花名册文件：traceback(最近一次调用)：[..]。权限错误：[错误13]权限被拒绝：&#39；/var/cache/salt/master/roots/mtime_map&#39；</p><p> And while the docs used absolute paths like  /home/vagrant/salt-ssh/ everywhere,I wanted relative paths that would work with a Git repository checked out anywhere.Not to mention that  log_file needs to be  ssh_log_filein the tutorial.</p><p>虽然文档使用的是绝对路径，如/home/volant/salt-ssh/Everywhere，但我希望在任何地方都能与Git存储库一起使用的相对路径，更不用说教程中的log_file需要是ssh_log_file。</p><p> So with all of that figured out after a while, this  minimal setup satisfied all of that:execution as an unprivileged user,relative paths with the help of  root_dir: .,significantly less noisy output through  state_output_diff: True,and a place to start adding playbook-like things to. For a bird&#39;s eye view:</p><p>过了一段时间之后，所有这些都解决了，这个最小的设置就满足了所有这些要求：以非特权用户身份执行、在root_dir：.帮助下的相对路径、通过state_output_diff：true显著降低噪音的输出，以及开始添加类似剧本的内容的位置。鸟瞰：</p><p> # tree . ├── master ├── pillar │   ├── data.sls │   └── top.sls ├── roster ├── salt │   └── setup.sls └── Saltfile</p><p>#树。├──Master├──Column│：├──data.sls│：└──top.sls├──花名册├──SALT│：└──setup.sls└──saltfile。</p><p>          With that as a base I can now port the playbook over in a new file  salt/setup.sls.</p><p>有了它作为基础，我现在可以将剧本移植到一个新文件salt/setup.sls中。</p><p> For example, let&#39;s adjust the Open SSH server configto know my public key (that I&#39;ll store at  salt/ssh/files/authorized-keys-root.txt),to disable password-based log-in (to protect against brute-force log-in attempts)and be sure that the server makes use of the adjusted configuration:</p><p>例如，让调整Open SSH服务器配置以了解我的公钥(我将存储在salt/ssh/files/Authorized-key-root.txt)，禁用基于密码的登录(以防止暴力登录尝试)，并确保服务器使用调整后的配置：</p><p> ssh-daemon :  # Set SSH public keys for root  ssh_auth.present :  -  user :  root  -  source :  salt://ssh/files/authorized-keys-root.txt  # Disable password-based log-ins to SSH  file.keyvalue :  -  name :  /etc/ssh/sshd_config  -  key :  PasswordAuthentication  -  value :  &#34;no&#34;  -  separator :  &#34;   &#34;  -  uncomment :  &#34;#&#34;  -  require :  -  ssh_auth :  ssh-daemon  # Restart sshd service to apply changes in configuration  service.running :  -  name :  sshd  -  reload :  True  -  watch :  -  file :  ssh-daemon</p><p>Ssh-daemon：#为根ssh_auth.Present设置SSH公钥：-user：root-source：salt：//ssh/files/Authorized-key-root.txt#禁用基于密码的SSH文件登录。keyvalue：-name：/etc/ssh/sshd_config-key：PasswordAuthentication-value：&#34；no&#34；-分隔符：&#34；&#34；-unComment：&#34；#&#34；-要求：-ssh_auth：ssh-daemon#重新启动sshd服务以应用配置服务中的更改。运行：-name：sshd-reload：true-watch：-file：ssh-daemon。</p><p>   # salt-ssh  &#39;*&#39; test.ping # salt-ssh  &#39;*&#39; grains.items # salt-ssh  &#39;*&#39; state.apply setup  test =True # salt-ssh  &#39;*&#39; state.apply setup</p><p>#sal.ssh&#39；*&#39；test.ping#salt-ssh&#39；*&#39；grains.item#salt-ssh&#39；*&#39；state.Apply setup test=True#salt-ssh&#39；*&#39；state.Apply setup。</p><p> It took me maybe one and a half day to port the whole playbook to salt-sshand be confident with the result. What did it get me?</p><p>我大概花了一天半的时间把整本剧本搬到盐湖，并对结果充满信心。它给我带来了什么？</p><p> Significant reduction of runtime: Down from 3-4 minutes with Ansible to about 1 minute with salt-ssh</p><p>显著缩短运行时间：从使用Ansible的3-4分钟降至使用salt-ssh的约1分钟。</p><p>   More flexibility (but also some duty) with regard to state dependencies and order of execution</p><p>在状态依赖关系和执行顺序方面有更大的灵活性(但也有一定的责任</p><p> Being able to use Jinja templating right in the playbook (&#34;state file&#34;) unlike with Ansible</p><p>能够在攻略(状态文件)中正确使用JJJA模板，这与Ansible不同。</p><p> I think it&#39;s fair to sayI consider myself an salt-ssh convert by now:new setups won&#39;t be Ansible with me anymore, but salt-ssh.</p><p>我认为这是公平的说，我现在认为我自己是一个盐-ssh的皈依者：新的设置不再是我所能接受的，而是salt-ssh。</p><p> What I do hope is that SaltStack gets better at fixing bugs.All the hiccups and limitations I ran into with version 3001.1were related to features that I consider mainstream enough thatI shouldn&#39;t even have seen them, given the size of the community.</p><p>我真正希望的是SaltStack在修复错误方面做得更好。我在3001.1版本中遇到的所有问题和限制都与我认为足够主流的功能有关，考虑到社区的规模，我甚至不应该看到这些功能。</p><p>   I hope those are not a sign of structural issues with SaltStack. VMWare bought SaltStack in September 2020so I&#39;m hoping that it turns out for the best.I&#39;m happy to help out with pull request once I&#39;m convinced that I won&#39;t be wasting my time.</p><p>我希望这些不是SaltStack结构性问题的迹象。VMware在2020年9月收购了SaltStack，所以我希望这会是最好的结果。一旦我确信我不会浪费时间，我很高兴能帮上忙。</p><p> For more about using salt-ssh to replace Ansible, maybeDuncan Mac-Vicar P.&#39;s article &#34; Using Salt like Ansible&#34;is of interest to you.</p><p>有关使用Salt-ssh取代Ansible的更多信息，您可能会对Duncan Mac-Vicar P.；的文章“像Ansible一样使用Salt”感兴趣。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.hartwork.org/posts/replacing-ansible-with-salt-ssh-for-speed-and-for-good/">https://blog.hartwork.org/posts/replacing-ansible-with-salt-ssh-for-speed-and-for-good/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/替换/">#替换</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ansible/">#ansible</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ssh/">#ssh</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>