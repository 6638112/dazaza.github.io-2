<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>对Nest Home / Away API进行反向工程 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">对Nest Home / Away API进行反向工程 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-18 15:55:00</div><div class="page_narrow text-break page_content"><p>不久前，我购买了Nest相机，因为我喜欢仅需提供电源和WiFi连接即可获得良好的安全系统的想法。  您可以使用Works with Nest（其开放式API）控制它的事实是做出此决定的主要因素。  然后，Google购买了Nest，并禁止未及时注册的用户（包括我）访问。  有希望将很快“创建”一个新的开放API。  最终，他们发布了智能设备管理API，尽管您可以做一些事情（获取摄像头数据流），但无法设置“家庭/离开”状态。  您可以在此处了解更多信息，但是TL; DR Nest摄像机的运动/声音警报只有在将其设置为“ Away”时才会触发。  由于我不想进入的原因，自动“回家/离开”功能对我不起作用，因此，我需要一种通过代码控制它的方法，以便可以将其自动化，这是一件好事。 </p><p>像所有专业人士一样，我的第一个尝试就是打开DevTools并打开Nest webapp，单击Home / Away切换，复制为curl，从CLI运行它，等等。</p><p>      curl命令末尾的主机端点很好地暗示了他们正在使用gRPC，到目前为止我还没有任何经验。</p><p>   它与我们之前看到的二进制有效负载相匹配，现在变得令人兴奋了！</p><p>  由于简单的有效负载重播没有任何作用，因此我需要弄清楚其中实际存在的内容。</p><p> 第一个（令人惊讶的）问题实际上是将二进制有效负载放入文本文件中，我猜想二进制文件在浏览器和我要粘贴的文件之间被弄乱了。</p><p> 这里的“使用内容另存为HAR”功能非常有用，特别是因为二进制文件下面有一个base64编码的字段。</p><p>  猫set-away-home.nest.com.har格伦grep＆＃39; json.log.entries [1] .response.content.text＆＃39; \ |切-d＆＃39;＆＃34;＆＃39; -f 2 \ | base64 -d \ | base64 -d </p><p>（如果您不了解gron，则一定要检查一下，它使JSON可以使用grep）</p><p>   查看protobuf的官方文档，似乎我需要.proto文件来做任何有用的事情。</p><p> 我无法弄清楚如何从Nest网站中提取内容，或者甚至无法找到。</p><p>  1 {1 {1：＆＃34; STRUCTURE_XXXXXXXXXXXXXXXX＆＃34; 2：＆＃34; XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX＆＃34; } 2 {1 {1：＆＃34; STRUCTURE_XXXXXXXXXXXXXXXX＆＃34; 2：＆＃34; structure_mode＆＃34; 3：＆＃34; XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX＆＃34; } 2：4 4 {1 {1：＆＃34; type.nestlabs.com/nest.trait.occupancy.StructureModeTrait.StructureModeChangeResponse&#34; 2 {1：1}}} 6 {1 {1：＆＃34; STRUCTURE_XXXXXXXXXXXXXXXXXXX＆＃34; 2：＆＃34; structure_mode＆＃34; 3：＆＃34; XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX＆＃34; } 2 {1：＆＃34; type.nestlabs.com/nest.trait.occupancy.StructureModeTrait.StructureModeChangeRequest&#34; 2 {1：2 2：1 3 {1：＆＃34; USER_XXXXXXXXXXXXXXXX＆＃34; }}} 3 {1：XXXXXXXXXX 2：XXXXXXXXX}}}} 15：＆＃34;＆＃34; 2：＆＃34;＆＃34; 15：＆＃34; \ 000 \ 000＆＃34;</p><p>  然后，我尝试通过上面的输出手动创建.proto文件。</p><p>  通过运气（也就是在GitHub上搜索这些类型），我发现比我聪明得多的人实际上已经设法从Nest网站提取了原始文件，谢谢陌生人！</p><p>   启动IDE，并按照protobuf教程中的内容来构建有效负载。 </p><p>我敢肯定，绝大部分的困难都来自于我以前从未使用过protobuf，但我也花了一点时间才意识到，他们将我们关心的命令（StructureModeChangeRequest）序列化为通用类型（ResourceCommandRequest），然后再进行序列化。</p><p> 最终，我能够将protobuf有效载荷发送到Nest API，哦，天哪，看到图标从“ Home”切换到“ Away”就像圣诞节初一样：）</p><p>  比较原始请求中的标头，我可以看到有一个X-Accept-Response-Streaming：true标头，添加它会导致连接按预期直接关闭。</p><p>  我将所有内容很好地打包到GitHub存储库中，然后继续进行最后一部分。</p><p>  这里的标准方法是在所有“家用”电话上安装一些位置跟踪器，并将其定期发送到服务器，然后由服务器决定何时切换Nest状态。</p><p> 尽管我实际上构建了一个android位置共享应用程序，但由于必须在电池寿命和响应能力之间进行权衡，因此我不喜欢这种方法。</p><p> 我还研究了Google位置信息共享，但是它涉及到创建另一个Google帐户，与其永久共享我的位置并将其用作来源。太脆弱了。 </p><p>如果响应被拒绝连接，则它们位于网络/“家庭”上。</p><p>  好吧，如果您很奇怪并且手机上装有服务器，也许也可以接受连接。</p><p> 我仍然对这种方法的效果感到惊讶，因为我在网上读了很多“不要这样做”，原因如下：</p><p>   2020-12-17 09:36:07 INFO找到了主机：[＆＃39; 192.168.0.30＆＃39 ;,＆＃39; 192.168.0.31＆＃39;] 2020-12-17 09:36:07 INFO 192.168.0.30是home2020-12-17 09:36:09 INFO将状态设置为：home（200）2020-12-17 09:41:09 INFO 192.168.0.30是home2020-12-17 09:46:13 INFO 192.168 .0.31是home2020-12-17 09:51:17 INFO 192.168.0.31是home [..] 2020-12-17 11:17:29 INFO将状态设置为：离开（200）2020-12-17 12:35 ：11 INFO 192.168.0.31是home2020-12-17 12:35:12 INFO将状态设置为：home（200）2020-12-17 12:40:16 INFO 192.168.0.31是home</p><p>    我不得不花一天时间去做一些应该起作用的事情，或者至少我应该自己拥有改变的机会，这真是太糟糕了。</p><p> 如果摄像机的质量不是很高，我会放弃它，然后使用DVR / NVR进行自我托管。</p><p> 构建所有功能本来需要更长的时间，但是我可以控制每个部分。 </p><p>Nest应用仍然困扰着我迁移到Google帐户，因此，让我们来看看该解决方案实际可以使用多长时间。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.emilburzo.com/2020/12/reverse-engineering-nest-home-away-status-api/">https://blog.emilburzo.com/2020/12/reverse-engineering-nest-home-away-status-api/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/home/">#home</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/nest/">#nest</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1040315.html"><img src="http://img2.diglog.com/img/2020/12/thumb_b1db83171fe4ad8473d129bf1fbe36eb.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1040315.html">不要在家尝试：乔治的奇妙药物有毒 </a></div><span class="my_story_list_date">2020-12-17 21:22</span></div><div class="col-sm"><div><a target="_blank" href="/story/1039916.html"><img src="http://img2.diglog.com/img/2020/12/thumb_19c3a24aeeeedc1b7c53b621fb7d27e4.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1039916.html">FDA授权不需要处方的第一个家庭冠状病毒测试 </a></div><span class="my_story_list_date">2020-12-16 3:49</span></div><div class="col-sm"><div><a target="_blank" href="/story/1038362.html"><img src="http://img2.diglog.com/img/2020/12/thumb_15a8d0bdf5ebffb992415f8fa8bd2952.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1038362.html">圣马特奥县卫生官员关于湾区居家命令的声明 </a></div><span class="my_story_list_date">2020-12-8 12:8</span></div><div class="col-sm"><div><a target="_blank" href="/story/1038296.html"><img src="http://img2.diglog.com/img/2020/12/thumb_d6b8b5094070d816c0eea4f61bb4edd6.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1038296.html">Quell筹集了300万美元，将家庭健身变成了游戏 </a></div><span class="my_story_list_date">2020-12-8 4:37</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>