<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Petabyte-Scale数据集的Neo4J性能冒险 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Petabyte-Scale数据集的Neo4J性能冒险 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-07 11:32:54</div><div class="page_narrow text-break page_content"><p>我最近提出了一个新的研究项目理念：让我们拍摄所有github（或＆lt;插入您的首选VCS主机＆gt;），并创建所有代码的多语言（偶数语言无话）具体语法树，以便我们可以一些其他不可能难以进一步的研究和回答令人难以置信的复杂问题。</p><p>  最初我使用MongoDB开始该项目并将节点之间的引用存储为ObjectID，但是我很快意识到表格格式不足以能够有效地表示真正的树。</p><p> 因此，我将整个项目转换为我遇到的第一个和最重要的图形数据库：neo4j。</p><p> 正如我快速了解到新的数据库范式，我也很快了解到我之间存在很多问题，并将数百个数据的数百个数据插入单个图形......</p><p>  第一个设计使用Neomodel来控制布局并定义图形连接，实际上我们仍然使用Neomodel用于收集过程的较低性能敏感部分。</p><p> 随着Neomodel运行一个相当长的时间，显而易见，当我用CProfile和Snakeviz检查收集器过程时，它的开销太空了。</p><p> 使用Neomodel有多次要求的查询是简单地插入一个语法节点（WSTNode），额外的检查基数和多个语句只能在新创建的节点上设置属性非常慢：尽管我发现我可以插入几百个每秒使用128个进程的节点。 </p><p>从刚刚开始的少数谷歌结果，很清楚，写自己的原始Cypher查询是下一步的下一步，以便更好地控制所需的操作。</p><p>  来自这些努力的下一个公关将WSTNode创建例程重新建成了一系列函数，每个功能都有一个不同的任务：创建节点，连接节点，添加节点文本，连接节点文本等。</p><p> 与使用Neomodel相比，这确实有所改善，但现在主要的瓶颈真的在网络插座上等待。</p><p>  这些5个块中的每一个对应于在插入WSTNode期间使用的5个功能之一，注意到它们是大致相同的大小导致我的下一个改进......</p><p>  一旦我看到每个查询才能初始化连接并读回结果，我都应该减少查询总数，这真的很容易。</p><p> 而不是创建节点，返回ID，运行新查询以使用该ID连接...只是重写Create查询，以连接新节点，这意味着较少的整个查询少执行！</p><p> 所以现在我们减少了每节点的呼叫数量超过一半的时间，我们看到了合理的改进，但我们仍然只在每秒谈论几百个节点，即使是100多名工人。 </p><p>现在我们处于困难的问题。因为我们插入彼此引用的节点集合，我们无法并行迭代它们，否则某些节点可能不会将其父节点写入数据库。</p><p> 因此，为了执行此操作，我需要向WSTnode结构添加另一个属性：预订。此属性对于文件中的节点是唯一的，并且在将WSTnode插入数据库之前计算，这意味着我们可以使用此属性来引用Neo4j的节点ID之前引用节点。</p><p> 一旦我们在文件中唯一地引用节点的方法，我们就可以使用超神奇的展开Cypher语句批量大量节点插入。基本上这允许我们通过一个巨大的查询参数（如列表中的10,000个节点的属性）并执行单个查询以创建这些10,000个节点。</p><p>  如果到目前为止，任何经验丰富的Neo4j用户遵循，他们可能已经意识到，我的WSTNodes上的预订属性在图中不是唯一的，因此即使我们在该属性上有索引，当您的图表成长到大小的Terabytes时，您将拥有太多的节点，其中具有相同的预订，以有效地搜索它们，以查找与我们在工作中相同的WSTFile节点的关系的全部。</p><p> 由于此单个额外的条件在Where子句内，Neo4j数据库定期将我们的实验室服务器的所有128个硬件线程放在WSTNodes中，只需查找与我们WSTFile关系的关系。</p><p> 因此，我需要一种方法来引用我刚刚使用恒定时间查找的节点。我一整天都在思考如何克服这个问题，最后最终接受了只要执行两个查询，而不是继续敲击Cyper语法Quirks会更快。</p><p> 第一个查询后，我使用返回的创建节点ID来执行第二个查询中的常量时间关系。可能有某种方式基于展开的结果创建关系，但只要我们在DB端的常数插入我很开心。 </p><p>绩效改进怎么样？我们从330秒到3岁以下！当然，单个文件330秒首先是荒谬的。</p><p>       我对大量批量大小的初始猜测是每次查询约为10,000个节点，但是当我们乘以128（并行运行的进程）和RAM使用的保守估计时，我们正在寻求尝试在每种千兆字节的多个千兆字节上处理内存中的事务第二。</p><p> 对此的解决方案是在Neo4J.conf中手动设置内存设置，因为我有一个专门的大量系统，专门用于研究工作，我可以窃取相当多的内存：</p><p> #MemRec的设置必须更改有点vs推荐的内容：＃我需要至少128克为我自己的代码运行在同一系统DBMS上。记忆。堆。 initial_size = 31 g dbms。记忆。堆。 max_size = 128 g dbms。记忆。 PageCache。 size = 259500 m＃它也建议将内存错误转换为完全崩溃，而不是允许部分崩溃的数据库继续运行：DBMS。 JVM。附加=  -  xx：+ ExitOnoutofMemoryError</p><p>  neo4j.exceptions.transientError：{code：neo.transienterror.transaction.bookmarkTimeout} {消息：数据库＆＃39; top1k＆＃39;不达到所要求的版本：113071.最新数据库版本是113054}</p><p> 这是一个棘手的，我仍然没有完全固定在发生这种情况的确切条件下，但它归结为数据库不及时应用交易，这意味着当前的“Live版本”可能超过一个几个交易日期。 （具有我的数据规模，它从日期的5-20个版本范围内。）</p><p> 我可以提出这个问题的最好的解决方案是只运行一半的工作进程，我的猜测是数据库一次遇到128次连续交易。 </p><p>我想知道为什么这一切恰好发生，如果可能的话，我会更喜欢将查询失速，直到满足请求的版本（如果无法达到该版本，而不是稍后失败 在。  如果您碰巧了解某些内容或如何发生这种情况，请留言，电子邮件给我发电子邮件，甚至在我们的项目中打开问题！ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://unhexium.net/research/neo4j-performance-adventures-for-petabyte-scale-datasets/">https://unhexium.net/research/neo4j-performance-adventures-for-petabyte-scale-datasets/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/性能/">#性能</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/scale/">#scale</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/节点/">#节点</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1049976.html"><img src="http://img2.diglog.com/img/2021/3/thumb_62d2811e9884847bee91074836281240.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1049976.html">JavaScript性能超出捆绑包大小 </a></div><span class="my_story_list_date">2021-3-1 2:11</span></div><div class="col-sm"><div><a target="_blank" href="/story/1049435.html"><img src="http://img2.diglog.com/img/2021/2/thumb_0d69274f2a0e3a9bd037fc5577579ddc.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1049435.html">我们正在从头开始构建高性能的电动三轮车 </a></div><span class="my_story_list_date">2021-2-26 2:36</span></div><div class="col-sm"><div><a target="_blank" href="/story/1049195.html"><img src="http://img2.diglog.com/img/2021/2/thumb_0a8bd0437f81d04d698969277eb64997.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1049195.html">GitHub具有降级的Git操作性能 </a></div><span class="my_story_list_date">2021-2-25 3:58</span></div><div class="col-sm"><div><a target="_blank" href="/story/1049124.html"><img src="http://img2.diglog.com/img/2021/2/thumb_f981be3f8e4d27ec61d0fe7ffd49e92d.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1049124.html">D-Wave的硬件性能胜过传统计算机 </a></div><span class="my_story_list_date">2021-2-25 1:4</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>