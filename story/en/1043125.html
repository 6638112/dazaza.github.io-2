<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>纯Bash Clojure-ish CI管道 A pure Bash Clojure-ish CI pipeline</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">A pure Bash Clojure-ish CI pipeline<br/>纯Bash Clojure-ish CI管道 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-04 20:27:54</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/1/60b3f241acb76ec3ef27a6ba01535f27.png"><img src="http://img2.diglog.com/img/2021/1/60b3f241acb76ec3ef27a6ba01535f27.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>name: lines  *******************************************************************target:  localstart: ter 22 dez 2020 21:38:01 -03 cmd:  echo hello world ! hello world ! exit-code: 0status:  truefinished: ter 22 dez 2020 21:38:04 -03  ****************************************</p><p>名称：线*************************************************** ********************目标：localstart：ter 22 dez 2020 21:38:01 -03 cmd：echo hello world！你好，世界 ！退出代码：0状态：真实完成：ter 22 dez 2020 21:38:04 -03 *********************************** *********</p><p>  A job is defined as a hashmap of keywords. The commons keywords available for job are:</p><p>  作业定义为关键字的哈希图。可用于工作的commons关键字是：</p><p>   Is the only required keyword that job needs. It&#39;s an array of objects that will be executed by a module. Each element of array is a tasks and the job can handler N tasks. If any tasks has a exit code different than 0, the job will stop and throw the error.  ignore-error and  retries helps to handler errors.</p><p>   是作业所需的唯一必需关键字。它是将由模块执行的对象数组。数组的每个元素都是一个任务，该作业可以处理N个任务。如果任何任务的退出代码都不同于0，则作业将停止并引发错误。忽略错误和重试有助于处理错误。</p><p>                 Host  target is the location where the job will run. If any target passed the job will run at localhost.</p><p>                 主机目标是作业将运行的位置。如果任何目标通过，则作业将在本地主机上运行。</p><p>  Targets can be defined in separated file, during execution is possible to merge data with job and execute the same job in n hosts.</p><p>  目标可以在单独的文件中定义，在执行期间可以将数据与作业合并并在n个主机中执行相同的作业。</p><p>  Is possible set another keywords for filter like  group,  dc or any other value you need to organizer targets.</p><p>  可以为过滤器设置另一个关键字，例如组，直流或组织者目标需要的任何其他值。</p><p>           If some task fail, lines will not stop the pipeline, just return the current task failed.</p><p>           如果某些任务失败，行将不会停止管道，仅返回当前任务失败。 </p><p>      The max retries are  2, but it can be increase setting  LINES_JOB_MAX_ATTEMPTS at environment vars.</p><p>最大重试次数为2，但可以在环境vars处设置LINES_JOB_MAX_ATTEMPTS来增加重试次数。</p><p>              { :module   &#34;docker &#34;  :args { :image   &#34;ubuntu &#34;  :services [{ :image   &#34;nginx &#34;  :alias   &#34;nginx &#34;}]}  :apply [  &#34;apt-get update &#34;   &#34;apt-get install curl -y &#34;   &#34;curl http://nginx &#34;]}</p><p>              {：module＆＃34; docker＆＃34; ：args {：image＆＃34; ubuntu＆＃34; ：服务[{：image＆＃34; nginx＆＃34; ：alias＆＃34; nginx＆＃34;}]}：应用[＆＃34; apt-get update＆＃34; ＆＃34; apt-get install curl -y＆＃34; ＆＃34; curl http：// nginx＆＃34;]}</p><p> start docker instance with nginx image as a  service and set network alias as  nginx</p><p> 使用nginx映像作为服务启动docker实例并将网络别名设置为nginx</p><p>       Services is an array of hashmaps, is possible up N services with docker module, the following keywords can be used to build a service.</p><p>       服务是一个哈希表数组，可以用docker模块最多N个服务，以下关键字可用于构建服务。</p><p>                  ; .lines/modules/git/module.clj  ; create a boilerplate function for git command( str-use [  &#34;git &#34;])  ; custom user function, params: job (receive job definition), i (apply index)  ; the function to return a string eg. `git clone -v git@github.com:rosineygp/mkdkr.git mkdkr`( defn  str-git-command-line [job i] ( git [  &#34;clone &#34;   &#34;-v &#34; ( get i  :repos) ( get i  :dest)]))  ; lines will call this function `lines-module-&lt;module_name&gt;`( defn  lines-module-git [job] ( lines-task-loop job str-git-command-line))   ; loop handler</p><p>                  ; .lines / modules / git / module.clj;为git命令创建样板函数（str-use [＆＃34; git＆＃34;]）；自定义用户功能，参数：job（接收工作定义），i（应用索引）；返回字符串的函数，例如。 `git clone -v git@github.com：rosineygp / mkdkr.git mkdkr`（defn str-git-命令行[job i]（git [＆＃34; clone＆＃34;＆＃34; -v＆ ＃34;（get i：repos）（get i：dest）]））； lines将调用此函数`lines-module-＆lt; module_name＆gt;`（defn lines-module-git [job]（lines-task-loop job str-git-command-line））；循环处理程序</p><p>     ; file: node.edn[{ :name   &#34;build &#34;  :apply [  &#34;npm install &#34;]} [{ :name   &#34;unit test &#34;  :group [  &#34;test &#34;]  :apply [  &#34;npm unit &#34;]} { :name   &#34;mocha test &#34;  :group [  &#34;test &#34;]  :apply [  &#34;npm mocha &#34;]}] { :name   &#34;deploy &#34;  :apply [  &#34;npm deploy &#34;]}]</p><p>     ;文件：node.edn [{：name＆＃34; build＆＃34; ：应用[＆＃34; npm install＆＃34;]} [{：名称＆＃34;单元测试＆＃34; ：组[＆＃34; test＆＃34;]：应用[＆npm unit＆＃34;]} {：名称＆＃34; mocha测试＆＃34; ：组[＆＃34; test＆＃34;]：应用[＆＃34; npm摩卡＆＃34;]}}] {：名称＆＃34;部署＆＃34; ：应用[＆＃34; npm部署＆＃34;]}]</p><p> Jobs inside pipeline can be executed in parallel, just group then with  [ array ], is possible use custom keywords for better notation like  :groups.</p><p> 管道内的作业可以并行执行，只需使用[array]组即可，然后可以使用自定义关键字以获得更好的表示法，例如：groups。 </p><p>    ; file: hosts.edn[{ :label   &#34;vm-0 &#34;  :host   &#34;192.168.1.4 &#34;  :method   &#34;ssh &#34;  :user   &#34;ubuntu &#34;} { :label   &#34;vm-1 &#34;  :host   &#34;192.168.1.5 &#34;  :method   &#34;ssh &#34;  :user   &#34;ubuntu &#34;}]</p><p>;文件：hosts.edn [{：label＆＃34; vm-0＆＃34; ：主机＆＃34; 192.168.1.4＆＃34; ：方法＆＃34; ssh＆＃34; ：user＆＃34; ubuntu＆＃34;} {：label＆＃34; vm-1＆＃34; ：主机＆＃34; 192.168.1.5＆＃34; ：方法＆＃34; ssh＆＃34; ：user＆＃34; ubuntu＆＃34;}]</p><p>  # execute pipeline in all hostslines -p node.edn -i hosts.edn  # filter only wm-0 hostlines -p node.edn -i hosts.edn -l label=wm-0  # filter jobs deploy and host wm-1lines -p node.edn -i hosts.edn -l label=wm-1 -j name=deploy</p><p>  ＃在所有主机行中执行管道-p node.edn -i hosts.edn＃仅过滤wm-0主机行-p node.edn -i hosts.edn -l label = wm-0＃过滤作业部署并托管wm-1lines- p node.edn -i hosts.edn -l label = wm-1 -j name =部署</p><p>     ; generate single job for each yml found and test with docker image yamllint( lines-pp ( parallel ( map ( fn [x] ( assoc {}  :name ( get x  :object)  :module   &#34;docker &#34;  :args { :image   &#34;my/yamllint &#34;}  :apply [( str   &#34;yamllint  &#34; ( get x  :object))])) ( filter ( fn [i] ( =   &#34;yml &#34; ( get i  :type))) ( list-dir   &#34;src/ &#34;)))))</p><p>     ;为找到的每个yml生成一个作业，并使用docker image yamllint（lines-pp（parallel（map（fn [x]（assoc {}：name（get x：object））：module＆＃34; docker＆＃34;： args {：image＆＃34; my / yamllint＆＃34;}：apply [（str＆＃34; yamllint＆＃34;（get x：object））]））（filter（fn [i]（=＆ ＃34; yml＆＃34;（get i：type）））（list-dir＆＃34; src /＆＃34;））））））</p><p>       filter | pmap | println_stderr | exit! | trap! | unset | str-join | str-subs | range | str-ident | mod | file-exists | file-write | unlink | or | and | hashmap-list | merge | key-name | call | callable? | get-in | even? | odd? | load-once | spit</p><p>       过滤器| pmap | println_stderr |出口！ |陷阱！ |未设定str-join | str-subs |范围| str-ident | mod |文件存在|文件写入取消链接|或|和哈希表列表|合并键名|打电话|可以打电话吗？ |进入|甚至？ |奇？ |一次加载|吐</p><p>  ({ :attempts  1  :args {}  :module   &#34;shell &#34;  :status  true  :apply [  &#34;echo hello world! &#34;]  :name   &#34;lines &#34;  :retries  0  :target { :label   &#34;local &#34;  :method   &#34;local &#34;}  :pipestatus (( 0))  :finished  1608684590507  :vars {  &#34;BRANCH_NAME_SLUG &#34;   &#34;master &#34;   &#34;BRANCH_NAME &#34;   &#34;master &#34;}  :ignore-error  false  :start  1608684587657  :result (({ :exit-code  0  :finished  1608684590253  :cmd   &#34;echo hello world! &#34;  :stdout   &#34;hello world! &#34;  :stderr   &#34; &#34;  :start  1608684590233  :debug   &#34; bash -c $&#39; export BRANCH_NAME_SLUG= \&#34;master \&#34; BRANCH_NAME= \&#34;master \&#34; ; echo hello world! &#39;  &#34;}))})</p><p>  （{：尝试1：args {}：module＆＃34; shell＆＃34;：status true：apply [＆＃34; echo hello world！＆＃34;]：name＆＃34; lines＆＃34; ：retries 0：target {：label＆＃34;：local＆＃34;：method＆＃34;}：pipestatus（（0））：完成1608684590507：vars {＆＃34; BRANCH_NAME_SLUG＆＃34 ;＆＃34; master＆＃34;＆＃34; master＆＃34;}：ignore-error false：start 1608684587657：result（（{{：exit-code 0：Finished 1608684590253 ：cmd＆＃34; echo hello world！＆＃34;：stdout＆＃34; hello world！＆＃34;：stderr＆＃34;＆＃34;：start 1608684590233：debug＆＃34; bash -c $ ＆＃39;导出BRANCH_NAME_SLUG = \＆＃34; master \＆＃34; BRANCH_NAME = \＆＃34; master \＆＃34;; echo hello world！＆＃39;＆＃34;}））}））</p><p>     Is possible create functions and extend usability, all extensions must be keep at  .lines/ext/, it is just a clojure script with useful functions.</p><p>     可能创建函数并扩展可用性，所有扩展名都必须位于.lines / ext /，这只是具有有用功能的clojure脚本。</p><p> ; file: .lines/ext/apt-helper.clj( str-use [  &#34;apt-get &#34;])( defn  apt-update [] ( apt-get [  &#34;update &#34;]))( defn  apt-args [options packages] ( apt-get ( concat options packages)))( defn  apt-install [packages] ( apt-args [  &#34;install &#34;   &#34;-y &#34;] packages))( defn  apt-remove [packages] ( apt-args [  &#34;remove &#34;   &#34;-y &#34;] packages))</p><p> ;文件：.lines / ext / apt-helper.clj（str-use [＆＃34; apt-get＆＃34;]）（defn apt-update []（apt-get [＆＃34; update＆＃34 ;]））（defn apt-args [选项软件包]（apt-get（concat选项软件包）））（defn apt-install [软件包]（apt-args [＆＃34; install＆＃34;＆＃34; -y＆＃34;]程序包））（defn apt-remove [程序包]（apt-args [＆＃34; remove＆＃34;＆＃34; -y＆＃34;]程序包）） </p><p>      flk is same of  Fleck with  patches/ applied and  lines is flk with all  src/ included.</p><p>flk与应用了patch /的Fleck相同，而flk包含所有src /。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://github.com/rosineygp/lines">https://github.com/rosineygp/lines</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/clojure/">#clojure</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/bash/">#bash</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/作业/">#作业</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>