<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>SSH隧道的直观指南 A visual guide to SSH tunnels</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">A visual guide to SSH tunnels<br/>SSH隧道的直观指南 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-02-09 20:22:45</div><div class="page_narrow text-break page_content"><p>This page explains use cases and examples of SSH tunnels while visually presentingthe traffic flows. For example, here&#39;s a reverse tunnel that allows only users fromIP address 1.2.3.4 access to port 80 on the SSH client through an SSH server.</p><p>该页面在直观地显示流量时说明了SSH隧道的使用案例和示例。例如，这是一个反向隧道，该隧道仅允许IP地址1.2.3.4的用户通过SSH服务器访问SSH客户端上的端口80。</p><p>  SSH tunnels are encrypted TCP connections between SSH clients and serversthat allows traffic entering one side of the tunnel to transparently exitthrough the other. While the term originally referred to tunnels using TUN/TAP virtualnetwork interfaces, it&#39;s commonly used to refer to SSH port forwarding nowadays.Use cases include:</p><p>  SSH隧道是SSH客户端和服务器之间的加密TCP连接，它允许进入隧道一侧的流量透明地从另一侧退出。虽然该术语最初是指使用TUN / TAP虚拟网络接口的隧道，但如今通常用于指代SSH端口转发。用例包括：</p><p> Local port forwarding allows you to forward traffic on the SSH clientto some destination through an SSH server. This lets you accessremote services over an encrypted connection as if they were local services.Example use cases:</p><p> 本地端口转发使您可以将SSH客户端上的流量通过SSH服务器转发到某个目标。这使您可以通过加密连接访问远程服务，就像它们是本地服务一样。用例示例：</p><p> Remote port forwarding allows you to forward traffic on an SSH serverto a destination through either the SSH client or another remote host.This gives users on public networks access to resources on private networks.Example use cases:</p><p> 远程端口转发使您可以将SSH服务器上的流量通过SSH客户端或其他远程主机转发到目标，这使公用网络上的用户可以访问专用网络上的资源。</p><p> Dynamic port forwarding opens a SOCKS proxy on the SSH client that letsyou forward TCP traffic through the SSH server to a remote host.</p><p> 动态端口转发在SSH客户端上打开一个SOCKS代理，使您可以通过SSH服务器将TCP流量转发到远程主机。</p><p> If you want to open a privileged port (ports 1-1023) to forward traffic, you&#39;llneed to run SSH with superuser privileges on the system that opens the port.</p><p> 如果要打开特权端口（端口1-1023）以转发流量，则需要在打开端口的系统上以超级用户特权运行SSH。</p><p> sudo ssh -L 80:example.com:80 ssh-server</p><p> sudo ssh -L 80：example.com：80 SSH服务器 </p><p> -f # forks the ssh process into the background -n # prevents reading from STDIN -N # do not run remote commands. Used when only forwarding ports -T # disables TTY allocation Here&#39;s an example of a command you would run to create an SSH tunnelin the background that forwards a local port through the ssh server.</p><p>-f＃将ssh进程派生到后台-n＃防止从STDIN读取-N＃不运行远程命令。仅在转发端口时使用-T＃禁用TTY分配这是您将在后台创建SSH隧道的命令示例，该隧道通过ssh服务器转发本地端口。</p><p> ssh -fnNT -L 127.0.0.1:8080:example.org:80 ssh-server</p><p> ssh -fnNT -L 127.0.0.1:8080:example.org:80 ssh服务器</p><p> ssh -L 127.0.0.1:8080:example.org:80 ssh-server  Forwards connections to 127.0.0.1:8080 on your local systemto port 80 on example.org through ssh-server. The traffic between yourlocal system and ssh-server is wrapped in an SSH tunnel,but the traffic between ssh-server and example.org is not.From the perspective of example.org the traffic originates fromssh-server.</p><p> ssh -L 127.0.0.1:8080:example.org:80 ssh-server通过ssh-server将连接转发到本地系统上的127.0.0.1:8080到example.org上的端口80。本地系统和ssh-server之间的流量包装在SSH隧道中，但ssh-server和example.org之间的流量不是。从example.org的角度来看，流量来自ssh-server。</p><p> ssh -L 8080:example.org:80 ssh-server ssh -L *:8080:example.org:80 ssh-server  Forwards connections to port 8080 on all interfaces on your local systemto example.org:80 through a tunnel to ssh-server.</p><p> ssh -L 8080：example.org：80 ssh服务器ssh -L *：8080：example.org：80 ssh-server通过隧道将连接转发到本地系统所有接口上的8080端口到example.org:80 -服务器。</p><p> ssh -L 192.168.0.1:5432:127.0.0.1:5432 ssh-server  Forwards connections to 192.168.0.1:5432 on your local system to127.0.0.1:5432 on ssh-server. Note that 127.0.0.1 here is localhostfrom the viewpoint of ssh-server.</p><p> ssh -L 192.168.0.1:5432:127.0.0.1:5432 ssh-server将连接转发到本地系统上的192.168.0.1:5432到ssh-server上的127.0.0.1:5432。请注意，从ssh-server的角度来看，这里的127.0.0.1是localhost。</p><p> Make sure that TCP forwarding is enabled on the SSH server. By default it should be.</p><p> 确保在SSH服务器上启用了TCP转发。默认情况下应该是。</p><p>  AllowTcpForwarding yes If you&#39;re forwarding ports on interfaces other than 127.0.0.1 then you&#39;llneed to enable GatewayPorts on your local system, either within ssh_config or asa command-line option</p><p>  AllowTcpForwarding是如果您要在127.0.0.1以外的接口上转发端口，则需要在ssh_config或asa命令行选项中启用本地系统上的GatewayPorts。 </p><p>  GatewayPorts yes</p><p>GatewayPorts是</p><p>  If you want to use a secure connection to access a remote servicethat communicates over plaintext. For example, redis and memcachedall use plaintext protocols. If you securely access one of these serviceson a remote server over public networks, you can tunnel a connectionfrom your local system to the remote server instead of having it listenover the public internet.</p><p>  如果要使用安全连接来访问通过纯文本进行通信的远程服务。例如，redis和memcachedall使用纯文本协议。如果您通过公共网络安全地访问远程服务器上的这些服务之一，则可以从本地系统到远程服务器建立隧道连接，而不必通过公共Internet进行监听。</p><p> ssh -R 8080:localhost:80 ssh-server  Forwards traffic to all interfaces on port 8080 on ssh-server tolocalhost port 80 on your local computer. If one of these interfaces is availableto the public internet, traffic connecting to port 8080 will be forwarded to yourlocal system.</p><p> ssh -R 8080：localhost：80 ssh-server将流量转发到ssh-server上端口8080上的所有接口到本地计算机上的localhost端口80。如果这些接口之一可用于公用Internet，则连接到端口8080的流量将转发到您的本地系统。</p><p> ssh -R 1.2.3.4:8080:localhost:80 ssh-server  Forwards traffic to ssh-server:8080 to localhost:80 on your local systemwhile only allowing access to the SSH tunnel entrance on ssh-serverfrom IP address 1.2.3.4. Use The GatewayPorts clientspecified directivewith this.</p><p> ssh -R 1.2.3.4:8080:localhost:80 ssh-server将流量转发到本地系统上的ssh-server：8080到localhost：80，同时仅允许从IP地址1.2.3.4访问ssh-server上的SSH隧道入口。与此一起使用GatewayPorts客户端指定的指令。</p><p> ssh -R 8080:example.org:80 ssh-server  Forwards traffic to all interfaces on ssh-server:8080 to localhost:80on your local system. From your local system, traffic is then forwardedto example.org:80. From the perspective of example.org the trafficis originating from your local system.</p><p> ssh -R 8080：example.org：80 ssh-server将流量转发到本地系统上ssh-server：8080上的所有接口到localhost：80。然后，从您的本地系统将流量转发到example.org:80。从example.org的角度来看，流量源自您的本地系统。</p><p> By default, forwarded ports are not accessible to the public internet.You&#39;ll need to add this to your sshd_config on your remote server to forwardpublic internet traffic to your local computer.</p><p> 默认情况下，公共Internet无法访问转发的端口。您需要将此端口添加到远程服务器上的sshd_config中，以将公共Internet流量转发到本地计算机。</p><p> GatewayPorts yes Or if you&#39;d like to specify which clients are allowed access, you can usethe following in your sshd_config instead</p><p> GatewayPorts是，或者如果您想指定允许哪些客户端访问，则可以在sshd_config中使用以下内容代替 </p><p> GatewayPorts clientspecified</p><p>指定的GatewayPorts客户端</p><p> ssh -D 3000 ssh-server  Opens a SOCKS proxy on port 3000 of all interfaces on your local system.This allows you to forward traffic sent through the proxy to the ssh-serveron any port or destination host. By default, SSH will use the SOCKS5 protocol,which forwards TCP and UDP traffic.</p><p> ssh -D 3000 ssh-server在本地系统所有接口的端口3000上打开一个SOCKS代理。这使您可以将通过代理发送的流量转发到任何端口或目标主机上的ssh-server。默认情况下，SSH将使用SOCKS5协议，该协议转发TCP和UDP通信。</p><p>  When you have a SOCKS proxy running, you can configure your web browserto use the proxy to access resources as if connections were originatingfrom ssh-server. For example, if ssh-server had access to other serverswithin a private network, by using using a SOCKS proxy you could accessthose other servers locally as if you were on the network, without needingto set up a VPN.</p><p>  运行SOCKS代理后，可以将Web浏览器配置为使用代理访问资源，就好像连接是从ssh-server发起的一样。例如，如果ssh-server可以访问专用网络中的其他服务器，则可以使用SOCKS代理来访问本地的其他服务器，就像在网络上一样，而无需设置VPN。</p><p>  If you want the SOCKS proxy to be available to more interfaces than justlocalhost, make sure to enable GatewayPorts on your local system.</p><p>  如果您希望SOCKS代理可用于除本地主机以外的更多接口，请确保在本地系统上启用GatewayPort。</p><p> GatewayPorts yes Since GatewayPorts is being configured on the SSH client here, you can also configure it with a command-line option instead of ssh_config.</p><p> GatewayPorts是由于此处在SSH客户端上配置了GatewayPorts，因此您也可以使用命令行选项而不是ssh_config对其进行配置。</p><p> ssh -o GatewayPorts=yes -D 3000 ssh-server</p><p> ssh -o GatewayPorts =是-D 3000 ssh服务器</p><p> ssh -J user1@jump-host user2@remote-host ssh -o &#34;ProxyJump user1@jump-host&#34; user2@remote-host  Establishes an SSH connection with jump-host and forwards TCP trafficto remote-host. Connecting to remote-host through an intermediate jump-host.The above command should work out of the box if jump-host already hasSSH access to remote-host. If it does not, you can use agent forwardingto forward the SSH identity of your local computer to remote-host.</p><p> ssh -J user1 @ jump-host user2 @ remote-host ssh -o＆＃34; ProxyJump user1 @ jump-host＆＃34; user2 @ remote-host与跳转主机建立SSH连接，并将TCP通信转发到远程主机。通过中间的跳转主机连接到远程主机。如果跳转主机已经具有对远程主机的SSH访问权限，则上述命令应立即可用。如果不是，则可以使用代理转发将本地计算机的SSH身份转发到远程主机。 </p><p>  ssh -o ProxyCommand=&#34;nc -X 5 -x localhost:3000 %h %p&#34; user@remote-host  Connecting to a remote server through a SOCKS5 proxy using netcat.From the perspective of the server, the originating IP is from proxy-host.However, the SSH connection itself is end-to-end encrypted so proxy-hostonly sees an encrypted stream of traffic between the local systemand remote-host.</p><p>ssh -o ProxyCommand =＆＃34; nc -X 5 -x localhost：3000％h％p＆＃34; user @ remote-host使用netcat通过SOCKS5代理连接到远程服务器。从服务器的角度来看，原始IP来自代理主机，但是SSH连接本身是端到端加密的，因此仅代理主机查看本地系统和远程主机之间的加密通信流。</p><p> To enable agent forwarding, you can use ssh-add to add your local SSHidentity to your local ssh agent.</p><p> 要启用代理转发，可以使用ssh-add将本地SSHidentity添加到本地ssh代理。</p><p> ssh-add</p><p> SSH添加</p><p> The commands listed above work on an ad-hoc basis, but ifyou want to maintain SSH tunnels through network outages orunreliable connections, you&#39;ll have to do some additional setup.</p><p> 上面列出的命令是临时运行的，但是如果您想通过网络中断或不可靠的连接来维护SSH隧道，则必须进行一些附加设置。</p><p> By default, the TCP connection used to establish an SSH tunnelmay time out after a period of inactivity. To prevent timeouts,you can configure the server to send heartbeat messages.</p><p> 默认情况下，一段时间不活动后，用于建立SSH隧道的TCP连接可能会超时。为了防止超时，可以将服务器配置为发送心跳消息。</p><p>  ServerAliveInterval 15 ServerAliveCountMax 4   ClientAliveInterval 15 ClientAliveCountMax 4</p><p>  ServerAliveInterval 15 ServerAliveCountMax 4 ClientAliveInterval 15 ClientAliveCountMax 4</p><p> While the above options may prevent a connection from droppingdue to inactivity, they will not re-establish dropped connections.To ensure that an SSH tunnel will be re-established, you can useautossh, which builds an SSH tunnel and monitors its health.</p><p> 尽管上述选项可以防止由于不活动而导致连接断开，但它们不会重新建立断开的连接。要确保重新建立SSH隧道，可以使用autossh来建立SSH隧道并监视其运行状况。 </p><p>  autossh -R 2222:localhost:22 ssh-server  This establishes a reverse tunnel that comes back after network failures.By default, AutoSSH will open extra ports on the SSH client and server forhealth checks. If traffic appears to no longer pass between the health checkports, AutoSSH will restart the SSH tunnel.</p><p>autossh -R 2222：localhost：22 ssh-server这将建立一个反向隧道，该隧道在网络故障后会返回。默认情况下，AutoSSH将在SSH客户端和服务器上打开额外的端口以进行运行状况检查。如果运行状况检查端口之间似乎不再有流量通过，则AutoSSH将重新启动SSH隧道。</p><p> autossh -R 2222:localhost:22 \   -M 0 \   -o &#34;ServerAliveInterval 10&#34; -o &#34;ServerAliveCountMax 3&#34; \   remote-host Using the -M 0 flag disables the health check ports and allows the SSH clientto handle the health checks. In this example, the SSH client expects the serverto send a heartbeat every 10 seconds. If 3 heartbeats fail in a row, the SSH clientexits, and AutoSSH will re-establish a new connection.</p><p> autossh -R 2222：localhost：22 \ -M 0 \ -o＆＃34; ServerAliveInterval 10＆＃34; -o＆＃34; ServerAliveCountMax 3＆＃34;远程主机使用-M 0标志禁用运行状况检查端口，并允许SSH客户端处理运行状况检查。在此示例中，SSH客户端希望服务器每10秒发送一次心跳。如果连续3个心​​跳失败，则SSH客户端退出，并且AutoSSH将重新建立新连接。</p><p> Let&#39;s say there&#39;s a git repository on a private network that&#39;s only accessiblethrough a private server on the network. This server is not accessible to the publicinternet. You have direct access to the server, but don&#39;t have VPN access to theprivate network.</p><p> 假设在专用网络上有一个git存储库，该存储库只能通过网络上的专用服务器进行访问。该服务器不可用于publicinternet。您可以直接访问服务器，但不能访问专用网络的VPN。</p><p>  For convenience, you&#39;d like to access this private git repository as if you wereconnecting to it directly from your local system. If you have SSH access to anotherserver that&#39;s accessible from both your local system and the private server, youcan accomplish this by establishing an SSH tunnel and using a couple ofProxyCommand directives.</p><p>  为了方便起见，您希望访问此私有git存储库，就好像您是直接从本地系统连接到它一样。如果您对本地服务器和私有服务器均可访问的另一台服务器具有SSH访问权限，则可以通过建立SSH隧道并使用几个ProxyCommand指令来实现此目的。</p><p> ssh -L 127.0.0.1:22:127.0.0.1:2222 intermediate-host  This forwards port 2222 on intermediate-host to port 22 on the private server.Now, if you SSH to port 2222 from intermediate-host, you&#39;re connecting to theSSH server on the private server despite the private server not being accessibleby the public internet.</p><p> ssh -L 127.0.0.1:22:127.0.0.1:2222中间主机它将中间主机上的端口2222转发到专用服务器上的端口22。现在，如果您从中间主机SSH到端口2222，则您＆＃39;即使公用Internet无法访问专用服务器，也要重新连接到专用服务器上的SSH服务器。</p><p> ssh -p 2222 user@localhost If you&#39;d like to make the backdoor even more convenient, you can addsome directives to your local ~/.ssh/config</p><p> ssh -p 2222 user @ localhost如果您想使后门更加方便，则可以向本地〜/ .ssh / config添加一些指令</p><p> Host git.private.network   HostName git.private.network   ForwardAgent yes   ProxyCommand ssh private nc %h %p  Host private   HostName localhost   Port 2222   User private-user   ForwardAgent yes   ProxyCommand ssh tunnel@intermediate-host nc %h %p  Now you have access to the private git repository as if you were on the privatenetwork.</p><p> 主机git.private.network主机名git.private.network ForwardAgent是ProxyCommand ssh私有nc％h％p主机私有主机名localhost本地端口2222用户私有用户ForwardAgent是ProxyCommand ssh tunnel @ intermediate-host nc访问％h％p到私有git仓库，就像您在私有网络上一样。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://robotmoon.com/ssh-tunnels/">https://robotmoon.com/ssh-tunnels/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/隧道/">#隧道</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/guide/">#guide</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ssh/">#ssh</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>