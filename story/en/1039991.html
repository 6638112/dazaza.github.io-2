<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我建立了一个智能恒温器 I Built a Smart Thermostat</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">I Built a Smart Thermostat<br/>我建立了一个智能恒温器 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-16 14:06:17</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/12/8a56af2475732c6fc884cd84b3157621.jpeg"><img src="http://img2.diglog.com/img/2020/12/8a56af2475732c6fc884cd84b3157621.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>The pursuit of minimizing my commute to work led me to move into an apartment with no temperature control. Given how common this is for downtown Chicago apartments with reasonable rent, I thought to myself, if other people can live without it, I’m sure I can too. Well, I was partially right, it was livable but not comfortable. So here is the story of how I built my own smart thermostat.</p><p>为了尽量减少通勤，我搬进了没有温度控制的公寓。考虑到芝加哥市中心租金合理的公寓有多普遍，我对自己想，如果其他人可以没有它，我肯定也可以。好吧，我部分正确，虽然宜居但不舒服。这就是我如何构建自己的智能恒温器的故事。</p><p>  The apartment didn’t come with a traditional thermostat control unit with all the lettered and colored wiring.</p><p>  该公寓没有配备带有所有带字母和彩色接线的传统恒温控制单元。</p><p>  Instead, the control unit is fairly simple with an on and off switch and another three fan speed switch. The temperature dial doesn’t work, the building controls whether its heating or cooling time. Even though it changes based on the temperature outside, for the sake of simplicity we will assume the temperature of the air coming out of the heater is constant.</p><p>  取而代之的是，控制单元非常简单，带有一个开/关开关和另一个三个风扇速度开关。温度刻度盘不起作用，建筑物控制加热或冷却时间。即使它是根据外界温度变化的，但为简单起见，我们将假定从加热器出来的空气的温度是恒定的。</p><p> Given how old the building is and that I am renting, I chose not to install a  controller with relay or  program one with a Raspberry Pi. I had to build a system that interacts with the control unit the same way I do.</p><p> 鉴于建筑物的历史和我要租的建筑物，我选择不安装带继电器的控制器，也不选择使用Raspberry Pi编程。我必须建立一个以与我相同的方式与控制单元进行交互的系统。</p><p>   Flipping the on and off switch requires both torque and precision, so I went with a pair of  SG90 servo motors.</p><p>   拨动通断开关既需要扭矩又需要精度，因此我选择了一对SG90伺服电机。</p><p>  I started the quest of finding a temperature sensor with the  DHT22, and I strongly recommend against using it. The way the sensor is designed makes it susceptible to heating up thus messing up its accuracy. I eventually went with the  DS18B20 sensor since interfaces with the Pi better, has a longer wire, and is more accurate. Lesson learned here, do your research instead of going off the first YouTube tutorial you watch.</p><p>  我开始寻找使用DHT22的温度传感器，强烈建议不要使用它。传感器的设计方式使其容易受热，从而破坏了其准确性。我最终选择了DS18B20传感器，因为它与Pi的接口更好，电线更长，更准确。您可以在这里学到的经验教训做研究，而不必先观看您观看的第一个YouTube教程。</p><p> I knew I wanted to use Lego to build the frame. Unlike 3D printing, Lego builds can be changed quickly and at no cost. At the same time, Lego pieces are designed to fit with each other in specific dimensions and increments. This made working around the Raspberry Pi and servo motors dimensions more challenging. Further more, I was constrained by the limited number of pieces I had.</p><p> 我知道我想用乐高积木制作框架。与3D打印不同，乐高积木可以快速免费更换。同时，乐高积木被设计成在特定的尺寸和增量上相互配合。这使得围绕Raspberry Pi和伺服电机尺寸的工作更具挑战性。此外，我受制于有限的作品数量。 </p><p>   The build took many iterations that ended up with it being more practical and sturdy than pretty. The limited amount of pieces pushed me to get creative with my building techniques. As you can see in the picture above and in this  album, I relied on axles to give me the freedom to slide the motors to where their arms are perpendicular to the on and off switch. Without getting too Lego technical, the motors are tightly held in place from all directions using half-studs, axels, and half-pegs/pins.</p><p>该构建进行了多次迭代，最终使它变得更加实用和坚固。数量有限的作品促使我在建筑技术上发挥创造力。正如您在上图和此专辑中所看到的，我依靠车轴使我可以自由地将电动机滑动到其臂垂直于开关的位置。无需太过Lego技术，就可以使用半螺柱，半轴和半销子/销将电动机从各个方向紧密地固定在适当的位置。</p><p>  Before we begin, the entire codebase for the projects can be found  here, feel free to checkout it out and leave any feedback.</p><p>  在开始之前，您可以在这里找到项目的整个代码库，可以随时对其进行检出并留下任何反馈。</p><p> I first wrote the Python scripts to control the motors and probe the temperature sensor. Writing these scripts was relatively easy given the abundance of online tutorials about these Raspberry Pi parts.</p><p> 我首先编写了Python脚本来控制电机和探测温度传感器。考虑到有关这些Raspberry Pi零件的大量在线教程，编写这些脚本相对容易。</p><p> Once I figured out the details around the thermostat logic, writing a Spring Boot application that exposes that thermostat’s API endpoints and houses it’s logic were straight forward, with the exception of calling the python scripts. Despite its age, this  article nicely describes why calling another process in Java bears such complexity. The Google Home integration was later added to the same application, the details of the integration are outlined in a later section.</p><p> 一旦我弄清了恒温器逻辑的细节，就编写了一个Spring Boot应用程序，该程序公开了恒温器的API端点并包含其逻辑，这很简单，只是调用了python脚本。尽管年代久远，本文还是很好地描述了为什么用Java调用另一个进程会带来如此复杂的原因。 Google Home集成后来被添加到同一应用程序中，集成的详细信息将在后面的部分中概述。</p><p>  Writing the thermostat logic opened my eye to a small portion of the vast design decisions and trade offs involved in making one.</p><p>  编写恒温器逻辑使我可以看到一小部分庞大的设计决策，并在做出决策时需要权衡取舍。</p><p> The simple stupid approach for the logic is as follows: keep the apartment temperature as close as possible to the temperature we set. This is not realistic as it would keep turning the system on and off very frequently, thus why the system needs a tolerance window. Introducing a tolerance window would let the temperature veer off the one we set by a Fahrenheit degree or two. If done right, the tolerance window will minimize the number of on and off cycles thus keeping the system on or off for longer, all without sacrificing our comfort.</p><p> 逻辑上的简单愚蠢方法如下：保持公寓温度尽可能接近我们设定的温度。这是不现实的，因为它将经常频繁地打开和关闭系统，因此为什么系统需要公差窗口。引入容差窗口将使温度偏离我们设定的华氏温度一到两个温度。如果操作正确，公差窗口将最大程度地减少打开和关闭循环的次数，从而使系统保持打开或关闭的时间更长，而这一切都不会影响我们的舒适度。</p><p> This tolerance window can be introduced into the system in two ways. For one, I can add a degree or two to the detected temperature. Or I can extend the duration in which the system polls the temperature sensor. Doing both together is possible as well.</p><p> 该公差窗口可以通过两种方式引入系统。首先，我可以将检测到的温度增加一到两个度。或者，我可以延长系统轮询温度传感器的时间。一起做也是可能的。 </p><p> Knowing myself and how I will probably try and work around it, I decided to abandon adding a constant to the temperature reading. As for the best polling time, it varies a lot because of how sensitive our poorly insulated apartment is to the temperature outside. And to make matters even more complex, between noon and sunset, the sun takes an active part in heating the place for us. So eventually, after a few trial and error days, setting the polling time to 20 minutes seemed like a good middle ground.</p><p>了解了自己以及我将如何尝试解决该问题后，我决定放弃在温度读数中添加一个常量。至于最佳轮询时间，由于我们绝缘不良的公寓对外界温度的敏感程度，其时间差异很大。为了使事情变得更加复杂，在中午和日落之间，太阳为我们加热了这个地方。因此，经过几天的反复试验，最终将轮询时间设置为20分钟似乎是一个很好的中间立场。</p><p>  While talking about the constraints, I glossed over two more factors that affect the system’s behavior. The fan speed and the temperature of the fluid running through pipes. These two go hand in hand to specify the effectiveness of the system. The fluid temperature is out of our control since the building adjusts it based on the outside temperature. On the other hand, the fan has three adjustable speeds we get to control. Without worrying too much about the pipe’s temperature, I found that setting the fan speed to high resulted in a better heat distribution throughout the apartment, since the system was heating a bigger volume of air. I’m assuming the opposite would work better for a smaller space.</p><p>  在讨论约束时，我忽略了另外两个影响系统行为的因素。风扇速度和流经管道的流体的温度。两者齐头并进，以指定系统的有效性。流体温度超出我们的控制范围，因为建筑物会根据外部温度对其进行调整。另一方面，风扇具有我们可以控制的三个可调速度。不用过多担心管道的温度，我发现将风扇速度设置为较高会导致整个公寓内更好的热量分配，因为系统正在加热更大的空气量。我假设相反的情况在较小的空间内会更好。</p><p>  To position the temperature sensor in what I believed to be the ideal height, I did some experimentation with the help of an indoor thermometer. Many days later, I realized that the position of the sensor doesn’t matter, it’s our perception of the temperature that does. Our perception will adopt regardless of the thermostat’s reading. In other words, instead of always setting the temperature to 70, we’d either set it to 71 or even 72 degrees and achieve the same result.</p><p>  为了将温度传感器定位在我认为是理想的高度，我在室内温度计的帮助下进行了一些实验。许多天后，我意识到传感器的位置无关紧要，这取决于我们对温度的感知。无论恒温器的读数如何，我们的看法都会得到采纳。换句话说，不是将温度始终设置为70，而是将温度设置为71甚至72度即可达到相同的结果。</p><p>  This step turned out to be more complex than anticipated. The picture below shows the information follow from the user to the Google Assistant and eventually to the smart device:</p><p>  事实证明，此步骤比预期的要复杂。下图显示了从用户到Google Assistant以及最终到智能设备的信息：</p><p>  Google’s Smart Home documentation outlines the integration as follows:  1) Setting up OAuth 2.0 for authorization and account linking. 2) Creating a Smart Home action in the Action Console.  3) Adding authentication.</p><p>  Google的Smart Home文档概述了以下集成：1）设置OAuth 2.0以进行授权和帐户链接。 2）在操作控制台中创建智能家居操作。 3）添加身份验证。</p><p> Actions in Google’s landscape are the equivalent of Amazon’s Alexa skills. Smart Home is a type of action that deals with smart devices integration.</p><p> 在Google领域中的动作等同于Amazon的Alexa技能。智能家居是处理智能设备集成的一种操作。</p><p> While going through the steps, I was disappointed to find out that regardless of whether I intent to publish my Smart Home action or not, I had to go through all of the steps. I couldn’t find a way that allows me to skip the OAuth and authentication steps in order to create a quick and easy test for my action. I don’t understand the reasoning behind such decision, since as of now, with everything setup, no one except me has access to my action unless I explicitly invite them.</p><p> 在执行这些步骤时，我很失望地发现，无论我是否打算发布智能家居操作，我都必须完成所有步骤。我找不到一种方法可以跳过OAuth和身份验证步骤，以便为自己的操作创建快速简便的测试。我不了解做出此决定的原因，因为到目前为止，在完成所有设置后，除非我明确邀请他们，否则只有我可以参与其中。 </p><p> Moreover, enforcing steps 1 and 3 means that anyone who plans to experiment with a Smart Home action must possess a publicly accessible URL. I was able to overcome this by using  ngrok, an awesome tool that tunnels traffic from a public URL to your local machine. Since the free version of ngrok uses a new random URL after each restart, I decided to pay for their basic plan which gives me the ability to reserve URLs on their domain. I recommend doing this, since I now don’t have to worry about changing the URL settings after any restart.</p><p>此外，执行步骤1和步骤3意味着计划进行Smart Home动作试验的任何人都必须拥有可公开访问的URL。我使用ngrok克服了这一问题，ngrok是一种很棒的工具，可将流量从公共URL传输到本地计算机。由于ngrok的免费版本在每次重新启动后都会使用一个新的随机URL，因此我决定为其基本计划付费，这使我能够在其域上保留URL。我建议您这样做，因为现在不必担心重新启动后更改URL设置。</p><p> Lastly, setting up the actions fulfillment endpoint that Google Cloud will call was a mix of looking at the  documentation,  samples, and reverse engineering.</p><p> 最后，设置Google Cloud将调用的操作执行端点是将文档，示例和反向工程结合在一起。</p><p>  Like any project, I had my ups and downs while working on this but I’m very satisfied with the final product and how well it works. Before I sign off, I want to give a shoutout to the  Pi-hole project, they help you setup a DNS black hole to achieve network-wide ad blocking, I strongly recommend setting it up if you have a Raspberry Pi or any compatible hardware.</p><p>  像其他任何项目一样，我在进行这项工作时也经历了很多挫折，但是我对最终产品及其效果如何感到非常满意。在我退出之前，我想大声疾呼Pi-hole项目，它们可以帮助您设置DNS黑洞以实现网络范围内的广告拦截，如果您使用Raspberry Pi或任何兼容的硬件，强烈建议进行设置。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://medium.com/swlh/how-i-built-a-smart-thermostat-8bd9510cf9de">https://medium.com/swlh/how-i-built-a-smart-thermostat-8bd9510cf9de</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/智能/">#智能</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/smart/">#smart</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/温度/">#温度</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>