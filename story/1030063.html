<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>PyInstrument-关注慢速部分的统计Python配置文件</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">PyInstrument-关注慢速部分的统计Python配置文件</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-20 22:46:54</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/ebba69f4297e762af60b8f98f2e4d95d.png"><img src="http://img2.diglog.com/img/2020/10/ebba69f4297e762af60b8f98f2e4d95d.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>PyInstrument是一个Python分析器。分析器是一种工具，可以帮助您优化代码-使其速度更快。这听起来很明显，但是要获得最大的速度提升，您应该专注于程序中最慢的部分。PyInstrument会帮助您找到它！</p><p>要从GIT签出运行PyInstrument，有一个构建步骤。看看如何贡献更多信息。</p><p>直接从命令行调用PyInstrument。不是编写python script.py，而是输入pyInstrument script.py。您的脚本将正常运行，并且在结束时(或者当您按^C时)，PyInstrument将输出彩色摘要，显示大部分时间都花在哪里。</p><p>用法：pyInstrument[选项]scriptfile[arg]...选项：--version show program的版本号和exit-h，--help显示此帮助消息并退出--load-prev=ID如果不运行脚本，请加载以前的报表-m module_name将库模块作为脚本运行，如&#39；python-m module&#39；-o OUTFILE，--outfile=OUTFILE save to&lt；outfile&gt；-r渲染器，--renender=渲染器应如何呈现报表。以下内容之一：text&39；、html&39；、&#39；json&39；或到渲染器类的python导入路径-t、--timeline呈现为时间线-保留顺序，并且不压缩重复调用--ide=expr glob样式模式，匹配要隐藏其帧的文件路径。默认为&#39；*/lib/*&#39；。--Hide-regex=与要隐藏其帧的文件路径匹配的REGEX regex。如果--HIDE没有给予足够的控制，那就有用了。--show-all(仅限文本渲染器)显示外部库代码--unicode(仅限文本渲染器)强制Unicode文本输出--no-unicode(仅限文本渲染器)强制ascii文本输出--color(仅限文本渲染器)强制ansi彩色文本输出--no-color(仅限文本渲染器)强制不输出彩色文本。</p><p>ProTip：-r html会给你一个HTML格式的交互式个人资料报告--你真的可以通过这种方式来探索！</p><p>安装后，将？PROFILE添加到请求URL的末尾以激活探查器。您的请求将照常运行，但您不会得到响应，而是会在网页中获得pyInstrument对请求的分析。</p><p>如果您正在编写API，当您想要分析某些内容时，更改URL并非易事。在这种情况下，将PYINSTRUMENT_PROFILE_DIR=&#39；PROFILES=#39；添加到settings.py。PyInstrument将分析每个请求，并将HTML输出保存到您工作目录中的文件夹配置文件中。</p><p>如果要根据请求显示分析页面，可以将PYINSTRUMENT_SHOW_CALLBACK定义为函数的虚线路径，该函数用于确定是否应该显示页面。您可以提供自己的函数回调(Request)，它在settings.py中返回True或False。</p><p>从flask import Flask，g，make_response，请求app=flask(__Name__)@app。BEFORE_REQUEST定义BEFORE_REQUEST()：如果请求中的&#34；配置文件&#34；。参数：g.profiler=profiler()g.profiler。Start()@app。AFTER_REQUEST定义AFTER_REQUEST(Response)：如果没有hasattr(g，&#34；profiler&#34；)：返回响应g.profiler。Stop()output_html=g.profiler。Output_html()返回make_response(Output_Html)。</p><p>这将检查每个请求上的？Profile查询参数，如果找到，则开始分析。在分析器运行的每个请求之后，它创建html输出并返回该输出，而不是实际的响应。</p><p>我希望有更多的方式使用PyInstrument进行分析--例如其他Web框架。鼓励使用PRS！</p><p>PyInstrument是一个统计分析器-它不会跟踪您的程序进行的每个函数调用。取而代之的是，它每1ms记录一次呼叫堆栈。</p><p>与其他分析器相比，这提供了一些优势。首先，统计分析器比跟踪分析器开销低得多。</p><p>█0.33s。</p><p>█0.43s。</p><p>██0.61s</p><p>██...██6.79s。</p><p>但低开销也很重要，因为它会扭曲结果。当使用跟踪探查器时，进行大量Python函数调用的代码会大量调用探查器，从而使其速度变慢。这会扭曲结果，并可能导致您优化程序的错误部分！</p><p>标准的Python分析器配置文件和cProfile向您显示一个函数列表，按每个函数花费的时间排序。这很好，但是很难解释为什么调用这些函数。了解调用这些函数的原因以及涉及到用户代码的哪些部分会更有帮助。</p><p>例如，假设我想弄清楚为什么Django中的Web请求速度很慢。如果我使用cProfile，我可能会得到这样的结果：</p><p>151940个函数调用(147672个基元调用)，按以下顺序排序：累计时间n调用总时间每次调用累计时间每次调用文件名：lineno(函数)1 0.000 0.000 1.696 1.696配置文件：0(&lt；代码对象&lt；模块&gt；位于0x1053d6a30，文件&#34；./Manage.py&#34；，行2&gt；)1 0.001 0.001 1.693 1.693 manage.py：2(&lt；模块&gt；)1 0.000 0.000 1.586 1.586__init__.py：394(EXECUTE_FROM_COMMAND_LINE)1 0.000 0.000 1.586 1.586__INIT__.py：350(执行)1 0.000 0.000 1.142 1.142__INIT__.py：254(获取命令)430.013 0.000 1.124 0.026__INIT__.py：1(&lt；模块&&gt;；)0.008 0.000 0.000 1.062 0.003 re.py：226(_COMPILE)158 0.005 0.000 1.048 0.007 SRE_COMPILLE.py：496(编译)1 0.001 0.001 1.0421.042__init__.py：78(Get_Commands)1530.001 0.000 1.0360.007re.py：188(编译)106/1020.000.000 1.0300.010_init_.py：52(_。_getattr__)1 0.000 0.000 1.029 1.029__init__.py：31(_Setup)1 0.000 0.000 1.021 1.021__init__.py：57(_CONFIGURE_LOGGING)2 0.002 0.001 1.011 0.505log.py：1(&lt；模块&gt；)。</p><p>PyInstrument记录整个堆栈，因此跟踪昂贵的呼叫要方便得多。默认情况下，它还隐藏库框架，让您专注于影响性能的应用程序/模块。</p><p>_._/_/记录：14：53：35样本：13/_//_/\/_/&#39；/持续时间：3.131 CPU时间：0.195/_/v3.0.0b3程序：示例/django_example/manage.py runserver--无线程--noreload3.131&lt；模块&gt；Py：2└─3.118 EXECUTE_FROM_COMMAND_LINE Django/CORE/MANAGEMENT/__INIT__.py：378[473帧隐藏]Django，socketserver，选择器，wsgi...。2.836选择选择器.py：365 0.126_GET_RESPONSE Django/CORE/Handler/base.py：96└─0.126 HELLO_WORLD Django_Example/Views.py：4。</p><p>PyInstrument使用挂钟时间记录持续时间。当您正在编写下载数据、读取文件和与数据库对话的程序时，所有这些时间都包含在pyInstrument跟踪的时间中。</p><p>这在调试性能问题时非常重要，因为Python经常被用作其他服务之间的粘合剂语言。问题可能不在您的程序中，但您应该仍然能够找到程序运行缓慢的原因。</p><p>PyInstrument每1ms中断一次程序，并在该点记录整个堆栈。它使用C扩展和PyEval_SetProfile来实现这一点，但是每1ms只读取一次读数。有关更多信息，请查看此博客帖子。</p><p>你可能会对组成一份报告的样本如此之少感到惊讶，但别担心，这不会降低准确性。默认间隔1ms是记录堆栈帧的下限，但如果在单个函数调用中花费的时间较长，则会在该调用结束时记录。因此，这些样本实际上被捆绑在一起，并在最后录制下来。</p><p>添加了在C函数中跟踪时间的功能。次要注意-由于Python记录帧的方式有限制，PyInstrument将C函数记录为叶子函数所花费的时间。Python-&gt；C-&gt；Python记录为Python-&gt；Python，但Python-&gt；Python-&gt；C的属性将正确。(#103)。</p><p>在Django中间件上添加了PYINSTRUMENT_SHOW_CALLBACK选项，以添加显示配置文件的条件(可用于在实时服务器上运行pyInstrument！)。</p><p>修复了Django中间件中由于Unicode错误而无法写入文件的错误。</p><p>修复了Windows上Django中间件的错误，在该错误中，由于我们试图在配置文件路径中放置非法字符&#39；？&#39；，所以配置文件将失败。(#66)。</p><p>添加--show和--show-regex选项，以标记要显示的某些文件。这有助于分析特定模块内部的情况，而不是隐藏。例如，pyInstrument--show&#39；*/symmy/*&39；script.py。</p><p>PyInstrument现在将通过您默认使用的库隐藏跟踪。因此，它不会向您展示通过外部内容(如urllib)内部的大量框架，而是让您专注于您的代码。</p><p>&#39；条目&#39；会显示隐藏组的框架，这样您就可以知道问题出在哪个呼叫上。</p><p>组中非常慢的帧也会显示出来，例如套接字上的Read调用。</p><p>其他指标显示在跟踪顶部-时间戳、样本数、持续时间、CPU时间。</p><p>隐藏代码由代码文件路径上的--HIDE或--HIDE-regex选项控制。</p><p>--HIDE=expr glob样式模式，匹配要隐藏其帧的文件路径。默认为&#39；*/lib/*&#39；。--Hide-regex=与要隐藏其帧的文件路径匹配的REGEX regex。如果--HIDE没有给予足够的控制，那就有用了。</p><p>因为现在有几个呈现选项，所以您可以使用--load-prev-pyInstrument加载前一个性能分析会话来保存最后10个会话。</p><p>(内部)当记录时间线时，框架树现在完全是线性的，允许创建超精确的框架图。</p><p>(内部)HTML渲染器已被重写为Vue.js应用程序。所有控制台的改进也适用于HTML输出，另外它还具有交互性。</p><p>大重构！录音机已被移除。帧录制现在是Profiler对象的内部。这意味着帧对象更加通用，这为……铺平了道路。</p><p>处理器！这些是改变树以雕刻输出的函数，渲染器使用它们将输出过滤成正确的形式。现在，分析器不是时间聚合记录器，而是只使用时间线样式的记录(这无论如何开销更低)，并且聚合是作为一个处理步骤来完成的。</p><p>这样做的结果是，现在可以更容易地更改树来过滤掉东西，并做一些更高级的事情，比如组合我们不关心的框架。在v3.0中还会有更多使用此功能的功能！</p><p>Importlib框架被移除-您将根本看不到它们。他们的孩子被保留下来，所以进口只是透明的。</p><p>当运行pyInstrument--html并且您没有将输出通过管道传输到文件时，pyInstrument会将控制台输出写入一个临时文件，然后在浏览器中打开该文件。</p><p>添加了对通过命令行使用pyInstrument运行模块的支持。新的语法是-m标志，例如pyInstrument-m模块名称！普瑞。</p><p>修复由于多线程使用pyInstrument而导致的崩溃。修复程序位于C扩展中，位于https://github.com/joerick/pyinstrument_cext/pull/3</p><p>修复了用于分析堆栈上有大量帧的程序时的最大递归错误。</p><p>PyInstrument使用一种新的剖析模式。Pyinterument不使用信号，而是使用基于PyEval_SetProfile的新统计分析器。这意味着在使用PyInstrument时不再有主线程限制，不再有IO错误，也不需要单独的More&#39；setprofile&#39；模式！</p><p>渲染器。用户可以通过Profiler.output()上的renender参数或命令行上的--renderer参数自定义PyInstrument以使用替代渲染器。</p><p>录音机。为了支持PyInstrument的其他使用案例(例如火焰图表)，PyInstrument现在有一个时间线记录器模式。此模式以线性方式记录捕获的帧，因此可以在atimeline上查看程序执行情况。</p><p>PyInstrument命令。现在可以通过运行$pyInstrument script.py从Shell分析python脚本。这现在等同于python-m pyInstrument。谢谢@asmeurer！</p><p>向Django界面添加了PYINSTRUMENT_PROFILE_DIR选项，该选项会将所有请求的配置文件记录到指定文件夹中的文件。用于分析API调用。</p><p>要从git存储库或源代码签出运行pyInstrument，必须先运行。</p><p>这将编译HTML输出所需的Javascript代码。您将需要安装节点(管道安装不需要节点，因为控制盘中已经预置了Javascript)。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://github.com/joerick/pyinstrument">https://github.com/joerick/pyinstrument</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/python/">#python</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/统计/">#统计</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1030062.html"><img src="http://img2.diglog.com/img/2020/10/thumb_febd33768c5e817e34a81b0bd750e291.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030062.html">CPython提速实施方案</a></div><span class="my_story_list_date">2020-10-20 22:46</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030052.html"><img src="http://img2.diglog.com/img/2020/10/thumb_8e77f040d37fd76761e6b57f203fb02c.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030052.html">Python中的模式匹配</a></div><span class="my_story_list_date">2020-10-20 22:41</span></div><div class="col-sm"><div><a target="_blank" href="/story/1029860.html"><img src="http://img2.diglog.com/img/2020/10/thumb_ef60e0e0abc843c004ccaf10b95ea086.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1029860.html">为Ruby、Python、Elixir、Go等提供更好的Git diff输出</a></div><span class="my_story_list_date">2020-10-20 1:43</span></div><div class="col-sm"><div><a target="_blank" href="/story/1029821.html"><img src="http://img2.diglog.com/img/2020/10/thumb_7f70d9555707141de03eda7009b9ad08.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1029821.html">剧情片巨蟒奖</a></div><span class="my_story_list_date">2020-10-19 23:21</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>