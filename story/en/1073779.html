<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>SpiceDB中的在线模式迁移Online Schema Migrations in SpiceDB</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Online Schema Migrations in SpiceDB<br/>SpiceDB中的在线模式迁移</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2022-02-17 09:45:08</div><div class="page_narrow text-break page_content"><p>Data migrations are a fact of life for any application. Requirements change, features are added or removed, services are merged together or split apart. As the application evolves, so too must the data behind it. In this regard, the permissions information you store in  SpiceDB is no different from any other data in any other database.</p><p>对于任何应用程序来说，数据迁移都是事实。需求变更、功能添加或删除、服务合并或拆分。随着应用程序的发展，其背后的数据也必须随之发展。在这方面，存储在SpiceDB中的权限信息与任何其他数据库中的任何其他数据没有区别。</p><p> If you’re unfamiliar with online migration strategies in general, there are a few  good resources online that cover the general topic; we’re going to focus just on SpiceDB and how to perform migrations against the data and schema it holds.</p><p>如果你不熟悉一般的在线迁移策略，那么网上有一些很好的资源涵盖了一般的主题；我们将只关注SpiceDB，以及如何针对它所包含的数据和模式执行迁移。</p><p>  But first, let’s highlight a couple of scenarios where SpiceDB shines because  no migrations are needed:</p><p>但首先，让我们重点介绍一下SpiceDB因无需迁移而大放异彩的几个场景：</p><p>  If the services that talk to SpiceDB are being refactored (i.e. a monolith is being split into a service oriented architecture), there is likely nothing you need to do with SpiceDB.</p><p>如果与SpiceDB对话的服务正在被重构（即，一个整体正在被拆分为一个面向服务的体系结构），那么您可能不需要对SpiceDB做任何事情。</p><p>  Because SpiceDB runs as a separate service, any new services that talk to it just need to connect and make the necessary queries. There’s peace of mind knowing that authorization (typically a challenging part of changing architecture at this layer) won’t be a burden or a bottleneck.</p><p>因为SpiceDB是作为一个独立的服务运行的，所以任何与之通信的新服务只需要连接并进行必要的查询。可以放心的是，授权（通常是在这一层改变体系结构的一个挑战部分）不会成为负担或瓶颈。</p><p>  With SpiceDB, you  write relationships, but you  check permissions. Permissions are computed over the relationships that are already stored. This means that any changes you wish to make to how permissions are computed can be done without any migrations at all: simply update the schema.</p><p>使用SpiceDB，您可以编写关系，但可以检查权限。权限是针对已存储的关系计算的。这意味着，您希望对权限计算方式所做的任何更改都可以在不进行任何迁移的情况下完成：只需更新模式即可。</p><p>  definition user {} definition organization { relation administrator : user relation direct_member : user permission member  = direct_member}</p><p>定义用户{}定义组织{关系管理员：用户关系直接成员：用户权限成员=直接成员}</p><p> You can include administrators as members and create a new “admin” permission without any migrations at all: definition user {} definition organization { relation administrator : user relation direct_member : user  permission admin  = administrator  permission member  = direct_member  + administrator}</p><p>您可以将管理员包括为成员并创建新的“管理员”权限，而无需任何迁移：定义用户{}定义组织{关系管理员：用户关系直接_成员：用户权限管理员=管理员权限成员=直接_成员+管理员}</p><p>  There will always be cases where a migration is required, and when that happens you will need to plan out the migration steps. Here are some patterns to help with your online migration plan:</p><p>总会有需要迁移的情况，当这种情况发生时，您需要规划迁移步骤。以下是一些有助于在线迁移计划的模式：</p><p>  All Schema writes are  fully consistent. This means that any relationship writes that occur after the schema has been written will be evaluated under that new schema.</p><p>所有模式写入都是完全一致的。这意味着在写入模式后发生的任何关系写入都将在该新模式下进行评估。</p><p> Any relationship  reads, however, will use the revision of the schema that matches the revision of the read request.This ensures that checks evaluate with the correct schema to avoid  new enemy problems.</p><p>但是，任何关系读取都将使用与读取请求版本匹配的模式版本。这确保检查使用正确的模式进行评估，以避免新的敌人问题。</p><p>   A relation, permission, or object definition can only be removed from an existing schema if there are no relationships referencing it.</p><p>只有在没有引用关系的情况下，才能从现有架构中删除关系、权限或对象定义。</p><p> With these in mind, all you need to get started is an appropriate  API client.</p><p>记住这些，你只需要开始使用一个合适的API客户端。</p><p>  The following examples will assume this is the schema we’re starting out with:</p><p>以下示例将假设这是我们开始使用的模式：</p><p> definition user {}  definition document { relation writer : user relation reader : user permission edit  = writer permission view  = reader  + edit}</p><p>定义用户{}定义文档{关系编写器：用户关系读取器：用户权限编辑=编写器权限视图=读取器+编辑}</p><p>   definition user {}  definition document { relation writer : user relation reader : user  relation owner : user  -- step 1  permission edit  = writer  + owner  -- step 4 permission view  = reader  + edit}</p><p>定义用户{}定义文档{关系编写器：用户关系读取器：用户关系所有者：用户--步骤1权限编辑=编写器+所有者--步骤4权限视图=读取器+编辑}</p><p> Any new documents that are created should include the new  owner relation when updating spicedb.</p><p>在更新spicedb时，创建的任何新文档都应包含新的所有者关系。</p><p> Backfill the relationship as if it had been there from the beginning.In this case, we look up who created the document in the application’s database, and write the owner relation with  authzed.api.v1.WriteRelationships.If this is done with  TOUCH then it won’t conflict with the relationships written in the previous step.</p><p>重新建立关系，就好像它从一开始就存在一样。在本例中，我们在应用程序的数据库中查找谁创建了文档，并用authzed编写所有者关系。应用程序编程接口。v1。写作关系。如果这是通过触摸完成的，那么它将不会与上一步中所写的关系冲突。</p><p> When the data has been backfilled, confirmed valid, and new data is being written, you can include the relation in other permission calculations and update the schema.It may be safe to go ahead and update the schema right away; the permission calculations will simply change as you backfill the relationships.</p><p>当数据已被回填、确认有效且正在写入新数据时，可以在其他权限计算中包含该关系，并更新架构。现在就开始更新模式可能是安全的；权限计算只会在回填关系时发生变化。</p><p>   1 definition user {} 2  3 definition document { 4 relation writer : user  5  -- step 5: removed `relation reader: user` 6 7 permission edit  = writer  8 permission view  = edit  -- step 1: removed `reader +` 9}</p><p>1定义用户{2 3定义文档{4关系编写器：用户5--步骤5:删除`关系读取器：用户`6 7权限编辑=编写器8权限视图=编辑--步骤1:删除`读取器+`9}</p><p> If there are any issues discovered via testing at this point, the data is all still there and permissions can be restored by reverting the change to the schema.</p><p>如果此时通过测试发现了任何问题，数据仍然存在，可以通过将更改恢复到架构来恢复权限。</p><p> You can stay at step 2 for as long as desired, in production, to retain your ability to roll back the change.</p><p>在生产过程中，您可以根据需要在第2步停留多长时间，以保持回滚更改的能力。</p><p>   definition user {}   definition group {  -- step 1  relation member : user  -- step 1 }  -- step 1  definition document {  relation writer : user  | group #member  -- step 4  relation reader : user  | group #member  -- step 4 permission edit  = writer permission view  = reader  + edit}</p><p>定义用户{}定义组{--步骤1关系成员：用户--步骤1}--步骤1定义文档{关系编写器：用户|组#成员--步骤4关系读取器：用户|组#成员--步骤4权限编辑=编写者权限视图=读取器+编辑}</p><p>     Now that we have worked through some examples, it’s clear that migrations in SpiceDB are no more challenging than migrations in a general purpose DBMS, and in some cases much simpler.</p><p>现在我们已经研究了一些示例，很明显，在SpiceDB中的迁移并不比在通用DBMS中的迁移更具挑战性，而且在某些情况下要简单得多。</p><p> But there is no reason to stop there!We’ve seen how SpiceDB’s focus on permission calculations makes a certain class of hard migration problems go away.We think that there are more ways we can simplify migrations in SpiceDB.If you’re interested in discussing those with us (or you have a question about your own migrations), why not drop by our  discord and have a chat?</p><p>但没有理由就此止步！我们已经看到了SpiceDB对权限计算的关注是如何消除某类硬迁移问题的。我们认为有更多的方法可以简化SpiceDB中的迁移。如果您有兴趣与我们讨论这些问题（或者您对自己的迁移有疑问），为什么不顺道拜访我们的discord并聊一聊呢？</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/模式/">#模式</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/schema/">#schema</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/关系/">#关系</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>