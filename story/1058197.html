<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>一个易于使用的MTP实现，为您的下一个嵌入式Linux项目实现 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">一个易于使用的MTP实现，为您的下一个嵌入式Linux项目实现 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-14 05:23:13</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/4/ace51f37e168525e136f3726df4f0fac.jpg"><img src="http://img2.diglog.com/img/2021/4/ace51f37e168525e136f3726df4f0fac.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>您是否知道您可以使用嵌入式设备上的最小依赖性运行许可的MTP实现？这里＆＃39;关于如何在Rock PI 4上轻松运行CMTP响应器的逐步指南或配备UDC的任何其他板。</p><p>  重新回顾：在本系列的第1部分中，我将您介绍到USB小工具的概念，它们的ConfigFS组合界面，可用的OpenSource工具和基本系统集成。在第2部分，我撰写了一个特定的USB小工具函数 -  FunctionFS  - 以及与Systemd的集成。然后我介绍了CMTP响应者，允许许可的MTP响应者实现，并显示了如何使用Dummy_hcd驱动程序在PC上玩它。它在后一篇文章中，我向您承诺在真正的硬件上运行CMTP响应者。您也可以在ELC 2019和Linux Piter 2019上看我谈论USB小工具。</p><p>      在这篇文章中，我赢得了＆＃39; t详细介绍了如何撰写小工具或如何使用systemd集成该进程。第一个段落包含足够的链接供您遵循，如果您尚未完成，我会鼓励您进行。我将谈论的是如何构建在真正硬件上运行所需的组件。</p><p>  就硬件而言，您可以在任何ARM板上运行您的小工具，提供一个UDC（OTG）芯片，该芯片被连接到电路板上的实际USB连接器（所以RPI零将使用此功能，但RPI不会工作） 。它绝对超出了这篇文章的范围，以谈论所有可能的硬件。我正在使用的硬件是RockPI 4型号B，但您可以轻松调整对您的特定板的说明，我将标记特定于硬件的所有位置。</p><p>      系统单位和小工具方案显然是与平台无关的。所以让＆＃39; s一步一步地通过构建平台依赖的碎片。</p><p>    首先，您可以在目标板上自然构建。它肯定会花更多的时间而不是交叉编译，而是一个可行的选择。对于自然建立建立又有另一个选项，您可以在仿真环境中编译在PC上（不需要全系统仿真，只需一个目标rootfs和内部的静态qemu即可加入并建立正在自然地建造）。在任何一种情况下，该过程应该看起来像x86上的x86的构建，并且您需要在电路板上安装相同类型的软件包（或在您的rootfs中）。但是，如果您期望您将经常重建CMTP响应者，并且交叉编译它绝对值得最初的努力，这篇文章的其余部分致力于这种后一种方法。</p><p>    我们想要实现的是建立一块软件，以便它在不同类型的机器上运行而不是用于建筑的机器。此过程称为交叉编译。无论我们是否需要使用Autotools样式（LibusBGX），CMake样式（GT，CMTP-Responder）或者说，Meson样式，一般概念都是一样的。 </p><p>首先需要一个交叉编译器。它是一个编译器，它本身是一个用于在构建主机上运行的程序，并为目标主机生成二进制文件。</p><p>  除非你正在编译尤。内核，你不能只是一个裸露的编译器。虽然它正在做它的工作，但它需要咨询几个文件，例如，库标题文件，它应该与目标主机中的文件匹配，而不是构建主机中的文件。这就是为什么你需要Sysroot  - 更多关于下面的Sysroot。有些库将其文件安装在已知位置，但Linux发行版可以选择其自定义位置。这就是为什么一个名为pkg-config的程序。您将在那里放入pkg-config调用而不是硬编码库文件位置。请注意，PKG-Config本身与您的分发和＃39; S包装系统（Deb，RPM等）无关。当然，您的开发库（和PKG-Config本身！）可以由您的分发包提供，但安装后，在编译程序时查找库的方式是使用PKG-CONFIG  - 而且无论如何，您都这样做您正在使用的分发（或者如果您根本不使用任何分发，但是从源代码编译整个系统）。</p><p>      您使用Sysroot使您的交叉编译器知道在哪里寻找特定于目标的某些文件。 Sysroot需要镜像rootfs＆＃39; s图书馆和标题。如果您是，您可以在您的实际目标rootfs上点点。将其安装在目标板上的NFS上。</p><p>  您使用pkg_config_path，以便pkg-config知道在哪里寻找特定于目标的文件。</p><p>  这些先决条件终于让＆＃39;终于实际建立了我们的东西。我假设基于Debian的系统和目标。如果您在所有使用不同的分发或无分发时调整用于安装所需包的命令。</p><p>    ＃相应地调整Sysroot$ Export Sysroot = / home / ap / collabora / rootfs / arm64 / debian-testing$ sudo apt-get安装pkg-config（在sysroot / targetro rootfs中）$ sudo apt-get安装libconfig-dev（在sysroot / targetro rootfs中）$ git clone https://github.com/libusbgx/libusbgx.git$ cd libusbgx.$ autoreconf -i.#USR / lib下的子目录是特定于平台的，所以--host =$ pkg_config_path = $ sysroot / usr / lib / aarch64-linux-gnu / pkgconfig ./configure --host = aarch64-linux-gnu --prefix = / usr --with-sysroot = $ sysroot$ make cflags =＆＃34;  -  sysroot = $ sysroot＆＃34;$ sudo make destdir = $ sysroot安装</p><p>    $ sudo apt-get安装asciidoc-base$ sudo apt-get安装libglib2.0-dev$ sudo apt-get安装libsystemd-dev$ git clone https://github.com/kopasiak/gt.git$ cd gt / source＃使用以下内容创建工具链文件#cmake_system_processor，cmake_c_compiler和pkg_config_libdir是特定于平台的$ cat aarch64-toolchain.txtset（cmake_system_name linux）SET（CMake_System_Processor AARCH64）＃相应调整SET（CMake_sysroot / home / ap / collabora / rootfs / arm64 / debian-testing）SET（CMake_C_COMPILER AARCH64-LINUX-GNU-GCC）set（env {pkg_config_libdir}＆＃34; $ {cmake_sysroot} / usr / lib / pkgconfig：$ {cmake_sysroot} / usr / lib / aarch64-linux-gnu / pkgconfig＆＃34;）`）`set（env {pkg_config_sysroot_dir} $ {cmake_sysroot}）set（cmake_find_root_path_mode_program never）SET（cmake_find_root_path_mode_library）set（cmake_find_root_path_mode_include）set（cmake_find_root_path_mode_package）$ cmake -dcmake_install_prefix = $ sysroot -dcmake_runtime_prefix = / -dcmake_toolchain_file = aarch64-toolchain.txt$ make$ sudo make安装 </p><p>在我们进入交叉编译CMTP响应程序之前，您必须了解它需要的描述符和字符串BLOB。它们可以以类似于本系列之前的一个博客文章中所示的方式手工制作。好消息是你不需要用手来做，因为CMTP响应者的构建系统也可以为您做到这一点。但是，目前此功能仅适用于当本地构建时，因此为了构建描述符和字符串Blobs的唯一目的，您将在目标板上进行本地编译。当Cross Compling此仍然有用时，您需要调用本机和交叉构建。 ＆＃34;副作用＆＃34;本机构建将是我们的描述符百波，依赖于目标平台和Don＆＃39;每次编译CMTP响应者时需要重新构建，然后我们删除其他所有东西并运行交叉构建。</p><p>  $ git clone https://github.com/cmtp-responder/cmtp-responder.git$ CD CMTP响应者＃自然地构建以获取描述符和字符串BLOB$ cmake -dbuild_descriptors =上。$ ls -l descs strs-rw-r  -  r-- 1 ap ap 80 sty 5 13:08 descs-rw-r  -  r-- 1 ap 32 sty 5 13:08 strs＃移动描述符和字符串BLOB到安全的地方$ mv descs ..$ mv strs ..＃将工作目录恢复到新状态$ rm -rf *$ git重置 - 哈达头＃还原描述符和字符串BLOB$ mv ../descs。$ mv ../strs。＃现在做十字架$ cp ../gt/aarch64-toolchain.txt。$ cmake -dcmake_toolchain_file = aarch64-toolchain.txt$ make$ sudo make destdir = $ sysroot安装</p><p>    有许多在线来源描述了这个主题，请使用您喜欢的搜索引擎查找说明。对于.config：</p><p>  config_configfs_fs = y＃configfs支持config_usb = y＃usb支持config_usb_gadget = y＃usb小工具框架config_usb_configfs = y＃与configfs编写USB小工具config_usb_configfs_f_fs = y #mementfs与configfs创建USB小工具的组件</p><p>  最重要的是，您需要启用您的UDC，这是特定于平台的。对于Rockpi 4我不得不说：</p><p>          ＃在构建主机上，而在CMTP-Responder目录中$ sudo mkdir $ sysroot / etc / gt / templates$ sudo cp systemd / mtp-ffs.scheme $ sysroot / etc / gt / templates$ sudo cp systemd / *。套接字$ sysroot / etc / systemd / system$ sudo cp systemd / *。服务$ sysroot / etc / systemd / system$ sudo cp systemd / *。安装$ sysroot / etc / systemd / system</p><p>  ＃在目标上$ sudo systemctl启用usb-gadget.service$ sudo systemctl启用run-ffs_mtp.mount$ sudo systemctl启用ffs.socket </p><p>重新启动后，它应显示为USB主机看到的MTP设备。 享受！  请勾选此框以确认您已阅读并接受有关您个人数据的集合/存储和使用情况的隐私通知条款：* </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.collabora.com/news-and-blog/blog/2021/04/13/an-easy-mtp-implementation-for-your-next-embedded-linux-project/">https://www.collabora.com/news-and-blog/blog/2021/04/13/an-easy-mtp-implementation-for-your-next-embedded-linux-project/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/实现/">#实现</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/mtp/">#mtp</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/sysroot/">#sysroot</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1057578.html"><img src="http://img2.diglog.com/img/2021/4/thumb_080e3b0db1f05ffd1aed9f27aaae1e92.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1057578.html">向强制更新失去了价值72小时的研究数据 </a></div><span class="my_story_list_date">2021-4-11 9:13</span></div><div class="col-sm"><div><a target="_blank" href="/story/1057567.html"><img src="http://img2.diglog.com/img/2021/4/thumb_b263b3ebef6877d1dc922f7b9b37b587.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1057567.html">对拱门Linux的新导游安装程序的反应 </a></div><span class="my_story_list_date">2021-4-11 7:12</span></div><div class="col-sm"><div><a target="_blank" href="/story/1057408.html"><img src="http://img2.diglog.com/img/2021/4/thumb_83109f13ae02498214c9d2844e4458d4.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1057408.html">Apple M1硬件支持合并为Linux 5.13 </a></div><span class="my_story_list_date">2021-4-10 6:25</span></div><div class="col-sm"><div><a target="_blank" href="/story/1057375.html"><img src="http://img2.diglog.com/img/2021/4/thumb_f304e711065a4d0665c18060845163cf.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1057375.html">Linux BPF VM中的漏洞允许任何本地用户运行内核级代码 </a></div><span class="my_story_list_date">2021-4-10 4:38</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>