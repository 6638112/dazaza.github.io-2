<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>操作系统中的复杂性</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">操作系统中的复杂性</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-31 06:24:51</div><div class="page_narrow text-break page_content"><p>Over the last years I’ve been working on very different operatingsystems. Operating systems are usually incredibly complex beasts. Ithink there are mainly three drivers of this complexity. Surprisinglyenough, neither of these is having to deal with hardware.</p><p>在过去的几年里，我一直在研究非常不同的操作系统。操作系统通常是极其复杂的野兽。我认为这种复杂性主要有三个驱动因素。令人惊讶的是，这两个都不需要与硬件打交道。</p><p> The first one is resource  discovery, i.e. figuring out how thecomputer the OS is running on actually looks like. On x86, thisinvolves parsing countless bitfields, tables, executing byte codeprovided by the firmware, probing individual features, etc. The mostpainful example of this I’ve seen so far is figuring out whichinterrupt a particular PCI interrupt line is routed to. It’s worth aset of posts, but until then, feel free to checkout  thisdescription. (If it’s down, it’salso cached by Google.)</p><p>第一个是资源发现，即弄清楚操作系统实际运行的计算机是什么样子。在x86上，这涉及到解析无数的位域、表、执行固件提供的字节代码、探测各个功能等等。到目前为止，我所见过的最痛苦的例子是找出特定的PCI中断行路由到哪个中断。这是值得一试的帖子，但在此之前，请随时查看这一描述。(如果它关闭了，它也会被谷歌缓存。)。</p><p> The second issue is  resource management. Essentially, how do youhand out and eventually reclaim all the resources you discovered. Forsome workloads performance matters here, so this code is usuallywritten with speed in mind.</p><p>第二个问题是资源管理。本质上，你如何分发并最终回收你发现的所有资源。对于某些工作负载来说，这里的性能很重要，因此在编写此代码时通常会考虑速度。</p><p> The third reason is that at compile time the  workload isunclear. So the kernel has to assume the worst. It must be ready tostart a couple of hundred VMs or create a thousand TCP sockets in ablink of an eye, because there is no way to know what’s going tohappen or what the actual requirements are.</p><p>第三个原因是在编译时工作负载不明确。所以内核必须做最坏的打算。它必须准备好在转眼间启动几百个虚拟机或创建一千个TCP套接字，因为无法知道将要发生什么或实际需求是什么。</p><p> A fun exercise is to checkout the  KVM code for creatingVMs. Tryto follow the codeto where the actual VM is created in hardware.  Spoiler: There isnone. It’s all figuring out what the platform can do and then settingup a bunch of spinlock, mutexes, lists, arrays, structs, …</p><p>一个有趣的练习是签出用于创建VM的KVM代码。尝试按照代码在硬件中创建实际VM的位置。剧透：没有。这一切都是弄清楚平台可以做什么，然后设置一系列自旋锁、互斥锁、列表、数组、结构、…。</p><p> I don’t want to pick on KVM in particular. I think it’s pretty ok asfar as Linux kernel code goes. Operating System kernel code is mostlylike this: A lot of really mind numbing platform discovery andresource management code written for speed assuming the worst caserequirements in a language that doesn’t do parsing, resourcemanagement or concurrency well (among other things).</p><p>我不想特别针对KVM。我认为就Linux内核代码而言，这是相当不错的。操作系统内核代码主要是这样的：许多真正令人头晕目眩的平台发现和资源管理代码是为速度而编写的，假设最坏的情况下使用的是一种不能很好地进行解析、资源管理或并发的语言(以及其他方面)。</p><p> People take this all for granted. But when I look around, I see manysystems that don’t need this complexity and where it is only a safetyand security burden. Consider most appliance-type products, e.g. aWi-Fi router. Or a system that runs one service on a cloud VM. Youknow everything in advance!</p><p>人们认为这一切都是理所当然的。但当我环顾四周时，我看到许多系统不需要这种复杂性，它只是一个安全和安保负担。以大多数家用电器类型的产品为例，例如AWI-Fi路由器。或者在云VM上运行一项服务的系统。你事先就知道一切了！</p><p> If you read until this point, you are probably asking yourself, whereI am going with this. If you think  separationkernel, you areright. My rough plan to write a couple of more posts to flesh out theidea of doing all the complicated OS parts at compile time and howthis results in an incredibly simple, secure, and efficient system atruntime. There will be  RISC-V, Haskell,  Dhall,and  Rust content.</p><p>如果你读到这一点，你可能会问自己，我要说的是什么。如果你认为分离核心，那你是对的。我的粗略计划是再写几篇文章，充实在编译时完成所有复杂操作系统部分的想法，以及这如何在运行时产生一个令人难以置信的简单、安全和高效的系统。将有RISC-V、Haskell、DHall和Rust内容。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://x86.lol/generic/2020/10/30/complexity-in-operating-systems.html">https://x86.lol/generic/2020/10/30/complexity-in-operating-systems.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/操作系统/">#操作系统</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/operating/">#operating</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/代码/">#代码</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1031674.html"><img src="http://img2.diglog.com/img/2020/10/thumb_aa894409fa807c74d89e9d9ad6dea94c.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031674.html">将MacOS作为虚拟化操作系统运行的Linux PC比hackinstosh更快</a></div><span class="my_story_list_date">2020-10-28 9:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1031071.html"><img src="http://img2.diglog.com/img/2020/10/thumb_c56b42a97bb7499813c376e3e11a86e7.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031071.html">MuditaOS：一个开源的e-ink移动操作系统</a></div><span class="my_story_list_date">2020-10-25 16:14</span></div><div class="col-sm"><div><a target="_blank" href="/story/1029192.html"><img src="http://img2.diglog.com/img/2020/10/thumb_e52669aa0dd5e737b281e50437ffa6bf.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1029192.html">Chromebook寿命缓慢上升：一些机型获得9年的操作系统更新</a></div><span class="my_story_list_date">2020-10-16 19:45</span></div><div class="col-sm"><div><a target="_blank" href="/story/1029043.html"><img src="http://img2.diglog.com/img/2020/10/thumb_d82f6d51c50938e047f329bb6f89368c.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1029043.html">在使用Windows 10年后，我转而使用Linux</a></div><span class="my_story_list_date">2020-10-16 0:6</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>