<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我在生产中删除了一个数据库，并且没有备份</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">我在生产中删除了一个数据库，并且没有备份</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-04 03:16:08</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/11/e4f045655c9a7854741da7e52f88d704.png"><img src="http://img2.diglog.com/img/2020/11/e4f045655c9a7854741da7e52f88d704.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>There comes a moment in every developer’s life when they must face this inevitable situation. Really, it’s a rite of passage for our community.</p><p>在每个开发人员的生命中都会有这样一个时刻，他们必须面对这种不可避免的情况。真的，这是我们社区的必经之路。</p><p>  I’m writing this short post to chronicle the events that lead to this dreadful accident along with a few important lessons to learn from this fiasco.</p><p>我写这篇简短的帖子是为了记录导致这起可怕事故的事件，以及从这场惨败中吸取的一些重要教训。</p><p> Before we begin, a quick overview of my infrastructure. The infrastructure at WorkIndia is hosted on AWS and some of the terms reference to AWS Services, but this could happen to anyone hosting databases on virtual machines. This particular microservice was hosted on a  single virtual machine running the API, a PostgreSQL, and a MongoDB server using Docker containers.</p><p>在我们开始之前，先快速概述一下我的基础架构。WorkIndia的基础设施托管在AWS上，其中一些术语指的是AWS服务，但这可能发生在任何在虚拟机上托管数据库的人身上。这个特定的微服务托管在运行API的单个虚拟机、PostgreSQL和使用Docker容器的MongoDB服务器上。</p><p>    I try to SSH into the machine but due to unnaturally high CPU load, my connection is unsuccessful. At this point the usual solution is to reboot or stop/start the instance from the AWS Console panel.  BIG MISTAKE!</p><p>我尝试通过SSH登录机器，但由于CPU负载异常高，我的连接不成功。此时，通常的解决方案是从AWS控制台面板重新启动或停止/启动实例。大错特错了！</p><p>    I stop the instance and give it a few minutes to boot a new machine and start the docker containers.</p><p>我停止该实例，并给它几分钟时间来引导一台新机器并启动码头容器。</p><p>     Sudden realisation that the service has been configured behind an  Auto Scaling Group (ASG). When I stopped the original instance, the ASG couldn’t find a healthy machine and it created a new instance from a very old launch template.</p><p>突然意识到服务已在Auto Scaling Group(ASG)后面配置。当我停止原来的实例时，ASG找不到健康的机器，它从一个非常旧的启动模板创建了一个新实例。</p><p> Its okay, at least I have the original instance and all its data. I’ll just change the database host settings in the new machine.</p><p>没关系，至少我有原始实例和所有数据。我只需更改新机器中的数据库主机设置。</p><p>   Once I stopped the instance, the ASG determined the instance was unhealthy and proceeded to permanently terminate it. This is the default behaviour of an ASG but an instance can be saved from such a fate using a  termination policy.</p><p>一旦我停止了该实例，ASG就确定该实例不健康，并继续永久终止它。这是ASG的默认行为，但是可以使用终止策略将实例从这种命运中拯救出来。</p><p>     I call in reinforcements, but its too late. The damage is done. All data on both the PostgreSQL and MongoDB was lost.</p><p>我叫了增援部队，但太晚了。损害已经造成了。PostgreSQL和MongoDB上的所有数据都丢失了。</p><p>  My trusted collegues immediately got to work and devised a plan to regenerate most of the lost data using logic from another service. It took them not more than a day, but thankfully the data was recovered,  more or less.</p><p>我信任的同事们立即开始工作，并设计了一个计划，使用来自另一项服务的逻辑重新生成大部分丢失的数据。他们花了不到一天的时间，但谢天谢地，数据或多或少得到了恢复。</p><p>  Infrastrucutre is an error prone business. As an infrastructure engineer, I feel more of my energy is spent on creating fail-safes than actually trying to create a perfectly robust application. Things will fail, its our job to handle the failures gracefully.</p><p>基础设施是一项容易出错的业务。作为一名基础设施工程师，我觉得我更多的精力花在创建故障保险上，而不是真正尝试创建一个完全健壮的应用程序。事情会失败的，我们的工作就是优雅地处理失败。</p><p>   At our scale, it is unwise to mix stateless applications like API servers with stateful applications like PostgreSQL and MongoDB which have storage requirements. Stateless and stateful applications play by different rules and therefore need to have vastly different failure strategies.</p><p>在我们的规模中，将API服务器等无状态应用程序与PostgreSQL和MongoDB等有状态应用程序混合使用是不明智的，这些应用程序有存储需求。无状态应用程序和有状态应用程序遵循不同的规则，因此需要使用截然不同的故障策略。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://medium.com/workindia-in/i-deleted-a-database-in-production-be78f1211b93">https://medium.com/workindia-in/i-deleted-a-database-in-production-be78f1211b93</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/数据库/">#数据库</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/database/">#database</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1032609.html"><img src="http://img2.diglog.com/img/2020/11/thumb_19a28c5b29d5b5f854cfbaa35e26f1a4.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032609.html">Google Sheets作为Web应用程序的数据库服务</a></div><span class="my_story_list_date">2020-11-1 20:26</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032515.html"><img src="http://img2.diglog.com/img/2020/11/thumb_69ef93455acd7d2aafcef4e201f773b2.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032515.html">我有99个问题，一个分布式数据库不是一个</a></div><span class="my_story_list_date">2020-11-1 1:2</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030615.html"><img src="http://img2.diglog.com/img/2020/10/thumb_69aa9f7bb5f5af253d1db30b98e61892.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030615.html">心理治疗中心数据库被黑，患者信息扣留赎金</a></div><span class="my_story_list_date">2020-10-23 1:53</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030433.html"><img src="http://img2.diglog.com/img/2020/10/thumb_2b56f915518fb33f55f689b3337502bc.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030433.html">你不需要区块链，你需要一个时间序列数据库</a></div><span class="my_story_list_date">2020-10-22 9:35</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>