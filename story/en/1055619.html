<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>零单击Apple麦克斯邮件中的漏洞 Zero click vulnerability in Apple’s macOS Mail</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Zero click vulnerability in Apple’s macOS Mail<br/>零单击Apple麦克斯邮件中的漏洞 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-02 04:40:36</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/4/93bc3ef6ddee6348cf3b18e61e4136bf.png"><img src="http://img2.diglog.com/img/2021/4/93bc3ef6ddee6348cf3b18e61e4136bf.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>I found a zero click vulnerability in Apple Mail, which allowed me to add or modify any arbitrary file inside Mail’s sandbox environment. This could lead to many bad things including unauthorized disclosure of sensitive information to a third party. An attacker can modify victim’s Mail configuration including mail redirects which enables takeover of victim’s other accounts via password resets. This vulnerability can be used to change the victim’s configuration so that victims will be propagating the attack to their correspondents in a worm-like fashion. Apple has patched this vulnerability in 2020–07.</p><p>我发现Apple Mail中的零单击漏洞，允许我在邮件的沙箱环境中添加或修改任意文件。这可能导致许多坏事，包括对第三方的敏感信息的未经授权披露。攻击者可以修改受害者的邮件配置，包括邮件重定向，可通过密码重置接管受害者的其他帐户。此漏洞可用于更改受害者的配置，使受害者将以蠕虫的方式将攻击传播到他们的信函。苹果在2020-07修补了这个漏洞。</p><p>  I was re  searching another vulnerability case (I’ll write about it a bit later) when I found this. I was reading Apple’s Bug Bounty categories and started to think what attack vectors there might be to trigger without user action. First idea obviously was Safari. I played a bit with Safari but couldn’t find any interesting leads. Next thing on my mind was Mail or iMessage. I focused on the Mail because of the hunch about the legacy features hiding in older codebase. I started to play around with Mail, sending test messages and attachments with the idea of trying to find an anomaly compared to normal email sending and receiving. I sent these test messages and followed Mail process syscalls to learn what is happening under the hood when email is received and here is what I found.</p><p>  我正在搜索另一个漏洞的情况（我发现这个问题时会稍后写一下）。我正在阅读Apple的Bug Bounty类别，并开始思考任何攻击向量可能会在没有用户动作的情况下触发什么。显然是野生动物园的第一个想法。我用safari玩了一点，但找不到有趣的领导。我心中的下一件事是邮件或局部。我专注于邮件是因为亨希关于悬浮在较旧的Codebase中的遗产功能。我开始用邮件播放，并在与正常电子邮件发送和接收中找到异常的想法，发送测试消息和附件。我发送了这些测试消息并遵循邮件过程Syscalls以了解在收到电子邮件时会在引擎盖下发生的情况，这是我找到的。</p><p>   Mail has a feature which enables it to automatically uncompress attachments which have been automatically compressed by another Mail user.</p><p>   邮件有一个功能，使其能够自动解压缩另一个邮件用户自动压缩的附件。</p><p> In the valid use case, if the user creates email and adds the folder as an attachment it will be automatically compressed with zip and x-mac-auto-archive=yes; is added to the MIME headers. When another Mail user receives this email, compressed attachment data is automatically uncompressed.</p><p> 在有效用例中，如果用户创建电子邮件并将文件夹添加为附件，则它将自动使用zip和x-mac-auto-archive自动压缩=是;添加到MIME标题中。当另一个邮件用户收到此电子邮件时，压缩附件数据会自动解压缩。</p><p> During my research I found that parts of the uncompressed data is not cleaned from temporary directory and that directory is not unique in context of Mail, this can be leveraged to get unauthorized write access to ~/Library/Mail and to $TMPDIR using symlinks inside of those zipped files.</p><p> 在我的研究期间，我发现没有从临时目录中清除未压缩数据的部分，并且该目录在邮件的上下文中不是唯一的，这可以利用来获取对〜/ library / mail的未经授权的写访问以及使用符号内部的$ tmpdir那些压缩文件。</p><p>  Attacker sends an email exploit which includes two zip files as attachments to the victim. Immediately when the user receives the email, Mail will parse it to find out any attachments with x-mac-auto-archive=yes header in place. Mail will uncompress those files automatically.</p><p>  攻击者发送电子邮件漏洞利用，其中包括两个zip文件作为对受害者的附件。当用户收到电子邮件时，请立即解析邮件以找出具有X-Mac-Auto-Archive = YES标题的任何附件。邮件将自动解压缩这些文件。</p><p>   First zip includes a symlink named Mail which points to victims “$HOME/Library/Mail” and file 1.txt . Zip gets uncompressed to “$TMPDIR/com.apple.mail/bom/”. Based on “filename=1.txt.zip” header, 1.txt gets copied to mail dir and everything works as expected. However cleanup is not done right way and the symlink is left in place.</p><p>   第一个zip包括一个名为mail的符号链接，它指向受害者“$ home / library / mail”和文件1.txt。 zip未压缩到“$ tmpdir / com.apple.mail / bom /”。基于“filename = 1.txt.zip”标题，1.txt被复制到邮件dir，一切都按预期工作。但是，清除不是正确的方式，符号链接留在适当位置。 </p><p>  Second attached zip includes the changes that you want to do to “$HOME/Library/Mail”. This will provide arbitrary file write permission to Library/Mail.</p><p>第二个附加的zip包括您要对“$ HOME / LIBRARY / MAIL”执行的更改。这将为库/邮件提供任意文件写入权限。</p><p> In my example case I wrote new Mail rules for the Mail application. With that you can add an auto forward rule to the victim’s Mail application.</p><p> 在我的示例案例中，我为邮件应用程序写了新的邮件规则。有了它可以向受害者的邮件应用程序添加自动转发规则。</p><p>    Files can be overwritten and that is what happens with the RulesActiveState.plist and the SyncedRules.plist files.</p><p>    文件可以覆盖，这就是CirousActivestate.Plist和SyncedRules.plist文件会发生什么。</p><p>   SyncedRules.plist contains a rule to match “AnyMessage” and rule in this PoC sets Mail application to play morse sound when any message is received.</p><p>   SyncedRules.Plist包含一个规则，以匹配“AnyMessage”，并在此PoC中设置邮件应用程序在收到任何消息时播放Morse声音。</p><p>  Instead of playing morse sound, this could be e.g forwarding rule to leak sensitive email data.</p><p>  这可能是泄漏敏感电子邮件数据的转发规则而不是播放Morse声音。</p><p>  This arbitrary write access allows the attacker to manipulate all of the files in $HOME/Library/Mail. As shown this will lead to exposure of the sensitive data to a third party through manipulating the Mail application’s configuration. One of the available configuration options is the user’s signature which could be used to make this vulnerability wormable.</p><p>  此任意写入访问允许攻击者操纵$ HOME / LIBRARY / MAIL中的所有文件。如图所示，通过操纵邮件应用程序的配置将曝光敏感数据曝光至第三方。其中一个可用的配置选项是用户的签名，可用于使此漏洞令人讨厌。</p><p> There is also a chance that this could lead to a remote code execution (RCE) vulnerability, but I didn’t go that far.</p><p> 还有可能导致远程代码执行（RCE）漏洞，但我没有走得太远。 </p><p>        Thanks to the fellow researchers who have shared their findings and knowledge, and thanks to Apple for the quick fixes. Huge thanks to my colleagues who helped me with this writeup! :)</p><p>感谢同类研究人员，他们分享了他们的发现和知识，并感谢Apple的快速修复。 感谢我的同事们帮助了我这个写作！ :) </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://mikko-kenttala.medium.com/zero-click-vulnerability-in-apples-macos-mail-59e0c14b106c">https://mikko-kenttala.medium.com/zero-click-vulnerability-in-apples-macos-mail-59e0c14b106c</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/漏洞/">#漏洞</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/麦克斯/">#麦克斯</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/邮件/">#邮件</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>