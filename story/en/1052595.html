<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>如何糟糕的随机数发生器冻结摇摆（2020） How a Bad Random Number Generator Froze Sway (2020)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">How a Bad Random Number Generator Froze Sway (2020)<br/>如何糟糕的随机数发生器冻结摇摆（2020） </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-16 06:18:32</div><div class="page_narrow text-break page_content"><p>Several months ago, I made the decision to switch from the  i3 window manager which uses the  X display protocol to  Sway which uses the new  Wayland protocol. This decision was based off the fact that I had display-specific workspaces were quite buggy in i3 and because I wanted to try something new. At first it went well, really well in fact — workspaces worked perfectly and any tearing I used to have was nonexistent.</p><p>几个月前，我决定从i3窗口管理器切换，该管理器使用x显示协议来摇摆，它使用新的WAILAND协议。这一决定是基于I3在I3的显示特定工作区的事实，因为我想尝试新的东西。起初它进展顺利，真的很好 - 事实上 - 工作区完美地工作，我过去常常的撕裂是不存在的。</p><p> All was going well until the last week of April after I updated Sway and rebooted. Sway instantly froze on the startup and kept keyboard input. After some investigation, I found that  Waybar seemed to be the problem. Removing it from the config let Sway startup and work normally... or so I thought. Randomly, Sway would completely freeze, the same way that it did on startup, so it was time to debug.</p><p> 在我更新摇摆并重新启动后，一切都很顺利。摇摆在启动时立即冻结并保持键盘输入。经过一些调查，我发现Waybar似乎是问题。从Config中删除它让摇摆启动并正常工作......或者我想。随机，摇摆将完全冻结，与启动时的方式相同，所以是时候调试了。</p><p>  While getting a Sway debug log was quite trivial by running Sway like so:  sway -d 2&gt; ~/sway.log it didn&#39;t yield much  1. The ideal solution would be to find out where Sway is hanging with a core dump, but this posed difficult to do because sway was now frozen and with it, keyboard input. Thus, resorting to the  SysRq shortcuts was necessary. These shortcuts are implemented in the kernel to perform basic, yet important, actions in cases like freezes. Below are some of the most common ones  2:</p><p>  通过运行Sway，播放调试日志的播放调试日志非常微不足道：Sway -d 2＆gt; 〜/ sway.log它没有产生了很多1.理想的解决方案是找出摇摆与核心转储悬挂的地方，但这难以理解，因为摇摆现在冻结并用它，键盘输入。因此，借助Sysrq快捷方式是必要的。这些快捷方式在内核中实现，以便在冻结等案例中执行基本，但重要的操作。以下是其中一些最常见的2：</p><p>  —  Everything beyond here was aided by the generous help of  Xyene. Thank you, if you ever read this.</p><p>   - 除了Xyene的慷慨帮助之外，所有人都得到了帮助。谢谢，如果你读过这个。</p><p> So, to get a core dump of the sway process, I first used the unraw shortcut, followed by switching to a tty and running the following commands:</p><p> 因此，要获得蠕动进程的核心转储，我首先使用横切快捷方式，然后切换到tty并运行以下命令：</p><p>   0  0x00007fcbb1012c6f  in  json_c_get_random_seed  ()  at  / usr / lib / libjson - c . so .5 1  0x00007fcbb1011fd6  in  ()  at  / usr / lib / libjson - c . so .5 2  0x00007fcbb100c713  in  json_object_object_add_ex  ()  at  / usr / lib / libjson - c . so .5 3  0x0000561dc53e42ff  in  ipc_json_describe_bar_config  ( bar = bar @ entry = 0x561dc6f0cbb0 )  at  .. / sway / sway / ipc - json . c : 1013  __PRETTY_FUNCTION__  =  &#34;ipc_json_describe_bar_config&#34;  json  =  0x561dc74da8b0  gaps  =  &lt; optimized  out &gt;  colors  =  &lt; optimized  out &gt;  tray_bindings  =  &lt; optimized  out &gt;  tray_bind  =  &lt; optimized  out &gt; # Truncated...</p><p>   json_c_get_random_seed（）in / usr / lib / libjson  -  c中的0 0x00007fcbb12c6f。所以.5 1 0x00007fcbb1011fd6 in（）在/ usr / lib / libjson  -  c。所以.5 2 0x00007fcbb100c713在json_object_object_add_ex（）at / usr / lib / libjson  -  c。所以.5 3 0x0000561DC53E42FF在IPC_JSON_DESCRIBE_BAR_CONFIG中（栏=栏@条目= 0x561dc6f0cmbb0）。 C：1013 __pretty_function__ =＆＃34; ipc_json_describe_bar_config＆＃34; JSON = 0x561DC74DA8B0间隙=＆lt;优化＆gt;颜色=＆lt;优化＆gt; Tray_Bindings =＆lt;优化＆gt;托架_bind =＆lt;优化＆gt; ＃截断......</p><p> What this revealed was that Sway was actually freezing because of  json-c, a JSON parsing library that Sway uses. Looking at the source code of  json-c, it can be seen calling the   json_c_get_random_seed function in an  infinite loop while checking if the result is  -1. And so, we found out  where json-c is freezing, but the question of  why remains.</p><p> 这揭示的是，由于JSON-C，摇摆的摇摆正在冻结，这是一个摇摆使用的JSON解析库。查看JSON-C的源代码，可以看到在无限循环中调用JSON_C_GET_RANDOM_SEED函数，同时检查结果是否为-1。所以，我们发现了JSON-C冻结的地方，但为什么仍然存在。 </p><p> Delving into  json_c_get_random_seed, another function called   get_rdrand_seed is ran to try to get a random number using the  RDRAND cpu instruction. This seems fine, except when you take into account the fact my CPU is an AMD Ryzen 5 3600X... which sometimes has a horribly malfunctioning RDRAND instruction that always returns  0xFFFFFFFFFFFFFFFF (which is  -1). This isn&#39;t normally an issue because very few processes attempt to use RDRAND without checking if it fails, often relying on  /dev/urandom instead. Both the linux kernel and  systemd check to make sure  RDRAND returns a sane random number.</p><p>DELVINGINATOJSON_C_GET_RANDOM_SEED，另一个名为get_rdrand_seed的函数是运行，以尝试使用RDRAND CPU指令获取随机数。除了考虑到我的CPU是AMD Ryzen 5 3600x的事实外，这似乎很好。其中有时有一个可怕的故障的RDRAND指令，始终返回0xFFFFFFFFFFFFFFFFFFFFFF（这是-1）。这不是一个问题，因为很少有进程尝试使用Rdrand而不检查它是否失败，通常依赖/开/ urandom。 Linux内核和SystemD都检查以确保RDRAND返回SANE随机数。</p><p>  So, to finally fix this glorious bug, Xyene introduced a  check into the  has_rdrand function (which checks whether to use the  RDRAND instruction later on) that disables  RDRAND if it returns the same value 10 times in a row. The important section can be seen below:</p><p>  因此，最终修复了这个辉煌的错误，Xyene介绍了一个禁用RDRAND的rdrand指令，检查了是否在行中返回相同的值10次。以下重要部分如下：</p><p> // Some CPUs advertise RDRAND in CPUID, but return 0xFFFFFFFF // unconditionally. To avoid locking up later, test RDRAND here. If over // 10 trials RDRAND has returned the same value, declare it broken. _has_rdrand  =  0 ; int  prev  =  get_rdrand_seed (); for  ( int  i  =  0 ;  i  &lt;  10 ;  i ++ )  {  int  temp  =  get_rdrand_seed ();  if  ( temp  !=  prev )  { 	 _has_rdrand  =  1 ; 	 break ;  }  prev  =  temp ; }</p><p> //一些CPU在CPUID中宣传RDRAND，但无条件地返回0xFFFFFFFF //。避免以后锁定，在此测试RDRAND。如果超过// 10试验Rdrand返回相同的值，请宣布破碎。 _has_rdrand = 0; int prev = get_rdrand_seed（）; for（int i = 0; i＆lt; 10; i ++）{int temp = get_rdrand_seed（）; if（temp！= prev）{_has_rdrand = 1;休息 ; } prev = temp; }</p><p> This leaves the chances of disabling a correctly functioning  RDRAND instruction a whopping  0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004% (4.68e-95%).</p><p> 这个叶禁用正常RDRAND指令高达0.00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004％（4.68e-95％）的机会。</p><p> A follow up patch was also required because of some inline assembly that tried to get the  cpuid bit which can be seen  here.</p><p> 由于某些内联组件，还需要进行后续修补程序，试图获取此处可以看到的CPUID位。</p><p> The associated Sway issue for this blog is  swaywm/sway#5290 along with  json-c/json-c#489 and  json-c/json-c#590 for the json-c issues.</p><p> 对于JSON-C / JSON-C＃489和JSON-C / JSON-C＃489和JSON-C / JSON-C＃590，此博客的相关摇摆问题是Swaywm / Sway＃5290以及用于JSON-C问题的JSON-C / JSON-C＃590。</p><p>  These are the shortcuts needed for a safe reboot, taken from the  Arch wiki. ↩</p><p>  这些是安全重启所需的快捷方式，从Arch Wiki中取出。 ↩ </p><p> This also required a build of Sway which didn&#39;t strip symbols. This was done by using the   sway-git package off the  AUR. Core dump available  here. ↩</p><p>这也需要一个摇摆的构建，它没有＆＃39; t条符号。 这是通过使用摇摆git包关闭AUR来完成的。 核心转储在此处提供。 ↩ </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://theavid.dev/sway-rng">https://theavid.dev/sway-rng</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/2020/">#2020</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/发生器/">#发生器</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/random/">#random</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/json/">#json</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012 - 2021 diglog.com </div></div></body></html>