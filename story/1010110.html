<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>即时编译器速成课程(2017)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">即时编译器速成课程(2017)</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-06 21:19:11</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/7/88ff4dec58afa367d96369000fda9bc3.jpg"><img src="http://img.diglog.com/img/2020/7/88ff4dec58afa367d96369000fda9bc3.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>这是关于WebAssembly的系列文章的第二部分，以及它的快速之处。如果您还没有阅读其他内容，我们建议从头开始。</p><p>JavaScript一开始速度很慢，但后来变得更快，这要归功于一种名为JIT的东西。但是JIT是如何运作的呢？</p><p>当您作为开发人员将JavaScript添加到页面时，您有一个目标和一个问题。</p><p>你说的是人类语言，而计算机说的是机器语言。即使您不认为JavaScript或其他高级编程语言是人类语言，它们确实是人类语言。它们是为人类认知而设计的，而不是为机器认知而设计的。</p><p>所以JavaScript引擎的工作就是把你的人类语言转化成机器能理解的东西。</p><p>我认为这就像电影“降临”，里面有人类和外星人试图相互交谈。</p><p>在那部电影中，人类和外星人不仅仅是逐字翻译。这两个群体对世界的看法不同。人类和机器也是如此(我将在下一篇文章中更多地解释这一点)。</p><p>在编程中，通常有两种方法可以转换为机器语言。您可以使用解释器或编译器。</p><p>另一方面，编译器不会在运行时进行翻译。它会提前创建该翻译并将其记录下来。</p><p>口译员很快就能上手并投入使用。在开始运行代码之前，您不必经历整个编译步骤。您只需开始翻译第一行并运行它。</p><p>正因为如此，解释器似乎自然而然地适合于JavaScript之类的东西。对于Web开发人员来说，能够快速开始并运行他们的代码是很重要的。</p><p>但是，当您多次运行相同的代码时，使用解释器的缺点就会出现。例如，如果您处于循环中。然后你必须一遍又一遍地做同样的翻译。</p><p>它需要多一点时间才能启动，因为它必须在开始时经过编译步骤。但是，循环中的代码运行得更快，因为它不需要为通过该循环的每一次传递重复转换。</p><p>另一个不同之处在于，编译器有更多的时间查看代码并对其进行编辑，以便运行得更快。这些编辑称为优化。</p><p>解释器在运行时执行其工作，因此在翻译阶段不需要花费太多时间就可以计算出这些优化。</p><p>作为摆脱解释器效率低下的一种方式-解释器在每次执行循环时都必须不断地重新翻译代码-浏览器开始混合编译器。</p><p>不同的浏览器执行此操作的方式略有不同，但基本思想是相同的。他们在JavaScript引擎中添加了一个新部件，称为监视器(也称为分析器)。该监视器在代码运行时监视它，并记录它运行了多少次以及使用了什么类型。</p><p>如果相同的代码行运行几次，则该代码段称为热代码段。如果经常跑，那就叫热。</p><p>当函数开始变暖时，JIT将把它送去编译。然后它将存储该编译。</p><p>函数的每一行都被编译成一个“存根”。存根是按行号和变量类型编制索引的(稍后我将解释为什么这一点很重要)。如果监视器发现执行再次命中具有相同变量类型的相同代码，它将直接取出其编译版本。</p><p>这有助于加快速度。但是就像我说的，编译器还可以做更多的事情。这可能需要一些时间来找出做事情最有效的方法…。进行优化。</p><p>基线编译器将进行其中的一些优化(下面我给出一个例子)。不过，它不想花费太多时间，因为它不想耽误执行太长时间。</p><p>然而，如果代码真的很热-如果它运行了一大堆次-那么花额外的时间进行更多的优化是值得的。</p><p>当一部分代码非常热时，监视器会将其发送给优化编译器。这将创建函数的另一个甚至更快的版本，该版本也将被存储。</p><p>为了更快地生成代码版本，优化编译器必须做出一些假设。</p><p>例如，如果它可以假设由特定构造函数创建的所有对象都具有相同的形状-即它们始终具有相同的属性名称，并且这些属性是以相同的顺序添加的-那么它可以在此基础上偷工减料。</p><p>优化编译器使用监视器通过观察代码执行所收集的信息来做出这些判断。如果某件事在之前通过循环的所有过程中都为真，则假定它将继续为真。</p><p>但当然，对于JavaScript，永远不会有任何保证。您可能有99个对象都具有相同的形状，但是第100个对象可能缺少一个属性。</p><p>因此，编译后的代码需要在运行前进行检查，以查看假设是否有效。如果是，则运行编译后的代码。但如果不是这样，JIT就会假设它做出了错误的假设，并将优化后的代码丢弃。</p><p>然后，执行返回到解释器或基准编译版本。这个过程被称为去最优化(或跳出)。</p><p>通常情况下，优化编译器会使代码更快，但有时它们可能会导致意想不到的性能问题。如果您的代码不断被优化，然后又被取消优化，那么它最终会比仅仅执行基线编译版本慢。</p><p>当这些优化/取消优化循环发生时，大多数浏览器都增加了一些限制来打破它们。比方说，如果JIT在优化方面进行了10次以上的尝试，并且一直不得不放弃，那么它就会停止尝试。</p><p>有很多不同种类的优化，但我想看一种类型，这样您就可以感受到优化是如何发生的。优化编译器的最大胜利之一来自一种称为类型专门化的东西。</p><p>JavaScript使用的动态类型系统在运行时需要做一些额外的工作。例如，请考虑以下代码：</p><p>函数arraySum(Arr){var sum=0；for(var i=0；i&lt；arr.length；i++){sum+=arr[i]；}}。</p><p>循环中的+=步骤可能看起来很简单。看起来您可以一步完成计算，但是由于动态类型，它需要的步骤比您预期的要多。</p><p>让我们假设arr是一个由100个整数组成的数组。一旦代码预热，基线编译器将为函数中的每个操作创建一个存根。因此，将有一个sum+=arr[i]的存根，它将把+=运算作为整数加法来处理。</p><p>但是，sum和arr[i]不能保证是整数。因为类型在JavaScript中是动态的，所以在以后的循环迭代中，arr[i]可能会是一个字符串。整数加法和字符串连接是两种截然不同的操作，因此它们将编译成截然不同的机器码。</p><p>JIT处理此问题的方式是编译多个基线存根。如果一段代码是单态的(即，总是用相同的类型调用)，它将获得一个存根。如果它是多态的(从一次代码到另一次代码使用不同的类型调用)，那么它将为通过该操作的每个类型组合获得一个存根。</p><p>这意味着JIT在选择存根之前必须问很多问题。</p><p>因为每行代码在基线编译器中都有自己的存根集，所以JIT需要在每次执行该行代码时不断检查类型。因此，对于循环中的每一次迭代，它都必须提出相同的问题。</p><p>如果JIT不需要重复这些检查，代码的执行速度会快得多。这也是优化编译器要做的事情之一。</p><p>在优化编译器中，整个函数一起编译。类型检查被移动，以便它们发生在循环之前。</p><p>有些JIT甚至进一步优化了这一点。例如，在Firefox中，对于只包含整数的数组有一个特殊的分类。如果arr是这些数组之一，那么JIT不需要检查arr[i]是否是整数。这意味着JIT可以在进入循环之前执行所有类型检查。</p><p>简而言之，这就是JIT。它通过在代码运行时监视代码并发送要优化的热代码路径，从而使JavaScript运行得更快。这使得大多数JavaScript应用程序的性能提高了许多倍。</p><p>但是，即使有了这些改进，JavaScript的性能也可能是不可预测的。为了加快速度，JIT在运行时增加了一些开销，包括：</p><p>用于监视器记账和救助发生时的恢复信息的内存。</p><p>这里还有改进的空间：这一开销可以消除，从而使性能更具可预测性。这是WebAssembly做的事情之一。</p><p>在下一篇文章中，我将更多地解释汇编以及编译器如何使用它。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://hacks.mozilla.org/2017/02/a-crash-course-in-just-in-time-jit-compilers/">https://hacks.mozilla.org/2017/02/a-crash-course-in-just-in-time-jit-compilers/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/编译/">#编译</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/速成/">#速成</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/代码/">#代码</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1009216.html"><img src="http://img.diglog.com/img/2020/7/thumb_ed473defc8c65c73e82fc3ee418156ef.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1009216.html">驯服ClojureScript项目中的高级编译错误</a></div><span class="my_story_list_date">2020-7-1 10:42</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008952.html"><img src="http://img.diglog.com/img/2020/6/thumb_63abb9829dd62f67d526ec3bc01f68e4.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008952.html">铁锈编译缓慢的几个原因</a></div><span class="my_story_list_date">2020-6-30 21:11</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008022.html"><img src="http://img.diglog.com/img/2020/6/thumb_3672abea6447c64aa1164dbf005e43a6.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008022.html">WIFF代码中的C编译器性能迷惑</a></div><span class="my_story_list_date">2020-6-25 5:12</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007158.html"><img src="http://img.diglog.com/img/2020/6/thumb_dde71b18b31374e668d369cd8c5ee2ef.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007158.html">编译器编译器：关于使用JavaScript引擎的Twitch系列文章</a></div><span class="my_story_list_date">2020-6-19 3:23</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>