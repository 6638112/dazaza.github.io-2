<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我们用存储类内存替换了固态硬盘。以下是我们了解到的情况</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">我们用存储类内存替换了固态硬盘。以下是我们了解到的情况</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-29 14:04:51</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/8/acbf005225bb769e4fe1a757f81c4864.png"><img src="http://img.diglog.com/img/2020/8/acbf005225bb769e4fe1a757f81c4864.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>2019年4月2日，英特尔Optane永久内存成为第一款商用的存储类内存(SCM)产品。与SSD一样，该内存是持久的，并且与DRAM一样，它位于内存总线上。早在商业发布之前，系统架构师就在思考SCM如何准确地适应存储层次结构，现在是执行具体测量的机会了。我们想要回答的一个问题是，位于内存总线上的存储设备是否可以提供比位于PCI-e上的同等存储设备更好的吞吐量。</p><p>访问单片机有两种方式：字节接口和块接口。字节接口允许使用加载和存储指令，就像使用DRAM一样。数据块接口将SCM公开为数据块设备，也可以选择在顶部放置一个文件系统：这样就可以像访问传统SSD一样访问它。加载/存储API得到了简化，因为应用程序和硬件之间没有任何障碍，但使用起来也很棘手，因为它没有像文件系统API通常那样提供崩溃一致性之类的功能。通过数据块或文件系统API访问SCM会带来操作系统开销，但不需要重写应用程序。</p><p>我们在本文中评估的MongoDB存储引擎WiredTiger使用相当大的块(通常为4KB或更大)从存储读写数据。除了是当今传统存储硬件的必需品外，使用块API还有其他实际优势。例如，客户梦寐以求的压缩和加密功能已针对块进行了优化。类似地，保护数据免受损坏的校验和是在数据块上计算的。此外，WiredTiger将数据块缓存在其DRAM驻留缓存中，这与操作系统缓冲区缓存一起提高了性能。</p><p>块导向和对缓存的依赖使WiredTiger与许多其他存储引擎一样，可以有效地隐藏慢速存储设备的延迟。因此，我们的实验表明，SCM相对于同等技术的SSD提供的适度延迟优势并不能转化为实际工作负载的性能优势。存储引擎有效地掩盖了这些延迟差异。当SCM用于无法通过批处理和缓存隐藏的延迟敏感型操作(如日志记录)时，它将大放异彩。在本文的其余部分中，我们将详细介绍导致我们得出这一结论的实验结果。</p><p>我们使用两种存储设备进行了实验：英特尔Optane直流永久内存(PM)和英特尔Optane P4800X固态硬盘。两者均采用Intel Optane 3D XPoint非易失性内存构建，但前者是位于内存总线上的SCM，而后者是连接PCIe的固态硬盘。</p><p>首先，我们使用使用8KB块读取或写入32 GB文件的微基准来测量原始设备带宽。我们改变同时访问文件的线程数量，每个线程都有自己的块。可以通过系统调用(读/写)或mmap访问文件；后一种方法的开销通常较小。</p><p>根据规格，我们的P48000X驱动器能够提供高达2.5 GB/s的顺序读取带宽和高达2.2 GB/s的顺序写入带宽。下面是我们通过Ubuntu Linux(5.3内核)原始设备API观察到的数字，这意味着数据绕过了操作系统缓冲区缓存。</p><p>只要我们使用至少两个线程，读取带宽就会根据规范运行。使用多个线程时，写入带宽意外超出其指定的上限。我们怀疑这可能是由于在操作系统或设备上缓冲写入造成的。</p><p>Optane P4800X固态硬盘在撰写本文时比典型的固态硬盘速度更快，但还没有达到无与伦比的地步。Optane固态硬盘提供高达2.5 GB/s的顺序读取带宽，而典型的NAND固态硬盘(例如英特尔SSD Pro 6000p系列)提供高达1.8 GB/s的带宽。写入方面的差异更为明显。Optane驱动器最高可提供2.2 Gb/s，而NAND驱动器不能超过0.56 Gb/s。</p><p>Optane SSD上的随机读取和写入并不比顺序读取和写入差多少。我们能够通过读取实现接近峰值的顺序吞吐量(使用mmap)，而写入的顺序吞吐量仅比峰值低10%。顺序访问和随机访问的近乎相同的性能是这些驱动器的已知特征。</p><p>现在让我们来看一下SCM的原始性能。支持Optane PM的英特尔系统最多可容纳六个DIMM，而我们的实验系统只有两个。我们测量了单个DIMM和一起使用的两个DIMM的吞吐量，以推断随着DIMM数量的增加而进行的扩展。我们还依靠其他研究人员的数据来证实我们的推断。</p><p>有两种方法可以直接访问PM：(1)devdax--PM模块公开为字符设备；(2)fsdax--在这种情况下，我们在伪装成块设备的PM模块之上有一个文件系统，但是文件访问通过直接访问(DAX)模式绕过了缓冲区缓存。在我们的实验中，我们使用ext4文件系统。</p><p>下表显示了通过这些访问方法获得的顺序读取和写入的吞吐量。在所有情况下，我们都使用mmap，因为这是devdax唯一支持的方法。</p><p>单个PM模块的顺序读取带宽达到6.4 Gb/s左右，与其他研究人员的观察结果相符。随机访问的行为与顺序访问几乎相同，因此我们省略了图表。</p><p>写实验讲述了一个不同的故事。单模块写入吞吐量仅达到0.6 Gb/s。这一测量结果与UCSD研究人员在单个设备上观察到的约2.3 Gb/s写入带宽的数据不一致。进一步的调查使我们相信这是由于硬件版本的不同造成的。也就是说，我们的观察显示，单个PM模块实现的写入吞吐量仅可与NAND SSD相媲美。</p><p>接下来，让我们看一下跨两个设备的扩展。下图显示了使用fsdax上的mmap进行顺序读取和写入的度量。我们使用Linux条带设备映射器将负载分散到两个DIMM上。对于读取，使用两个DIMM几乎可以将峰值读取带宽提高一倍，从使用一个DIMM的6.4 GB/s提高到使用两个DIMM的12.4 GB/s。同样，加州大学圣迭戈分校的研究人员观察到六个DIMM之间几乎呈线性扩展。</p><p>对于写入，我们使用两个DIMM实现了近1 Gb/s的写入吞吐量，而使用一个DIMM实现了0.6 Gb/s的写入吞吐量，但如果我们可以从单个数据点推断，扩展能力就不是线性的。USCD的研究人员观察到，与使用单个DIMM相比，使用6个DIMM的带宽提高了5.6倍，这与我们的观察结果一致。从这些数据点推断，如果我们的系统有6个DIMM，我们将观察到大约3.4 GB/s的峰值写入带宽，这比Optane SSD高出约50%。</p><p>总而言之，使用裸设备访问时，Optane固态硬盘上的峰值读取带宽约为2.5 GB/s，单个Optane PM模块上的峰值读取带宽约为6.4 GB/s。如果使用6个模块，吞吐量将约为38 GB/s。单个PM模块的写入吞吐量仅为0.6 GB/s，如果使用6个模块，预计将达到3.4 GB/s，而Optane SSD可达到2.2 GB/s的写入带宽。</p><p>Optane SCM在读取方面明显优于固态硬盘，在写入方面略有优势，前提是您负担得起6个PM模块；否则，固态硬盘将提供更高的写入吞吐量。</p><p>虽然SCM比传统存储介质更接近DRAM的速度，但DRAM仍然更快，因此DRAM缓存的优势难以忽视。下面的图表显示，在打开缓冲区缓存的情况下(这里我使用的是不带DAX选项的ext4)，无论我们是进行读取还是写入、随机访问还是顺序访问，所有设备的性能都大致相同。这些实验是使用热缓冲区缓存进行的，也就是说，在我开始实验之前，文件就已经在缓冲区缓存中了，所以在这里我们测量的是纯DRAM性能。由于访问数据花费的时间更少，软件开销变得更加明显，这就是为什么如果我们使用8个或更多线程，mmap比系统调用要快得多。</p><p>如果我们从冷缓冲区缓存开始每个实验，设备之间的差异仍然很明显，但不如完全绕过缓冲区缓存那么明显。使用冷缓冲区缓存时，在读取路径上，操作系统必须将数据从存储设备复制到缓冲区缓存中，然后才能供应用程序使用(因此需要额外的软件开销)。此外，在打开缓冲区缓存的情况下，操作系统不会使用大型页面。这些因素削弱了SCM的原始读取优势。</p><p>对于写入，SCM过去提供的带宽比使用原始访问的SSD低，但现在SCM的带宽超过了SSD，这可能是因为缓冲区高速缓存吸收并批处理了其中的一些写入，而不是立即将每个写入刷新到设备。</p><p>与大多数存储引擎一样，WiredTiger的设计和调优都是为了利用DRAM缓存。WiredTiger内部缓存和操作系统缓冲区缓存对于我们测量的所有工作负载的性能都至关重要。在我们的实验中，在没有操作系统缓冲区缓存(fsdax模式)的情况下运行WiredTiger会使其性能降低多达30倍；因此，我们没有使用直接访问模式。</p><p>我们运行WiredTiger的wtperf基准测试套件，该套件旨在强调系统的各个部分，并模拟在实践中观察到的典型工作负载。在各个基准测试中，WiredTiger内部缓存的大小从几GB到100 GB不等，并且大多数基准测试至少使用十几个线程。(可在此处查看所有基准的详细配置参数。)。WiredTiger在公共路径上没有锁定，因此线程级并发通常会转化为高CPU利用率和并发I/O。正如我们在上一篇博客中所描述的那样，我们向WiredTiger添加了一个特性，以便使用mmap进行I/O而不是系统调用。</p><p>下表显示了wtperf套件在英特尔Optane SCM(一个模块和两个模块)和Optane SSD上的性能。我们发现SCM和SSD之间没有明显的性能差异。除了一个写密集型基准evict-btree-1(在SSD上速度更快)外，这两个基准之间在统计上没有显著差异。与单模块SCM相比，使用双模块SCM也不会带来性能优势。</p><p>虽然SCM比同等技术的SSD具有更高的带宽，但优势在一个数量级之内，而事实证明，有效的DRAM缓存掩盖了这种差异。</p><p>SCM的亮点在于延迟，而不是带宽。与带宽相比，从Optane PM读取数据块的延迟比从Optane SSD读取数据块的延迟短两个数量级：1微秒对100-200微秒。在存储引擎中，延迟可能成为瓶颈的最明显的地方是日志记录，学术文献中使用Optane PM进行日志记录的成功例子已经成熟。同时，请继续关注我们的下一篇关于探索持久内存的报道。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://engineering.mongodb.com/post/we-replaced-an-ssd-with-storage-class-memory-here-is-what-we-learned">https://engineering.mongodb.com/post/we-replaced-an-ssd-with-storage-class-memory-here-is-what-we-learned</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/内存/">#内存</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/硬盘/">#硬盘</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/固态硬盘/">#固态硬盘</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/替换/">#替换</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ssd/">#ssd</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1020402.html"><img src="http://img.diglog.com/img/2020/8/thumb_2e540190fec5f7f1acad5376da6aa592.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1020402.html">漏洞利用开发的现状：第1部分</a></div><span class="my_story_list_date">2020-8-26 19:36</span></div><div class="col-sm"><div><a target="_blank" href="/story/1019850.html"><img src="http://img.diglog.com/img/2020/8/thumb_6e50ece1e013bbf8a20058f0e1782492.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019850.html">RPCS3 Inside Look：深入研究硬件和性能扩展</a></div><span class="my_story_list_date">2020-8-23 6:35</span></div><div class="col-sm"><div><a target="_blank" href="/story/1017409.html"><img src="http://img.diglog.com/img/2020/8/thumb_d5ac22b6724f715986d70f6c316f3742.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1017409.html">16位MS-DOS内存模型回顾</a></div><span class="my_story_list_date">2020-8-11 3:47</span></div><div class="col-sm"><div><a target="_blank" href="/story/1017327.html"><img src="http://img.diglog.com/img/2020/8/thumb_586e0defe0ce03e4f6eb1ed969fd929d.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1017327.html">围棋中的分布式内存数据结构。可嵌入或独立的服务</a></div><span class="my_story_list_date">2020-8-10 21:16</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>