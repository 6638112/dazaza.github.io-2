<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>将Golang和Rust CLI工具移植到D</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">将Golang和Rust CLI工具移植到D</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-20 16:02:34</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/8/5de001861fff2a53e8e0d517dc5b43f5.png"><img src="http://img.diglog.com/img/2020/8/5de001861fff2a53e8e0d517dc5b43f5.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>几天前，在编程子reddit中，Paulo Henrique Cuchi分享了他用Rust和Go编写命令行工具的经验。正在讨论的工具是他的副项目HashTrack的一个客户。Hashtrace公开了一个GraphQL API，客户端可以使用该API跟踪特定的Twitter标签，并获得相关tweet的实时列表。在这条评论的提示下，我决定编写一个D端口来演示如何使用D来实现类似的目标。我会尽量保持与他在博客帖子中使用的结构相同的结构。</p><p>主要原因是，最初的博客文章比较了Go和Rust等静态类型的语言，并恭敬地提到了Nim和Crystal，但没有提到D.属于这一类，所以我认为这将是一个有趣的比较。</p><p>我也喜欢D作为一种语言，我在其他各种博客文章中都提到过它。</p><p>该手册有一个很长的页面，介绍如何下载和安装参考编译器DMD。Windows用户可以获得安装程序，而MacOS用户可以使用自制软件。在Ubuntu上，我只需添加APT存储库并执行正常的APT安装。有了这个，你将得到DMD，但也会得到包管理器。</p><p>我安装Rust是为了了解启动和运行起来有多容易。我惊讶于它是如此容易。我只需要运行交互式安装程序，它会负责其余的工作。我确实必须在路径中添加~/.cargo/bin。考虑到这一点，我可能只需要重新启动控制台就可以使更改生效。</p><p>我不费吹灰之力地用Vim编写了hashtrace，但这可能是因为我对标准库中的所有内容都有一定的了解。我确实让文档一直处于打开状态，因为我偶尔会使用没有从正确的包中导入的符号，或者我使用错误的参数调用函数。请注意，就标准库而言，您可以只导入STD，并且可以随心所欲地使用所有东西。不过，对于第三方图书馆来说，您只能靠自己了。</p><p>我对工具的状态很好奇，所以我在插件中寻找我最喜欢的IDE，IntelliJ Idea。我找到了这个并安装了它。我还通过克隆DCD和DScanner各自的repos并构建它们，然后配置Idea插件使其指向正确的路径，从而代替了DCD和DScanner。大声向这篇博客文章的作者解释这一过程。</p><p>起初我遇到了一些问题，但在更新IDE和插件后，这些问题都得到了修复。我遇到的问题之一是，它无法识别我自己的包裹，并一直将它们标记为可能未定义的。后来我发现，我必须将&#34；module name_of_the_package；&#34；放在文件的顶部才能识别它。</p><p>我认为它仍然有一个错误，它不能识别.length，至少在我的机器上是这样。我在Github上开了一期，如果你好奇，可以在这里关注它。</p><p>Dub是d中事实上的包管理器，它从https://code.dlang.org/.获取和安装依赖项。对于这个项目，我需要一个HTTP客户端，因为我不想使用cURL。我最终获取了两个依赖项，Requests和它的依赖项cachTools，它本身没有依赖项。不过，由于某些原因，它又获得了12个依赖项：</p><p>Rust下载了很多板条箱，但这可能是因为Rust版本的代码比我的版本有更多的功能。例如，它获取了rpassword，这是一个在您将密码字符键入终端时隐藏密码字符的工具，非常类似于Python的getpass函数。这是我的代码中没有的许多东西之一。</p><p>由于对GraphQL知之甚少，我不知从何说起。通过在code.dlang.org上搜索GraphQL&34；，我找到了一个相关的图书馆，名字恰如其分地命名为&#34；raphqld&34；。不过，在仔细研究之后，我觉得它更像是一个vibe.d插件，而不是一个真正的客户端，如果真的有这样的事情的话。</p><p>在检查了Firefox上的网络请求之后，我意识到对于这个项目，我可以只模拟GraphQL查询和突变，然后用HTTP客户端发送它们。响应只是JSON对象，我可以使用std.json包提供的工具来解析它们。考虑到这一点，我开始寻找HTTP客户端，并确定了请求，一种简单易用的HTTP客户端，但更重要的是，它已经达到了一定的成熟度。</p><p>我复制了来自网络检查器的传出请求，并将它们粘贴到单独的.raphql文件中，然后使用适当的变量导入并发送这些文件。大部分功能被放在GraphQLRequest结构中，因为我想向其中注入不同的端点和配置，这是项目的一个要求：</p><p>Struct GraphQLRequest{String operationName；String query；JSONValue Variables；Config Configuration；JSONValue toJson(){return JSONValue([&#34；operation Name&#34；：JSONValue(Operation Name)，&#34；Variables&#34；：Variables，&#34；Query&#34；：JSONValue(Query)，])；}string toString(){return to Json().toPrettyString。Token&#34；，&#34；&#34；)])；return request.post(configuration ation.get(&#34；Endpoint&#34；)，toString()，&#34；application/json&#34；)；}}。</p><p>Struct session{配置配置；void login(String用户名，字符串密码){auto request=createSession(用户名，密码)；auto response=request.send()；response.throwOnFailure()；string Token=response.jsonBody[&#34；data&#34；].object[&#34；createSession&#34；].object[&#34；Token&#34；].str；configuration ation.put(&#34；Token&。CreateSession.graphql&#34；).lineSplitter().join(&#34；\n&#34；)；自动变量=SessionPayload(用户名，密码).toJson()；Return GraphQLRequest(&#34；CreateSession&#34；，Query，Variables，Configuration)；}}struct SessionPayload{String Email；String Password；//TODO：将其设置为模板混合或JSONValue toJson(){return JSONValue([&#34；Email&#34；：JSONValue(Email)，&。}string toString(){return to Json().toPrettyString()；}}</p><p>它是这样的：main()函数从命令行参数创建一个Config结构，并将其注入到会话结构中，该结构实现了login、logout和status命令的功能。CreateSession()方法通过从适当的.raphql文件读取实际请求并传递变量来构造GraphQL请求。我不想用GraphQL突变和查询来污染源代码，所以我将它们移到.raphql文件中，然后在编译过程中借助枚举和导入将其导入。后者需要编译器标志将其指向字符串ImportPath(默认为views/)。</p><p>至于login()方法，它只负责发送HTTP请求和处理响应。在这种情况下，它会处理潜在的错误，尽管不是彻底的。然后，它将令牌存储在一个配置文件中，该文件实际上只不过是一个美化的JSON对象。</p><p>ThrowOnFailure方法不是请求库核心功能的一部分。它实际上是一个帮助器函数，执行快速而肮脏的错误处理：</p><p>Void throwOnFailure(响应响应){if(！response.isSuccessful||&#34；error&#34；in response.jsonBody){string[]error=response.error；抛出新的RequestException(errors.join(&#34；\n&#34；))；}}。</p><p>因为D支持UFC，所以可以将throwOnFailure(Response)语法重写为response.throwOnFailure()。这使得它可以与其他内置方法(如send())无缝集成。我可能在整个项目中滥用了这个功能。</p><p>当涉及到错误处理时，D几乎偏爱异常。这里详细解释了其基本原理。我喜欢它的一点是，除非明确地静默，否则未处理的错误最终会被报告。这就是我能够摆脱简单错误处理的原因。例如，在以下行中：</p><p>如果响应正文不包含令牌对象或任何指向它的对象，它将抛出一个异常，该异常将冒泡到主函数，然后在用户面前爆炸。如果我一直在使用Go，我在处理每个阶段的错误时都必须非常小心。老实说，因为每次我调用函数时编写if err！=null都很烦人，所以我很想忽略它。然而，我对围棋的理解是原始的，如果编译器因为你没有对错误返回值做任何事情而对你吠叫，我不会感到惊讶，所以如果我错了，请随时纠正我。</p><p>原始帖子中解释的Ruust样式错误处理很有趣。我不认为D在标准库中有类似的东西，但是已经有关于将其作为第三方库实现的讨论。</p><p>我只想快速提一下，我没有使用WebSockets来实现watch命令。我尝试使用Vibe.d；的WebSocket客户端，但是我无法使用hashtrace后端，因为它一直在关闭连接。我最终放弃了它，转而支持民调，尽管它令人皱眉。客户端确实可以工作，因为我已经用另一台WebSocket服务器对其进行了测试，所以我可能会在将来再来讨论这一点。</p><p>对于CI，我设置了两个构建作业：一个是针对Feature分支的普通构建，另一个是针对Master的发行版，以便以可下载构件的形式提供优化的构建。</p><p>然后，我运行了/usr/bin/time-v./hashtrace--list命令来测量内存使用情况，如原始文章中所述。我不知道内存使用情况是否取决于登录用户遵循的标签，但以下是使用dub build-b release构建的D的结果：</p><p>最大驻留集大小(千字节)：10036最大驻留集大小(千字节)：10164最大驻留集大小(千字节)：9,940最大驻留集大小(千字节)：10060最大驻留集大小(千字节)：10008。</p><p>还不错。我与我的hashtrace用户运行了Go和Rust版本，得到了以下结果：</p><p>最大驻留集大小(千字节)：13684最大驻留集大小(千字节)：13820最大驻留集大小(千字节)：13904最大驻留集大小(千字节)：13796最大驻留集大小(千字节)：13600。</p><p>最大驻留集大小(千字节)：9224最大驻留集大小(千字节)：9192最大驻留集大小(千字节)：9384最大驻留集大小(千字节)：9132最大驻留集大小(千字节)：9168。</p><p>编辑：Redditor skocznymroczny建议我在测试DMD的同时测试LDC和GDC。以下是结果：</p><p>最大驻留集大小(千字节)：7792最大驻留集大小(千字节)：7856最大驻留集大小(千字节)：7792最大驻留集大小(千字节)：7760最大驻留集大小(千字节)：7708。</p><p>D有垃圾收集功能，但它也支持智能指针，最近还支持一种受Rust启发的实验性内存管理方法。我不太确定这些功能与标准库集成得有多好，所以我决定让GC为我处理内存。考虑到我在编写代码时没有考虑到内存消耗，我认为结果相当不错。</p><p>我认为D是编写这样的命令行工具的可靠语言。我不经常接触外部依赖项，因为标准库拥有我需要的大部分内容。解析命令行参数、处理JSON、单元测试、发出HTTP请求(使用cURL)等都在标准库中可用。如果标准库缺少您需要的东西，第三方软件包就会出现，但我认为在这方面仍有改进的空间。好的一面是，如果你有一种不是在这里发明的心态，或者如果你想作为一名开源贡献者轻松地产生影响，那么你肯定会喜欢D生态系统。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://pingfrommorocco.blogspot.com/2020/08/porting-golang-and-rust-cli-tool-to-d.html">https://pingfrommorocco.blogspot.com/2020/08/porting-golang-and-rust-cli-tool-to-d.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/golang/">#golang</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1019114.html"><img src="http://img.diglog.com/img/2020/8/thumb_bc14903f7a17967e35248a2869c4734a.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019114.html">印度反垄断监管机构驳回了针对WhatsApp的诉讼，称该公司没有滥用其主导地位在支付市场扩张</a></div><span class="my_story_list_date">2020-8-19 21:51</span></div><div class="col-sm"><div><a target="_blank" href="/story/1018922.html"><img src="http://img.diglog.com/img/2020/8/thumb_40462da55165ca9c980a6bad5e066545.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018922.html">OneSignal正在招聘一名对编写Go and Rust感兴趣的后端工程师</a></div><span class="my_story_list_date">2020-8-18 23:25</span></div><div class="col-sm"><div><a target="_blank" href="/story/1018921.html"><img src="http://img.diglog.com/img/2020/8/thumb_10c030b2429f801a5aed8756bdece9d2.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018921.html">为铁锈的未来奠定基础</a></div><span class="my_story_list_date">2020-8-18 23:25</span></div><div class="col-sm"><div><a target="_blank" href="/story/1018695.html"><img src="http://img.diglog.com/img/2020/8/thumb_bc260e14829409fa0b3a5098bd5c416c.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018695.html">
苹果将其独立维修计划扩大至Mac，此前美国反垄断调查审查了该公司的维修政策</a></div><span class="my_story_list_date">2020-8-18 0:56</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>