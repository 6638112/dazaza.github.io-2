<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>如何正确管理用于服务器访问的SSH密钥</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">如何正确管理用于服务器访问的SSH密钥</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-27 03:15:46</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/9/9d2b51fdc422c687708ed5c069421e6c.png"><img src="http://img2.diglog.com/img/2020/9/9d2b51fdc422c687708ed5c069421e6c.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>通常，这是使用公钥-私钥加密实现的，每个开发人员都会生成自己的公钥-私钥对。每个开发人员的公钥都会添加到他们有权访问的每台服务器上的AUTHORIZED_KEYS文件中。</p><p>在这种情况下，应该从所有服务器中删除该开发人员的公钥。这可能是一项相当大的工作，具体取决于他们有权访问的服务器数量。更糟糕的是，如果手动完成此操作，则可能会有相当大的风险，即某些服务器上的密钥仍会被遗忘，因此访问仍然是开放的。</p><p>有一些商业和开源解决方案想要帮助解决这个问题。基本思想是您添加和维护该服务上的密钥和访问列表，当您删除密钥时，它们会将其从所有服务器中删除。</p><p>听起来不错，但它有一个非常大的缺点：它是一个潜在的失败的单一来源。如果有人捕获了对该服务的访问权限，他们就可以访问您的所有服务器。如果您无法访问该服务，那么在最坏的情况下，您也会失去对所有服务器的访问权限。</p><p>当我面临这个问题时，我在HackerNews上询问别人是如何解决这个问题的。</p><p>社会人士提出了一些很好的建议和见解，而解决这个问题的最好办法似乎是签署密钥，我将在这里向大家详细介绍这一点。</p><p>粗略的想法是：您仍然为每个开发人员生成一个公钥-私钥对。但是，您不会将公钥上传到您的服务器。</p><p>相反，您可以使用之前生成的所谓的证书颁发机构(CA)密钥对公钥进行签名。此签名只生成第三个证书文件，您将该文件返回给开发人员，开发人员将其放在私钥和公钥旁边的.ssh/文件夹中。</p><p>在服务器上，您只需告诉服务器您的CA的公钥，服务器就可以检测用户是否具有正确签名的证书，并且只允许拥有此类签名证书的开发人员访问。</p><p>签署证书时，您可以确定该签名的有效期。因此，如果您签署的有效期为3个月，而开发人员离开了公司，那么在3个月之后，他们肯定无法访问任何服务器。</p><p>现在你会说：嗯，但是我不想每3个月签一次每个人的钥匙，这是一个公平的观点。</p><p>一种可能性是自动化该过程，例如，通过构建一个服务，用户在使用公司电子邮件和密码授权时可以自动获得签名证书，但这超出了本文的讨论范围。</p><p>另一种简单的选择是，您签发有效期更长的证书，然后如果有人离开公司，您可以吊销证书，即使其无效。您可以在服务器上放置一个无效证书列表，而服务器将不再接受该用户。例如，可以通过在AWS S3或其他一些存储上放置此列表，并在每台定期拉取此证书的服务器上设置cronjob来实现此目的。</p><p>首先，您生成一个证书颁发机构公钥-私钥对，其中的私钥应该非常安全：</p><p>Umask 77#您希望它是private kdir~/my-ca&amp；&amp；cd~/my-caSSH-keygen-C ca-f ca-b 4096#请确保使用密码并将其安全存储。</p><p>然后，在您的服务器上指定允许您的CA签名的所有用户访问该服务器：</p><p>通过在/etc/ssh/sshd_config中添加一行，告诉服务器允许由其签名的用户访问：</p><p>要使更改生效，您应该重新加载ssh服务：sudo服务ssh reload。</p><p>现在，如果开发人员生成了他们的公钥-私钥对(例如，ssh-keygen-tecdsa-b521)，他们只需向您发送他们的公钥(请注意，您永远不需要发送任何私钥！)。然后，您可以签署他们的公钥来生成他们的证书：</p><p>#在~/my-ca文件夹中，签署其公钥(此处：id_ecdsa.pub)ssh-keygen-s ca-i USER_ID-V+12w-z 1 id_ecdsa.pub。</p><p>-V+12w-证书过期前多长时间-此处有效期为12周。</p><p>-z 1-此证书的序列号-可用于以后使此特定证书无效，应该是唯一的。</p><p>它将生成证书id_ecdsa-cert.pub，您可以将其发送给开发人员，开发人员将其放入公钥-私钥对旁边的~/.ssh文件夹。</p><p>您的开发人员可能有不同的经验、不同的团队和角色，而且不是每个人都访问相同的服务器。</p><p>这样，您就可以在服务器上指定允许哪些角色访问服务器，并在签名过程中指定要签名的开发人员的角色。</p><p>当你加入一个新的开发人员时，你只需要生成一个证书，然后他们就可以访问所有相关的服务器，而不需要在这些服务器上添加任何东西。</p><p>首先，创建要配置访问权限的文件夹：sudo mkdir/etc/ssh/auth_projecals在该文件夹中，您可以使用服务器用户的名称创建文件，用户可以使用该名称登录。例如，要向某些角色授予root访问权限，请添加文件/etc/ssh/auth_projecals/root。</p><p>在/etc/ssh/auth_projecals/root中，您只需列出应该能够以root身份登录的所有角色，每行一个角色：</p><p>最后，通过在/etc/ssh/sshd_config中再次添加一行，在服务器上配置为使用角色：</p><p>要使更改生效，您应该重新加载ssh服务：sudo服务ssh reload。</p><p>这是使用角色对密钥进行签名的方式(角色将被添加到证书中)：</p><p>它与前面相同，但是使用了-nROLE1、ROLE2标志。重要提示：不同角色的逗号之间不能有空格！</p><p>现在，开发人员可以登录到任何服务器，其中ROLE1或ROLE2在auth_projecals文件中，以获得他们试图登录的用户名。</p><p>最后，如果希望使证书无效，可以通过用户名或证书序列号(-z标志)来执行此操作。建议在Excel电子表格中列出生成的证书列表，或者根据窥视次数建立数据库。</p><p>这是当您已经有一个已撤销的密钥列表并想要更新它的时候(-u标志)。对于初始生成，请在不带更新标志的情况下使用它。</p><p>要撤销的列表需要由用户名(ID)或序列号(生成期间的-z标志)组成，如下所示：</p><p>这将撤销对序列号为1的证书和ID为test.user的所有证书的访问。</p><p>要让服务器尊重已撤销的密钥，您需要将生成/更新的已撤销密钥文件添加到/etc/ssh/revoked-key中，并在/etc/ssh/sshd_config中重新配置：</p><p>警告：请确保吊销的密钥文件是可访问和可读的，否则可能会失去对服务器的访问权限。</p><p>在我看来，这个解决方案是最好的。您可以选择根据角色通过ssh管理对服务器的访问。您只需配置您的服务器一次(允许哪些角色访问它)。对于每个新开发人员，您只需要生成签名证书，他们就可以立即访问与其角色/经验匹配的所有相关计算机。当他们离开公司时，您还可以通过简单的方式撤销他们的访问权限。</p><p>而且，即使发生意外，开发人员在访问权限没有被撤销的情况下离开，他们的证书也会在一段时间后过期，因此他们也会自动失去访问权限。</p><p>对于小型团队，您可以手动完成这些步骤，因为它们的执行速度非常快；然后，随着您的发展，您可以根据公司身份验证详细信息使用登录服务自动执行证书签名。</p><p>由Disqus提供支持的评论</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.paepper.com/blog/posts/how-to-properly-manage-ssh-keys-for-server-access/">https://www.paepper.com/blog/posts/how-to-properly-manage-ssh-keys-for-server-access/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/用于/">#用于</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/manage/">#manage</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/服务器/">#服务器</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1026145.html"><img src="http://img2.diglog.com/img/2020/9/thumb_1c8c2396c163ddb4444d6f1c648b9e59.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1026145.html">SCC-用于DOS的小型C编译器</a></div><span class="my_story_list_date">2020-9-24 21:24</span></div><div class="col-sm"><div><a target="_blank" href="/story/1025829.html"><img src="http://img2.diglog.com/img/2020/9/thumb_6cb8c62d35296d178170d5d06471ffc7.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1025829.html">Mono Icons-寻找关于一组新图标的反馈-(开源和免费)</a></div><span class="my_story_list_date">2020-9-23 18:53</span></div><div class="col-sm"><div><a target="_blank" href="/story/1025312.html"><img src="http://img2.diglog.com/img/2020/9/thumb_bcf94ba346d567aecdf73449ce32c4f6.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1025312.html">Sktime：用于时间序列机器学习的统一Python工具箱</a></div><span class="my_story_list_date">2020-9-21 19:54</span></div><div class="col-sm"><div><a target="_blank" href="/story/1024807.html"><img src="http://img2.diglog.com/img/2020/9/thumb_14f822995e29d469d117d0668d0e1b77.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1024807.html">OpenSCAD--程序设计人员Solid 3D CAD Modeler</a></div><span class="my_story_list_date">2020-9-18 18:45</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>