<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>ESP32上的铁锈(2019年)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">ESP32上的铁锈(2019年)</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-05 20:55:04</div><div class="page_narrow text-break page_content"><p>大约六个月前，我在reddit上发了一篇帖子，强调Espressif&#39；的llvm xtensa fork的发布，不久之后，我就有了一个可以生成xtensa汇编的rustc工具链。在这一点上，我不得不将这个项目搁置一边，以完成我的大学最后一年。有趣的是，我没有离题太远，我最后一年的项目使用铁锈制造了一款智能手表(如果有人感兴趣，我将来可能会写到这一点)。</p><p>从那以后，我看到一些帖子使用我的fork在ESP32上运行Rust(如果你还没有看到ctron写的这篇很棒的文章)，其中大多数都是在用C编写的esp-idf之上构建的。在这篇帖子中，我将讨论我使用rustc为xtensa体系结构生成有效二进制文件的步骤，然后编写一些no_std代码，以便只使用Ruust！为ESP32构建一个闪烁的程序！(请参阅ctron撰写的这篇很棒的文章)，在这篇文章中，我将讨论我使用rustc为xtensa体系结构生成有效二进制文件的步骤，然后编写一些no_std代码，以便仅使用Rust！为ESP32构建一个闪烁的程序。</p><p>2019年3月，Espressif发布了他们在支持xtensa架构的llvm分支上的第一次运行。不久之后，我开始用Bootstrapping Rust来使用这个新创建的叉子。在这个项目之前，我没有使用编译器的经验，幸运的是我遇到了RISCV PR，它让我对所需的东西有了一个大致的了解。经过多次构建尝试，我终于让它正常工作了；我现在能够从Rust源代码生成xtensa程序集了！</p><p>下一步是组装并链接生成的程序集。处于当前状态的llvm fork不能执行对象生成，因此我们必须使用外部汇编器。幸运的是，Rust允许我们这样做，方法是将LINKER_AMESS指定为GCC，并使用链接器目标选项提供到链接器的路径，在本例中为xtensa-esp32-ELF-GCC。之后，我创建了几个内置目标(您可以在这里看到)；xtensa-esp32-None-ELF用于ESP32；xtensa-ESP8266-None-ELF用于ESP8266；最后xtensa-UNKNOWN-NONE-ELF目标用于通用的xtensa目标。</p><p>现在，让我们尝试让ESP32电路板仅使用铁锈来闪烁板载LED。首先，我们需要基本的程序结构。xtensa_lx6_rt板条箱完成了这方面的大部分繁重工作，我们只需要定义一个入口点和死机处理程序。其中一些可能看起来有点眼熟，如果你在Rust上有任何皮层-m开发的经验，我已经尽我所能地镜像了API。</p><p>#！[no_std]#！[no_main]Use xtensa_lx6_rt as_；use core：：Panic：：PanicInfo；/入口点-初始化后由xtensa_lx6_rt调用#[no_manger]FN main()-&gt；！{loop{}}/简单死机处理程序#[Panic_Handler]FN PanicInfo(_info：&amp；PanicInfo)-&gt；！{loop{}。</p><p>现在，让我们为要使用的外围设备添加一些寄存器定义。对于闪烁的程序，我们需要控制GPIO外围设备。在ESP32(和大多数现代处理器)中，外围设备映射到内存地址，通常称为内存映射外围设备。要控制外设，我们只需根据芯片制造商提供的参考手册将值写入存储器中的正确地址。</p><p>/GPIO输出启用REG CONST GPIO_ENABLE_W1TS_REG：U32=0x3FF44024；/GPIO输出设置寄存器CONST GPIO_OUT_W1TS_REG：U32=0x3FF44008；/GPIO输出清除寄存器CONST GPIO_OUT_W1TC_REG：U32=0x3FF4400C；/连接到板载LED CONST BE的GPIO。const GPIO_FUNX_OUT_SEL_CFG：u32=GPIO_FUNX_OUT_BASE+(Blinky_GPIO*4)；</p><p>使用这些定义，应该可以通过更改Blinky_GPIO来更改主板1的GPIO；对于我的主板(NODEMCU ESP-32S)，它是GPIO2。</p><p>接下来，让我们将引脚设置为GPIO输出。对于ESP32，这是一个两步过程1。首先，这只是设置GPIO输出使能寄存器中的一个位的情况。其次，引脚必须配置为GPIO模式。芯片中所有可能的外围设备都没有足够的引脚，为了解决这个问题，每个引脚可以有多种功能模式。在ESP32的情况下，每个引脚具有多达256个不同的功能，尽管并非所有引脚都被映射。要将引脚置于GPIO模式，需要将其置于模式256(0x100)，方法是写入功能选择寄存器。发出这两个寄存器写入后，我们应该能够通过设置GPIO设置寄存器2内的相关位来打开GPIO。</p><p>#[NO_MANGLE]FN Main()-&gt；！{//将引脚配置为输出不安全{CORE：：PTR：：WRITE_VOLILAR(GPIO_ENABLE_W1TS_REG AS*MUT_，0x1&lt；&lt；Blinky_GPIO)；//0x100使此引脚成为简单的GPIO引脚-有关更多信息，请参阅技术参考CORE：：PTR：：WRITE_VARILAR(GPIO_FUNX_OUT_SEL。}//打开LED不安全{CORE：：PTR：：WRITE_VILAR(GPIO_OUT_W1TS_REG AS*mut_，0x1&lt；&lt；idx)；}LOOP{}}。</p><p>对于闪烁程序的下一阶段，我们需要一种延迟的方法；一种简单的方法可以使用for循环，如下所示。</p><p>发布FN延迟(时钟：u32){let ummy_var：u32=0；for_in 0..时钟{不安全{core：：ptr：：read_volatile(&amp；ummy_var)}；}}。</p><p>我们添加了易失性读取，这样编译器就不会优化我们的延迟。这种方法的问题在于，根据优化级别的不同，循环的每次迭代的时钟周期数都会改变。我们需要一种周期精确的延迟方式，幸运的是，ESP32有一个内部时钟计数寄存器，可以通过读取专用寄存器RSR指令访问该寄存器。现在的延迟函数是这样的。</p><p>/使用周期计数器寄存器pub FN Delay(时钟：u32)进行周期精确延迟{//注意：不考虑翻转//省略：ASM读取时钟let target=get_ccount()+时钟；loop{if get_ccount()&gt；target{Break；}}。</p><p>现在我们有了精确的周期计数，我们可以通过等待处理器在一秒内执行的周期数来延迟一秒。大多数ESP板上的默认时钟速度为40 MHz，因此等待4000万个周期相当于一秒的延迟。</p><p>将代码片段放在一起并将代码清理成函数，我们现在就有了如下所示的Main。</p><p>#[NO_MANGLE]fn main()-&gt；！{//将管脚配置为输出configure_pin_as_output(Blinky_GPIO)；loop{set_led(Blinky_GPIO，TRUE)；DELAY(CORE_HZ)；SET_LED(Blinky_GPIO，FALSE)；DELAY(CORE_HZ)；}}。</p><p>在向电路板闪烁并启动我们的JTAG调试器3之后，我们看到一个闪烁的LED！</p><p>如果您想亲自尝试一下，可以在xtensa快速入门资源库中找到完整的源代码。</p><p>现在我知道你们大多数人现在在想什么，它不是很生锈；它包含了成堆的不安全因素，这里没有真正的抽象，你们是对的；但它是让球滚动起来的东西。</p><p>有一些小的初期问题，但是到目前为止最大的问题是fork很难生成调试信息；外部汇编程序不支持CFI指令，这是所有llvm目标都需要支持的。通过一些预处理可以很容易地删除CFI指令，但是当然会增加一个额外的步骤。在解决了这个问题之后，我仍然收到重新定位链接器错误。我开了一期来记录我的发现，希望它能在下一次的llvm fork迭代中被分类。</p><p>一旦调试信息问题得到解决，我希望开始开发一个由HAL和驱动程序组成的生态系统，类似于STM32-RS和NRF-RS；我已经启动了ESP-RS组织，这也是xtensa-lx6-rt目前所在的组织。Espressif已经启动了上游过程，前十个补丁现在正在审核中，他们的分支应该会有一个更新，从旧的llvm6升级到llvm8(希望还会有一些其他的补充和修复！)。</p><p>1请注意，这仅适用于GPIO 0至31，其余的GPIO使用不同的寄存器。</p><p>2如果LED连接的引脚未默认为正确的IOMUX功能，情况并不总是如此，有关详细信息，请参阅快速入门示例。</p><p>3这一步实际上非常重要，目前主板将在引导时无休止地重置(我假设是因为看门狗没有被禁用)，但是使用调试器启动可以正常工作。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://mabez.dev/blog/posts/esp32-rust/">https://mabez.dev/blog/posts/esp32-rust/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/esp32/">#esp32</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/gpio/">#gpio</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1009840.html"><img src="http://img.diglog.com/img/2020/7/thumb_54587e731f148e21e100a134f51ef8dc.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1009840.html">回到老把戏，或者说，生锈的婴儿步</a></div><span class="my_story_list_date">2020-7-5 2:11</span></div><div class="col-sm"><div><a target="_blank" href="/story/1009787.html"><img src="http://img.diglog.com/img/2020/7/thumb_fcd8781943618c6566442ee43c80e0e1.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1009787.html">Linus Torvalds谈多样性、长寿、生锈和ARM芯片</a></div><span class="my_story_list_date">2020-7-4 17:51</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008980.html"><img src="http://img.diglog.com/img/2020/6/thumb_1c2d3b30300916aac9a67d3f86ba8a1c.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008980.html">视频聊天短路，这是信任必不可少的大脑功能</a></div><span class="my_story_list_date">2020-6-30 21:35</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008952.html"><img src="http://img.diglog.com/img/2020/6/thumb_63abb9829dd62f67d526ec3bc01f68e4.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008952.html">铁锈编译缓慢的几个原因</a></div><span class="my_story_list_date">2020-6-30 21:11</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>