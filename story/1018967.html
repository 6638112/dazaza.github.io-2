<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>如何在不创建数百个IAM用户的情况下授予对AWS资源的访问权限？</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">如何在不创建数百个IAM用户的情况下授予对AWS资源的访问权限？</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-19 02:51:29</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/8/53df4803033e144ff71baac3ea6e4cec.jpeg"><img src="http://img.diglog.com/img/2020/8/53df4803033e144ff71baac3ea6e4cec.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>假设您是一家拥有100多名销售员工的公司的解决方案架构师，您正在从内部部署迁移到AWS云。您希望使用现有的员工身份验证系统，并希望将员工在日常工作中使用的文件存储在S3上。您不想将S3存储桶公开，这会将所有文件公开给每个人。您有两个选项：</p><p>为所有员工创建具有S3存储桶访问权限和登录凭据的单一角色。有了这个，用户必须使用2个不同的登录。一个用于访问其现有系统，另一个用于访问S3文件。</p><p>使用AWS安全令牌服务(STS)承担具有S3访问权限的角色，并使用该角色授予对文件的访问权限。用户仍将使用其现有系统进行身份验证。</p><p>在这篇文章中，我们将探索并实现选项2。请注意，我们是在上一篇文章的基础上构建这个示例的。</p><p>AWS安全令牌服务(AWS STS)是一项Web服务，使您可以为AWS Identity and Access Management(IAM)用户或您验证的用户请求临时、有限权限凭据。您可以对STS使用AssumeRole操作，该操作返回一组临时安全凭据，您可以使用这些凭据来访问您通常可能无权访问的AWS资源。这些临时凭据由访问密钥ID、秘密访问密钥和安全令牌组成。通常，您在帐户内使用AssumeRole或用于跨帐户访问。在我们的示例中，我们在同一帐户中使用AssumeRole。</p><p>在我们的示例中，我们将创建一个名为S3ReadOnlyAccessAssumeRole的角色。顾名思义，它只有S3读访问策略。我们还将创建信任策略并附加到此S3角色。信任策略将允许此角色由我们的lambda执行角色承担。下面是我们的SAM在这个角色中的样子。</p><p>IamS3Role：Type：aws：：iam：：Role Properties：AssumeRolePolicyDocument：Version：2012-10-17语句：-Effect：允许主体：aws：！GetAtt ShowFilesFunctionRole.Arn操作：-&#39；sts：AssumeRole&#39；描述：&#39；Lamdba在运行时承担的只读S3角色&#39；ManagedPolicyArns：-arn:aws:iam：：aws:policy/AmazonS3ReadOnlyAccess角色名称。</p><p>在上面的代码片断中，AssumeRolePolicyDocument属性指定信任策略，该信任策略允许由原则aws：！GetAtt ShowFilesFunctionRole.Arn标识的Lamdba执行角色到此策略附加到的AssumeRole，即S3ReadOnlyAccessAssumeRole。ManagedPolicyArns属性指定S3ReadOnlyAccessAssumeRole的策略，该策略允许对S3存储桶进行只读访问。</p><p>现在，让我们编写将使用此角色的Lamdba处理程序。这是SAM的认证书。</p><p>ApiGatewayShowFilesApi：type：aws：：Serverless：：API Properties：Stagename：Prod Auth：UsagePlan：CreateUsagePlan：Per_API Description：此API的使用计划配额：Limit：500 Period：Month Throttle：BurstLimit：100 RateLimit：50 ShowFilesFunction：Type：Aws：：Serverless：：Function Properties：Environment：Variables：UserTable：！ref myDynamoDBTable s。：！ref myDynamoDBTable事件：getCounter：Type：API属性：Path：/showFiles方法：获取RestApiId：！ref ApiGatewayShowFilesApi。</p><p>我们在这里定义了几个参数，它们将被设置为Lambda的环境变量。使用Origin，我们指定CORS的原始域。这是我们的S3存储桶的虚拟托管风格的URL。FilesBucket是存储文件的存储桶。在无服务器函数定义中，它使用showfiles.py作为lambda处理程序。函数具有使用DB的权限。我们还使用path/showFiles为这个Lamdba创建了API。</p><p>让我们看看我们在Lambda处理程序中做了什么。我们修改了上一篇文章中的login.py lambda处理程序。一旦用户通过身份验证，我们将设置Cookie。这是完全可选的，并且确实不是STS工作所必需的，但是您可能需要某种系统来识别该用户是否已经通过身份验证。</p><p>如果deccryptedPass==pwd：Token=Secrets.Token_hex(16)Response=table.update_item(key={&#39；userid&#39；：uname}，AttributeUpdate={&#39；Token&#39；：{&#39；value&#39；：Token，}})返回{&#39；statusCode&#39；200，&#39；Header&#39；：{&#39；Set-Cookie。&amp；+Token+&#39；；Secure；SameSite=None；HttpOnly；Domain=.amazonaws.com；Path=/&#39；，&#39；内容类型&#39；：&#39；Text/html&#39；}，&#39；Body&#39；：&#39；&lt；html&gt；&lt；head&gt；&lt；script&gt；window.location.href=\&#39；&#39；+os.environ[&#39；showFilesUrl&#39；]+&#39；\&#39；&lt；/script&gt；&lt；/head&gt；&lt；body&gt；Hello&lt；/body&gt；&lt；/html&gt；&#39；}否则：响应[&#39；状态&#39；]=&#39；登录失败&#39；返回{&#39；状态代码&#39；：200，&#39；主体&#39；：json.dump(响应)}。</p><p>当用户提交用户名和密码时，Login lambda处理程序将对用户进行身份验证，将唯一ID存储在数据库中，设置cookie以响应位置以显示S3存储桶中的showFiles url html页面。在页面加载时，浏览器会将位置更改为showfiles url，这将触发showFiles.py中定义的showFiles Lambda处理程序。</p><p>文件访问系统文件正在加载..。FETCH(&#34；https://9nimlkmz74.execute-api.us-east-2.amazonaws.com/Prod/showFiles/&#34；，{Credentials：&#39；Include&#39；}).Then(Response=&&gt;；response.text()).Then((Body)=&gt；{var files=&#34；；var obj=JSON.parse(Body)for(i=0；i&lt；obj.length；i++){FILES=FILES+&#34；&lt；I class=&#39；&gt；&lt；a href=&#39；#&#39；&gt；&amp；nbsp；&amp；nbsp；&#34；+obj[i]+&#34；&lt；/a&gt；&34；}Document.getElementById(&#34；Files&#34；).innerHTML=FILES}).catch(函数(错误){控制台日志(错误)；})；</p><p>我们调用showFiles API，它从S3存储桶中获取文件列表并显示在页面上。</p><p>Import json import Logging import boto3 import oslog=logging.getLogger()log.setLevel(logging.info)#返回登录cookie信息userid和唯一令牌def(Cookies)：cookie中x的data={}if keyValue[0].strie()==&#39；tkn&#39；：cookieValue=keyValue[1]t。]=tKnValues[0]DATA[&#39；TKN&#39；]=tKNALUES[1]ELSE：cookieValue=&#39；&#39；return data#验证保存在数据库中的唯一令牌与请求def(Data)中的令牌：DynamoDB=boto3.resource(&#39；DynamoDB&#39；)table=dynamic odb.Table(os.environ[&#39；userTable&#39；])response=table.get_item(。]})json_str=json.dump(Response[&#39；Item&#39；])resp_dict=json.loads(Json_Str)内标识=resp_didic.get(&#34；Token&#34；)return bool(Token==data[&#39；TKN&#39；])#使用STS def()返回存储桶中的文件列表：sts_client=boto3.client(&#39；STS&#39。)#调用STSConnection对象的Asmise_Role方法，并传递角色#ARN和角色会话名称。Assumed_Role_Object=STS_client.Assumed_Role(RoleArn=os.environ[&#39；s3ole&#39；]，RoleSessionName=&#34；AssumeRoleSession1&#34；)#从包含假定角色的响应中获取可用于进行后续API调用的临时#凭据Credentials=AssumeRole_Object[&#39；Credentials&#39；]#使用AssumeRole返回到的临时凭据。AccessKeyId&#39；]，AWS_SECRET_ACCESS_KEY=Credentials[&#39；SecretAccessKey&#39；]，AWS_SESSION_TOKEN=Credentials[&#39；SessionToken&#39；]，)bucket=s3_resource ce.Bucket(os.environ[&#39；filesBucket&#39；])bucket中obj的files=[]。objects.all()：files.append(obj.key。Cookie&#39；].Split(&#34；；&#34；)Data=getLoginCookie(Cookie)isVerify=verifyLogin(Data)if(IsVerify)：Response=getFilesList()Return{&#39；statusCode&#39；：200，&#39；Header&#39；：{&#39；Content-Type&39；：&#39；Application/json&39；，&#39；Access-Control-Allow-Origin&#39；：os.environ[&#39；Origin&。]，&#39；Access-Control-Allow-Credentials&#39；：&#39；true&#39；}，&#39；body&#39；：json.dump(Response)}。</p><p>这里关注lamdba_handler函数。我们首先获得cookie并验证登录。如果经过验证，我们将调用getFilesList函数，STS的魔力就是在这里发生的。我们从Lambda环境变量中获得要假定的角色的ARN。ASSUME_ROLE函数返回包含访问密钥ID、秘密访问密钥和会话令牌的凭据。您可以使用此凭据获取S3资源并访问存储桶。我们以数组的形式创建文件列表，并将其作为响应发送。</p><p>在运行SAM Deploy之前，创建一个S3存储桶来存储html文件。在我们的例子中，它是stsexamplebucket。我们在SAM模板中使用此存储桶中的URL。在SAM Deploy上，它将生成带有3个API URL的输出。修改html文件以指向这些URL并上传到S3存储桶。一定要把那些文件公之于众。</p><p>您需要使用SAM模板中FilesBucket参数中指定的名称创建一个Bucket。此存储桶将存储文件以供显示。</p><p>总之，我们使用了一个自定义身份代理来对用户进行身份验证，然后使用AWS STS来允许这些用户访问AWS资源。您可能会想，我们是否可以将访问S3的权限授予Lambda执行角色，而不是使用STS。你当然可以，而且它会奏效的。但这里的想法是使用sts，您可以使用sts而不考虑lambda，即在您的其他应用程序中使用sts，如Spring boot、java、python应用程序等。在下一篇文章中，我们将进一步扩展这一点，使用s3签名的url来访问存储在s3中的文件。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.rajanpanchal.net/how-to-give-access-to-aws-resources-without-creating-100s-of-iam-users-ckds91qj100pf97s1gc3v8vwb">https://blog.rajanpanchal.net/how-to-give-access-to-aws-resources-without-creating-100s-of-iam-users-ckds91qj100pf97s1gc3v8vwb</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/access/">#access</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/s3/">#s3</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1015740.html"><img src="http://img.diglog.com/img/2020/8/thumb_423ac761be952f184aa49f26eab2b79c.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1015740.html">文件显示，国土安全部可以获得波特兰抗议者的信息</a></div><span class="my_story_list_date">2020-8-2 14:42</span></div><div class="col-sm"><div><a target="_blank" href="/story/1015288.html"><img src="http://img.diglog.com/img/2020/7/thumb_77168b112742cc1ee07ea310c5fe5e08.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1015288.html">
CBS All Access在2021年更名之前增加了3500集新剧集</a></div><span class="my_story_list_date">2020-7-31 4:32</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003855.html"><img src="http://img.diglog.com/img/2020/5/thumb_80f7d5a82b427f9b94efb32151e90764.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003855.html">无需花费数小时即可轻松访问前端的AWS基础设施</a></div><span class="my_story_list_date">2020-5-27 6:40</span></div><div class="col-sm"><div><a target="_blank" href="/story/1000225.html"><img src="http://img.diglog.com/img/2020/5/thumb_6f812cf55b4ad05940b2f7cddbfdb7e6.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1000225.html">如何SSH进入自动驾驶卡车</a></div><span class="my_story_list_date">2020-5-2 18:0</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>