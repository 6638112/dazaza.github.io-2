<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>使用system.io.pipelines在c＃中的性能助推器 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">使用system.io.pipelines在c＃中的性能助推器 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-06-04 01:34:36</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/6/5f9666d0130a96ba0eeb79c5eb30073b.png"><img src="http://img2.diglog.com/img/2021/6/5f9666d0130a96ba0eeb79c5eb30073b.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>由于我们的行业已接受处理包括容器（读为K8S）或无服务器的生产工作负载的新策略或无服务器（作为服务的函数读取），开发人员没有在生产环境中具有无限制的计算资源的奢侈。那些日子已经消失，可以轻松获取具有许多核心和高内存的大型虚拟机，以进行应用程序部署需求。作为.NET开发人员虽然您使用托管代码而且您依赖GC（垃圾收集器）进行作业，但ONU现在正在编写高度性能的代码，该代码可以从Docker容器到IoT设备的任何位置运行。随着C＃8和.NET核心的出现，Microsoft .NET团队一直非常认识到内存分配。每个新版本都配有现代API，可以将应用程序的性能提高到与旧版传统API的旧版。在此博客文章中，我将以3种不同的技术展示文件I / O操作，并将对每个技术进行基准。从基准测试结果，System.io.pipelines在执行和内存分配时都会非常明显。</p><p>  我们将尝试阅读员工数据的大型CSV文件（具有5个字段的10万条记录）。我相信您必须在您的职业生涯中遇到此挑战，在那里您必须解析大型CSV文件。这一挑战在GC上创造了足够的压力。垃圾收集周围的考虑因素时尤为重要。这是因为垃圾收集占用CPU时间，减少了在实际数据处理上花费的时间。不仅如此，而且每次触发垃圾收集时，都会暂停大部分工作，以便可以评估其余的引用。这可以大大影响处理数据所需的时间量。我为这一挑战选择了三种技术。</p><p> 使用CSVhelper：这是一个流行的库，用于在.NET生态系统中解析CSV文件。</p><p> 使用IASyncenumerable：从C＃8引入此API，其中可以处理数据流（数据块）而不是整个文件。</p><p> 使用system.io.pipelines：此API已使用.NET Core 2.1附带，并且由Kestrel，用于ASPNet核心的Web服务器内部用于高性能，以处理从套接字收到的每秒的许多请求。它可以作为Nuget包下载.David福勒，他们将这些API归档为其介绍的优秀帖子。</p><p> 我的github repo上有此帖子的源代码。 Repo还包括具有基准结果的测试。</p><p>   进入点公共方法是processFileAsync，它创建了Pipereader类的实例，它读取该数据并转换为缓冲区，这是readonlysequence的数据类型＆lt; byte＆gt; 。然后将该缓冲区数据传递给Parselines方法作为参考，以及Pipereader的位置，其具有0值，因为它处于开始位置。 Parselines方法尝试使用换行符导航新行作为分隔符。此过程继续到达牵引液位器的最终位置。解析完成后，完成牵引位置直到缓冲器的末端，标记为加工（线号35和43）。 </p><p>实际数据处理在Parstine方法中的静态类LineParser中进行，在省略CSV文件的标题行之后，它尝试通过查找＆＃34来捕获每个字段数据值;，＆＃34;位置，然后尝试使用索引偏移和范围模式使用UTF8编码提取字符串值。每个字段一个接一个地处理，并且由FieldCount变量跟踪。</p><p>   创建员工类型的ArrayPool。 Arraypool＆lt; t＆gt;是一个高性能的托管阵列。它是一个带有自定义最大长度的线程安全池。</p><p> 接下来的事情是调用租金方法，该方法要求您指定缓冲区的最小长度。请记住，租金返回可能比您所要求的更大。</p><p> 一旦使用它，您只需将其返回到同一个池中。返回方法具有过载，允许您清理缓冲区，因此通过租金后续消费者不会看到以前的消费者的内容。默认情况下，内容不变。</p><p>  表{边界崩溃：崩溃;显示：块;宽度：100％;溢出：自动; TD，TH {填充：6px 13px;边框：1px solid #ddd;文字对齐：右; } tr {背景 - 颜色：#fff;边界 - 顶部：1px solid #ccc; } TR：nth-​​child（偶数）{背景：＃f8f8f8; } BenchmarkDotnet = V0.13.0，OS = MacOS Big Sur 11.4（20F71）[达尔文20.5.0]英特尔酷睿I9-9880H CPU 2.30GHz，1 CPU，16逻辑和8物理核心网= 5.0.203 [主机] ：.Net 5.0.6（5.0.621.22011），x64 ryujit defaultjob：.Net 5.0.6（5.0.621.22011），x64 ryujit</p><p>   由于来自上述Pipelines方法，方法是清晰的赢家，它刚刚拍摄了143.1毫秒来处理数据，只需44 MB的内存分配 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://goldytech.wordpress.com/2021/05/31/performance-booster-with-system-io-pipelines-in-c/">https://goldytech.wordpress.com/2021/05/31/performance-booster-with-system-io-pipelines-in-c/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/性能/">#性能</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/c#/">#c#</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/booster/">#booster</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/方法/">#方法</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1062884.html"><img src="http://img2.diglog.com/img/2021/5/thumb_766cd6c3269d4d9d1b17ad9c4447da8b.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1062884.html">基于RC应用的基于STM32 / ESP32 / ESP8285的高性能无线电链路 </a></div><span class="my_story_list_date">2021-5-15 23:52</span></div><div class="col-sm"><div><a target="_blank" href="/story/1062388.html"><img src="http://img2.diglog.com/img/2021/5/thumb_4de73dc5ec6d0d8b6d81f78ee3bf3925.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1062388.html">增加SSD的性能和生活 </a></div><span class="my_story_list_date">2021-5-13 13:44</span></div><div class="col-sm"><div><a target="_blank" href="/story/1062253.html"><img src="http://img2.diglog.com/img/2021/5/thumb_71f95fc72e2fe75130f7c9b3a3707d4a.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1062253.html">审查华硕的新Zenfone 8旗舰，可用于599- $ 799：周到和紧凑的设计，强大的构建和卓越的性能，但电池寿命平均 </a></div><span class="my_story_list_date">2021-5-13 2:40</span></div><div class="col-sm"><div><a target="_blank" href="/story/1061966.html"><img src="http://img2.diglog.com/img/2021/5/thumb_37cca5a8c63abbefef509f193201a61d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1061966.html">PPROF ++：具有硬件性能监控的GO Profiler </a></div><span class="my_story_list_date">2021-5-11 23:47</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>