<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Dockerfile安全最佳做法</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Dockerfile安全最佳做法</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-14 22:55:31</div><div class="page_narrow text-break page_content"><p>集装箱安全是一个广阔的问题空间，有许多低垂的果实可以收获，以降低风险。一个很好的起点是在编写Dockerfile时遵循一些规则。</p><p>我整理了一份常见安全问题的清单，以及如何避免这些问题。对于每个问题，我还编写了一个开放策略代理(Open Policy Agent，OPA)规则，可以使用conftest静态分析您的Dockerfile。你不能再往左移了！</p><p>您可以在此存储库中找到.rego规则集。我感谢反馈和贡献。</p><p>秘密分发是一个毛茸茸的问题，很容易弄错。对于容器化的应用程序，可以通过挂载卷从文件系统显示它们，也可以更方便地通过环境变量来显示它们。</p><p>使用ENV存储机密是不好的做法，因为Dockerfile通常是随应用一起分发的，所以在代码中与硬编码机密没有区别。</p><p>Secrets_env=[&#34；密码&#34；，&#34；密码&#34；，##34；密码&#34；，##34；密码&#34；，&#39；不能使用此密码&#34；密码&#34；，&#34；密钥&#34；，&#34；访问&#34；，&#34；api_key&#34；，&#34；apiKey&#34；，&#34；令牌&34；，&#34；TKN&#34；]DENY[msg]{input[i].Cmd==&#34；env&#34；val：=input[i].value包含(LOWER(val[_])，secrets_env[_])msg=sprintf(&#34；第%d行：在ENV密钥中找到潜在秘密：%s&#34；，[i，val])}}。</p><p>针对容器化应用的供应链攻击还将来自用于构建容器本身的层的层次结构。</p><p>主要的罪魁祸首显然是使用的基本图像。不受信任的基本映像风险很高，应尽可能避免。</p><p>Docker为最常用的操作系统和应用提供了一套官方基础镜像。通过使用它们，我们利用与Docker本身分担的某种责任，将危害风险降至最低。</p><p>拒绝[msg]{input[i].Cmd==&#34；from&#34；val：=Split(input[i].value[0]，&#34；/&#34；)count(Val)&gt；1 msg=sprintf(&#34；第%d行：使用受信任的基本映像&#34；，[i])}}。</p><p>此规则针对DockerHub的官方图片进行调整。这非常愚蠢，因为我只检测到名称空间的缺失。</p><p>固定基础映像的版本将使您在构建的容器的可预测性方面获得一些安心。</p><p>如果您依赖于LATEST，您可能会静默继承更新的包，在最坏的情况下可能会影响您的应用程序的可靠性，在最坏的情况下可能会引入漏洞。</p><p>拒绝[msg]{input[i].Cmd==&#34；From&#34；val：=Split(Input[i].value[0]，&#34；：&#34；)包含(LOWER(VAL[1])，&#34；LATEST&#34；])msg=spintf(&#34；第%d行：不要对基本图像使用&#39；LATEST&#39；标记&#34；，[i])}。</p><p>从互联网上拉东西，然后把它们输送到一个外壳里，这是最糟糕的事情了。不幸的是，这是一种广泛使用的简化软件安装的解决方案。</p><p>供应链攻击的风险也是如此，归根结底是信任。如果你真的要卷曲狂欢，那就做对了：</p><p>拒绝[消息]{Input[i].Cmd==&#34；Run&#34；val：=Concat(&#34；&#34；，Input[i].value)匹配：=regex.find_n(&#34；(curl|wget)[^|^&gt；]*[|&gt；]&#34；，下限(Val)，-1)计数(匹配)&gt；0消息=短跑(&#34；行%d：避免卷曲打击&#34；，[i])}。</p><p>这可能有点牵强，但理由如下：您希望固定软件依赖项的版本，如果您执行apt-get升级，您将有效地将它们全部升级到最新版本。</p><p>如果您进行了升级，并且使用的是基本映像的最新标记，则会放大依赖关系树的不可预测性。</p><p>您要做的是固定基本映像版本，然后只更新apt/apk。</p><p>UPGRADE_COMMANDS=[&#34；apk Upgrade&#34；，&#34；apt-get Upgrade&#34；，&#34；，]Deny[msg]{input[i].Cmd==&#34；run&#34；val：=Concat(&#34；&#34；，input[i].value)包含(val，Upgrade_Commands[_])msg=sprintf(“行：%d：不升级系统包&#34；，[i])}。</p><p>Add命令的一个小功能是，您可以将其指向远程url，它将在构建时获取内容：</p><p>从安全的角度来看，同样的建议也适用：不要。在获取您需要的任何内容之前，对其进行验证，然后复制。但是，如果您真的必须这样做，请使用受信任的来源，而不是安全的连接。</p><p>注意：如果您有一个可以动态生成Dockerfile的奇特构建系统，那么Add实际上就是一个请求利用的接收器。</p><p>拒绝[msg]{input[i].Cmd==&#34；add&#34；msg=sprintf(&#34；第%d行：使用复制而不是添加&#34；，[i])}。</p><p>容器中的root与主机上的root相同，但受docker守护进程配置的限制。不管有什么限制，如果一个演员冲出了容器，他仍然能够找到一种方法来完全访问主持人。</p><p>当然，这并不理想，您的威胁模型不能忽略以root身份运行所带来的风险。</p><p>请注意，在Dockerfile中显式设置用户只是一层防御措施，并不能解决以根用户身份运行的整个问题。</p><p>相反，我们可以(也应该)采用纵深防御方法，并在整个堆栈中进一步缓解：严格配置docker守护进程或使用无根容器解决方案，限制运行时配置(如果可能，则禁止--特权，等等)，等等。</p><p>Any_user{input[i].Cmd==&#34；user&#34；}拒绝[msg]{不是any_user msg=&#34；不要以root身份运行，改用user&#34；}。</p><p>即使您以用户身份运行，也要确保该用户不是sudoers俱乐部的成员。</p><p>拒绝[msg]{input[i].Cmd==&#34；run&#34；val：=Concat(&#34；&#34；，input[i].value)包含(较低(Val)，&#34；sudo&#34；)msg=spintf(&#34；行%d：请勿使用&#39；sudo&#39；命令&#34；，[i])}</p><p>这幅作品受到了马杜·阿库拉的启发，是对马杜·阿库拉现有技术的迭代。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://cloudberry.engineering/article/dockerfile-security-best-practices/">https://cloudberry.engineering/article/dockerfile-security-best-practices/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/docker/">#docker</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/security/">#security</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1026303.html"><img src="http://img2.diglog.com/img/2020/9/thumb_cc5bfb0230e49dc3bc3bb7680f205cd9.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1026303.html">简单的WireGuard Docker网络设置</a></div><span class="my_story_list_date">2020-9-25 5:32</span></div><div class="col-sm"><div><a target="_blank" href="/story/1023393.html"><img src="http://img2.diglog.com/img/2020/9/thumb_4b1e079520b716db8d5b43146ede3545.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1023393.html">使用conda-pack缩小您的Conda Docker映像</a></div><span class="my_story_list_date">2020-9-12 2:50</span></div><div class="col-sm"><div><a target="_blank" href="/story/1020098.html"><img src="http://img.diglog.com/img/2020/8/thumb_f50cf7950020549f7a8c734cdfd9993d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1020098.html">Docker to Rate Limit镜像拉取</a></div><span class="my_story_list_date">2020-8-25 8:40</span></div><div class="col-sm"><div><a target="_blank" href="/story/1019350.html"><img src="http://img.diglog.com/img/2020/8/thumb_23b15fc551a88bd6c3b96cf317281423.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019350.html">深入研究Python的官方Docker图像</a></div><span class="my_story_list_date">2020-8-20 21:45</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>