<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Docker可以减慢您的代码并扭曲您的基准测试 Docker can slow down your code and distort your benchmarks</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Docker can slow down your code and distort your benchmarks<br/>Docker可以减慢您的代码并扭曲您的基准测试 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-05-13 05:11:13</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/5/210f6642406835fee01f80ba9195e223.png"><img src="http://img2.diglog.com/img/2021/5/210f6642406835fee01f80ba9195e223.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>One of the benefits of containers over virtual machines is that you get some measure of isolation without the performance overhead or distortion of virtualization.Docker images therefore seem like a good way to get a reproducible environment for measuring CPU performance of your code.</p><p>容器在虚拟机上的一个好处是，在没有虚拟化的性能开销或失真的情况下获得一些隔离衡量标准。因此，Docker图像似乎是获得用于测量代码的CPU性能的可再现环境的好方法。</p><p> There are, however, complications. Sometimes, running under Docker can actually slow down your code and distort your performance measurements.</p><p> 但是，并发症。有时，在Docker下运行实际上可以减慢代码并扭曲您的性能测量。</p><p> On macOS and Windows, for example, standard Linux-based Docker containers aren’t actually running directly on the OS, since the OS isn’t Linux.And the image filesystem from the container itself is typically mounted with some sort of overlay filesystem, which can slow things down, so for anything I/O bound you want to use a bind-mounted volume.</p><p> 例如，在MacOS和Windows上，标准的基于Linux的Docker容器实际上并不直接在OS上运行，因为OS不是Linux。来自容器本身的图像文件系统通常使用某种覆盖文件系统，这可以减慢速度，因此对于您想要使用绑定安装的卷的任何I / O键。</p><p> But even on Linux, with seeminly CPU-only workloads, Docker can distort runtime performance.Let’s see why, and some workarounds.</p><p> 但即使在Linux上，只有CPU的工作负载，Docker可以扭曲Runtime Performance.let，看看为什么，以及一些解决方法。</p><p>  The computer I’m testing on is running Fedora 33, and has Docker 20.10.6; I’ve disabled some operating system and CPU features that can make benchmarks less consistent (ASLR and turboboost).I’m going to compare running some code on my machine to code inside a container, and so for maximum realism I’m going to use the  fedora:33 image.</p><p>  我正在测试的电脑正在运行Fedora 33，并具有Docker 20.10.6;我已经禁用了一些操作系统和CPU功能，可以使基准变得不那么一致（ASLR和Turboboost）.i'm将在我的机器上运行一些代码，以便在容器内的代码，因此对于我要去的最大现实主义使用fedora：33图像。</p><p> First, let’s test a tiny Rust program that just does some floating point calculations:</p><p> 首先，让我们测试一个微小的铁锈程序，只有一些浮点计算：</p><p>  Some of the runs were slower; I picked the fastest ones.As a first approximation it seems like the performance was the same in and out of Docker.</p><p>  一些跑步较慢;我挑选了最快的。似乎表现的第一个近似值是相同的码头。 </p><p> Next, let’s try a Python program that again only does some computation.I’ve chosen the fastest runs:</p><p>接下来，让我们尝试一个Python程序，只有一些计算。我选择了最快的运行：</p><p> $ python3.9 pystone.py  Pystone(1.2) time for 50000 passes = 0.248776This machine benchmarks at 200984 pystones/second $ docker run  -v  $PWD:/code fedora:33 python3.9 /code/pystone.py Pystone(1.2) time for 50000 passes = 0.297675This machine benchmarks at 167968 pystones/second</p><p> $ python3.9 pystone.py pystone（1.2）50000通过的时间= 0.248776这款机床基准测试200984 Pystones /秒$ Docker Run -V $ PWD：/代码Fedora：33 Python3.9 / Code/pystone.py pystone（1.2 ）50000通行证的时间= 0.297675这款机床基准167968码头/秒</p><p>  Even worse, we can see the performance hit is  inconsistent: our tiny little Rust benchmark was unaffected by Docker, but the Python benchmark was slower.If the slowdown was always consistent, running everything in Docker would at least let us reliably measure relative performance, for example between two versions of some code. Inconsistent slowdowns mean Docker is distorting our results.</p><p>  更糟糕的是，我们可以看到绩效命中是不一致的：我们的小小的铁锈基准不受Docker的影响，但Python基准测试速度慢。如果放缓始终一致，则在Docker中运行所有内容将至少让我们可靠地衡量相对性能，例如，在一些代码的两个版本之间。不一致的减速速度意味着码头扭曲了我们的结果。</p><p>  Now, containers don’t inherently have performance overhead: the whole point is that other than having different namespaces for things like networking or user IDs, a process in a container is just another process like any other.</p><p>  现在，容器并非本质上具有性能开销：整个点是除了网络或用户ID等内容中具有不同的命名空间，容器中的进程只是其他任何进程。</p><p> So where’s the performance hit coming from?One plausible theory  suggested by Aras Abbasi is that it’s Docker’s security features.</p><p> 因此，绩效袭击来自哪里？Aras Abbasi建议的一个合理的理论是它是Docker的安全功能。</p><p> Docker originated in the world of platform-as-a-service, where applications from different users are running exposed to the world.So Docker also adds additional layers of security to prevent programs escaping from the container to the host.</p><p> Docker起源于平台和A-A-Service的世界，其中来自不同用户的应用程序暴露于World.so Docker还会增加其他安全性层，以防止程序从容器转到主机到主机。</p><p> One of these security mechanisms is   seccomp, which Docker uses to constrain what system calls containers can run.</p><p> 这些安全机制之一是SECCOMP，Docker用于约束系统调用容器可以运行的系统。 </p><p> There may of course be other  seccomp performance issues that are causing the problem, or one of the other security mechanisms that Docker uses, but we can at least test this general theory by running our Docker container in privileged mode.This disables all the security features, and so if those are responsible for the slowdown we should get our speed back:</p><p>当然可能有其他SECCOMP性能问题导致问题，或者码头使用的其他安全机制之一，但我们至少可以通过在特权模式下运行我们的Docker容器来测试这一普遍理论。这会禁用所有安全功能，所以如果那些负责减速，我们应该得到我们的速度：</p><p> $ docker run  --privileged  -v  $PWD:/code fedora:33 python3.9 /code/pystone.py Pystone(1.2) time for 50000 passes = 0.239254This machine benchmarks at 208983 pystones/second</p><p> $ Docker Run  - 专项-V $ PWD：/代码Fedora：33 Python3.9 /code/Pystone.py Pystone（1.2）50000通行证的时间= 0.239254这款机床基准208983 Pystones /秒</p><p> It worked!The code is no longer slower than the host.And yes, I’ve run both variants many times: performance always goes back to normal when running with  --privileged.</p><p> 它的工作！代码不再慢于主机。是的，是的，我已经多次运行了两个变体：在使用时始终始终恢复正常。</p><p>  So should you run your benchmarks with  --privileged, assumed you trust the code you’re running to run as  root?</p><p>  那么，你应该用 - 专项运行基准，假设你相信你正在运行的代码以root身份运行？</p><p>  If you’re running your code on a containerized platform, the default Docker configuration might actually match reality better.Then again, it might not.For example, the Podman reimplementation of Docker doesn’t have this problem, and Kubernetes uses a different container runtime.</p><p>  如果您在集装箱平台上运行代码，则默认的Docker配置实际上可能更好地匹配现实。然后，它可能不是，它可能不是。例如，船坞的Podman重新实现Docker没有这个问题，Kubernetes使用不同的容器运行。</p><p> Your best bet: compare measurements across different environments, work out the differences, and aim for maximum realism for your particular situation.</p><p> 您最好的投注：比较不同环境的测量，解决差异，旨在实现特定情况的最大现实主义。</p><p>        There&#39;s always more to learn in the Python world, and it&#39;s easy to let your skills slip behind. Learn how you can upgrade your team’s skills—and ship faster—with  my training classes.</p><p>        在那里＆＃39;总是在Python世界中学习，它很容易让你的技能滑倒。了解如何升级您的团队的技能 - 以及我的培训课程更快地发货。 </p><p> Sign up for my newsletter, and join over 2800 Python developers and data scientists learning practical tools and techniques, from Docker packaging to testing to Python best practices, with a free new article in your inbox every week.</p><p>注册我的时事通讯，加入超过2800多个Python开发人员和数据科学家学习实用工具和技术，从Docker包装到测试到Python最佳实践，每周在您的收件箱中有一个免费的新文章。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://pythonspeed.com/articles/docker-performance-overhead/">https://pythonspeed.com/articles/docker-performance-overhead/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/代码/">#代码</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/docker/">#docker</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/减慢/">#减慢</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/slow/">#slow</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>