<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>将所有人类知识放在盒子里 Fitting all human knowledge in a box</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Fitting all human knowledge in a box<br/>将所有人类知识放在盒子里 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-12-25 05:47:09</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/12/b93f7fd17c170399948b133cf14900f5.png"><img src="http://img2.diglog.com/img/2020/12/b93f7fd17c170399948b133cf14900f5.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>&lt;center&gt;# How to Fit All Human Knowledge in a Box&lt;big&gt;**How we used the power of Cython to help streamline the way that knowledge can be packaged and shared all over the world -- even without the internet.**&lt;/big&gt;*Written by Tess McCrea and Juan Diego Caballero. Originally published 2020-08-11 on the [Monadical blog](https://monadical.com/blog.html).*&lt;/center&gt;## Knowledge for All! If you asked for a list of the three things we love most excessively at Monadical, I might say open source projects, free exchange of information, and all forms of learning. So we were all super excited when Kiwix founder Emmanuel Engelhart contacted us a few months ago after coming across our co-founder Nick’s open source side-project [archivebox.io](https://archivebox.io/) (a tool to allow people to create their own self-hosted archives or their favourite pieces of the internet). If you haven’t heard of Kiwix, they’re awesome -- they’ve created a whole suite of open source software components to compress the world’s greatest repositories of human knowledge, starting with [Wikipedia](https://www.wikipedia.org/) and now including stuff like [Project Gutenberg](https://www.gutenberg.org/), [Stack Exchange](https://stackexchange.com/), [YouTube](https://www.youtube.com/) and [Ted Talks](https://www.ted.com/talks), as well as an offline browser to access all this info. ![Kiwix logo](https://docs.monadical.com/uploads/upload_035e06066e7e34d8d328aa37089a8f8f.png)“Cool,” you may be thinking, Hypothetical Reader, “I’d love to have Stack Overflow at my fingertips while I’m trying to debug on an 8-hour WiFi-less flight”. Or perhaps, “Great! Next time the power goes out I’ll still be able to learn about how to [maximize my misery](https://www.youtube.com/watch?v=LO1mTELoj6o) most efficiently!”. ![maximize my misery](https://docs.monadical.com/uploads/upload_eea70f6d9d481f612849adeec758d06b.png)And, indeed, you will! However, in addition to these noble use cases, Kiwix lets people who don’t have internet access, or who have limited internet access, utilise the massive wealth of human knowledge many of us take for granted. If you’re like me, you probably barely even register the fact that you have virtually instantaneous, constant access to an unimaginable trove of information (and, of course, [seductive radishes](https://www.sadanduseless.com/radish-hotness/?fbclid=IwAR1_psKlYDxE2vy4Uk55ku83hzBKgIIP0O6-vs0Nn53HVfjQyEvpuq2t7uk)) anymore. But did you know that according to a [2017 study](https://www.itu.int/dms_pub/itu-s/opb/pol/S-POL-BROADBAND.18-2017-PDF-E.pdf) by the UN Broadband Commission for Sustainable Development, over half the world’s population (close to **4 billion** people!) doesn’t have access to the internet? The main reasons are lack of infrastructure and lack of affordability -- an issue of growing concern in a world increasingly reliant on digital information exchange.![internet usage world map](https://docs.monadical.com/uploads/upload_c45845b29fd8e65be931c5d0fa35e617.png)And that’s to say nothing of countries where the information access is heavily controlled or tracked -- Wikipedia itself has been [intermittently censored or banned outright](https://en.wikipedia.org/wiki/Censorship_of_Wikipedia) in countries as varied as the U.K., Russia, Venezuela, and Turkey. In China, Wikipedia is blocked in its entirety. In Cuba, internet infrastructure is increasingly available, but private internet access remains prohibitively expensive (in part due to the U.S.’s historical trade embargo), and all internet usage is heavily [monitored by the government](https://freedomhouse.org/country/cuba/freedom-net/2019). According to freedomhouse.org, which produces yearly Freedom on the Net reports tracking internet access, freedom of expression, and privacy issues in 65 representative countries around the world, as of 2018, [internet freedom is on the decline](https://freedomhouse.org/report/freedom-net/2018/rise-digital-authoritarianism#:~:text=Freedom%20on%20the%20Net%20is,internet%20freedom%20conditions%20each%20year.) overall -- including in the U.S. With Kiwix, massive knowledge bases are bundled and organized for offline use. They can then be downloaded directly by users with unreliable or low-bandwidth internet (the method used by the [Afripedia Project](https://en.wikipedia.org/wiki/Afripedia_Project)), or accessed via USB or external hard drive. ![Kiwix content manager](https://docs.monadical.com/uploads/upload_cc1f6360512c292d6730e4257a137e73.png)&lt;center&gt; Kiwix offline browser with files available for download. &lt;/center&gt;## The Problem:I hear you, dear Hypothetical Reader, saying to yourself “Great, I’m definitely convinced that Kiwix is awesome! But what does it have to do with Monadical??” Oh, Hypothetical. You always know just the right question to ask. As you can imagine, bundling massive amounts of internet-based content into a downloadable and browseable file comes with some challenges. Basically, Kiwix created a library called libzim, and content (images, videos, text, links, etc.) is scraped from internet-based sources and put into the library. The library bundles and organizes it into what’s called a [ZIM file](https://en.wikipedia.org/wiki/ZIM_(file_format)), which users can acquire (by download, or on a USB stick, for example) and browse using the [Kiwix ZIM reader](https://www.kiwix.org/en/downloads/kiwix-reader/). Sounds simple, right? Not so fast! The library is written in C++. This makes sense, because C++ is a relatively low-level language, meaning that it’s closer to machine language (think ones and zeroes), compared to a higher-level language, which is more abstracted from machine language, and closer in syntax and structure to human language. Lower-level languages are faster to execute than higher-level languages, and the programmer has direct control over how memory is handled, which makes it ideal for a library like libzim. So far, so good! However, the content scraper is written in Python. Uh-oh. This meant that the library couldn’t communicate directly with the scraper. “Uh...then why was the scraper written in Python?” I hear you asking. So inquisitive! A higher-level language like Python, which is closer to human language, is more “natural” and easier to use for a lot of programmers. In C++, tons of information is needed from the user in order to make it work, while Python comes with a lot of built-in data structures like vectors, dictionaries and iterators that make it easier to use right out of the box. ![Python vs C++](https://docs.monadical.com/uploads/upload_36a979d3a2a8044d432bd2e73641c926.png)Nowadays, self-taught programmers more often opt for the softer learning curve Python offers, and universities have been coming to similar conclusions. C programmers (who are proficient in C languages like C, C++, and C#) are increasingly uncommon, and having the scraper in Python made it more accessible for contributors, and easier to adapt to different data sources. Usually, only sections of code that need to be optimized are written in low-level languages like C/C++, as modern computers are plenty fast anyway, and it&#39;s much more time-consuming to write low-level code. Basically, developer time is usually the limiting factor, as opposed to processor cycles.Kiwix’s workaround for the communication problems between the scraper and the library was to use a disk (the file system hard drive) as an intermediary. Content scraped by the scraper was copied onto a disk, which was then bundled into the library by another tool, so that the library could create the ZIM file:![Original Workflow](https://docs.monadical.com/uploads/upload_0ec9a9e9ac4d37741bfc9518f2a91401.png)As you can imagine, this workflow was non-ideal; it was slow and took up a lot of disk space. In addition, using the library to write more complex data sources was complicated and difficult. Generally speaking, using the hard disk as RAM is something to be avoided, because of the computer’s [memory hierarchies](https://en.wikipedia.org/wiki/Memory_hierarchy).Fixing it would require a mechanism that could communicate in both worlds. That&#39;s where Monadical came in.## Our Solution:Our job was to create this intermediary mechanism. So we decided to develop a “wrapper” to take Python data structures and translate them to C++. A simple wrapper would pass data (in the form of strings, such as a sequence of characters e.g. “hola”) into the library, from which it could be retrieved with a function:![Simple Wrapper](https://docs.monadical.com/uploads/upload_ead6eeb127d3aafaa5c836de6c7ad074.png)But this posed a problem. The library was expecting input in the form of a function, not a string. Our solution was to create a class blend wrapper, which would allow libzim to get data from Python by passing pointers to Python functions to be called from C++. This was equivalent to implementing a virtual C++ class in python:![Class Blend Wrapper](https://docs.monadical.com/uploads/upload_23da7cec77494d3341d9502afcd49ced.png)Brilliant! A perfect solution, case closed. But wait! As the old adage says, a programmer’s work is never done. Once we started to implement this plan, we ran into another issue. Libzim is a multi-threaded library, which means it can execute more than one sequential set or “thread” of instructions at the same time, making it faster and more efficient. However, in Python, while many threads can exist, only one can run Python at a time. This is mediated by a mechanism known as the GIL, or Global Interpreter Lock. So with libzim calling and passing Python functions directly, its multi-threading capacity was incapacitated by GIL. In order to unleash the multi-threaded potential of libzim, while still maintaining GIL when running Python functions in Python (to avoid memory collisions), we used the ability of the Cython wrapper to run with nogil, so that GIL could be turned on and off. When the library is called, GIL is off, and libzim, much like She-Ra the Princess of Power, has the power (of multi-threading). When data is retrieved from Python by running Python functions, GIL is on, so as not to mess up Python&#39;s data and execution. ![multi-threading power](https://docs.monadical.com/uploads/upload_00c21c41aa52798266a44457aeb9e66d.png)With these adaptations, the old workflow (using Python to scrape the source and copy to a disc (filesystem) and then using another program to bundle content into the library, which could then create the ZIM file) became the new workflow: scraping the source and syphoning the content directly into the library.![original workflow](https://docs.monadical.com/uploads/upload_525fbe5c98082a61bd5312b006da7087.png)![new workflow](https://docs.monadical.com/uploads/upload_d3f7d446a6c235955e0d1786d1141def.png)The new workflow is faster, easier, and uses Python -- the C++ library is able to call Python functions (not content), and the time- and space-consuming intermediate copy is eliminated. The result is that the library can write more complex sources, since the way that data can be brought in can be manipulated more easily. Overall, the process is more efficient and faster. We had tons of fun working through the challenges of this project with Kiwix’s team. We hope you had as much fun reading about it as we had doing it! The whole thing is open source, so if you’re interested in taking a look at it, you can find it [here](https://github.com/openzim/python-libzim/).---&lt;center&gt; &lt;img src=&#34;https://monadical.com/static/logo-black.png&#34; style=&#34;height: 80px&#34;/&gt;&lt;br/&gt; Monadical.com | Full-Stack Consultancy*We build software that outlasts us* &lt;/center&gt;---</p><p>Warning: Can only detect less than 5000 characters</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://monadical.com/posts/knowledge-in-box.html">https://monadical.com/posts/knowledge-in-box.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/知识/">#知识</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/human/">#human</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/warning/">#warning</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>