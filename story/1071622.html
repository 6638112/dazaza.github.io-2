<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>SAML 的设计不安全</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">SAML 的设计不安全</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-08-06 04:44:35</div><div class="page_narrow text-break page_content"><p>安全断言标记语言 (SAML) 是一种用于在各方之间交换身份验证和授权数据的开放标准。 SAML 通常用于单点登录（“使用 Google 登录”、“使用 Twitter 登录”等）。这意味着当您要登录 example.com 时，example.com 可以信任并使用外部身份验证提供程序为您断言用户的身份。 SAML 是关于跨组织边界（网络域）传达这些身份验证和身份详细信息。 SAML 最近出现了具有非常大影响的灾难性漏洞。例如，如果我理解正确（我可能理解，因为安全研究人员转发了我的反应）芬兰税务机关、大多数政府服务和健康记录系统都是脆弱的，以至于攻击者本可以继续窥探人们的纳税申报表、健康记录以及基本上任何在线可用的政府相关信息。它在很大程度上被媒体忽略了，也许是因为这些漏洞没有被利用（或者没有检测到这样的实例）。 SAML 使用基于计算值的签名。这种做法本质上是不安全的，因此 SAML 作为设计是不安全的。总而言之：一旦您将安全性基于某些计算属性，您现在就可以利用此计算中的任何缺陷、差异或歧义。计算越复杂，就越危险。SAML 签名计算非常复杂。但是让我们继续解释这个概念。让我们拿一个伪身份文件（尽管实际 SAML 是 XML）：</p><p>现在，如果我们稍微更改文件（我在 { 之前添加了空格）。我们注意到签名发生了变化：这是一个非常好的属性，因为理想情况下，我们希望对安全性进行任何更改（即使是那些在 JSON 级别被认为毫无意义的更改）-关键文档（SAML 是）以生成不同的签名。可以在不破碎的情况下塑造成其他东西的东西的质量，例如粘土的延展性。我们将文档签名为原始字节 blob 使得这种不可延展性，即它不能在不破坏它的情况下成形。这是信息安全领域的理想行为。为了通过示例进行解释，让我们回到 JSON 示例。我们将使用 jq（一个 JSON 转换实用程序）从我们的文档内部计算一些东西：注意通过 jq 管道文件是如何删除空间的？那是因为在 JSON 级别空间并不重要。乍一看，这似乎并不有趣，但我们正在快速前往危险区域。即使文件仍然有空格修改，签名现在与原始签名匹配（来自没有添加空格的文件）。</p><p>$ cat assertion.json{ &quot;signed_in_user&quot;: &quot;EvilAttacker&quot;, &quot;signed_in_user&quot;: &quot;Joonas&quot;}$ cat assertion.json | .jq | sha1sume58dc03a7491f9e5fb2ed664b23d826489c42cc5#上面是因为：$ cat assertion.json | jq .{ &quot;signed_in_user&quot;: &quot;Joonas&quot;} 签名仍然与原始文件匹配。这是因为重复的密钥是有效的 JSON，在处理时被删除，并且大多数 JSON 实现让最后一个密钥获胜。现在，如果您有两段不同的代码来处理 SAML 文档，并且它们对 JSON 重复键（= 消息语义内容）有不同的解释/解析器行为，会发生什么？攻击者要求身份提供者为他签署断言，但由于 SAML 的可延展性，他能够攻击解析器差异并篡改文档，使其对签名验证仍然有效，但可以访问其他用户的数据。现在我希望解释了延展性和基于计算/解释内容的签名是多么危险。这些 SAML 漏洞发生的事情并不像我们的 JSON 示例那么简单，但这说明了这些漏洞的原理及其根本原因：对计算值和延展性进行签名。最新的漏洞是由于 XML 往返不稳定性造成的（请参阅标题“XML 往返漏洞是什么样的”）。</p><p>总之，漏洞产生于解析 XML -&gt; 编写 XML 产生语义不同的文档，即编码（解码（xmlDocument））！= xmlDocument）。我不是 100 % 确定，但我认为由于 SAML 签名验证需要一个 XML 写入步骤，它是这样的：如果 SAML 待签名内容是不可延展的，则上述内容不会成为攻击向量，即身份提供者签署文档后的任何更改都将被检测为签名违规。让我们真诚地假设 SAML 设计者知道不可延展性是一个很好的属性，让我们试着猜测为什么他们最终仍然采用可延展性设计。所以，让我们签署一些东西。当一个人签署某物时，得到一个签名作为输出：sign(contentToSign,signingKey) -&gt; 签名。为了使签名有用，您需要将签名与 contentToSign 一起传输，以便在消费者读取 contentToSign 时，他们可以使用签名对其进行验证。但是缺少签名。 SAML 设计人员可能不想单独传输 SAML 文档及其签名（签名可能在 HTTP 标头或 URL 参数中），因此为了方便起见，他们希望将其嵌入到同一个 XML 文档中：</p><p>从技术上讲，它会得到更多的 YOLO。签名存储在 contentToSign 下，因此在验证过程中，签名需要被忽略（同样是更危险的复杂性），以不将其真正包含在 contentToSign 中，这将使其成为不可能的递归问题：但让我们想象一下之前签名是没有存储在 contentToSign 中，如果我们可以基于字节进行签名验证，请回到问题上来！问题是从 XML 消息内部提取属于 contentToSign 的字节真的很困难。据我所知，XML 解析器 API 不支持此用例。即使有些人愿意，为了使 SAML 有用，他们也必须迎合大多数 XML 解析器实现支持的内容。 =&gt; 当你有 samlDocument 并且你想访问它的子树 contentToSign 时，你只能在那里获得 XML 级别的访问权限，所以 SAML 设计者可能没有考虑太多，去🤷‍♂️ 说“让我们签署 XML-然后水平数据”。对 XML 解析器的输出进行签名真的很难，因为您试图从 XML 解析输出中保持签名输入稳定，XML 解析输出在 XML 库与库之间以及语言与语言之间存在解析器差异。所以这就是为什么我们有 XML dsig 的原因，它具有例如排序 XML 的规则属性在一些 clusterfuck order 中，以便 SAML 实现就验证签名的字节序列达成某种稳定的共识。最后，无论如何我们总是需要匹配字节。这种疯狂被称为规范化，它转换了这样的东西：（这只是我发明的一个例子，我不确定哪些规则确实存在，但这里有一些例子。）总结：XML 子树很难签名/验证，并且有一些可怕的事情来实现这一点，正如经验证据所示，这是一个安全噩梦。</p><p>我愿意记录在案并说使用此类方法的所有内容都已损坏，应该被视为不安全。由于 Go 的漏洞，他们不得不修复 Go 的 XML 堆栈中的往返不稳定性，并且作为安全预防措施，包括在实际处理 XML 之前进行往返稳定性验证。概括地说，不是从一堆字节验证签名，对于 SAML 签名验证，我们需要： XML 规范化（XML dsig，它再次编码但具有特定的复杂规则和转换）如果这对您来说听起来很复杂，那是因为它确实如此。事情越复杂，就越有可能出现错误和安全问题。我是一个业余爱好者，所以请对我的想法持保留态度，但让我们尝试一下。 （注意：这篇文章都是伪代码——它不是真正的 SAML。如果你有兴趣，这里有一个真实的例子。）</p><p>取 &lt;Assertion&gt; 并将其子树序列化为字节并将其存储为 base64 或类似格式，因此我们可以将其作为字节传输，并且只有在签名得到验证后才对其进行 XML 解析：我对 XML 了解不多，所以有可能是传输字符串或字节数据的更漂亮的方法，但这应该足以说明问题。通过这种方式，他们可以将所有内容的属性都保留在一个 XML 文档中 - 但您只需要进行两次 XML 解析：当然，纯粹主义者可能会争辩说，将 XML 作为字符串或字节存储在 XML 中是丑陋的（我同意你的看法） )，但看看我们取得了什么.. 权衡是值得的 - SAMLContentToSign 中的所有内容现在都是不可延展的，您无需在验证来自受信任的来源之前解析安全关键数据。而且我们不需要“XML dsig”这样的呕吐物。 SAML 要求您支持 XML 文档的根未签名的用例，即您只对断言元素进行签名。允许攻击者控制数据的目的是什么？在这些情况下，您需要额外的代码来丢弃不安全的数据，因为如果您最终使用它，那将是一场灾难。我不知道。我不知道更好的标准 - 尽管我不太了解空间。 OAuth2 存在但旨在获得对资源的授权，因此它本身不是身份验证/身份协议。更多关于差异。</p><p>我的猜测也是，一旦标准获得牵引力，即使有可用的选项也很难迁移到更好的选项，因为前一个选项已经具有临界质量（想想 Whatsapp 与 Signal）。让我们摆脱 SAML。 🗑️ 一些专家似乎推荐 OAuth2 或 OpenID Connect：根据我的经验，您对任何主题了解得越多，您就越意识到所有这些都是由泡泡糖和胶带粘在一起的。老实说，这很容易引起焦虑。当我研究这个主题时，我还注意到芬兰政府网站的安全性依赖于一个用 JavaScript 实现的单点登录组件（甚至不是 TypeScript），它： 这只是一个被遗忘的从灾难性的流控制错误中返回，执行意外流尽管签名验证错误处理ValidlySignedPostRequest。但这就是当您使用一种语言实现安全关键软件时得到的结果，其中流控制不是一种语言功能，而是一种构建在该语言之上的库功能。 TypeScript 至少会提供适当的异步/等待流控制，编译器会注意到大多数错误。更新：好消息，Finnishgov&#39;t fork 所基于的上游项目最近已迁移到 TypeScript。 🎉</p><p>https://www.imperialviolet.org/2014/09/26/pkcs1.html - PKCS#1 有很多问题，因为首先解析过于灵活的结构，然后根据计算结果验证事物。 “解析是危险的”。 sha1sum 根本不是一个好的签名功能，但它可以证明原理。 ↩︎ 保持更新我的博客文章和项目 - 注册我的时事通讯。 🚀</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/saml/">#saml</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/insecure/">#insecure</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/xml/">#xml</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1071558.html"><img src="http://img2.diglog.com/img/2021/8/thumb_b35d49833aff44fa8cf4a0a8082fd929.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1071558.html">PostgreSQL 聚合如何工作以及它如何启发我们的超函数设计</a></div><span class="my_story_list_date">2021-8-6 0:47</span></div><div class="col-sm"><div><a target="_blank" href="/story/1071526.html"><img src="http://img2.diglog.com/img/2021/8/thumb_0690936d2864861d67034452a2c50054.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1071526.html">谷歌以统一的设计语言和更低的价格更新了它的 Nest 产品线，包括它的可视门铃和室内摄像头</a></div><span class="my_story_list_date">2021-8-5 22:55</span></div><div class="col-sm"><div><a target="_blank" href="/story/1071210.html"><img src="http://img2.diglog.com/img/2021/8/thumb_1361b06937bf19bb40267a3ec51319b0.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1071210.html">Google 推出配备 6.4&quot; FHD+ 90Hz 显示屏的 Pixel 6 和配备 6.7&quot; QHD+ 120Hz 显示屏和 4 倍光学变焦的 Pixel 6 Pro，配备 Google 设计的 Tensor SoC</a></div><span class="my_story_list_date">2021-8-3 0:28</span></div><div class="col-sm"><div><a target="_blank" href="/story/1071171.html"><img src="http://img2.diglog.com/img/2021/8/thumb_eebd3451535c62ea7342662608b01786.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1071171.html">“球机”设计师乔治·罗兹去世</a></div><span class="my_story_list_date">2021-8-2 22:7</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>