<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>自组织WS2811 LED</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">自组织WS2811 LED</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-06 05:53:28</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/7/a11d35b364326dfbce6f19e7243c4615.jpg"><img src="http://img.diglog.com/img/2020/7/a11d35b364326dfbce6f19e7243c4615.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>我有一大堆可寻址的WS2811LED串和一块ESP-CAM板(一块带摄像头的ESP32开发板)。只有一个可能的项目可以使用这些组件来完成。把杂乱无章的灯光变成更有组织的东西。</p><p>作为额外的好处，我最终用JavaScript复制了图像处理代码，因此您甚至不需要在ESP32板上安装摄像头-您只需使用普通的开发板来驱动LED即可。</p><p>您可以在下面的视频中看到我努力的结果，我将在下面的文本中详细介绍代码。</p><p>如果您想自己做这件事，那么您将需要某种类型的ESP32开发板，当然，您还需要某种可寻址的LED。我使用FastLED库来驱动LED，因此只需稍加修改代码，您就可以支持几乎任何可寻址的LED。</p><p>我们的挑战归结为一个非常基本的问题，即从摄像机获取图像流时，每个LED在2D空间中的大致位置。完成此操作后，将每个LED的x和y位置映射到包含您想要显示的图案的帧缓冲区就是一个简单的问题。</p><p>有一堆模板代码来初始化ESP-CAM-我从这里的示例代码中获得了灵感，并复制了我需要的部分来启动和运行相机。</p><p>我所做的一个重要更改是仅以最低帧大小捕获灰度图像：</p><p>我们的Frame类获取像素的副本以及图像的宽度和高度。</p><p>像素=(uint8_t*)malloc(FB-&&gt;；高度*FB-&&gt;；宽度)；memcpy(像素，FUF-&&gt;；BUF，FB-&&gt;；高度*FB-&&gt;宽度)；WIDTH=FB-&&gt;宽度；高度=FB-&&gt;；高度；长度=FB-&&gt;；宽度*FB-&&gt;；高度；</p><p>对于此代码的JavaScript版本，情况稍微复杂一些。最大的问题之一是我们需要在HTTPS上运行才能访问摄像头-在稍后的…上有更多内容。。</p><p>常量流=等待导航器。媒体设备。getUserMedia({video：{facingMode：&#34；Environment&#34；}，dio：false，})；const canPlayListener=()=&gt；{//视频加载完毕，我们可以在VideoReady(Video)；video上抓帧。removeEventListener(&#34；CanPlay&#34；，canPlayListener)；}；视频。addEventListener(&#34；canPlay&#34；，canPlayListener)；视频。srcObject=流；视频。play()；</p><p>一旦我们有了来自摄像机的视频流，我们就可以通过将视频绘制到画布上下文，然后从其中获取ImageData来抓取帧。</p><p>函数getVideoFrame(video：HTMLVideoElement，Canvas：HTMLCanvasElement){const width=video。VideoWidth；常量高度=视频。VideoHeight；Const Context=Canvas。getContext(&#34；2d&#34；)；//将视频绘制到画布上下文！drawImage(video，0，0，width，Height)；//获取原始图像字节const ImageData=context！getImageData(0，0，width，Height)；//转换为灰度常量字节=new Uint8Array(width*Height)；for(设y=0；y&lt；Height；y++){for(设x=0；x&lt；width；x++){const r=ImageData。data[(y*width+x)*4]；const g=ImageData。data[(y*width+x)*4+1]；const b=ImageData。数据[(y*宽度+x)*4+2]；//https://en.wikipedia.org/wiki/Grayscale#Converting_color_to_grayscale常量灰度=数学。MIN(255，0.299*r+0.587*g+0.114*b)；字节[y*宽度+x]=灰色；}}返回字节；}。</p><p>现在我们可以抓取帧了，我们只需要抓取一个没有LED点亮的帧，点亮一个LED，抓取另一个帧，然后比较这两个帧。不同之处应该能告诉我们LED在哪里。为了避免噪声或相机的微小移动产生一点影响，我们在获取差异之前对捕获的帧应用高斯模糊。</p><p>这当然是一个非常幼稚和简单的算法，可以很容易地改进。</p><p>在ESP32的C++代码中，我们直接在代码中完成所有这些操作。在JavaScript版本中，我们在ESP32的Web接口上调用API函数来打开和关闭LED，一旦我们完成处理，就将计算出的LED位置发送到电路板上。</p><p>在我们的ESP32代码中，我们创建了一个帧缓冲区，并在其中绘制模式。然后，我们使用每个LED的位置来计算出它应该是什么颜色。</p><p>为了解决摄像头需要HTTPS访问，同时API调用也需要HTTPS的问题(现在不能混合内容！)。我们需要一种通过HTTPS从ESP32 Web服务器同时提供UI和API的方法。有一些Web服务器支持HTTPS和ESP32可用的自签名证书，但这会导致其他问题，需要重写设备代码。解决此问题的一个简单方法是使用诸如ngrok之类的服务来提供从云通过我们的计算机到ESP32设备的安全URL。有点费解，但很管用！</p><p>仅当您不使用ESP-CAM并且必须使用手机的摄像头来校准LED时才需要此功能。向ngrok注册免费帐户，然后找到您的ESP32主板的IP地址：</p><p>ping espcam.localPING espcam.local(10.0.1.17)：56个数据字节10.0.1.17：icmp_seq=0ttl=255time=14.343 ms 10.0.1.17：icmp_seq=1ttl=255 time=6.493 ms。</p><p>你需要稳定的手-有相当长的等待时间，所以打开和关闭LED到抓取相框之间的空间可能相当大。当我拿着相框来显示位置时，我稍微移动了一下，所以位置稍微偏了一点。</p><p>查看这段视频，看看它有多好-对于如此简单的算法来说，这是令人惊讶的。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.cmgresearch.com/2020/06/05/self-organising-ws2811-leds.html">https://blog.cmgresearch.com/2020/06/05/self-organising-ws2811-leds.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/ws2811/">#ws2811</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/esp32/">#esp32</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>