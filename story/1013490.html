<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>锈迹-如何创建一个全局的、可变的单例？</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">锈迹-如何创建一个全局的、可变的单例？</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-22 22:44:41</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/7/ff0287210796737fd34a6056d629fa7a.png"><img src="http://img.diglog.com/img/2020/7/ff0287210796737fd34a6056d629fa7a.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>在系统中只有一个实例化的情况下创建和使用结构的最佳方式是什么？是的，这是必要的，它是OpenGL子系统，制作多个副本并到处传递它会增加混乱，而不是减轻它。</p><p>单身人士需要尽可能高效。似乎不可能在静态区域中存储任意对象，因为它包含带有析构函数的VEC。第二种选择是在静态区域上存储一个(不安全的)指针，该指针指向分配了单例的堆。在保持语法简洁的同时，执行此操作的最方便、最安全的方式是什么？</p><p>您看过OpenGL现有的Rust绑定如何处理同样的问题吗？--谢泼德。</p><p>是的，这是必要的，它是OpenGL子系统，制作多个副本并到处传递它会增加混乱，而不是减轻它。=&gt；这不是必需品的定义，它可能(一开始)很方便，但不是必需的。--K.Matthieu M.。</p><p>是的，你说得有道理。尽管OpenGL无论如何都是一个很大的状态机，我几乎可以肯定在任何地方都不会有它的克隆，使用它只会导致OpenGL错误。--斯捷文库切拉(Stevenkucera)。</p><p>总体上避免全局状态。相反，应在早期(可能在Main中)的某个位置构造对象，然后将对该对象的可变引用传递到需要它的位置。这通常会使您的代码更容易推理，并且不需要那么多的向后弯曲。</p><p>在决定需要全局可变变量之前，请仔细看看镜子中的自己。在极少数情况下，它是有用的，所以这就是为什么它值得知道怎么做的原因。</p><p>惰性静态板条箱可以省去一些手工创建单例的苦差事。下面是一个全局可变向量：</p><p>Use lazy_static：：lazy_static；//1.4.0use std：：sync：：mutex；lazy_static！{static ref array：mutex&lt；vec&lt；u8&gt；&gt；=mutex：：new(vec！[])；}fn do_a_call(){ARRAY.lock().unwire().ush(1)；}fn main(){do_a_call()；调用{}&#34；，ARRAY.lock().unwire().len())；}。</p><p>您还可以使用一个卢旺达Lock而不是一个Mutex来允许多个并发读取器。</p><p>Once_cell板条箱可以省去一些手工创建单例的苦差事。下面是一个全局可变向量：</p><p>使用ONCE_CELL：：SYNC：：LAZY；//1.3.1使用STD：：SYNC：：Mutex；静态数组：LAZY&lt；Mutex&lt；Vec&lt；u8&gt；&gt；&gt；=Lazy：：New(||Mutex：：New(vec！[]))；fn do_a_call(){ARRAY.lock().unwire().ush(1)；}fn main。Println！(&#34；调用{}&#34；，ARRAY.lock().unwire().len())；}。</p><p>您还可以使用一个卢旺达Lock而不是一个Mutex来允许多个并发读取器。</p><p>如果只需要跟踪整数值，可以直接使用原子：</p><p>使用std：：sync：：atom：：{AtomicUsize，Ording}；Static Call_Count：AtomicUsize=AtomicUsize：：New(0)；fn do_a_call(){call_COUNT.fetch_add(1，order：：SeqCst)；}fn main(){do_a_call()；println！(&#34；call{}&#34；，call_COUNT.load(order：SeqCst)；}fn main(){do_a_call()；println！(&#34；调用{}&#34；，call_COUNT.load(排序：SeqCst)。</p><p>这在很大程度上是从Rust 1.0的stdin实现中抄袭过来的，并对现代的Rust进行了一些调整。您还应该看看io：：Lazy的现代实现。我已经对每一行的功能进行了内联注释。</p><p>使用std：：sync：：{Arc，Mutex，Once}；使用std：：Time：：Duration；使用std：：{mem，thread}；#[Derate(Clone)]struct SingletonReader{//由于我们将在多个线程中使用，因此需要保护//并发访问内部：Arc&lt；Mutex&lt；U8&gt；&gt；，}FN Singleton()-&gt；SingletonReader{//。Unsafe{ONCE.call_once(||{//make it let singleton=SingletonReader{Internal：arc：：new(Mutex：：New(0))，}；//将其放入堆中，这样它就可以超过这次调用Singleton=mem：：transmute(Box：：new(Singleton)；}))；//现在我们分发一份可以安全并发使用的数据副本。(*singleton).clone()}}fn main(){//让我们在几个线程中使用Singleton让线程：VEC&lt；_&gt；=(0..10).map(|i|{线程：：Span(Move||{线程：：Slear(Duration：：From_Millis(I*10)；let s=singleton()；let mut data=s.inner.lock().unwire()；*data。//让&#39；为线程中的线程定期检查_in 0u8..20{线程：：SLEEP(持续时间：：From_Millis(5))；let s=singleton()；let data=s.inner.lock().unwire()；println！(&#34；it：{}&#34；，*data)；}}。</p><p>它是：0是：1它是：1它是：2它是：3它是：3它是：4它是：5它是：5它是：6它是：7它是：8它是：9它是：9它是：9。</p><p>此代码使用Rust 1.42.0编译。标准输入的真正实现使用了一些不稳定的特性来尝试释放分配的内存，而这段代码没有这样做。</p><p>实际上，您可能希望让SingletonReader实现Deref和DerefMut，这样您就不必自己深入对象并锁定它。</p><p>请注意，您仍然可以使用普通Rust作用域和模块级隐私来控制对STATIC或LAZY_STATIC变量的访问。这意味着您可以在模块中或甚至在函数内部声明它，并且不能在该模块/函数外部访问它。这有利于控制访问：</p><p>Use lazy_static：：lazy_static；//1.2.0fn only_here(){lazy_static！{static ref name：string=string：：from(&#34；hello，world！&#34；)；}println！(&#34；{}&#34；，&amp；*name)；}fn not_here(){println！(&#34；{}&#34；，&amp；*name)；}。</p><p>错误[E0425]：在此作用域中找不到值`NAME`--&gt；src/lib.rs：12：22|12|println！(&#34；{}&#34；，&amp；*name)；|^在此作用域中找不到。</p><p>但是，该变量仍然是全局的，因为它只有一个实例存在于整个程序中。</p><p>经过深思熟虑后，我确信不使用Singleton，而是完全不使用全局变量，并将所有内容传递出去。使代码更具自文档化功能，因为可以清楚地知道哪些函数可以访问呈现器。如果我想改回单身，比起换回单身，这样做要容易得多。--斯捷文库切拉(Stevenkucera)。</p><p>谢谢你的回答，它帮了我很大的忙。我只是想，我应该在这里发表评论来描述我所看到的LAZY_STATIC！的有效用例。我使用它来连接一个允许加载/卸载模块(共享对象)的C应用程序，Ruust代码就是这些模块之一。我看不到比使用全局加载更多的选择，因为我根本无法控制main()以及核心应用程序如何与我的模块交互。我基本上需要一个可以在我的mod加载后在运行时添加的东西的向量。-米歇尔·莫伊塞斯·席尔瓦。</p><p>@MoisesSilva总是会有一些需要单身的理由，但在许多使用它的情况下，使用它是没有必要的。在不知道您的代码的情况下，C应用程序可能会允许每个模块返回一个用户数据，然后将其传递回每个模块的方法中。这是C代码的典型扩展模式。如果应用程序不允许这一点，并且您不能更改它，那么是的，单例可能是一个很好的解决方案。-约翰·谢普马斯特。</p><p>@worik你能解释一下为什么吗？我不鼓励人们做一些在大多数语言中都是糟糕想法的事情(就连OP也同意，对于他们的应用程序来说，全局是一个糟糕的选择)。这通常就是这个意思。然后，我展示了两种解决方案来说明如何做到这一点。我刚刚在Rust1.24.1中测试了lazy_static示例，它完全正常工作。这里任何地方都没有外部静电。也许你需要检查一下你那端的东西，以确保你已经完全理解了答案。-约翰·谢普马斯特。</p><p>@worik如果您需要有关如何使用板条箱的基础知识的帮助，我建议您重新阅读Rust编程语言。关于创建猜谜游戏的章节展示了如何添加依赖项。-约翰·谢普马斯特。</p><p>/EMPTY_ATTACK_TABLE定义一个空的攻击表，用于初始化攻击表pub const Empty_Attack_TABLE：AttackTable=[0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，]；LAZY_STATIC！{/Knight_Attack是骑士酒吧静态参考Knight_Attack的攻击表：AttackTable={let mut at=Empty_Attack_table；for sq in 0.board_area{at[sq]=JUMP_ATK(sq，&amp；Knight_deltas，0)；}at}；...。</p><p>使用ONCE_CELL：：SYNC：：LAZY；.../AttackTable类型记录国际象棋棋盘pub类型AttackTable=[Bitboard；Board_Area]的每个方格的攻击位板；/EMPTY_ATTACK_TABLE定义一个空的攻击表，用于初始化攻击表pub const Empty_Attack_TABLE：AttackTable=[0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，0，]；/Knight_Attack是骑士酒吧静态Knight_Attack：lazy&lt；AttackTable&gt；=Lazy：：new的攻击表(||{let mut at=Empty_Attack_table；for sq in 0..board_area{at[sq]=Jump_Attas(sq，&amp；Knight_deltas，0)；}at})；</p><p>与已经讨论了LAZZY_STATIC和较新的ONCE_CELL的现有答案相比，这个答案没有提供任何新的东西。在SO上将事物标记为重复的目的是为了避免冗余信息。-约翰·谢普马斯特</p><p>点击“发布您的答案”，即表示您同意我们的服务条款、隐私政策和Cookie政策。</p><p>不是你想要的答案吗？浏览标记的其他问题或提出您自己的问题。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://stackoverflow.com/questions/27791532/how-do-i-create-a-global-mutable-singleton">https://stackoverflow.com/questions/27791532/how-do-i-create-a-global-mutable-singleton</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/可变/">#可变</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/create/">#create</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1013424.html"><img src="http://img.diglog.com/img/2020/7/thumb_0cb7eb9181a290b41c61dee3c3dde806.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1013424.html">火箭现在可以在稳定的铁锈上编译</a></div><span class="my_story_list_date">2020-7-22 14:21</span></div><div class="col-sm"><div><a target="_blank" href="/story/1013136.html"><img src="http://img.diglog.com/img/2020/7/thumb_cf01d8a49cc191f7cf977d30c7903cf8.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1013136.html">2020年会是Linux内核的锈年吗？</a></div><span class="my_story_list_date">2020-7-21 6:28</span></div><div class="col-sm"><div><a target="_blank" href="/story/1013088.html"><img src="http://img.diglog.com/img/2020/7/thumb_2e8719c3472d9b233962efd512204d09.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1013088.html">Dijo：用Rust编写的基于终端的习惯跟踪器</a></div><span class="my_story_list_date">2020-7-21 2:46</span></div><div class="col-sm"><div><a target="_blank" href="/story/1012859.html"><img src="http://img.diglog.com/img/2020/7/thumb_f8e8c3f93d5f1a5a8822b47d93dccbe4.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1012859.html">不信任冠状病毒疫苗可能危及广泛的免疫力</a></div><span class="my_story_list_date">2020-7-19 16:31</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>