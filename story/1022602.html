<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>BitTorrent v2</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">BitTorrent v2</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-08 05:07:02</div><div class="page_narrow text-break page_content"><p>Libtorrent-2.0刚刚发布，有几个主要的新特性。其中之一是对BitTorrent v2的支持。</p><p>BEP 52的大部分规范工作是由8472完成的。对BitTorrent v2的libtorrent支持主要是由Steven Siloti实现的。BiglyBT还将在不久的将来发布BitTorrent v2的实现。</p><p>在谷歌宣布产生冲突后不久，BitTorrent v2开始努力摆脱SHA-1作为碎片的散列函数。考虑到一个新的散列函数不会向后兼容，在我们遭受兼容性打击的同时，还提出了一些其他的更改。这篇文章描述了BitTorrent v2协议的新特性。</p><p>片断数据的散列函数更改为SHA-256。这样做的一个结果是散列是32字节而不是20字节。在BitTorrent v2中，信息字典也是由SHA-256计算的，这对DHT和跟踪器的兼容性构成了挑战，后者的协议要求20字节的哈希。为了处理此问题，分布式哈希表和跟踪器对v2 Torrent的通告和查找使用截断为20字节的SHA-256信息散列。</p><p>这是最初创建v2协议的基本原理之一。这意味着从根本上说，v2 Torrent将由与v1 Torrent不同的散列来标识，这将始终创建单独的群，即使在共享相同的文件时也是如此。稍后将在向后兼容性一节中详细介绍这一点。</p><p>在BitTorrent v1中，片段是散列的，生成的散列包含在.torrent文件/元数据中(在信息字典中)。在大多数情况下，片段散列是.Torrent文件大小的大部分。要将.torrent文件大小保持在大文件的合理大小范围内，可以增加片段大小，这意味着每个哈希表示文件的更大部分。较大片段大小的结果是，如果散列失败，则必须重新下载文件的较大部分，直到该片段通过散列检查。</p><p>改进这两个度量的一个旧想法是使用Merkle散列树来表示片段散列(最初是在Tribler中实现的)。这会使.torrent文件保持较小，因为您只需要树的根哈希。BitTorrent v2对片段使用Merkle散列树(但Tribler实现的协议不同)。这有以下优点：</p><p>Torrent元数据(特别是.Torrent文件的信息字典部分)变得小得多。这减少了添加磁铁链接时的启动延迟，因为在Torrent下载本身可以开始之前需要下载更少的字节。</p><p>下载的数据可以在块级别上进行验证。这意味着如果对等设备发送损坏的数据，它可以立即被发现，并且只需要重新下载16 KiB。也可以确定地识别发送损坏数据的对等体。与识别v1中的坏对等点(有时称为智能禁令)所需的启发式算法相比，这是一个很大的改进。</p><p>散列树的叶子始终为16 KiB(数据块大小)，而不考虑数据段大小。片段大小的概念仍然存在，并且仍然在对等线路协议中使用，就像今天一样。例如在HAVE和REQUEST消息中。但是，片段散列实际上不是片段内容的散列，而是片段散列树的根。即完整Merkle树的子树。</p><p>在v2中，.torrent文件必须仍然包含这些片段散列(实际上是Merkle树中代表片段级别的散列)。这有助于分发和存储散列，以便在重新启动正在设定种子的客户端时不必重新计算它们。它们还存储在恢复状态中。对于v2 Torrent，.torrent文件大小并不小，因为它仍然包含片段散列，但是信息字典是小的，这是磁铁链接开始下载所需的部分。</p><p>BitTorrent v2不仅使用哈希树，还为Torrent中的每个文件形成哈希树。这有几个优点：</p><p>相同的文件将始终具有相同的哈希，并且可以更容易地从一个Torrent移动到另一个Torrent(在创建Torrent时)，而不必重新对任何内容进行哈希处理。相同的文件也可以更容易地跨不同的群进行识别，因为它们的根哈希仅取决于文件的内容。</p><p>所有文件都将分片对齐，这意味着每个文件后面都有隐式PAD文件。</p><p>这解决了一个长期的愿望，即更容易地跨群识别重复文件或查找文件的多个源。</p><p>正如前面提到的，在大多数情况下，片段散列占据了信息字典中的大部分空间。例外情况是具有大量小文件的Torrent；然后是使用最多空间的文件列表。在v1 Torrents中，文件列表表示为具有完整路径的单个文件列表。在具有深层目录结构的Torrent中(或仅具有长名称的目录)，这些目录名将重复多次，从而加剧问题。</p><p>V2 Torrent通过对目录结构使用更有效的编码来解决这个问题，减少了重复。目录结构不是平面列表，而是存储为树(使用本码字典)。这导致目录名只被提及一次。例如：</p><p>&#39；文件&#39；：[{&#39；属性&#39；：&#39；x&#39；，&#39；长度&#39；：12323346，&#39；路径&#39；：[&#39；F&#39；]}，{&#39；属性&#39；：&#39；p&#39；，&#39；长度&#39；：62958，&#39；路径&#39；：[&#39；.pad&#39；，&#39；62958&#39；]}，{&#39；attr&#39；：&#39；x&#39；，&#39；Length&#39；：2567，&#39；path&#39；：[&#39；这是一个非常长的目录名，在v1 Torrents&#39；，&#39；A&#39；]}，{&#39；attr&#39；]}，{&#39；attr&#39；]}，{&#39；attr&#39；：&#39；p&#39；，&#39；长度&#39；：62969，&#39；路径&#39；：[&#39；.pad&#39；，&#39；62969&#39；]}，{&#39；attr&#39；：&#39；x&#39；，&#39；长度&#39；：14515845，&#39；路径&#39；：[&#39；这是一个非常长的目录名，在v1 Torrents&#39；，&#39；B&#39；]}，{&#39；attr&#39；：&#39；p&#39；，&#39；Length&#39；：33147，&#39；path&#39；：[&#39；.pad&#39；，&#39；33147&#39；]}，{&#39；attr&#39；]}，{&#39；p&#39；，&#39；路径&#39；：[&#39；.pad&#39；，&#39；33147&#39；]}，{&#39；p&#39；，&#39；：&#39；x&#39；，&#39；长度&#39；：912052，&#39；路径&#39；：[&#39；这是一个非常长的目录名，在v1 Torrents&#39；，&#39；C&#39；]}，{&#39；attr&#39；：&#39；p&#39；，&#39；长度&#39；：5452，&#39；路径&##中多次重复。：[&#39；.pad&#39；，&#39；5452&#39；]}，{&#39；attr&#39；：&#39；x&#39；，&#39；length&#39；：1330332，&#39；path&#39；：[&#39；这是一个非常长的目录名，在v1 Torrents&#39；，&#39；D&#39；]}，{&#39；属性&#39；：&#39；p&#39；，&#39；长度&#39；：45924，&#39；路径&#39；：[&#39；.pad&#39；，&#39；45924&#39；]}，{&#39；属性&#39；：&#39；x&#39；，&#39；长度&#39；：2529209，&#39；路径&#39；：[&#39；这是一个非常长的目录名，最终会在v1 Torrents中被重复多次。</p><p>&#39；文件树&#39；：{&#39；F&#39；：{&#39；&#39；属性&#39；：&#39；x&#39；，&#39；长度&#39；：12323346，&#39；片根&#39；：&#39；d1dca3b4a65568b6d62ef2f62d21fcdb676099797c8aa3e092aa0adcb9a9f6a5&#39；}}，&#39；这是一个非常长的目录名，最终在v1 Torrent&#39；中被重复多次。：{&#39；A&#39；：{&#39；&#39；：{&#39；attr&#39；：&#39；x&#39；，&#39；长度&#39；：2567，&#39；片根&#39；：&#39；f6e5b48ebc00d7c6351aafdec9a0fa40ab9c8effe8ac6cfb565df070d9532f70&#39；}}，&#39；B&#39；：{&#39；&#39；：{&#39；attr&#39；：&#39；X&#39；，&#39；长度&#39；：14515845，&#39；片根&#39；：&#39；271d61e521401cfb332110aa472dae5f0d49209036eb394e5cf8a108f2d3fb03&#39；}}，&#39；C&#39；：{&#39；&#39；：{&#39；属性&#39；：&#39；x&#39；，&#39；长度&#39；：912052，&#39；片根&#39；：&#39；d66919d15e1d90ead86302c9a1ee9ef73b446be261d65b8d8d78c589ae04cdc0&#39；}，&#39；D&#39；：{&#39；&#39；：{&#39；属性&#39；：&#39；x&#39；，&#39；长度&#39；：1330332，&#39；片根&#39；：&#39；202e6b10310d5aae83261d8ee4459939715186cd9f43336f37ca5571ab4b9628&#39；}}，&#39；E&#39；：{&#39；&#39；：{&#39；属性&#39；：&#39；x&#39；，&#39；长度&#39；：2529209，&#39；片根&#39；：&#39；9cc7c9c9319a80c807eeefb885dff5f49fe7bf5fba6a6fc3ffee5d5898eb5fdb&#39；}，</p><p>在v1 Torrent中，块的大小不受规范的限制。拥有一块小于16 KiB的块大小的块没有多大意义，但这并不是不允许的。绝大多数创建的洪流都使用2的幂的块大小，但也有一些离群值不是16 KiB的，但仍然可以被16 KiB整除。V2 Torrents收紧了对块大小的要求，要求它们必须：</p><p>这样做的主要原因是片段散列适合散列树。由于v2片段散列实际上是片段的Merkle散列树根，因此它必须表示块的2次方。</p><p>.torrent文件是使用BINCODING编码的树形结构。在BENCODING中，存在具有多个可能编码的单个值的少数情况。整数可以用前导零编码，也可以不用前导零编码，0可以编码为负0。这些编码一直都是非法的，但解析器历来都很宽容并接受它们。也许最常见的例子是如何要求字典中的键按字典顺序排序。然而，一些Torrent创作者未能对它们进行分类，因此客户接受了它们。</p><p>这主要在往返折弯编码结构时引起问题。一旦解析，词典条目的特定顺序或前导零的特定数量可能会丢失。因此，当重新编码结构时，它可能会有所不同。如果正在往返的字典是INFO-DICTIONARY，那么INFO-HASH已经改变，事情就会崩溃。</p><p>词条排序不正确的词典。例如“D1：B3：foo1：A3：Bare”(“A”应排在“B”之前)</p><p>实施这些编码还有助于使两个人从相同的文件创建Torrent，最终得到相同的信息散列和相同的Torrent。</p><p>磁铁链路协议已扩展为支持v2 Torrent。与v1 SHA-1信息散列的urn：btih：prefix一样，还有一个新的前缀：urn：btmh：用于完整的v2 SHA0256信息散列。例如，磁铁链接如下所示：</p><p>带有btmh前缀的信息散列是以十六进制编码的多散列格式的v2信息散列。实际上，这意味着它将有一个双字节前缀0x12 0x20。为了向后兼容，可以在磁链路中包括V1(BTIH)和V2(BTMH)信息散列两者。</p><p>BitTorrent v2中所有不向后兼容的新功能都被仔细地命名为新名称，以允许它们与v1的对等物共存。因此，创建混合洪流是可能的。也就是说，可以同时参与v1和v2群的Torrent，服务于相同的文件。</p><p>混合Torrent有两个信息散列，一个v1 SHA-1散列，一个(可能被截断)SHA-256散列。这就形成了两个蜂群，或者说是一个隔离的蜂群。Libtorrent将对等点标记为是否支持v2。该信息还通过新的对等交换(PEX)标志进行中继。</p><p>混合.torrent文件既包括片段散列，也包括每个文件的树根散列。</p><p>对于对测试BitTorrent v2实现感兴趣的任何人(或使用libtorrent-2.0的客户端)，您可以在此处找到测试Torrents：</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.libtorrent.org/2020/09/bittorrent-v2/">https://blog.libtorrent.org/2020/09/bittorrent-v2/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/散列/">#散列</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>