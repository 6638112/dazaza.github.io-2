<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Cachy：树外Linux调度器提高CPU缓存使用率</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Cachy：树外Linux调度器提高CPU缓存使用率</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-24 05:41:06</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/8/0a7686f9f4b48b7b3988666e090072a4.png"><img src="http://img.diglog.com/img/2020/8/0a7686f9f4b48b7b3988666e090072a4.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Cachy-Sched是一个利用CPU缓存的Linux调度器，它基于最高响应率NEXT(HRRN)策略。</p><p>删除除空闲CPU平衡之外的所有平衡代码。没有定期平衡，仅应用空闲CPU平衡。一旦一个任务被分配给一个CPU，它就会一直使用它，直到另一个CPU空闲，然后这个任务可能会被拉到新的CPU上。禁用周期性平衡的原因是为了利用任务的CPU缓存。</p><p>一项任务在每个滴答中都会被抢占。如果时钟以250 Hz计时(即CONFIG_HZ_250=y)，则任务运行4毫秒，然后在运行队列中有其他任务时被抢占。</p><p>此调度程序是为桌面使用而设计的，因为它与响应性有关。这对服务器来说可能不是坏事。</p><p>Cachy可能适合手机或Android，因为它的响应度很高。Cachy需要集成到Android中，我不认为目前的版本没有做好推特和适应Android黑客的准备。</p><p>选择内核版本的分支，并安装文件夹linux-(Version)-cachy，这是可以打补丁的Linux内核。</p><p>或者自己打补丁下载linux内核(与补丁版本相同的https://www.kernel.org/))(即如果补丁文件名为cachy-5.7.6.patch，则下载https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.7.6.tar.xz)。</p><p>Dmesg|grep-i；cachy CPU&#34；[0.059697]cachy CPU调度器v5.7.10，作者：Hamad Al Marri。感谢我妻子萨拉的耐心。</p><p>挑选下一个任务的复杂度为O(N)，其中n是运行队列中的任务数(每个CPU都有自己的运行队列)。</p><p>注：O(N)听起来很可怕，但通常对于具有4个CPU的计算机(用于桌面或移动作业)，可运行任务的最大数量可能不超过10(在挑选下一次运行时)-空闲任务被排除在外，因为它们在休眠时出列，在醒来时排队。大量CPU(4+)的Cachy调度器延迟通常比CFS少，因为不需要树平衡或任务平衡-同样适用于台式机和移动设备。</p><p>CACHY是一种基于最高响应率NEXT(HRRN)策略的调度策略，HRRN是一种响应率最高的进程下一次运行的调度策略。每个进程都有一个响应比值R=(w_t+s_t)/s_t，其中w_t是进程等待时间，s_t是进程运行时间。如果两个进程的运行时间相似，等待时间较长的进程将首先运行。HRRN的目的是防止饥饿，因为它争取了进程的等待时间，也增加了响应时间。</p><p>如果两个进程在整数舍入后具有相同的R，则比较除法余数。R值的完整计算见下文：</p><p>U64 r_curr，r_se，w_curr，w_se；struct task_struct*t_curr=task_of(Curr)；struct task_struct*t_se=task_of(Se)；U64 VR_curr=Curr-&gt；sum_exec_run+1；U64 VR_se=se-&gt；sum_exec_run+1；s64 diff；w_curr=(现在-t_curr-。//调整优先级w_curr*=(140-t_curr-&gt；prio)；w_se*=(140-t_se-&gt；prio)；r_curr=w_curr/vr_curr；r_se=w_se/vr_se；diff=(S64)(R_Se)-(S64)(R_Curr)；//相等时取余数(diff=0){r_Curr。Diff=(S64)(R_Se)-(S64)(R_Curr)；}如果(diff&gt；0)返回1；返回-1；</p><p>计算等待时间，然后乘以(140-t_curr-&gt；PRIO)，其中t_curr是任务。</p><p>正常策略中的最高优先级为100，因此等待时间乘以140-100=40。</p><p>正常策略中的正常优先级为120，因此等待时间乘以140-120=20。</p><p>最低优先级为139，因此等待时间乘以140-139=1。</p><p>此计算适用于正常策略中范围为100-139的所有任务。</p><p>下面的结果是Cachy和CFS在20次运行中获得的最好结果。有时CFS更快，但在此测试中通常Cachy更快。</p><p>Uname-aLinux SUSE 5.7.6-cachy-1-default#1 SMP Fri Jul 24 18：00：47 AEST 2020 x86_64 GNU/Linuxsudo perf stat-e上下文开关、周期、指令、L1-dcache-Load、L1-dcache-Load-Misses、LLC-Load、LLC-Load-Misses、分支。BRANCH-MISSES-A-B STRESS-NG--cpu4-t2m--cpu-method all--metrics-Brief Stress-NG：INFO：[12260]调度猪：4个cpuStress-NG：INFO：[12260]成功运行在120.06秒(2分钟，0.06秒)Stress-ng：INFO：[12260]压力源BOOOP实时用户时间BOOPS/s BOGO OPS/SSEST-NG：INFO：[12260](秒)(实时)(USR+SYS时间)压力-NG：信息：[12260]CPU 87526 120.03 478.67 0.02 729.23 182.84&#39的性能计数器统计；系统范围&#39；：36,459上下文开关1,248,551,472,864个周期(62.50%)1,337,471,008,174条指令#1.07 insn/周期(75.00%)133,423,744,677条L1-dcache-Loads(65.93%)12,176,291,467 L1-dcache-Load-未命中#9.13%所有L1-dcache命中(53.11%)2,969,067,073个LLC-Loads(34.21。</p><p>Uname-aLinux SUSE 5.7.7-1-default#1 SMP Wed Jul 1 19：03：27 UTC 2020(Cba119b)x86_64 GNU/Linuxsudo perf stat-e上下文开关、周期、指令、L1-dcache-Load、L1-dcache-Load-Misses、LLC-Load、LLC-Load-Misses、分支。BRANCH-MISSES-A-B STREST-NG--cpu 4-t 2M--cpu-method all--metrics-Brief Stress-NG：INFO：[2862]调度猪：4个cpuStress-NG：INFO：[2862]成功运行在120.08秒(2分钟，压力-ng)压力-ng：INFO：[2862]压力源BOOOP实时用户时间BOOPS/s BOGO-OPS/sStress-ng：INFO：[2862](秒)(实时)(USR+SYS时间)压力-NG：INFO：[2862]CPU 86378 120.04 478.73 0.01 719.58 180.43&#39的性能计数器统计；系统范围&#39；：31,631上下文开关1,234,757,563,294周期(62.50%)1,320,229,149,505条指令#1.07 INSN/周期(75.00%)131,542,662,029 L1-dcache-Loads(62.32%)12,147,505,410 L1-dcache-Load-未命中#9.23%所有L1-dcache命中(56.44%)4,326,450,020 LLC-Load(40.23</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://github.com/hamadmarri/cachy-sched">https://github.com/hamadmarri/cachy-sched</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/缓存/">#缓存</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/tree/">#tree</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/cpu/">#cpu</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1019931.html"><img src="http://img.diglog.com/img/2020/8/thumb_9f7c3abc984c56cd55c1baee0f17691d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019931.html">Paragon向Linux内核提交27k NTFS驱动程序</a></div><span class="my_story_list_date">2020-8-24 1:7</span></div><div class="col-sm"><div><a target="_blank" href="/story/1019804.html"><img src="http://img.diglog.com/img/2020/8/thumb_b4c9ac6369469b9efc5b650c4542a441.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019804.html">查找Linux兼容打印机</a></div><span class="my_story_list_date">2020-8-22 23:37</span></div><div class="col-sm"><div><a target="_blank" href="/story/1019436.html"><img src="http://img.diglog.com/img/2020/8/thumb_606d5a72d7aca4319d1c503e673aa617.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019436.html">美国国家安全局和联邦调查局警告Linux恶意软件用于间谍攻击</a></div><span class="my_story_list_date">2020-8-21 3:10</span></div><div class="col-sm"><div><a target="_blank" href="/story/1019302.html"><img src="http://img.diglog.com/img/2020/8/thumb_627f9a53a01bb0458c88072f6c33eb60.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019302.html">这些年来我是如何设法从Windows切换到Linux的</a></div><span class="my_story_list_date">2020-8-20 14:2</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>