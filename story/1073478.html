<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>从Solr迁移到Elasticsearch及其差异</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">从Solr迁移到Elasticsearch及其差异</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2022-02-15 16:52:05</div><div class="page_narrow text-break page_content"><p>在意识到需要一个由工程师组成的文字团队才能使我们的自我管理的Solr基础设施保持最新并正常工作后，我们正在转向一个托管搜索解决方案——Elasticsearch！</p><p>更具体地说，我们正在迁移到Elasticsearch，它由Amazon Web Services（AWS）托管和管理。这两个搜索引擎有很多相似之处，但确实需要一些术语、模式和思维的翻译。</p><p>超过2021，我们已经将一个较小的搜索索引完全迁移到弹性搜索，并且目前正在使用弹性搜索来搜索一些新的搜索域。迄今为止的旅程教会了我们很多Solr和Elastic之间的关键区别，以及人们可能不知道的细微差别，除非他们经历了类似的迁移。</p><p>我们把这篇博文放在一起是为了帮助其他正在考虑这样一个练习的人。</p><p>我们从2014年开始在Canva使用Solr，当时它是最活跃的社区中最成熟的选择。现在，在2022年，Elasticsearch不再是一个乏味且有点不可靠的新手，而是已经证明自己是一个可靠的搜索引擎，拥有强大的开发者社区和支持。</p><p>现在，雇佣具有Elasticsearch经验的工程师变得更容易了，雇佣熟悉Solr的人也更难了。</p><p>以下各节并排比较了我们如何体验Solr和Elasticsearch，我们对它们的喜爱和挣扎，以及我们希望在迁移之前了解Elasticsearch的情况。我们希望这将有利于希望做同样事情的团队。</p><p>我们（作为工程师）与技术互动的关键区别在于基础设施的管理方式。以下是要考虑的方面。</p><p>必须单独管理以解决问题。如果你在管理Solr，你还必须管理Zookeeper。</p><p>自动缩放可以添加节点以保持最小复制，但不支持在AZs（AWS可用性区域）之间进行平衡。</p><p>自动缩放不会平衡副本以防止危险的拓扑。我们观察到自动缩放的几种不良行为。</p><p>两个节点被指定为同一碎片的副本，如果其中一个崩溃，会给幸存者带来巨大的负载，通常还会导致幸存者死亡。</p><p>将多个节点作为副本添加到单个领导者，同时导致领导者尝试将其数据同时分发给两个新的追随者。这偶尔会让领导倒台。</p><p>我们有一些自我管理的脚本，以确保碎片的副本位于不同的节点中并跨AZ，但这不是现成的。</p><p>碎片根据复制值放置在节点上，复制值在索引创建时定义，或由索引模板指定。</p><p>solrconfig。xml，其中包含一些设置，例如自定义默认手持器、zookeeper超时和自动提交间隔。</p><p>可以使用具有这些设置默认值的索引模板创建索引，但更改模板不会更改活动索引的配置。要更改活动索引的配置，必须直接将设置或映射应用于该索引。</p><p>Elasticsearch处理索引配置的方式与Solr相比有很大变化。了解什么是索引模板以及如何使用它们有助于将Solr配置文件转换为Elasticsearch上下文。</p><p>索引模板包含定义索引的设置和映射。它们指定一个索引模式（例如test-*），该模式应用于与该模式匹配的所有新索引。</p><p>映射定义字段以及它们应该使用的分析器/标记器。映射也可以标记为&#34；动态&#34；：&#34;严格的&#34；，这要求您显式地添加要为映射编制索引的字段（就像Solr中的大多数字段一样）；如果要编制索引的文档包含映射中未定义的字段，则无法编制索引。</p><p>还可以使用组件模板创建索引模板。例如，不同的组件模板可能各自定义：</p><p>然后，可以使用这三个模板创建索引模板，将它们的组合配置应用于新索引。</p><p>Elasticsearch和Solr具有类似的标记化器和分析器，但对模式的定义不同，并且有自己的索引行为。</p><p>&lt；字段名=&#34；品牌&#34；类型=&#34；简单的文字&#34；索引=&#34；正确&#34；存储=&#34；假&#34；必需=&#34；假&#34；多值=&#34；正确&#34/&gt&书信电报；字段类型名称=&#34；简单的文字&#34；等级=&#34；索尔。文本字段和#34；位置增量差距=&#34；100&#34;&gt&书信电报；分析仪&gt&书信电报；标记器类=&#34；索尔。WhitespaceTokenizerFactory&#34/&gt&书信电报；过滤等级=&#34；索尔。小写字母filterFactory&#34/&gt&书信电报；过滤等级=&#34；索尔。ASCIIFoldingFilterFactory&#34/&gt&lt/分析仪&gt&lt/fieldType&gt；</p><p>{&#34；设置&#34；：{&#34；简单文本&#34；{&#34；标记器&#34；：&#34；标准&#34；&#34；过滤器&#34；[&#34；小写&#34；&#34；&#&#34;映射&#34；：{&#34；动态&#34；：&#34；严格&#34；&#34；属性&#34；：{&#34；品牌&#34；{&#34；类型&#34；：&#34；文本&#34；}</p><p>要求字段由字段名显式定义，或作为动态字段定义，例如title-*。</p><p>对于大多数查询，Solr和Elasticsearch之间有直接等价物，但通常具有不同的标签和查询结构；</p><p>获取/搜索{&#34；查询&#34；{&#34；布尔&#34；{&#34；必须&#34；[{&#34；匹配&#34；{&#34；头衔&#34；：&&#34；搜索&#34；}，{&#34；匹配&#34；：{&#34；内容&#34；：&#34；弹性搜索&#34；}]&#34;过滤器&#34；：[{&#34；任期&#34；：{&#34；状态&#34；：&#34；出版&#34；}，{&#34；范围&#34；：{&#34；出版日期&#34；：{&#34；gte&#34；：&#34；2015-01-01&#34；}</p><p>获取/搜索{&#34；#源&#34；：{&#34；包括&#34；：[&#34；名称&#34；&#34；id&#34；]&#34;查询&#34；：{&#34；术语&#34；：{&#34；用户&#34；：&#34；kimchy&#34；}</p><p>Elasticsearch支持将对象字段映射为嵌套数据类型。以这种方式映射的对象捕获结构化数据，可以单独查询，也可以作为字段集合查询。</p><p>放置my-index-000001{&#34；映射&#34；{&#34；属性&#34；{&#34；用户&#34；{&#34；类型&#34；&#34；嵌套&#34；&#属性&#34；{&#34；第一&&&#34；#类型&&&#34；#&#34;最后&#34；：{&#34；类型&#34；：&#34；文本&#34；}&#34;第34组：{&#34；类型&#34；：&#34；关键字&#34；}}}</p><p>把my-index-000001/#u doc/1{&#34；组&#34；&#34；粉丝&#34；&#34；用户&#34；[{&#34；第一&#34；&#34；约翰&&#34；&#34；&#最后&#34；&&#，{&#34；第一&#34；&#34；爱丽丝&#34；&#34；最后&#34；&#34；怀特&#34；}</p><p>//匹配具有匹配//first或last of&#34的任何用户对象的文档；罗伯特&#34；获取my-index-000001/#u search{&#34；query&#34；{&#34；bool&#34；{&#34；must&#34；：[{&#34；match&#34；user.&&&#34；&&&#34；Robert&#34；}}匹配具有单个用户对象的文档，这些对象匹配//first of&#34；简&#34**和**第34项中的最后一项；史密斯和#34；获取my-index-000001/#u search{&#34；query&#34；{&#34；bool&#34；{&#34；must&#34；：[{&#34；match&#34；user.first&#34；&#Jane&#34；}，{&#34；匹配&#34；：{&#34；用户。最后&#34；：&#34；史密斯&#34；}}}</p><p>我们向Elasticsearch的迁移解锁了一些向量搜索选项，通过将向量编码为二进制doc_值，可以将字段映射为密集和稀疏向量。值得注意的是，lucene（以及Elasticsearch和Solr）正在这一领域添加功能，包括Solr最近对HNSW向量搜索的支持。</p><p>维护文档和API参考，以及活跃的在线社区。尽管我们非常感谢Solr和Zookeeper的Apache邮件列表，但拥有在线论坛是一种胜利。</p><p>如果您想要一个非结构化搜索，可以将任何内容放入索引中，那么动态字段是很好的选择，但是如果您想要一个有保证字段的结构化搜索，那么必须在索引之前设置它。</p><p>Elasticsearch无法指定所有文档都需要一个给定的字段，或者一个给定的字段必须只有一个值，因为您需要一个带有故障处理器的摄取管道。</p><p>这似乎是一件小事（而且可能是），但从Solr的角度来看。xml模式到Elasticsearch&#39；在JSON模板中，您必须为所有有见地的注释找到一个新的家，比如我们不想使用小写用户名的原因。</p><p>另一件小事情，但来自Solr，在Solr中很容易获得一个图，并查看哪些节点在哪个碎片上以及它们的当前状态，Elasticsearch需要一种不同的思维方式来调试。例如，如果Elasticsearch集群为黄色，则必须在没有漂亮图片的情况下调试它。</p><p>抽象的奇妙之处使infra超级容易设置，这使得确定哪些节点或实例出现故障变得更加困难。幸运的是，我们已经成功地用节点和索引的度量设置了仪表板，以便能够发现异常值。</p><p>您可以将额外的文件（例如包含同义词的文件）上载到集合，并按id引用它们。但是，此id是在上载时设置的，不可更改或指定。</p><p>这些是从我们的第一个搜索引擎迁移到Elasticsearch框架中吸取的经验教训。我们现在正在努力将我们规模更大、设置更完善的服务，以及它们整整7年的模式，转变为Elasticsearch！</p><p>从最初的迁移开始，我们很高兴不需要设置一个带有仔细记录设置的动物园管理员。我们也感谢移民之旅教会我们的所有知识。</p><p>围绕我们迁移的另一个大问题是Elasticsearch和OpenSearch产品的发展和差异。我们目前使用的是Elasticsearch 7.10，能够追踪任何一个流，并将继续关注他们各自的搜索功能和托管选项。</p><p>Brandon Janson，Nic Laver，Yiwei Han，Stuart Cam：他在我们的搜索平台上工作，迁移关键的搜索组件。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/迁移/">#迁移</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/solr/">#solr</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>