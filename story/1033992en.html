<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>去找内部服务</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">去找内部服务</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-09 15:07:15</div><div class="page_narrow text-break page_content"><p>Go/Golang is Google’s open source programming language generally used for backend/systems engineering. Its major benefits are static typing, fast compilation times, and simplicity via its limited featureset.</p><p>Go/Golang是Google的开源编程语言，通常用于后端/系统工程。它的主要优点是静态类型、快速编译以及通过其有限的特性集实现的简单性。</p><p> I’ve been working with Go at my day job for internal services for a few years - and have noticed some common themes from various success stories, incident post-mortems, and conversations with other engineers.  This post inspired me to write some of these experiences down.</p><p>几年来，我一直在GO做内部服务的日常工作，从各种成功案例、事故事后回顾以及与其他工程师的对话中，我注意到了一些共同的主题。这篇帖子启发我写下了其中的一些经历。</p><p>  go vet is a static analyzer that checks for common pitfalls, like using  references to iterator variables.</p><p>Go VET是一个静态分析器，它检查常见的缺陷，比如使用对迭代器变量的引用。</p><p> Run this automatically as a linter or in CI to catch issues before they hit production.</p><p>自动将其作为Linteror或CI运行，以便在问题投入生产之前将其捕获。</p><p>  staticcheck is another static analyzer that catches problems like dead code. In my experience, it’s too slow to run locally for large projects, but it’s useful as a pre-submit check in CI.</p><p>Staticcheck是另一种静态分析器，可以捕获死代码等问题。根据我的经验，在本地运行大型项目太慢了，但作为预提交的CI签入很有用。</p><p>     In practice, there’s often an assumption that if the returned error is nil, then the returned value is non-nil, and vice-versa. Trying to verify in all cases that the returned value is non nil if the error is nil adds verbosity for very little benefit. So if you’re writing a library that has many different use cases, it’s useful to guarantee a non nil value if err is nil to callers. I don’t know of a great solution to automatically flag this, since it’s valid to return both nils in some cases.</p><p>在实践中，通常会假设如果返回的错误为nil，则返回值为非nil，反之亦然。如果错误为nil，则尝试在所有情况下验证返回值是否为非nil会增加冗长，但好处很小。因此，如果您正在编写一个具有许多不同用例的库，那么如果err对于调用者来说是nil，那么保证一个非nil值是很有用的。我不知道有什么很好的解决方案来自动标记它，因为在某些情况下同时返回两个Nil是有效的。</p><p>  In most cases, services should terminate on panic. Since the panic can originate anywhere in the codebase and halt execution, no error handling code (except recover) is run, and internal state can become inconsistent. In other words, “all bets are off”. The panic handler should be a top level function that best effort reports an exception to an external system, and then terminates. Deterministic panics should be caught by SLO alerts like availability, or checks for crash loops at the task level.</p><p>在大多数情况下，服务应该因恐慌而终止。由于死机可能源自代码库中的任何位置并暂停执行，因此不会运行错误处理代码(恢复除外)，内部状态可能会变得不一致。换句话说，“所有的赌注都取消了”。死机处理程序应该是一个顶级函数，它会尽最大努力向外部系统报告异常，然后终止。确定性恐慌应该通过SLO警报(如可用性)或在任务级别检查崩溃循环来捕获。</p><p>  By convention, functions that panic in valid error scenarios must be prefixed with `Must`. This signals to callers that the function they’re calling should be thoroughly vetted and not passed arbitrary input without sanitization. I’ve had incidents where arbitrary input causes crashes on a small percentage of the fleet that have been hard to track down (since we didn’t handle panics by reporting them to an exception reporting system).</p><p>按照惯例，在有效错误场景中死机的函数必须以‘Must`为前缀。这向调用者发出信号，他们正在调用的函数应该经过彻底的审查，并且在没有经过清理的情况下不能传递任意输入。我曾经遇到过任意输入导致一小部分机队崩溃的事件，这些事件很难追踪(因为我们没有通过向异常报告系统报告来处理恐慌)。</p><p>  This issue deserves a special mention - it will take you many hours to debug these, even if you’ve been working in Go for several years, so it’s worth remembering.</p><p>这个问题特别值得一提的是--即使您已经在Go中工作了几年，也需要花费很多小时来调试它们，所以这是值得记住的。</p><p> for _, val := range values {	go func() {		fmt.Println(val) // doesn&#39;t do what you expect	}()}</p><p>For_，val：=范围值{go func(){fmt.Println(Val)//没有做您期望的事情}()}。</p><p>  Go provides a  race detector to catch concurrency programming bugs. It will often double memory usage and slow down your program. One can run tests in CI in race mode to catch issues.</p><p>Go提供了一个竞争检测器来捕获并发编程错误。它通常会使内存使用量翻倍，并减慢程序的运行速度。用户可以在竞争模式下在CI中运行测试以捕获问题。</p><p> Occasionally, bugs are deployed to production before they’re caught by the race detector since they fail non deterministically. It’s useful to “bake” changes for a few hours/run a stress test until  some automation can catch these flakes. Often, the race detector catches a testonly issue, since developers often don’t think too much about concurrency for tests.</p><p>偶尔，bug在被竞争检测器捕获之前就被部署到生产中，因为它们不确定地失败了。对更改进行几个小时的“烘焙”/运行压力测试，直到某些自动化可以捕捉到这些薄片，这是很有用的。通常，竞争检测器会捕捉到仅限测试的问题，因为开发人员通常不会过多地考虑测试的并发性。</p><p> It seemed like a good idea to try deploying canary instances in race mode to detect issues proactively, but that caused a significant latency regression and was never tried again.</p><p>尝试在竞争模式下部署Canary实例来主动检测问题似乎是个好主意，但这会导致显著的延迟倒退，因此再也没有尝试过。</p><p>   Be careful with caller deadlines - they might not provide enough time for your service to finish its own work. For example, your service might take 500ms to complete an operation, but a caller might specify a deadline of 100ms for whatever reason (generally a tight deadline by a nested caller). These will manifest as timeouts in your service and affect its SLA. Your service should fail requests that don’t provide meaningful time to complete work. If it sounds like overkill to check this everywhere - it’s worth logging the received deadline by caller, so you can track down the source the next time you have to debug mysterious timeouts.</p><p>注意呼叫者的最后期限--他们可能没有为您的服务提供足够的时间来完成它自己的工作。例如，您的服务可能需要500ms才能完成一项操作，但调用者可能会出于任何原因将截止时间指定为100ms(通常嵌套调用者的截止时间很短)。这些将在您的服务中表现为超时，并影响其SLA。如果您的服务没有提供有意义的时间来完成工作，那么您的服务应该失败。如果到处检查这一点听起来有点过分--它值得记录调用者收到的截止日期，这样你就可以在下一次调试神秘的超时时追踪到来源。</p><p>  Log error stack traces via  libraries so you’re not stuck wondering where an error came from.</p><p>通过库记录错误堆栈跟踪，这样您就不会纠结于错误是从哪里来的。</p><p>  Go is my “go to” language to use in production. Hopefully these experiences provide some food for thought when you develop your next service in Go.</p><p>围棋是我在生产中使用的“围棋”语言。希望这些经验能为你在Go中开发下一项服务时提供一些思考的素材。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://reliability.substack.com/p/go-for-internal-services">https://reliability.substack.com/p/go-for-internal-services</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/服务/">#服务</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/internal/">#internal</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/运行/">#运行</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1033851.html"><img src="http://img2.diglog.com/img/2020/11/thumb_d3ed20a5006930bd8200c9d0704d043f.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033851.html">亚马逊42%的评论可能是“不可靠的”</a></div><span class="my_story_list_date">2020-11-8 22:41</span></div><div class="col-sm"><div><a target="_blank" href="/story/1033564.html"><img src="http://img2.diglog.com/img/2020/11/thumb_94b11314bfb5af9f6442b72274a671e4.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033564.html">2020年使用AT&T的768kbps DSL会是什么样子-是的，这很糟糕</a></div><span class="my_story_list_date">2020-11-7 6:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1033421.html"><img src="http://img2.diglog.com/img/2020/11/thumb_9e7cc24d0d195762db3df9b789e2f425.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033421.html">WhatsApp于2018年开始在印度测试其支付服务，拥有100万用户。WhatsApp获得了扩大这项服务的批准，从2000万用户开始</a></div><span class="my_story_list_date">2020-11-6 7:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1033411.html"><img src="http://img2.diglog.com/img/2020/11/thumb_8c7428c0db7547cdc606c6729480eb96.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033411.html">消息来源：堡垒之夜可能会重返iOS，这要归功于英伟达GeForce Now游戏流媒体服务的一个版本，该服务旨在Safari和其他浏览器上运行</a></div><span class="my_story_list_date">2020-11-6 7:29</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>