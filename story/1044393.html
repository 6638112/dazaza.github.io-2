<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>实施跨进程锁 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">实施跨进程锁 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-16 03:58:06</div><div class="page_narrow text-break page_content"><p>我刚刚完成了一个平凡的Pijul：Sanakirja数据库的跨进程锁。在这篇文章中，我解释了它是如何工作的。</p><p>  Sanakirja本质上是文件中B树的写时复制集合。我们可以启动可变事务，这允许我们更改数据库，并且可以删除（此后数据库仍保持不变）或提交，以及不可变事务（仅允许我们读取数据库）。</p><p> 有一些规则可以防止出现争用情况：一次只能启动一个可变事务，如果在最后一次提交之前仍启动了一个不可变事务，则可变事务就无法启动。换句话说，允许以下情形：在这些图中，绿色可变事务首先开始，而蓝色事务在绿色事务提交后开始。粉红色的不可变交易先于其他所有交易。即使在提交绿色事务之后，粉红色事务也可以继续，并且将像启动绿色事务之前一样读取数据库。</p><p> 但是，在开始蓝色事务之前，我们必须等待粉红色事务的结束。</p><p>  如下图所示，粉红色交易是在绿色交易开始之前还是之后开始都没有关系：</p><p>  该系统的另一个显着特点是，甚至可以在两个可变交易之间启动另一个不变交易（在下图中以橙色绘制），与粉红色交易并行。在这种情况下，橙色和粉红色事务将读取数据库的不同版本。这是允许的，因为橙色事务在提交绿色事务之后开始。</p><p>   B树中的节点大小为4096字节，这是大多数平台上的内存页大小（UltraSPARC是一个例外，只有8192字节页）。 </p><p>在任何平台上，页面都是从原子上同步到磁盘的：即使较大的块可能仅部分同步，也可以保证页面原子同步。这就是为什么总是选择比平台的页面大小小的块大小总是安全的原因：UltraSPARC上的大页面同步速度会变慢，但是由于磁盘缓存的原因，同步仍然会自动发生。</p><p> 在Sanakirja中，第一页包含指向（1）空闲页列表的指针，以及（2）最多500个指向B树的不同指针的集合。</p><p> 在可变事务中，不修改现有页面：而是将它们复制到新分配的页面。就性能而言，这听起来很可怕，但实际上并没有那么糟糕，因为我们必须在访问程序之前将这些页面复制到内存中，并在修改它们和这些同步输入后将它们写回到磁盘中。 / output操作比复制页面大小的块要昂贵得多，即使在SSD上也是如此。</p><p>  我之前写过有关Sanakirja的锁模型的信息，但这仅限于单个进程的范围，并且依靠文件锁来工作，因为使用Sanakirja的任何进程都必须首先获得排他文件锁，并且然后在进程内的线程之间使用正确的并发模型。</p><p> 但是，Pijul有时需要的还不止这些：例如，@ cole-h在第43期中报道了pijul记录锁定了其他命令，如果您想在编辑更改时打开日志，这会带来不便。</p><p> 当然，防止两个记录（或一个记录和一个提取）并行发生是基本的，但是完全排他锁显然太多了。</p><p>  在上一次提交期间处于活动状态的事务计数器。这对于在上图中的粉红色和橙色事务之间进行区别很有用。 </p><p>每个不可变事务都会在启动时记住时钟的值，并增加活动事务计数器的值。当它停止时，它会减少活动的不可变事务的计数器，并且如果它在上一次提交之前启动，那么还会减少在上一次提交期间活动的事务的计数器。</p><p>  每次操作一次将所有这些值读取并更新到文件中，该文件将受到锁的保护。从原则上讲，这听起来可行，但是有一个陷阱：在最后一次提交之前启动的最后一个不可变事务的结尾，我们需要一种机制来向潜在的可变事务发出可以启动的信号。在线程之间，这可以通过条件变量来实现。在进程之间，这更加复杂：我们可以使用Unix信号，但是它们的处理程序可以中断任何正在运行的函数，这意味着这些处理程序不能使用任何互斥量，也不能与Tokio进行通信，这限制了它们的实用性。</p><p> 我最终实现的另一个选择是在外部过程中编写锁定模型的准系统实现，使用Tokio任务对事务进行建模，并使用Unix域套接字与该Tokio运行时进行通信。每次事务启动时，它都会尝试在指定位置连接到Unix域套接字。如果失败，将派生一个新进程，以在后台运行pijul lock hidden命令（使用std :: process :: Command :: spawn），这将打开Unix域套接字并在其标准输出中打印新行。父进程等待该换行符，然后连接到套接字。然后pijul lock命令的工作方式如下：</p><p> 在UDS上实现的协议具有三个命令（启动不可变事务，启动可变事务和提交）和两个答案（称为ack和locked）。所有这些消息都编码在一个字节上。</p><p>  当最后一个客户端与套接字断开连接时，pijul锁将等待一秒钟，检查是否还有其他客户端，如果没有，则退出。此延迟避免了在脚本中使用pijul时反复启动pijul锁定实例。</p><p> 可以在Nest上看到该新命令的源代码，在Nest上也可以找到这两种事务的源代码。</p><p>  首先，这目前仅在Unix平台上有效，但似乎Windows上的UDS可能很快将在Tokio中实现。 Windows上的Pijul仍然依赖于标准文件锁。 </p><p>而且，这是在Pijul中实现的，而不是在Libpijul中实现的，因为从长远来看Libpijul并不依赖于Tokio（该依赖关系将在1.0的beta之前删除）。  最后要注意的是文件锁是建议性的，外部过程也是如此。 这意味着只要写入数据库的所有进程都知道它们，它们就可以安全使用。 但是，就像文件系统中所有文件的情况一样，拒绝合作并具有文件访问权限的进程将始终能够破坏该文件。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://pijul.org/posts/2021-01-15-sanakirja-locks/">https://pijul.org/posts/2021-01-15-sanakirja-locks/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/进程/">#进程</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/cross/">#cross</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/事务/">#事务</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1032732.html"><img src="http://img2.diglog.com/img/2020/11/thumb_5ef2ea312d19aa1f2a1506f2e04253c4.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032732.html">Unix域套接字上的文件描述符传输</a></div><span class="my_story_list_date">2020-11-2 14:21</span></div><div class="col-sm"><div><a target="_blank" href="/story/1022009.html"><img src="http://img2.diglog.com/img/2020/9/thumb_a9d8021c511ac373db158915d3794a25.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1022009.html">了解守护程序初学者指南</a></div><span class="my_story_list_date">2020-9-4 7:15</span></div><div class="col-sm"><div><a target="_blank" href="/story/1014985.html"><img src="http://img.diglog.com/img/2020/7/thumb_e15bd1652048823880d2c47f17417529.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1014985.html">缓解频谱和其他安全威胁：CloudFlare工作人员安全模型</a></div><span class="my_story_list_date">2020-7-30 2:27</span></div><div class="col-sm"><div><a target="_blank" href="/story/1014936.html"><img src="http://img.diglog.com/img/2020/7/thumb_e15bd1652048823880d2c47f17417529.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1014936.html">员工安全</a></div><span class="my_story_list_date">2020-7-29 23:5</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>