<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>ZFS DRAID，最后 ZFS DRAID, Finally</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">ZFS DRAID, Finally<br/>ZFS DRAID，最后 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-02-18 23:09:39</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/2/aec9ef203ce012c135506d3558b6494b.jpeg"><img src="http://img2.diglog.com/img/2021/2/aec9ef203ce012c135506d3558b6494b.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>This is part of our article series published as “OpenZFS in Depth”.    Subscribe to our article series to find out more about the secrets of OpenZFS</p><p>这是我们的文章系列的一部分，该文章系列以“深度的OpenZFS”发布。订阅我们的文章系列，以了解有关OpenZFS秘密的更多信息</p><p>  Isaac Huang’s  talk at the OpenZFS 2017 developers summit witnessed the expansion of the ZFS storage endurance envelope for large installations.  dRAID or distributed RAID is a new vdev type that complements existing ZFS data protection capabilities for very large storage arrays.  Starting with the RAID-Z-like underpinnings, dRAID permutes, or mixes, disk blocks together in a way where accesses are evenly spread across all the drives. Fast spindle replacement is accomplished by using all members of the pool, using pre-allocated virtual spares, spread evenly over all the spindles. Contributors include Intel, Lawrence Livermore Labs, and HP Enterprise, which have material interest in storage at datacenter scale and high reliability. The OpenZFS user community are the benefactors of this enhancement if we apply it well.</p><p>  Isaac Huang在OpenZFS 2017开发者峰会上的讲话见证了针对大型安装的ZFS存储持久性范围的扩大。 dRAID或分布式RAID是一种新的vdev类型，是对非常大的存储阵列的现有ZFS数据保护功能的补充。从类似RAID-Z的基础开始，dRAID将磁盘块排列或混合在一起，以使访问均匀地分布在所有驱动器上的方式。通过使用池中的所有成员，使用预分配的虚拟备件，将其快速分布在所有主轴上，可以快速更换主轴。贡献者包括英特尔，劳伦斯·利弗莫尔实验室和惠普企业，它们对数据中心规模和高可靠性的存储具有浓厚的兴趣。如果我们应用得当，OpenZFS用户社区将是此增强功能的受益者。</p><p>  Admins will often use wide RAID stripes to maximize usable storage given a number of spindles. RAID-Z deployments with large stripe widths, ten or larger, are subject to poor resilver performance for a number of reasons. Resilvering a full vdev means reading from every healthy disk and continuously writing to the new spare. This will saturate the replacement disk with writes while scattering seeks over the rest of the vdev. For 14 wide RAID-Z2 vdevs using 12TB spindles, rebuilds can take weeks. Resilver I/O activity is deprioritized when the system has not been idle for a minimum period. Full zpools get fragmented and require additional I/O’s to recalculate data during reslivering. A pool can degenerate into a never ending cycle of rebuilds or loss of the pool Aka: the Death Spiral.</p><p>  管理员通常会使用宽RAID条带，以在有多个主轴的情况下最大化可用存储空间。条带宽度大（十个或更大）的RAID-Z部署由于许多原因而导致重新银色性能不佳。重新格式化完整的vdev意味着从每个正常的磁盘读取数据并不断写入新的备用磁盘。这将使替换磁盘充满写操作，而散布遍及vdev的其余部分。对于使用12TB主轴的14个宽RAID-Z2 vdev，重建可能需要数周时间。当系统在最短的时间内没有空闲时，优先使用Resilver I / O活动。完整的zpool会碎片化，并需要其他I / O来重新计算数据。一个池可能退化为一个永无止境的重建周期或池Aka：死亡螺旋的丢失。</p><p> As spindles age together, disks may fail in groups as defect counts and mechanical failure are not independent random processes with respect to age. SSD’s further complicate this math as the wear leveling endurance will be very closely matched and clusters of devices under identical load may fail together.  Manufacturer provided mean time to failure is a forward-looking statement and is not suitable for replenishment planning. One manufacturer claims 1.2 Million hour MTBF: a dubious 137 year commitment to quality. It’s poor planning to assume any drive isn’t going to pick today to dramatically fail.</p><p> 随着主轴一起老化，磁盘可能会成组出现故障，因为缺陷计数和机械故障不是关于寿命的独立随机过程。 SSD的运算法则更加复杂，因为其耐磨损水平耐久性将非常接近，并且在相同负载下的设备集群可能会一起失效。制造商提供的平均故障时间是前瞻性声明，不适合补货计划。一家制造商声称其平均无故障时间为120万小时：这是对质量的137年承诺。糟糕的计划是假设今天不会选择任何驱动器来导致严重故障。</p><p> dRAID is an option providing rapid parity rebuild that can mitigate the death spiral behaviour of wide RAIDZ stripes, but as reflected in its default width setting of eight, it does not encourage wide stripes. Dedicating sufficient parity increases the durability of the ZFS pool and the investment in parity should be informed by the risk of losing the pool.</p><p> dRAID是一种提供快速奇偶校验重建的选项，可以减轻RAIDZ宽条带的死亡螺旋行为，但是从默认宽度设置8中可以看出，它不鼓励宽条带化。专用足够的奇偶校验可以提高ZFS池的持久性，并且应该以丢失该池的风险来告知对奇偶校验的投资。</p><p>  Spare disks are a way of keeping a disk warm and ready to replace a failed member. Usually, a spare’s life is leisurely idle until they are scrammed into action during a rebuild. That idleness is a wasted opportunity to do useful work. There are no specific spare disks in a dRAID. Rather, enough blocks are allocated throughout out the vdev to act as spares. The distributed spare is a clever redistribution of work so that all disks are always in use. A disk failure precipitates a rebuild into that dedicated space. After replacement disks are available, the vdev can be re-balanced to return the spare block and put the replacement disk in to use.</p><p>  备用磁盘是一种使磁盘保持温暖并准备更换发生故障的成员的方法。通常，备用零件的闲置时间是闲散的，直到他们在重建过程中被抢购一空。懒惰是浪费时间做有用的工作。 dRAID中没有特定的备用磁盘。而是，在整个vdev中分配了足够的块以充当备用块。分布式备用磁盘是对工作的明智重新分配，因此所有磁盘都始终处于使用状态。磁盘故障会导致对该专用空间的重建。备用磁盘可用后，可以重新平衡vdev以返回备用块并将备用磁盘投入使用。</p><p>  Unlike RAID-Z, an entire stripe in dRAID is allocated at once, no matter how many disk blocks are needed to store the object. The stripe width is determined by the disk sector size multiplied by the number of data drives in the RAID group.</p><p>  与RAID-Z不同，无论存储对象需要多少磁盘块，dRAID中的整个条带都会立即分配。条带宽度由磁盘扇区大小乘以RAID组中数据驱动器的数量确定。 </p><p>  RAID-Z has a method of optimizing block layout to minimize block allocations for small files. dRAID however priorities the speed of rebuilding parity and does not make the same space preserving attempt. If your files are a small fraction of the stripe size, dRAID will not be able to use all the disk blocks fully. For example, a default dRAID vdev has a stripe with of 32k (4k per disk, 8 disks); any allocation will require at least 32k. Internal padding is allocated to fill out the stripe width after the request object is stored. Using a smaller stripe width or providing a special mirror vdev will suit smaller allocations and improve drive utilization.</p><p>RAID-Z具有优化块布局的方法，以最小化小文件的块分配。但是，dRAID优先考虑重建奇偶校验的速度，并且没有进行相同的空间保留尝试。如果您的文件仅占条带大小的一小部分，则dRAID将无法完全使用所有磁盘块。例如，默认的dRAID vdev具有32k的条带（每个磁盘4k，8个磁盘）。任何分配至少需要32k。存储请求对象后，将分配内部填充以填充条带宽度。使用较小的条带宽度或提供特殊的镜像vdev将适合较小的分配并提高驱动器利用率。</p><p>  After a failure, the real or distributed spare is written to in sequence, following only the parity layout in the space map to rebuild the drive according to parity data. Sequential reconstruction can be accomplished rapidly by issuing large I/O blocks, reducing seeks, and avoiding tree indirection overhead. The rebuilt disk’s contents are not necessarily consistent with the Merkle tree that proves the zpools data is intact.  It’s important to reconstruct this bitwise copy of the disk first, allowing the system to return to mostly intact state and return to service. That is to say, the sequential reconstruction process restores the redundancy level of the pool, but without being able to verify the checksums of the data. The advantage to this is that it can be completed much more quickly, reducing the window during which additional disk failures might put the pool at risk.</p><p>  发生故障后，将仅按照空间映射中的奇偶校验布局依次写入实际或分布式备用，以根据奇偶校验数据重建驱动器。通过发布大型I / O块，减少寻道并避免树间接开销，可以快速完成顺序重构。重建磁盘的内容不一定与证明zpools数据完整的Merkle树一致。重要的是，首先要重建磁盘的按位复制，以使系统恢复到完整的状态并恢复服务。也就是说，顺序重建过程将恢复池的冗余级别，但无法验证数据的校验和。这样做的好处是它可以更快地完成，从而减少了其他磁盘故障可能会使池处于危险中的窗口。</p><p> A healing resilver is triggered automatically after a sequential resilver, it is a final operation that verifies that all the contents of the drives match their initial checksums via block pointer traversal. The healing resilver has a number of optimizations to quickly find and reconstruct writes to the failed disk. When a replacement drive can be added to the pool, the rebalance operation is another sequential resilver followed by a healing resilver.</p><p> 修复重发会在顺序重发后自动触发，这是最终操作，可通过块指针遍历验证驱动器的所有内容是否与它们的初始校验和相匹配。修复性银盘具有许多优化功能，可以快速找到并重建对故障磁盘的写入。当可以将备用驱动器添加到池中时，重新平衡操作是另一个顺序重新启动，然后再执行修复重新启动。</p><p> A scrub is the gold standard for a pool health; however, a scrub might be a prohibitive amount of work, visiting every block allocated in the pool. The healing resilver allows a practical return to operation in an environment where failures must be repaired routinely.</p><p> 磨砂膏是泳池健康的金标准；但是，清理可能是一项艰巨的工作，需要访问池中分配的每个块。修复性镀银可以在必须定期修复故障的环境中实际恢复运行。</p><p>  According to a report from the January OpenZFS leadership meeting, OpenZFS 2.1 will support dRAID in early 2021. If you must have it now; the head branch of the OpenZFS build against recently supported operating systems: FreeBSD 12.1+, Linux 5.10+, Illumos, NetBSD et al. The OpenZFS regression test suite ztest is a good indication that dRAID satisfies the ZFS commitment to data protection. Corporate customers at IBM and Panasas have been flogging other distributed RAID systems for more than ten years. It’s a mature concept that complements the ZFS tool set.</p><p>  根据1月OpenZFS领导会议的报告，OpenZFS 2.1将在2021年初支持dRAID。 OpenZFS的主要分支是针对最近支持的操作系统构建的：FreeBSD 12.1 +，Linux 5.10 +，Illumos，NetBSD等。 OpenZFS回归测试套件ztest很好地表明dRAID满足了ZFS对数据保护的承诺。十多年来，IBM和Panasas的企业客户一直在鞭打其他分布式RAID系统。这是一个成熟的概念，是对ZFS工具集的补充。</p><p>   We’ll install ZFS head from source and gin up some ‘md’ file backed disks.</p><p>   我们将从源代码安装ZFS磁头，然后添加一些“ md”文件支持的磁盘。</p><p>    Following the life cycle of failure and replacement in the documentation is recommended before those skills are tested in production.</p><p>    建议在生产中测试这些技能之前，遵循故障的生命周期并在文档中进行更换。 </p><p>  Let’s decode the nomenclature that describes the geometry of a dRAID vdev. A string such as “dRAID2:3d:14c:1s” encodes the following about a dRAID vdev.</p><p>我们来解码一下描述dRAID vdev的几何的术语。诸如“ dRAID2：3d：14c：1s”之类的字符串编码有关dRAID vdev的以下内容。</p><p>  -parity: Required, the number of spindles to use to store parity information. Eg: A dRAID3 can survive until a fourth disk failure without losing data. Parity may be 1,2 or 3.</p><p>  -parity：必需，用于存储奇偶校验信息的主轴数。例如：dRAID3可以生存到第四个磁盘出现故障而不会丢失数据。奇偶校验可以是1,2或3。</p><p> -[d] data: (spindles per RAID group): Determines the width of the data stripe, 8 is the default. Larger values will increase the stripe width and reduce total parity.</p><p> -[d]数据：（每个RAID组的主轴数）：确定数据条带的宽度，默认值为8。较大的值将增加条带宽度并减少总奇偶校验。</p><p> -[c] children: This parameter should match the number of device entries that you feed to the vdev. A helpful check will warn you if you don’t get the right number of disks named correctly: “invalid number of dRAID children; 14 required but 13 provided”</p><p> -[c]子代：此参数应与您提供给vdev的设备条目数相匹配。如果您没有正确命名正确数量的磁盘，将进行有益的检查，警告您：“ dRAID子代数无效；需要14个，但提供了13个”</p><p> -[s] spares: The number of disk areas to mix in as distributed spares. No spares are created by default, a maximum of four are welcome. Each spare will remove a fraction of space from every disk.</p><p> -[s]备用磁盘：要作为分布式备用磁盘混入的磁盘区域数。默认情况下不创建任何备件，最多可容纳四个。每个备用磁盘都会从每个磁盘中删除一小部分空间。</p><p>  The dRAID offers a solution for large arrays, vdevs with fewer than 20 spindles will have limited benefits from the new option. The performance and resilver result will be similar to RAIDZ for small numbers of spindles. Installations with many spindles will see the best results with regards to performance, fast spare activation and replacement. The benefits come with the associated cost of whole stripe at a time allocation for small objects in the pool. This overhead should be calculated in the design of the pool before it’s an operational surprise.</p><p>  dRAID为大型阵列提供了一种解决方案，具有少于20个心轴的vdev将无法从新选项中受益。对于少量的主轴，性能和重新镀银的结果将类似于RAIDZ。具有许多主轴的安装将在性能，快速备用激活和更换方面获得最佳效果。好处是在池中为小型对象分配时间时整个条带的相关成本。该开销应该在操作池意外之前通过池的设计计算得出。</p><p> There is no free lunch with dRAID for in saving parity or spare drives, they are your defense against data loss. As drives increase in size, their time to resilver increases and the amount of data they can destroy increases.</p><p> dRAID不提供免费午餐来保存奇偶校验或备用驱动器，它们是您防止数据丢失的防御措施。随着驱动器大小的增加，它们重新备份的时间增加，并且可以破坏的数据量也增加。 </p><p> ZFS is crucial to many companies. We guide companies and teams towards safe, whitepaper implementations of ZFS that enhance and improve the way the infrastructure is enabling your business.</p><p>ZFS对许多公司而言至关重要。 我们指导公司和团队实现ZFS的安全白皮书实施，以增强和改善基础架构为您的业务提供支持的方式。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://klarasystems.com/articles/openzfs-draid-finally/">https://klarasystems.com/articles/openzfs-draid-finally/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/zfs/">#zfs</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/draid/">#draid</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/磁盘/">#磁盘</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>