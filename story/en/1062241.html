<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>prisma，next.js，＆postgres陷阱 Prisma, Next.js, & Postgres Pitfalls</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Prisma, Next.js, & Postgres Pitfalls<br/>prisma，next.js，＆postgres陷阱 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-05-13 02:37:29</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/5/081d1b2e4a703b50e79be48cd1b524b6.png"><img src="http://img2.diglog.com/img/2021/5/081d1b2e4a703b50e79be48cd1b524b6.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>At the beginning of the week, I finished up some final touches on a project that I&#39;d been working for a couple of weeks. When setting out to build this project my initial decision was the use Next.js since I really enjoy working in React. I&#39;d heard a lot of interesting things about Prisma, so I thought I&#39;d give that a shot. When it came to the database there wasn&#39;t really a whole lot to choose from, so I went with the one I was most comfortable with, PostgreSQL, since Prisma mostly supports SQL databases (although they have a MongoDB adapter coming).</p><p>在本周初，我在一个项目上完成了一些最终触摸，即我＆＃39; d一直在工作几周。在旨在构建此项目时，我的初步决定是下一个问题，因为我真的很喜欢反应。我听到了很多关于prisma的有趣的东西，所以我以为我＆＃39; d给出了镜头。当它来到数据库时，没有那么多选择，所以我和PostgreSQL一起去过我最舒服的那个，因为PRISMA大多支持SQL数据库（尽管他们有MongoDB适配器即将到来）。</p><p> During the development, it all really was a breeze. It was so easy to create the schemas, run the migrations, and use the Prisma client. It almost felt too good to be true. When it came to deploying everything to Vercel, that&#39;s when the issues started coming.</p><p> 在发展中，这一切都是微风。创建模式非常容易，运行迁移，并使用prisma客户端。这几乎是真的太好了。当它来部署到Vercel的一切，那个问题开始时。</p><p>   When deploying to production a read a little bit about where people usually get hosted Postgres databases, and Digitalocean seemed like a pretty good alternative. With their &#34;1-click&#34; solution, I really quickly got a production-ready database up and running. The issue I ran into here though lies in the serverless factor of deploying to Vercel and using API Routes. The issue was that the number of active connections to the database would really just skyrocket after a couple of minutes.</p><p>   部署到生产后，一点读一下人们通常被托管的Postgres数据库，而DigitaloCean似乎是一个非常好的替代方案。与他们的＆＃34; 1点击＆＃34;解决方案，我真的很快得到了一个生产就绪的数据库，并运行。我在这里遇到的问题是在部署到Vercel并使用API​​路由的无服务器中。问题是，数据库的活动连接数量将在几分钟后真正飙升。</p><p>  The solution to this is to set up something called  connection pools for your database. In Digitalocean this was really easy to do, and you can  read more about it here. There&#39;s also this really great  YouTube video where an employee at Prisma (Daniel Norman) goes through how to solve this.</p><p>  解决方案是为数据库设置一个名为Connection Pools的东西。在Digitalocean中，这真的很容易，你可以在这里阅读更多信息。在那里这个真正的伟大的YouTube视频，Prisma（Daniel Norman）的员工经历了如何解决这个问题。</p><p>   Another issue that I ran into was the fact that I had all of my services, Next.js client, Next.js API routes, and database deployed all in different geographical locations. This plays a pretty big factor when it comes to lowering the time it takes for the requests to run.</p><p>   我遇到的另一个问题是我拥有我所有的服务，下一个服务，下一个问题，下一个问题.js API路由和数据库部署在不同的地理位置中。在降低请求运行所需的时间时，这效果非常重要。</p><p>  You want to make sure that you locate all your services in roughly the same geographical area (the closer the better to each other the better).  Here you can read more about how to set your region for the Next.js client, and  here you can read more about how to do it for the API routes. Unfortunately, you can only set the geographical location for the API routes if you&#39;re on a Pro Team plan. I think this a pretty uncool move.</p><p>  您希望确保您在大致相同的地理区域找到所有服务（彼此越越好）。在这里，您可以了解如何为Next.js客户端设置您所在的地区，并且您可以在此处阅读有关如何为API路由执行的信息。不幸的是，如果您在专业团队计划中，您只能设置API路线的地理位置。我认为这是一个漂亮的迫切举动。</p><p>   The last, but probably biggest, issue that I encountered was with using  next-auth for authentication. It turned out that when using session-based authentication with next-auth, the execution time for the API routes was substantially slower than when using JWT based authentication.</p><p>   最后一个但可能是最大的，我遇到的问题是使用下一个验证进行身份验证。事实证明，当使用Neut-auth使用基于会话的身份验证时，API路由的执行时间大大慢，而不是使用基于JWT的身份验证时。 </p><p>   You want to make sure that you manually opt into using JWT based authentication if you&#39;re using next-auth as your authentication handler.  Here you can read more about next-auth and JWT&#39;s, and  here you can see how to actually secure your API routes using JSON Web Tokens instead of sessions.</p><p>如果您＆＃39，则要确保您手动选择基于JWT的身份验证;重新使用Next-Auth作为身份验证处理程序。在这里，您可以阅读更多关于Neut-Auth和JWT＆＃39; s的信息，您可以看到如何使用JSON Web令牌而不是会话实际保护您的API路由。</p><p>  Using a modern but untested stack will always be challenging. I really enjoyed working with this stack (especially in development mode), and therefore got pretty frustrated when I ran into so many issues when going into production. A couple of things that I still find a little bit annoying, but that I can&#39;t really get away from is that:</p><p>  使用现代但未经测试的堆栈将永远具有挑战性。我真的很喜欢使用这个堆栈（特别是在开发模式中），因此在进行生产时遇到了这么多问题时非常沮丧。几件事，我仍然发现有点讨厌，但我可以＆＃39; t真的逃脱了：</p><p> Joins ( &#34;includes&#34; in Prisma) will add a certain amount of extra delay to the execution time. I think you have to make some sort of evaluation here for yourself whether you want to put off this to the execution time by doing a lot of includes, or whether you want to make more requests on the client instead.</p><p> 加入（＆＃34;包括＆＃34;在prisma中）将为执行时间添加一定数量的额外延迟。我认为你必须通过做大量包括或者是否想要在客户端上做更多的请求来为自己提供某种评估。</p><p> If you want to read more about the process of discovering these issues, solutions, and measurements, you can take a look at  this GitHub issue. And, if you like this sort of content, you can follow me on Twitter  @albingroen.</p><p> 如果您想了解有关发现这些问题，解决方案和测量的过程的更多信息，您可以查看此GitHub问题。而且，如果您喜欢这种内容，您可以在Twitter @alingroen上关注我。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.albingroen.com/posts/prisma-nextjs-and-postgres-pitfalls">https://blog.albingroen.com/posts/prisma-nextjs-and-postgres-pitfalls</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/postgres/">#postgres</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/数据库/">#数据库</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>