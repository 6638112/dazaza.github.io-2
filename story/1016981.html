<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>长生不老的RAM和末日的模板(2016)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">长生不老的RAM和末日的模板(2016)</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-08 13:05:44</div><div class="page_narrow text-break page_content"><p>我将用两行代码试图说服您，Elixir比您使用过的任何编程语言都更有趣。</p><p>准备好了吗？不用担心，代码不涉及快速排序、元编程或任何类似的东西。</p><p>代码本身并没有什么特别之处。它打开一个文件并向其中写入一个短字符串，用HTML实体&amp；amp；替换(硬编码)字符串中的“&amp；amp；”。您可能足够敏锐，能够在几分钟或更短的时间内用您最喜欢的语言编写等价的代码。</p><p>但您的代码不会完全等同于药剂代码，至少从计算机的角度看不是这样。如果在非Elixir代码上运行strace或dtruss之类的跟踪程序，您可能会看到如下所示：</p><p>这只是我们期待的普通系统调用。但是如果你跟踪这个长生不老的程序，你会看到类似这样的东西：</p><p>什么给予？那个奇怪的十六进制数字是什么，更重要的是，为什么对于Fancy Pants药剂先生来说，好的旧笔迹(2)还不够好呢？</p><p>答案虽然从代码样例中并不是一目了然，但在解释Elixir独特的性能特征以及如果您尝试对Erlang或Elixir的HTML模板进行基准测试时可能会遇到的一些异常情况方面有很大帮助。继续阅读这个关于技术微妙和工程的故事，最终在内存中渲染末日的模板，一个来自海底的30G大小的怪物。在这篇文章结束时，我保证你不会以同样的方式看待任何网络服务器。</p><p>如果您将该代码粘贴到Elixir shell中，您将看到一些稍微出乎意料的东西：</p><p>我说的不是扁线，而是Erlang-Oops，我说的是Erlang吗？我的意思是elxir-创建一个包含四个叶元素的嵌套列表，它们加起来就是我们预期的字符串：&#34；Hello&#34；、&#34；&amp；&#34；、&#34；amp；&#34；和&#34；再见&#34；。乍一看，这似乎是一个毫无意义的复杂情况，但让我们看看计算机对这种情况的看法。</p><p>如果您查看writev的手册页，您将看到它是一个“聚集写入”，这意味着它在单个系统调用中从多个内存位置写入数据。我编写了一个小的DTrace脚本来解压前面看到的writev调用，并查看Elixir代码对这个系统调用实际做了什么。下面是该脚本的日志：</p><p>Writev：返回Writev数据1/4：(6字节)：0x000000001a3c0d78 Hello writev：返回Writev数据2/4：(1字节)：0x000000001a3c0d7e&amp；writev：返回Writev数据3/4：(4字节)：0x000000001a3c0b49 amp；writev：返回Writev数据4/4：(8字节)：0xx000000001a3c0b49 amp；writev：返回Writev数据4/4：(8字节)：0xx000000001a3c0b49。</p><p>最初的十六进制数-在引言中的writev调用中-是向量的内存地址。该向量包含四个其他存储器地址的存储器地址，上面以大的十六进制数表示，紧挨着这些地址的字符串。</p><p>您可以从该日志中看到，Elixir正在单独编写嵌套列表的元素：&#34；Hello&#34；、&#34；&amp；&#34；、&#34；amp；&#34；和&#34；再见&#34；。但你有没有注意到记忆位置有什么特别之处？他们中有没有一个人看起来不像其他人呢？</p><p>我对十六进制不是很在行，所以让我们把所有字符都放在它们指定的内存地址上。为了清楚起见，我只是简单地重新排列和扩展上面日志中的数据-粗体-面向起始地址。</p><p>0x0b49&#39；a&#39；0x0b4a&#39；m&#39；0x0b4b&#39；p&#39；0x0b4c&#39；；&#39；...0x0d78&#39；H&#39；0x0d79&#39；e&#39；0x0d7a&#39；l&#39；0x0d7b&#39；l&#39；0x0d7b&#39；0x0d7b&#39；l&#39；0x0d7b&#39；l&#39；0x0d7b&#39；l&#39；0x0d7b&#39；G&#39；0x0d81&#39；o&#39；0x0d82&#39；o&#39；0x0d83&#39；o&#39；0x0d84&#39；d&#39；0x0d85&#39；b&#39；0x0d86&#39；y&#39；0x0d87&#39；e&#39；</p><p>你看到了吗？字符串片段的嵌套列表-组成新字符串的列表-现在开始有意义了。它只是三个指向原始字符串的指针，加上一个指向替换字符串的乱序指针。换句话说，没有“新字符串”-只有旧字符串的一组修改。(您还可以看到正则表达式引擎执行的一个额外的微小优化-请注意，最终的字符串使用的是原始字符串中的和号，而不是替换字符串中的和号。)</p><p>数据结构称为I/O列表。它旨在利用writev，从而最大限度地减少写入磁盘或网络时的数据副本。大多数语言会删除原始字符串并复制整个内容，但是它们错过了一整类无复制(和延迟复制)的性能优化。</p><p>当然，指针不是万能的。有时数据复制比指针篡改更便宜。让我们使用DTrace来探索Erlang VM实现，并查看系统在试图平衡工程注意事项的过程中在哪里划清了不同的界限。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.evanmiller.org/elixir-ram-and-the-template-of-doom.html">https://www.evanmiller.org/elixir-ram-and-the-template-of-doom.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/ram/">#ram</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/字符串/">#字符串</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>