<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>良好的日志记录</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">良好的日志记录</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-24 15:28:41</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/7/bb023970b632eaa4ece31b34d394f8a3.jpg"><img src="http://img.diglog.com/img/2020/7/bb023970b632eaa4ece31b34d394f8a3.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>要检查程序是否正在执行其应该执行的操作，可以检查给定输入的输出。但是随着系统的增长，您还需要日志记录来帮助您了解正在发生的事情。排除故障时，良好的日志消息至关重要。然而，许多开发人员没有在正确的位置记录足够的信息。</p><p>当我解决问题时，我会查看日志。有时会有一个bug导致错误的行为。其他时候没有问题-系统运行正常，但我们对它应该做什么有错误的预期。在这两种情况下，日志帮助我了解系统中发生的情况。在完成一项新功能之后，我在进行探索性测试时也会检查日志。当我尝试该功能时，我检查是否获得了预期的结果。但我也会查看日志，看它们是否符合我的预期。</p><p>根据经验，我喜欢记录任务开始、转换和结束的时间。如果是短的，可能只在尾部记录就足够了。我还喜欢登录所有任务可能失败的地方。以下是从日志消息中获取最大价值的进一步提示：</p><p>即使现代日志记录系统可以处理大量日志消息，限制记录的内容也是很好的。一些最糟糕的过度记录情况也没有什么价值。例如，如果跳过条件很简单，则“跳过的MARGIN_DATA_Available类型的消息”只是噪声，应该删除。此外，如果代码中的点A总是跟在点B之后，那么在点B处记录就足够了(可能包括来自点A的信息)，而不是两条日志语句。</p><p>尽管日志记录过多有时是一个问题，但日志记录不足的情况要常见得多。这尤其适用于所有类型的失败(包括预期的和意想不到的)。调试问题时，通常需要了解任务失败的原因和原因。如果没有记录所有故障模式，那么您有时只能猜测。</p><p>通常，日志消息没有其应有的帮助。例如“连接到开票服务器”可以通过增加服务器的IP地址和端口来改进。另一个例子：在工作中，我们通过从文件中读取日历数据来初始化内存中的数据库。创建数据库时的日志消息包括文件名和文件包含的数据行数。在排除因数据文件被截断而导致的问题时，此日志消息是关键。通常，尝试添加尽可能多的动态信息。</p><p>即使日志消息自动包含文件名和行号，最好使日志消息中的文本唯一且易于grep。这使得在代码中查找日志语句变得简单快捷。如果日志消息是从字符串构建的，请确保它仍然易于grep。很多地方的“失败：%s%s”使得这一点很难实现。如果很难在文本中描述不同的案例，您甚至可以使用“FAILED(1)：%s%s”等来区分案例。</p><p>如果日志记录是在一个从许多地方调用的函数中完成的，请考虑为该函数添加一个额外的参数，用于描述其大小写的字符串。这样，在日志消息中就可以清楚地知道它来自哪个案例。</p><p>当有关于要做什么的逻辑时，我喜欢将该逻辑放在可以自己进行单元测试的函数中。如果逻辑很复杂，我还想生成一些日志消息来解释所做的决定。有很多方法可以做到这一点，但我喜欢的一种方法是返回元组。元组的第一个元素是结果，第二个元素是要输出的日志消息列表(可能为空)。调用函数后，如果消息列表不为空，则会将条目连接起来并作为日志消息输出。</p><p>通过这种方式，很容易测试结果是否正确，以及日志消息是否符合我的预期。它是一个列表而不是字符串的原因是，通常关于如何做出决定可能有多个重要方面。例如，配置强制使用保证金类型，而协议的开始日期是将来。这两点可能都与协议本期不应开具发票的决定有关。此外，即使列表中有多个项目，它仍然只有一条日志语句，而不是几条，从而减少了日志记录。</p><p>偶尔我会在代码中看到这样的日志消息：“#无法获取ABC-DEF-CSA的协议数据”。不可避免的是，将会有类似的消息，例如，“#--”等等。最终，这一切都演变为一场关于谁的日志消息最能引起注意的尖叫的比赛。日志消息不应包含任何特殊字符以引起您的注意。让正在看日志的人决定他们要看什么。唯一可接受的区别是使用不同的日志级别，如警告和信息。</p><p>第一次尝试很难获得正确的日志消息。我常常要试几次才会对我所看到的感到满意。查看输出，并根据需要调整消息。例如，我在记录协议UUID时，它不会开票。但事实证明，记录协议名和参与方名称比记录UUID更有帮助，所以我更改了它。</p><p>此外，如果您正在对问题进行故障排除，而日志中没有您需要的所有信息，请记住添加它。</p><p>有时，日志可能看起来是多余的，但仍然是有用的。例如，在工作中，我们每分钟都有一个心跳API调用。这是有度量的，如果没有收到，就会发送警报。不过，我还在收到日志时添加了日志记录。因为它只是每分钟，所以不会产生太多的输出。它有助于理解系统中正在发生的事情。此外，一旦指标收集出现问题，能够检查日志并看到心跳仍在传入是件好事。</p><p>故障排除非常贴近我的心，我以前也写过关于它及其与日志记录的关系的文章：伟大的程序员编写可调试代码、查找Bugs：调试器与日志记录和基于会话的日志记录。</p><p>良好的日志记录在故障排除时非常有用。故障排除越多，您就越喜欢用正确的信息记录在正确的位置。开发新功能时，问问自己，如果新功能不起作用，您需要哪些信息，然后添加适当的日志消息。你的伐木经验是什么？请在评论中让我知道。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://henrikwarne.com/2020/07/23/good-logging/">https://henrikwarne.com/2020/07/23/good-logging/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/日志/">#日志</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/good/">#good</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1012716.html"><img src="http://img.diglog.com/img/2020/7/thumb_dd6a85679c1071e8bd8ddaa6fbc7754f.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1012716.html">“严格无日志策略”的VPN暴露了数百万个用户日志文件</a></div><span class="my_story_list_date">2020-7-18 21:6</span></div><div class="col-sm"><div><a target="_blank" href="/story/1012641.html"><img src="http://img.diglog.com/img/2020/7/thumb_0d54d0a17bd7e7162853b9a7159d83ee.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1012641.html">声称零日志策略的VPN公司泄露2000万用户日志</a></div><span class="my_story_list_date">2020-7-18 6:3</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008840.html"><img src="http://img.diglog.com/img/2020/6/thumb_dc1b5c288e4d037ade0041cde0ea2150.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008840.html">游戏机，苹果放弃的重要工具</a></div><span class="my_story_list_date">2020-6-29 16:2</span></div><div class="col-sm"><div><a target="_blank" href="/story/1006466.html"><img src="http://img.diglog.com/img/2020/6/thumb_7e7fecb78bdb0957db227b29529a32cd.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1006466.html">Go中的结构化日志</a></div><span class="my_story_list_date">2020-6-14 6:10</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>