<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>面向 C 程序员的现代 C++</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">面向 C 程序员的现代 C++</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-07-24 07:20:30</div><div class="page_narrow text-break page_content"><p>注意：如果你喜欢这些东西，来 PowerDNS 和我一起工作 - 有抱负的 C++ 程序员欢迎！欢迎阅读面向 C 程序员的现代 C++ 第 1 部分，请参阅本系列的目标和背景介绍。在这一部分中，我们从 C++ 特性开始，您可以使用这些特性“逐行”添加代码，而无需立即使用“C++ 编程语言”的全部 1400 页。 C 和 C++ 实际上是非常接近的亲戚，以至于许多编译器都为这两种语言提供了统一的基础架构。换句话说，您的 C 代码已经通过与 C++ 共享的代码路径（并且可能是用 C++ 编写的）。事实上，当 TrivialC 程序用 g++ 编译为 C++ 时，会出现大小相同的二进制文件。我们钟爱的 The C ProgrammingLanguage 中的所有示例程序都编译为有效的 C++。有趣的是，1988 年版的 K&amp;R notes Bjarne Stroustrup 的 C++“翻译器”被广泛用于本地测试。这种关系更进一步——整个 C 库都包含在 C++ 的“byreference”中，并且 C++ 知道如何调用所有 C 代码。相反，完全有可能从 C 调用 C++ 函数。C++ 被明确设计为不存在与 C 相比不可避免的开销。引用 ISO C++ 网站的话说：零开销原则是 C++ 设计的指导原则。它指出：你不使用的东西，你不付钱（在时间或空间上）并且进一步：你使用的东西，你不能更好地编写代码。</p><p>换句话说，不应向 C++ 添加任何会使任何现有代码（不使用新特性）变大或变慢的特性，也不应添加任何使编译器生成的代码不如程序员在不使用新特性的情况下创建的代码的特性。功能。这些都是很大的主张，它们确实需要一些证据。为了在 2018 年实现这一目标，我们必须小心。许多代码使用异常，并且这些都带有一些开销。但是，也可以声明我们的全部或部分代码是无异常的，这会导致编译器删除该基础结构。但是，这里有实际的证据。使用 C qsort() 函数对 1 亿个整数进行排序，使用 C++ 中的 std::sort() 并使用 C++-2017 并行排序，我们得到以下计时：C qsort(): 13.4 秒 (13.4 CPU)C++ std:: sort()：8.0 秒（8.0 CPU）C++ 并行排序：1.7 秒（11.8 秒的 CPU 时间）这是什么魔法？ C++ 版本比 C 快 40%？这怎么可能？ int cmp(const void* a, const void* b){ if(*(int*)a &lt; *(int*)b) return -1;否则 if(*(int*)a &gt; *(int*)b) 返回 1；否则返回0； }int main(int argc, char**argv){ auto lim = atoi(argv[1]); std::vector&lt;int&gt; vec; vec.reserve(lim); while(lim--) vec.push_back(random()); if(*argv[2]==&#39;q&#39;) qsort(&amp;vec[0], vec.size(), sizeof(int), cmp);否则 if(*argv[2]==&#39;p&#39;) std::sort(std::execution::par, vec.begin(), vec.end()); else if(*argv[2]==&#39;s&#39;) std::sort(vec.begin(), vec.end());} 值得研究一下。 cmp() 函数用于 qsort()，并定义排序顺序。</p><p>Main 和 C 中一样是 main，但是我们看到了第一个奇怪的东西：auto。我们稍后会介绍这个，但是 auto 几乎总是做你认为它会做的事情：计算所需的类型并使用它。接下来的两行定义了一个包含整数的向量，并在其中为我们想要的条目数量保留足够的空间。这是一个可选的优化。 while 循环然后用“随机”数字填充向量。接下来……神奇的事情发生了。我们调用 C qsort() 函数，对包含我们的数字的 C++ 向量进行操作。这怎么可能？事实证明 std::vector 被明确设计为可与原始指针操作互操作。它旨在能够传递给 C 库或系统调用。它将数据存储在可以随意更改的连续内存块中。接下来的 4 行使用 C++ 排序函数。在某些版本的 G++ 上，您可能需要这种（非标准）语法来获得相同的结果：__gnu_parallel::sort(vec.begin(), vec.end())。 qsort() 是一个接受比较回调的库函数。因此，编译器（及其优化器）无法将 qsort() 过程视为一个整体。此外，还有函数调用开销。同时，C++ std::sort 版本实际上是一个“模板”，它能够内联比较谓词，对于 int，它默认为 &lt;operator。为了确保我们是公平的，因为 qsort() 使用的是自定义比较器，而我们的 std::sort 不是，我们可以使用：</p><p>std::sort(vec.begin(), vec.end(), [](const auto&amp; a, const auto&amp; b) { return a &lt; b; } );执行时，这仍然需要相同的时间。要逆序排序，我们可以将 a &lt; b 更改为 b &lt; a。但是这个神奇的语法是什么？这是一个 C++ lambda 表达式，一种定义内联函数的方法。这可以用于很多事情，并且以这种方式定义排序操作​​是非常惯用的。最后，C++ 2017 附带了许多核心算法的并行版本，对于我们的案例，似乎并行排序确实在我的 8 超核机器上提供了 4.7 倍的加速。可能很难相信，但在 C++ 最初开发的大部分时间里，它并没有字符串类。写这样的课有点像成人礼，每个人都自己做。这背后的部分原因是长期尝试制作一个适合所有人的课程。 auto pos = fname.find(&#39;/&#39;);if(pos != string::npos) cout &lt;&lt; &quot;First / is at &quot; &lt;&lt; pos &lt;&lt; &quot;\n&quot;;pos = fname.find(&quot;host&quot; );if(pos != string::npos) cout &lt;&lt; &quot;Found host at &quot; &lt;&lt; pos &lt;&lt; &quot;\n&quot;;std::string newname = fname;newname += &quot;.backup&quot;;unlink(newname. c_str()); std::string 使用 [] 运算符提供对其字符的不安全和未经检查的访问，因此 newname[0] == &#39;/&#39;，但明智的人使用 newname.at(0) 执行边界检查。 2011 年之后的 std::string 设计非常有趣。基本字符串实现的存储可能如下所示：</p><p>在现代系统上，这是 24 字节的数据。容量字段用于存储已分配多少内存，以便 mystring 知道何时需要重新分配。每次将字符添加到 astring 时都不重新分配是一个很大的胜利。然而，我们存储在字符串中的东西经常比 24 字节短很多。为此，现代 C++ std::string 实现实现了小字符串优化，这允许它们在自己的存储中存储 16 甚至 21 个字节的字符，而无需使用 malloc()，这是一个加速。防止对 malloc() 进行不必要调用的另一个好处是，字符串数组现在存储在连续内存中，这对于内存缓存命中率非常有用，这通常会提供整个加速因素。经过多年的设计，std::string 可能不是每个人的全部，但与“零开销”原则一致，它胜过您可以快速手写的内容。在本系列的第 1 部分中，我希望向您展示一些您可以立即开始使用的 C++ 的有趣部分 - 为您提供许多新功能，而无需立即用复杂的东西填充您的代码。如果您有任何喜欢的东西想看到讨论或问题，请联系我 @PowerDNS_Bert 或 bert.hubert@powerdns.com 注意：如果您喜欢这些东西，请与我一起在 PowerDNS 工作 - 有抱负的 C++ 程序员欢迎！</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://berthub.eu/articles/posts/c++-1/">https://berthub.eu/articles/posts/c++-1/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/c++/">#c++</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/程序员/">#程序员</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1069266.html"><img src="http://img2.diglog.com/img/2021/7/thumb_cc5be889692880816bc09e154aa2ac9b.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1069266.html">来自 Kickstarter 资金最多的应用程序背后团队的专业提示</a></div><span class="my_story_list_date">2021-7-24 4:53</span></div><div class="col-sm"><div><a target="_blank" href="/story/1069222.html"><img src="http://img2.diglog.com/img/2021/7/thumb_f4cfadab681291660fc2c461fc7f7d42.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1069222.html">Facebook 通过渐进式网络应用程序将其云游戏服务引入 iPhone 和 iPad，游戏使用 Facebook Pay 接受游戏内购买</a></div><span class="my_story_list_date">2021-7-23 23:53</span></div><div class="col-sm"><div><a target="_blank" href="/story/1069207.html"><img src="http://img2.diglog.com/img/2021/7/thumb_dc15a6960d606f87f73f0ea87a28b459.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1069207.html">无服务器堆栈为开源应用程序框架筹集了 100 万美元</a></div><span class="my_story_list_date">2021-7-23 21:11</span></div><div class="col-sm"><div><a target="_blank" href="/story/1069104.html"><img src="http://img2.diglog.com/img/2021/7/thumb_16f1d824101161becc34ab2cfe9fffc8.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1069104.html">VOCHI 为其基于计算机视觉的视频编辑应用程序筹集了 240 万美元</a></div><span class="my_story_list_date">2021-7-23 4:18</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>