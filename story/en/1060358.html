<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>用ory hydra / kratos建立oss auth Building OSS auth with Ory Hydra/Kratos</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Building OSS auth with Ory Hydra/Kratos<br/>用ory hydra / kratos建立oss auth </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-28 11:02:26</div><div class="page_narrow text-break page_content"><p>The technical challenges we ran into with our Hydra/Kratos-based solution, and how we addressed them.</p><p>我们用基于Hydra / Kratos的解决方案遇到的技术挑战以及我们如何解决它们。</p><p>  Pixie is an observability platform recently acquired by New Relic. To make the project more accessible to the developer community, New Relic is open sourcing Pixie. As part of our commitment to OSS, we want Pixie to be deployable in a completely open source environment. However, Pixie had a strong dependency on Auth0 that would complicate this effort.</p><p>  Pixie是最近被新遗物获得的可观察性平台。要使项目更易于开发人员社区，新的遗物是开放的源精灵。作为我们对OSS承诺的一部分，我们希望在完全开源环境中可以部署精灵。但是，Pixie对Auth0具有很强的依赖，这将使这项努力复杂化。</p><p> In this post we detail how we redesigned Pixie&#39;s auth to be open source compatible. We discuss trade offs of several approaches and dive into our final open source implementation. Let&#39;s start with our Auth0 design.</p><p> 在此帖子中，我们详细介绍了我们如何重新设计的Pixie＆＃39; s auth是开源兼容的。我们讨论几种方法的贸易问题，并潜入我们的最终开源实施。让＆＃39;首先从我们的Auth0设计开始。</p><p>  Adding Auth0 to Pixie was very simple. Integrating Auth0&#39;s API took less than a day and our implementation continues to work two years later. Auth0 has been incredibly easy to use throughout the entire experience.</p><p>  将验证添加到Pixie非常简单。 Indoply Auth0＆＃39; S API不到一天，我们的实施继续工作两年后。验证在整个体验中都非常易于使用。</p><p> In our original authentication scheme ( figure below), Pixie&#39;s UI redirects to Auth0 and receives an access token back. The UI forwards the token to the Pixie Cloud backend and the backend validates the token by making a call to the external Auth0 server.</p><p> 在我们的原始身份验证方案（下图）中，Pixie＆＃39; s UI重定向到auth0并收到访问令牌。 UI将令牌转发到Pixie Cloud后端，后端通过拨打外部Auth0服务器来验证令牌。</p><p>  Auth0 does all the heavy lifting and provides an easy way to setup different login providers - we went with Google-based Signup and Login flows. During signup, users could give us access to their name and profile picture. We incorporated this into our small profile dropdown, rounding out the user experience.</p><p>  Auth0所有繁重的升降机都提供了一种设置不同的登录提供商的简单方法 - 我们使用基于谷歌的注册和登录流程。在注册期间，用户可以让我们访问他们的姓名和档案图片。我们将其纳入我们的小型外形下拉，舍入用户体验。</p><p> The Auth0 + Google flow was simple and worked extremely well for us. Auth0 saved development time that we later spent on our core observability product. We would recommend Auth0 to anyone who is comfortable with a hosted, third party solution.</p><p> Auth0 + Google Flow很简单，对我们来说非常好。 Auth0保存了我们以后花在我们的核心可观察性产品上的开发时间。我们将Auth0向任何与托管的第三方解决方案舒适的人推荐给任何人。 </p><p>  Unfortunately, Auth0 does not work for Pixie&#39;s open source offering. We don&#39;t want to require open source users to depend on remotely hosted, closed source APIs. This is especially important for our users with air-gapped clusters that cannot make external network requests. We need a standalone version of Pixie that exclusively relies on open source components.</p><p>不幸的是，Auth0不适用于Pixie＆＃39;开源提供。我们不想要求开源用户依赖于远程托管的封闭源API。这对我们的用户具有无法进行外部网络请求的空中覆盖群体尤为重要。我们需要一个独立版本的Pixie，它专门依赖于开源组件。</p><p> As part of this change, we also needed to enable username and password login. Our hosted implementation requires an identity from a third-party provider (ie Google) - another dependency that breaks our open source commitment. Username / password, on the other hand, can be implemented with open source libraries and works regardless of a cluster&#39;s network connectivity.</p><p> 作为此更改的一部分，我们还需要启用用户名和密码登录。我们的托管实现需要来自第三方提供商的身份（即谷歌） - 违反我们开源承诺的另一个依赖关系。另一方面，用户名/密码可以使用开源库实现，无论群集和＃39;网络连接如何，都可以实现。</p><p>        Adds extra burden to the user during setup, does not work &#34;out of the box&#34;</p><p>        在设置期间向用户增加额外的负担，不起作用＆＃34;从框中开箱＆＃34;</p><p> This option is compelling, but would limit our users to only those willing and able to open an Auth0 account. It also adds friction to get Pixie Cloud up and running, while also preventing network-isolated Pixie Cloud deployments. We want to open up as much access to Pixie Cloud as possible, so option 1 alone won&#39;t satisfy our needs.</p><p> 此选项是引人注目的，但会将用户限制为愿意和能够开立Auth0帐户的用户。它还增加了摩擦来获取Pixie云并运行，同时还可以防止网络隔离的Pixie云部署。我们希望尽可能多地向Pixie云开放，因此单独选择1赢得了我们的需求。</p><p>      While open source projects commonly implement authentication from scratch, we&#39;re wary of spending time rolling our own solution. Pixie, like all development teams, has an engineering budget that we allocate across our products. Rolling our own auth would require us to spend a large chunk of that budget on this feature, while taking on the risk of opening security vulnerabilities if done incorrectly. We would rather rely on a project that has been built by experts and has been vetted by the open source community.</p><p>      虽然开源项目通常从头开始实施身份验证，但我们谨慎花时间滚动自己的解决方案。像所有开发团队一样，Pixie拥有我们在我们的产品中分配的工程预算。滚动我们自己的Auth将要求我们在此功能上花费大块该预算，同时在不正确的情况下承担打开安全漏洞的风险。我们宁愿依赖专家建造的项目，并被开源社区审查。</p><p>      Outsourcing logic to third-party libraries is often easier said than done. Using an off-the-shelf solution sounds appealing, but integration into an existing project requires time to learn the new system and adapt it to your specific needs. The upside is that you inherit the working knowledge of the library&#39;s developers and save yourself many pains of edge-case discovery.</p><p>      向第三方图书馆外包逻辑通常更容易完成。使用现成的解决方案声音吸引力，但集成到现有项目需要时间来学习新系统并使其适应您的特定需求。上行的是你继承了图书馆的工作知识和开发人员的工作知识，并拯救了自己许多边缘案例发现的痛苦。</p><p> In this case, we felt the benefits outweighed the disadvantages. Security is extremely important to us because we deal with sensitive user data. It was worth the effort to redesign our system to use an existing solution written by security/authentication experts.</p><p> 在这种情况下，我们感受到了益处超过了缺点。安全对我们来说非常重要，因为我们处理敏感的用户数据。重新设计我们的系统值得使用安全/认证专家编写的现有解决方案是值得的。 </p><p> We found that a combination of  Ory&#39;s  Kratos and  Hydra projects best fit our needs. Many other alternatives don&#39;t provide username/password authentication, and instead rely on OAuth/OIDC. Others restrict users to pre-built UIs. Kratos and Hydra together gave us a flexible and full solution that fit our needs while also remaining accessible to anyone in the open source community.</p><p>我们发现ory＆＃39; kratos和hydra项目的组合最适合我们的需求。许多其他替代方案Don＆＃39; t提供用户名/密码身份验证，而是依赖OAUTH / OIDC。其他人将用户限制为预构建的UI。 Kratos和Hydra一起给了我们一个灵活的完整解决方案，适合我们的需求，同时也仍然可以在开源社区中的任何人访问。</p><p>    At a high level,  Ory&#39;s  Kratos is an open source system for identity and user management. Kratos supports registration, login, authentication, and other user-related tasks, all through a convenient  REST API. At the moment, Pixie only uses Kratos for username/password-based authentication, but Kratos also supports login with third-party identity providers through OIDC (ie Google Identity Platform).</p><p>    在高水平，Ory＆＃39; kratos是一个用于身份和用户管理的开源系统。 Kratos支持注册，登录，身份验证和其他与用户相关的任务，全部通过方便的REST API。目前，Pixie仅使用Kratos进行用户名/密码的身份验证，但Kratos还支持与第三方身份提供商通过OIDC（即Google Identity平台）登录。</p><p> Unlike our Auth0 use-case, Kratos uses stateful session cookies rather than stateless access tokens to store identity information. The most important difference is that session cookies require a service roundtrip to check authorization, while access tokens like JWTs can be verified at the endpoint, reducing the latency necessary to access an authenticated endpoint. (You can learn more about the difference  here).</p><p> 与我们的auth0用例不同，kratos使用有状态会话cookie而不是无状态访问令牌来存储身份信息。最重要的区别是会话cookie需要服务往返检查授权，而可以在端点验证像JWT的访问令牌，从而减少访问认证端点所需的延迟。 （您可以在此处了解更多信息）。</p><p> Our auth design incorporates JWTs for their performance advantage, but Kratos only provides the session-cookie option. We fill this gap with Hydra.</p><p> 我们的Auth设计包括JWTS的性能优势，但Kratos仅提供会话cookie选项。我们用Hydra填补这个差距。</p><p>  Hydra, another project by  Ory, is an open source OAuth 2.0 server and OpenID Connect provider. Hydra does not come packaged with identity or user management - instead it completely focuses on enabling API access to the OAuth flows and expects users to come with their own identity solutions (such as Kratos). An added benefit is that the project is very mature and also in production  at several notable companies. We use Hydra in Pixie Cloud to create the stateless access tokens we use for auth in the rest of our backend. However, we had to do some work to convert the Kratos session cookies into the access tokens.</p><p>  HYDRA，ORY的另一个项目，是一个开源OAuth 2.0服务器和OpenID Connect Provider。 Hydra不与身份或用户管理包装 - 相反，它完全专注于使API访问OAuth流程，并希望用户附带自己的身份解决方案（例如kratos）。额外的好处是该项目非常成熟，也在几家着名公司的生产中。我们在Pixie Cloud中使用Hydra来创建我们在其余的后端使用的无状态访问令牌。但是，我们必须做一些工作来将kratos会话cookie转换为访问令牌。</p><p>  The Kratos maintainers  intend to build an explicit integration between Hydra and Kratos, and they&#39;ve  prototyped an integration in Javascript. However, (at the time of writing) the integration is still a work in progress so we needed to build it ourselves.</p><p>  Kratos维护者打算在Hydra和Kratos之间建立明确的集成，并且它们在JavaScript中进行了分组。但是，（在撰写本文时）整合仍然是正在进行的工作，因此我们需要自己建造它。</p><p> We document our design here for reference in case future readers also want an access token based, open source, auth solution.</p><p> 我们在此记录我们的设计以供参考，以防未来读者也希望基于访问令牌，开源，Auth解决方案。 </p><p>   The Hydra/Kratos integration is complex, so it&#39;s easiest to demonstrate with an example. Let&#39;s break down a successful login flow.  The steps match the diagram above.</p><p>Hydra / Kratos集成是复杂的，所以它最容易用一个例子来证明。让＆＃39;分解成功的登录流程。步骤匹配上图。</p><p> Kratos logs in the user, sets the session cookie, and redirects the user to an endpoint on the Pixie backend API service.</p><p> Kratos日志在用户中，设置会话cookie，并将用户重定向到Pixie后端API服务上的端点。</p><p>   Pixie&#39;s API service tells Hydra to accept the user&#39;s login because the user has a valid session cookie.</p><p>   Pixie＆＃39; S API服务告诉Hydra接受用户＆＃39; s登录，因为用户有一个有效的会话cookie。</p><p> Hydra redirects the UI (via the backend API response not drawn above) to an endpoint where the UI receives an  OAuth Access Token.</p><p> Hydra将UI（通过上述API响应未绘制）重定向到UI接收OAuth访问令牌的端点。</p><p>   Pixie&#39;s Auth service validates the access token with Hydra, to ensure that it is receiving a legitimate request from a user.</p><p>   Pixie＆＃39; s auth服务使用Hydra验证访问令牌，以确保它正在接收来自用户的合法请求。</p><p> Hydra responds that the access token is valid, and Pixie&#39;s Auth service generates an augmented token. This augmented token is stored as part of the user&#39;s encrypted session cookie. When the UI makes subsequent requests to auth-restricted endpoints, the API-service verifies the augmented token stored in the user&#39;s session.</p><p> Hydra响应访问令牌是有效的，并且Pixie＆＃39; s auth服务生成增强令牌。这一增强令牌作为用户的一部分存储，并将其加密会话cookie存储。当UI使后续请求对Auth-受限的终端进行后，API服务验证存储在用户中的增强令牌＆＃39; s会话中的增强令牌。</p><p>  With the Hydra/Kratos implementation for authentication, the following users will be able to use Pixie:</p><p>  使用Hydra / kratos的身份验证实现，以下用户将能够使用Pixie： </p><p> Users who need a fully open source observability solution that works out of the box</p><p>需要完全开源可观察性解决方案的用户，该解决方案开箱即用</p><p>   Given the benefits, we will still support Auth0 in Pixie. Pixie users will have the choice of configuring their deployment with Auth0 or relying on Kratos and Hydra. We reduced the auth solution to a simple interface, as shown in the following diagram.</p><p>   鉴于好处，我们仍将在Pixie中支持auth0。 Pixie用户将选择使用Auth0配置其部署或依赖Kratos和Hydra。我们将Auth解决方案减少到简单的界面，如下图所示。</p><p>     We are big fans of both Auth0 and Ory&#39;s Hydra/Kratos. Each comes with their own sets of trade-offs and we offer both options to enable our users to choose the use case that works best for them. Most importantly, both solutions are vetted by security experts and hardened by their wide user-base. Pixie&#39;s development team can spend less time worrying about security and instead focus on  making our no-instrumentation observability platform better. We hope this blog post will help you decide which auth solution works best for you.</p><p>     我们是Auth0和Ory＆＃39; s hydra / kratos的大粉丝。每个都带有自己的权衡，我们提供两个选项，使我们的用户能够选择最适合它们的用例。最重要的是，两种解决方案都被安全专家审查，并由其广泛的用户基础硬化。 Pixie＆＃39; S的开发团队可以花费更少的时间担心安全性，而是专注于使我们的无仪器观察性平台更好。我们希望这个博客帖子有助于您决定哪种Auth解决方案最适合您。</p><p> If you want to dive into our auth code, check out our  Github. If you have any questions about the topic, join our  Slack and send us a message.</p><p> 如果您想潜入我们的Auth代码，请查看我们的GitHub。如果您对该主题有任何疑问，请加入我们的懈怠并向我们发送一条消息。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.pixielabs.ai/open-source-auth/ossauth/">https://blog.pixielabs.ai/open-source-auth/ossauth/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/hydra/">#hydra</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/oss/">#oss</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>