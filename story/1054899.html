<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>MIPS R4000，第9部分：愚蠢的分支延迟插槽技巧 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">MIPS R4000，第9部分：愚蠢的分支延迟插槽技巧 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-29 00:34:00</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/3/d5ac22b6724f715986d70f6c316f3742.jpg"><img src="http://img2.diglog.com/img/2021/3/d5ac22b6724f715986d70f6c316f3742.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>最后一次，我们了解了MIPS分支延迟插槽。今天，我们会看一些可以使用分支延迟插槽的一些技巧。</p><p> 第一个技巧：跳入分支延迟插槽是合法的。当然，当你这样做时，它不是分支延迟插槽。这使您可以编写一些古怪的代码：</p><p>  当拍摄无条件分支时，在分支目标继续执行之前，V0寄存器将设置为零。</p><p> 同时，如果有人跳到标签，则执行在标签上继续执行，该标签将v0设置为零，然后继续使用其他内容。</p><p> 标签的指令作为前提条分支的分支延迟插槽，但如果有人直接跳入其中，它也是基本块中的第一个指令。</p><p> 我已经看到这类“挤出单一指令”优化出现的机会，但Microsoft编译器不会利用它。这可能是一件好事。 （对于一件事而言，二进制转换工具使程序变得更加困难，以将程序分解为基本块并以不同方式重新组合它们。）</p><p> 另一个愚蠢的分支延迟插槽技巧是作为跳转的一部分编辑返回地址。 </p><p>BAL指令将RA寄存器设置为指向分支延迟插槽后的指令，这在我们的情况下是第一个NOP。但在分支延迟插槽中，我们修改了RA寄存器，以便在执行达到被叫过程的开始时，它获得了人工返回地址。</p><p> 我被告知某种诀窍由某些编译器使用，将呼叫和无条件跳入呼叫与虚假返回地址。例如，在此代码片段中</p><p> 如果（...）{...功能1（...）; } else {...} //恢复x = 0;</p><p> 对Function1的调用可能之后是无条件跳转以跳过其他分支。</p><p> BAL功能1 NOP;垃圾在分支延迟插槽B恢复或v0，零，零;设置x = 0 ... else-branch代码在这里......或v0，零，零;设置x = 0resume：...</p><p>  BAL功能1 ADDIU RA，RA，RESUME  -  Nominal_Return;调整返回addrationnominal_return：... else-branch代码进入这里...恢复：或v0，零，零;设置x = 0 ...</p><p> 在分支延迟插槽中，我们编辑返回地址，以便在函数1返回时，它恢复在恢复而不是nominal_return时执行，从而避免必须执行另一个分支指令。 （我们还能够删除已挂起的重复或v0，零，零指令，该指令已挂起到无条件分支的分支延迟插槽。）请注意，只有您在分支延迟插槽中有一个垃圾nop，只能获得此节省。如果那里有一个有用的指令，那么转换就会这样： </p><p>//原始代码BAL功能1移动A0，R0;函数B恢复或v0的参数，零，零;设置x = 0 // Sneaky代码移动A0，R0;设置函数Bal功能的参数1 Addu Ra，RA，......;调整返回地址：或v0，零，零;设置x = 0</p><p> BAL指令的分支延迟插槽中的指令必须进入其他地方，因此您没有保存任何时间（尽管您仍然通过避免重复或v0，零，零）保存一个空间指令。</p><p> 但正如我们早些时候所看到的那样，这个技巧击败了返回地址预测器，¹所以这可能是一个坏主意。</p><p> 好的，下次，我们将更加密切地查看呼叫大会。</p><p> 奖金Chatter：另一个额外的偷偷摸摸的技巧正在重用返回地址。假设您的解释器循环如下：</p><p> void解释器_loop（译员_state * state）{for（;;）{uint32_t opcode = * state-＆gt; pc;国家 - 和gt; PC ++; jump_table [操作码]（状态，操作码，状态 - ＆gt; pc）; }}</p><p> 解释器循环将永远调度到下一个操作码。据推测，您将用Longjmp或其他一些非函数转移突破这个循环。 </p><p>处理程序函数被赋予当前的解释器状态（所以它可以更新它），并且作为礼貌，它还可以根据便利性获取当前操作码和指向下一个解单字节的指针。</p><p> 译员_Loop：...移动S0，A0; S0指向解释器状态LA S1，Jump_Table La Ra，Next_opcode;脚注²next_opcode：LW V1,80（S0）;获取下一个操作码字节Addu A2，V1,1的地址;移动到下一个操作码字节（处理程序的参数）lbu a1,0（v1）;加载当前操作码字节（处理程序的参数）SW A2,80（S0）;将指针保存到下一个操作码字节SLL T0，A1,2;多个乘4到索引跳转表Addu T0，T0，S1;计算跳转表LW V0，0（T0）中的条目;加载跳转目标JR V0;跳转到处理程序 - 将返回到Next_opcode Move A0，S0;处理程序的论据</p><p> 当我们调用第一个处理程序时，RA设置为等于Next_opcode。该处理程序将完成其工作，然后通过将返回地址恢复到RA寄存器并执行JR RA来返回调用者。</p><p> 这意味着当控制返回到next_opcode时，您知道RA等于Next_opcode！由于这是您想要在该寄存器中的价值，无论如何，当您跳转到下一个处理程序时，您就可以将其留在那里，从而节省您必须明确地分支到Next_opcode的麻烦。</p><p> 这似乎是一个非常聪明的技巧，但它在实践中可能并不是那么返回地址预测的东西。</p><p> ¹另一方面，MIPS R4000没有单独的操作码用于“跳转到注册”，并且“跳转间接以获得返回的目的”;它使用两种情况的JR指令。</p><p> 无法区分跳跃指令是语义上的返回指令是MIPS架构的原始实现中的非问题。它只有一个两级管道，所以单个分支延迟槽就足以避免需要预测任何分支。 </p><p>MIPS R4000有一个四阶段管道，并且分支错误规定将遭受2个周期的摊位。 MIPS设计人员编码了现有的实践并追溯宣布，如果JR指令中的寄存器操作数是RA，则它将其预测为子程序返回; 否则它预测计算跳跃。  ²为额外的窃款（并保存指令），³循环准备代码可以写成  LA S1，Jump_Table Bal Next_Opcode Move S0，A0; S0指向Interpreter StateNext_opcode：  此版本允许处理器通过执行bal来计算Next_opcode的地址。 这将返回地址设置为分支延迟插槽后的指令，这是next_opcode，然后跳转到... next_opcode，这就是指令已经消失的地方。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://devblogs.microsoft.com/oldnewthing/20180412-00/?p=98495">https://devblogs.microsoft.com/oldnewthing/20180412-00/?p=98495</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/延迟/">#延迟</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/r4000/">#r4000</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/返回/">#返回</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1053062.html"><img src="http://img2.diglog.com/img/2021/3/thumb_95e30af2803e1b62dc04dbd82ab78efe.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1053062.html">每秒亿次在毫秒延迟的事件：Giga-Scale的Nexmark </a></div><span class="my_story_list_date">2021-3-18 3:36</span></div><div class="col-sm"><div><a target="_blank" href="/story/1052163.html"><img src="http://img2.diglog.com/img/2021/3/thumb_a1e44856d2ee3c9600158e754555bbe9.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1052163.html">Web爬网延迟实验 </a></div><span class="my_story_list_date">2021-3-13 14:27</span></div><div class="col-sm"><div><a target="_blank" href="/story/1049347.html"><img src="http://img2.diglog.com/img/2021/2/thumb_0ea0cf1e436ebbe178eac8ed6b6e16bf.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1049347.html">实施“延期” </a></div><span class="my_story_list_date">2021-2-25 19:41</span></div><div class="col-sm"><div><a target="_blank" href="/story/1044395.html"><img src="http://img2.diglog.com/img/2021/1/thumb_917822b255ef05671697dfade6ec396d.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1044395.html">用户强烈反对之后，WhatsApp延迟推出新的隐私工具 </a></div><span class="my_story_list_date">2021-1-16 3:59</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>