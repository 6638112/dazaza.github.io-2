<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Datasette-ripgrep：用于您的源代码的正则表达式搜索引擎</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Datasette-ripgrep：用于您的源代码的正则表达式搜索引擎</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-28 19:19:51</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/11/f6673761bbaf765b0771949796d16529.png"><img src="http://img2.diglog.com/img/2020/11/f6673761bbaf765b0771949796d16529.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>本周，我构建了datasette-ripgrep，这是一个基于源代码运行正则表达式搜索的Web应用程序，基于令人惊叹的ripgrep命令行工具构建。</p><p>    该演示针对我的每个以数据集开头的GitHub存储库（目前为61个存储库）的源代码进行搜索，因此它应包括我的所有Datasette插件以及核心Datasette存储库本身。</p><p> 由于它在ripgrep之上运行，因此支持正则表达式。这是非常有用的。一些例子：</p><p>  我通常会在命令行上以rg的形式运行ripgrep，或者在Visual Studio Code中使用它（有趣的事实：VS Code的“查找文件”之所以如此出色，是因为它在后台运行ripgrep）。</p><p> 那么为什么将其作为Web应用程序呢？因为这意味着我可以链接到它，将其添加为书签并在手机上使用。</p><p>   已经有许多出色的现有代码搜索工具：我听说过关于livegrep的很棒的事情，而Google的快速搜索显示了很多其他选择。</p><p> 除了是一个有趣的项目之外，datasette-ripgrep还具有一个关键优势：它可以从Datasette的发布机制中受益，这意味着它真的很容易部署。</p><p>通过将要搜索的源代码检出到all目录中，然后使用以下命令来部署ripgrep.datasette.io演示：</p><p> 数据集发布cloudrun \ --metadata metadata.json \ --static all：all \ --install = datasette-ripgrep \ --servicedatasette-ripgrep \ --apt-get-install ripgrep</p><p>   这里的所有都是它的！结果是在Google Cloud Run上运行了已部署的代码搜索引擎。</p><p> （如果您想自己尝试，则需要从GitHub安装Datasette，它使用的--apt-get-install命令是新命令，并且尚未发布。）</p><p> 部署该演示的GitHub Action工作流还使用我的github-to-sqlite工具获取我的存储库，然后浅克隆以数据集开头的存储库。</p><p> 如果您拥有自己的Google Cloud Run凭据，则可以针对自己的存储库运行该工作流程的副本。</p><p>  Datasette是用于发布SQLite数据库的工具，因此大多数Datasette插件都以某种方式与SQLite集成。</p><p>datasette-ripgrep有所不同：它完全不使用SQLite，而是利用Datasette的URL路由，datasette发布部署和权限系统。</p><p>  虽然该插件不使用SQLite，但确实与Datasette有着共同的理念：该插件将要搜索的源代码作为已部署的应用程序的一部分捆绑在一起，类似于Datasette通常捆绑一个或多个SQLite的方式数据库文件。</p><p> 因此，它的运行成本极其低廉，可以部署到无服务器托管中。如果需要缩放，可以运行更多副本。</p><p> 这确实意味着需要重新部署应用程序以获取对可搜索代码的更改。我可能会设置演示以每天执行一次。</p><p>  实现过程中最棘手的部分是弄清楚如何使用Python的asyncio.create_subprocess_exec（）方法来安全地运行rg进程以响应传入的请求。</p><p> 我不希望使用昂贵的搜索来占用服务器，因此在此实施了两个限制。第一个是时间限制：默认情况下，搜索有第二个运行时间，此后将终止rg进程，并且仅返回到目前为止接收到的结果。这可以使用asyncio.wait_for（）函数来实现。</p><p> 我还对可返回的匹配行数实施了限制，默认为2,000。除此之外，该过程将尽早终止。</p><p>我本周的另一个项目是对til.simonwillison.net的升级：我终于花了一些时间为网站设计更好的URL。</p><p>     为此，我利用了一个潜入Datasette 0.49：自定义页面模板的路径参数的功能。我可以创建一个名为pages / {topic} / {slug} .html的模板文件，然后Datasette使用该模板来处理与该模式匹配的404错误。</p><p> 这是我的TIL网站的新页面/{topic}/{slug}.html模板。它使用来自datasette-template-sql插件的sql（）模板函数来检索和呈现匹配的TIL，如果找不到TIL，则加4040。</p><p> 我还需要设置从旧页面到新页面的重定向。我在Datasette的edirects上写了一篇TIL，解释了我是如何做到的。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://simonwillison.net/2020/Nov/28/datasette-ripgrep/">https://simonwillison.net/2020/Nov/28/datasette-ripgrep/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/代码/">#代码</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ripgrep/">#ripgrep</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/datasette/">#datasette</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1036676.html"><img src="http://img2.diglog.com/img/2020/11/thumb_6c9f01b7e2108ebd589e3e7212b4aac3.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1036676.html">前Googler开发工具指南</a></div><span class="my_story_list_date">2020-11-26 15:14</span></div><div class="col-sm"><div><a target="_blank" href="/story/1036126.html"><img src="http://img2.diglog.com/img/2020/11/thumb_e9da784083bedf15db089070f96f2044.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1036126.html">Django重构游戏–您可以修复所有的Models反模式吗？</a></div><span class="my_story_list_date">2020-11-24 5:16</span></div><div class="col-sm"><div><a target="_blank" href="/story/1036110.html"><img src="http://img2.diglog.com/img/2020/11/thumb_9c09df6ce6a87fbab7b583a457a7c8ee.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1036110.html">“代码就是酵母”</a></div><span class="my_story_list_date">2020-11-24 1:9</span></div><div class="col-sm"><div><a target="_blank" href="/story/1036092.html"><img src="http://img2.diglog.com/img/2020/11/thumb_ae7347ab153eadc232c0c009402c8d72.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1036092.html">Serenade获得210万美元的种子轮融资，将语音转换为代码</a></div><span class="my_story_list_date">2020-11-23 23:24</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>