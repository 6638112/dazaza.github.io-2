<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>ZIG与LLVM的新关系</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">ZIG与LLVM的新关系</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-28 23:24:37</div><div class="page_narrow text-break page_content"><p>虽然还没有发布1.0版，但Zig即将达到成熟和稳定的新水平。</p><p>在早期，Zig只是LLVM面前的一个薄薄的前端。这对于快速入门和填补Andrew作为编译器开发人员的知识空白很有帮助。现在，自行车的训练轮正在脱落，LLVM正在转变为一个可选部件。</p><p>用新的纯Zig版本替换当前C++编译器实现的工作已经开始。转向自托管实现通常被认为是走向成熟的一步，语言本身的开发人员感受到了最大的好处。例如，Go通过切换到自托管编译器而损失了一些编译速度，但作为交换，它简化了工具链，消除了依赖，并改善了整个开发体验。</p><p>转移到Zig的自托管编译器对核心贡献者有类似的优势，但它也使LLVM成为可选的依赖项，提高编译速度(而不是失去它)，并为代码的调试版本添加了一个令人惊叹的特性：使用就地二进制修补的增量编译，这是另一个独特的Zig特性。</p><p>大多数语言都提供某种形式的缓存来加快编译速度，从C的编译单元开始，一直到更现代语言中的模块、包和其他类似的边界。</p><p>Zig还实现了一个缓存系统，在构建混合了C和Zig源代码的项目时，或者将Zig用作带有zig cc命令的C编译器时，该系统特别方便。ZIG跟踪编译过程中涉及的所有文件，因此可以非常容易地知道目标文件何时可以重用，而这只是使用ZIG编译C代码的优势之一。</p><p>Zig源代码总是捆绑到单个编译单元中，因此当前形式的缓存系统在编辑和重新编译纯Zig项目时不会提供任何加速。好处是，不仅编译Zig代码非常快，而且增量编译将为Zig代码提供智能缓存，而不仅仅是弥补了我们无法从简单缓存中获得的东西。</p><p>增量编译是一种缓存形式，它在比正常的“编译单元”级缓存更高的粒度级别进行操作。Rust博客有一篇很棒的帖子，解释了它是如何工作的。</p><p>对于Rust，编译器在AST级别构建依赖图，然后将其与缓存的中间结果(目标文件)一起保存到磁盘。当请求新的编译时，编译器将能够很容易地注意到AST的哪些部分已经更改，从而使依赖于它的所有中间结果无效。</p><p>关于此图的一个重要细节是，最右边的框始终是无效的。换句话说，最终的可执行文件总是从头开始重新链接，从旧的和新生成的目标文件混合开始。很明显，情况肯定是这样的，因为最终的可执行文件依赖于其他所有东西，所以对代码的任何有意义的更改都会使其无效，但这正是Zig自托管编译器为表带来新的巧妙想法的地方。</p><p>从Zig版本0.6.0开始，无论发布的类型是什么(调试、安全发布、快速发布)，总会有最后一步委托给LLVM，这至少会占用总编译时间的70%，包括编译调试版本时，其中甚至没有启用优化。</p><p>自托管编译器将不依赖于LLVM进行调试构建，并且将能够显著缩短编译时间，基本上将这70%减少到几乎为零，因为与LLVM相比，它是一款更简单的软件。</p><p>最重要的是，由于编译器将完全控制整个过程，因此它将使用针对增量编译进行优化的特别策略生成机器码，从而允许编译器使用新的更改就地修补最终的可执行文件。</p><p>就地二进制打补丁基于顶级声明的粒度。每个全局变量和函数都可以独立打补丁，因为最终的二进制文件被构造为一系列松散耦合的块。另一个重要特征是所有这些信息都保存在内存中，因此编译器将在两次编译之间保持打开状态。</p><p>如果您想看看自托管编译器的运行情况，下面是Andrew的5分钟演示：</p><p>高效的就地二进制修补只能通过紧密耦合编译器前端和后端来实现。这个特性在野外非常少见的部分原因是它违背了我们更好的抽象感和干净的代码组织。但我们永远不能忘记：抽象只是达到实际结果的一种工具，并不总是最合适的工具。</p><p>为了执行就地二进制修补，我们需要代码与位置无关。这允许我们在函数在其分配的边界之外增长时，在虚拟内存中移动它。我们还需要能够间接引用虚拟地址，以便在将函数移动到新的虚拟地址时不需要更新N个调用点。</p><p>然而，这只解决了函数问题。这里需要考虑更多组件，例如调试信息。当我们向函数添加新行时，它会修改调试信息，该信息用于打印堆栈跟踪！解决这一问题需要创造性地组织调试行信息的分配方案，并找出如何进行NOP。安德鲁在这里的旅程包括创建一个新的矮人线路号码操作码的提案。</p><p>对于每种链接后端-ELF、DWARF、PE、PDB、MACO和WebAssembly，这个问题都必须反复解决。特别感谢挺身而出并接受支持就地二进制修补的额外挑战的贡献者：Alexandros Naskos、Jakub Konka和Isaac Freund。</p><p>请关注Andrew的博客上更具技术性的帖子，在那里他将深入研究这些引人入胜的细节-包括这种设计如何让我们达到90%的热代码交换！</p><p>自托管后端仍在进行中，但本文中提供的所有功能都经过了设计和原型设计，现在只需要完成工作的有条不紊的部分。</p><p>自托管后端将在一个FLAG后面发布Zig 0.7.0，只支持Zig语言的一个子集。与此同时，核心开发团队和其他一些贡献者正在冲刺，提供更多的语言支持和更多的目标。目前的目标是用Zig 0.8.0的自托管后端完全取代C++实现，大约7个月后。</p><p>如果你喜欢Zig要去的地方，现在是加入Zig社区的最佳时机，如果你想帮助加快开发速度，请考虑捐赠给Zig软件基金会，让核心开发者花更多的时间在Zig上。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://kristoff.it/blog/zig-new-relationship-llvm/">https://kristoff.it/blog/zig-new-relationship-llvm/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/llvm/">#llvm</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/zig/">#zig</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>