<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>使用 Tcl 解析器工具解析 Excel XLSX (2011)</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">使用 Tcl 解析器工具解析 Excel XLSX (2011)</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-08-05 20:58:37</div><div class="page_narrow text-break page_content"><p>这是我编写的一些代码，用于解析和评估 Excel 2008 xml 格式电子表格中的公式。我使用 perl 以 Excel 格式生成了一些非常复杂的报告（XLSX:Excel:Writer Using Perl to get Excel），所以我的 xlsx 输出文件没有为每个单元格预计算的值，默认情况下 excel 写入其输出的方式。为了测试和验证我推送给客户的值，我需要能够评估我编写的公式。这是一个相当长的故事，但它以使用 tcllib 1.13 中的 Tcl 解析器工具的示例开始：PEG xlsexpr (Formula) Formula &lt;- Expr EOF ; MulOp &lt;- &#39;&lt;&#39; / &#39;&gt;&#39; / &#39;=&#39; / &#39;*&#39; / &#39;/&#39; ; Expo &lt;- Value (&#39;^&#39; Value)？ ; Prod &lt;- Expo WS (MulOp WS Expo)*； AddOp &lt;- &#39;^&#39; / &#39;+&#39; / &#39;-&#39; ; Sum &lt;- Prod WS (AddOp WS Prod)* ; Expr &lt;- 总和;无效：WS &lt;- &lt;空格&gt;* ;价值 &lt;- UnOp？ ( &#39;(&#39; Expr &#39;)&#39; / String / Func / Range / Cell / Number ) ; UnOp &lt;- &#39;-&#39; / &#39;+&#39; ; Func &lt;- FunName &#39;(&#39; WS FunArgs WS &#39;)&#39; ; FunName &lt;- &lt;alpha&gt;&lt;alnum&gt;* ; FunArgs &lt;- Expr WS (&#39;,&#39; WS Expr)* ;范围 &lt;- 表？ RowCol &#39;:&#39; RowCol ;单元格 &lt;- 表？细胞_ ;工作表&lt;-“&#39;”？床单_ ”&#39;”？ &#39;！ ; Sheet_ &lt;- [-A-Za-z0-9&amp; ]+ ; Cell_ &lt;- &lt;alpha&gt;+&lt;ddigit&gt;+ ; RowCol &lt;- Col_ Row_ ; Col_ &lt;- &lt;alpha&gt;+ ;行_ &lt;- &lt;ddigit&gt;+ ;字符串 &lt;- &#39;&quot;&#39; [A-Za-z0-9]* &#39;&quot;&#39; ;叶子：数字 &lt;- 符号？ ( &lt;ddigit&gt;+ Frac? ) / Frac? ;符号 &lt;- &#39;-&#39; / &#39;+&#39; ;压裂 &lt;- &#39;.&#39; &lt;ddigit&gt;* ; EOF &lt;- !. ;结尾;这是一个生成 Excel 表达式解析器的 Makefile。我想要解析器工具来为 TclOO 生成解析器，但是 oo:: 的评估器失败了，所以我最终使用了 snit。 sed 命令修复了解析器工具输出中的一个小错误： PT=pt parser : xls-parser.peg $(PT) generate snit -class xls-parser -name xls-parser xls-parser.tcl peg xls-parser。 peg sed -es/PACKAGE/xls-parser/ &lt; xls-parser.tcl &gt; tmp mv tmp xls-parser.tcl 这是顶级驱动程序。这里有趣的命令是“比较”。它两次加载相同的电子表格，从任何包含一个副本的公式的单元格中清除 excel 提供的值，然后将这些值与单元格的 tcl 评估值进行比较。 #!/bin/env tclkit8.6 # 源 xml.tcl ; # 这是税源 xlsx.tcl package require vfs package require vfs::zip set argv [lassign $argv op] switch $op { form { lassign $argv file sheet cell workbook create wb $file puts [[wb name2obj $sheet] form $cell] } cell { lassign $argv file sheet cell workbook create wb $file puts [[wb name2obj $sheet] cell $cell] } cell+ { lassign $argv file sheet cell workbook create wb $file wb clear puts [[wb name2obj $sheet] 单元格？ $cell] } cells { workbook create wb [lindex $argv 0] foreach name [wb sheet] { set sheet [wb name2obj $name] puts [list $sheet [$sheet cells]] } } compare { lassign $argv file1 file2 workbook create wb1 $file1 workbook create wb2 $file2 wb2 clear foreach name1 [wb1 sheet] name2 [wb2 sheet] { if { $name1 ne $name2 } { puts &quot;Sheet names don&#39;t match $name1, $name2&quot; } set sh1 [wb1 name2obj $name1] set sh2 [wb2 name2obj $name2] foreach cell [$sh1 cells] { #puts &quot;$name1 $cell&quot; if { [set v1 [$sh1 cell $cell]] != [set v2 [$ sh2 cell $cell]] } { puts &quot;$name1 : $cell $v1 != $v2&quot; } } } } } 这是代码的主要内容。它将近 500 行，所以我只在这里引用它：https://github.com/jbroll/xlsx-expr</p><p>包括打开 xlsx 文件并将 xml 中的单元格值、公式和格式解析为 xlsx 对象中的实例变量数组的方法。 “=”方法计算单元格的值，包括通过电子表格中的所有引用遵循公式。每个公式值仅缓存和评估一次。通过使用解析器工具将它们解析为 AST 格式，然后将 AST 作为脚本执行来评估公式。脚本的结果是一个适合 expr 的表达式，然后调用它来获取单元格的值。这里只实现了足够的东西来支持我的电子表格中的语法和函数，但扩展它应该是直接的。我已经评估了带有多个工作表的工作簿，跨越数千个单元格的复杂公式，与 excel 自行计算的值完全一致。解析器使用 tcl::chan::string 提供，它需要一个小补丁。 Allowance 方法被破坏，所以我只是在 virtchannel_core/events.tcl:Allowance 的开头添加了一个“返回”以禁用任何检查。无论如何，这种检查对我来说似乎太过分了。 AK：检查是必要的。我 2009 年关于反射和转换通道的会议论文（在 TCA 会议页面上）解释了这些内部结构。实际问题是缺少构造函数链阻止了事件管理核心的正确初始化。在源存储库头中修复。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://wiki.tcl-lang.org/page/Parsing+Excel+XLSX">https://wiki.tcl-lang.org/page/Parsing+Excel+XLSX</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/tcl/">#tcl</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/excel/">#excel</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/lt/">#lt</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>