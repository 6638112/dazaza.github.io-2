<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>关闭旧API的正确方法 The right way to turn off your old APIs</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">The right way to turn off your old APIs<br/>关闭旧API的正确方法 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-23 13:51:32</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/1/a18b32c935f0a731a71b0a16c1baded8.jpg"><img src="http://img2.diglog.com/img/2021/1/a18b32c935f0a731a71b0a16c1baded8.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>All things come to an end, even HTTP APIs. However great your API may be today, one day you&#39;ll want to release a completely new version, an improved but incompatible endpoint, a new parameter that solves the same problem better, or to shut down your API entirely. Your current API will not be live forever.</p><p>一切都结束了，甚至HTTP API也是如此。无论您的API在今天有多棒，有一天您都希望发布一个全新的版本，一个经过改进但不兼容的终结点，一个可以更好地解决同一问题的新参数，或者完全关闭您的API。您当前的API不会永远有效。</p><p> Inconveniently though, your API has clients. If you shut down endpoints, parameters, or entire APIs without properly warning them then they&#39;re going to be very unhappy.</p><p> 不过，您的API有客户端，这很不方便。如果您关闭端点，参数或整个API，而没有正确警告它们，那么它们将非常不高兴。</p><p> How do you shut down your APIs safely, making it at easy as possible for your users?</p><p> 您如何安全地关闭API，以使其对您的用户尽可能简单？</p><p> There are right ways to do this, including two new draft headers being standardized by the exciting new IETF &#34;Building Blocks for HTTP APIs&#34; working group, designed to help with this exact process. Let&#39;s take a look.</p><p> 有正确的方法来执行此操作，包括由令人兴奋的新IETF＆＃34; HTTP API的构建块＆＃34;标准化两个新的草稿标头。工作组，旨在帮助完成这一确切过程。让我们来看看。</p><p>   Hopefully you have some API metrics or at least logging somewhere. If you don&#39;t, add some! If you do, and you can tell for sure that nobody is using this API anymore, then you win. Turn it off right now, delete the code, skip this article and have a well-deserved nap.</p><p>   希望您有一些API指标，或者至少在某个地方记录日志。如果您不添加，请添加一些！如果这样做，您可以确定没有人再使用此API，那么您将获胜。现在将其关闭，删除代码，跳过本文，小憩片刻。</p><p> The next question, if you&#39;re not napping, is to ask yourself is whether there&#39;s an alternative to shutting down this API. Everything you turn off will break somebody&#39;s code and take their time to fix it. It&#39;s good for the health of your client ecosystem and the web as a whole if APIs keep working.</p><p> 如果您没有睡午觉，那么下一个问题是问自己：是否有替代此API的替代方法。您关闭的所有内容都会破坏某人的代码并花费时间进行修复。如果API继续运行，则对于客户端生态系统和整个Web的健康都是有益的。</p><p> In many cases, old APIs can be translated internally, to transparently transform requests into calls to a new API instead, without maintaining two completely independent versions. This is a fundamental part of  the API versioning approach at Stripe who include transformations with all API changes to ensure that requests for incompatible old versions continue to work as before, automatically translating the requests and responses to use the newer code as required.</p><p> 在许多情况下，可以在内部转换旧的API，从而透明地将请求转换为对新API的调用，而无需维护两个完全独立的版本。这是Stripe API版本控制方法的基本组成部分，该方法包括所有API更改的转换，以确保对不兼容的旧版本的请求继续像以前一样工作，并自动转换请求和响应以根据需要使用更新的代码。 </p><p> Translation like this isn&#39;t always possible, and doing so  forever can entail significant extra complexity, but if you can do it, this can provide a valuable stability for your users, and avoid a lot the work required for deprecation or old version maintenance.</p><p>这样的翻译并非总是可能的，永远这样做可能会带来极大的额外复杂性，但是如果您能够做到，则可以为您的用户提供宝贵的稳定性，并且避免了很多弃用或过时的工作保养。</p><p> However, if this service/endpoint/parameter is in use in production, and it&#39;s not practical to keep supporting it, it&#39;s got to go.</p><p> 但是，如果该服务/端点/参数在生产中正在使用，并且持续支持它是不切实际的，那就必须走了。</p><p>  When should they start migrating away from this API? Is your proposed replacement ready to use today?</p><p>  他们应该何时开始从该API迁移？您提议的替代品是否可以立即使用？</p><p> What&#39;s the deadline? I.e. when will this API stop working completely? (If you&#39;re not totally sure yet, you can delay this answer for a little bit).</p><p> 截止日期是几点？即该API何时会完全停止运行？ （如果您还不太确定，则可以延迟一点答案）。</p><p>    Email your mailing list, post it on Twitter, update your API specification if you have them (e.g. OpenAPI has a  deprecated field on  operations and  parameters), and highlight this loudly in the relevant documentation online.</p><p>    通过电子邮件发送您的邮件列表，将其发布到Twitter上，如果有的话，更新您的API规范（例如，OpenAPI的操作和参数字段已弃用），并在在线相关文档中大声地突出显示。</p><p> You should include all the info above: what they should do instead, when you recommend they start migrating, and the deadline when they  must migrate (if you have one).</p><p> 您应该包括上面的所有信息：它们应该做些什么，何时建议他们开始迁移以及必须迁移的截止日期（如果有的话）。</p><p> Once you&#39;ve told the humans, it&#39;s time to tell the computers. This is where the new IETF headers come in.</p><p> 告诉人类后，就该告诉计算机了。这是新的IETF标头出现的地方。 </p><p>  The  Deprecation header tells clients that the requested resource still works as before, but is no longer recommended. You can state that very simply with a single HTTP header:</p><p>“不赞成使用”标头告诉客户端所请求的资源仍然可以像以前一样工作，但是不再建议这样做。您可以使用单个HTTP标头非常简单地说明这一点：</p><p>  Alternatively, you can provide a date. This date tells users when they should start migrating elsewhere. This can be in the past (if they should start migrating immediately) or the future (usually meaning that the thing they should migrate to isn&#39;t ready yet). Like so:</p><p>  或者，您可以提供日期。该日期告诉用户何时应该开始迁移到其他地方。可以是过去（如果他们应该立即开始迁移）或将来（通常意味着他们应该迁移到的东西还没有准备好）。像这样：</p><p>  If you&#39;re deprecating the whole endpoint or service, you can just return this with every response. If you&#39;re deprecating a specific feature, perhaps a parameter, request method, or a certain field in the request body, then you want to just return this in requests when that feature is used.</p><p>  如果您不赞成使用整个端点或服务，则只需在每个响应中将其返回即可。如果您不赞成使用特定功能，例如参数，请求方法或请求正文中的特定字段，那么您只想在使用该功能时在请求中返回该功能。</p><p> To give the client more information, you can use  Link HTTP response headers to link to endpoints or human-readable documentation elsewhere. You can more than one of these in combination in the same  Link header, by just comma-separating them (we&#39;ll see a full example later). The spec defines 4 links related to deprecation:</p><p> 要向客户端提供更多信息，您可以使用Link HTTP响应标头链接到端点或其他地方的可读文档。您可以在同一个Link标头中组合使用多个逗号，只需用逗号分隔即可（稍后将看到完整的示例）。规范定义了4个与弃用相关的链接：</p><p>    This is the main way to tell your users what&#39;s going on, and what they should do about it. You almost always want to use this! If you don&#39;t have the full details and a final shutdown date yet, then even a placeholder saying that will be helpful. In that case, don&#39;t forget to let users subscribe for updates, with a mailing list or RSS or similar, so they can hear about the full plan once it&#39;s ready.</p><p>    这是告诉您的用户正在发生的事情以及他们应该怎么做的主要方法。您几乎总是想使用它！如果您还没有完整的详细信息和最终的关闭日期，那么即使是占位符也将有所帮助。在这种情况下，请不要忘记让用户使用邮件列表或RSS或类似内容来订阅更新，这样，一旦准备就绪，他们就可以听到有关完整计划的信息。</p><p>  If you want clients to move to the latest version of the same endpoint of your API, use this to point them there, like so:</p><p>  如果您希望客户端移动到API相同端点的最新版本，请使用此命令将它们指向那里，如下所示：</p><p>   If you have multiple versions of your API available, it&#39;s usually nicer to migrate one version forwards at a time, rather than jumping straight from the oldest now-deprecated version to the latest. To help with this, you can link to the  next version of the deprecated endpoint, not just the latest, like so:</p><p>   如果您有多个版本的API，通常一次迁移一个版本通常会更好，而不是直接从最早的旧版本过渡到最新的版本。为了解决这个问题，您可以链接到不建议使用的端点的下一版本，而不仅仅是最新版本，如下所示： </p><p>   If there&#39;s no new equivalent version of this API, and users should migrate to a totally different resource that might be a good substitute, you can use alternate links to indicate that:</p><p>如果此API没有新的等效版本，并且用户应迁移到完全可以替代的完全不同的资源，则可以使用备用链接指示：</p><p>   Once you know when the API is going to shutdown entirely, you should add a  Sunset header.</p><p>   一旦知道API何时完全关闭，就应该添加一个Sunset标头。</p><p> The Sunset header tells clients when this will stop working. It&#39;s a hard deadline: API clients  must move elsewhere before this date, and you promise not to break anything until then.</p><p> Sunset标头会告诉客户端何时停止运行。这是一个艰难的截止日期：API客户端必须在此日期之前转移到其他地方，并且您保证在此之前不会破坏任何内容。</p><p> You must provide a date here, and it  should be in the future. If it&#39;s in the past, that&#39;s OK though: at that point you&#39;re effectively saying &#34;this could turn off at any moment you need to stop using it immediately&#34;. It looks like this:</p><p> 您必须在此处提供日期，并且应该在将来。如果是过去的话，那还是可以的：在那一点上，您实际上是在说＆nbsp;＆nbsp;这可能会在您需要立即停止使用的任何时候关闭。看起来像这样：</p><p>  This is super simple, and can be used for more than just API shutdowns: you can use it to signal HTTP redirects that will come in the future for URL migrations, or to indicate limited lifetimes of certain URLs (for content that&#39;s temporary by nature, or for regulatory reasons like data retention policies on certain resources). All it says is &#34;this endpoint may stop doing what you expect after this date, be ready&#34;.</p><p>  这非常简单，不仅可以用于关闭API：您还可以使用它来表示将来会进行URL迁移的HTTP重定向，或者表示某些URL的生存期有限（对于那些本质上是临时的，或出于监管原因（例如某些资源的数据保留政策）。它只说＆＃34;此端点在此日期之后可能会停止做您期望的事情，请准备好＆＃34;。</p><p>  This spec also provides a sunset link relationship. This is designed to link to more information about your plan for shutting down this specific endpoint (probably the same documentation as your deprecation link, if you have one) or about the general sunset policy for your service. Like so:</p><p>  该规范还提供了日落链接关系。该链接旨在链接到有关关闭该特定终结点的计划的更多信息（如果有的话，可能与弃用链接相同的文档），或有关服务的常规日落策略的更多信息。像这样：</p><p>  This is a good place to point out that a general sunset policy is a very useful thing! A sunset policy tells clients when you shut down endpoints (e.g. 1 year after a replacement goes live) how users should ensure they hear about this (mailing lists, status pages, HTTP headers, you name it), what they should usually do about it (update, check the docs, follow  Link headers).</p><p>  这是指出常规日落政策非常有用的好地方！日落策略会告诉客户，当您关闭端点时（例如，替换开始生效一年后），用户应如何确保他们听到此信息（邮件列表，状态页面，HTTP标头，您可以为其命名），以及通常应如何处理（更新，检查文档，遵循链接标题）。 </p><p> Adding one doesn&#39;t help much with doing a deprecation right now, but if you&#39;d published one a year ago, your clients would be ready already. The second best time to publish a sunset/deprecation policy is now. Might be worth considering if you&#39;re writing deprecation docs anyway.</p><p>现在添加一个并不能帮助您弃用，但是如果您在一年前发布，则您的客户已经准备好了。现在是发布日落/弃用策略的第二好的时间。如果您仍在编写弃用文档，则可能值得考虑。</p><p>  These parts are designed to work nicely together. For example, to indicate that an API was deprecated recently, will be turned off in 6 months, link to the documentation, and provide a direct link to the next version, you should include headers like this in the response:</p><p>  这些部分设计为可以很好地协同工作。例如，要表明一个API最近已被弃用，将在6个月内关闭，链接到文档，并提供直接链接到下一个版本，您应在响应中包含以下标头：</p><p> Deprecation: Thu, 21 Jan 2021 23:59:59 GMTSunset: Tue, 20 Jul 2021 23:59:59 GMTLink: &lt;https://api.example.com/v2/customers&gt;; rel=&#34;successor-version&#34;, &lt;https://developer.example.com/shutting-down-customers-v1&gt;; rel=&#34;deprecation&#34;</p><p> 弃用时间：格林尼治标准时间2021年1月21日星期四23:59:59日落时间：格林尼治标准时间2021年7月20日星期二23:59:59链接：＆lt; https：//api.example.com/v2/customers&gt ;; rel =＆＃34; successor-version＆＃34 ;,＆lt; https：//developer.example.com/shutting-down-customers-v1&gt ;; rel =＆＃34;弃用＆＃34;</p><p>  Once all that&#39;s in place, and your sunset deadline has passed, you&#39;re good to go.</p><p>  一旦一切就绪，并且您的日落截止日期过去了，您就可以开始了。</p><p> That doesn&#39;t mean you need to immediately kill the API completely though. Progressive shutdowns can help ensure that any clients still using this API get a last-chance warning before it disappears completely. GitHub  did this when removing some crypto support in 2018: first they disabled it for one hour, then reenabled it, then they disabled it permanently two weeks later.</p><p> 但这并不意味着您需要立即完全终止该API。逐步关闭可以帮助确保仍在使用此API的所有客户端在完全消失之前获得最后机会警告。 GitHub在2018年删除一些加密支持时做到了这一点：首先，他们将其禁用了一个小时，然后重新启用，然后两周后将其永久禁用。</p><p> There&#39;s other tricks too: Android  added increasing delays to deprecated native APIs in 2015, eventually going up to a full 16 second wait, before finally turning off the API entirely. These progressive shutdowns provide a little flexibility for clients who miss your deadline, and may help clients who haven&#39;t noticed the deprecation spot and deal with the issue before the API turns off completely.</p><p> 还有其他窍门：Android在2015年为已弃用的本机API增加了越来越多的延迟，最终等待了整整16秒的等待时间，才最终完全关闭了该API。这些逐步关闭会为错过您的最后期限的客户提供一点灵活性，并可能帮助尚未注意到弃用现场的客户并在API完全关闭之前解决问题。</p><p>  Either way, once you&#39;ve done the best you can to communicate the shutdown, it&#39;s time to turn off the endpoint/feature/entire service, delete the code, and finally go take that nap.</p><p>  无论哪种方式，只要您已尽力而为，就可以传达关闭的信息，现在该关闭端点/功能/整个服务，删除代码，最后小睡一下。 </p><p> Doing deprecations and shutdowns carefully like this makes it as clear as possible to your clients how they can depend on your API, when they need to take action, and what they need to do. These kind of changes can be a big deal, and this information is important!</p><p>像这样仔细地进行弃用和关闭操作，可以使您的客户端尽可能清楚地知道他们如何依赖您的API，何时需要采取行动以及需要做什么。这些变化可能很重要，并且此信息很重要！</p><p> These new draft headers allow us to communicate not only to humans, but also to expose this information to automated systems. As these headers become widespread, I&#39;m really excited to start seeing more tooling building on top of them. Generic HTTP clients can log useful warnings automatically based on this data, API generators themselves can handle more and more of this for you based on API specifications, and HTTP debuggers like   HTTP Toolkit can highlight usages of deprecated endpoints for you in intercepted live traffic. It&#39;s an exciting time to start turning things off!</p><p> 这些新的标题标题使我们不仅可以与人类进行交流，还可以将这些信息公开给自动化系统。随着这些标头的普及，我很高兴开始看到在它们之上构建更多的工具。通用HTTP客户端可以根据这些数据自动记录有用的警告，API生成器本身可以根据API规范为您处理越来越多的警告，HTTP调试器（如HTTP Toolkit）可以在截获的实时流量中为您突出显示不赞成使用的端点的用法。这是一个令人兴奋的时刻，开始关闭一切！</p><p> It is important to note that these headers are  draft HTTP specifications. It&#39;s possible they may change before they&#39;re finalized. That said, they&#39;ve been through a few rounds of revisions already, it&#39;s fairly unlikely they&#39;ll change dramatically from here, and it&#39;s time to start testing them in the wild.</p><p> 重要的是要注意，这些标头是HTTP规范草案。在最终确定之前，它们可能会更改。就是说，他们已经经历了几轮修订，从现在开始它们不太可能会发生巨大变化，现在是时候开始在野外进行测试了。</p><p> This does mean there&#39;s still time for feedback though! If you have thoughts on how this works and how it could work better, get in touch with the &#34;Building Blocks for HTTP APIs&#34; working group. You can email the mailing list at  httpapi@ietf.org, or scroll the previous mailing list discussions  here.</p><p> 但这确实意味着仍然需要反馈！如果您对它如何工作以及如何更好地工作有任何想法，请与＆＃34; HTTP API的构建模块取得联系。工作小组。您可以通过httpapi@ietf.org通过电子邮件发送邮件列表，或在此处滚动以前的邮件列表讨论。</p><p> Debugging, integrating or building HTTP APIs? Intercept, inspect &amp; mock HTTP from anything in one click with   HTTP Toolkit.</p><p> 调试，集成或构建HTTP API？拦截，检查和一键式使用HTTP Toolkit模拟HTTP。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://httptoolkit.tech/blog/how-to-turn-off-your-old-apis/">https://httptoolkit.tech/blog/how-to-turn-off-your-old-apis/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/关闭/">#关闭</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/turn/">#turn</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/api/">#api</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>