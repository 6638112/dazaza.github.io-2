<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>使用KEYCLOAK和AMISTER对K8进行分步集中身份验证</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">使用KEYCLOAK和AMISTER对K8进行分步集中身份验证</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-29 03:21:49</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/8/70ce710e7e79f1b787ce30303273c78f.png"><img src="http://img.diglog.com/img/2020/8/70ce710e7e79f1b787ce30303273c78f.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>当您构建Kubernetes应用程序时，很容易导致“身份验证无序蔓延”，您的所有服务都有不同的身份验证机制。本教程将介绍如何使用IdP和API网关集中您的身份验证机制。</p><p>Keycloak是一个被广泛采用的身份和访问管理(IAM)开源解决方案。2014年是突破性技术的重要一年，因为Keycloak和Kubernetes项目最初都是相隔几周发布的。不足为奇的是，许多Kubernetes最终用户正在将Keyshaak作为管理对其平台的安全API和服务的访问的首选方式。</p><p>然而，简单地在Kubernetes中运行Keycloak并不能保证您的平台安全。许多问题留给用户来配置和实现：从使用TLS和入口控制器公开Keyloak API端点，到在特定业务端点上实施安全策略。在解决这些问题时，我们倾向于使用API网关解决方案来处理加密连接和集中API管理策略，而不是在您的微服务架构的每种语言和应用中重新实现身份验证策略。</p><p>我们今天的目标是安装Keycloak作为我们的IAM解决方案，并将其保护在大使边缘堆栈之后，该堆栈是我们的API网关，充当Kubernetes入口控制器。作为最后一步，我们将部署一个示例应用程序，并演示如何将Keycloak用作身份提供者(简称IdP)，以使用请求过滤器通过OAuth2限制对此应用程序的访问。</p><p>在本教程中，我们将使用非生产就绪的Keycloak安装。为了简化依赖图，我们将使用内存中的数据存储，它完全适合演示，但不能保证生产环境中的高可用性。如果您正在寻找生产级持久性，Keycloak提供多种存储解决方案。</p><p>入口控制器是大多数Kubernetes产品中缺少的构建块。尽管Kubernetes定义了Inress资源，但它实际上并不受任何将资源转换为公共服务的实现的支持！入口解决方案的选择和安装由操作员负责。在这里，我们将使用社区版的大使边缘堆栈，因为它与Keyshaak直接集成以进行身份验证，从而公开和保护来自Internet请求的公共流量，并保护在我们的Kubernetes集群中运行的下游私有服务的安全。</p><p>在本教程结束时，我们将启动并运行大使边缘堆栈，在Kubernetes网络的边缘执行TLS终止，在/auth/下公开我们的Keycloak安装，并在/backend/下保护我们的Quote应用程序。</p><p>库伯内斯经常被取笑，因为需要大量的YAML。我们将使用K8s Initializer为我们生成所有的Kubernetes资源，而不是去寻找YAML样本并将所有的拼图拼凑在一起。K8s Initializer是一个项目生成器工具，类似于应用程序开发人员现有的工具：考虑一下Spring Initializr或Yeoman。</p><p>K8S Initializer的向导式界面将指导我们解决几个问题，以了解和配置因云提供商而异的特定设置。这些实现细节通常是违背承诺和缺乏可移植性的地方，这使得配置入口控制器和向公共流量公开服务变得困难。希望我们可以通过使用像K8S Initializer这样的综合工具来消除这些小问题，K8s Initializer将为我们提供最佳配置。</p><p>对于本教程，我们特别选择了我们的目标Kubernetes集群：“Google Kubernetes engine”和一个“Google外部负载均衡器(L4)”负载均衡器。我们还为安装选择了公共主机名。使用公共主机名将需要额外的步骤来配置DNS条目以指向我们的安装，但是考虑到我们想要演示如何构建公共安全的应用程序堆栈，付出额外的努力是值得的。至于K8S Initializer的Auth配置，我们无疑选择了Keycloak，并设置了临时密码。</p><p>一旦对我们的K8S初始化器选项感到满意，我们就点击“下载”按钮。我们将收到一组准备就绪的YAML文件和说明。</p><p>我们将从安装大使边缘堆栈开始，因为它包含大量Kubernetes Custom Resource Definitions依赖项。假设您有权访问所需的Kubernetes集群，安装将非常简单，只需运行kubectl Apply命令并配置DNS条目以指向所配置服务的外部IP即可。</p><p>从生成的YAML安装Keycloak也很简单：只需一个kubectl Apply命令。一只好奇的猫可能会偷看Keycloak YAML文件，别担心它不会杀了你！实际上，您将能够理解大使映射资源将如何指示到达public/auth/prefix端点的流量被转发到在Kubernetes集群中运行的私有Keycloak pod。</p><p>给Keyloak几分钟的启动时间，然后我们就可以在https://domain-name/auth/.上访问它的UI了。由于我们在K8S初始化器选项中选择了让“大使使用让我们加密的证书来终止TLS”，因此我们可以理解如何使用安全证书自动终止TLS以用于我们的Keyloak安装。</p><p>然后，我们可以使用之前选择的默认管理员用户名和临时密码登录到Keyloak的管理控制台UI，以根据我们的需求…配置Keyloak。并更改密码！</p><p>为了保护我们的API，我们将使用闪亮的新Keyloak安装作为我们的IdP。我们首先需要创建一个客户端来处理来自大使边缘堆栈的身份验证请求。所有这些配置步骤都可以使用Keyloak UI来实现。</p><p>我们首先创建一个新的“领域”。将鼠标悬停在右侧导航中的“Master”标签上，即可单击“Add Realm”。我们选择大使作为我们新领域的“名称”。稍后在身份验证筛选器中配置AuthizationURL字段时将需要该字段。</p><p>我们将通过导航到“客户端”并单击“创建”来创建一个新客户端。我们选择了以下设置：-客户端ID：大使-此值将用于身份验证筛选器的ClientID字段。-客户端协议：openID-connect-root URL：无，不填。</p><p>在下面的屏幕上，我们为客户端配置了：-访问类型：机密-有效重定向URI：*。</p><p>导航到客户端中的“Mappers”选项卡，单击“Create”并使用以下设置：-Protocol：openID-connect-name：大使Mapper-Mapper类型：包括受众的客户端受众：从下拉列表中选择客户端的名称。记住，我们任命我们的客户为大使。</p><p>回到我们的大使客户端，我们导航到“client Scopes”部分，并将我们的客户端配置为OFFLINE_ACCESS。</p><p>再次回到我们的大使客户，然后我们导航到“凭证”部分。我们注意到了“Secret”值，因为它将在稍后配置身份验证过滤器时使用。</p><p>与我们的客户端配置一起，让我们配置一个密钥遮盖“用户”：</p><p>导航到Keyloak管理控制台的“Users”部分，我们将单击“Add User”。我们为用户提供了一个简单的用户名：my-keyloak-user，然后单击“保存”。</p><p>在下面的屏幕上，我们切换到用户的“Credentials”选项卡以设置临时密码。</p><p>现在我们已经有了一个可以进行身份验证的用户，让我们部署一个应用程序。</p><p>在Kubernetes上部署自定义应用程序是通过创建一些定义为…的Kubernetes资源来实现的。你猜对了，更多的是YAML！这一次，因为我们部署的是示例后端应用程序，所以示例有点轻量级。您可以将以下定义保存到“QUOTE-service.yaml”文件中，并使用kubectl Apply-f QUOTE-service.yaml部署它。</p><p>-apiVersion：v1种类：服务元数据：名称：报价命名空间：默认规格：端口：-名称：HTTP端口：80目标端口：8080选择器：APP：QUOTE-apiVersion：Apps/v1 Kind：部署元数据：名称：报价命名空间：默认规格：副本：1选择器：matchLabels：App：Quote Strategy：Type：RollingUpdate Template：Metadata：Labels：App：Quote Spec：Containers：-Name：Backend Image：docker.io。-名称：HTTP容器端口：8080-api版本：getambasador.io/v2种类：映射元数据：名称：引用-后端命名空间：默认规范：前缀：/后端/服务：引用。</p><p>这将创建一个Kubernetes部署、服务和映射，以在/backend/路径下公开我们正在运行的Quote应用程序。试一试，它目前不受保护：https://domain-name/backend/.。</p><p>在前面“配置密钥罩领域、客户端和用户”一节中应用到密钥罩安装的配置的基础上，我们将在Kubernetes中创建一个OAuth2筛选器和FilterPolicy资源。不要忘记将此YAML示例中的占位符替换为安装中的值！再次将以下定义保存到“keycloak-filter.yaml”文件，并使用kubectl Apply-f keycloak-filter.yaml部署它。</p><p>-api版本：getambasador.io/v2 Kind：筛选元数据：名称：密钥罩-筛选器命名空间：大使规范：OAuth2：AuthizationURL：https://{domain-name}/auth/realms/ambassador受众：大使客户端ID：大使密码：{CLIENT_SECRET}ProtectedOrigins：-Origin：https://{domain-name}-api版本：getambasador.io/v2 Kind：筛选器策略元数据：名称：报价策略命名空间：默认规范：规则：-主机：&#34；*&。路径：/Backend/Filters：-name：keyloak-filter命名空间：大使参数：作用域：-&#34；OFFLINE_ACCESS&#34；</p><p>由于筛选器策略作用于/Backend/PATH，因此在导航到https://domain-name/backend/下的报价服务时，系统现在会提示我们使用密钥罩进行身份验证！尝试使用我们之前创建的my-keyloak-user用户名登录！</p><p>我们距离使用相同的身份验证策略扩展此FilterPolicy配置以保护多条路径、端点和服务只有一步之遥。谈谈推出单点登录和集中身份验证机制的有效方法！现在，只需按照以下说明使用Keyloak配置Filter和FilterPolicy资源的细粒度设置即可。</p><p>在本教程中，我们展示了如何在Kubernetes中集中身份验证，方法是将Keycloak部署为您的IDP，并将大使边缘堆栈部署为您的Kubernetes原生API网关。在K8S初始化器的帮助下，您只需点击几下即可启动并运行这些工具。</p><p>要了解有关这些工具和集中身份验证策略的更多信息，请查看以下资源：</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.getambassador.io/centralized-authentication-with-keycloak-and-ambassador-edge-stack-d509ffbc7b6f">https://blog.getambassador.io/centralized-authentication-with-keycloak-and-ambassador-edge-stack-d509ffbc7b6f</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/keycloak/">#keycloak</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>