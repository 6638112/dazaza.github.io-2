<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>卑微的分解Humble Decomposition</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Humble Decomposition<br/>卑微的分解</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2022-02-21 15:31:13</div><div class="page_narrow text-break page_content"><p>Now feels like a good time to make this blog an actual log, documenting my findings as I develop Clojure UI library,  Humble UI.</p><p>现在感觉是一个很好的时机，让这个博客成为一个真正的日志，记录我在开发Clojure UI库（Humble UI）时的发现。</p><p>  None of the decisions are final and might change at any time. In fact, my expectation is that talking about them in public might help either solidify or replace them, rubber duck-style.</p><p>这些决定都不是最终决定，可能随时会改变。事实上，我的期望是，在公共场合谈论它们可能会有助于巩固或取代它们，就像橡皮鸭一样。</p><p>  Humble UI is a Clojure framework, but it’s based on  JWM and  Skija, both Java libraries. Skija draws graphics, JWM takes care of window management and OS integrations.</p><p>Humble UI是一个Clojure框架，但它基于Java库JWM和Skija。Skija绘制图形，JWM负责窗口管理和操作系统集成。</p><p>  Yes, the fact that there are three libraries instead of a single monolithic package makes it harder to work with.</p><p>是的，有三个库，而不是一个单一的整体包，这一事实使它更难使用。</p><p> But I think it’s a worthy goal: without strong coupling, each library is much more versatile on its own. Use one, use both, or use neither: the decision is up to you. For example, Skija is already being used with AWT, LWJGL, winit, etc. The same applies to JWM: want window management but do your own graphics? Easy!</p><p>但我认为这是一个值得追求的目标：如果没有强耦合，每个库都会有更多的功能。使用其中一个、两个都使用，或者两者都不使用：决定权在你。例如，Skija已经被用于AWT、LWJGL、winit等。同样的情况也适用于JWM：想要窗口管理，但自己做图形？容易的</p><p> The use of Java also makes these available to every JVM language out there. So I am happy both with separation and the choice of Java as an implementation language.</p><p>Java的使用也使得每种JVM语言都可以使用这些功能。因此，我对分离和选择Java作为实现语言感到满意。</p><p>  As you can imagine, in a UI framework there are lots of points, vectors, and rectangles flying around. The same is true for both Skija and JWM, actually.</p><p>可以想象，在UI框架中，有很多点、向量和矩形四处飞舞。事实上，Skija和JWM也是如此。</p><p> And if there’s one thing I hate to see the most it’s pointless conversions between structurally the same types but named differently. E.g. from  class SkijaPoint { int x, y; } to  class JWMPoint { int x, y; } to  (defrecord HumblePoint [^int x ^int y]).</p><p>如果有一件事我最不喜欢看到的话，那就是在结构相同但命名不同的类型之间进行毫无意义的转换。例如，从类SkijaPoint{int x，y；}到类JWMPoint{int x，y；}到（记录下位点[^int x^int y]）。</p><p>  a) Use built-in AWT classes. A good option but might require linking with java.desktop module and that’s a huge dependency.</p><p>a） 使用内置的AWT类。这是一个不错的选择，但可能需要与java链接。桌面模块，这是一个巨大的依赖。</p><p> b) Use a shared library. That’s what I  ended up doing, even though I hate to add one more project to the mix. Turned out Point and Rect are pretty much all you need to share, so it’s not that bad and probably won’t need to update it too often.</p><p>b） 使用共享库。这就是我最终要做的，尽管我不想再增加一个项目。事实证明，Point和Rect几乎都是你需要分享的东西，所以它没那么糟糕，可能不需要经常更新。</p><p>   Clojure has a great Java interop, but it’s relying on type annotations too much. And points and rectangles are really everywhere. An example:</p><p>Clojure有很好的Java互操作性，但它过于依赖类型注释。点和矩形真的无处不在。举个例子：</p><p> (let [content-y (- (.-offset ^VScroll child)) content-h (.-height ^IPoint (.-child-size ^VScroll child)) scroll-y (.-y ^IPoint child-rect) scroll-h (.-height ^IPoint cs) scroll-r (.getRight ^IRect child-rect)</p><p>（让[content-y（-（-offset^VScroll child））content-h（-height^IPoint（-child size^VScroll child））滚动-y（-y^IPoint child rect）滚动-h（-height^IPoint cs）滚动-r（.getRight^direct child rect）</p><p>  Solution one will be  (defrecord HumblePoint [^int x ^int y]). But then we’re back to square one: converting from JWM points to Clojure ones.</p><p>解决方案一将是（deffrecord HumblePoint[^int x^int y]）。但接下来我们回到原点：从JWM点转换为Clojure点。</p><p> Solution two is to make  class IPoint implement  clojure.lang.ILookup,  IPersistentCollection,  Associative etc. It’s pretty easy to do and could make any Java class behave like Clojure map!</p><p>解决方案二是让类IPoint实现clojure。ILookup、IPersistentCollection、Associative等等。这很容易做到，可以让任何Java类的行为都像Clojure map！</p><p>  This makes working with Java classes from Clojure  very pleasant. Code snipped above turns into</p><p>这使得使用Clojure的Java类非常愉快。上面被剪掉的代码变成了</p><p> (let [content-y (- (:offset child)) content-h (:height (:child-size child)) scroll-y (:y child-rect) scroll-h (:height cs) scroll-r (:right child-rect)</p><p>（让[content-y（-（：offset child））content-h（：height（：child size child））scroll-y（：y child rect）scroll-h（：height cs）scroll-r（：right child rect）</p><p>  The problem is, to implement e.g.  clojure.lang.ILookup you need to depend on Clojure (static typing problems, ugh). And Clojure is a huge dependency to impose on everyone who would want to use Skija or JWM from Java.</p><p>问题是，要实现例如clojure。你需要依赖Clojure（静态类型问题，呃）。Clojure是一个巨大的依赖性，它强加于所有想要使用Java中的Skija或JWM的人。</p><p> I was struggling with this dilemma for a while until I arrived at a rather unorthodox decision: implement two versions of  types library, one with Clojure interfaces and one without. Both contain the same classes, but the latter implements a few Clojure interfaces on them.</p><p>我在这个困境中挣扎了一段时间，直到我做出了一个相当非正统的决定：实现两个版本的类型库，一个带有Clojure接口，另一个没有。两者都包含相同的类，但后者在它们上实现了几个Clojure接口。</p><p>    public class IPoint extends AFn implements Associative { public final int _x; public final int _y; @Override public Object valAt(Object key) { return valAt(key, null); } @Override public Object invoke(Object arg1) { return valAt(arg1, null); } ...}</p><p>公共类IPoint扩展AFn实现关联{public final int_x；public final int_y；@Override public Object valAt（Object key）{return valAt（key，null）；}@重写公共对象调用（对象arg1）{return valAt（arg1，null）；}…}</p><p> Both Skija and JWM depend on Clojure-free version of  types. But when used through Humble UI we already have Clojure on classpath, so we replace  types with  types-clojure:</p><p>Skija和JWM都依赖于类型的Clojure免费版本。但是当通过简单的UI使用时，我们已经在类路径上有了Clojure，所以我们用Clojure类型替换类型：</p><p>  Am I happy with this decision? I don’t know. It sure sounds complicated, and I don’t like that.</p><p>我对这个决定满意吗？我不知道。这听起来很复杂，我不喜欢这样。</p><p>  it is simple for the end-user (you depend on  humbleui and it does the right thing by default),</p><p>这对于最终用户来说很简单（您依赖humbleui，默认情况下它会做正确的事情），</p><p>  I  love how natural it feels to use Clojure-enabled classes, even though they are written in Java.</p><p>我喜欢使用支持Clojure的类的感觉，尽管它们是用Java编写的。</p><p>      I also create open-source stuff: Fira Code, AnyBar, DataScript and Rum. If you like what I do and want to get early access to my articles (along with other benefits), you should  support me on Patreon.</p><p>我还创建了开源软件：Fira代码、AnyBar、DataScript和Rum。如果你喜欢我所做的，并且想尽早获得我的文章（以及其他好处），你应该在Patreon上支持我。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/分解/">#分解</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/humble/">#humble</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/clojure/">#clojure</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>