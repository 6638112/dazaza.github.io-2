<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>随机员工在CloudFlare聊天 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">随机员工在CloudFlare聊天 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-21 07:22:45</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/3/393a635b54662937dfaf22b32d6dcaba.png"><img src="http://img2.diglog.com/img/2021/3/393a635b54662937dfaf22b32d6dcaba.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>由于Covid-19大流行，大多数CloudFlare办事处于2020年3月关闭，员工开始在家工作。在线会议出现了自己的挑战，但保留了物理办公室的偶然遭遇的好处是我们挣扎的东西。那些非正式的互动，就像咖啡机旁边谈论的团队，帮助将公司一起举起的社交胶水。</p><p> 在CloudFlare的工程师介绍了“随机工程师聊天”，试图重新创建那种经验，David Wragg推出了“随机工程师聊天”（我们将它们称为“随机员工聊天”，因为这可以应用于任何团队）。这个想法是，参与者是随机配对的，并且对然后时间安排30分钟的视频通话。这些对话没有固定议程，但参与者可能会在其他团队中学习发生的事情，通过讨论它或结识新的人来获得新的工作。</p><p> 随机员工聊天的第一次迭代使用共享电子表格来协调该过程。人们会通过将自己添加到电子表格，并每周一次，David将从列表中随机形成对，并发送带有结果的电子邮件。然后，每对都会在方便的时候安排呼叫。这个过程是这个想法的最低可行实施，但这意味着该过程依赖于一个人。</p><p>  我们希望自动化这些重复的手动任务，并且自然地，我们希望使用CloudFlare工人来做。这是一个完整应用程序的一个很好的例子，它完全在边缘的CloudFlare工人上运行，没有后端或原点服务器。</p><p>   工作人员符合所有这些要求，结果应用程序在CloudFlare＆＃39; s边缘网络中运行，无需在其他平台上运行代码或存储数据。工人脚本提供返回静态HTML和JavaScript资产的UI，以及存储，工人KV跟踪登录的人。</p><p> 我们最近还宣布了工人Cron触发器，允许我们在定义的时间表上运行CloudFlare Workers脚本。工人Cron Triggers非常适合在会话之前配对人员，并提醒用户注册下一个会话。</p><p>   界面非常简单。它显示参与者列表，并允许用户注册下一个会话。 </p><p>当用户单击寄存器按钮时，它会调用API，该API在工人kv中添加密钥：</p><p>  用户信息存储在工人KV中，并在接口中显示以创建参与者列表。用户信息在配对期间删除，因此列表已准备好用于下一轮聊天。我们需要从想要参加聊天的参与者的每周注册以确认他们的可用性。</p><p>   随机员工聊天是一对一的对话，所以在一定时间内，应用程序将参与者成对。每个星期一早上在0800 UTC时，工人Cron作业运行配对脚本，该配对脚本正在使用Wrangler部署。</p><p> Wrangler支持使用熟悉的Cron符号配置作业的计划。例如，我们的Wrangler.Toml有：</p><p> 名称=＆＃34; randengchat-c​​ron-pair＆＃34; type =＆＃34; webpack＆＃34; consub_id =＆＃34; ...＆＃34; webpack_config =＆＃34; webpack.config.js＆＃34 ; ... kv_namespaces = [...] [触发] crons = [＆＃34; 0 8 * * 2＆＃34;]</p><p> 配对脚本是应用程序中最复杂的部分，因此让我们通过其代码来运行。首先，我们列出当前注册的用户。这是使用Workers KV提取键的列表函数与前缀寄存器完成：。</p><p>  如果我们没有偶数参与者，我们将从列表中删除一个人（David！）。 </p><p>async函数createweightedpair（）{const对= []; for（让我= 0; i＆lt; keys.length  -  1; i ++）{for（let j = i + 1; j＆lt; keys.length; j ++）{const重量=（...）等待（...）） * -1;对.push（[i，j，weigh]）; }}返回对;}</p><p> 例如，假设四个人已经注册（Tom，Edie，Ivie和Ada），这是6对的（4选择2）。我们最终可能会有以下对及其相关权重：</p><p>  使用过去匹配的对匹配的次数来计算权重，以避免在已经满足的人之间调度聊天。可以考虑更复杂的因素，例如相同的办公室或时区，当时他们遇到的等等等等。</p><p> 我们跟踪使用保存在kV中的计数匹配的次数匹配的次数：</p><p> async函数copttimespaired（key）{const v = await db.get（key，＆＃34; json＆＃34;）; if（v！== null＆amp;＆amp; v.count）{return v.count; }返回0;}</p><p> 人民与人们形成一个完整的图表，作为节点，边缘加权边缘连接的两个人的次数。</p><p>  接下来，我们运行加权匹配算法，在我们的曲目中，这将在图表上找到最大匹配（一组边缘，最大化与每个人完全一切显示的人数的人数的数量最大化）。当我们使用开花算法的加权形式时，我们也最小化了路径权重。这具有找到最佳成对的效果，最小化人们先前遇到的次数。 </p><p>在上面的算法上，算法表明最佳成对是（Tom，IVIE）和（EDIE，ADA）。 在这种情况下，这些对以前从未见过面。  该对在工人KV中记录了他们更新的匹配计数，以优化未来会话的重量：  通知发送给每对用户，以通知它们它们匹配。  该应用程序将用户提醒每周注册。 对于提醒而言，我们使用另一名工人Cron作业，每周四在1300 UTC中运行。 争吵者的时间表是  此脚本比配对脚本更简单。 它只是向我们公司消息传递平台中的房间发送消息，该平台通知所有频道的所有成员。  我们希望您发现这段代码有用，它激励您使用工人，工人kv，工人unbound和workers cron触发器写入完全没有后端服务器的大型实际应用程序。  CloudFlare Workers CloudFlare Workers KV Cron Wrangler </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://cfl.re/3cLcmHL">https://cfl.re/3cLcmHL</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/employee/">#employee</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1052788.html"><img src="http://img2.diglog.com/img/2021/3/thumb_f4131e4f4cbf40acc3f03615a40b569f.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1052788.html">GitHub员工解雇了“纳粹”的下降，以便他的工作回来 </a></div><span class="my_story_list_date">2021-3-17 2:27</span></div><div class="col-sm"><div><a target="_blank" href="/story/1047472.html"><img src="http://img2.diglog.com/img/2021/2/thumb_f30b6481b9c208c5d35e955bd24605c0.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1047472.html">一项CA法案旨在让受NDA插科打workers的工人说出任何歧视，而不仅仅是性骚扰。 前Pinterest员工Ifeoma Ozoma帮助起草了该文件 </a></div><span class="my_story_list_date">2021-2-9 20:47</span></div><div class="col-sm"><div><a target="_blank" href="/story/1046074.html"><img src="http://img2.diglog.com/img/2021/1/thumb_04b6a437929456e987f4a86fe28ed498.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1046074.html">前ADT员工承认，他通过摄像头观看客户多年性生活 </a></div><span class="my_story_list_date">2021-1-24 5:27</span></div><div class="col-sm"><div><a target="_blank" href="/story/1044756.html"><img src="http://img2.diglog.com/img/2021/1/thumb_80f733faadeb48a2d0c4ed6914736d50.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1044756.html">员工事务更新 </a></div><span class="my_story_list_date">2021-1-18 2:16</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>