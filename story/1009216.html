<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>驯服ClojureScript项目中的高级编译错误</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">驯服ClojureScript项目中的高级编译错误</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-07-01 10:42:47</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/7/ed473defc8c65c73e82fc3ee418156ef.png"><img src="http://img.diglog.com/img/2020/7/ed473defc8c65c73e82fc3ee418156ef.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>想象一下：您有一个大型的多模块ClojureScript项目，并且您计划在生产中进行新的部署，您的项目使用的是CLJS编译器的高级优化模式，一切似乎都很顺利。在发布之前，您正在执行一些最后的E2E测试。然后，加载有故障的模块。砰！您会被打耳光，并出现类似如下的错误：</p><p>未捕获错误：没有协议方法IMultiFn.-Add-为类型函数定义的方法：函数xr(){[本机代码]}位于Nb((INDEX)：964)，位于Yh((INDEX)：443at(INDEX)：236(INDEX)：143)。未捕获类型错误：无法读取位于Nu((INDEX)：143)处未定义的、位于Nu((INDEX)：143)的属性&#39；j&#39；login-a5a67c0fffdfa158b7220c8c2553253b645e4e2e.js:169。</p><p>你没料到会这样。自上一次构建以来没有重大的新变化，单元测试也都是完美无缺的。此外，在使用Firefox时一切正常，但现在编译后的代码在Google Chrome上崩溃了。怎么一回事？发布的最后期限迫在眉睫，你必须尽快解决这个问题。</p><p>当您使用CLJS编译器构建代码时，它会发出与Google闭包编译器的ADVANCED_OPTIMIZATIONS级别兼容的JavaScript代码。然后，如果启用了&#34；：Optimations：Advanced&#34；编译器选项，CLJS编译器将使用Close Compiler的高级优化缩小结果。</p><p>闭包编译器的高级优化模式可能会在您的构建中导致一些错误，如果您是Closure编译器的新手，跟踪这些错误可能会很不舒服。最重要的是，如果您试图搜索带有错误消息的Web，可能很难找到帮助，因为函数名称都已损坏。</p><p>最好从项目开始时就牢记高级编译模式来避免这些错误。我将描述一些帮助您避免和解决高级编译问题的常用方法，并展示如何解决开头描述的更不常见的问题及其背后的原因。</p><p>建议对您的生产构建使用&#34；：优化：高级CLJS编译器选项。通过使用更积极的高级转换(如删除死代码和积极重命名)，您将极大地减小最终的构建大小。在此处阅读有关高级转换的更多信息：闭包编译器编译级别。</p><p>不同的构建工具(如lein-cljsbuild和dow-cljs)可能会将不同的默认选项传递给Close Compiler。我不会在这篇博客文章中讨论这些不同之处，但我会提供一些关于如何避免在项目中使用高级编译的一般指导原则。</p><p>extern是一种声明不应该被闭包编译器忽略(重命名)的名称的机制。当您使用外部库时，如果您使用的是lein-cljsbuild这样的构建工具，请确保它们与externs捆绑在一起。或者，如果需要，提供您自己的externs文件。否则，闭包编译器将在高级编译期间无意中忽略对外部定义符号的引用，从而导致只有在稍后运行编译代码时才会发现错误。</p><p>要添加您自己的externs，请使用编译器选项，例如：&#34；：externs[&#34；exters.js&#34；]&#34；并在您的工作目录中提供一个exters.js文件。</p><p>此外，使用&#34；：infer-externs true&#34；编译器选项也很好。此选项将启用为JavaScript互操作调用自动生成外部变量。</p><p>值得一提的是，闭包编译器包含稳定JavaScriptAPI外部变量，但可能还没有包含处于试验状态的新特性。实验API变化非常快，因此将它们包含在闭包编译器工具中是没有意义的。因此，如果您计划使用一些实验特性，请确保将它们添加到您自己的externs文件中。</p><p>如果要将CLJS代码拆分为：模块，则可能需要使用：rename-prefix&#34；.&#34；编译器选项。拆分模块在全局JavaScript作用域中运行，因此它们可能会干扰同一页上加载的其他代码(例如Google Analytics)，并在发生名称冲突时导致不可预测的错误。使用&#34；：rename-prefix&#34；时，最好使用非常短的字符串作为前缀，例如：：rename-prefix&#34；r_&#34；</p><p>这将略微增加最终(Gzided)构建大小，因为现在每个被忽略的全局变量都将以“r_”为前缀。</p><p>在高级编译过程中，闭包编译器将生成大量全局变量，这些变量可能会导致与同一页上运行的其他代码发生名称冲突。如果您在同一页上加载其他代码，并且没有将代码拆分成多个模块，则可以使用&#34；：output-wrapper true&#34；编译器选项。编译器将使用默认值&#34；(Function(){…}包装输出的JavaScript代码。​}；)()&#34；。这将防止污染全局JavaScript作用域，从而防止与其他外部代码发生冲突。</p><p>但是，如果项目中有多个模块，则必须添加编译器选项：Rename-Prefix-Namespace&#34；.&#34；。这使每个模块都可以访问它所依赖的其他模块中定义的变量。这与&#34；：Rename-Prefix&#34；选项的工作方式类似。不同之处在于，现在每个全局变量的作用域都是一个全局变量，而不是多个全局变量。例如，如果使用这样的前缀命名空间：：rename-prefix-nampace&#34；P&#34；，编译后的代码将引用变量&#34；foo&#34；like&#34；p.foo&#34；。此选项还会像&#34；：rename-prefix&#34；选项一样增加最终的构建大小，因此在使用它之前请三思。</p><p>还有其他与高级优化没有直接关系的有趣编译器选项，例如&#34；：fn-Invoke-direct&#34；，它们对于优化性能关键型代码很有用。您可以在CLJS文档中阅读有关它们的更多信息。</p><p>如果您怀疑高级编译可能有问题，浏览器控制台中可能没有意义的错误通常会提示您，最好通过以下方式解决问题。</p><p>为您的高级编译构建添加两个额外的编译器选项&#34；：伪名称true&#34；和&#34；：Pretty-print true&#34；。您的错误现在将显示与源代码中的名称相对应的可读名称。这将帮助您推断是否缺少外部定义。</p><p>此外，如果在启用上述编译器选项后错误消失，它会提示您可能存在名称冲突问题。如果强制变量名与外部变量名冲突出现问题，则当强制变量名更改时，该问题就会消失，就像启用：Pseudo-Names选项时发生的情况一样。通常，如果没有正确修复，名称冲突问题可能会出现，然后在添加新更改时神奇地“修复”，这反过来会导致构建输出中的参数变量名称发生更改。最好是彻底消除这些问题。</p><p>在极少数情况下，可能有一些高级编译问题不是那么容易避免的。让我们回到开头。在Chrome中运行我们构建的Web应用程序时出现错误。火狐没有任何问题。</p><p>未捕获错误：没有为类型函数定义协议方法IMultiFn.-add-method：函数xr(){[本机代码]}，位于Nb((Index)：964)，位于yh((Index)：443)，位于(Index)：236。</p><p>堆栈跟踪指向CLJS源代码中的某个多方法。乍一看，这个错误可能毫无意义。编译后的代码正在尝试为名为xr的函数调用-add-method IMultiFn协议方法。在构建输出中搜索强制的XR时，一切似乎都很正常。XR看起来不错，应该可以工作，对吧？错误消息中需要注意的关键一点是&#34；[本机代码]&#34；部分&#34；函数xr(){[本机代码]}&#34；。这告诉我们，编译后的代码正在尝试调用本机浏览器函数xr，而不是我们的参数xr。一次偶然的机会，闭包编译器将我们的Multimethod命名为XR，这恰好与浏览器提供的XR函数冲突。</p><p>在使用较旧版本的闭包编译器时，偶尔会遇到这样的错误。开发人员一直在向Web浏览器添加新功能。当用户升级他/她的网络浏览器时，有可能添加了新的保留字，该保留字与被忽略的变量冲突。</p><p>原来，xr是WebXR平台API添加的保留字。当错误发生时，“xr”被添加到最新版本的Google Chrome中，但还没有添加到Firefox中。较新的闭包编译器版本通过为其提供外部元素来考虑到这一点。升级ClojureScript版本以及项目中使用的闭包编译器并不总是很容易。在这种情况下，您可以通过添加自己的自定义外部来快速解决问题：</p><p>很多时候，如果准备得当，CLJS的高级编译问题很容易避免。在极少数情况下，可能会发生一些奇怪的错误。因此，使用当前浏览器版本测试您的构建，并学习快速调试高级编译问题，以避免浪费宝贵的时间。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://dev.solita.fi/2020/06/25/taming-cljs-advanced-compilation.html">https://dev.solita.fi/2020/06/25/taming-cljs-advanced-compilation.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/编译/">#编译</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/advanced/">#advanced</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/错误/">#错误</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1008952.html"><img src="http://img.diglog.com/img/2020/6/thumb_63abb9829dd62f67d526ec3bc01f68e4.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008952.html">铁锈编译缓慢的几个原因</a></div><span class="my_story_list_date">2020-6-30 21:11</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008022.html"><img src="http://img.diglog.com/img/2020/6/thumb_3672abea6447c64aa1164dbf005e43a6.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008022.html">WIFF代码中的C编译器性能迷惑</a></div><span class="my_story_list_date">2020-6-25 5:12</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007158.html"><img src="http://img.diglog.com/img/2020/6/thumb_dde71b18b31374e668d369cd8c5ee2ef.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007158.html">编译器编译器：关于使用JavaScript引擎的Twitch系列文章</a></div><span class="my_story_list_date">2020-6-19 3:23</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007138.html"><img src="http://img.diglog.com/img/2020/6/thumb_7583c582a09ba5fcac7604ae2baefec2.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007138.html">编译时合并排序[C++]</a></div><span class="my_story_list_date">2020-6-19 2:38</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>