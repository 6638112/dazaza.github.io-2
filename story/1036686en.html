<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>DigitalOcean对接管2万个DigitalOcean域的响应DigitalOcean Response for Taking over 20K DigitalOcean Domains</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">DigitalOcean Response for Taking over 20K DigitalOcean Domains<br/>DigitalOcean对接管2万个DigitalOcean域的响应</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-26 17:41:34</div><div class="page_narrow text-break page_content"><p>EDIT: DigitalOcean seems to be getting a lot of flak from this post so I’d just like to point out that I feel DigitalOcean’s reaction in this case was entirely justified (they saw an anomaly and they put a stop to it). The only thing I’d wish was done differently would be that the domains were deleted from my account upon me being banned. There was a few hour delay between testing and reaching out to them and ideally I should’ve reached out ahead of time. The main reason I did not reach out with the theory instead of the proof-of-concept was because I believed that it would be ignored due to lack of evidence (as is my experience with past disclosures). Overall my impression of DigitalOcean’s security team is very positive and I will definitely be much more proactive about reaching out to them in the future.</p><p>编辑：DigitalOcean似乎从这篇文章中得到了很多支持，所以我想指出，我觉得DigitalOcean在这种情况下的反应是完全有道理的（他们看到了异常情况，并且制止了它）。我唯一希望做的事情与众不同，那就是在我被禁止后，域名从我的帐户中删除了。从测试到与他们联系有几个小时的延迟，理想情况下，我应该提前与他们联系。我没有接触理论而不是概念证明的主要原因是因为我认为由于缺乏证据，该理论将被忽略（我过去的经验也是如此）。总的来说，我对DigitalOcean的安全团队的印象非常积极，将来我肯定会更加主动地与他们联系。</p><p> DigitalOcean is a cloud service provider similar to Amazon Web Services or Google Cloud. They offer cloud DNS hosting as one of their product lines – a nice guide on how to set up your domain to use their DNS can be found  here. Take a moment to read it over and see if you can spot any potential issues with their domain name set up process.</p><p> DigitalOcean是类似于Amazon Web Services或Google Cloud的云服务提供商。他们提供云DNS托管作为其产品系列之一-有关如何设置您的域以使用其DNS的不错指南，请点击此处。花一点时间仔细阅读一下，看看您是否可以在其域名设置过程中发现任何潜在问题。</p><p> From a quick glance it appears to be a very easy to use system. For example: No pesky domain validation to impede your ability to add any arbitrary domain to your account, no need to recall who is on your domain’s WHOIS, and no need to set your domain to specific nameservers as is needed with systems such as Cloudflare. In fact all you have to do is the following:</p><p> 乍一看，它似乎是一个非常易于使用的系统。例如：无需进行讨厌的域验证即可阻止您向帐户添加任意​​域的能力，无需回忆域的WHOIS上的用户，也无需像Cloudflare这样的系统将域设置为特定的名称服务器。实际上，您要做的只是以下几点：</p><p> “Within the Networking section, click on Add Domain, and fill in the the domain name field and IP address of the server you want to connect it to on the subsequent page.”</p><p> “在“网络”部分中，单击“添加域”，然后在下一页上填写您要连接到的服务器的域名字段和IP地址。”</p><p> So, if you’d like, you can add my domain  thehackerblog.com to your own DigitalOcean account right now (assuming nobody else has done so already). This brings up interesting questions like, “ can people block me from importing my domain to DigitalOcean?” and, “ what happens when I delete my domain from DigitalOcean but forget to change the nameservers?“. These are good questions, but before we answer them we’ll take a short detour to another cloud provider and see how their implementation differs.</p><p> 因此，如果您愿意，可以立即将我的域名thehackerblog.com添加到您自己的DigitalOcean帐户中（假设其他人都没有这样做）。这就提出了一些有趣的问题，例如“人们可以阻止我将我的域名导入DigitalOcean吗？”并且，“当我从DigitalOcean删除域但忘记更改名称服务器时会发生什么？”。这些是很好的问题，但是在我们回答之前，我们将先绕道另一云提供商，看看它们的实现有何不同。</p><p>  Amazon Web Services, or AWS, also offers cloud DNS hosting in the form of its product line known as  Route53. As a test, we’ll try the set up process for the domain  thehackerblog.com. You can see AWS’s official documentation  here if you’d like to try this yourself. The first step is to click the  Create Hosted Zone button in the top left corner of the Route53 control panel. We’ll now fill in the domain we wish to use along with a short comment and whether or not we wish for this DNS zone to be public. Finally we hit create and are brought to the DNS management panel for our newly created zone. The  NS record type has been pre-populated with a few randomly generated nameservers. For example, the nameserver list I received after trying this is as follows:</p><p>  Amazon Web Services或AWS还以其产品系列Route53的形式提供云DNS托管。作为测试，我们将尝试设置域名thehackerblog.com的过程。如果您想自己尝试，可以在这里查看AWS的官方文档。第一步是单击Route53控制面板左上角的“创建托管区域”按钮。现在，我们将填写我们希望使用的域以及简短评论，以及是否希望将该DNS区域公开。最后，我们点击create，并进入我们新创建区域的DNS管理面板。 NS记录类型已预先填充了一些随机生成的名称服务器。例如，尝试此操作后收到的名称服务器列表如下：</p><p>     The above is very important – if I created a zone for  thehackerblog.com and you did the same we’d both get different nameservers. This ensures that nobody could takeover my domain if I deleted the zone file from my AWS account because the nameservers are specific to my account. So, if I deleted my domain and you wanted to take it over, you’d have to keep trying until you get the same nameserver set as above in order to do so. Otherwise my domain would be pointed to other nameservers than the ones you control.</p><p>     上面的内容非常重要-如果我为thehackerblog.com创建了一个区域，而您执行的操作相同，则我们将获得不同的名称服务器。这样可以确保，如果我从我的AWS账户删除区域文件，则没有人可以接管我的域名，因为名称服务器是我的账户专用的。因此，如果我删除了我的域并想要接管该域，则必须继续尝试，直到获得与上述相同的名称服务器集为止。否则，我的域将指向您控制之外的其他名称服务器。</p><p>  Returning to DigitalOcean, the answer to the question “ what happens when I delete my domain from DigitalOcean but forget to change the nameservers?” becomes clear. If you delete the domain from your account anyone can immediately re-add it to their own account without any verification of ownership and take it over.</p><p>回到DigitalOcean，以下问题的答案是：“当我从DigitalOcean删除域但忘记更改名称服务器时会发生什么？”变得清晰。如果您从帐户中删除域，那么任何人都可以立即将其重新添加到自己的帐户中，而无需任何所有权证明并接管该域。</p><p> It’s one thing to notice a possible issue that  could occur but  proving that it does occur at a large scale is another beast. How can we find out if this issue is systematic and common without attempting to add every domain on the Internet to our DigitalOcean account? How would we even get a list of every domain name anyway?</p><p> 注意到可能发生的问题是一回事，但是证明确实确实发生了另一件事是另一回事。在不尝试将Internet上的每个域都添加到我们的DigitalOcean帐户的情况下，我们如何才能找出此问题是否是系统性的和常见的？无论如何，我们如何获得每个域名的列表？</p><p> To start, one notable way to tell if a domain has been added to a DigitalOcean account is to perform a regular DNS query and see how the DigitalOcean nameserver’s respond. As an example, we’ll use  alert.cm, which has their nameservers set to DigitalOcean but are not listed under any DigitalOcean account:</p><p> 首先，判断域是否已添加到DigitalOcean帐户的一种重要方法是执行常规DNS查询，并查看DigitalOcean域名服务器的响应方式。例如，我们将使用alert.cm，其名称服务器设置为DigitalOcean，但未在任何DigitalOcean帐户下列出：</p><p> [email protected] ~&gt; dig NS alert.cm @ns1.digitalocean.com.; &lt;&lt;&gt;&gt; DiG 9.8.3-P1 &lt;&lt;&gt;&gt; NS alert.cm @ns1.digitalocean.com.;; global options: +cmd;; Got answer:;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: REFUSED, id: 53736;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0;; WARNING: recursion requested but not available;; QUESTION SECTION:;alert.cm.            IN    NS;; Query time: 51 msec;; SERVER: 173.245.58.51#53(173.245.58.51);; WHEN: Tue Aug 23 23:09:00 2016;; MSG SIZE  rcvd: 26</p><p> [受电子邮件保护]〜>挖掘NS alert.cm @ ns1.digitalocean.com。 > DiG 9.8.3-P1 > NS alert.cm @ ns1.digitalocean.com。;;全局选项：+ cmd ;;得到了答案：;; ->> HEADER <<-操作码：QUERY，状态：拒绝，id：53736 ;;标志：qr rd;查询：1，答案：0，权限：0，附加：0；警告：请求递归但不可用；问题部分：; alert.cm。 IN NS ;;查询时间：51毫秒；服务器：173.245.58.51＃53（173.245.58.51）;;时间：2016年8月23日星期二23:09:00； MSG大小RCVD：26</p><p> As can be seen in the above  dig output, the DigitalOcean nameservers returned a DNS  REFUSED (RCode 5) error which indicates that the nameservers refused to respond to the NS record query we performed. This gives us an easy and lightweight way to differentiate between domains that are currently listed under a DigitalOcean account and domains that aren’t.</p><p> 从上面的dig输出中可以看出，DigitalOcean域名服务器返回了DNS REFUSED（RCode 5）错误，表明该域名服务器拒绝响应我们执行的NS记录查询。这为我们提供了一种简便而轻巧的方法，可以区分出DigitalOcean帐户下当前列出的域和未列出的域。</p><p> This solves one part of the problem, but checking every domain on the Internet this way is still very intensive. Additionally, how can we get a list of every domain name on the Internet? The answer is to get a copy of the zone files for various top level domains (TLDs). To start we’ll acquire the zone files for the .com and .net TLDs because they are easily  acquirable from Verisign for research purposes. The zone files contain every .com and .net domain in existence and their corresponding nameservers. By grepping through these zone files we can figure out exactly how many .com &amp; .net domain names use DigitalOcean for DNS hosting. At the time of this writing, the count for both TLDs are the following:</p><p> 这解决了问题的一部分，但是以这种方式检查Internet上的每个域仍然非常耗时。此外，我们如何获取Internet上每个域名的列表？答案是获取各种顶级域（TLD）的区域文件的副本。首先，我们将获取.com和.net TLD的区域文件，因为出于研究目的可从Verisign轻松获取它们。区域文件包含现有的每个.com和.net域及其对应的名称服务器。通过遍历这些区域文件，我们可以准确地找出有多少.com和.net域名使用DigitalOcean进行DNS托管。在撰写本文时，两个TLD的计数如下：</p><p>  Combined, this is a total of 187,930 domain names that have DigitalOcean as their DNS provider. We can now query all of these domains to check for DNS REFUSED errors to see if they are not listed under a DigitalOcean account (and are thus able to be taken over). After a short Python script and a few hours of DNS querying we are able to enumerate all of the vulnerable domains (at least in the two TLDs previously mentioned). The final count comes out to be 21,598 domains that returned a DNS REFUSED error upon querying them. After adding these domains to my DigitalOcean account  via their API, the real number turned out to be closer to ~19,500 domains (as it appears the DNS method was not 100% accurate). For all of the domains added to my account a single DNS A record for the base domain was added to a EC2 instance. This was done in hopes of understanding why so many domains ended up in this state, and the results were quite surprising.</p><p>  合并后，总共有187,930个域名以DigitalOcean作为其DNS提供程序。现在，我们可以查询所有这些域，以检查DNS拒绝的错误，以查看它们是否未在DigitalOcean帐户下列出（并因此可以被接管）。经过简短的Python脚本和几个小时的DNS查询，我们就能枚举所有易受攻击的域（至少在前面提到的两个TLD中）。最终计数为21,598个域，这些域在查询时返回了DNS REFUSED错误。通过它们的API将这些域添加到我的DigitalOcean帐户后，实际数字却接近了19,500个域（因为DNS方法似乎并非100％准确）。对于添加到我的帐户的所有域，将基本域的单个DNS A记录添加到EC2实例。这样做是为了了解为什么这么多的域最终以这种状态出现，结果令人惊讶。</p><p>  While I expected that most of the domains were purely spam/junk domains that had not yet been configured (perhaps all belonging to a single domain reseller for example) – this was not the case. The sinkhole server was just a standard nginx web server returning a blank webpage and logging web requests. After having the server up for just a few days the access logs have grown to 1.8GB in size with a constant stream of requests pouring in. Most of these are unsurprisingly from search engines eager to crawl the web as quickly as possible (~80% of the traffic was from spiders) however the rest are legitimate users navigating to the now redirected websites.</p><p>虽然我希望大多数域都是尚未配置的纯垃圾邮件/垃圾域（例如，可能都属于一个域经销商），但事实并非如此。接收器服务器只是一个标准的Nginx Web服务器，它返回空白网页并记录Web请求。在将服务器启动几天后，访问日志的大小已增长到1.8GB，并且不断有不断涌入的请求流。其中大多数来自希望尽快抓取网络的搜索引擎，这不足为奇（约80％的流量来自蜘蛛），但是其余的都是合法用户，他们正在导航到现在重定向的网站。</p><p>  After sinkholing the domains and proving that the theory was in fact true, I reached out to DigitalOcean’s security team describing the issue (using PGP  as specified by their security page). Their response was the following:</p><p>  在消灭了各个领域并证明该理论实际上是正确的之后，我联系了DigitalOcean的安全团队来描述该问题（使用其安全页面所指定的PGP）。他们的回应如下：</p><p> Thank you for sending this in. This is a known workflow within our platform. We are committed to always improving our customer’s experience and have been examining ways of minimizing the type of behavior you are describing.</p><p> 感谢您发送此信息。这是我们平台中已知的工作流程。我们致力于不断改善客户的体验，并一直在研究减少您描述的行为类型的方法。</p><p>  So essentially they’re aware and  may be looking for ways to mitigate this behaviour in the future but they don’t appear to be making any immediate plans.</p><p>  因此，从本质上讲，他们知道并且将来可能会寻找减轻这种行为的方法，但他们似乎并未制定任何立即的计划。</p><p> Additionally my DigitalOcean account had been locked. This prevented me from the next logical step: changing all the DNS to point to 127.0.0.1 – effectively neutering the traffic. When asking support why my account had been locked (though I had some idea) I received the following response:</p><p> 另外，我的DigitalOcean帐户已被锁定。这使我无法进行下一步操作：将所有DNS都更改为指向127.0.0.1，从而有效地阻止了流量。当询问支持人员为何我的帐户被锁定时（尽管我有一些想法），我收到以下答复：</p><p> I understand this may be inconveniencing, but we are not going to be able to provide you hosting services.</p><p> 我了解这可能会带来不便，但我们将无法为您提供托管服务。</p><p>   So no reasoning for the ban and there would be no further support. This leaves me in the uncomfortable position of being stuck with all the traffic I’ve been sinkholing. Since I can’t access my account to change the domain’s DNS, I’m stuck receiving thousands of requests a minute from various sites. I can’t tear down the EC2 sinkhole server because the Elastic IP may be re-allocated to someone more malicious so I have to pay to keep it up (for how long I’m not sure). While I’ve stopped all services on the server to protect the privacy of the users accidentally hitting these sites, and have  srm-ed the access logs, I am unable to stop the flood of traffic going forward. Being in this awkward position, I reached out to DigitalOcean’s team to see if they can assist in deleting the domains from my account (sadly leaving them vulnerable again) or sinkholing the DNS to 127.0.0.1. I received a very helpful response from someone on the security team and it appears they will look into it.</p><p>   因此，没有任何理由禁止该禁令，也没有进一步的支持。这使我处于无法自拔的状态，被困在我一直沉迷的所有流量中。由于我无法访问自己的帐户来更改域的DNS，因此我一分钟无法收到来自各个站点的数千个请求。我无法拆除EC2污水处理服务器，因为弹性IP可能会重新分配给更具恶意的人，因此我必须付费以保持其正常运行（不确定的时间）。虽然我已停止服务器上的所有服务以保护意外访问这些网站的用户的隐私，并存储了访问日志，但我无法阻止大量的流量。身为这个尴尬的职位，我联系了DigitalOcean的团队，以查看它们是否可以协助从我的帐户中删除域名（使域名再次变得脆弱）或将DNS扩展到127.0.0.1。我收到了安全团队中某人的非常有帮助的答复，看来他们会调查一下。</p><p>  This provides some interesting insight as to why the pattern of using unique nameservers for importing domain names is so common (to prevent exactly this issue). It’s worthy to note that any system which uses non-unique nameservers for domain name importing is likely vulnerable to this exact same type of attack pattern (what about registrars? domain parking services?). Further research into this area is likely to yield similar results.</p><p>这提供了一些有趣的见解，说明了为什么使用唯一名称服务器导入域名的方式如此普遍（以防止出现此问题）。值得一提的是，任何使用非唯一名称服务器进行域名导入的系统都可能会受到这种完全相同类型的攻击模式的影响（注册服务商或域名停放服务是什么？）。对该领域的进一步研究可能会产生相似的结果。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://thehackerblog.com/floating-domains-taking-over-20k-digitalocean-domains-via-a-lax-domain-import-system/">https://thehackerblog.com/floating-domains-taking-over-20k-digitalocean-domains-via-a-lax-domain-import-system/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/dns/">#dns</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>