<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>NetMask NPM包，由270k +项目使用，易受八进制输入数据 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">NetMask NPM包，由270k +项目使用，易受八进制输入数据 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-30 00:33:18</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/3/9501d781f365e5af3d5ac71d90370f03.png"><img src="http://img2.diglog.com/img/2021/3/9501d781f365e5af3d5ac71d90370f03.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>以下研究概述了当前使用的NetMask NPM包中发现的漏洞，目前由278,7222个其他项目使用。该漏洞已有9年。</p><p> 由于此程序包非常令人难以置信，我会建议每个NodeJS开发人员检查他们的package.jsons以查看它们是否使用NetMask ...并立即升级！</p><p>              显然，大多数下载都没有由人类完成，而是通过连续的整合和连续递送管道（CI / CD）进行。</p><p> 对于不知道的读者，它只是“自动代码”。</p><p> 虽然它似乎很明显，大多数30,000,000,000,000多个下载是某人的Docker图像或单元测试的一部分，它应该同样显而易见，几乎所有这些包都不会在运行时在最终用户中“检查”。</p><p>  几个月前，我们在称为私有IP的下游封装中发现了不同的漏洞（CVE-2020-28360）。</p><p> 当我们修复漏洞时，我们添加了一个名为“netmask”的新包。包装非常受欢迎，每周有数百万下载。 </p><p>虽然我喜欢Regex，但是当时修复私有IP包的表达数量会很长，所以我们决定使用更强大的东西：网络掩码。</p><p> 修复包括添加一个名为NetMask的另一个包，然后使用更简单的表示法定义IP地址范围/块。</p><p> 它似乎完全是完全评估IP是否在任何给定的IPv4范围内或外部的包装。</p><p>  让私人= [＆＃39; 0.0.0.0 / 8&#39 ;,＆＃39; 10.0.0.0/8&#39 ;,＆＃39; 100.64.0.0/10&#39 ;,＆＃39; 127.0.0.0 / 8＆＃39 ;,＆＃39; 169.254.0.0/16&#39 ;,＆＃39; 172.16.0.0/12&#39 ;,＆＃39; 192.0.0.0/24&#39 ;,＆＃39; 192.0 .0.0 / 29＆＃39 ;,＆＃39; 192.0.0.8/32&#39 ;,＆＃39; 192.0.0.9/32&#39 ;,＆＃39; 192.0.0.10/32&#39 ;,＆＃39 ; 192.0.0.170/32&#39 ;,＆＃39; 192.0.0.171/32&#39 ;,＆＃39; 192.0.2.0/24&#39 ;,＆＃39; 192.31.196.0/24&#39;，＆ ＃39; 192.52.193.0/24&#39 ;,＆＃39; 192.88.99.0/24&#39 ;,＆＃39; 192.168.0.0/16&#39 ;,＆＃39; 192.175.48.0/24&#39; ，＆＃39; 198.18.0.0/15&#39 ;,＆＃39; 198.51.100.0/24&#39 ;,＆＃39; 203.0.113.0/24&#39 ;,＆＃39; 240.0.0.0/4&# 39 ;,＆＃39; 255.255.255.255/32&#39; ]</p><p>    对于给定IP，它将返回true或false关于IP是否在定义的“块”中。</p><p> 例如，网络掩码有许多其他功能，例如，它会向您展示其中有多少IP在该块中：</p><p>      几个月过去了，然后大约两周前，两个研究人员参与了私人IP固定，约翰杰克逊＆amp; Nick Sahler，联系了自己，生病的代码，与新的SSRF旁路相关。 </p><p>开发人员＆amp; 研究员，Victor Viale，已经发现另一个旁路，他向我们展示如下：  如果您想知道此问题的问题，可以在以下示例中演示：  在浏览器中输入0127.0.0.1，或者只是访问浏览器中的以下链接：http：//0127.0.0.1。  问题是，私有IP思考0127是127，因为它不是评估为以八进制格式的第一个八位字节，如真正十进制值87。  私有IP将看到0177为177，但实际位置是... 127在您的环回范围内！  如果您的浏览器识别八进制文字，但NodeJS应用程序没有，用户可以提交似乎内部的所有类型的恶性URL，但真的转到远程文件。  另一方面，用户还可以提交似乎公众的URL，但它们实际上非常私密！ </p><p>伟大的...私人IP易于绕过，又重要，导致潜在的服务器端请求伪造（SSRF）或远程文件包含（RFI）。  起初，我认为另外的开发人员在添加网络掩码后恢复了私有IP返回Regex。  尼克再次立即检查代码并提醒我们只使用正则表达式过滤IPv6。  如果你失去了汽车钥匙，那么有人通常会告诉你站在某些东西上，得到了不同的房间的视角。  从不同的角度看代码，就像鹰眼的方法一样，有时你必须捏住自己并重新审视代码的明显部分，就像是非常基本的包裹。 记得shellshock？  inck排除了IPv4正则表达式问题后，我最终排除了整个私有IP。  私有IP中的SSRF旁路实际上是由我们引入的新上游包引起的，我们已被称为网络掩码。 </p><p>近十年来，网络掩码一直错误地将八进制输入数据作为字符串读取; 只需在前面剥离0并使用其余数据作为合法。  所有270,000个项目易受攻击吗？ 好吧，很可能不是：它完全取决于项目如何使用它。  我个人没有重点检查278,000个代码基础，但其中一些项目是API，安全软件，加密项目，后端项目以及前端项目。  此时，另一个开发商凯莉，加入我们，因为我们手上有一个重大问题。  我们需要弄清楚谁在这里发生故障：是NetMask的错，因为不关心八进制输入数据？  或者它由使用网络掩码的每个单独的项目，在网扫描之前正确地将IP地址划分为十进制值，或者将八进制数据解析为十进制值？  每个其他项目怎么样，并在该项目的基础或范围内使用NetMask使用？ </p><p>有一个无限量的问题，没有人可以真正计算，而不检查所有270k下游代码基础。</p><p>   “如果您提交012，网络掩码将看到12（公共），但它真的是10（私人）”</p><p> “如果您提交010，网络掩码将看到10（私人），但它真的是一个8（公众）”</p><p>   如果NetMask定义最终目标，则有人可以从第一列输入IP地址，但实际上从第二列获取数据。</p><p>  0254.17.0.1读为254.17.0.1。但它进入了Docker Bridge Gateway，172.17.0.1（私人），通常是localhost！</p><p>  同样，任何人都可以从第二个/第三列提交IP地址，并显示为私有，但实际上可以通过欺骗网络掩码来追溯思维方式来传送恶意软件。</p><p>  控制87.0.0.1的个人使用Telecom Italia的意大利人，实际上可以将恶意软件提供给通过使用网络掩码的应用程序所做的请求，以查看请求是否为本地。 </p><p>有人，就在巴西中部，某人有IP地址：177.0.0.1，这是0177.0.0.1的真正目的地。  其他有趣的其他包括010.0.0.1，这是8.0.0.1，由3级通信控制。  使用NetMask的一些VPC / VPN适应可能会考虑010.0.0.1私有，但真的达到8.0.0.1。  同样，012.0.0.1（AT＆amp; T服务）看起来是网克的，但它真的是您的私人网络的单向机票！  您不需要特殊的IP地址来执行此操作，您可以简单地提交公共网址并获取本地文件。  从字面上有很多漏洞导致它会让你的头部旋转。  如何将CNAME鞭打到一些蜘蛛蜜罐，并欺骗使用NetMask将自己电子邮件发送到顽皮列表的应用程序？ </p><p>如何将Azure应用程序欺骗到服务邻居的请求中！</p><p>        实际用CoffeeScript编写的节点网络掩码包的维护者是Netflix的工程总监，这是意外的！ @rs是超级响应，并与我们合作在修复程序上，特别是在我们报告后的几天内获得第一个修补程序。</p><p> IP2Long将输入字符串IP分割为字符串数组，然后最终返回单个长度。</p><p>   IP2Long =（IP） - ＆gt; B =（IP +＆＃39;＆＃39;）。分裂（＆＃39;＆＃39;）;如果b.length为0或b.length＆gt; 4然后抛出新的错误（＆＃39;无效的IP＆＃39;），如果ISNAN Parseint（字节，10），则在B中抛出新错误（＆＃34;无效的字节：＃{byte}＆＃34; ）如果byte＆lt; 0或字节＆gt; 255然后抛出新的错误（＆＃34;无效的字节：＃{byte}＆＃34;）返回（（b [0]或0）＆lt; 24 |（b [1]或0）＆lt; 16 |（B [2]或0）＆lt;（b [3]或0）））>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> 0.</p><p> 由于我们知道0-Prefixed JavaScript表单中的Base-8整数，由于在使用Parseint（字节，10）中的显式基本呼叫，我们最初选择在处理输入之前选择将它们脱离基地10。</p><p>  ...对于byte，i在b如果是iSNAN解析int（字节，10），那么抛出新的错误（＆＃34;无效的字节：＃{byte}＆＃34;）如果byte和byte [0] ==＆＃39 ; 0＆＃39; ＃确认0前缀字节被解析为八进制字节= parseint（字节，8）else byte = parseint（字节，10）如果是isnan（byte），则抛出新的错误（＆＃34;无效的byte：＃{byte}＆＃ 34;）如果byte＆lt; 0或字节＆gt; 255然后抛出新的错误（＆＃34;无效的字节：＃{byte}＆＃34;）b [i] = bytereturn（（b [0]或0）> 0.</p><p> 以上不与十进制相同的0  - 前缀八位字节。我们用以下测试验证，然后向@RS发送了我们建议的补丁以供考虑： </p><p>＆＃39;框31.0.0/8&#39 ;:主题： - ＆gt;新（＆＃39; 31.0.0.0/8&#39;）＆＃39;包含IP 31.5.5.5＆＃39 ;:（块） - ＆gt; assert.ok block.Contains（＆＃39; 31.5.5.5＆＃39;）＆＃39;不包含IP 031.5.5.5（25.5.5.5）＆＃39 ;:（块） - ＆gt; Assert.ok不是块。附件（＆＃39; 031.5.5.5＆＃39;）＆＃39;框127.0.0.0/8&#39;主题： - ＆gt;新（＆＃39; 127.0.0.0/8&#39;）＆＃39;包含IP 127.0.0.2＆＃39 ;:（块） - ＆gt; assert.ok block.Contains（＆＃39; 127.0.0.2＆＃39;）＆＃39;包含IP 0177.0.0.2（127.0.0.2）＆＃39 ;:（块） - ＆gt; assert.ok block.Contains（＆＃39; 0177.0.0.2＆＃39;）</p><p>   我们以前考虑过NetMask如何解释基础-8整数的主要问题，尽管围绕使用内置NodeJS Parseint函数有一些辩论。</p><p> 虽然我们的第一次尝试解决了我们最初看到的问题，但它也在网络掩码中创造了另一个漏洞。</p><p> 现在代码将解析基本16整数，在JavaScript中以0x（即0xFF）开头，如0-前缀八进制......</p><p> 这个错误只会过大约几个小时，这是一个升级到最新版本需要278,000多个项目的十亿日。</p><p>  ...＃禁用十六进制inputif /\d/.test（字节）然后抛出新的错误（＆＃34;无效的字节：＃{byte}＆＃34;）如果ISNAN Parseint（字节，10）抛出新错误（ ＆＃34;无效的字节：＃{byte}＆＃34;）如果byte和byte [0] ==＆＃39; 0＆＃39; ＃确认0前缀字节被解析为八进制字节= parseint（字节，8）else byte = parseint（字节，10）如果是isnan（byte），则抛出新的错误（＆＃34;无效的byte：＃{byte}＆＃ 34;）如果byte＆lt; 0或字节＆gt; 255然后抛出新的错误（＆＃34;无效的字节：＃{byte}＆＃34;）b [i] = byte ...</p><p> 现在我们在传统的“点十进制”表示法中表达了IP地址，其在十六进制中被解析为长期，正如我们在基础-8和Base-10中所能。为了符合NodeJS生态系统的其余部分评估IP地址的方式，NetMask不得禁用Base-16中的IP地址或位掩码输入。这也是一个破坏的变化......由于网络掩码先前允许十六进制输入（如README所示）。 </p><p>在这一点上，我向节点JS跨堆积代码添加了一系列Mocha测试到节点网络掩码存储库，因为我们知道CoffeScript和节点可以评估一些事情......</p><p>  ...如果byte和byte [0] ==＆＃39; 0＆＃39;如果byte.length＆gt; 2和（字节[1] ==＆＃39; x＆＃39;或byte [1] ==＆＃39; x＆＃39;）＃确保0x前缀字节被解析为hex字节= parseint（字节，16 ）否则＃确保0前缀字节被解析为八进制字节= Parseint（字节，8）else字节= parseint（字节，10）...</p><p>  我们尚未考虑解释的事实，这是一个Nodejs内置，条纹空白空间......</p><p> Victor和我自己（Kelly）经过验证的验证肯定会发现在IP八位字节之前或之后的白色空间。</p><p>  否则，如果byte和（byte [0] ==＆＃39;＆＃39;或byte [byte.length-1] ==＆＃39;＆＃39;）抛出新的错误（＆＃39;无效的ip＆＃ 39;）</p><p> CoffeScript版本的NetMask中的最终修补版IP2Long的版本如下所示：</p><p> IP2Long =（IP） - ＆gt; B =（IP +＆＃39;＆＃39;）。分裂（＆＃39;＆＃39;）;如果b.length为0或b.length＆gt; 4然后抛出新的错误（＆＃39;无效的IP＆＃39;）对于byte，如果byte和byte [0] ==＆＃39; 0＆＃39;如果byte.length＆gt; 2和（字节[1] ==＆＃39; x＆＃39;或byte [1] ==＆＃39; x＆＃39;）＃确保0x前缀字节被解析为hex字节= parseint（字节，16 ）else＃确保0前缀字节被解析为八进制字节= parseint（字节，8）否则如果byte和（byte [0] ==＆＃39;＆＃39;或byte.length-1] == ＆＃39;＆＃39;）抛出新的错误（＆＃39;无效的ip＆＃39;）byte = parseint（字节，10）如果是isnan（byte），则抛出新的错误（＆＃34;无效的byte：＃ {byte}＆＃34;）如果byte＆lt; 0或字节＆gt; 255然后抛出新的错误（＆＃34;无效的字节：＃{byte}＆＃34;）b [i] = byte，而b.length＆lt; 4 B.Unshift（0）返回（B [0]＆lt; <1]＆lt; <2]＆lt;＆lt;＆lt;＆lt;＆lt; [3]＆gt;＆gt;＆gt;＆gt;＆gt;＆gt;＆lt; <3]＆lt;＆lt;＆lt;＆lt;＆lt; 0. </p><p>唯一合理的修复是考虑前导零使IP无效。 试图说服一些人应该被认为是八进制人或其他不应该被认为是八万的其他人是徒劳的。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://sick.codes/universal-netmask-npm-package-used-by-270000-projects-vulnerable-to-octal-input-data-server-side-request-forgery-remote-file-inclusion-local-file-inclusion-and-more-cve-2021-28918/">https://sick.codes/universal-netmask-npm-package-used-by-270000-projects-vulnerable-to-octal-input-data-server-side-request-forgery-remote-file-inclusion-local-file-inclusion-and-more-cve-2021-28918/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/npm/">#npm</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/ip/">#ip</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1043521.html"><img src="http://img2.diglog.com/img/2021/1/thumb_0642770f6ba3b7bd86925a9142dc733f.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1043521.html">我们将NPM重新定位为发布和分发内部CLI的Go二进制文件 </a></div><span class="my_story_list_date">2021-1-8 22:9</span></div><div class="col-sm"><div><a target="_blank" href="/story/1037603.html"><img src="http://img2.diglog.com/img/2020/12/thumb_9ad4efabca8c0a38d23134a88e0ec872.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1037603.html">恶意npm软件包捕获安装远程访问木马 </a></div><span class="my_story_list_date">2020-12-4 21:34</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032975.html"><img src="http://img2.diglog.com/img/2020/11/thumb_5cfce9df1a765e2ae57e92a402f12f24.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032975.html">恶意NPM包在程序员的计算机上打开后门</a></div><span class="my_story_list_date">2020-11-3 22:50</span></div><div class="col-sm"><div><a target="_blank" href="/story/1028618.html"><img src="http://img2.diglog.com/img/2020/10/thumb_3e8d9fa0e22d0790c640b2bc85a9edb5.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1028618.html">NPM v7.0.0发布</a></div><span class="my_story_list_date">2020-10-14 4:37</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>