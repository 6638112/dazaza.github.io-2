<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>亲爱的，我缩小了arduino核心 Honey, I shrunk the Arduino core</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Honey, I shrunk the Arduino core<br/>亲爱的，我缩小了arduino核心 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-06 07:42:08</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/4/af71a1309ae44dbf7e4d10ef4e9409f4.png"><img src="http://img2.diglog.com/img/2021/4/af71a1309ae44dbf7e4d10ef4e9409f4.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>One of my gripes about  the Arduino AVR core is that it is not an example of efficient embedded programming.  One of the  foundations of C++ (PDF) is zero-overhead abstractions, yet the Arduino core has a very significant overhead.  The Arduino basic blink example compiles to almost 1kB, with most of that space taken up by code that is never used.  Rewriting the AVR core is a task I&#39;m not ready to tackle, but after writing  picoCore, I realized I could use many of the same optimization techniques in an Arduino library.  The result is  ArduinoShrink, a library that can dramatically reduce the compiled size of Arduino projects.  In this post I&#39;ll explain some of the techniques I used to achieve the coding trifecta of faster, better, and smaller.</p><p>我关于Arduino AVR核心的一个抓地力是它不是高效嵌入式编程的一个例子。 C ++（PDF）的基础之一是零开销抽象，但Arduino内核具有非常显着的开销。 Arduino Basic Blink示例编译为近1KB，大多数由从未使用的代码占用的空间。重写AVR核心是一项任务I＆＃39; M＆＃39尚未准备好解决，但在编写小心之后，我意识到我可以在Arduino库中使用许多相同的优化技术。结果是ArduInoshRink，一个可以大大降低arduino项目的编译大小的库。在这篇文章中我＆＃39; ll解释了一些我用来实现更快，更好，更小的编码三十字的技术。</p><p> The Arduino core is actually a static library that is linked with the project code.  As Eli explains in  this post on static linking, libraries like libc usually have only one function per .o in order to avoid linking in unnecessary code.  The Arduino doesn&#39;t use that kind of modular approach, however by making use of gcc&#39;s &#34;-ffunction-sections&#34; option, it does mitigate the amount of code bloat due to the non-modular approach.</p><p> Arduino Core实际上是一个与项目代码相关联的静态库。由于Eli在静态链接上解释了这篇文章，Libc等库通常只有一个函数，以避免在不必要的代码中链接。 Arduino没有使用那种模块化方法，但是通过使用GCC＆＃39; S＆＃34;  - 功能 - 部分＆＃34;选项，它确实会降低由于非模块化方法而导致的代码融合量。</p><p> With  ArduinoShrink, I wrote more modular, self-contained code.  For example, the  Arduino delay() function calls micros(), which relies on the 32-bit timer0 interrupt overflow counter.  I simplified the delay function so that it only needs the 8-bit timer value.  If the user code never calls micros() or millis(), the timer0 ISR code never gets linked in.  By using a more efficient algorithm and writing the code in AVR assembler, I reduced the size of  the delay function to 12 instructions taking 24 bytes of flash.</p><p> 使用Arduinoshrink，我写了更多的模块化，独立的代码。例如，Arduino Delay（）函数调用micros（），它依赖于32位定时器0中断溢出计数器。我简化了延迟函数，使其仅需要8位定时器值。如果用户代码永远不会调用micros（）或millis（），则Timer0 ISR代码从未被链接。通过使用更高效的算法并在AVR汇编程序中编写代码，我将延迟功能的大小减少到12指令24闪光的字节。</p><p> In order to minimize code size and maximize speed, almost half of the code is in AVR assembler.  Despite  improvements in compiler optimization techniques over the past decades, on architectures like the AVR I can almost always write better assembler code than what the compiler generates.  That&#39;s especially true for interrupt service routines, such as the timer0 interrupt used to maintain the counters for millis() and micros().  My assembler version of the interrupt uses only 56 bytes of flash, and is faster than the Arduino ISR written in C.</p><p> 为了最小化代码大小和最大化速度，几乎一半的代码是AVR汇编程序。尽管过去几十年的编译器优化技术有所改善，但在像AVR这样的架构上，我几乎总是可以始终编写更好的汇编代码，而不是编译器生成的代码。 ＆＃39;对于中断服务例程尤其如此，例如用于维护Millis（）和micros（）的计数器的Timer0中断。我的汇编程序版本的中断仅使用56个字节的闪光，并且比在C中写的Arduino ISR更快</p><p> One part that is still written in C is the digitalWrite() function.  The Arduino core uses a set of tables in flash to map a given pin number to an IO port and bit, making for a lot of code to have digitalWrite(13, LOW) clear PORTB5.  Making use of  Bill&#39;s discovery that these flash memory table lookups can be resolved at compile time, digitalWrite(13, LOW) compiles to a single instruction: &#34;cbi PORTB, 5&#34;.</p><p> 仍然用C仍写的一个部分是DigitalWrite（）函数。 Arduino Core使用Flash中的一组表来将给定的PIN码映射到IO端口和位，使大量代码具有DigiteWrite（13，低）清除PortB5。利用比尔＆＃39; S发现，这些闪存表查找可以在编译时解析，DigiteWrite（13，低）编译为单个指令：＆＃34; CBI Portb，5＆＃34;。</p><p> ArduinoShrink is also designed to significantly reduce interrupt latency.  The original timer0 interrupt takes around 5us to run, during which time any other interrupts are delayed.  The first instruction in my ISR is &#39;sei&#39;, which allows other interrupts to run, reducing the latency impact to a few cycles more than  the hardware minimum.  The official Arduino core disables interrupts in several places, such as when reading the millis counter.  My solution is to  detect if the millis counter has been updated and re-read it, thereby avoiding any interrupt latency impact.</p><p> ArduinoshRink还设计用于显着降低中断延迟。原始Timer0中断需要左右5us运行，在此期间任何其他中断都会延迟。我的ISR中的第一个指令是＆＃39; sei＆＃39;，它允许运行其他中断，将延迟影响降低到几个周期的最小值。官方Arduino Core禁用几个地方的中断，例如在阅读Millis柜台时。我的解决方案是检测毫米计数器是否已更新并重新读取它，从而避免任何中断延迟影响。</p><p> The only limitation compared to the official AVR core is that the compiler must be able to resolve the pin number for the digital IO functions at compile time.  Although the pin may hard-coded, even with LTO enabled, avr-gcc is not always able to recognize the pin is a compile-time constant.  Since  AVR is not a priority target for GCC optimizations, I can&#39;t rely on compiler improvements to resolve this limitation.  Therefore I plan to write a version of digitalWrite that is much smaller and faster, even when avr-gcc can&#39;t figure out the pin at compile time.</p><p> 与官方AVR核心相比的唯一限制是编译器必须能够在编译时解析数字IO函数的PIN码。虽然PIN可以硬编码，但即使使用LTO启用，AVR-GCC也不总是能够识别引脚是编译时间常数。由于AVR不是GCC优化的优先目标，因此我可以＆＃39; t依赖于编译器改进来解决此限制。因此，我计划写一版本的DigitialWrite，即使AVR-GCC可以在编译时弄清楚PIN。 </p><p> Although  ArduinoShrink should be compatible with any Arduino sketch, given some of the compiler tricks I&#39;ve used it&#39;s not unlikely I&#39;ve missed a potential error.  If you do find what you think is a bug, open an  issue in the github repository.</p><p>虽然ArduinoshRink应该与任何Arduino素描兼容，但是给予了一些编译器技巧I＆＃39; ve使用它＆＃39;不太可能我错过了一个潜在的错误。 如果您确实找到了您认为错误，请在GitHub存储库中打开一个问题。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://nerdralph.blogspot.com/2021/04/honey-i-shrunk-arduino-core.html">https://nerdralph.blogspot.com/2021/04/honey-i-shrunk-arduino-core.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/arduino/">#arduino</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/shrunk/">#shrunk</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/代码/">#代码</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>