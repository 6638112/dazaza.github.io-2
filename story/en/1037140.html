<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>安装了多少物理内存？How much physical memory is installed?</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">How much physical memory is installed?<br/>安装了多少物理内存？</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-29 22:35:46</div><div class="page_narrow text-break page_content"><p>I&#39;ve often wanted to calculate the exact amount of physical memoryinstalled in a system running Linux, and I finally stumbled across asatisfying solution today: look under /sys/devices/system/memory. I know I have exactly 16GB (or GiB, if you prefer) of memory installedin this system. I&#39;ve always found it frustrating that commands like free -greport only 15GB as the “Total installed memory”. I understand why this is the case — some of the total memory isreserved by the system, some is occupied by the kernel, and only theremainder is available to applications. That&#39;s the number reported asthe “MemTotal” in /proc/meminfo, and that&#39;s the number everything elseuses. For most practical purposes, this is the number that matters. $ grep MemTotal: /proc/meminfo MemTotal: 16283212 kB$ echo $(( $(getconf PAGE_SIZE) * $(getconf _PHYS_PAGES) / 1024 ))16283212</p><p>我经常想计算安装在运行Linux的系统中的物理内存的确切数量，今天我终于偶然发现了令人满意的解决方案：在/ sys / devices / system / memory下查看。我知道我已经在该系统中安装了16GB（或者如果您愿意，可以选择GiB）的内存。我一直觉得令free -greport之类的命令只有15GB作为“安装的总内存”感到沮丧。我知道为什么会这样-某些总内存由系统保留，有些由内核占用，而只有其余部分可供应用程序使用。那是/ proc / meminfo中报告为“ MemTotal”的数字，这是其他所有东西使用的数字。对于大多数实际目的，这是重要的数字。 $ grep MemTotal：/ proc / meminfo MemTotal：16283212 kB $ echo $（（$（getconf PAGE_SIZE）* $（getconf _PHYS_PAGES）/ 1024））16283212</p><p> I knew of one other way to get an answer:  dmidecodewill report the exact size of each “memory device”. For example, mysystem has 2×8GB DIMMs installed:  Unfortunately, you must have root access in order to run dmidecode, theoutput is quite verbose (try running just &#34;dmidecode&#34;), and although ithas worked everywhere I&#39;ve tried it, I&#39;ve never been entirely sure howportable it is to different architectures and system configurations. It&#39;s not a really  satisfying solution. But look what I stumbledacross today: $ cd  /sys/devices/system &amp;&amp; echo $(( $(grep -x online  memory/memory[0-9]*/state|wc -l) * 0x$(cat  memory/block_size_bytes) / 1024**3 ))16</p><p> 我知道获得答案的另一种方法：dmidecode将报告每个“内存设备”的确切大小。例如，mysystem安装了2×8GB DIMM：不幸的是，您必须具有root用户访问权限才能运行dmidecode，输出相当冗长（尝试仅运行“ dmidecode”），尽管在我尝试过的所有地方都可以使用，从来没有完全确定过它对不同的体系结构和系统配置的适应性。这不是一个真正令人满意的解决方案。但是看看我今天遇到的困难：$ cd / sys / devices / system && echo $（（$（grep -x在线内存/内存[0-9] * / state | wc -l）* 0x $（cat内存/ block_size_bytes ）/ 1024 ** 3））16</p><p> Perfect! Each memoryN subdirectory under /sys/devices/system/memoryrepresents a block_size_bytes chunk of physical memory, and if you addup everything, you get the correct total. On my system, the block sizeis 0x8000000 bytes, i.e., 128MB, and there are 128 subdirectories, togive a total of 16GB. On systems with hot-swappable RAM, memoryN/state might be “offline”, soI grep for “online” to ensure it&#39;s not before counting the subdirectorytowards the total. (It seems one can &#34;echo offline&#34; into the state fileto change the state, but I didn&#39;t dare to try it.) Interestingly, the subdirectories are not memory0 to memory127, butmemory0 to memory20 and memory32 to memory138. There must be someexplanation for the 11-block hole in the numbers, but I don&#39;t know whatit is.  If your last reboot was not too long ago, you might find a message likethis in your dmesg: Memory:  16265512K/16659852K available (10252K kernel code,1222K rwdata, 3252K rodata, 1552K init, 656K bss,  394340Kreserved, 0K cma-reserved)</p><p> 完善！ / sys / devices / system / memory下的每个memoryN子目录都代表一个block_size_bytes物理内存块，如果将所有内容相加，则得出正确的总数。在我的系统上，块大小为0x8000000字节，即128MB，并且有128个子目录，总计16GB。在具有可热插拔RAM的系统上，内存N /状态可能为“离线”，因此我将grep设置为“在线”以确保不在将子目录计入总数之前。 （似乎可以“回传离线”状态文件以更改状态，但我不敢尝试。）有趣的是，子目录不是memory0到memory127，而是memory0到memory20和memory32到memory138。数字中的11块孔必须有一些解释，但我不知道它是什么。如果最近一次重新启动不是不久之前，您可能会在dmesg中找到以下消息：内存：可用16265512K / 16659852K（10252K内核代码，1222K rwdata，3252K rodata，1552K init，656K bss，394340Kreserved，0K cma保留）</p><p> This doesn&#39;t tell you exactly how much physical memory there is, but thenumbers are interesting. The 16265512K corresponds to MemTotal, and ifyou add the 394340K of reserved memory, you get to 16659852K. Neat, buta smidgen less than 500MB short of the expected 16777216K. That was from some old dmesg output that I happened to have saved. Whilewriting this article, however, I got curious about what my system wouldsay and rebooted to check. To my utter surprise, I couldn&#39;t make senseof the result: # uname -r5.8.0-0.bpo.2-amd64# dmesg -T|grep Memory:[Fri Nov 27 12:37:05 2020] Memory:  2627884K/16659852K available(12291K kernel code, 1292K rwdata, 4060K rodata, 1632K init,1864K bss, 442808K reserved, 0K cma-reserved)</p><p> 这并不能告诉您确切的物理内存多少，但是这些数字很有趣。 16265512K对应于MemTotal，如果添加了394340K的保留内存，则将达到16659852K。整洁，但是smidgen少于预期的16777216K不到500MB。那是我碰巧保存的一些旧的dmesg输出。但是，在撰写本文时，我对系统会说些什么感到好奇，然后重新启动进行检查。令我惊讶的是，我无法理解结果：＃uname -r5.8.0-0.bpo.2-amd64＃dmesg -T | grep内存：[Fri Nov 27 12:37:05 2020]内存：2627884K / 16659852K可用（12291K内核代码，1292K rwdata，4060K rodata，1632K init，1864K bss，442442K保留，0K cma保留）</p><p> The 16659852K is the same, and the other numbers in parentheses lookplausible (for a different kernel), but 2627884K is only 2.5GB! Despite this strange result, the values in /proc/meminfo look fine: # cat /proc/meminfo MemTotal: 16283212 kBMemFree: 8985772 kBMemAvailable: 11920424 kB…DirectMap4k: 306976 kBDirectMap2M: 9013248 kBDirectMap1G: 8388608 kB</p><p> 16659852K相同，括号中的其他数字看起来合理（对于不同的内核），但是2627884K只有2.5GB！尽管有这个奇怪的结果，/ proc / meminfo中的值看起来还是不错的：＃cat / proc / meminfo MemTotal：16283212 kBMemFree：8985772 kBMemAvailable：11920424 kB…DirectMap4k：306976 kBDirectMap2M：9013248 kBDirectMap1G：8388608 kB</p><p> The message in question comes from the mem_init_print_info() function in mm/page_alloc.c(edited for clarity): pages_to_kb = PAGE_SHIFT - 10; /* == 2 for 4KB x86 pages */reserved_pages = get_num_physpages() - totalram_pages() …;pr_info(&#34;Memory:  %luK/%luK available (%luK kernel code, …, &#34; &#34;%luK reserved, …)\n&#34;,  nr_free_pages() &lt;&lt; pages_to_kb, get_num_physpages() &lt;&lt; pages_to_kb, codesize &gt;&gt; 10, … reserved_pages &lt;&lt; pages_to_kb, …);</p><p> 有问题的消息来自mm / page_alloc.c中的mem_init_print_info（）函数（为清晰起见进行了编辑）：pages_to_kb = PAGE_SHIFT-10; / * == 2 for 4KB x86 pages * / reserved_pa​​ges = get_num_physpages（）-totalram_pages（）…; pr_info（“内存：％luK /％luK可用（％luK内核代码，...，”“％luK保留，...）\ n“，nr_free_pages（）> 10，…reserved_pa​​ges << pages_to_kb，…）;</p><p> I don&#39;t know why this kernel suddenly thinks I have a drasticallysmaller nr_free_pages() than before, but I look forward to finding out.</p><p> 我不知道为什么这个内核突然认为我的nr_free_pages（）比以前小得多，但是我期待发现。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/内存/">#内存</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/物理/">#物理</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/memory/">#memory</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>