<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>在我的酒店逆向工程一个神秘的UDP流 Reverse Engineering a Mysterious UDP Stream in My Hotel</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Reverse Engineering a Mysterious UDP Stream in My Hotel<br/>在我的酒店逆向工程一个神秘的UDP流 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-01 20:03:30</div><div class="page_narrow text-break page_content"><p>Hey everyone, I have been staying at a hotel for a while. It’s one of those modern ones with smart TVs and other connected goodies. I got curious and opened Wireshark, as any tinkerer would do.</p><p>嘿大家，我一直住在酒店一段时间。这是具有智能电视和其他连接好吃的现代化的现代化。因为任何Tinkerer都会这样做，我感到好奇并打开了Wireshark。</p><p>  I was very surprised to see a huge amount of UDP traffic on port 2046. I looked it up but the results were far from useful. This wasn’t a standard port, so I would have to figure it out manually.</p><p>  我非常惊讶地看到港口2046年的大量UDP流量。我看了看起来，但结果远非有用。这不是一个标准端口，所以我必须手动弄清楚。</p><p>  At first, I suspected that the data might be a television stream for the TVs, but the packet length seemed too small, even for a single video frame.</p><p>  起初，我怀疑数据可能是电视的电视流，但分组长度似乎太小，即使是单个视频帧。</p><p>      The UDP packets weren’t sent to my IP and I wasn’t doing ARP spoofing, so these packets were sent to everyone. Upon closer inspection, I found out that these were  Multicast packets. This basically means that the packets are sent once and received by multiple devices simultaneously. Another thing I noticed was the fact that all of those packets were the same length (634 bytes).</p><p>      UDP数据包没有发送到我的IP，我没有做ARP欺骗，所以这些数据包被发送给每个人。仔细检查后，我发现这些是组播数据包。这基本上意味着数据包被发送一次并同时由多个设备接收。我注意到的另一件事是，所有这些数据包都是相同的长度（634字节）。</p><p>  I decided to write a Python script to save and analyze this data. First of all, here’s the code I used to receive Multicast packets. In the following code,  234.0.0.2 is the IP I got from Wireshark.</p><p>  我决定编写一个Python脚本来保存和分析此数据。首先，这是我用于接收组播数据包的代码。在以下代码中，234.0.0.2是我从Wireshark获得的IP。</p><p>  import  socket import  struct s  =  socket . socket ( socket . AF_INET ,  socket . SOCK_DGRAM ,  socket . IPPROTO_UDP ) s . setsockopt ( socket . SOL_SOCKET ,  socket . SO_REUSEADDR ,  1 ) s . bind (( &#39;&#39; ,  2046 )) mreq  =  struct . pack ( &#34;4sl&#34; ,  socket . inet_aton ( &#34;234.0.0.2&#34; ),  socket . INADDR_ANY ) s . setsockopt ( socket . IPPROTO_IP ,  socket . IP_ADD_MEMBERSHIP ,  mreq ) while  True :  data  =  s . recv ( 2048 )  print ( data )</p><p>  导入套接字导入结构s =套接字。套接字（套接字。AF_INET，套接字。SOCK_DGROM，套接字。IPPROTO_UDP）S。 setsockopt（套接字。sol_socket，socket。so_reuseaddr，1）s。绑定（（＆＃39;＆＃39;，2046））mreq = struct。包（＆＃34; 4SL＆＃34;，套接字。INET_ATON（＆＃34; 234.0.0.2＆＃34;），插座。inaddr_any）s。 SetsockOpt（套接字。IPPROTO_IP，套接字。IP_ADD_MEMBERSHIP，MREQ）而true：data = s。 RECV（2048）打印（数据）</p><p>  On top of this, I also used  binascii to convert this to hex in order make reading the bytes easier. After watching thousands of these packets scroll through the console, I noticed that the first ~15 bytes were the same. These bytes probably indicate the protocol and the packet/command ID but I only received the same one so I couldn’t investigate those.</p><p>  在此之上，我还使用Binascii将此转换为十六进制，以便更轻松地阅读字节。观看数千个这些数据包滚动控制台后，我注意到第一个〜15个字节是相同的。这些字节可能表示协议和数据包/命令ID，但我只收到相同的协议，以便我无法调查那些。 </p><p>    It also took me an embarrassingly long time to see the string  LAME3.91UUUUUUU at the end of the packets. I suspected this was MPEG compressed audio data, but saving one packet as test.mp3 failed to played with mplayer and the  file utility only identified this as  test.mp3: data. There was obviously data in this packet and  file should know when it sees MPEG Audio data, so I decided to write another Python script to save the packet data with offsets. This way it would save the file  test1 skipping 1 byte from the packet,  test2 skipping 2 bytes and so on. Here’s the code I used and the result.</p><p>它还花了我一个令人尴尬的时间很长一段时间，在数据包结束时看到字符串跛行。我怀疑这是MPEG压缩的音频数据，但保存一个数据包作为Test.mp3无法使用mplayer播放，并且文件实用程序仅将此标识为test.mp3：数据。在此数据包中有显然数据和文件应该知道它何时看到MPEG音频数据，所以我决定编写另一个Python脚本以将数据包数据与偏移一起保存。这样，它将保存文件Test1从数据包跳过1个字节，Test2跳过2个字节等。这是我使用的代码和结果。</p><p>    After this, I ran  file test* and voilà! Now we know we have to skip 8 bytes to get to the MPEG Audio data.</p><p>    在此之后，我ran文件测试*和voilà！现在我们知道我们必须跳过8个字节来获取MPEG音频数据。</p><p>  $  file  test * test0: datatest1: UNIF v-16624417 format NES ROM imagetest10: UNIF v-763093498 format NES ROM imagetest11: UNIF v-1093499874 format NES ROM imagetest12: datatest13: TTComp archive, binary, 4K dictionarytest14: datatest15: datatest16: UNIF v-1939734368 format NES ROM imagetest17: UNIF v-1198759424 format NES ROM imagetest18: UNIF v-256340894 format NES ROM imagetest19: UNIF v-839862132 format NES ROM imagetest2: UNIF v-67173804 format NES ROM imagetest20: datatest21: datatest22: datatest23: DOS executable (COM, 0x8C-variant)test24: COM executable for DOStest3: UNIF v-1325662462 format NES ROM imagetest4: datatest5: datatest6: datatest7: datatest8: MPEG ADTS, layer III, v1, 192 kbps, 44.1 kHz, JntStereotest9: UNIF v-2078407168 format NES ROM image</p><p>  $文件测试* test0：datatest1：unif v-16624417格式nes rom imageTest10：unif v-763093498格式nes rom imageTest11：unif v-1093499874格式nes rom imageTest12：datatest13：ttcomp存档，二进制，4k字典蒂斯14：datatest15：datatest16：unif V-1939734368格式NES ROM ImageTest17：UNIF V-1198759424格式NES ROM ImageTest18：UNIF V-256340894格式NES ROM ImageTest19：UNIF V-839862132 Format NES Rom ImageTest2：Unif V-67173804格式NES Rom ImageTest20：DataTest21：Datatest22：DataTest23： DOS可执行文件（COM，0x8C-VARIANT）TEST24：COM可执行文件为DOSTEST3：UNIF V-1325662462格式NES ROM ImageTest4：DataTest5：DataTest6：Datatest7：Datatest8：MPEG ADTS，第III层，V1，192 Kbps，44.1 kHz，JntstereTest9：UNIF V-2078407168格式NES ROM图像</p><p>    Now all we need to do is continuously read packets, skip the first 8 bytes, write them to a file and it should play perfectly.</p><p>    现在我们需要做的只是持续读取数据包，跳过前8个字节，将它们写入文件，它应该完美播放。</p><p>  But what was this audio? Was this a sneakily placed bug that listened to me? Was it something related to the smart TVs in my room? Something related to the hotel systems? Only one way to find out.</p><p>  但这个音频是什么？这是一个令人窒息的虫子，听我了吗？是否与我房间里的智能电视有关？与酒店系统有关的东西？只有一种方法可以找到。</p><p>  $  python3 listen_2046.py  &gt; test.mp3 * wait a little to get a recording *^C $  mplayer test.mp3 MPlayer (C) 2000-2016 MPlayer Team224 audio &amp; 451 video codecsPlaying test.mp3.libavformat version 57.25.100 (external)Audio only file format detected.=====Starting playback...A: 3.9 (03.8) of 13.0 (13.0) 0.7%</p><p>  $ python3 lishing_2046.py＆gt; test.mp3 *等待一点录制* ^ c $ mplayer test.mp3 mplayer（c）2000-2016 Mplayer Team224音频＆amp; 451视频编码播放测试.mp3.libavformat版本57.25.100（外部）音频仅检测到文件格式。=====开始播放...... A：3.9（03.8）13.0（13.0）0.7％</p><p>    What the hell? I can’t believe I spent time for this. It’s just elevator music. It is played in the hotel corridors around the elevators. Oh well, at least I can listen to it from my room now.</p><p>    我勒个去？我不敢相信我花时间为此。这只是电梯音乐。它在电梯周围的酒店走廊里玩。哦，至少我现在可以从我的房间听它。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.gkbrk.com/2016/05/hotel-music/">https://www.gkbrk.com/2016/05/hotel-music/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/逆向工程/">#逆向工程</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/逆向/">#逆向</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/数据包/">#数据包</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>