<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Postgres中的版本化有限状态机</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Postgres中的版本化有限状态机</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-23 13:11:20</div><div class="story_img_container"><a href="http://img.diglog.com/img/2020/8/9e1c31b56a363cf1fc238af2a8b536a7.jpg"><img src="http://img.diglog.com/img/2020/8/9e1c31b56a363cf1fc238af2a8b536a7.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>受Felix Geisendorfer博客文章的启发，我用Postgresql实现了一个数据库FSM(有限状态机)。我对Felix的实现进行了一些改进，但在阅读以下内容之前，我建议您仔细阅读原始文章。</p><p>为简单起见，我将使用与Felix完全相同的FSM图：包含付款和发货步骤的订购流程。</p><p>首先，我将状态/事件存储从文本替换为枚举。因为我有有限数量的状态和转换，所以我可以将它们正确地存储为自定义枚举。它将这些数据的存储减少到更轻且恒定的4字节。</p><p>将类型ORDER_STATE创建为ENUM(&#39；开始&#39；，&#39；等待支付&#39；，&#39；等待_发货&#39；，&#39；等待退款&#39；，&#39；已发运&#39；，&#39；已取消&#39；，&#39；错误&#39；)；将类型ORDER_EVENT创建为ENUM(&#39；创建&#39；，&#39；支付&#39；，&#39；发货&#39；，&#39；退款&#39；，&#39；取消&#39；)；</p><p>创建表ORDER_EVENTS(id bigint总是作为标识主键生成，order_id UUID NOT NULL DEFAULT UUID_GENERATE_v4()，EVENT ORDER_EVENT NOT NULL DEFAULT&#39；CREATE&#39；，TIME TIMESTAMP DEFAULT NOW()NOT NOT。</p><p>正如您注意到的，我将order_id类型从int替换为uuid。简而言之，因为它超出了范围：我从不对从数据库中取出的字段使用SERIAL。</p><p>在他的实现中，Felix Geisendorfer使用Switch语句来实现状态转换，这是一个很好、很简单的解决方案。但是，如果您有更多的状态/事件，可能会变得很难维护。此外，如果要对FSM进行版本化，通常需要创建或替换FuncION。相反，我创建了一个包含3列的映射表：</p><p>创建表ORDER_EVENTS_TRANSIONS(STATE ORDER_STATE NOT NULL，EVENT ORDER_EVENT NOT NULL，NEXT_STATE ORDER_STATE NOT NULL，PRIMARY KEY</p><p>答：对于具有主键(状态、事件)的两个给定状态，我可以将转换限制为只有一条路径。</p><p>在我们的新转换函数中，不在此表中的任何转换都将被解析为错误状态：</p><p>CREATE Function ORDER_EVENTS_TRANSION(_STATE ORDER_STATE，_EVENT ORDER_EVENT)将ORDER_STATE语言SQL返回为$$SELECT COALESSCE((SELECT NEXT_STATE FROM ORDER_EVENTS_TRANSIONS WHERE STATE=_STATE和EVENT=_EVENT)，&#39；</p><p>安：也许有一种比“合并”更好的方式来实现“默认”…。</p><p>插入ORDER_EVENTS_TRANSFIONS值(&#39；开始&#39；，&#39；创建&#39；，&#39；等待支付&#39；，&#39；等待支付&#39；，&#39；等待发货&#39；)，(&#39；等待支付&#39；，&#39；取消&#39；，&#39；取消&#39；，&#39；取消&#39；，&#39；取消&#39；，&#39；取消&#39；，&#39；取消&#39；，&#39；取消&#39；，&#39；取消&#39；)，(&#39；等待发货&#39；，&#39；取消&#39；，&#39；等待退款&#39；，&#39；等待发货&#39；，&#39；发货&#39；，&#39；发货&#39；)，(&#39；等待退款&#39；，&#39；退款&#39；，&#39；取消&#39；)；</p><p>在现实生活中，我的用例和业务流程不断变化(快速)。因为我构建的FSM是这个过程的实现，所以IRL的每个更改都会影响我的数据库设计。</p><p>如果我在不考虑过去的ORDER_EVENTS的情况下更改转换函数和表，我将完全破坏我的FSM。实际上，因为我正在移动Create事件，所以所有已经记录的转换都将引发错误状态。它是不可维护的！</p><p>将类型ORDER_FSM_VERSION_STATUS创建为ENUM(&#39；LIVE&#39；，&#39；已过时&#39；，&#39；废弃&#39；)；创建表ORDER_FSM_VERSIONS(始终作为标识主键生成的版本整数，STATUS ORDER_FSM_VERSION_STATUS NOT NULL DEFAULT&#39；LIVE&#39；)；</p><p>CREATE函数ORDER_FSM_LAST_VERSION()以$$SELECT VERSION FROM ORDER_FSM_VERSIONS WHERE STATUS=&#39；LIVE&#39；ORDER BY VERSION DESC LIMIT 1；$$；</p><p>CREATE TABLE ORDER_EVENTS(id bigint总是作为标识主键生成，order_id UUID NOT NULL DEFAULT UUID_GENERATE_v4()，EVENT ORDER_EVENT NOT NULL DEFAULT&#39；CREATE&#39；，VERSION INTEGER NOT NULL DEFAULT ORDER_FSM_LAST_VERSION()，TIMESTAMP NOT NULL DEFAULT NOW()，外键(版本)引用ORDER_F。创建表ORDER_EVENTS_TRANSIONS(STATE ORDER_STATE NOT NULL，EVENT ORDER_EVENT NOT NULL，VERSION INTEGER NOT NULL DEFAULT ORDER_FSM_LAST_VERSION()，NEXT_STATE ORDER_STATE NOT NULL，PRIMARY KEY(STATE，EVENT，VERSION，NEXT_。</p><p>转换函数及其聚合还必须注意此版本号：</p><p>CREATE函数ORDER_EVENTS_TRANSION(_STATE ORDER_STATE，_EVENT ORDER_EVENT，_VERSION INTEGER DEFAULT ORDER_FSM_LAST_VERSION())将ORDER_STATE语言SQL返回为$$SELECT COALESSCE((SELECT NEXT_STATE FROM ORDER_EVENTS_TRANSIONS WHERE STATE=_STATE和EVENT=_EVENT AND VERSION=_。创建聚合ORDER_EVENTS_FSM(ORDER_EVENT，INTEGER)(SFUNC=ORDER_EVENTS_TRANSION，STYPE=ORDER_STATE，INITCOND=&#39；START&#39；)；</p><p>最后，我们必须根据版本状态限制一些转换。它按ORDER_EVENTS_TRIGGER进行：</p><p>CREATE Function ORDER_EVENTS_TRIGGER_FUNC()将触发器语言plpgsql返回为$$DECLARE NEXT_STATE ORDER_STATE；TRANSPATION_STATUS ORDER_FSM_VERSION_STATUS；BEGIN SELECT STATUS。版本转换为TRANSFERATION_STATUS；如果TRANSPATION_STATUS=&#39；已弃用&#39；：：ORDER_FSM_VERSION_STATUS，则发出通知&#39；版本%已弃用&#39；，新。版本；结束IF；如果转换状态=&#39；已过时&#39；：：ORDER_FSM_VERSION_STATUS，则引发异常&#39；版本%已过时&#39；，新。Version；end if；select order_events_fsm(event，version order by id)from(select id，event，version from order_events where order_id=new。Order_id联合选择新建。身份证，新的。活动，新的。版本)%s进入NEXT_STATE；如果NEXT_STATE=&#39；错误&#39；：：ORDER_STATE，则引发异常&#39；无效订单事件&#39；；END IF；RETURN NEW；END$$；</p><p>我现在可以引入我的FSM图的新版本，并弃用以前的版本。当我在ORDER_EVENTS中插入行时，它默认使用图形的最后一个活动版本。</p><p>插入ORDER_FSM_VERSIONS(版本，状态)值(2，&#39；LIVE&#39；)，返回*；UPDATE ORDER_FSM_VERSIONS SET STATUS=&#39；已弃用&#39；WHERSION=1；INSERT INSERT INTER ORDER_EVENTS_TVERSIONS(STATE，EVENT，NEXT_STATE，VERSION)值(&#39；开始&#39；，&#39；创建&#39；，&#39；等待批准&#39；，2)，(&#39；等待审批&#39；，&#39；批准&#39；，&#39；等待付款&#39；，2)，(&#39；等待付款&#39；，&#39；支付&#39；，&#39；等待发货&#39；，2)，(...)。插入ORDER_EVENTS(Order_id，Event，Time)值(&#39；0d687d74-bab3-4c76-beed-0f55ec8a3af2&#39；，&#39；创建&#39；，&#39；2017-07-23 00：00：00&#39；)，(&#39；0d687d74-bab3-4c76-beed-0f55ec8a3af2&#39；，&#39；批准&#39；，&#39；2017-07-23 00：00&#39；)，(&#39；0d687d74-bab3-4c76-beed-0f55ec8a3af2&#39；，&#39；Pay&#39；，&#39；2017-07-23 12：00&#39；)；</p><p>我编写了一个小SQL脚本来测试所有这些功能。即使你不能开箱即用，我也希望它是有用的。如果您有反馈，请告诉我。</p><p>最后，请记住，它仍然是试验性的。请将其视为POC，而不是可以投入生产的产品！</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://raphael.medaer.me/2019/06/12/pgfsm.html">https://raphael.medaer.me/2019/06/12/pgfsm.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/版本/">#版本</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/finite/">#finite</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/order/">#order</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1019104.html"><img src="http://img.diglog.com/img/2020/8/thumb_5c85379002d40249724c295417d5369d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019104.html">为什么Linux有史以来最大的内核版本没什么大不了的</a></div><span class="my_story_list_date">2020-8-19 21:20</span></div><div class="col-sm"><div><a target="_blank" href="/story/1018583.html"><img src="http://img.diglog.com/img/2020/8/thumb_295e1d97560db0a837217fbcdcaad6ba.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018583.html">Clojure中的波函数崩溃</a></div><span class="my_story_list_date">2020-8-17 9:24</span></div><div class="col-sm"><div><a target="_blank" href="/story/1016438.html"><img src="http://img.diglog.com/img/2020/8/thumb_606b661574fb025cfb3faaeb8b7ec2cd.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1016438.html">
三星Galaxy Watch 3的挡板又回来了</a></div><span class="my_story_list_date">2020-8-5 23:52</span></div><div class="col-sm"><div><a target="_blank" href="/story/1015928.html"><img src="http://img.diglog.com/img/2020/8/thumb_fa98f9572cd087c644a001731291fa97.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1015928.html">Linus Torvalds渴望修复头文件，但无论如何都会发布Linux5.8</a></div><span class="my_story_list_date">2020-8-4 0:22</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>