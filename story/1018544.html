<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>不带浏览器的WebAssembly第1部分</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">不带浏览器的WebAssembly第1部分</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-08-17 03:58:10</div><div class="page_narrow text-break page_content"><p>大多数WebAssembly在线教程和示例都侧重于在浏览器中使用它，以加速网站或Web应用程序的各种功能。但是，有一个领域的WebAssembly功能非常强大，但没有太多讨论：浏览器场景之外的领域。这就是我们将在这一系列帖子中关注的。</p><p>网络人经常给事物带来恶名(web-GPU就是另一个例子)。WebAssembly既不是Web，也不是汇编，而是一种字节码，可以从C++、C#、Rust和其他语言中定位。这意味着您可以编写一些Rust代码，将其编译成WebAssembly，然后在WebAssembly虚拟机中运行该代码。</p><p>这是非常强大的，因为您将不再需要处理垃圾收集的脚本语言，基本上使用Rust或C++作为您的脚本语言。WebAssembly支持可预测和稳定的性能，因为它不像通常的选项(Lua/JavaScript)那样需要垃圾收集。</p><p>这是一个相对较新的产品，有很多粗糙的地方，特别是在浏览器之外的情况下。在我的经历中，最艰难的事情之一是为浏览器外的场景编写文档，这就是我发表博客文章的原因，目的是记录我的发现，希望能帮助一些可能对这个主题感兴趣的人。</p><p>对于浏览器之外的场景，它的主要优势之一是提供系统级访问，而不会影响安全性。这是通过WASI(Web组装系统接口)完成的。WASI是一组类似C的函数，它们以安全的方式提供对FD_READ、RAND、FD_WRITE、THREADS(WIP)等功能的访问。</p><p>在以下几种情况下，您可以在浏览器之外使用Web程序集：</p><p>以最小的开销运行一些代码，就像Fastly/Cloudflare在边缘计算场景中所做的那样。</p><p>在物联网设备上安全地运行一些易于更新的代码，并将运行时开销降至最低。</p><p>为了在这次冒险中获得最佳体验，我建议使用Visual Studio代码作为您的IDE，并安装以下扩展：</p><p>首先，您需要一个可以运行WebAssembly程序的虚拟机(VM)。此虚拟机需要是可嵌入的，以便您可以将其添加到您的游戏引擎中，或者从现在开始我们将在主机程序中将其添加到游戏引擎中。有几个可供选择：WASM3、Wasmtime、WAMR和许多其他的。它们具有各种特性，例如支持JIT、使用尽可能少的内存等等，您必须选择一种适合您的目标平台和场景的特性。</p><p>除了调试之外，除了运行时属性外，您选择什么VM都无关紧要。我发现的唯一允许无缝调试体验的VM是Wasmtime(这是另一个粗糙的边缘)。因此，即使您由于其他限制而不打算将其部署到任何地方，我也建议您将其用作调试VM。无论何时需要调试一些WASM代码，都可以使用Wasmtime启动它。</p><p>现在，我们可以编辑lib.rs并从中导出以下与CFFI兼容的函数：</p><p>#[NO_MANGLE]外部&#34；C&#34；FN SUM(a：I32，b：I32)-&gt；I32{let s=a+b；println！(&#34；from WASM：SUM is：{：？}&#34；，s)；s}。</p><p>这是一个函数，它接受两个数字，将它们相加，然后在返回它们的和之前打印结果。WebAssembly没有定义在加载模块之后执行的默认函数，因此在宿主程序中，您需要根据函数的签名获取函数并运行它(非常类似于dlopen/dlsym的工作方式)。</p><p>我们使用[#no_manger]和pub extern&#34；C&#34；将这个SUM函数(以及我们希望从主机VM调用的任何其他函数)公开为可从C调用的函数。如果您是从一些WASM来这里学习浏览器教程，您可能会注意到我们根本不需要使用wasm-bindgen。</p><p>Rust支持WebAssembly的两个目标：wam32-未知-未知和wam32-wai。第一个是基本的WebAssembly。可以将其视为WebAssembly的[#no-std]。它是您在浏览器中使用的那种，它不假定有任何系统功能可用。</p><p>在另一端，wam32-wasi假设VM公开了WASI功能，允许使用标准库的不同实现(该实现依赖于可用的WASI函数)。</p><p>您可以在这里查看Rust的stdlib的可用实现：https://github.com/rust-lang/rust/tree/master/library/std/src/sys这是假设当在WebAssembly VM：https://github.com/rust-lang/rust/tree/master/library/std/src/sys/wasi.中运行时，Rust程序可以使用WASI函数的实现。</p><p>#只运行此命令一次，然后为wam32-wai目标添加wasm32-wai#编译。Cargo build wasm32-wai。</p><p>您可能已经注意到，我们调用println！()并期望程序工作并打印到控制台，但是WebAssembly程序如何知道如何做到这一点呢？</p><p>这就是我们使用wam32-wai的原因。此目标为rust stdlib选择假定具有某些功能的版本(WASI函数)。打印到控制台意味着只需写入特殊的文件描述符。大多数虚拟机在默认情况下都允许这样做，因此除了编译正确的wam32-wai目标之外，我们不需要进行任何特殊设置。</p><p>如果您已经为vscode安装了所需的扩展，您现在可以右键单击target/wasm32-wai/debug/wasm_example.wasm并选择Show WebAssembly，您应该会在vscode中打开一个新文件，如下所示：</p><p>(模块...。(类型$T15(函数(参数i64 I32 I32)(结果I32)(IMPORT&#34；WASI_SNAPSHOT_PREVIE1&#34；&#34；FD_WRITE&34；(FUNC$_ZN4wasi13lib_generated22wasi_snapshot_preview18fd_write17h6ec13d25aa9fb6acE(类型$T8)(IMPORT&#34；WASI_SNAPSHOT_PREVIE1&#34；&#34；PROC_EXIT&#34；(函数$__WASI_PROC_EXIT(类型$t0)(IMPORT&#34；WASI_SNAPSHOT_PREVIE1&#34；&#34；ENVIRON_SIZES_GET&#34；(FUNC$__WASI_ENVIRON_SIZES_GET(类型$T2)(IMPORT&#34；WASI_SNAPSHOT_PREVIE1&#34；&#34；ENVIRON_GET&#34；(函数$__WASI_ENVIRON_GET(类型$T2)(函数$_ZN4core3fmt9Arguments6new_v117hb11611244be67330E(类型$t9)(参数$P0 I32)(参数$p1 I32)(参数$p2 I32)(参数$p3 I32)(参数$p4 I32)(本地$L5 I32)(本地$16 I32)(本地$L7 I32)。(LOCAL$18 I32)(LOCAL$L9 I32)(LOCAL$L10 I32)global.get$G0 local.set$L5...。</p><p>这是一份水务档案。WAT代表WebAssembly文本格式。这有点像在反汇编二进制文件时查看x64/arm ASM指令，只是更难看，更难理解。我读到这是因为WebAssembly的创建者不能决定文本格式，所以他们只是把它留在这个难看的s表达式形式中。</p><p>这里的import语句告诉我们，WASM程序需要以下函数来运行存在于WASI_SNAPSHOT_PREVIEW 1名称空间中的PROC_EXIT、FD_WRITE、ENVIRON_GET、ENVIRON_SIZES_GET。从WebAssembly模块导入或导出的所有函数都需要命名空间。WASI_SNAPSHOT_PREVIE1是WASI名称空间，因此您可以将其视为这些函数的保留名称空间。普林特恩！需要WASI_SNAPSHOT_PREVIE1：：FD_WRITE才能写入标准输出。</p><p>您可以选择任何具有WASI可用的虚拟机。我将使用Wasmtime，因为稍后我想向您展示如何调试WebAssembly，而这个VM是目前唯一可以调试的虚拟机。</p><p>该程序从路径：Examples/wasm_example.wasm加载wasm二进制文件。这是您以前编译过的文件，可以在wasm_example/target/wasm32-wasi/debug/wasm_example.wasm.中找到。在运行主机程序之前，请确保将其移动到正确的位置。</p><p>下面是主机VM rust程序的完整清单，该程序初始化Wasmtime VM、加载模块、链接WASI，并从WASM模块加载并执行导出的SUM函数：</p><p>Use std：：Error：：Error；use wasmtime：：*；use wasmtime_wasi：：{wasi，WasiCtx}；fn main()-&gt；result&lt；()，Box&lt；dyn error&gt；{//A`Store`在某种意义上是一种全局对象，但现在说它通常传递给大多数构造就足够了。//让store=Store：：Default()；让Engine=Engine：：New(Config：：New().debug_info(True))；让store=Store：：New(&amp；Engine)；//我们首先创建一个`Module`，表示输入wasm模块的编译形式//。在本例中，它将在//我们解析文本格式之后进行JIT编译。Let module=Module：：from_file(&amp；engine，&amp；engine/wasm_example.wasm&#34；)？；//将WASI模块链接到我们的VM。Wasmtime允许我们决定WASI是否在场。//因此我们需要在这里加载它，因为我们的模块需要从//WASI_SNAPSHOT_PREVIE1名称空间中提供某些函数，如上所述。//这将使我们的WASM程序中的println！()正常工作。(它使用FD_WRITE)。让wasi=wasi：：new(&amp；store，WasiCtx：：New(std：：env：：args()？)；让mut Imports=VEC：：New()；用于模块.Imports()中的导入{if import.module()==&#34；wasi_snap_preview1&#34；{if let ome(Export)=wasi.get_export(import.name(){Imports.ush(Extern：：from(export.。}}死机！(&#34；找不到`{}：：{}`&#34；，import.module()，import.name())；}//在我们编译了一个`Module`之后，我们可以实例化它，创建//一个我们可以实际插入函数的`Instance`。让instance=instance：：new(&amp；store，&amp；module，&amp；Imports)？；//`Instance`让我们可以访问各种导出的函数和项，//我们可以在这里访问它们来拉出我们的`swer`导出函数并//运行它。让main=instance.get_func(&#34；sum&#34；).Expect(&#34；`main`不是导出函数&#34；)；//有几种方法可以调用`main``函数`值。//最简单的方法是使用`get2`静态断言其签名(本例中断言//它接受2个I32参数并返回1个I32)，然后调用它。让main=main.get2：：&lt；I32，I32，I32&gt；()？；//最后我们可以调用我们的函数了！请注意，使用`？`进行错误传播//是为了处理wasm函数陷入陷阱的情况。让result=main(5，4)？；println！(&#34；from host：答案返回给主机VM：{：？}&#34；，result)；确定(())}。</p><p>编译wasm_host v0.1.0(Wasm_Host)在运行`target\debug\wasm_host.exe`FROM WASM：SUM IS：9FROM HOST：答案返回到主机VM：9的35.38秒内完成了dev[未优化+调试信息]目标。</p><p>我们可以观察到Printn！从wasm模块返回的信息已正确打印到控制台，返回的答案如预期的那样为9。</p><p>在我的WebAssembly Outside the Browser系列的这篇文章中，我们学习了如何编译WebAssembly的程序、设置主机程序来加载和运行您的WASM二进制文件、执行WASM程序导出的函数以及将所有这些放在一起，最后我们将两个数字相加并打印它们的结果(从WebAssembly和主机程序)。在接下来的部分中，我们将涉及调试、优化程序大小、将主机VM的函数公开给WASM程序以及在两个VM之间共享内存等领域。</p><p>以下是完整的WASM规范。对我来说，这是我读过的最难的规范之一。我更希望这个规范类似于CPU用户手册(例如VR4300)，而不是将当前的形式强行转换成某种数学语言，虽然正确，但不会给读者带来额外的清晰度或洞察力。我强烈认为这里描述的概念本可以用一种更容易理解和解析的语言很好地表达出来，我不相信“实际上，它针对的是VM作者，而不是普通人”这种常见的借口。我们应该接受它根本无法访问的事实，我们可以做得更好。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://alexene.dev/2020/08/17/webassembly-without-the-browser-part-1.html">https://alexene.dev/2020/08/17/webassembly-without-the-browser-part-1.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/浏览器/">#浏览器</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/browser/">#browser</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/函数/">#函数</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1017016.html"><img src="http://img.diglog.com/img/2020/8/thumb_8bac61c9335cdb5d67945eae8487c0f8.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1017016.html">不升级到新的Firefox for Android浏览器的三个原因</a></div><span class="my_story_list_date">2020-8-8 23:55</span></div><div class="col-sm"><div><a target="_blank" href="/story/1015457.html"><img src="http://img.diglog.com/img/2020/8/thumb_1857b9181adce2d709e1f9a4e695e709.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1015457.html">如果谷歌是你的搜索引擎，微软的Edge浏览器就会崩溃</a></div><span class="my_story_list_date">2020-8-1 1:14</span></div><div class="col-sm"><div><a target="_blank" href="/story/1011834.html"><img src="http://img.diglog.com/img/2020/7/thumb_a6c2db4a1e33f6a86f1a55e60f692bef.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1011834.html">
投资者正在浏览Chromium初创公司</a></div><span class="my_story_list_date">2020-7-15 3:35</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008255.html"><img src="http://img.diglog.com/img/2020/6/thumb_b2ce936850c390ff53a37eacb94373c7.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008255.html">角度10现已可用</a></div><span class="my_story_list_date">2020-6-26 2:59</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>