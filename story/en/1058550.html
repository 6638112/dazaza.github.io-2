<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>允许任意URL，期待任意代码执行 Allow arbitrary URLs, expect arbitrary code execution</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Allow arbitrary URLs, expect arbitrary code execution<br/>允许任意URL，期待任意代码执行 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-16 02:46:58</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/4/b948e2c4d83cbe4e00c7e366ca12644a.png"><img src="http://img2.diglog.com/img/2021/4/b948e2c4d83cbe4e00c7e366ca12644a.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>-- MARKDOWN -- - We found and reported 1-click code execution vulnerabilities in popular software including **Telegram**, **Nextcloud**, **VLC**, **Libre-/OpenOffice**, **Bitcoin/Dogecoin Wallets**, **Wireshark** and **Mumble** - Desktop applications which pass user supplied URLs to be opened by the operating system are frequently vulnerable to **code execution with user interaction** - Code execution can be achieved either when a URL pointing to a malicious executable (`.desktop`, `.jar`, `.exe`, ...) hosted on an internet accessible file share (`nfs`, `webdav`, `smb`, ...) is opened, or an additional vulnerability in the opened application’s URI handler is exploited - Vulnerabilities following this pattern have already been found in other software, with more expected to be revealed going forward</p><p>-  Markdown  -   - 我们发现并报告了在流行软件中的1单击代码执行漏洞，包括**电报**，** nextcloud **，** vlc **，** libre- / OpenOffice **，**比特币/ dogecoin钱包**，** wireshark **和** mumble **  - 通过操作系统打开的用户提供的URL的桌面应用程序经常容易受到用户交互的代码执行**  - 代码执行可以是当一个URL指向一个恶意可执行文件（`.desktop`，`.jar`，`.exe`，......）托管在互联网访问的文件共享（`nfs`，`webdav`，`smb`）上......）已打开，或者开放应用程序的URI处理程序中的额外漏洞是利用 - 此模式中已发现的漏洞已被发现在其他软件中，更预期将透露前进</p><p>  In this post, we show code execution vulnerabilities in numerous desktop applications, all with the same root cause: insufficient validation of user input that is later treated as a URL and opened with the help of the operating system. The required user interaction and exploitation strategy depends on the desktop environment and whether the application was hardened, for instance, with a URI-scheme allow/block list. As an example, here is what exploitation of this issue in Nextcloud (&lt; 3.1.3) on Xubuntu 20.04 looks like:</p><p>  在此帖子中，我们在许多桌面应用程序中显示了代码执行漏洞，所有这些都具有相同的根本原因：用户输入的验证不足，稍后将被视为URL并在操作系统的帮助下打开。所需的用户交互和开发策略取决于桌面环境，例如，使用URI方案允许/阻止列表是否已硬化。作为一个例子，这里是在xubuntu 20.04上的NextCloud（＆lt; 3.1.3）中对此问题的开发方式。</p><p>  After explaining the root cause, vulnerable patterns and oddities of different OS’s and desktop environments, we’ll explore how this vulnerability type can be exploited in various popular desktop applications.</p><p>  在解释不同OS和桌面环境的根本原因，易受攻击的模式和奇怪之后，我们将探讨如何在各种流行的桌面应用程序中利用此漏洞类型。</p><p>  - [Introduction](#introduction) - [Root cause: user-supplied URLs opened by the OS](#root-cause-user-supplied-urls-opened-by-the-os) - [Finding vulnerable features is straightforward](#finding-vulnerable-features-is-straightforward) - [Operating systems and desktop environments have different URL opening behaviors](#operating-systems-and-desktop-environments-have-different-url-opening-behaviors)     - [Windows 10 19042](#windows-10-19042)     - [Xubuntu 20.04](#xubuntu-2004-xfce)     - [Other Linux Operating Systems](#other-linux-operating-systems) + [Snap](#snap)     - [Mac (Catalina 10.15.6)](#mac-catalina-10156) - [Vulnerabilities](#vulnerabilities)     - [Nextcloud](#nextcloud)     - [Telegram](#telegram)     - [VLC](#vlc)     - [Open-/LibreOffice](#open-libreoffice)     - [Mumble](#mumble)     - [Bitcoin/Dogecoin Wallets](#bitcoindogecoin-wallets)     - [Wireshark](#wireshark)     - [Bonus-Vulnerability: WinSCP](#bonus-vulnerability-winscp) - [Systematic mitigation requires contributions from OS, Framework, and Application maintainers](#systematic-mitigation-requires-contributions-from-os-framework-and-application-maintainers) - [Conclusion](#conclusion)</p><p>   -  [简介]（＃介绍） -  [根原因：OS打开的用户提供的URL]（＃根本原因 - 用户提供的URL-On-Whe-OS） -  [查找易受攻击的功能是简单的] （＃查找易受攻击 - 特点 - 是直接的） -  [操作系统和桌面环境具有不同的URL开放行为]（＃操作系统 - 桌面 - 环境 - 具有不同的URL开放行为） -  [Windows 10 19042]（#windows-10-19042） -  [xubuntu 20.04]（＃xubuntu-2004-xfce） -  [其他Linux操作系统]（#topto-linux-moctions-systems）+ [snap]（＃snap） - [Mac（Catalina 10.15.6）]（#mac-catalina-10156） -  [漏洞]（＃漏洞） -  [nextcloud]（＃nextcloud） -  [电报]（＃telegram） -  [vlc]（#vlc） - [打开 -  / libreoffice]（＃开放式libreoffice） -  [mumble]（＃mumble） -  [比特币/ dogecoin钱包]（＃bitcoindogecoin-wallets） -  [wireshark]（＃wireshark） -  [bonus-blynerability：winscp]（ #boolus vultnerability-winscp） -  [系统缓解需要contri来自操作系统，框架和应用维护者的武器]（＃系统缓解 - 需要 - 从OS框架和应用程序维护者源） -  [结论]（＃结论）</p><p>  A common way to open files and links from a native desktop application is by passing a URI to the operating system to handle (e.g. to open the default mail application for a `mailto:` link).</p><p>  从本机桌面应用程序打开文件和链接的常用方法是通过将URI传递给操作系统来处理（例如，打开“邮件”的默认邮件申请：“链接”：“链接”。</p><p>  - Windows: `ShellExecute*` - Linux: `xdg-open` (detects desktop environment and calls `gio open`, `gvfs-open`, `gnome-open`, `mate-open`, `exo-open` or `enlightment_open`) - Mac: `NSWorkspace#openURL()`</p><p>   -  Windows：`shellexecute *` -  Linux：`xdg-open`（检测桌面环境和呼叫`gio打开'，`gvfs-open`，`gnome-open-open`，`mate-open`，`exo-open` `Enlightment_open`） -  Mac：`nsworkspace＃OpenURL（）`</p><p>  When a user-supplied URL is opened in this way without additional checks, this can lead to code execution:</p><p>  通过以这种方式打开用户提供的URL而无需额外检查，这可能导致代码执行： </p><p> - By exploiting OS behavior for specific URI schemes and file extensions - By exploiting vulnerabilities in 3rd party application URL handlers (e.g. [this vulnerability in the `steam://` protocol](http://revuln.com/files/ReVuln_Steam_Browser_Protocol_Insecurity.pdf))</p><p>- 通过利用特定URI方案和文件扩展的操作系统行为 - 通过利用第三方应用程序URL处理程序的漏洞（例如[STEAV中的此漏洞：///`协议）（http://revuln.com/files/revuln_steam_browser_protocol_Insecurity。 PDF））</p><p> Browsers are aware of the potential security implications and disable `file://`-links as one of the most dangerous URI schemes, as well as at least showing a popup before navigating to other external URLs.</p><p> 浏览器了解潜在的安全性含义和禁用`文件：//` -links作为最危险的URI方案之一，并且至少在导航到其他外部URL之前显示弹出窗口。</p><p> While these additional checks have been implemented over time by security-conscious browser developers, they are missing in many other applications.</p><p> 虽然这些额外的检查已经通过安全意识的浏览器开发人员随着时间的推移来实现，但是在许多其他应用程序中缺少它们。</p><p>  For any given software, check all features where user-supplied values are opened as URLs (e.g. hyperlinks). If the feature, under the hood, uses the OS to handle the opening and allows arbitrary schemes without comprehensive warning messages, there is likely a way to exploit the feature on certain platforms.</p><p>  对于任何给定软件，请检查所有功能，其中用户提供的值被打开为URL（例如超链接）。如果该功能在引擎盖下使用操作系统以处理开口并允许任意方案而无需全面的警告消息，可能有一种方法可以利用某些平台上的功能。</p><p> We found that QT’s `QDesktopServices::openUrl()` function fulfills the first condition and checked popular QT-based open source software for instances where the function is called with insufficiently validated user input. Tools such as [searchcode allow to easily expand a search across millions of indexed open source projects](https://searchcode.com/?q=QDesktopServices%3A%3AopenUrl).</p><p> 我们发现Qt的`Qdesktopservices :: OpenURL（）`功能满足第一个条件，并检查了使用验证的用户输入不充分的函数的函数的流行Qt的开源软件。诸如[SearchCode的工具允许轻松扩展跨越数百万索引开源项目的搜索]（https://searchcode.com/?q=qdesktopservices%3a%3aopenurl）。</p><p> Please note that this behavior and issue is not unique to QT. As another example, Electron’s `shell.openExternal()` [has the same behavior](https://benjamin-altpeter.de/shell-openexternal-dangers/), which lead e.g. to an [RCE in the Wire Messenger](https://github.com/wireapp/wire-desktop/security/advisories/GHSA-5gpx-9976-ggpm).</p><p> 请注意，此行为和问题并不是Qt唯一的。作为另一个例子，电子的`shell.openexternal（）`[具有相同的行为]（https://benjamin-altpeter.de/shell-openexternal-dangers/），这引领了例如到了Wire Messenger中的[RCE]（https://github.com/wireapp/wire-desktop/security/advisities/ghsa-5gpx -9976-ggpm）。</p><p>  From our point of view, the ideal URL opening behavior for an OS includes the following characteristics:</p><p>  从我们的角度来看，OS的理想URL打开行为包括以下特征： </p><p> - **Does not automatically mount** previously unmounted file shares without a comprehensive user warning as simply mounting an `smb` share can cause credential leakage - **Displays a comprehensive user warning** before opening an executable or risky (i.e. `.docm`) file from a remote file share</p><p>-  **未自动安装**未在没有全面的用户警告的情况下寄出的文件共享，因为只需安装“SMB”份额可能导致凭据泄漏 -  **在打开可执行或危险之前显示全面的用户警告**（即`。来自远程文件共享的DOCM`）文件</p><p> The remainder of this section contains a detailed write-up of deviations from this behavior we have observed in different operating systems. If you are not interested in those specifics, you can [skip ahead to the vulnerabilities section](#vulnerabilities) where we demo the different vulnerable desktop applications.</p><p> 本节的其余部分包含我们在不同操作系统中观察到的这种行为的详细陈述。如果您对这些细节不感兴趣，您可以[跳过漏洞部分]（＃漏洞）我们演示不同的易受攻击桌面应用程序。</p><p>  * Executable `.jar` files do not trigger a warning when they are located on a mounted file share (standard JRE installation required) * UNC paths for all compatible file share protocols cause automatic mounting without a warning:     * `smb`: `\\&lt;hostname&gt;\&lt;filename&gt;`&lt;/filename&gt;&lt;/hostname&gt;     * `webdav`: `\\&lt;hostname&gt;\DavWWWRoot\&lt;filename&gt;`&lt;/filename&gt;&lt;/hostname&gt;     * `webdavs`: `\\&lt;hostname&gt;@SSL\DavWWWRoot\&lt;filename&gt;`&lt;/filename&gt;&lt;/hostname&gt; * Many applications convert file URLs to UNC paths: `file://&lt;hostname&gt;/DavWWWRoot/&lt;filename&gt;` becomes `\\hostname\DavWWWRoot\&lt;filename&gt;`, allowing one to bypass client-side checks&lt;/filename&gt;&lt;/filename&gt;&lt;/hostname&gt; * When the UNC path points to a file in the root folder of the share, mounting and opening the file is done with a single URL open/click (otherwise, taking two clicks to first mount and then open)</p><p>  *可执行的`.jar`文件不会触发当它们位于安装的文件共享时（所需标准JRE安装）*所有兼容文件共享协议的UNC路径导致自动安装，没有警告：*`SMB`：`\ \＆lt; hostname＆gt; \＆lt; filename＆gt;`＆lt; / filename＆gt;＆lt; / hostname＆gt; *`webdav`：`\\＆lt; hostname＆gt; \ davwwwroot \＆lt; filename＆gt;`＆lt; / filename＆gt;＆lt; / hostname＆gt; *`webdavs`：`\\＆lt; hostname＆gt; @ssl \ davwwwroot \＆lt; filename＆gt;`＆lt; / filename＆gt;＆lt; / hostname＆gt; *许多应用程序将文件URL转换为UNC路径：`file：//＆lt; hostname＆gt; / davwwwroot /＆lt; fileename＆gt;`变为`\\ hostname \ davwwwroot \＆lt; filename＆gt;`，允许一个绕过客户端检查＆lt; / filename＆gt;＆lt; / filename＆gt;＆lt; / hostname＆gt; *当UNC路径指向共享的根文件夹中的文件时，使用单个URL打开/单击完成文件时（否则，请单击“第一次安装”然后打开）</p><p>  - Executing a `.desktop` file (and therefore running the specified command) does not trigger a warning when it’s located on a mounted file share and the file has the executable bit set - `nfs` URLs cause automatic mounting without a warning/notification and allow for mounting and execution via a single URL open action - `dav` and `davs` URLs pointing to the root folder of an unmounted share cause automatic mounting. If the server is modified to return a `collection` element in the response to the first PROPFIND request to `/file`, automatic mounting is also done for URLs pointing to specific files on the share - `dav`, `davs`, `ftp`, `ftps` URLs cause automatic mounting without a warning. When the mounting is initiated by a URL pointing to an executable file, a warning message about the unknown origin of that file is shown after mounting. However, even if the execution is canceled by the user, when the same URL is opened again, with the share now already being mounted, the file is executed and no further warning is displayed - `smb` URLs initiate a mounting process which shows a connect dialog (not a security warning) that can be confirmed with one click on the pre-selected confirm button - `sftp` URLs initiate a mounting process which shows the host key confirmation dialog on first connect</p><p>   - 执行`.desktop`文件（因此运行指定的命令）在安装文件共享时不会触发警告，并且该文件具有可执行位设置 - “NFS”URL导致自动安装，而无需警告/通知并允许通过单个URL打开动作安装和执行 - “DAV”和“DAVS”URL指向未安装的共享的根文件夹导致自动安装。如果经过修改服务器以返回到对“/文件”的第一个Propfind请求的响应中的“集合”元素，还可以为指向共享上的特定文件的URL进行自动安装 - “DAV”，“DAVS”，“ FTP`，`ftps`ulls导致自动安装，没有警告。当安装由指向可执行文件的URL启动时，在安装后显示了关于该文件的未知原点的警告消息。但是，即使用户被用户取消了执行，当再次打开相同的URL时，使用现在已经安装了相同的URL，则执行该文件，并未显示进一步的警告 - “SMB”URL启动示出一个安装过程连接对话框（不是安全警告）可以用一点击选定的确认按钮 - “sftp`ulls启动一个安装过程，该过程在第一次连接时显示主机键确认对话框</p><p>  The exact opening behavior is dependent on the desktop environment and configuration. After quick review, xfce seems to have the most exploitable features:</p><p>  确切的打开行为取决于桌面环境和配置。快速评论后，XFCE似乎具有最具可利用的功能：</p><p> - **Auto-mounting:** In Kubuntu/KDE (`kde-open5`), remote files are auto-opened but the remote share is not permanently mounted. When a remote file is opened, it is downloaded and then opened/executed with the default program (but executable-flags are not retained during this download). Ubuntu/GNOME (gio open) does not auto-mount remote shares (“The specified location is not mounted”), however the contents of already mounted shares can be referenced as local files (`file:///var/run/user/&lt;id&gt;/gvfs/...`) - **File types:** .desktop files are often not parsed/executed, but rather opened in a text editor. Since this was unexpected to many, and meant that there was no on-board way to launch .desktop files from the command line, a bug was filed in 2009 [https://bugs.launchpad.net/ubuntu/+source/glib2.0/+bug/378783](https://bugs.launchpad.net/ubuntu/+source/glib2.0/+bug/378783) and many similar discussions can be found on the Internet. In December 2020, the bug was closed with the introduction of a new separate `gio launch` command. Users that have implemented workarounds, for example, [by associating `.desktop` files with `dex`](https://github.com/jceb/dex) are likely still vulnerable.</p><p>  -  **自动安装：**在Kubuntu / KDE（`KDE-OPEN5`），远程文件是自动打开的，但远程份额未永久安装。打开远程文件时，会下载它，然后用默认程序打开/执行（但在此下载期间不会保留可执行标志）。 Ubuntu / Gnome（GIO打开）没有自动安装远程共享（“指定的位置未安装”），但已安装的股份的内容可称为本地文件（`文件：/// var /运行/用户/＆lt; id＆gt; / gvfs / ...`） -  **文件类型：** .desktop文件通常不会解析/执行，而是在文本编辑器中打开。由于这对许多人来说意外，并且意味着没有从命令行启动的载载方法。2009年提交了一个错误[https://bugs.launchpad.net/ubuntu/+source/glib2 .0 / +错误/ 378783]（https://bugs.launchpad.net/ubuntu/+source/glib2.0/ addbug/378783）和许多类似的讨论可以在互联网上找到。在2020年12月，通过引入新的单独的`GIO Maillow`命令关闭该错误。例如，已经实现了解决方法的用户，[通过将“.desktop`文件与`dex`”相关联（https://github.com/jceb/dex）可能仍然易受攻击。</p><p>  Snap apps are subject to an additional URI scheme allowlist. Initially, this list only contained `http`, `https`, `mailto` and `snap`, which broke a lot of applications including Google Chrome. Recently [more URI schemes were added](https://github.com/snapcore/snapd/blob/30ef6dd52df387d359afdcd15f96210e6e0a1d71/usersession/userd/launcher.go#L56-L118).</p><p>  捕捉应用程序受其他URI方案允许列表。最初，此列表仅包含“http`，`https`，`mailto`和`snap`，这打破了很多应用程序，包括Google Chrome。最近添加了更多URI方案]（https://github.com/snapcore/snapd/blob/30ef6dd52df387d359afdcd15f96210e6e0a1d71/usersession/userd/launcher.go#l56-l118）。 </p><p> The snap team has the explicit goal to harden `xdg-open` calls using the following criteria: - The scheme is understood and documented in the code - The scheme itself does not cause `xdg-open` to open files (e.g. `file://`) - It is verified that the recipient of the url (ie, the callee of `xdg-open`) won&#39;t process file paths or other arguments in a way that can be leveraged to break out of the sandbox (requires understanding how the url can drive the recipient application)</p><p>Snap Team使用以下条件来解决“XDG-Open”呼叫的明确目标： - 该方案被理解并记录在代码中 - 方案本身不会导致“XDG-Open”（例如）打开文件（例如`文件： //`） - 验证了URL的收件人（即“XDG-Open`的Callee”）赢得了＆＃39; T处理文件路径或其他参数，以便可以利用突破沙箱（需要了解URL如何驱动收件人应用程序）</p><p> From a security perspective, this much appreciated. However, the initial usability decrease was high which probably drove users to overall less constrained .deb packages. Even though more URI schemes were added, many use cases are still broken. As a rather mundane example, we found that `ftp://`-links are opened (safely in the browser) from the “normal” Telegram desktop app, but nothing happens in the snap version (“user-open error: supplied URL scheme “ftp” is not allowed&#34;)</p><p> 从安全角度来看，这很值得赞赏。但是，初始可用性降低很高，这可能使用户推向整体限制的.deb包。尽管添加了更多的URI方案，但许多用例仍然被破坏。作为一个相当平凡的示例，我们发现“FTP：//` -Links从”普通“电报桌面应用程序（浏览器中安全地）打开（安全地在浏览器中），但在Snap版本中没有任何内容（”用户打开错误：提供的URL计划“FTP”不允许＆＃34;）</p><p>  - `smb` URLs open a connect dialog. Confirming the the connection will mount the share and open a Finder (file explorer) view - `smb` URLs to specific files on shares are interpreted as URLs to a share’s root folder. They trigger another connect dialog even if the real root folder has been mounted already. Confirming that connection adds an additional entry with the name of the referenced file to `/Volumes` - Files on already mounted shares can be referenced via `file` URLs pointing to `/Volumes/&lt;share_name&gt;/&lt;file_name&gt;`&lt;/file_name&gt;&lt;/share_name&gt; - `file` URLs to specific files open the file with the associated application only for some file types like `.txt`, and only if the file has been opened manually before (for example by double-clicking in the Finder) - In all other tested cases, `file` URLs pointing to specific files open up the Finder for the containing folder rather than opening the file</p><p>   - “SMB”“URL”打开“连接”对话框。确认连接将安装共享并打开Finder（文件资源管理器）视图 - “SMB”（File Explorer）视图 - “Shares上的特定文件的URL被解释为Share的根文件夹的URL。即使已安装了真实的根文件夹，它们也会触发另一个连接对话框。确认连接添加了附加条目，其中包含引用的文件的名称到“/卷” - 可以通过指向“/卷/＆lt; share_name＆gt; /＆lt; file_name＆gt;`＆lt;` ; / file_name＆gt;＆lt; / share_name＆gt; - 对于特定文件的“文件”URL，仅对某些文件类型打开文件，仅为某些文件类型，如“.txt`”，才能在手动打开之前（例如，通过双击Finder） - 总而言之其他测试的案例，`file`网址指向特定文件打开包含文件夹的查找器而不是打开文件</p><p> **Please note:** Besides these different combinations of file share URI schemes and extensions, many more dangers can be introduced with custom URL scheme handlers, independent of the OS. In this blog post, we disclose one such RCE in a 3rd party application that allows for arbitrary code execution without additional user interaction. In an upcoming blog post, we’ll explore a similar vulnerability in a Windows 10 default URI handler.</p><p> **请注意：**除了这些文件共享URI方案和扩展的这些不同组合外，还可以使用自定义URL方案处理程序引入更多危险，而独立于操作系统。在此博客文章中，我们在第三方应用程序中披露了一个这样的RCE，其允许任意代码执行而无需额外的用户交互。在即将介绍的博客文章中，我们将探讨Windows 10默认URI处理程序中的类似漏洞。</p><p>    The Nextcloud Desktop client uses `QDesktopServices::openUrl` in various places, however, the most interesting case is when the user connects to a Nextcloud server. In this case, the server’s login page is loaded in a WebView. QT&#39;s default behavior is that a click on a link in a WebView does not directly call the OS&#39; handler, so it’s safe against our attack. However, the Nextcloud code was specifically [intercepting those requests and passing them to `QDesktopServices::openUrl` by overwriting `acceptNavigationRequest()`](https://github.com/nextcloud/desktop/blob/4b985ab3b322d18773c76e1d1afd6cbad3cdbba2/src/gui/wizard/webview.cpp#L226-L232).</p><p>    NextCloud Desktop Client在各个地方使用`qdesktopservices :: OpenURL`，但是，最有趣的情况是当用户连接到NextCloud服务器时。在这种情况下，服务器的登录页面已加载到WebView中。 Qt＆＃39;默认行为是，在WebView中的单击链接不会直接调用OS＆＃39;处理程序，所以这是安全的攻击。但是，NextCloud代码专门[拦截那些请求并将它们传递给`qdesktopservices :: OpenURL`向导/ webview.cpp＃l226-l232）。</p><p>  -- CODE language-js -- bool ExternalWebEnginePage::acceptNavigationRequest(const QUrl &amp;url, QWebEnginePage::NavigationType type, bool isMainFrame) {          Q_UNUSED(type);          Q_UNUSED(isMainFrame);          QDesktopServices::openUrl(url);          return false; }</p><p>   - 代码语言-JS  -  Bool ExternalWebenginePage :: AcceptNavigationRequest（Const QURL＆amp; URL，qwebenginePage :: NavigationType类型，Bool IsmainFrame）{q_unused（类型）; Q_Unused（ISMainFrame）; qdesktopservices :: OpenURL（URL）;返回false; }</p><p>  Without any filtering on the URI scheme, this gives many possibilities and allows for smooth exploitation without additional confirmation as shown in the video in the Introduction section. The following two videos show an alternative exploit strategy for Xubuntu (using `sftp://`) and exploitation on Windows in combination with a vulnerable URI handler:</p><p>  如果没有对URI方案进行任何过滤，这会产生许多可能性，并且可以在没有额外确认的情况下平滑开发，如图中的视频中的视频中所示。以下两个视频显示了xubuntu（使用`sftp：//`）和窗口中的剥削与漏洞的URI处理程序的开发方式： </p><p>  The issue has been fixed by the Nextcloud team by replacing `QDesktopServices::openUrl` with their utility function `Utility::openBrowser`, which implements an additional AllowList-check (`http`/`https`/`oauthtest`) before passing it to `QDesktopServices::openUrl`.</p><p>NextCloud团队通过替换“Qdesktopservices :: OpenURL”（IndowUll`）与其实用程序函数`: OpenBrowser`实现该问题，该oppmbrows`它到`qdesktopservices :: Openurl`。</p><p> **CVE:** CVE-2021-22879 **Patch:** [Validate sensitive URLs to only allow http(s) schemes](https://github.com/nextcloud/desktop/pull/2906) **HackerOne report:** [Nextcloud Desktop Client RCE via malicious URI schemes](https://hackerone.com/reports/1078002) **Security Advisory:** [https://nextcloud.com/security/advisory/?id=NC-SA-2021-008](https://nextcloud.com/security/advisory/?id=NC-SA-2021-008)</p><p> ** cve：** cve-2021-22879 ** patch：** [验证敏感网址只允许http（s）方案]（https://github.com/nextcloud/desktop/pull/2906）** hackerone报告：**通过恶意URI方案的[NextCloud Desktop客户端RCE]（https://hackerone.com/reports/1078002）**安全咨询：** [https://nextcloud.com/security/advisory/?id= nc-sa-2021-008]（https://nextcloud.com/security/advisory/?id=nc-sa-2021-008）</p><p>  The Telegram Desktop Application for Windows/Linux/Mac OS seemed like an interesting target because it’s based on Qt and passes links directly to `QDesktopServices::openUrl`.</p><p>  Windows / Linux / Mac OS的电报桌面应用程序似乎是一个有趣的目标，因为它是基于Qt，并通过链接直接传递给`qdesktopservices :: OpenURL`。</p><p> While Telegram optionally supports End-to-End-encrypted chats, the Desktop Application only supports non-E2E-encrypted chats. In this case, Telegram makes use of their ability to filter the sent URLs.</p><p> 虽然电报可选地支持端到端加密的聊天，但桌面应用程序仅支持非E2E加密的聊天。在这种情况下，电报利用它们过滤发送的URL的能力。</p><p> The Telegram API defines specific `MessageEntity`s ([https://core.telegram.org/type/MessageEntity](https://core.telegram.org/type/MessageEntity)), that have an `offset`, a `length` and optional additional parameters. The MessageEntities related to URLs are [messageEntityUrl](https://core.telegram.org/constructor/messageEntityUrl) and [messageEntityTextUrl](https://core.telegram.org/constructor/messageEntityTextUrl).</p><p> 电报API定义了特定的`MearryEntity`s（[https://core.telegram.org/type/messageentity]（htpps://core.telegram.org/type/messageentity）），具有“偏移”，a `length`和可选的附加参数。与URL相关的消息是[MESSAMENTITYURL]（https://core.telegram.org/constructor/messageentityURL）和[MESSAMENTITYTEXTURL]（https://core.telegram.org/constructor/messageentitytexturl）。</p><p> With `messageEntityTextUrl`, any text can point to any URL (offset and length define which part of the message to underline while the `url` parameter defines the destination). In this case, the backend performs strict checks on the URL and in many cases returns a “400 - Unsupported url protocol”. We found that for `messageEntityUrl` items (which have no URL field, so the underlined text is also the link destination), a slightly more relaxed filter list is used that allows the `sftp://` URI scheme. On Xubuntu, this can be exploited by linking to an executable .desktop file via `sftp://` (including the username and with an empty password set on the server for minimal interaction):</p><p> 使用“mearaerentitytexturel`”，任何文本都可以指向任何URL（偏移量和长度定义要在`URL`参数定义目标时下划线的消息的哪个部分。在这种情况下，后端对URL执行严格检查，并且在许多情况下返回“400  - 不支持的URL协议”。我们发现，对于`messageentityurl`项目（没有URL字段，因此带下划线的文本也是链接目的地），使用稍微放松的过滤列表，允许`sftp：//`ul方案。在xubuntu上，这可以通过链接到可执行的.desktop文件通过`sftp：//`（包括用户名和服务器上的空密码为最小交互设置）来利用，以便利用。</p><p>  In a default Windows installation, there are no applications installed for handling `sftp://` links. However, our testing machine had WinSCP installed which by default registers itself as `sftp://` URI handler. [Having been downloaded 150 million times](https://winscp.net/eng/index.php), WinSCP is popular and almost without competition as `sftp`/`scp` client for Windows, so we had a quick look to see what’s possible. Check out [Bonus-Vulnerability: WinSCP](#bonus-vulnerability-winscp) below to see the code execution on Windows (with WinSCP installed).</p><p>  在默认的Windows安装中，没有安装用于处理`sftp：//`链接的应用程序。但是，我们的测试机器安装了WinSCP，默认寄存器本身是“SFTP：//”URI处理程序“。 [已下载1.5亿次]（https://winscp.net/eng/index.php），Winscp是流行的，几乎没有竞争为Windows的“SFTP”/“SCP”客户端，所以我们快速了解看看有可能。签出[奖励 - 漏洞：winscp]（#bonus-plastability-winscp）下面，以查看Windows上的代码执行（使用WinSCP安装）。 </p><p> Interestingly, we could trace back the different treatment of `sftp://` to [a Github issue from 2015](https://github.com/telegramdesktop/tdesktop/issues/1201), where a user observed and reported a seemingly surprising behavior, and the URI scheme was added without an actual use case.</p><p>有趣的是，我们可以追溯到从2015年的“SFTP：//`”的不同治疗方法（HTTPS://github.com/telegramdesktop/tdesktop/issues/1201），其中用户观察并报告了一个看似的人令人惊讶的行为，而没有实际用例，增加了URI方案。</p><p>  The issue was reported to Telegram on January 11th, and after several follow-ups, closed via a server-side change on (or slightly before) February 10th.</p><p>  该问题于1月11日报告给电报，经过几次随访，通过服务器方面的改变（或以前）2月10日关闭。</p><p>  In the case of VLC, it might not be so obvious that the exploited functionality is opening a URL under the hood. The vulnerable feature is the “Show Containing Folder...” action in the context menu of a playlist item.</p><p>  在VLC的情况下，它可能不那么明显，利用功能在引擎盖下打开一个URL。该易受攻击的功能是播放列表项的上下文菜单中的“包含文件夹...”操作。</p><p> When clicking the item, the path of the containing directory is fetched and opened by `QDesktopServices::openUrl`. By adding an additional `/` or `/doesnotexist.mp4` to a playlist entry’s URL, “Show Containing Folder...” can be diverted to open files with the associated default application.</p><p> 单击该项目时，包含的目录的路径被获取并由`qdesktopservices :: OpenURL`打开。通过添加额外的`/`或`/ dootnotexist.mp4`到播放列表条目的URL，“包含文件夹...”可以将“显示文件夹”归功于使用关联的默认应用程序打开文件。</p><p>  - `vlc_uri2path`: This VLC function contains [code that looks like it was intended to filter out UNC paths](https://code.videolan.org/videolan/vlc/-/blob/2090c051abb8d3b15fd1824c394897eedda63c7f/src/text/url.c#L291), but the relevant code seems to be unreachable and the function executes succesfully for UNC paths - [`FromLocalFile`](https://doc.qt.io/qt-5/qurl.html#fromLocalFile): Returns a QUrl representation of a &#34;local file&#34; string, but maybe suprisingly also support remote files (&#34;This function also accepts paths with a doubled leading slash (or backslash) to indicate a remote file, as in `//servername/path/to/file.txt`&#34;) - [`isLocalFile`](https://doc.qt.io/qt-5/qurl.html#isLocalFile): Returns `true` for any URI starting with `file:` (&#34;Note that this function considers URLs with hostnames to be local file paths&#34;)</p><p>   - `vlc_uri2path C＃L291），但是相关代码似乎无法访问，并且函数为UNC路径成功执行 -  [来自从小核文件，https://doc.qt.io/qt-5/qurl.html#fromlocalfile）：返回A＆＃34的古怪表示;本地文件＆＃34;字符串，但也许假定也支持远程文件（＆＃34;此函数也接受具有一倍的前导斜杠（或反斜杠）的路径，以指示远程文件，如`//servername/path/to/file.txt`w ＃34;） -  [`islocalfile`]（https://doc.qt.io/qt-5/qurl.html#islocalfile）：返回与`文件开始的任何URI的`true`：`（＆＃34;请注意，此函数将具有主机名的URL为本地文件路径＆＃34;）</p><p> As all of those functions allow remote `file://`-paths, this can be exploited on Windows using a malicious playlist file containing a file URL or UNC path pointing to a .jar file on a WebDav share:</p><p> 由于所有这些函数允许远程`文件：//` -paths，这可以使用包含文件URL或UNC路径指向的WebDAV共享中的文件URL或UNC路径的恶意播放列表文件在Windows上进行利用。</p><p>  Exploitation on Linux is heavily restricted due to the URI scheme limitation. As no remote files can be referenced to force an auto-mount, only already-mounted remote shares (e.g.  where the playlist resides) can be referenced using the special `/run/user` directory (e.g. `file:///run/user/1000/gvfs/sftp:host=&lt;host&gt;,user=&lt;user&gt;`)</p><p>  由于URI方案限制，对Linux的开发严重限制。由于没有引用远程文件以强制自动安装，只能使用特殊的`/运行/用户`目录引用已安装的远程共享（例如，播放列表所在的位置）（例如，“文件：///运行/运行/用户/ 1000 / gvfs / sftp：host =＆lt; host＆gt;，用户=＆lt; user＆gt;`） </p><p> The issue was mitigated by adding a check to ensure that the opened URI is a directory, preventing the RCE. `vlc_uri2path` was not changed. So although the function may appear to have the goal of disallowing remote files, UNC files can still be specified (leading to an NTLM hash leak or potentially other unexpected behavior when `vlc_uri2path` is used).</p><p>通过添加检查来缓解该问题，以确保打开的URI是目录，防止RCE。 `vlc_uri2path`没有改变。因此，尽管函数可能似乎具有禁止远程文件的目标，但仍然可以指定UNC文件（导致使用NTLM哈希泄漏或潜在的其他意外行为，或者在使用`VLC_URI2PATH`时）。</p><p> We reported the vulnerability to VLC on January 18th, together with 3 patch candidates. One candidate was merged on Feb 08th and the patched version 3.0.13 will presumably be released next week.</p><p> 我们向1月18日向VLC报告了漏洞，以及3个补丁候选人。一名候选人于2月8日合并，修补版3.0.13将可能会在下周发布。</p><p>   OpenOffice and LibreOffice allow for Hyperlinks to be embedded in various types of documents, including macro-disabled file types which are frequently shared among untrusted parties. Hyperlinks can be CTRL-clicked, sending them on to a call to `ShellExecute` on Windows, or `xdg-open` on Linux. One-click exploits are shown for OpenOffice on Windows and Xubuntu, as well as LibreOffice on Xubuntu:</p><p>   OpenOffice和LibreOffice允许嵌入各种类型的文档中的超链接，包括常常在不受信任的方面共享的宏禁用文件类型。超链接可以点击Ctrl键，将它们发送到Windows上的“Shellexecute”或“Linux上的”XDG-Open“或”XDG-Open“呼叫。一键式漏洞显示在Windows和Xubuntu上的OpenOffice，以及Xubuntu的LibreOffice：</p><p>  In the Windows version of LibreOffice, a [file extension blacklist](https://github.com/LibreOffice/core/blob/5e4c771c0b89452ab55d1ab30dbb1634f15d3775/shell/source/win32/SysShExec.cxx#L340) aimed at protecting against this type of attack was implemented long before our research. However, we quickly found a way to bypass this blacklist, allowing for 2-click exploitation on Windows, showcasing the unreliability of such an approach.</p><p>  在Windows版libreoffice中，a [文件扩展名黑名单]（https://github.com/libreoffice/core/blob/5e4c771c0b89452ab55d1ab30dbbb1634f15d3775/shell/source/win32/sysshexec.cxx#l340）旨在保护这种类型的攻击在我们的研究之前已经很久了。但是，我们很快找到了一种绕过这个黑名单的方法，允许在Windows上单击剥削，展示这种方法的不可靠性。</p><p>  The office suites allow for files with pretty complex content and functionality and are sometimes used in contexts where niche features like `ftp` hyperlinks in documents are actually expected to work. Therefore, a fully restrictive fix would not be possible without a potentiall</p><p>  办公室套件允许具有相当复杂的内容和功能的文件，有时在实际上预期在“文件中的”FTP“特征（如”文件“中的内容）中的上下文中使用。因此，没有潜在的情况，不可能完全限制修复</p><p>......</p><p>...... </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://positive.security/blog/url-open-rce">https://positive.security/blog/url-open-rce</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/代码/">#代码</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/任意/">#任意</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/arbitrary/">#arbitrary</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/文件/">#文件</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>