<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我们如何通过卡夫卡网络优化每月节省10万美元</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">我们如何通过卡夫卡网络优化每月节省10万美元</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-31 04:36:38</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/e64be0afd9ef8b915167fa7761bde084.png"><img src="http://img2.diglog.com/img/2020/10/e64be0afd9ef8b915167fa7761bde084.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>在Segment，我们每天处理数百亿个事件。虽然这从业务角度来看是积极的，但也意味着我们的云提供商的账单需要持续监控和管理。作为一项基础设施密集型SaaS业务，成本很容易失控，因此我们必须非常小心云成本对毛利率的影响。</p><p>在过去的几个月里，在线活动的增加意味着流量的大幅增加。连锁反应是，我们开始注意到我们的网络传输成本(即云提供商对进出实例的数据收取的费用)的增长速度明显高于流量负载本身。</p><p>在深入研究之后，我们意识到很大一部分增长与我们的Kafka集群有关，我们使用这些集群通过我们的核心管道传递事件。我们决定应对挑战，在尊重我们的可用性、SLO和SLI的同时，大幅降低我们的Kafka平台的成本。</p><p>这篇文章将解释为什么Kafka网络在云环境下会如此昂贵，以及我们做了什么来解决这个问题。</p><p>在详细介绍我们所做的更改之前，让我们先讨论一下将消息(大致相当于Segment后端中的单个事件)添加到Kafka主题中的分区时发生的网络扇出。</p><p>首先，消息从生产者发送到写入消息的分区领导者。该领导者将该消息复制到分区中的跟随者(在Segment，我们在大多数主题中使用复制因子3，这意味着有2个跟随者)。最后，消息从领导者传递到从分区读取的每个消费者。</p><p>假设有3个副本和3个消费者，这意味着每条消息在网络上传输6次。</p><p>问题是，如果传输跨越云环境中的可用区(AZ)边界，它就不是免费的。</p><p>以下是可能出现的最坏情况，其中主节点与所有其他节点位于不同的区域：</p><p>在AWS的情况下，我们的大部分Kafka基础设施都运行在这里，数据传输成本可能很难计算出来(请参阅本指南以获得良好的摘要)。</p><p>在我们的Kafka集群中，同一VPC内的EC2实例之间的跨AZ流量不涉及其他AWS服务，因此标价为0.02美元/GB。</p><p>这看起来不像是一大笔钱。但是，当你每天转账多个TBS时，就会增加。它也比原始消息数量增加得更快，所以你的会计团队开始注意到这只是个时间问题。</p><p>在分析了数据并评估了不同策略的权衡之后，我们开始了几项平行的努力，以减少我们跨区域的Kafka网络流量。</p><p>在此项目之前，我们几乎所有主题分区的副本都分布在三个可用区中。这是为了确保最佳的服务可靠性，并保护自己免受全区停机的影响。</p><p>但是，如前所述，这意味着生成的每个消息都被复制到所有三个区域，从而导致大量代价高昂的跨区域数据传输。</p><p>在考虑了我们的管线的故障模式之后，我们意识到如果需要，我们的许多主题中的数据都可以从上游检查点重新创建。我们可以从我们的许多主题中删除跨区域复制，而不会影响我们渠道的整体可靠性。</p><p>基于这种洞察力，我们首先在管道的最前面设置了一组健壮的摄取主题。这些产品具有跨区域复制和较长的保留窗口(长达48小时)。</p><p>然后，我们浏览了每个下游主题，并使用topicctl将其转换为使用机架内复制放置。此拓扑仍使用相同数量的副本(在分段情况下为3个)，但这些副本位于同一区域的代理中，从而最大限度地减少了跨AZ流量。</p><p>对于我们最大的主题，迁移耗时长达6个小时(有大量数据要传输！)，但在迁移过程中，我们没有注意到集群中有任何重大的性能问题，这很棒。</p><p>我们的大多数Kafka消费者都是用Golang编写的，并使用建立在Kafka-Go之上的通用阅读器库。</p><p>在进行副本迁移的同时，我们的团队仔细检查了主数据管道中的所有消费者，并将他们切换到使用Kafka-Go的RackAffinityGroupBalancer功能的新阅读器库中。后者匹配使用者和分区，以便尽可能多的对位于同一区域中。</p><p>在此之后，我们消除了每个主题每封邮件另外1-5次跨区域传输(根据从该主题阅读的消费者组数量的不同而有所不同)。</p><p>虽然可以按区域将生产者与分区领导者相匹配，但每个经纪人或每个分区的负载很容易变得不平衡(特别是当领导者四处移动时)。如果生产者本身变得区域不平衡(例如，由于部署)，这也可能在没有仔细协调的情况下导致集群中的不平衡。</p><p>例外的是我们正在筹备的重复数据删除部分，在之前的一篇博客文章中讨论了这一点。这就是我们在生成器和分区之间使用静态1：1映射的语义分区的地方。在这里，因为生产者的基数和区域不变，我们可以安全地围绕每个分区的区域移动，以减少跨区域的生产流量。我们在topicctl中使用了最新的静态机架策略来实现这一点。</p><p>我们计划重新考虑这一方法，并将生产者优化添加到我们流水线的更多组件中。Kafka-Go的路线图包括一个区域亲和性生产者的计划，所以在实现之后，我们可以在我们的代码中使用它。</p><p>随着2.1.0版本的发布，Kafka引入了对新的压缩编解码器Tzstd的支持。我们在生产流量的影子版本上进行了一些测试，发现zstd比我们之前的默认版本snappy节省了40%的空间，而没有显著降低管道性能(即，由于潜在的更高的压缩和解压缩开销)。</p><p>不幸的是，我们的大多数主题都在运行较旧卡夫卡版本的集群中。但是，我们可以切换到zstd来获取管道最前面的&#34；摄取&#34；主题，因为这些主题托管在一个新的集群中。我们为这些主题保留了跨区域复制，因此通过使用zstd，我们能够显著降低与这些主题相关的网络成本。</p><p>未来，我们希望在将集群升级到更新的Kafka版本时，将更多的主题迁移到zstd。</p><p>通过上述努力，我们逐渐将一些关键主题的拓扑从如下内容过渡：</p><p>随着我们取得进展，我们开始看到我们每天的EC2数据传输成本下降。当我们完成所有大型主题的工作时，我们已经减少了超过10万美元/月的成本，或120万美元/年。考虑到所需的工作量(大约2名工程师需要2个月)，这项工作非常划算！</p><p>除了为Segment节省了一大笔钱，这个项目还带来了新的工具(包括topicctl)，为我们的Kafka集群带来了新的Runbook，并对我们的主题和集群进行了全面的清理。</p><p>如果您在云环境中运营，请重新查看您的账单的转账成本，并计算跨区域Kafka网络的百分比。如果这不是一笔微不足道的数目，你也许可以通过尝试上面描述的一些策略来节省一大笔钱。</p><p>装满了市场趋势、分析和洞察力，这些都是我们从与数千名客户的交谈中总结出来的。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://segment.com/blog/kafka-optimization">https://segment.com/blog/kafka-optimization</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/网络/">#网络</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/kafka/">#kafka</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1031717.html"><img src="http://img2.diglog.com/img/2020/10/thumb_b5d0f1167a86fdbbb8945644fc4c54f6.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031717.html">网络浏览器什么时候才能完成？</a></div><span class="my_story_list_date">2020-10-28 15:9</span></div><div class="col-sm"><div><a target="_blank" href="/story/1031484.html"><img src="http://img2.diglog.com/img/2020/10/thumb_2ab563fd8391606c6a3761e5727d86f0.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031484.html">
光年获得370万美元种子，将网络基础设施采购数字化</a></div><span class="my_story_list_date">2020-10-27 22:1</span></div><div class="col-sm"><div><a target="_blank" href="/story/1030101.html"><img src="http://img2.diglog.com/img/2020/10/thumb_c13b3f1099d36de5e19f251181f82cea.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1030101.html">
Beam正在构建一个从您的Web活动中收集知识的Web浏览器</a></div><span class="my_story_list_date">2020-10-21 0:12</span></div><div class="col-sm"><div><a target="_blank" href="/story/1029848.html"><img src="http://img2.diglog.com/img/2020/10/thumb_83ca3f00b5bb7b1551b3cd5dde085c7d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1029848.html">Juniper宣布有意以4.5亿美元收购128 Technology，以在Juniper的网络产品中提升基于人工智能的功能</a></div><span class="my_story_list_date">2020-10-20 0:52</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>