<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>传递用于构建 Docker 镜像的安全信息</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">传递用于构建 Docker 镜像的安全信息</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-08-08 19:52:32</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/8/c1edfab45795f1bcfc233ed37254796b.png"><img src="http://img2.diglog.com/img/2021/8/c1edfab45795f1bcfc233ed37254796b.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>非常感谢从 Docker 映像中访问 Nexus 或 GitHub 存储库等私有资源，并且不泄露任何与安全相关的信息。首先，我们绝不会直接在 Dockerfile 中包含凭据或任何其他安全信息。其次，可以创建多阶段¹构建并从任何私人信息中清除最终图像和图层。然而，这不是一个简单的解决方案，在很大程度上取决于谁在开发。最后，我们中的一些人可以依靠使用参数——ARG——并在 docker build² 命令中传递信息。然而，仅此而已，图像层中的秘密信息可用。接下来我将展示一个例子。从 ubuntu ARG USERNAME ARG PASSWORD RUN apt-get update &amp;&amp; \ apt-get upgrade &amp;&amp; \ apt-get install -y curl RUN curl -o nginx_policy.yaml -u $USERNAME:$PASSWORD http://nexus:8081/repository/ raw/policy/nginx-policy.yaml docker build -t secret:args --build-arg USERNAME=$user --build-arg PASSWORD=$pass 。将构建上下文发送到 Docker 守护进程 3.072kB 步骤 1/5：从 ubuntu ---&gt; c29284518f49 步骤 2/5：ARG 用户名 ---&gt; 使用缓存 ---&gt; 720c9732f5db 步骤 3/5：ARG 密码 ---&gt; 使用缓存 ---&gt; 193f8044461b 第 4/5 步：运行 apt-get update &amp;&amp; apt-get upgrade &amp;&amp; apt-get install -y curl ---&gt; 使用缓存 ---&gt; 894b791e5ec3 第 5/5 步：运行 curl -o nginx_policy .yaml -u $USERNAME:$PASSWORD http://172.17.0.2:8081/repository/raw/policy/nginx-policy.yaml ---&gt; Using cache ---&gt; e4050d5c1743 成功构建 e4050d5c1743 成功标记 secret:args I在 build-arg 选项中使用环境变量来不存储凭据操作系统历史记录。此外，在图像中，我没有将这些信息保存在任何地方。</p><p>当您针对此图像运行 docker history 命令时，会出现这种方法的问题： ➜ docker history secret:args_env IMAGE CREATED CREATED BY SIZE COMMENT f11cb0b139f3 2 分钟前 |2 PASSWORD=admin123 USERNAME=admin /bin/sh ... 0B 6ca5f3fc074a |2 PASSWORD=admin123 USERNAME=admin /bin/sh … 0B 193f8044461b 43 分钟前 /bin/sh -c #(nop) ARG 密码 0B 720c9732f5db 43 分钟前 /bin/sh -c #(nop) ARG USERNAME284f51b几天前 /bin/sh -c #(nop) CMD [&quot;bash&quot;] 0B &lt;missing&gt; 3 天前 /bin/sh -c #(nop) ADD file:5c3d9d2597e01d1ce... 72.8MB 显然，我们可以看到凭据存储在图像的元数据中。尽管我们尽了最大的努力，我们仍然在泄露机密信息。 Buildkit³ 与 Docker 精确集成⁴，以帮助我们保持安全。自 18.06 版本以来，Buildkit 出现在 Docker 中，目前仅支持 Linux 容器。要启用 Buildkit 构建，请在调用 docker build 命令时设置 DOCKER_BUILDKIT=1 环境变量，例如： docker build 的新 --secret 标志允许用户传递要在 Dockerfile 中使用的机密信息，以在一个不会最终存储在最终图像中的安全方式。要使用此功能，我们需要覆盖 Dockerfile 中的默认前端⁶。在 Dockerfile 的第一行输入： RUN 命令中添加了 --mount 标志，以允许构建容器访问安全文件，例如私钥，而无需将它们烘焙到映像中。</p><p>并且使用指定使用 BuildKit 前端 docker/dockerfile:1.2 的 Dockerfile，在执行 RUN 时可以访问机密：此 Dockerfile 仅用于证明可以访问机密。如您所见，构建输出中打印的秘密。最终构建的镜像将没有秘密文件： $ DOCKER_BUILDKIT=1 docker build --no-cache --progress=plain -t secret:buildkit --secret id=mysecret,src=mysecret.txt 。 5c65425f6fc0d6c65a5ddd6784812097b4eff778b9bcbf39bc708aacbad59abd＃1转移dockerfile：从Dockerfile＃1 SHA256＃1 [内部]负载生成定义196B完成＃1 DONE 0.0S＃2内部]负载.dockerignore＃2 SHA256：35c8e51716823a06d8dbd04a2594a31a90f3d02bb55a0b8c3e9f2c1b44f901c7＃2传送上下文：2B完成＃2 DONE对于docker.io/docker/dockerfile:1.2＃3 SHA256 0.0S＃3解析图像配置：b239a20f31d7f1e5744984df3d652780f1a82c37554dd73e1ad47c8eb05b0d69＃3 DONE 2.5S＃4搬运工图像：//docker.io/docker/dockerfile：1.2@sha256：e2a8561e419ab1ba6b2fe6cbdf49fd92b95912df1cf7d313c3e2230a333fdbcc＃4 SHA256：37e0c519b0431ef5446f4dd0a4588ba695f961e9b0e800cd8c7f5ba6165af727＃4决心docker.io/docker/dockerfile:1.2@sha256:e2a8561e419ab1ba6b2fe6cbdf49fd92b95912df1cf7d313c3e2230a333fdbcc完成＃4＃CACHED 5内部]负载元数据docker.io/library/alpine:latest＃5 SHA256：d4fb25f5b5c00defc20ce26f2efc4e288de8834ed5aa59dff877b495ba88fda6＃5 DONE 0.0S #6 [1/2] 来自 docker.io/library/alpine #6 SHA256：665ba8b2cdc0cb0200e2a42a6b3c0f8f684089f4cd1b81494fbb9805879120f7＃6＃CACHED 7 [2/2] RUN --mount =类型=秘密，ID = mysecret猫/运行/秘密/ mysecret＃7 SHA256：75601a522ebe80ada66dedd9dd86772ca932d30d7e1b11bba94c04aa55c237de＃7 0.494 SUPER_SECRET_PASSWORD＃7 DONE 0.5秒＃8导出到图像＃8 SHA256：e8c613e07b0b7ff33893b694f7759a10d42e180f2b4dc349fb57dc6b71dcab00＃8层导出0.0S做过＃8刻写的图像SHA256：8df0fe20ceab547858702c32456d962b99d66fd40ab29f4e191ac0b52e383039做过＃8 DONE 0.0S $搬运工历史秘密：buildkit的形象创造的创SIZE条评论7da5afe4875316秒前RUN / bin / sh的-c猫/run/secrets/mysecret # b... 0B buildkit.dockerfile.v0 &lt;missing&gt; 4 周前 /bin/sh -c #(nop) CMD [&quot;/bin/sh&quot;] 0B &lt;missing&gt; 4 周前 /bin/ sh -c #(nop) ADD file:f278386b0cef68136... 5.6MB 可以使用环境变量⁷来传递秘密信息，而不是使用秘密文件，例如：本文解释了使用受限信息所需的步骤在 Docker 容器中更安全。通过在“docker build”之前设置一个环境变量并在 Dockerfile 中进行一些更改，您可以防止用于配置 Docker 容器的凭据泄露。</p><p>Docker Buildkit 不仅支持秘密，还支持其他构建挂载⁸，例如缓存和 ssh。开始或继续探索 Buildkit 并了解它如何帮助您提高环境的安全性。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/docker/">#docker</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/用于/">#用于</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/secure/">#secure</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>