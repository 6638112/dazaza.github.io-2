<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>我得到了在OpenBSD上工作的GNU Modula-2编译器 I got the GNU Modula-2 compiler working on OpenBSD</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">I got the GNU Modula-2 compiler working on OpenBSD<br/>我得到了在OpenBSD上工作的GNU Modula-2编译器 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-04-04 12:16:11</div><div class="page_narrow text-break page_content"><p>When it rains it pours. After making a splash with  D,  1 I remembered that some time ago I began an attempt to bring the  GNU Modula-2 compiler to  OpenBSD. Because why not?  Modula-2 is a language that exists and has compiler implementations. I guess my goal is to bring all the languages and compilers to OpenBSD. And as always, there are lessons to be learned. So let&#39;s learn some.</p><p>当鸣则已一鸣惊人。在与D的溅起后，1我想象一段时间我开始尝试将GNU Modula-2编译器带到OpenBSD。因为为什么不呢？ Modula-2是一种存在的语言，并具有编译器实现。我猜我的目标是将所有语言和编译器带到OpenBSD。一如既往，有课程要学习。所以，让＆＃39;学到了一些。</p><p>  Unlike  gdc, which has been officially integrated into  gcc, gm2 exists externally to the official gcc repository. With that said, setup is relatively straightforward. On the gm2  download page there are pre-setup repositories you can clone with  git. Or if git isn&#39;t your thing, there are  tarballs with the same contents as the git repositories. Or if you truly hate compiling and happen to be running  Debian, there are some  pre-built binaries available. But of course, we are on OpenBSD so let&#39;s compile. I chose the current development branch that uses gcc-11 as its base.</p><p>  与GDC不同于已正式集成到GCC的GDC，GM2存在于官方GCC存储库中。有了这一说，设置相对简单。在GM2下载页面上有预先设置的存储库，您可以使用Git克隆。或者，如果git isn＆＃39; t你的东西，有tarballs与git存储库相同的内容。或者如果您真正讨厌编译并碰巧运行Debian，则有一些预先构建的二进制文件可用。但当然，我们在OpenBSD上所以让＆＃39;编译。我选择了当前的开发分支，它使用GCC-11作为其基础。</p><p>  Let&#39;s just go for it. Let&#39;s build and see what happens. Maybe we will get lucky.</p><p>  让＆＃39; s只是为了它。让＆＃39;建立并看看会发生什么。也许我们会幸运。</p><p>  Surprise surprise, we hit a build error. This one I got a little help from  Josh Rickmar, who I have known for quite a while all the way back to the  Devio.us days. Thanks Josh!</p><p>  惊喜惊喜，我们击中了一个构建错误。这一个我从Josh Rickmar获得了一点帮助，我已经知道了很多，一直都回到Devio.us天。谢谢乔希！</p><p> The problem was that the C++ compiler was  failing on a  reinterpret_cast&lt;*&gt; (NULL). Turns out that on OpenBSD, if you are compiling C++11 or later,   NULL expands out to  nullptr. The standard leaves the expansion of  NULL to be implementation-defined. So I tried out a couple of Linux distros and  FreeBSD to compare. On seemingly every Linux,  NULL expands unconditionally to  __null. On FreeBSD, what  NULL expands to depends on the compiler used: if using the in-base  clang  NULL expands to  nullptr whereas if you use the package of  gcc-10 then  NULL expands to  __null. As GNU Modula-2 uses C++11, this was a problem for OpenBSD. However, OpenBSD&#39;s expansion of  NULL is legal according to the standard, so I do not believe that changing it is what needs to be done. Instead, we should probably add to gm2 an extra preprocessor check for __OpenBSD__ and if that&#39;s true then we should undefine  NULL and redefine it as  __null. For now, I simply  commented out the check in  sys/_null.h to force  NULL to expand to  __null.</p><p> 问题是C ++编译器在重新诠释_Cast＆lt; *＆gt上失败了。 （无效的）。事实证明，在OpenBSD上，如果您正在编译C ++ 11或更高版本，Null会扩展到NULLPTR。标准留下了要定义的null的扩展。所以我试过了几个Linux Distrs和FreeBSD比较。似乎每个Linux，null对__null无条件地扩展。在FreeBSD上，null扩展到依赖于所用的编译器：如果使用基础克朗null展开到nullptr，而如果使用gcc-10的包，则null扩展到__null。由于GNU Modula-2使用C ++ 11，这是OpenBSD的问题。然而，OpenBSD＆＃39; NULL的扩张根据标准是合法的，所以我不相信改变它是需要做的。相反，我们可能会添加到GM2额外的预处理器检查__openBSD__，如果是那个＆＃39; s true那么我们应该unefine null并将其重新定义为__null。目前，我只是注明了在sys / _null.h中的检查，以强制null展开__null。</p><p>  After the  NULL expansion was dealt with, building continued smoothly. But then I got a host of linker errors telling me that  __builtin_unreachable was not resolved. That symbol first appears in  gcc-4.5 which made me think that perhaps somehow the libgcc from gcc-4.2.1, which is still in the OpenBSD/amd64 base system, was being picked up before the libgcc from gcc-11. Heavy-handed approach here: I replaced the old gcc-4.2.1 libgcc with the new gcc-11 libgcc. I don&#39;t actually use the in-base gcc for anything, and I presume it will be removed someday. Ideally, this would be fixed but I was more interested in getting gm2 working first and then we can go back and fix these things.</p><p>  拒绝零扩建后，建筑持续顺利。但是，我收到了一系列链接错误，告诉我__builtin_unroachable没有解决。该符号首次出现在GCC-4.5中，让我认为可能以某种方式来自GCC-4.2.1的Libgcc，它仍处于OpenBSD / AMD64基础系统，在GCC-11之前正在拾取。这里的沉重方法：我用新的GCC-11 Libgcc替换了旧的GCC-4.2.1 Libgcc。我不实际使用基于基础的GCC的任何东西，我会发现一天会删除它。理想情况下，这将是固定的，但我对获得GM2的工作更感兴趣，然后我们可以回去解决这些问题。</p><p>  Building continued until it attempted to build the gm2 plugin. Unfortunately, the build system tries to pick up  gmp.h but the build system does not include the GMP include directory in the compiler invocation. This seems like an oversight from the gm2 developers that should be fixed.</p><p>  建筑继续直到它试图构建GM2插件。不幸的是，构建系统尝试拾取GMP.h，但构建系统不包括MPP包含编译器调用中的目录。这似乎是应该修复的GM2开发人员的监督。 </p><p>  The gm2.texi file did not build with either the in-base makeinfo or the from-ports makeinfo. So I got rid of it. Can always read the online documentation if I need to.</p><p>gm2.texi文件没有使用基础MakeInfo或From-Ports MakeInfo构建。所以我摆脱了它。如果需要，可以始终阅读在线文档。</p><p>  And then the build completed successfully! That was surprisingly easy. Now it was time to test it out. Fortunately that is quite easy since gm2 has  a page on testing. I ran the tests and  posted the results. It is not that bad. There are plenty of failures but it is far and away mostly passes. I  wrote to the gm2 mailing list with the results as well. I hope to hear back from the developers soon.</p><p>  然后构建成功完成！这令人惊讶地容易。现在是时候测试它了。幸运的是，由于GM2在测试页面上，因此很容易。我跑了测试并发布了结果。这不是那么糟糕。有很多失败，但它远远超过了。我与结果写入GM2邮件列表。我希望很快能听到开发商的回复。</p><p>    But the build kept failing! First it seemed like gm2 could not find its own headers. Once I manually added those in, I got lots and lots of linker errors. I ended up tracking down some very old gm2 documentation squirreled away on an old ftp site that happened to always have  -I. in all their compiler invocations. That indeed was the magic addition. Once I added  -I. compilation worked correctly without having to add in anything else:  gm2 -I. hello.mod. It does leave behind a lot of intermediate files and appears to transpile Modula-2 to C++ and then compiles the C++ into a binary. The compiled binary worked as well, which was a good re-confirmaton that I indeed built a working compiler.</p><p>    但是构建保持失败！首先，它看起来像GM2找不到自己的标题。一旦我手动添加了那些，我有很多链接器错误。我最终追踪了一些非常旧的GM2文档在旧的FTP站点上掉了出来的旧FTP网站，始终始终拥有-i。在所有编译器调用中。这确实是魔法补充。一旦我添加了-I。编译正常工作，而无需添加其他任何内容：gm2 -i。 hello.mod。它确实留下了大量的中间文件，并且出现在C ++中将调制模块-2转换为，然后将C ++编译为二进制文件。编译的二进制文件也奏效，这是一个很好的重新确认，我确实建立了一个工作编译器。</p><p>  I am hoping that the gm2 developers get back to me soon about my mailing list post. I do want to get the testsuite failures down to zero. And I also want to submit patches to ensure that the OpenBSD build just works. There were no instructions on how patch submission worked, so I asked in my mailing list post. As gm2 is, after  over 20 years of development, finally preparing to be  merged into gcc, now is the perfect time to get those very small tweaks for OpenBSD support in. A pre-emptive congratulations to the gm2 team on their persistence and dedication. But I also want to make sure that OpenBSD can build gm2 out of the box the day the merge happens.</p><p>  我希望GM2开发人员很快就会回复我的邮件列表帖子。我要将TestSuite失败降至零。而且我也想提交修补程序以确保OpenBSD构建只是作品。没有关于补丁提交的工作原理的说明，所以我在邮寄名单帖子中询问。随着GM2的发展，终于准备合并到GCC，现在是获得OpenBSD支持的那些非常小的调整的完美时间。对GM2团队的持久性和奉献精神先发制人祝贺。但我也想确保OpenBSD可以在合并发生的那一天在盒子中建造GM2。</p><p>  As the person who  created,  imported, and  maintains the port of  GNU Pascal, which I still use and which is sadly the only remaining  Pascal compiler in ports after  Free Pascal was  removed after  no one stepped up to maintain it after it broke, I guess I must have some affinity for  Wirth languages.</p><p>  作为创建，进口和维护GNU Pascal港的人，我仍然使用，遗憾的是在没有人在破裂后搬到维护之后搬到港口的唯一剩余的帕斯卡编译器，我猜我必须对Wirth语言具有一些亲和力。</p><p> But I also enjoy porting compilers and other toolchain bits. Something about the meta of it all I think. Anyhow, I hope you enjoyed this adventure into getting GNU Modula-2 working on OpenBSD!</p><p> 但我也喜欢移植编译器和其他工具链条。我认为这一切都是关于它的梅塔。无论如何，我希望你喜欢这个冒险进入GNU Modula-2在OpenBSD上工作！</p><p> 1 Amusingly, as a result of my contributions to the D standard library, my name now appears in the  gcc source tree.</p><p> 1有趣的是，由于我对D标准库的贡献，我的名字现在将显示在GCC源树中。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://briancallahan.net/blog/20210403.html">https://briancallahan.net/blog/20210403.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/编译/">#编译</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/openbsd/">#openbsd</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/modula/">#modula</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/gm2/">#gm2</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>