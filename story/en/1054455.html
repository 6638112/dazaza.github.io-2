<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>GitHub动作如何呈现大规模的日志 How GitHub Actions renders large-scale logs</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">How GitHub Actions renders large-scale logs<br/>GitHub动作如何呈现大规模的日志 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-03-26 20:20:14</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/3/50b167e95326ddd1d22749c631dcdc2a.png"><img src="http://img2.diglog.com/img/2021/3/50b167e95326ddd1d22749c631dcdc2a.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>Rendering logs in a web UI might seem simple: they are just lines of plain text. However, there are a lot of additional features that make them more useful to our users: coloring, grouping, search, permalinks, etc. but most importantly, the interface should work no matter if the log has ten or tens of thousands of lines. This was something we had to prioritize from the beginning when we made GitHub Actions GA in 2019. We didn’t have usage metrics at that time, but it was obvious we had to deal with the case of very large log lines. The browser could freeze in the initial load, or it could be completely unusable if we didn’t tackle this problem correctly. We had to make use of a technique called virtualization.</p><p>在Web UI中渲染日志似乎很简单：它们只是纯文本的线条。但是，有很多额外的功能使它们对我们的用户更有用：着色，分组，搜索，永久链接等。但最重要的是，界面应该无论日志都有10个或成千上万的线路，都应该工作。这是我们在2019年制作GitHub行动的时候从一开始就优先考虑。我们当时没有使用量度指标，但很明显，我们不得不处理非常大的日志线的情况。浏览器可以在初始负载中冻结，如果我们没有正确解决此问题，可能是完全无法使用的。我们必须利用一种称为虚拟化的技术。</p><p> Virtualization consists of rendering only a subset of the information in a list, to make the UI behave seamlessly without the user noticing that there’s data out of the visible viewport that is not yet rendered. It requires updating the visible content when the user scrolls, calculating layout positions even when not all the information is rendered to keep the scrolling experience smooth and much more.</p><p> 虚拟化包括仅渲染列表中的信息的子集，以使UI无缝行为，而没有用户注意到尚未呈现的可见视口中的数据。它需要更新用户滚动时的可见内容，计算布局位置，即使不是所有信息都呈现以保持滚动体验平滑等等。</p><p>   When we first launched GitHub Actions, we tested with a React-based library and also a vanilla JavaScript one. Some of the libraries have hard limitations because of the way they are implemented. For example, many libraries require that all items rendered in the screen have a fixed height. This constraint makes the calculations a lot easier for them, because if a user wants to scroll to a specified item (visible or not), they just have to multiply  item_index * items_height to calculate the position, and then scroll to it. Also, in order to calculate the whole scrollable height, they can do something similar  items_count * items_height. That’s it! Of course in many cases not all elements have the same height, making this limitation not acceptable. In the case of GitHub Actions, we wanted to break long log lines, which meant we had to support log lines with variable height.</p><p>   当我们首次启动GitHub操作时，我们用基于React的库和vanilla JavaScript One测试。由于它们的实施方式，一些图书馆具有困难的限制。例如，许多库要求屏幕中呈现的所有项目具有固定高度。此约束使计算使它们更容易，因为如果用户想要滚动到指定的项目（可见或不可见），则它们只需乘以emply_index * items_height来计算位置，然后滚动到它。此外，为了计算整个可滚动的高度，他们可以做一些类似的项目_count *项目_height。而已！当然，在许多情况下，所有元素都有相同的高度，使这个限制不可接受。在GitHub操作的情况下，我们想要打破长的日志线，这意味着我们必须支持具有变量高度的日志行。</p><p> We ended up choosing a vanilla JavaScript library that had most of the functionality we wanted: the ability to have variable element heights, to scroll to an item, etc. However, we started to see limitations with bugs and poor UX experiences for variety of reasons:</p><p> 我们最终选择了一个拥有我们想要的大多数功能的vanilla javascript库：具有可变元素高度的能力，滚动到项目等。但是，由于各种原因，我们开始看到错误和差的UX体验的限制：</p><p> The scrollable area should have a fixed height which is another typical limitation that makes the internal implementation easy. But in our case, this made the UX experience poor, especially because in our logs, one job will have multiple steps and each step has its own virtualization. This meant the page had to have individual scrolling areas for each step along with the scrollbar for the whole page.</p><p> 可滚动区域应具有固定的高度，这是另一个典型的限制，使内部实现容易。但在我们的情况下，这使得UX体验差，特别是因为在我们的日志中，一个作业将有多个步骤，每个步骤都有自己的虚拟化。这意味着页面必须为每个步骤都有单独的滚动区域以及整页的滚动条。</p><p> It was not very well tested for cases where the virtualized list had to switch its visibility from hidden to visible. For GitHub Actions, we allow users to expand and collapse steps, as well as expand logs automatically. We began to see there was a bug when a step started running. When we automatically expanded the logs to make them visible, and the browser tab was not visible at that moment, sometimes users weren’t able to properly see the logs when they came back to the browser tab.</p><p> 对于虚拟化列表必须将其从隐藏可见的可见性切换到可见的情况并不是很好的。对于GitHub操作，我们允许用户展开和折叠步骤，并自动展开日志。我们开始看到一步开始运行时有一个错误。当我们自动扩展日志以使它们可见时，此时浏览器选项卡不可见，有时用户无法在返回浏览器选项卡时正确地看到日志。</p><p> Users weren’t able to select text and scroll at the same time because the selection would end up being removed from the DOM due to the virtualization.</p><p> 用户无法同时选择文本并滚动，因为选择将从DOM删除由于虚拟化而删除。 </p><p> In some cases, the experience was slow because we had to render log lines in the background in order to calculate their height. The virtualization wasn’t helping much and we were actually rendering some lines twice instead of not rendering them at all. But, we had to do it this way because incorrect height calculations led to log lines being cut off in the UI.</p><p>在某些情况下，体验很慢，因为我们必须在后台渲染日志行以便计算它们的高度。虚拟化并没有帮助多大，我们实际上是两次渲染两行，而不是根本没有渲染它们。但是，我们不得不这样做，因为不正确的高度计算导致在UI中被切断的日志线。</p><p>  For all these reasons, we decided to revamp the log experience. We started with a question: do we still need virtualization? As noted, we didn’t have metrics about usage at launch, but now we were able to make decisions based on real usage. For example, we could remove virtualization if the vast majority of our users had logs that were small enough to render them without, but allow larger logs to be downloaded separately.</p><p>  出于所有这些原因，我们决定改造日志经验。我们开始了一个问题：我们还需要虚拟化吗？如上所述，我们没有关于推出的用途的指标，但现在我们能够根据真实用法做出决定。例如，如果我们的绝大多数用户具有足够小的日志，我们可以删除虚拟化，以便在没有的情况下呈现它们，但允许单独下载更大的日志。</p><p> Our data showed us that 99.51% of existing jobs had less than 50k lines, but we knew that browsers start struggling with more than 20k log lines. We also found that even if there is a low number of log lines, it was possible that it could take up too much space in memory. With all that information, we decided that we didn’t need data virtualization but we did still require UI virtualization. Data virtualization would have required to only load parts of the logs in memory and fetch more information as the user scrolls, but we found that that level of complexity wasn’t necessary. In the very edge case of having a very large log file with a low number of log lines, we truncate it and provide a link to download it.</p><p> 我们的数据显示，99.51％的现有就业机会少于50k线，但我们知道浏览器开始以超过20k的日志线挣扎。我们还发现即使存在低数量的日志线，也可能占用的空间太多。通过所有这些信息，我们决定我们不需要数据虚拟化，但我们仍然需要UI虚拟化。数据虚拟化需要仅在内存中加载日志的部分并将更多信息获取，但我们发现没有必要的复杂程度。在具有较少数量的日志线路的非常大的日志文件的非常边缘情况下，我们截断并提供下载它的链接。</p><p>  Once these decisions were made we tried to look for alternative libraries to the one we were using, but none of them suited our needs. We had to make an implementation from scratch. Our goals were:</p><p>  一旦做出这些决定，我们试图寻找我们使用的替代图书馆，但他们都不适合我们的需求。我们必须从头开始实施。我们的目标是：</p><p> Make the UI/UX smooth in most cases. Including when jumping between search results or permanent links and streaming logs.</p><p> 在大多数情况下使UI / UX平滑。包括在搜索结果或永久链接和流日志之间跳跃时。</p><p>   Make the computations as fast as possible, and use less memory. Not completely accurate calculations are fine.</p><p>   使计算尽可能快，并使用更少的内存。不是完全准确的计算很好。</p><p> To reach these goals, we had to approach this a bit different than other libraries in a few areas:</p><p> 要达到这些目标，我们必须在少数地区的其他图书馆方面接近这一点不同： </p><p> Estimate heights before rendering: Whereas, most virtualization libraries rely on precise calculations or fixed heights and use absolute positioning to make the implementation very simple, we decided to estimate heights before rendering to avoid costly calculations. We also use relative positioning to avoid log lines being cut off if those calculations are not precise.</p><p>估计高度在渲染前：虽然，大多数虚拟化库依赖于精确的计算或固定高度，并使用绝对定位使实现非常简单，我们决定在渲染之前估算高度以避免昂贵的计算。我们还使用相对定位，以避免如果这些计算不准确，则避免切断的日志线。</p><p> DOM structure: Another challenge was how to structure the DOM for allowing sticky headers and having only one scrollable area. The scrollable container had to contain both but the sticky headers must not be virtualized.</p><p> DOM结构：另一个挑战是如何构建DOM以允许粘性标头并只有一个可滚动区域。可滚动的容器必须包含两个，但粘性标头不得虚拟化。</p><p> We made a quick implementation to validate our strategy. After some tests generating large logs we found that, while we validated that we could implement our own virtualization meeting all our goals, we had to be careful because it was easy to make wrong decisions and ruin the whole experience. For example, one thing we quickly realized was that rendering as few DOM nodes as possible was important, but it was also important to do as few DOM mutations as possible while scrolling. When the user scrolls, we need to add nodes that become visible and remove nodes that are no longer visible. If the user scrolls fast, especially in mobile devices, there may be too many DOM mutations resulting in a subpar experience.</p><p> 我们快速实施以验证我们的策略。经过一些测试，我们发现我们发现的大日志，虽然我们验证了我们可以实现我们自己的虚拟化会议，但我们必须小心，因为它很容易做出错误的决策并破坏整个经历。例如，我们快速实现的一件事是，尽可能少的DOM节点渲染很重要，但在滚动时尽可能少的DOM突变也很重要。当用户滚动时，我们需要添加变得可见的节点，并删除不再可见的节点。如果用户快速滚动，尤其是在移动设备中，可能会有太多的DOM突变导致子达经验。</p><p> However, we can fix this in a few ways. For example, you can throttle your code and do the updates in batches and not very frequently. But we found that this approach made the UI less smooth. We came up with the idea of grouping log lines in clusters, so instead of removing and adding individual lines, we put log lines in clusters of N lines and add or remove clusters instead of individual lines. After some tests, we now have an idea of how many lines a cluster would have: 50 lines per cluster.</p><p> 但是，我们可以通过几种方式解决此问题。例如，您可以节省您的代码并以批处理进行更新而不是频繁进行更新。但我们发现这种方法使UI不太顺利。我们提出了在集群中分组日志行的想法，因此我们将在N行的群集中放置数目，而不是删除和添加单个行，并添加或删除群集而不是单个线路。在某些测试之后，我们现在了解群集有多少行将有：每簇50行。</p><p>  In a week or so, we were able to get an initial implementation that allowed us to see all the benefits in terms of UX. At that point we knew we were on the right path. The next few weeks we worked on other  UI/UX improvements and we knew there was a long tail of edge cases we had to deal with.</p><p>  在一周左右的一周左右，我们能够获得初步实现，使我们能够在UX方面看到所有的好处。那时我们知道我们在正确的道路上。接下来的几周我们在其他UI / UX改进中工作，我们知道我们必须处理的边缘案件长长的尾部。</p><p> After a lot of work internally on this, we shipped it to all users and are happy to now offer a superior logs experience: faster, smoother, friendlier, and more cohesive and robust. Most of the time you don’t have to reinvent the wheel, but sometimes the best solution is to implement your own solution from scratch to have the experience and the performance totally under your control.</p><p> 经过大量工作的内部，我们向所有用户发货，现在很高兴提供优越的日志体验：更快，更顺畅，更友好，更凝聚力和强大。大多数时候您不必重新发明轮子，但有时最好的解决方案是从头开始实施自己的解决方案，以便在您的控制中完全进行体验和表现。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://github.blog/2021-03-25-how-github-actions-renders-large-scale-logs/">https://github.blog/2021-03-25-how-github-actions-renders-large-scale-logs/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/github/">#github</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/动作/">#动作</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/actions/">#actions</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/日志/">#日志</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>