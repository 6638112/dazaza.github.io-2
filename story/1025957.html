<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>在2D中行进光线柔和阴影</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">在2D中行进光线柔和阴影</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-24 02:48:54</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/9/54973ac29e1e5c80a7daca2864e5d08c.png"><img src="http://img2.diglog.com/img/2020/9/54973ac29e1e5c80a7daca2864e5d08c.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>免责声明：此页面上的演示使用的WebGL功能在某些移动设备上不可用。</p><p>几周前，我在推特上发布了一个玩具图形项目的视频(见下图)。虽然还没有做完，但是很多人都很喜欢，很惊喜也很有趣！一些人问它是如何工作的，所以这就是这篇帖子的主题。</p><p>在引擎盖下面，它使用一种叫做距离场的东西。距离场是一个图像，如下图所示，它告诉您每个像素离您的形状有多远。浅灰色像素接近形状，深灰色像素远离形状。</p><p>当演示启动时，它在2D画布上绘制一些文本并生成其距离场。它使用了我编写的一个库，可以非常快速地生成距离场。如果你好奇图书馆是怎么运作的，我在这里写过。</p><p>我们的照明方案是这样工作的：在处理特定像素时，我们考虑从它到光线的光线，例如…。</p><p>如果光线与字形相交，我们着色的像素一定在阴影中，因为在它和光线之间有一些东西。</p><p>要检查这一点，最简单的方法是以1px为增量沿光线移动，从我们着色的像素开始，在灯光处结束，反复询问距离场我们与形状的距离是否为0。这会奏效的，但会很慢。</p><p>我们可以选择一些特定的长度，如30px，然后以该大小为增量移动，但是我们可能会跳过小于30px的字形。我们可能会认为我们本应处于阴影中，但我们并没有处于阴影中。</p><p>Ray Marching的核心思想是：距离字段告诉您距离最近的字形有多远。您可以安全地沿着光线前进该距离，而无需跳过任何字形。</p><p>让我们来演示一个例子。我们按照上图开始，询问距离场我们离任何字形有多远。在这种情况下，结果是95px(如左图所示)。这意味着我们可以沿着光线移动95px，而不会跳过任何东西！</p><p>现在我们离光更近了一点。我们重复这个过程，直到我们到达b的上升点！如果没有b字形，我们就会一直往前走，直到撞上灯。</p><p>下面的演示展示了给定像素的光线行进步骤。红色方框是我们要着色的像素，沿光线的每个圆表示光线行进步长以及该步长与场景的距离。</p><p>下面是实现此技术的GLSL。它假定您已经定义了对距离场进行采样的函数getDistance。</p><p>Ve2 rayOrigin=...；ve2 rayDirection=...；浮动rayProgress=0；而(True){if(rayProgress&gt；Distance(rayOrigin，lightPosition)){//我们撞到灯了！此像素不在阴影中。Return 1.；}Float sceneDist=getDistance(rayOrigin+rayProgress*rayDirection)；if(sceneDist&lt；=0.){//我们遇到了形状！此像素处于阴影中。返回0；}rayProgress+=sceneDist；}。</p><p>事实证明，有些像素的处理成本确实很高。因此，在实践中，我们使用for-循环而不是while循环-这样，如果我们做了太多的步骤，我们就会跳出困境。光线行进中的一种常见“缓慢情况”是光线平行于场景…中的形状的边缘。</p><p>到目前为止，我描述的方法将为您提供如下所示的场景。</p><p>很酷，但是阴影很锐利，看起来不太好。演示中的阴影看起来更像这个…。</p><p>一个很大的免责声明是，它们在物理上是不现实的！真实阴影看起来像边缘已模糊化的硬阴影。这种方法所做的事情略有不同：以前处于阴影中的所有像素仍然完全处于阴影中。我们刚刚在它们周围添加了部分阴影像素的半影。</p><p>优点是它们计算起来又漂亮又快，这就是我所关心的！在计算它们时涉及到三个“规则”。</p><p>规则1：光线与形状相交的距离越近，其像素的阴影就越大。在下图中，有两条相似的射线(它们与用黄色和绿色绘制的形状的距离)。我们希望离拐角更近的那个更有阴影。</p><p>计算成本很低，因为变量scenedist告诉我们，在每个光线行进步骤中，我们距离最接近的形状有多远。因此，对于上图中的黄色和绿色线条，所有步骤中的sceneDist的最小值是一个很好的近似值。</p><p>规则2：如果我们着色的像素距离它几乎与形状相交的点很远，我们希望阴影扩散得更远。</p><p>考虑沿着上面的射线的两个像素。一个更靠近几乎是十字路口，也更轻(它的距离是绿线)。另一个更远、更暗(它的距离是黄线)。一般而言：像素离其几乎相交的距离越远，我们应该使其越“处于阴影中”。</p><p>计算成本很低，因为变量rayProgress是上图中绿色和黄色线条的长度。</p><p>所以：我们之前为不在阴影中的像素返回了1.0。为了实现规则1和2，我们计算每个光线行进步骤上的scenedist/rayProgress，跟踪其最小值，然后返回该值。</p><p>Vector 2 rayOrigin=...；ve2 rayDirection=...；浮动rayProgress=0。；浮动stopAt=Distance(samplePt，lightPosition)；Float lightContribution=1。；for(int i=0；i&lt；64；i++){if(rayProgress&gt；stopAt){return lightContribution；}//`getDistance`对距离场纹理进行采样。Float sceneDist=getDistance(rayOrigin+rayProgress*rayDirection)；if(sceneDist&lt；=0){//我们撞到形状了！此像素处于阴影中。Return 0.；}lightContribution=min(lightContribution，scenedist/rayProgress)；rayProgress+=scenedist；}//光线行进超过64步！返回0。；</p><p>这个比率对我来说有点神奇，因为它不符合任何物理价值。因此，让我们通过思考为什么它可能具有特殊的价值，来为它建立一些直觉，…。</p><p>如果sceneDist/rayProgress&gt；=1，则scenedist较大或rayProgress较小(相对于彼此)。在前一种情况下，我们远离任何形状，也不应该处于阴影中，因此灯光值为1是有意义的。在后一种情况下，我们正在阴影的像素非常接近投射阴影的对象，并且阴影还不是模糊的，因此光度值为1是有意义的。</p><p>仅当sceneDist为0时，该比率才为0。这对应于与对象相交且其像素在阴影中的光线。</p><p>规则3是最直截了当的：你离它越远，光线就越弱。</p><p>我们不是逐字返回scenedist/rayProgress的最小值，而是将其与距离因子相乘，距离因子紧挨着灯光为1，远离灯光为0，并且随着您离开灯光而平方变小。</p><p>Vec2 rayOrigin=...；Vec2 rayDirection=...；Float rayProgress=0。；Float stopAt=Distance(samplePt，lightPosition)；Float lightContribution=1。；for(int i=0；i&lt；64；i++){if(rayProgress&gt；stopAt){//我们撞上了灯！FLOAT LIGHT_RADIUS_PX=800.；//灯光旁边的fadeRatio为1.0，为0。在//LIGHT_RADIUS_PX之外。浮动fadeRatio=1。0-CLAMP(stopAt/light_Radius_px，0.，1.)；//我们希望灯光以平方方式衰减，而不是//以//线性方式衰减。Float Distancefactor=power(fadeRatio，2.)；return lightContribution*DistanceFactor；}//`getDistance`对距离场纹理进行采样。Float sceneDist=getDistance(rayOrigin+rayProgress*rayDirection)；if(sceneDist&lt；=0){//我们撞到形状了！此像素处于阴影中。Return 0.；}lightContribution=min(lightContribution，scenedist/rayProgress)；rayProgress+=scenedist；}//光线行进超过64步！返回0。；</p><p>我忘了我是在哪里找到这种柔和阴影技术的，但我绝对没有发明它。Inigo Quilez在它上面有一个很棒的帖子，在那里他谈到了在3D中使用它。</p><p>Inigo的帖子还谈到了这种方法的一个问题，您可能已经在上面的演示中注意到了：它会导致条带状的工件。这是因为规则1假设所有步骤上的sceneDist的最小值是光线到场景距离的最佳近似值。这并不总是正确的，因为我们有时走的射线步数很少。</p><p>因此，在我的演示中，我使用了Inigo在他的帖子中写到的改进的近似值。我还使用了另一个更有效但性能较差的技巧：不是在每个光线行进步骤中按sceneDist前进，而是前进类似于sceneDist*随机抖动，其中随机抖动介于0和1之间。</p><p>这改进了近似值，因为我们在光线行进中添加了更多的步数。但是我们可以通过向场景方向前进来做到这一点。随机抖动确保彼此相邻的像素不会出现在同一波段。这使得结果有点模糊，这不是很好。但我觉得看起来比捆绑…要好。这是演示中我仍然不满意的一个方面，所以如果您对如何改进有什么想法，请告诉我！</p><p>总体而言，我的演示有一些额外的调整，我将来可能会写到，但这是它的核心。谢谢你的阅读！如果你有问题或意见，请在推特上告诉我。</p><p>感谢Jessica Liu，Susan Wang，Matt Nichols和Kenrick Rilee对本帖子早期草稿的反馈！另外，如果你喜欢这个帖子，你可能会喜欢和我一起在Figma工作！</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.rykap.com/2020/09/23/distance-fields/">https://www.rykap.com/2020/09/23/distance-fields/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/行进/">#行进</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/marching/">#marching</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/距离/">#距离</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>