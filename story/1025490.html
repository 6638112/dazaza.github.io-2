<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Mikrotik RB3011上的主线Linux</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Mikrotik RB3011上的主线Linux</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-09-22 10:30:20</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/9/bb4cc07abe59cf9e336f44fb4e43459d.jpg"><img src="http://img2.diglog.com/img/2020/9/bb4cc07abe59cf9e336f44fb4e43459d.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>去年10月，我把家里的互联网连接升级为光纤(FTTP)。我仍然在使用80M/20M的服务，所以它并不比我原来的VDSL FTTC连接速度快，因此我在很长一段时间里继续使用我的运行OpenWRT的HomeHub5A。然而，FTTP ont意味着我已经用完了路由器上的一个额外的以太网端口，而且我已经很缺了，所以我最终也使用了一台GigE交换机。另外，我的WiFi是由Unifi处理的，它通过以太网供电。这意味着我有一台路由器、一台交换机和一个PoE注入器，它们都离我很近。我想减少设备数量，理想情况下，一旦我决定升级FTTP服务速度，就可以升级到可以扩展的设备。</p><p>环顾四周，我发现了Mikrotik RB3011UiAS-RM，这是一款机架安装式设备，有10个GigE端口(外加一个SFP插槽)和一个双核高通IPQ8064臂为其供电。有1G内存和128MB NAND闪存，以及一个USB3端口。它还支持PoE。从纸面上看，它似乎是一个理想的装置。我对在它(提供的软件)上运行RouterOS不是特别感兴趣，但它是基于Linux的，而且OpenWRT内部正在进行一些工作来添加支持，所以它看起来是一个值得试验的平台(什么，您认为这是关于我购买现成的设备并仅与提供的软件一起使用吗？)。作为一个额外的奖励，一位朋友说他有一台他没有用过的，很高兴以便宜的价格卖给我。</p><p>我一开始确实尝试过RouterOS，但我并不觉得它特别有吸引力。我习惯于在Linux命令行中配置防火墙和路由，并且在路由器上运行一些额外的服务，比如我的MQTT代理和MQTT-ARP(我的wifi设备状态监视器)。我可以移动东西，让它们在内部服务器上运行，但我认为它们是核心服务，因此我对它们在路由器上运行更满意。</p><p>第一步是在路由器上启动一些东西。幸运的是，它的背面有一个RJ45串行控制台端口，以及一个功能合理的引导加载器，可以通过网络上的TFTP进行引导。它需要的是ELF二进制文件，而不是普通的内核，但是Sergey Sergeev已经做了艰苦的工作，让u-boot在IPQ8064上工作，这意味着我可以只构建普通的u-boot映像来试用。</p><p>Linux upstream已经对我感兴趣的很多部分提供了基本支持。关于AUTO_ZRELADDR有一点模糊，因为网络协处理器需要RAM开始时的一大块内存，但是关于如何干净地处理这一问题的讨论正在进行中，我希望这最终将意味着我可以放弃这种攻击。串行、以太网、QCA8337交换机(2组5端口，绑定到处理器上的不同GigE设备)和内部NOR都有驱动程序，因此只需精心设计一个合适的DTB来使它们工作即可。这就留下了一些微不足道的地方。</p><p>首先，第二台交换机通过SGMII连接。结果发现IPQ806x stmmac驱动程序在此模式下没有正确初始化时钟，qca8k开关驱动程序也没有正确初始化时钟。所以我需要修复这两个问题(Sergey已经处理了stmmac驱动程序，所以我只需要清理并提交他的补丁)。接下来，与高通固件(SCM)对话的驱动程序已经更新，打破了IPQ8064所需的旧方法。一些吉特考古学家发现了这一点，并提供了解决方案。Ansuel Smith很有帮助地为USB端口提供了DWC3PHY驱动程序。这让我可以将Debian的armhf映像放到U盘上，并将其挂载为root，这使得调试变得容易得多。</p><p>在这一点上，我开始尝试将设备配置为实际充当路由器。我在我的家庭网络上使用了许多VLAN，所以我想确保我可以支持这些VLAN。原来stmmac驱动程序不愿意重新配置它的MTU，因为IPQ8064驱动程序没有配置FIFO大小。我找到了似乎正确的价值观，并把它们灌输进去。那么qca8k驱动程序只支持端口桥接。我希望能够有一个中继端口来连接到楼上的交换机，同时也有一个端口只有一个用于本地设备的VLAN。我想让交换机来处理这件事，而不是需要CPU来桥接流量。谢天谢地，很容易找到QCA8337数据表的副本，内核分布式交换机体系结构非常灵活，所以我能够实现必要的支持。</p><p>我坚持把Debian放在U盘上，因为它实际上已经投入生产了。如果需要的话，这使得修复变得更容易，而且U盘允许完整的Debian安装，这在128M的内部NAND上是很棘手的。这意味着我可以使用像nftables这样的东西来进行防火墙，并使用标准的Debian包来处理Colltd和Moterto之类的东西。另外，对于调试，我可以启动tcpdump或tshark之类的东西。这最终很有用，因为当我把这个设备投入生产时，我开始有一个奇怪的</p><p>这些工作中的大部分将在5.9内核发布后出现--5.8中已经有了基础知识。目前我能想到的没有排队的有以下几点：</p><p>Stmmac IPQ806x FIFO大小。我为这些发送了RFC补丁，但没有收到任何回复。我可能只需要提交这个。</p><p>NAND。这缺少对QCOM ADM DMA引擎的支持。我已经发送了我找到的支持这一功能的补丁，并收到了一些反馈，所以我希望它能在某个时候发布。</p><p>液晶屏。AFAICT LCD是一款ST7735设备，它支持内核，但是我没有花很大力气让SPI配置正常工作。</p><p>触摸屏。同样，这似乎是zt2046q或类似的，它有一个内核驱动程序，但我尝试的基本尝试没有得到任何响应。</p><p>正确的SFP功能。IPQ806x有一个PCS模块，但是stmmac驱动程序没有一种简单的方法来实现这一点。我对如何让它正常工作有一些想法(而且可以用固定的链接配置来破解)，但这并不是最优先考虑的事情。</p><p>设备树添加。我后来启用的一些位还不在主线RB3011DTB中。我会在某个时候提交补丁的。</p><p>总体而言，我认为这款设备是成功的，让它正常工作是一件很有趣的事情。我运行的主要是主线内核，它可以毫不费力地处理我家的流量，而且它运行的是Debian，这使得我可以很容易地按照自己的意愿在上面投放更多的东西。然而，事实证明，RB3011并不像我希望的那样完美。PoE支持是被动的，而Unifi需要802.1af。所以我最终会有两台设备。碰巧，我买了一台便宜的D-Link DGS-1210-10P交换机，它提供PoE支持以及一些额外的交换机端口。此外，它还运行linux，因此在后面的…上有更多信息</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.earth.li/~noodles/blog/2020/09/rb3011-mainline.html">https://www.earth.li/~noodles/blog/2020/09/rb3011-mainline.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/mikrotik/">#mikrotik</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/设备/">#设备</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1025293.html"><img src="http://img2.diglog.com/img/2020/9/thumb_88af0eb68cc33b47118dd16b0e9a9c1e.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1025293.html">系统管理员常用的Linux命令-第4部分</a></div><span class="my_story_list_date">2020-9-21 15:48</span></div><div class="col-sm"><div><a target="_blank" href="/story/1025091.html"><img src="http://img2.diglog.com/img/2020/9/thumb_60a3c18b86b669b6bf24fcce0dc2bf66.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1025091.html">微软提交Linux内核补丁，使Linux在Hyper-V上作为根分区运行</a></div><span class="my_story_list_date">2020-9-20 5:4</span></div><div class="col-sm"><div><a target="_blank" href="/story/1024824.html"><img src="http://img2.diglog.com/img/2020/9/thumb_b89f42205318c416a913cb77ea162107.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1024824.html">RTX3080 TensorFlow和NAMD在Linux上的性能(初步版)</a></div><span class="my_story_list_date">2020-9-18 19:49</span></div><div class="col-sm"><div><a target="_blank" href="/story/1024800.html"><img src="http://img2.diglog.com/img/2020/9/thumb_85d294fa7a82f3a01412d0996463a30f.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1024800.html">在Rust中编写可以启动vmlinux的x86引导加载程序</a></div><span class="my_story_list_date">2020-9-18 17:16</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>