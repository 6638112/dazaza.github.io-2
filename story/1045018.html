<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>租约：对集群节点使用限时租约来协调其活动 </title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">租约：对集群节点使用限时租约来协调其活动 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-19 10:14:52</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2021/1/75a9cc1b6393d9a1e22cbfa337298e13.png"><img src="http://img2.diglog.com/img/2021/1/75a9cc1b6393d9a1e22cbfa337298e13.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>群集节点需要对某些资源的独占访问权。但是节点会崩溃；它们可以暂时断开连接或经历过程暂停。在这些错误情况下，它们不应无限期地保持对资源的访问。</p><p> 群集节点可以在有限的时间段内请求租约，租约在此期限后到期。如果节点想要扩展访问权限，则可以在其到期之前更新租约。使用Consistent Core实现租约机制以提供容错能力和一致性。有时间生活与租赁相关的价值。群集节点可以在具有附加租约的一致性核心中创建密钥。租约与领导者和追随者复制以提供容错能力。拥有租约的节点负责定期刷新它。客户使用HeartBeat在一致的核心中刷新实现价值的时间。在一致性核心中的所有节点上创建租约，但只有领导者跟踪租约超时。 [1]一致性核心中的关注者未跟踪超时。这样做是因为我们需要领导者使用自己的单调时钟来决定租约何时到期，然后让追随者知道租约何时到期。这样可以确保节点（与一致性核心中的其他任何决定一样）也就租约到期达成共识。</p><p>      私有ScheduledThreadPoolExecutor执行程序= new ScheduledThreadPoolExecutor（1）;私人ScheduledFuture＆lt;？＆gt; cheduleTask; @Override public void start（）{scheduleTask = executor.scheduleWithFixedDelay（this :: checkAndExpireLeases，leaseCheckingInterval，leaseCheckingInterval，TimeUnit.MILLISECONDS）; } @Override public void checkAndExpireLeases（）{remove（expiredLeases（））; } private void remove（Stream＆lt; String＆gt; expiredLeases）{expiredLeases.forEach（（leaseId）-＆gt; {//从此服务器上删除它，以免再次引起触发。expireLease（leaseId）; //提交请求，以便追随者知道过期的租约SubmitExpireLeaseRequest（leaseId）;}）; }私人Stream＆lt; String＆gt; expiredLeases（）{很久以前= System.nanoTime（）; Map＆lt; String，Lease＆gt;租约= kvStore.getLeases（）; return leases.keySet（）。stream（）.filter（leaseId-＆gt; {租约租赁= leases.get（leaseId）;返回lease.getExpiresAt（）＆lt; now;}）; }</p><p>   公共无效onCandidateOrFollower（）{如果（leaseTracker！= null）{leaseTracker.stop（）; } leaseTracker = new FollowerLeaseTracker（this，leases）; }</p><p>  公共类Lease实现Logging {字符串名；长ttl; //此租约到期的时间长久expiresAt; //与此租约相连的kv商店中的密钥List＆lt; String＆gt; AttachedKeys = new ArrayList＆lt;＆gt;（）; public Lease（字符串名称，long ttl，很久了）{this.name = name; this.ttl = ttl; this.expiresAt = now + ttl; } public String getName（）{返回名称； } public long getTtl（）{return ttl; } public long getExpiresAt（）{返回expiresAt; } public void refresh（long now）{expiresAt = now + ttl; getLogger（）。info（＆＃34;刷新租约＆＃34; +名称+＆＃34;过期时间为＆＃34; + expiresAt）; } public void attachKey（String key）{attachKeys.add（key）; } public List＆lt; String＆gt; getAttachedKeys（）{返回AttachedKeys; }}</p><p> 当节点想要创建租约时，它与Consistent Core的负责人连接并发送创建租约的请求。寄存器租用请求的复制和处理与Consistent Core中的其他请求类似。仅当高水位标记达到复制日志中请求条目的日志索引时，请求才完成。</p><p>   @Overridepublic CompletableFuture＆lt; Response＆gt; registerLease（字符串名称，long ttl）{如果（leaseExists（name））{返回CompletableFuture .completedFuture（Response.error（Errors.DUPLICATE_LEASE_ERROR，＆＃34;名称为＆＃34; +名称+＆＃34;的租赁已存在＆ ＃34;））； }返回server.propose（new RegisterLeaseCommand（name，ttl））;}私有布尔leaseExists（字符串名称）{返回leases.containsKey（name）;} </p><p>要注意的重要事项是在哪里可以验证重复的租赁注册。在提出请求之前仅对其进行检查是不够的，因为可能会有多个进行中的请求。因此，成功复制后注册租约时，服务器还会检查重复项。</p><p>  私有Map＆lt; String，Lease＆gt;租赁； @Override public void addLease（String name，long ttl）抛出DuplicateLeaseException {if（leases.get（name）！= null）{抛出新的DuplicateLeaseException（name）; }租约=新的Lease（name，ttl，clock.nanoTime（））; leases.put（名称，租赁）; }</p><p>    负责租约的节点连接到领导者，并在租约到期之前刷新租约。如HeartBeat中所讨论的，它需要考虑网络往返时间来决定生存时间。值，并在租约到期前发送刷新请求。节点可以在“离开时间”内多次发送刷新请求。时间间隔，以确保在发生任何问题时刷新租约。但是该节点还需要确保没有发送太多刷新请求。在大约一半的租赁时间过去之后，发送请求是合理的。这导致在租用时间内最多两个刷新请求。客户端节点使用自己的单调时钟跟踪时间。</p><p>   刷新请求仅发送给Consistent Core的负责人，因为只有负责人负责确定租约到期的时间。</p><p>   租约到期后，将从租户中删除。将此信息提交给一致性核心也至关重要。因此，领导者发送了一个使租约到期的请求，该请求的处理与Consistent Core中的其他请求一样。高水位标记达到建议的过期租赁请求后，将从所有关注者中删除。</p><p>  public void expireLease（String name）{getLogger（）。info（＆＃34; Expiring lease＆＃34; + name）;租约已删除租约= leases.remove（name）; removeAttachedKeys（removedLease）; }</p><p> 集群需要知道其节点之一是否发生故障。为此，可以使节点从Consistent Core租用，然后将其附加到存储在Consistent Core中的自识别密钥。如果群集节点正在运行，则应定期更新租约。如果租约到期，则将删除关联的密钥。除去键后，指示状态节点故障的事件将发送到感兴趣的群集节点，如状态监视模式中所述。 </p><p>使用Consistent Core的群集节点通过进行网络调用来创建租约，如下所示：</p><p>  然后，它可以将此租约附加到它存储在Consistent Core中的自我识别密钥上。</p><p>  当Consistent Core收到将密钥保存在其键值存储中的消息时，它还会将密钥附加到指定的租约。</p><p>    私人回应applySetValueCommand（Long walEntryId，SetValueCommand setValueCommand）{getLogger（）。info（＆＃34;设置键值＆＃34; + setValueCommand）; if（setValueCommand.hasLease（））{租约= leases.get（setValueCommand.getAttachedLease（））; if（lease == null）{//要添加的租约在一致的核心返回Response.error（Errors.NO_LEASE_ERROR，＆＃34;不存在租约＆＃34; + setValueCommand.getAttachedLease（））下不可用; } lease.attachKey（setValueCommand.getKey（））; } kv.put（setValueCommand.getKey（），new StoredValue（setValueCommand.getValue（），walEntryId））;</p><p> 租约到期后，一致性核心还将从其键值存储中删除附加的键。</p><p>  public void expireLease（String name）{getLogger（）。info（＆＃34; Expiring lease＆＃34; + name）;租约已删除租约= leases.remove（name）; removeAttachedKeys（removedLease）; }</p><p> 私人无效removeAttachedKeys（Lease removalLease）{if（removedLease == null）{return; } List＆lt; String＆gt; AttachedKeys = removeLease.getAttachedKeys（）; for（String AttachedKey：AttachedKeys）{getLogger（）。trace（＆＃34; +删除＆＃34; + Attached + +＃34;带有租约＆＃34; + removeLease）; kvStore.remove（attachedKey）; }} </p><p>当现有领导者失败时，将为Consistent Core选择新的领导者。 一旦 当选 ， 新领导人 开始跟踪 租约 。  新的领导者将刷新它所知道的所有租约。 请注意，原先将要到期的租约将延长生存时间。 值。 这不是问题，因为它为客户提供了与新领导者重新连接并继续租赁的机会。  卡夫卡[kip-631]建议使用限时租约来管理卡夫卡经纪人的组成员身份和故障检测。  [etcd]提供了有时间限制的租赁工具，客户可以使用该工具来协调其活动以及组成员身份和故障检测。  dhcp协议允许连接的设备租用IP地址。 具有多个DHCP服务器的故障转移协议的工作方式与此处说明的实现类似。 </p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://martinfowler.com/articles/patterns-of-distributed-systems/time-bound-lease.html">https://martinfowler.com/articles/patterns-of-distributed-systems/time-bound-lease.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/租约/">#租约</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>