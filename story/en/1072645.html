<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>今天NPM应该做些什么来阻止明天的新颜色攻击What NPM Should Do Today to Stop a New Colors Attack Tomorrow</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">What NPM Should Do Today to Stop a New Colors Attack Tomorrow<br/>今天NPM应该做些什么来阻止明天的新颜色攻击</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2022-01-11 01:21:54</div><div class="page_narrow text-break page_content"><p>Anyone running modern production systems knows about testing followed by  gradual or staged rollouts, in which changes to a running system are deployed gradually over a long period of time, to reduce the possibility of accidentally taking down everything at once. For example, the last time I needed to make a change to Google’s core DNS zone files, the change was tested against many many regression tests and then deployed to each of Google’s four name servers, one at a time, over a period of 24 hours. Regression testing checks that the change does not appear to affect answers it shouldn’t have, and then the gradual rollout gives plenty of time for both automated systems and reliability engineers to notice unexpected problems and stop the rollout. NPM’s design choice is the exact opposite. The latest version of colors was promoted to use in all its dependents before any of them had a chance to test it and without any kind of gradual rollout.Users can disable this behavior today, by pinning the exact versions of all their dependencies. For example here is  the fix to aws-cdk. That’s not a good answer, but at least it’s possible. The right path forward for NPM and package managers like it is to stop preferring the latest possible version of all dependencies when installing a new package. Instead, they should prefer to use the dependency versions that the package was actually tested with, or versions as close as possible to those. I call that a   high-fidelity build. In contrast, the people who installed aws-cdk and other packages over the weekend got low-fidelity builds: NPM inserted a new version of colors that the developers of these other packages had never tested against. Users got to test that brand new configuration themselves over the weekend, and the test failed. High-fidelity builds solve both the testing problem and the gradual rollout problem. A new version of colors wouldn’t get picked up by an aws-cdk install until the aws-cdk authors had gotten a chance to test it and push a new version configuration in a new version of aws-cdk. At that point, all new aws-cdk installs would get the new colors, but all the other tools would still be unaffected, until they too tested and officially adopted the new version of colors. There are many ways to produce high-fidelity builds. In Go, a package declares the minimum required version of each dependency, and that’s what the build uses, unless some other constraint in the same build graph requests a newer one. And then, it only uses that specific newer one, not the one that just appeared over the weekend and is entirely untested by anyone. For more about this approach, see “ The Principles of Versioning in Go.” Package managers don’t have to adopt Go’s approach exactly. It would be enough, for example, to record the versions that the aws-cdk developers used for their testing and then reuse those versions during the install. In fact, NPM can already record those versions, in a lock file. But  npm install of a new package does not use the information in that package’s lock file to decide the versions of dependencies: lock files are not transitive. NPM also has a new   npm shrinkwrap command, which appears to fix the problem for commands. Most of the authors of commands affected by the colors sabotage should be looking carefully at  npm shrinkwrap today. Kudos to NPM for providing a tool for package authors to protect themselves from this kind of problem. The next step, though, is for NPM to arrange for that kind of protection to happen by default. And then the same protection is needed when installing a new library package as a dependency, not just when installing a command. All this will require more work. Other package managers should take note too. Marak has done all of us a huge favor by highlighting the problems most package managers create with their policy of automatic adoption of new dependencies without the opportunity for gradual rollout or any kind of testing whatsoever. Fixing those problems is long overdue. Next time will be worse.</p><p>运行现代生产系统的任何人都知道关于测试，后跟渐变或分阶段的卷展栏，在长时间逐渐部署到运行系统的变化，以减少一次意外地取消一切的可能性。例如，我最后一次需要更改Google的核心DNS区域文件，更改是针对许多回归测试测试的，然后在24小时内部部署到Google的四个名称服务器中的每一个。 。回归测试检查变更似乎不会影响答案它不应该有，然后逐渐推出为自动化系统和可靠性工程师提供充足的时间，以注意意外问题并停止卷展栏。 NPM的设计选择是完全相反的。最新版本的颜色被提升为在所有这些依赖性之前在任何有机会测试它并且没有任何类型的渐进式卷展栏之前使用。用户可以通过钉住所有依赖项的确切版本来禁用这种行为。例如，这里是AWS-CDK的修复程序。这不是一个很好的答案，但至少有可能。 NPM和Package Managers的正确路径是在安装新包时停止更激先使所有依赖项的最新可能版本。相反，它们应该更喜欢使用包实际测试的依赖性版本，或者可以尽可能靠近那些版本。我称之为高保真的构建。相比之下，在周末安装了AWS-CDK和其他包的人得到了低保护版本：NPM插入了新版颜色，即这些其他包的开发人员从未测试过。用户必须在周末测试这个全新配置，并测试失败。高保真构建解决了测试问题和逐渐推出问题。 AWS-CDK作者在AWS-CDK作者中掌握了一个新版本的AWS-CDK作者并在新版本的AWS-CDK中推动新版本配置，无法通过AWS-CDK安装来获得新版本的颜色。此时，所有新的AWS-CDK安装都会获得新的颜色，但所有其他工具仍然不受影响，直到他们过于测试并正式采用新版本的颜色。有很多方法可以制作高保真构建。在Go中，包声明每个依赖关系的最低要求版本，这就是构建使用的，除非同一构建图中的其他约束请求更新的。然后，它只使用那个特定的更新，而不是周末刚刚出现的那个，并且完全没有任何人。有关此方法的更多信息，请参阅“Go的版本控制原则”。包管理人员不必完全采用Go的方法。例如，它足够了，可以记录用于其测试的AWS-CDK开发人员，然后在安装期间重用这些版本的版本。实际上，NPM可以在锁定文件中记录这些版本。但NPM安装新包不使用该软件包锁文件中的信息来决定依赖项的版本：锁定文件不传递。 NPM还具有新的NPM ShrinkWrap命令，它似乎可以解决命令问题。受到颜色破坏的大多数作者应该在今天的NPM Shrinkwrap上仔细看。 KEDOS到NPM为包装作者提供一种工具，以保护自己免受这种问题。但是，下一步是为了NPM，可以默认排列此类保护。然后在将新库包安装为依赖项时，需要相同的保护，而不仅仅是在安装命令时。所有这些都需要更多的工作。其他套餐管理人员也应该注意。 Marak通过突出大多数计划经理在自动采用新依赖性的政策的情况下突出了这些问题，使我们所有人都赢得了巨大的利益，而无需逐渐推出或任何类型的测试。修复这些问题是长期的。下次会更糟。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/应该/">#应该</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/today/">#today</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/测试/">#测试</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>