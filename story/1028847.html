<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>只读模式可缩短Rails停机时间</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">只读模式可缩短Rails停机时间</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-15 01:56:48</div><div class="page_narrow text-break page_content"><p>最近，我希望在我一直在开发的一个应用程序上升级Postgres版本。这将需要少量的停机时间，可能约为10分钟。</p><p>在这些情况下，我想要的默认解决方案是进入Heroku的维护模式，该模式提供一个带有503ServiceUnailable状态代码的HTML维护页面。这是可行的，但在升级过程中会使应用程序完全不可用，我希望能找到更好的解决方案。在本例中，我还希望能够提供JSON响应，因为应用程序主要为移动应用程序提供API。</p><p>在研究了几个不成熟的选项之后，我决定使用仅限区域的数据库连接，以仍然允许读取，但防止任何写入发生。在使用只读连接时，Postgres适配器会在我们试图更改数据库中的数据时引发错误，但我们可以轻松地修复此特定错误并将其转换为面向用户的通知。我觉得使用异常作为这个工作流程的核心有点奇怪，但最终，它工作得非常好，所以我想分享一下具体细节。</p><p>值得一提的是，这个解决方案特别适合这个特定的应用程序，它只提供一个API，使用起来非常繁重，但我想它也可以扩展到与其他风格的应用程序一起使用。</p><p>如果存在，Rails将使用DATABASE_URL环境变量中的连接字符串连接到数据库。按照Rails指南中的连接首选项说明，我意识到可以明确使用DATABASE_URL并允许临时覆盖。为此，我为生产环境添加了一个具有所需连接首选项的显式urlproperty：</p><p>准备就绪后，我只需设置DATABASE_URL_READ_ONLY环境变量即可启用只读模式：</p><p>注意：我能够使用Heroku的Postgres凭证界面创建只读用户，但是如果您不使用Heroku，您应该能够使用这些说明来创建您的只读用户。</p><p>使用我考虑的其他方法，我发现我必须关闭向数据库发出写入的多个不同的潜在方式，但是只读连接可以很好地在一次更改中切断所有内容。这就是说，这只是解决方案的一半，因为我当然不想让错误让它变得更糟。</p><p>谢天谢地，提供集中式救援相对简单，这样我就可以处理所有错误。首先，我使用Rails的ActiveSupport：：Concern功能创建了一个模块：</p><p>#app/controllers/concerns/read_only_controller_support.rb模块只读控制器支持扩展ActiveSupport：：Concerns Included Do IF ENV[&#34；DATABASE_URLREAD_ONLY&#34；]。现在时?。REASURE_FROM ActiveRecord：：StatementInvalid DO|ERROR|IF ERROR。留言。是否匹配？(/pg：：不充分权限/i)Render(status：：service_unavailable，json：{info：&#34；应用当前处于只读维护模式。请稍后重试。&#34；，}，)否则引发错误END END END。</p><p>当包含该模块时，该模块将使用Rails的REASE_FROM方法来捕获可能相关的错误，然后我们在该块内进行快速检查，以确保我们只捕获相关的错误。</p><p>注意，RESAVE_FROM逻辑仅在设置了DATABASE_URL_READ_ONLY时才启用，因此我们可以重用该变量的存在作为确定此行为范围的一种方式。</p><p>我最初使用这种只读模式的用例只需要支持API请求，但我可以想象将其扩展到HTML和基于表单的界面。</p><p>我要考虑的第一件事是添加一个站点范围的横幅，声明我们处于只读维护模式，以提醒用户当前状态。</p><p>有了这些，我认为我们可以扩展ReadOnlyControllerSupport模块中的错误处理，以将用户重定向回来并显示异常消息：</p><p>REASURE_FROM ActiveRecord：：StatementInvalid DO|ERROR|IF ERROR。留言。是否匹配？(/PG：：不充分权限/I)RESPONSE_TO|FORMAT|FORMAT。JSON DO#JSON错误消息，如上所示结束格式。HTML DO REDIRECT_BACK(FLABACK_LOCATION：ROOT_PATH，ALERT：&#34；应用程序当前处于只读维护模式。请稍后重试。&#34；，)END END否则引发错误END END</p><p>这里的另一个注意事项是关于后台作业和调度程序进程。对于后台工作，事情相对简单-我们只需要在只读期间将我们的工作人员池缩减到零即可。</p><p>调度器进程有点棘手，因为我没有全局启用或禁用它们的机制。考虑到这一点，我认为理想的解决方案是只让调度程序进程将作业排入队列，而不实际执行任何超出该队列的工作。</p><p>我们遇到的最后一个症结是移民。我们在Procfile中定义了一个RELEASE命令，该命令被配置为运行rake db：Migrate。不幸的是，即使没有运行迁移，Rails仍会尝试写入ar_Internal_METADATA表，作为db：Migratecomand的一部分，并且Heroku将在我们更改环境的任何时候运行Release命令。在我最初的尝试中，当我尝试设置DATABASE_URL_READ_ONLY时，Heroku失败了，因为在运行rake db：Migrate时，相关的Release命令遇到了只读错误。</p><p>为了解决这个问题，我编写了一个小脚本，它首先检查是否有任何迁移需要运行，并且只有在有的情况下才会运行，然后运行rakedb：Migrate：</p><p>此脚本作为bin/Migrate-if-Need添加到repo，然后将我们的调用放到rake db：Migrate with bin/Migrate-if-Need</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://ctoomey.com/writing/read-only-mode-for-better-rails-downtime/">https://ctoomey.com/writing/read-only-mode-for-better-rails-downtime/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/模式/">#模式</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/mode/">#mode</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1025342.html"><img src="http://img2.diglog.com/img/2020/9/thumb_7cf484ceeae6bc7fc2161eddc603cd15.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1025342.html">收入模式比文化更重要吗？</a></div><span class="my_story_list_date">2020-9-21 22:37</span></div><div class="col-sm"><div><a target="_blank" href="/story/1023080.html"><img src="http://img2.diglog.com/img/2020/9/thumb_a078325ddd2535630445c6e9ba33e9ec.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1023080.html">Vivaldi浏览器为Internet添加了暂停按钮</a></div><span class="my_story_list_date">2020-9-10 5:55</span></div><div class="col-sm"><div><a target="_blank" href="/story/1019390.html"><img src="http://img.diglog.com/img/2020/8/thumb_19e616c64cc1adbc40737172336a6526.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1019390.html">谷歌的Pixel Buds获得了一个新的转录模式，可以翻译长篇演讲，注意提醒用户发生在他们周围的重要事件，等等</a></div><span class="my_story_list_date">2020-8-21 0:17</span></div><div class="col-sm"><div><a target="_blank" href="/story/1018883.html"><img src="http://img.diglog.com/img/2020/8/thumb_b48c49129c67194b706ec2f329a209de.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1018883.html">消息来源：优步和Lyft正在考虑在加州采取类似特许经营的模式，将自己的品牌授权给车队运营商</a></div><span class="my_story_list_date">2020-8-18 20:34</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>