<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Threema多设备：体系结构概述</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Threema多设备：体系结构概述</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-11-04 01:59:19</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/11/6620e50b8403175ae7abce277b93f844.png"><img src="http://img2.diglog.com/img/2020/11/6620e50b8403175ae7abce277b93f844.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>These days, many chat services allow users to use multiple devices in parallel. Therefore, one might assume that such a multi-device functionality must be easy enough to implement. Provided that security and privacy protection are not a major priority, this notion isn’t far off. If, however, the multi-device protocol is required to meet Threema standards, things get complicated.</p><p>如今，许多聊天服务允许用户并行使用多个设备。因此，人们可能会认为这样的多设备功能必须足够容易实现。只要安全和隐私保护不是主要的优先事项，这个概念就不远了。然而，如果需要多设备协议来满足Threema标准，事情就变得复杂了。</p><p> In order to fulfill Threema’s requirements, a multi-device solution must, of course, provide full end-to-end encryption. That’s a given. But on top of that, it also has to rule out any possibility for the server to alter key material, and the amount of transferred metadata must be kept to the absolute minimum.</p><p>当然，为了满足Threema的要求，多设备解决方案必须提供完全的端到端加密。这是理所当然的。但最重要的是，它还必须排除服务器更改关键材料的任何可能性，并且必须将传输的元数据数量保持在绝对最小。</p><p> Even though these requirements pose a true technological challenge, we believe to have found a capable and elegant solution, which is currently in development and will become available in the course of 2021. For technically inclined readers, we outline our approach below.</p><p>尽管这些要求构成了真正的技术挑战，但我们相信已经找到了一个有能力的、优雅的解决方案，该解决方案目前正在开发中，将于2021年推出。对于技术倾向的读者，我们在下面概述我们的方法。</p><p>  According to Occam’s razor, it’s advisable to prefer simple solutions over complex ones, and as far as security is concerned, this principle certainly holds true. The less moving parts there are in key components, the lower is the risk for vulnerabilities to go unnoticed when assessing a system’s security.</p><p>根据Occam‘s Raporer的说法，比起复杂的解决方案，更喜欢简单的解决方案是明智的，就安全而言，这一原则肯定是正确的。关键组件中移动的部件越少，评估系统安全时漏洞被忽视的风险就越低。</p><p> Threema’s chat server, which is probably the most optimized part of our infrastructure, adheres to this “Keep it simple” motto, and there are reasons other than the security benefit why it should stay that way.</p><p>Threema的聊天服务器可能是我们基础设施中最优化的部分，它坚持“保持简单”的座右铭，除了安全方面的好处外，还有其他原因让它保持这种状态。</p><p> For one thing, not everyone will use multiple devices, and there’s no need to change anything as far as the classic single-device use case is concerned. For another thing, the chat server was never designed to handle multiple devices that use the same Threema ID in parallel.</p><p>首先，不是每个人都会使用多个设备，就经典的单设备用例而言，没有必要更改任何内容。另一方面，聊天服务器从来没有设计成并行处理使用相同Threema ID的多个设备。</p><p> Instead of complicating a crucial part of our infrastructure by extending the chat server’s range of duty, we decided to take a different route.</p><p>我们决定采取一条不同的路线，而不是通过扩大聊天服务器的职责范围来使我们的基础设施的一个关键部分变得复杂。</p><p>  A new “mediator server” will act as an exchange hub for devices that share a Threema ID. The main tasks of this mediator server are:</p><p>一个新的“中介服务器”将充当共享Threema ID的设备的交换中心。该中介服务器的主要任务是：</p><p>  Let’s take a closer look at these tasks one by one. We’ll begin with the authentication process.</p><p>让我们逐一仔细看看这些任务。我们将从身份验证过程开始。</p><p>  One fundamental requirement for server-based multi-device functionality is some kind of grouping mechanism that combines multiple devices into a single entity. Of course, the Threema ID could serve as an identifier to establish this tie. However, the mediator server doesn’t need to know which specific Threema ID a group of devices belongs to.</p><p>基于服务器的多设备功能的一个基本要求是将多个设备组合成单个实体的某种分组机制。当然，Threema ID可以作为建立这种联系的标识符。但是，中介服务器不需要知道一组设备属于哪个特定的Threema ID。</p><p> Instead of using the Threema ID itself, we derive a bit of cryptographic key material from the private key associated with the ID:</p><p>我们不使用Threema ID本身，而是从与ID关联的私钥中派生出一些加密密钥材料：</p><p> First, we derive the “Device Group Key” from the Threema ID’s private key. This Device Group Key will be used to encrypt the data that’s exchanged between devices that share an ID.</p><p>首先，我们从Threema ID的私钥导出“设备组密钥”。此设备组密钥将用于加密共享ID的设备之间交换的数据。</p><p> Next, we derive the “Mediator Path Key” from the Device Group Key. The Mediator Path Key will be used for authentication towards the mediator server. The server uses the public part of this key as identifier for the user’s devices; therefore, it’s called “Device Group ID.”</p><p>接下来，我们从设备组密钥派生“中介路径密钥”。中介路径密钥将用于向中介服务器进行身份验证。服务器使用该密钥的公共部分作为用户设备的标识符；因此，它被称为“设备组ID”。</p><p>  A device authenticates itself towards the mediator server by solving an authentication challenge based on the Mediator Path Key. Each device is able to accomplish the cryptographic key derivation independently. Since there is no way for the mediator server to determine which Threema ID the keys were derived from, we have established an anonymous device-grouping mechanism. And because all key material is derived from the Threema ID’s private key, which only the clients have access to, it’s impossible for the server to alter key material.</p><p>设备通过基于中介路径密钥解决认证质询来向中介服务器认证其自身。每个设备都能够独立地完成密钥导出。由于中介服务器无法确定密钥来自哪个Threema ID，因此我们建立了匿名设备分组机制。而且因为所有密钥材料都派生自Threema ID的私钥，只有客户端才能访问，所以服务器不可能更改密钥材料。</p><p>  After the authentication process is completed, the mediator server designates one of the devices currently connected to the server to be the “leader.” This device is assigned a vital task: Whenever it receives a message from the chat server, it must process and “reflect” (i.e., forward) it to the other devices via mediator server. Similarly, any device that sends out a message has to reflect that message to the other devices. Reflected messages are end-to-end encrypted using the Device Group Key.</p><p>身份验证过程完成后，中介服务器将当前连接到该服务器的设备之一指定为“领导者”。该设备被分配了一项重要任务：每当它接收到来自聊天服务器的消息时，它必须处理该消息并通过中介服务器将其“反映”(即转发)到其他设备。同样，任何发送消息的设备都必须将该消息反映给其他设备。反映的消息使用设备组密钥进行端到端加密。</p><p> A mechanism that reflects messages to every other device of a group is the most fundamental component for multi-device functionality. As trivial as this might sound, the devil is, as always, in the details.</p><p>将消息反映到组中所有其他设备的机制是多设备功能的最基本组件。虽然这听起来微不足道，但魔鬼总是在细节中。</p><p> Most of Threema’s message types trigger some sort of reaction on the recipient’s device. Here are two examples:</p><p>Threema的大多数消息类型都会在收件人的设备上触发某种反应。这里有两个例子：</p><p> If a message is received and read receipts are enabled, at least one device has to return a read receipt to the sender.</p><p>如果收到邮件并且启用了已读回执，则至少有一个设备必须将已读回执返回给发件人。</p><p> If a message is received from an unknown contact, this contact must be added to the contact list, where a name and and other properties are assigned. These properties must be identical on all devices.</p><p>如果收到来自未知联系人的消息，则必须将此联系人添加到联系人列表中，并在该列表中分配姓名和其他属性。所有设备上的这些属性必须相同。</p><p> The context is always relevant as far as incoming messages are concerned. In general, a reaction must be triggered on the leading device when a message is received, whereas devices other than the leader are not supposed to react to incoming messages.</p><p>就传入消息而言，上下文始终是相关的。通常，当接收到消息时，必须在引导器设备上触发反应，而引导器以外的设备不应该对传入的消息作出反应。</p><p> Given this rule of thumb, a problem arises in the second example above: Without a reaction on devices other than the leader, a new contact will only be added to the leading device’s contact list, not to the other ones’. That’s where device synchronization comes into play.</p><p>根据这条经验法则，上面的第二个示例中会出现一个问题：在除引导者之外的设备上没有反应的情况下，新联系人将仅添加到引导者设备的联系人列表中，而不会添加到其他设备的联系人列表中。这就是设备同步发挥作用的地方。</p><p>  If multiple devices share a single Threema ID, it’s not only required for new messages to appear on each device, it’s also expected that contacts, group chats, distribution lists, and user settings are synchronized across all devices. Therefore, the mediator server also distributes data that never passes the chat server.</p><p>如果多个设备共享一个Threema ID，则每个设备上不仅需要显示新消息，还需要在所有设备上同步联系人、群聊、通讯组列表和用户设置。因此，中介服务器还分发从未通过聊天服务器的数据。</p><p> With synchronization comes the possibility of conflicts. If, for example, a different profile picture is set on two devices simultaneously, both devices could, in the worst case, end up with the profile picture set by the opposite device. To prevent undesirable outcomes like this, a mechanism to temporarily grant a device exclusive access to the mediator server’s “Reflect Message Queue” is required.However, an explanation of the transaction mechanism is out of this brief overview’s scope.</p><p>同步随之而来的是冲突的可能性。例如，如果在两个设备上同时设置了不同的简档图片，则在最坏的情况下，两个设备都可能以由相反的设备设置的简档图片结束。为了防止出现这样的不良结果，需要一种机制来临时授予设备对中介服务器的“反射消息队列”的独占访问权限。但是，对事务机制的解释超出了本概述的范围。</p><p>  Threema’s chat server uses TCP as transport protocol. For technical reasons we leave up to the reader’s imagination for now, the mediator server requires WebSocket support. Instead of equipping the chat server with the WebSocket protocol, the mediator server will support this protocol, and communication between chat server and multi-device clients will be proxied via the mediator server.</p><p>Threema的聊天服务器使用TCP作为传输协议。出于技术原因，我们暂时让读者发挥想象力，中介服务器需要WebSocket支持。中介服务器将支持该协议，而不是为聊天服务器配备WebSocket协议，并且聊天服务器和多设备客户端之间的通信将通过中介服务器进行代理。</p><p> A welcome side effect of this proxying technique is the fact that the chat server is unable to correlate IP addresses with Threema IDs. And thanks to anonymous device grouping, the same holds true for the mediator server.</p><p>这种代理技术的一个受欢迎的副作用是聊天服务器无法将IP地址与Threema ID相关联。多亏了匿名设备分组，同样的情况也适用于中介服务器。</p><p> While Threema will, of course, provide an official mediator server, users will also be able to self-host their own mediator server if they so desire. In doing so, users will only disclose their mediator servers’ IP addresses to Threema’s chat server but not their devices’ IP addresses, reducing the amount of metadata on Threema’s end once again.</p><p>当然，虽然Threema将提供官方中介服务器，但如果用户愿意，也可以自行托管他们自己的中介服务器。这样，用户只会向Threema的聊天服务器泄露他们的中介服务器的IP地址，而不会泄露他们的设备的IP地址，从而再次减少了Threema端的元数据数量。</p><p>  As we have seen, there are quite a few obstacles to overcome if security and privacy protection are major requirements for multi-device functionality.</p><p>正如我们已经看到的，如果安全和隐私保护是多设备功能的主要要求，则需要克服相当多的障碍。</p><p> Threema’s solution provides full end-to-end encryption. Our protocol’s cryptographic properties render it impossible for servers to alter key material. And, in true Threema fashion, the amount of metadata is kept to the absolute minimum thanks to anonymous device grouping and a self-hostable mediator server.</p><p>Threema的解决方案提供完全的端到端加密。我们协议的加密属性使得服务器不可能更改密钥材料。而且，在真正的Threema方式中，由于匿名设备分组和可自我托管的中介服务器，元数据的数量被保持在绝对最小的水平。</p><p> Of course, there are many other facets we haven’t touched upon in this rough outline. While we’re in a stage of development where technical details are still subject to change, the basic framework has been established.</p><p>当然，在这个粗略的提纲中，我们还有许多其他方面没有触及。虽然我们正处于开发阶段，技术细节仍有可能更改，但基本框架已经建立。</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://threema.ch/en/blog/posts/md-architectural-overview">https://threema.ch/en/blog/posts/md-architectural-overview</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/设备/">#设备</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/multi/">#multi</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1033010.html"><img src="http://img2.diglog.com/img/2020/11/thumb_6620e50b8403175ae7abce277b93f844.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1033010.html">Threema多设备：体系结构概述</a></div><span class="my_story_list_date">2020-11-4 1:58</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032743.html"><img src="http://img2.diglog.com/img/2020/11/thumb_eb13f6c1de301f8a5c385ece4770e28d.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032743.html">
树莓派基金会宣布可爱的小树莓派400</a></div><span class="my_story_list_date">2020-11-2 16:14</span></div><div class="col-sm"><div><a target="_blank" href="/story/1032270.html"><img src="http://img2.diglog.com/img/2020/10/thumb_2a88b3eea39a9054566e36c872ab1c9b.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1032270.html">三星推出SmartThings Find应用程序来追踪丢失的Galaxy设备，可与Galaxy手机、平板电脑、Buds、手表等配合使用</a></div><span class="my_story_list_date">2020-10-30 21:1</span></div><div class="col-sm"><div><a target="_blank" href="/story/1031831.html"><img src="http://img2.diglog.com/img/2020/10/thumb_cd5b73a74b2b0de22bab4f1bf3c9813a.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1031831.html">
Jackery的太阳能发电系统可以帮助您收集和储存足够的电力，以满足离网必需品的需求</a></div><span class="my_story_list_date">2020-10-29 9:46</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/美国/">#美国</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>