<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>对“ WireGuard：出色的协议，但跳过Mac应用程序”的回应 Response to “WireGuard: great protocol, but skip the Mac app”</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Response to “WireGuard: great protocol, but skip the Mac app”<br/>对“ WireGuard：出色的协议，但跳过Mac应用程序”的回应 </h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2021-01-15 20:07:30</div><div class="page_narrow text-break page_content"><p>Jason A. Donenfeld  Jason at zx2c4.com    Fri Dec 25 16:48:25 CET 2020  Hi Rachel,I&#39;m writing this to you, but am CC&#39;ing the WireGuard mailing list, asI think there&#39;s relevant technical discussion to be had.I woke up this morning with my inbox lit up by netizens outraged at mefor having allowed the WireGuard Project to produce such terriblysubpar and dysfunctional software for the Mac. That was a weird way towake up on Christmas, considering how much I really do care aboutdelivering polished software. I squinted at my telephone a bit tryingto figure out what was going on, when I finally wound up on a HackerNews &#34;top story&#34; linking to your blog post [1].Fortunately the top comment [2] correctly identified the technicalnature of the problem, upon which hopefully I can expound a bit inthis email:&gt;&gt;  Wireguard won&#39;t upgrade itself if it&#39;s still running…&gt;  This is not unique to Wireguard. I’ve had this happen with the Lockdown app too. This is an Apple problem. Apple should notify you that the VPN app needs to close in order to upgrade then offer you a simple way of doing that.&gt;&gt;  I don&#39;t know exactly, and I don&#39;t really care.&gt;  This about sums it up. This is a rant and it’s difficult not to just close tab half way through.I thought it might be useful to reframe our efforts with the Mac interms of the technical hurdles we&#39;re facing with Apple&#39;s frameworksand with the App Store, in hope that this motivates either you orothers to help contribute to making the app better. Again, I really docare immensely about producing quality software for the Mac, and tothe extent that things are as dire as your post makes them sound, I&#39;dreally like to fix that. You wrote, &#34;What about the problems? Well,it&#39;s free. They owe me nothing.&#34; But, owe you something or not, Istill care.1. The App Store refuses to update when a network extension is running.This is true! And it&#39;s not exactly clear the best way to fix it,either. We&#39;re currently trying to detect it from the actual UI, whichsometimes receives a notification: https://git.zx2c4.com/wireguard-apple/tree/Sources/WireGuardApp/UI/macOS/MacAppStoreUpdateDetector.swift https://git.zx2c4.com/wireguard-apple/tree/Sources/WireGuardApp/UI/macOS/AppDelegate.swift#n144The goal here is to detect the update and then do the right thing.These are hard to test, though, because the app store doesn&#39;t allowsideloading old versions to be updated, which means we need to manageVM snapshots and wait cycles of app store updates. Apple being Appledoes not make this easy or pleasant to debug. It&#39;s possible this isnow broken in Big Sur. It also won&#39;t work if the app is closed but thenetwork extension is running.Do I know how to workaround that? Yes I do, but the app store&#39;sguidelines won&#39;t let me employ any of those techniques. Should Applefix this, as the Hacker News commenter wrote? Yes, they should, butit&#39;s been several versions now, and it still isn&#39;t fixed. I wouldn&#39;thold my breath; Apple doesn&#39;t usually fix old bugs (only new ones,according to sources). In fact, I&#39;d estimate that _at least_ around3/4th of time spent developing the macOS app has been devoted tohacking around random Apple bugs. We&#39;ve cataloged a few at the bottomof [3].2. Version 1.0.10, our first update in a ~year, introduced aregression that didn&#39;t get fixed for several days.Actually, I fixed that regression within minutes. But the App Storereview process is insane. We faced rejections in submitting the app,because they decided to change their policy on the app having a linkin the &#34;About WireGuard&#34; tool window to www.wireguard.com/donations/ (which they previously had allowedexplicitly; now they want 30% or something), and then after removingthat [4], they reviewed the old app instead of the new one, and thenand then and then... Well, finally they approved the fix, but notafter a delay, during which time I fielded email after email of userstrying to figure out what was going on.How and why did this regression sneak in in the first place? In theprocess of introducing WireGuardKit [5], a developer new to thecodebase didn&#39;t realize that he was removing a workaround toyet-another-Apple-bug. I should have caught it, and I takeresponsibility for it, and probably workarounds need more comments sothis doesn&#39;t happen. But hey, regressions happen, especially dealingwith the hugely buggy and inconsistent Apple NetworkExtensionframework. And while I am nearly always available to stop what I&#39;mdoing to fix a regression within minutes of reports, the App Store isvery far from being amenable to quick reactions, in an era whenknee-jerk blog reactions are even faster. There&#39;s also no TestFlighton Mac, and as I&#39;ll mention below, no other alternative fordistribution.3. &#34;On-Demand&#34; has weird and confusing semantics.Again, this is how Apple&#39;s API is designed, and it&#39;s awful. Our nextbig push after the holidays will likely be to overhaul how we expose&#34;On-Demand&#34; so that we can somehow tame a bit of the NetworkExtensionframework&#39;s madness. It sounds like your issue with it is mostlyrelated to (1) above, but there are other issues too with just how&#34;sticky&#34; it is. So the app is going to have to become a lot moreaggressive in fighting Apple&#39;s framework so that it behaves nicely.Top of the to-do list.4. A, uh, description of sorts:&gt;  Just the way it failed told me something was up with the overall model here.&gt;  It feels like the UI is poking at the &#34;thing doing the actual work&#34; with very&gt;  long and wobbly sticks. It&#39;s doing this in a dimly-lit room with oversized&gt;  gloves zip-tied to its hands, and its glasses are smeared with filth. In&gt;  short, it&#39;s not in control of the situation, not really.I&#39;d say this is an accurate description of what it&#39;s like programmingfor the NetworkExtension framework. We&#39;ve put a *LOT* of effort intotaming it and presenting a UI that displays something consistent. Butit&#39;s mostly out of our control. Apple doesn&#39;t give us a lot of controlover anything, and if we try to take control, they&#39;ll flag the APIviolations and eventually just ban the whole developer account. WhenI&#39;m debugging these issues, I&#39;ll often times spend a few hours in IDAPro (Apple doesn&#39;t provide debug symbols, unlike Microsoft, whichmakes this process even more miserable than it already is), and afteridentifying the issue I&#39;ll often have several ideas for &#34;clever&#34;workarounds. Which of them are acceptable for the App Store? Usuallynone! C&#39;est la vie.So that&#39;s the deal... The bottom line is that Apple&#39;s framework is abuggy mess, and App Store policies make software release both morerisky and don&#39;t permit us to workaround issues as we&#39;d like. That sortof suggests another question, though: why are we in the App Store atall? Because as far as I know, Apple only allowsNetworkExtension-based apps to be distributed via the App Store,according to their developer relations guy [6], so we&#39;re locked in.And even if they were to change that someday somehow, and we went tostandalone distribution, we would then have to support two paralleldistribution channels so as not to abandon former Mac App Store users,presumably, which means we&#39;d still be limited by App Storerestrictions. That&#39;s an unfortunate situation; we&#39;re trapped. Theother option would be to distribute a root-app and do thingsourselves, much like the version of wg-quick available inwireguard-tools on brew (and MacPorts, as your blog post mentioned). Icould probably integrate this very deeply with the OS and make it workwell. But it&#39;s really only a matter of time before Apple closes downthat entirely too and forces everything into entitlement-basedframeworks. In other words, that&#39;s not a reliable base anymore in thatuniverse. And that also wouldn&#39;t work on iOS.If you (or anyone else on the list) is interested in helping to tamethese APIs, we really could use a hand. The goal is to integrate withnative system functionality -- NetworkExtension, Keychain, and so on-- so that it feels like a first-party app, while also beingdistributable in the App Store and basically functional so that peoplewant to use it. It turns out this is a taller order than it may seem.Hope this helps clarify. And sorry again for the buggy software.Merry Christmas,Jason[1]  https://rachelbythebay.com/w/2020/12/24/wg/[2]  https://news.ycombinator.com/item?id=25534089[3]  https://docs.google.com/document/d/1BnzImOF8CkungFnuRlWhnEpY2OmEHSckat62aZ6LYGY/edit[4]  https://git.zx2c4.com/wireguard-apple/commit/?id=a4fc0f64b8bca8afae5abab37b81ba0b45836975[5]  https://lists.zx2c4.com/pipermail/wireguard/2020-December/006161.html[6]  https://developer.apple.com/forums/thread/81281</p><p>Warning: Can only detect less than 5000 characters</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://lists.zx2c4.com/pipermail/wireguard/2020-December/006226.html">https://lists.zx2c4.com/pipermail/wireguard/2020-December/006226.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/出色/">#出色</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/wireguard/">#wireguard</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/warning/">#warning</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>