<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>40KB的优化为我们节省了50TB的带宽</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5effb96910009800120b8d4d&product=inline-share-buttons" async="async"></script>
<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">40KB的优化为我们节省了50TB的带宽</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-10-16 01:51:14</div><div class="story_img_container"><a href="http://img2.diglog.com/img/2020/10/af0d77d13d2e6882857c56af5f90b091.jpg"><img src="http://img2.diglog.com/img/2020/10/af0d77d13d2e6882857c56af5f90b091.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></a></div><div class="page_narrow text-break page_content"><p>自从Crisp在2015年推出以来，我们将Crisp Chatbox设计为功能齐全，同时又不影响重量。我们反复尝试确保我们的Chatbox脚本(我们的每个用户网站访问者加载的)不会减慢我们的用户网站的速度，并以尽可能快的速度弹出视图。</p><p>考虑到性能，我们已经至少减少了对供给库的依赖，并通过使用uglify和cssmin对生产资产进行后处理来最小化所有生产资产。后来，我们甚至将我们的字体文件(Noto Sans)分成了每个字母表的子文件，这将通常加载的字体文件大小从150KB降到了10KB-如果你会说拉丁语，为什么需要加载西里尔文字体字形呢？</p><p>我们达到了市场上最轻的Chatbox，压缩大小为232KB(满载)，而其他Chatbox提供商通常会加载高达1兆字节(！！)。</p><p>通过这篇快速文章，您将了解哪家公司提供最快的网站实时聊天解决方案。</p><p>因此，我们接受了这样一个事实，即我们不能对其进行更多的优化。这是本周之前的事了。</p><p>就用户体验而言，速度很重要，因为您的聊天小部件加载得越快，与网站访问者或客户互动的机会就越快。</p><p>另一方面，加载速度是谷歌和其他搜索引擎众所周知的排名因素。</p><p>在我们深入到我们如何优化Chatbox以使其更轻更快的技术解释之前，这里是我们的Chatbox与其他提供商的比较(应用了所有优化)。</p><p>这就是为什么我们比较了不同的实时聊天软件，向你展示它们在加载速度方面的表现。</p><p>我们分析了以下测量图表：Chatbox字节大小、加载时间、HTTP请求数、解析的DNS主机名和CDN服务器延迟。</p><p>我们从欧盟通过光纤互联网和一个良好的WiFi接入点进行了这些比较。我们假设其他提供商在CDN上运行，并在欧盟内有一个存在点，以便将延迟保持在我们测量的最佳水平。使用的测试浏览器是Firefox82，它支持所有最新的优化和Web技术，例如HTTP/3。浏览器缓存在每次测试之前都会被清除。</p><p>Chatbox的大小越大，在速度较慢的网络上加载所需的时间就越长。越小越好。</p><p>如何衡量：这个co是在打开实时聊天(点击按钮)后，通过欧盟的WiFi热点，通过汇总所有加载的资产从Firefox获得的。我们确保隔离特定于网站的资产，如操作员头像，因为它们的大小在不同网站之间差别很大，因此在此测量中不相关。另外，请注意，这些都是压缩大小，根据Chatbox提供商的不同，可以通过Gzip或Brotli(Brotli比Gzip好，通常高出10%)。</p><p>加载Chatbox按钮的时间取决于许多因素，例如Chatbox字节大小、服务器延迟以及Chatbox在准备就绪之前加载的依赖项数量。越低越好。</p><p>衡量方式：这一比较是从欧盟WiFi热点上的火狐(Firefox)获得的，方法是将Chatbox按钮首次显示在屏幕上所需的所有资源的所有顺序加载时间相加。在多个资源可以作为阻塞组的一部分并行加载的情况下，采用最大加载时间(为了反映实际)。</p><p>会发出多个HTTP请求来加载Chatbox所需的所有资源，加载其用户设置，并建立实时消息传递通道。更多的HTTP请求可能会导致等待网络的时间更长，尽管这种测量对当今使用现代HTTP/2和HTTP/3协议的性能影响较小，这两种协议都将请求流水线传输到相同的重用连接上。(通常)越低越好。</p><p>衡量方式：通过计算聊天按钮出现之前发送的所有HTTP请求，以及聊天按钮出现后发送的所有HTTP请求，从欧盟WiFi热点上的Firefox获得了这一比较，这是Chatbox服务(如操作员头像和WebSocket)所必需的。</p><p>Chatbox脚本可能需要访问不同子域(主机名)上的资源。主机名越多，DNS解析查询就越多，等待答案所花费的时间也就越多。这还可以防止在单个主机名上高效地流水线传输HTTP请求，因此需要协商不同的安全通道，从而导致将更多的CPU时间花费在硬加密工作上(假设使用HTTPS，这是2020年的标准)。越低越好。</p><p>如何衡量：这个比较是通过欧盟WiFi热点上的Firefox获得的，列出了所有不同的解析主机名，以便Chatbox按钮和头像可以出现在屏幕上，并建立了WebSocket连接。</p><p>CDN服务器的延迟是影响加载时间的关键。延迟是网络请求流向Chatbox服务器，然后返回第一个应答字节所需时间的基本度量。高延迟，加上大量HTTP请求，将导致极高的加载时间(因为需要多次往返)。越低越好。</p><p>测量方法：此比较是从位于法国的一台服务器上的有线光纤连接获得的，该服务器已就其到互联网主干的低而稳定的延迟(通常为5ms)进行了测试，因此反映了一个人在理想条件下可以获得的来自欧盟的实际最小延迟。</p><p>重要提示：此比较是在2020年10月写成的。自那以后，这里显示的数据可能发生了变化，因为其他Chatbox提供商可能已经推出了Chatbox的更新，这可能会使其变得更轻或更重。</p><p>下面是我们进一步优化Chatbox的动机背后的背景故事：Crisp团队两周前来到了一年一度的远程务虚会。我们降落在一个偏僻的小岛上，来到了一座乡下的大房子里。房子设备齐全，有高速光纤互联网。不幸的是，由于厚厚的墙壁，这座房子的WiFi接收效果很差。糟糕的WiFi意味着更高的数据包丢失率，无论座机连接有多好。</p><p>在轻度分组丢失的情况下，TCP带宽会显著降低，因为TCP算法倾向于降低每个丢失分组的带宽窗口，以调整到传输信道的最大限制带宽(这里：WiFi)。这会影响HTTP和一般Web浏览体验(HTTP在TCP上运行)。</p><p>更糟糕的是，由于使用UDP的DNS不保证交付，也不重新传输丢失的数据，因此许多DNS查询从未得到响应。DNS失败意味着我们的Web浏览器经常无法解析主机名，最常见的是网站加载的第三方脚本，这些脚本解析了大量的主机名。</p><p>据我们所知，Crisp Chatbox也受到了这个糟糕网络的影响。我们可以通过优化Chatbox运行方式中的某些因素来解决这个问题吗？让我想想。</p><p>我们的技术团队花了数天时间调查是否有进一步实时聊天优化的机会，并反复在多个级别测试几个想法，并在进行最终实现之前检查对捆绑包大小和速度的任何影响。</p><p>通过简化SVG的矢量路径，使用svgo可以将SVG的总大小减少50%，svgo也有一个很好的GUI可用(它们在主CSS中内联为base64)；</p><p>播放声音时，例如。可以将接收到的消息重新编码为较低的比特率(取决于它们的编解码器，即AAC、MP3或Vorbis)，以达到使用高质量耳机的典型人耳不会察觉到太多质量差异的最低限度。对我们来说幸运的是，人的耳朵听力很差，所以我们可以欺骗他们降低音质；</p><p>在我们针对所有现代浏览器的现代CSS构建中(它们仍然包含在我们的遗留样式表构建中)，可以禁用所有遗留浏览器(2017年前)的免费CSS属性；</p><p>Woff字体可以从我们现代的CSS版本中移除，只保留WOFF2(由于特定于字母的Unicode范围规则，这些规则重复了数百次)；</p><p>一些资源提示&#34；dns-prefetch&#34；和&#34；preconnect&#34；可以被删除，以避免不必要的DNS查询和TCP&amp；密码握手，当Chatbox关闭时，通常有1%的人看到它的域；</p><p>设置主机名#34；settings.crisp.chat&#34；可以合并到子路径上的资产主机名#34；client.crisp.chat&#34；，这将节省1次DNS查询、1次TCP握手和1次密码协商，并允许重复使用已经打开的HTTP/2连接来加载Chatbox设置；</p><p>某些CSS规则&#34；可见性：隐藏；&#34；可以调整为&#34；显示：无；&#34；以防止99%的Chatbox用户在屏幕上未显示时加载字体，从而节省20KB的数据和2个HTTP请求；</p><p>通过我们的散列后处理器，可以进一步减少CSS类名，它接受人类可读的CSS类名，如&#34；.crisp-client-tainer&#34；，并将它们修改为散列类名，如&#34；.cc-2da1&#34；；</p><p>内部的JavaScript属性和函数名可以通过uglify按类进行破坏，这将转换为例如。&#34；this.__LONG_PROPERTY_NAME&#34；到例如。&#34；this.Wr_&#34；(这节省了大量字节)；</p><p>供应商提供的库应该用特殊的优化来构建，以删除未使用的代码，例如，我们用来建立到服务器的RTM消息传递连接的Socket.IO包含一个遗留的HTTP长轮询连接方法-这是相当繁重的！-尽管我们只需要在今天的现代浏览器中使用WebSocket连接方法；</p><p>我们的Content Delivery Network以压缩格式提供所有脚本和样式表，优先使用Brotli压缩算法，并在浏览器不支持Gzip的情况下后退到Gzip。Brotli在减少资源大小方面比Gzip做得更好，并且正在成为当今的标准。</p><p>我们在优化工作前后测量了所有核心Chatbox资产(脚本、样式表)的Brotli压缩大小：</p><p>那可是一次不错的总减重啊！这并不包括加载的所有其他较小的资源，这些资源加起来总共减少了30%的大小。</p><p>此外，我们还希望确保我们的包大小不会因为微小的代码更改而随着时间的推移而变得更大。因此，我们在生产构建结束时实现了一项检查，将生成的构建大小与预先配置的大小基线进行比较。跨过阈值意味着构建会被拒绝，并且不会部署到生产环境中，从而出错并提醒开发人员。</p><p>➡️：是的，这是文章封面图片上的协和。当我们想到速度和重量时，它立刻浮现在我们的脑海中。太糟糕了，它不见了！</p></div><div id="story_share_this"><div class="sharethis-inline-share-buttons"></div></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://crisp.chat/blog/fastest-live-chat/">https://crisp.chat/blog/fastest-live-chat/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/优化/">#优化</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/chatbox/">#chatbox</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1021023.html"><img src="http://img.diglog.com/img/2020/8/thumb_495457808cfb0b896b43bbc49de12862.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1021023.html">针对4K的基于镜头的优化编码</a></div><span class="my_story_list_date">2020-8-29 5:40</span></div><div class="col-sm"><div><a target="_blank" href="/story/1016473.html"><img src="http://img.diglog.com/img/2020/8/thumb_5ca2e7d8d610e8c21bd81cb2cf2ebb8f.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1016473.html">PC上的Horizon Zero Dawn：不是我们希望的优化端口</a></div><span class="my_story_list_date">2020-8-6 1:16</span></div><div class="col-sm"><div><a target="_blank" href="/story/1015984.html"><img src="http://img.diglog.com/img/2020/8/thumb_b72a87f0f81a861654f3353eec21666d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1015984.html">搜索引擎优化的超快速概述</a></div><span class="my_story_list_date">2020-8-4 2:45</span></div><div class="col-sm"><div><a target="_blank" href="/story/1012566.html"><img src="http://img.diglog.com/img/2020/7/thumb_2d27f7acc193d3eae7cedcc78eaf4125.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1012566.html">混沌工程学原理</a></div><span class="my_story_list_date">2020-7-18 2:7</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy;2012-2021 diglog.com </div></div></body></html>